# ì—…ì²´ ì‚­ì œ ë¬¸ì œ í•´ê²°

## ğŸ” ë¬¸ì œ ì›ì¸

### ì—ëŸ¬ ë©”ì‹œì§€
```
error: update or delete on table "pickup_agencies" violates foreign key constraint
"airport_pickups_agency_id_fkey" on table "airport_pickups"
```

### ì›ì¸
- `airport_pickups` í…Œì´ë¸”ì´ `pickup_agencies`ë¥¼ ì™¸ë˜í‚¤ë¡œ ì°¸ì¡°
- ì‚­ì œí•˜ë ¤ëŠ” ì—…ì²´ë¥¼ ì‚¬ìš©í•˜ëŠ” í”½ì—… ì˜ˆì•½ì´ ì¡´ì¬
- ë°ì´í„° ë¬´ê²°ì„± ë³´í˜¸ë¥¼ ìœ„í•´ PostgreSQLì´ ì‚­ì œë¥¼ ê±°ë¶€

## âœ… í•´ê²° ë°©ë²•: ìŠ¤ë§ˆíŠ¸ ì‚­ì œ ì‹œìŠ¤í…œ

### êµ¬í˜„ëœ ë¡œì§

```javascript
1. ì‚­ì œ ìš”ì²­ ì‹œ:
   â”œâ”€ í•´ë‹¹ ì—…ì²´ë¥¼ ì‚¬ìš©í•˜ëŠ” í”½ì—…ê±´ í™•ì¸
   â”œâ”€ ì‚¬ìš© ì¤‘ì¸ í”½ì—…ê±´ì´ ìˆìœ¼ë©´ â†’ ë¹„í™œì„±í™” (is_active = false)
   â””â”€ ì‚¬ìš© ì¤‘ì¸ í”½ì—…ê±´ì´ ì—†ìœ¼ë©´ â†’ ì™„ì „ ì‚­ì œ (DELETE)
```

### 1. ë°±ì—”ë“œ ë¡œì§ (routes/pickup.js)

```javascript
// ìŠ¤ë§ˆíŠ¸ ì‚­ì œ ì‹œìŠ¤í…œ
router.delete('/api/agencies/:id', async (req, res) => {
  // 1. ì‚¬ìš© ì¤‘ì¸ í”½ì—…ê±´ í™•ì¸
  const usageCount = await pool.query(
    `SELECT COUNT(*) FROM airport_pickups 
     WHERE agency_id = $1 AND status = 'active'`
  );
  
  if (usageCount > 0) {
    // 2-A. ì‚¬ìš© ì¤‘ â†’ ë¹„í™œì„±í™”
    await pool.query(
      `UPDATE pickup_agencies SET is_active = false WHERE id = $1`
    );
    return { message: 'ë¹„í™œì„±í™” ì²˜ë¦¬ë¨', deactivated: true };
  } else {
    // 2-B. ë¯¸ì‚¬ìš© â†’ ì™„ì „ ì‚­ì œ
    await pool.query(`DELETE FROM pickup_agencies WHERE id = $1`);
    return { message: 'ì‚­ì œ ì™„ë£Œ', deleted: true };
  }
});
```

### 2. í”„ë¡ íŠ¸ì—”ë“œ UI (agencies.ejs)

#### ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
```javascript
// ë¹„í™œì„±í™”ëœ ì—…ì²´ëŠ” íšŒìƒ‰ ë°°ê²½ìœ¼ë¡œ í‘œì‹œ
<tr class="${!a.is_active ? 'table-secondary' : ''}">
  <td>
    ${a.agency_name}
    ${!a.is_active ? '<small>(ì‚¬ìš©ì¤‘ì¸ í”½ì—…ê±´ ìˆìŒ)</small>' : ''}
  </td>
  <td>
    ${a.is_active 
      ? 'ğŸ—‘ï¸ ì‚­ì œ ë²„íŠ¼'
      : 'âœ… í™œì„±í™” ë²„íŠ¼'
    }
  </td>
</tr>
```

#### ì‚¬ìš©ì ë©”ì‹œì§€
```javascript
// ì‚­ì œ ì‹œë„ ì‹œ
if (deactivated) {
  alert('âš ï¸ í•´ë‹¹ ì—…ì²´ë¥¼ ì‚¬ìš©í•˜ëŠ” í”½ì—…ê±´ì´ Nê±´ ìˆì–´ ë¹„í™œì„±í™” ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
} else {
  alert('âœ… ì—…ì²´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
}
```

## ğŸ¯ ì£¼ìš” ê¸°ëŠ¥

### 1. ìŠ¤ë§ˆíŠ¸ ì‚­ì œ
- âœ… ì‚¬ìš© ì¤‘ì¸ ì—…ì²´ â†’ ìë™ìœ¼ë¡œ ë¹„í™œì„±í™”
- âœ… ë¯¸ì‚¬ìš© ì—…ì²´ â†’ ì™„ì „ ì‚­ì œ
- âœ… ë°ì´í„° ë¬´ê²°ì„± ìœ ì§€

### 2. ì¬í™œì„±í™”
- âœ… ë¹„í™œì„±í™”ëœ ì—…ì²´ë¥¼ ë‹¤ì‹œ í™œì„±í™” ê°€ëŠ¥
- âœ… "í™œì„±í™”" ë²„íŠ¼ìœ¼ë¡œ ì›í´ë¦­ ë³µêµ¬

### 3. ì‹œê°ì  êµ¬ë¶„
- âœ… ë¹„í™œì„± ì—…ì²´: íšŒìƒ‰ ë°°ê²½
- âœ… í™œì„± ì—…ì²´: ì¼ë°˜ ë°°ê²½
- âœ… ìƒíƒœ ë°°ì§€: í™œì„±(ë…¹ìƒ‰) / ë¹„í™œì„±(íšŒìƒ‰)

### 4. ë¶€ë¶„ ì—…ë°ì´íŠ¸ ì§€ì›
- âœ… is_activeë§Œ ì „ì†¡í•´ë„ ì—…ë°ì´íŠ¸ ê°€ëŠ¥
- âœ… ë‹¤ë¥¸ í•„ë“œëŠ” ê¸°ì¡´ ê°’ ìœ ì§€

## ğŸ“Š ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ì‚¬ìš© ì¤‘ì¸ ì—…ì²´ ì‚­ì œ
```
1. ì‚¬ìš©ì: "ABC ì—…ì²´" ì‚­ì œ í´ë¦­
   â†“
2. ì‹œìŠ¤í…œ: ABC ì—…ì²´ë¥¼ ì‚¬ìš©í•˜ëŠ” í”½ì—…ê±´ 5ê±´ ë°œê²¬
   â†“
3. ì‹œìŠ¤í…œ: is_active = falseë¡œ ë³€ê²½
   â†“
4. ì‚¬ìš©ì: "5ê±´ì˜ í”½ì—…ê±´ì´ ìˆì–´ ë¹„í™œì„±í™” ì²˜ë¦¬ë¨" ë©”ì‹œì§€ í™•ì¸
   â†“
5. ë¦¬ìŠ¤íŠ¸: ABC ì—…ì²´ê°€ íšŒìƒ‰ ë°°ê²½ìœ¼ë¡œ í‘œì‹œë¨
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: ë¯¸ì‚¬ìš© ì—…ì²´ ì‚­ì œ
```
1. ì‚¬ìš©ì: "XYZ ì—…ì²´" ì‚­ì œ í´ë¦­
   â†“
2. ì‹œìŠ¤í…œ: XYZ ì—…ì²´ë¥¼ ì‚¬ìš©í•˜ëŠ” í”½ì—…ê±´ ì—†ìŒ
   â†“
3. ì‹œìŠ¤í…œ: DELETE ì¿¼ë¦¬ ì‹¤í–‰
   â†“
4. ì‚¬ìš©ì: "ì—…ì²´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€ í™•ì¸
   â†“
5. ë¦¬ìŠ¤íŠ¸: XYZ ì—…ì²´ê°€ ëª©ë¡ì—ì„œ ì œê±°ë¨
```

### ì‹œë‚˜ë¦¬ì˜¤ 3: ë¹„í™œì„± ì—…ì²´ ì¬í™œì„±í™”
```
1. ì‚¬ìš©ì: ë¹„í™œì„± ì—…ì²´ì˜ "í™œì„±í™”" ë²„íŠ¼ í´ë¦­
   â†“
2. ì‹œìŠ¤í…œ: is_active = trueë¡œ ë³€ê²½
   â†“
3. ì‚¬ìš©ì: "ì—…ì²´ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€ í™•ì¸
   â†“
4. ë¦¬ìŠ¤íŠ¸: ì¼ë°˜ ë°°ê²½ìœ¼ë¡œ í‘œì‹œ, "ì‚­ì œ" ë²„íŠ¼ í‘œì‹œë¨
```

## ğŸ›¡ï¸ ì•ˆì „ ì¥ì¹˜

### 1. ì™¸ë˜í‚¤ ì œì•½ì¡°ê±´ ì²˜ë¦¬
```javascript
if (error.code === '23503') {  // Foreign key violation
  return 'ë¹„í™œì„±í™” ì²˜ë¦¬ë©ë‹ˆë‹¤';
}
```

### 2. í™•ì¸ ë©”ì‹œì§€
```javascript
confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€» í”½ì—… ì˜ˆì•½ì´ ìˆìœ¼ë©´ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.')
```

### 3. ìƒì„¸ í”¼ë“œë°±
- ì‚¬ìš© ì¤‘ì¸ í”½ì—…ê±´ ê°œìˆ˜ í‘œì‹œ
- ë¹„í™œì„±í™” ì´ìœ  ì„¤ëª…
- ë‹¤ìŒ ì•¡ì…˜ ê°€ì´ë“œ

## ğŸš€ í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. ì‚¬ìš© ì¤‘ì¸ ì—…ì²´ ì‚­ì œ í…ŒìŠ¤íŠ¸
```sql
-- 1. í”½ì—… ì˜ˆì•½ì´ ìˆëŠ” ì—…ì²´ í™•ì¸
SELECT a.agency_name, COUNT(ap.id) as pickup_count
FROM pickup_agencies a
LEFT JOIN airport_pickups ap ON a.id = ap.agency_id
WHERE ap.status = 'active'
GROUP BY a.id, a.agency_name
HAVING COUNT(ap.id) > 0;

-- 2. í•´ë‹¹ ì—…ì²´ ì‚­ì œ ì‹œë„ â†’ ë¹„í™œì„±í™” ì²˜ë¦¬ë¨
-- 3. is_active = false í™•ì¸
```

### 2. ë¯¸ì‚¬ìš© ì—…ì²´ ì‚­ì œ í…ŒìŠ¤íŠ¸
```sql
-- 1. í”½ì—… ì˜ˆì•½ì´ ì—†ëŠ” ì—…ì²´ í™•ì¸
SELECT a.* FROM pickup_agencies a
LEFT JOIN airport_pickups ap ON a.id = ap.agency_id
WHERE ap.id IS NULL;

-- 2. í•´ë‹¹ ì—…ì²´ ì‚­ì œ ì‹œë„ â†’ ì™„ì „ ì‚­ì œë¨
-- 3. í…Œì´ë¸”ì—ì„œ ì œê±°ë¨ í™•ì¸
```

## ğŸ“ ë³€ê²½ ë‚´ì—­

### íŒŒì¼ ìˆ˜ì •
1. **routes/pickup.js**
   - DELETE `/api/agencies/:id` - ìŠ¤ë§ˆíŠ¸ ì‚­ì œ ë¡œì§
   - PUT `/api/agencies/:id` - ë¶€ë¶„ ì—…ë°ì´íŠ¸ ì§€ì›

2. **views/pickup/agencies.ejs**
   - deleteAgency() - ì—ëŸ¬ ì²˜ë¦¬ ê°œì„ 
   - activateAgency() - ì¬í™œì„±í™” ê¸°ëŠ¥ ì¶”ê°€
   - ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ - ì‹œê°ì  êµ¬ë¶„ ì¶”ê°€

## ğŸ‰ ì™„ë£Œ!

ì´ì œ ì—…ì²´ ì‚­ì œê°€ ì•ˆì „í•˜ê³  ìŠ¤ë§ˆíŠ¸í•˜ê²Œ ì‘ë™í•©ë‹ˆë‹¤:
- âœ… ì™¸ë˜í‚¤ ì—ëŸ¬ ì—†ìŒ
- âœ… ë°ì´í„° ë¬´ê²°ì„± ìœ ì§€
- âœ… ì‚¬ìš©ì ì¹œí™”ì ì¸ ë©”ì‹œì§€
- âœ… ì¬í™œì„±í™” ê°€ëŠ¥

---

**ì‘ì„±ì¼**: 2025-10-15  
**ë²„ì „**: 2.0.0
