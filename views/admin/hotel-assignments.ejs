<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - ê´Œì„¸ì´ë¸Œì¹´ë“œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* ëª¨ë‹¬ ë‚´ë¶€ëŠ” ì¸ë°•ìŠ¤ì™€ ë™ì¼í•œ í°íŠ¸ í¬ê¸° (30% ì¶•ì†Œ) */
        body {
            font-size: 0.8rem;
            background: #f5f7fa;
        }
        
        /* ëª¨ë‹¬ ì „ìš© ìŠ¤íƒ€ì¼ - ì¸ë°•ìŠ¤ì™€ ë™ì¼ */
        .modal-body .form-label {
            font-size: 0.7rem !important;
            margin-bottom: 0.25rem;
        }
        .modal-body .form-control, .modal-body .form-select {
            font-size: 0.7rem !important;
            padding: 0.25rem 0.5rem !important;
        }
        .modal-body h2 {
            font-size: 1.4rem !important;
        }
        .modal-body h5 {
            font-size: 0.875rem !important;
        }
        .modal-body h6 {
            font-size: 0.75rem !important;
        }
        .modal-body .btn {
            font-size: 0.7rem !important;
            padding: 0.375rem 0.75rem !important;
        }
        
        .stats-card {
            border-radius: 12px;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .reservation-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .reservation-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .reservation-table th {
            padding: 12px 8px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
            border-right: 1px solid rgba(255,255,255,0.2);
        }
        .reservation-table th:last-child {
            border-right: none;
        }
        .reservation-table tbody tr {
            border-bottom: 1px solid #e9ecef;
            transition: background 0.2s;
        }
        .reservation-table tbody tr:hover {
            background: #f8f9fa;
        }
        .reservation-table td {
            padding: 10px 8px;
            font-size: 0.75rem;
            vertical-align: middle;
            text-align: center;
            border-right: 1px solid #e9ecef;
        }
        .reservation-table td:last-child {
            border-right: none;
        }
        
        .status-badge {
            padding: 0.35rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-processing { background: #d1ecf1; color: #0c5460; }
        .status-confirmed { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        .status-modifying { background: #e2e3e5; color: #383d41; }
        
        .action-btn {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 2px solid;
            transition: all 0.3s;
            margin: 0 4px;
            font-size: 1.2rem;
            cursor: pointer;
            background: white;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .btn-edit { border-color: #17a2b8; color: #17a2b8; }
        .btn-edit:hover { background: #17a2b8; color: white !important; }
        
        .btn-assignment { border-color: #6f42c1; color: #6f42c1; }
        .btn-assignment:hover { background: #6f42c1; color: white !important; }
        
        .btn-confirm { border-color: #28a745; color: #28a745; }
        .btn-confirm:hover { background: #28a745; color: white !important; }
        
        .btn-voucher { border-color: #fd7e14; color: #fd7e14; }
        .btn-voucher:hover { background: #fd7e14; color: white !important; }
        
        .btn-settlement { border-color: #dc3545; color: #dc3545; }
        .btn-settlement:hover { background: #dc3545; color: white !important; }
        
        .room-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }
        
        .date-info {
            background: #f8f9fa;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.75rem;
        }
        
        .search-box {
            border-radius: 25px;
            border: 2px solid #e0e0e0;
            padding: 0.5rem 1.5rem;
            transition: all 0.3s;
        }
        .search-box:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            outline: none;
        }
        
        .filter-btn {
            border-radius: 20px;
            padding: 0.4rem 1rem;
            font-size: 0.75rem;
            margin: 0 0.25rem;
            border: 2px solid #e0e0e0;
            background: white;
            transition: all 0.3s;
            cursor: pointer;
        }
        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .guest-list {
            font-size: 0.7rem;
            color: #666;
            margin-top: 0.5rem;
        }
        
        .price-tag {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .reservation-date-badge {
            background: #ffc107;
            color: #000;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        /* ì¸ë°•ìŠ¤ ìŠ¤íƒ€ì¼ ë³µì‚¬ - ëª¨ë‹¬ìš© */
        .modal-body .room-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f8f9fa;
        }
        .modal-body .room-card.active {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .modal-body .guest-card {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            background: white;
        }
        .modal-body .extra-item-card {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            background: #fff;
        }
        .modal-body .btn-add-room, 
        .modal-body .btn-add-guest, 
        .modal-body .btn-add-extra {
            border: 2px dashed #667eea;
            color: #667eea;
            background: white;
            font-weight: 600;
            transition: all 0.3s;
        }
        .modal-body .btn-add-room:hover, 
        .modal-body .btn-add-guest:hover, 
        .modal-body .btn-add-extra:hover {
            background: #667eea;
            color: white;
            border-style: solid;
        }
        .modal-body .total-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
        }
        .modal-body #status {
            font-weight: 600;
        }
        .modal-body #status option[value="pending"] {
            background-color: #fff3cd;
            color: #856404;
        }
        .modal-body #status option[value="processing"] {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .modal-body #status option[value="confirmed"] {
            background-color: #d4edda;
            color: #155724;
        }
        .modal-body #status option[value="cancelled"] {
            background-color: #f8d7da;
            color: #721c24;
        }
        .modal-body #status option[value="modifying"] {
            background-color: #e2e3e5;
            color: #383d41;
        }
        .modal-body #status.status-pending {
            background-color: #fff3cd;
            color: #856404;
            border-color: #ffc107;
        }
        .modal-body #status.status-processing {
            background-color: #d1ecf1;
            color: #0c5460;
            border-color: #17a2b8;
        }
        .modal-body #status.status-confirmed {
            background-color: #d4edda;
            color: #155724;
            border-color: #28a745;
        }
        .modal-body #status.status-cancelled {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }
        .modal-body #status.status-modifying {
            background-color: #e2e3e5;
            color: #383d41;
            border-color: #6c757d;
        }
        
        /* í”„ë¡œëª¨ì…˜ ìŠ¤íƒ€ì¼ */
        .promo-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            font-weight: 600;
            margin-left: 0.5rem;
            font-size: 0.7rem;
        }
        .rate-display {
            background: #e7f3ff;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #2196F3;
            font-size: 0.7rem;
        }
        .benefit-badge {
            background: #4CAF50;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-right: 0.5rem;
            display: inline-block;
            margin-bottom: 0.25rem;
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar') %>

    <div class="container-fluid mt-4" style="max-width: 1400px;">
        <!-- í—¤ë” -->
        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="fas fa-clipboard-list me-2"></i>í˜¸í…” ìˆ˜ë°°ê´€ë¦¬</h2>
            </div>
        </div>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div style="font-size: 0.7rem; opacity: 0.9;">ëŒ€ê¸°ì¤‘</div>
                                <div style="font-size: 1.8rem; font-weight: bold;" id="stat-pending">0</div>
                            </div>
                            <i class="fas fa-clock" style="font-size: 2.5rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div style="font-size: 0.7rem; opacity: 0.9;">ìˆ˜ë°°ì¤‘</div>
                                <div style="font-size: 1.8rem; font-weight: bold;" id="stat-processing">0</div>
                            </div>
                            <i class="fas fa-paper-plane" style="font-size: 2.5rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div style="font-size: 0.7rem; opacity: 0.9;">í™•ì •</div>
                                <div style="font-size: 1.8rem; font-weight: bold;" id="stat-confirmed">0</div>
                            </div>
                            <i class="fas fa-check-circle" style="font-size: 2.5rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-secondary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div style="font-size: 0.7rem; opacity: 0.9;">ì „ì²´</div>
                                <div style="font-size: 1.8rem; font-weight: bold;" id="stat-total">0</div>
                            </div>
                            <i class="fas fa-list" style="font-size: 2.5rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê³ ê¸‰ ê²€ìƒ‰ ë° í•„í„° -->
        <div class="card mb-4" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div class="card-body">
                <!-- ì²« ë²ˆì§¸ ì¤„: ê¸°ë³¸ ê²€ìƒ‰ -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <input type="text" class="form-control search-box" id="searchBox" placeholder="ğŸ” ì˜ˆì•½ë²ˆí˜¸, í˜¸í…”ëª…, ê³ ê°ëª…ìœ¼ë¡œ ê²€ìƒ‰..." onkeyup="filterReservations()">
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleAdvancedFilter()">
                            <i class="fas fa-filter me-1"></i>ìƒì„¸ ê²€ìƒ‰
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="resetFilters()">
                            <i class="fas fa-redo me-1"></i>ì´ˆê¸°í™”
                        </button>
                    </div>
                </div>

                <!-- ê³ ê¸‰ í•„í„° ì˜ì—­ (ì ‘ê¸°/í¼ì¹˜ê¸°) -->
                <div id="advancedFilterArea" style="display: none;">
                    <hr class="my-3">
                    <div class="row g-2">
                        <!-- ë‚ ì§œ ê²€ìƒ‰ -->
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">ë‚ ì§œ ê¸°ì¤€</label>
                            <select class="form-select form-select-sm" id="dateType">
                                <option value="check_in">ì¶œë°œì¼(ì²´í¬ì¸)</option>
                                <option value="reservation">ì˜ˆì•½ì¼</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">ì‹œì‘ì¼</label>
                            <input type="date" class="form-control form-control-sm" id="startDate">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">ì¢…ë£Œì¼</label>
                            <input type="date" class="form-control form-control-sm" id="endDate">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">ê±°ë˜ì²˜</label>
                            <select class="form-select form-select-sm" id="agencyFilter">
                                <option value="">ì „ì²´</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">êµ­ê°€/ì§€ì—­</label>
                            <select class="form-select form-select-sm" id="countryFilter">
                                <option value="">ì „ì²´</option>
                                <option value="ê´Œ">ê´Œ</option>
                                <option value="ì‚¬ì´íŒ">ì‚¬ì´íŒ</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">í˜¸í…”ëª…</label>
                            <select class="form-select form-select-sm" id="hotelFilter">
                                <option value="">ì „ì²´</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">ë‹´ë‹¹ì</label>
                            <select class="form-select form-select-sm" id="assignedToFilter">
                                <option value="">ì „ì²´</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">&nbsp;</label>
                            <button class="btn btn-sm btn-primary w-100" onclick="filterReservations()">
                                <i class="fas fa-search me-1"></i>ê²€ìƒ‰
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ìƒíƒœ í•„í„° ë²„íŠ¼ -->
                <div class="mt-3 d-flex justify-content-center flex-wrap gap-2">
                    <button class="filter-btn active" data-status="all" onclick="filterByStatus('all')">
                        <i class="fas fa-list me-1"></i>ì „ì²´
                    </button>
                    <button class="filter-btn" data-status="pending" onclick="filterByStatus('pending')">
                        <i class="fas fa-clock me-1"></i>ëŒ€ê¸°ì¤‘
                    </button>
                    <button class="filter-btn" data-status="processing" onclick="filterByStatus('processing')">
                        <i class="fas fa-paper-plane me-1"></i>ìˆ˜ë°°ì¤‘
                    </button>
                    <button class="filter-btn" data-status="confirmed" onclick="filterByStatus('confirmed')">
                        <i class="fas fa-check me-1"></i>í™•ì •
                    </button>
                    <button class="filter-btn" data-status="modifying" onclick="filterByStatus('modifying')">
                        <i class="fas fa-edit me-1"></i>ìˆ˜ì •ì¤‘
                    </button>
                    <button class="filter-btn" data-status="cancelled" onclick="filterByStatus('cancelled')">
                        <i class="fas fa-times me-1"></i>ì·¨ì†Œ
                    </button>
                </div>
            </div>
        </div>

        <!-- ì˜ˆì•½ ë¦¬ìŠ¤íŠ¸ -->
        <div id="reservationsContainer">
            <!-- ì˜ˆì•½ ì¹´ë“œê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
        </div>

        <!-- ë¡œë”© -->
        <div id="loading" class="text-center py-5" style="display: none;">
            <i class="fas fa-spinner fa-spin fa-3x text-primary"></i>
            <p class="mt-3">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <!-- ë¹ˆ ìƒíƒœ -->
        <div id="emptyState" class="text-center py-5" style="display: none;">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <p class="text-muted">ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
    </div>

    <!-- ì˜ˆì•½ ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal fade" id="editReservationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>ì˜ˆì•½ ìˆ˜ì •
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
                    <!-- í˜¸í…”ì •ë³´ ë° ê¸°ë³¸ì •ë³´ ì„¹ì…˜ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-hotel me-2"></i>í˜¸í…”ì •ë³´ ë° ê¸°ë³¸ì •ë³´
                            </h6>
                        </div>
                        <div class="col-12 mb-2">
                            <div class="d-flex align-items-center gap-1">
                                <label class="form-label mb-0" style="min-width: 55px;">í˜¸í…”ëª…*</label>
                                <select class="form-control form-control-sm" id="hotel_id" required disabled style="background: #e9ecef; cursor: not-allowed; flex: 1.5;">
                                    <option value="">í˜¸í…” ì„ íƒ</option>
                                </select>
                                <label class="form-label mb-0 ms-1" style="min-width: 75px;">ì˜ˆì•½ê±°ë˜ì²˜</label>
                                <select class="form-control form-control-sm" id="booking_agency_id" disabled style="background: #e9ecef; cursor: not-allowed; flex: 1.5;">
                                    <option value="">ê±°ë˜ì²˜ ì„ íƒ</option>
                                </select>
                                <label class="form-label mb-0 ms-1" style="min-width: 65px;">ì˜ˆì•½ë²ˆí˜¸*</label>
                                <input type="text" class="form-control form-control-sm" id="reservation_number" required style="flex: 1;">
                                <label class="form-label mb-0 ms-1" style="min-width: 50px;">ì˜ˆì•½ì¼</label>
                                <input type="date" class="form-control form-control-sm fw-bold" id="reservation_date" readonly style="background: #f0f0f0; flex: 1;">
                                <label class="form-label mb-0 ms-1" style="min-width: 40px;">ìƒíƒœ</label>
                                <select class="form-control form-control-sm" id="status" style="flex: 0.8;">
                                    <option value="pending">ëŒ€ê¸°ì¤‘</option>
                                    <option value="processing">ìˆ˜ë°°ì¤‘</option>
                                    <option value="confirmed">í™•ì •</option>
                                    <option value="cancelled">ì˜ˆì•½ì·¨ì†Œ</option>
                                    <option value="modifying">ìˆ˜ì •ì¤‘(ì˜ˆì•½ë³€ê²½)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ë‚ ì§œ ì •ë³´ ì„¹ì…˜ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-calendar me-2"></i>ë‚ ì§œ ì •ë³´
                            </h6>
                        </div>
                        <div class="col-md-4 mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0" style="width: 40%;">ì²´í¬ì¸ *</label>
                                <input type="date" class="form-control" id="check_in_date" required onchange="calculateNights(); autoApplyPromotion();" style="width: 60%;">
                            </div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0" style="width: 40%;">ì²´í¬ì•„ì›ƒ *</label>
                                <input type="date" class="form-control" id="check_out_date" required onchange="calculateNights(); autoApplyPromotion();" style="width: 60%;">
                            </div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0" style="width: 40%;">ë°•ìˆ˜</label>
                                <input type="number" class="form-control fw-bold" id="nights" readonly style="background: #f0f0f0; width: 60%;">
                            </div>
                        </div>
                    </div>

                    <!-- í•­ê³µí¸ ì •ë³´ ì„¹ì…˜ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-plane me-2"></i>í•­ê³µí¸ ì •ë³´
                            </h6>
                        </div>
                        <div class="col-md-6 mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0" style="width: 40%;">ì…êµ­ í•­ê³µí¸ëª…</label>
                                <input type="text" class="form-control" id="arrival_flight" placeholder="ì˜ˆ: KE123" style="width: 60%;">
                            </div>
                        </div>
                        <div class="col-md-6 mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0" style="width: 40%;">ì¶œêµ­ í•­ê³µí¸ëª…</label>
                                <input type="text" class="form-control" id="departure_flight" placeholder="ì˜ˆ: KE124" style="width: 60%;">
                            </div>
                        </div>
                    </div>

                    <!-- í”„ë¡œëª¨ì…˜ ì½”ë“œ ì„¹ì…˜ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-tag me-2"></i>í”„ë¡œëª¨ì…˜ ìš”ê¸ˆ
                            </h6>
                        </div>
                        <div class="col-md-12">
                            <div id="promoResult" style="display: none;">
                                <!-- í”„ë¡œëª¨ì…˜ ê²°ê³¼ê°€ í‘œì‹œë¨ -->
                            </div>
                            <div id="promoLoading" style="display: none;" class="text-center py-2">
                                <i class="fas fa-spinner fa-spin"></i> í”„ë¡œëª¨ì…˜ ìš”ê¸ˆ ì¡°íšŒ ì¤‘...
                            </div>
                            <div id="noPromo" class="alert alert-info py-2">
                                í”„ë¡œëª¨ì…˜ ì •ë³´ ì—†ìŒ
                            </div>
                        </div>
                    </div>

                    <!-- ê°ì‹¤ ì •ë³´ ì„¹ì…˜ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-bed me-2"></i>ê°ì‹¤ ì •ë³´
                            </h6>
                        </div>
                        <div class="col-12" id="roomsContainer">
                            <!-- ê°ì‹¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                        </div>
                        <div class="col-12">
                            <button type="button" class="btn btn-add-room w-100" onclick="addRoom()">
                                <i class="fas fa-plus-circle me-2"></i>ê°ì‹¤ ì¶”ê°€
                            </button>
                        </div>
                    </div>

                    <!-- ì¶”ê°€ í•­ëª© ì„¹ì…˜ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-plus-square me-2"></i>ì¶”ê°€ í•­ëª© (ê³µí•­í”½ì—…, ê½ƒë°”êµ¬ë‹ˆ ë“±)
                            </h6>
                        </div>
                        <div class="col-12" id="extrasContainer">
                            <!-- ì¶”ê°€ í•­ëª©ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                        </div>
                        <div class="col-12">
                            <button type="button" class="btn btn-add-extra w-100" onclick="addExtraItem()">
                                <i class="fas fa-plus-circle me-2"></i>í•­ëª© ì¶”ê°€
                            </button>
                        </div>
                    </div>

                    <!-- ì´ ìš”ê¸ˆ ì„¹ì…˜ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="total-summary">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>ì´ ê°ì‹¤ ìš”ê¸ˆ:</span>
                                    <div class="input-group input-group-sm" style="width: 150px;">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="totalRoomCharge" value="0" step="0.01" min="0" onchange="calculateTotal()" style="text-align: right; font-weight: bold; max-width: 60%;">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span id="breakfastChargeLabel">ì¡°ì‹ ìš”ê¸ˆ (ë¶ˆí¬í•¨):</span>
                                    <div class="input-group input-group-sm" style="width: 150px;">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="totalBreakfastCharge" value="0" step="0.01" min="0" readonly style="text-align: right; font-weight: bold; max-width: 60%; background: #e7f3ff;">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>ì¶”ê°€ í•­ëª© ìš”ê¸ˆ:</span>
                                    <div class="input-group input-group-sm" style="width: 150px;">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="totalExtrasCharge" value="0" step="0.01" min="0" onchange="calculateTotal()" style="text-align: right; font-weight: bold; max-width: 60%;">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2" id="agencyFeeRow" style="display: none;">
                                    <span>ìˆ˜ë°°í”¼ (<span id="agencyFeeName"></span>):</span>
                                    <div class="input-group input-group-sm" style="width: 150px;">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="agencyFee" value="0" step="0.01" min="0" onchange="calculateTotal()" style="text-align: right; font-weight: bold; max-width: 60%;">
                                    </div>
                                </div>
                                <hr style="border-color: rgba(255,255,255,0.3);">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">ì´ íŒë§¤ê°€:</h5>
                                    <h4 class="mb-0" id="grandTotal">$0.00</h4>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ë©”ëª¨ ì„¹ì…˜ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-sticky-note me-2"></i>ë©”ëª¨
                            </h6>
                        </div>
                        <div class="col-12 mb-2">
                            <div class="d-flex gap-2">
                                <label class="form-label mb-0" style="width: 20%;">íŠ¹ë³„ ìš”ì²­ì‚¬í•­</label>
                                <textarea class="form-control" id="special_requests" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="col-12 mb-2">
                            <div class="d-flex gap-2">
                                <label class="form-label mb-0" style="width: 20%;">ë‚´ë¶€ ë©”ëª¨</label>
                                <textarea class="form-control" id="internal_memo" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-success btn-lg" onclick="saveReservationChanges()">
                        <i class="fas fa-save me-1"></i>ì €ì¥
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ìˆ˜ë°°ì„œ ìƒì„±/ë³´ê¸° ëª¨ë‹¬ -->
    <div class="modal fade" id="assignmentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-file-alt me-2"></i>Hotel Booking Confirmation
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="assignmentContent" style="background: white;">
                    <!-- ìˆ˜ë°°ì„œ ë‚´ìš©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="sendAssignmentEmail()">
                        <i class="fas fa-envelope me-1"></i>Send to Hotel
                    </button>
                    <button type="button" class="btn btn-info" onclick="copyAssignmentLink()">
                        <i class="fas fa-link me-1"></i>Copy Link
                    </button>
                    <button type="button" class="btn btn-success" onclick="printAssignment()">
                        <i class="fas fa-print me-1"></i>Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allReservations = [];
        let currentFilter = 'all';
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        document.addEventListener('DOMContentLoaded', function() {
            loadReservations();
        });
        
        // ì˜ˆì•½ ëª©ë¡ ë¡œë“œ
        async function loadReservations() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            
            try {
                const response = await fetch('/api/hotel-reservations');
                const data = await response.json();
                
                allReservations = data;
                displayReservations(allReservations);
                updateStats(allReservations);
                
            } catch (error) {
                console.error('ì˜ˆì•½ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì˜ˆì•½ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // ì˜ˆì•½ ì¹´ë“œ í‘œì‹œ
        function displayReservations(reservations) {
            const container = document.getElementById('reservationsContainer');
            
            if (reservations.length === 0) {
                container.innerHTML = '';
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            
            document.getElementById('emptyState').style.display = 'none';
            
            container.innerHTML = `
                <table class="reservation-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;">No</th>
                            <th style="width: 80px;">ì˜ˆì•½ì¼</th>
                            <th style="width: 120px;">ì˜ˆì•½ë²ˆí˜¸</th>
                            <th style="width: 80px;">ì¶œë°œì¼</th>
                            <th style="width: 90px;">ê±°ë˜ì²˜</th>
                            <th style="width: 70px;">ë‹´ë‹¹ì</th>
                            <th style="width: 350px;">ì§„í–‰ìƒíƒœ</th>
                            <th style="width: 80px;">ëŒ€í‘œì˜ˆì•½ì</th>
                            <th style="width: 50px;">ì§€ì—­</th>
                            <th style="min-width: 150px;">í˜¸í…”ëª…</th>
                            <th style="min-width: 150px;">ë£¸íƒ€ì…</th>
                            <th style="width: 90px;">ë°©ê°œìˆ˜/ì¸ì›</th>
                            <th style="width: 280px;">ì•¡ì…˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${reservations.map((res, index) => `
                            <tr data-reservation-id="${res.id}" data-status="${res.status}">
                                <td>${index + 1}</td>
                                <td>${formatDateShort(res.reservation_date)}</td>
                                <td style="font-weight: 600; color: #2c3e50;">${res.reservation_number}</td>
                                <td>${formatDateShort(res.check_in_date)}</td>
                                <td style="font-size: 0.7rem;">${res.agency_name || '-'}</td>
                                <td>
                                    <span class="badge bg-info" style="font-size: 0.65rem;">${res.assigned_to || 'ë¯¸ë°°ì •'}</span>
                                    ${res.has_memo ? '<br><span class="badge bg-warning mt-1" style="font-size: 0.6rem;"><i class="fas fa-sticky-note"></i></span>' : ''}
                                </td>
                                <td style="padding: 5px;">
                                    ${getProgressBarCompact(res)}
                                </td>
                                <td style="font-size: 0.7rem;">${res.representative_name || '-'}</td>
                                <td><span class="badge bg-secondary" style="font-size: 0.65rem;">${res.region || 'ê´Œ'}</span></td>
                                <td style="text-align: left; font-size: 0.7rem;">${res.hotel_name || '-'}</td>
                                <td style="text-align: left; font-size: 0.65rem;">${res.room_types || '-'}</td>
                                <td>
                                    <span class="badge bg-primary" style="font-size: 0.65rem;">${res.total_rooms || 0}ê°œ</span>
                                    <span class="badge bg-success" style="font-size: 0.65rem;">${res.total_guests || 0}ëª…</span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary btn-sm" onclick="editReservation(${res.id})" title="ì˜ˆì•½ë³€ê²½">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="createAssignment(${res.id})" title="ìˆ˜ë°°ì„œ">
                                            <i class="fas fa-file-alt"></i>
                                        </button>
                                        <button class="btn btn-outline-success btn-sm" onclick="confirmReservation(${res.id})" title="í™•ì •">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn btn-outline-info btn-sm" onclick="createVoucher(${res.id})" title="ë°”ìš°ì²˜">
                                            <i class="fas fa-ticket-alt"></i>
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm" onclick="createSettlement(${res.id})" title="ì •ì‚°">
                                            <i class="fas fa-dollar-sign"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats(reservations) {
            const pending = reservations.filter(r => r.status === 'pending').length;
            const processing = reservations.filter(r => r.status === 'processing').length;
            const confirmed = reservations.filter(r => r.status === 'confirmed').length;
            
            document.getElementById('stat-pending').textContent = pending;
            document.getElementById('stat-processing').textContent = processing;
            document.getElementById('stat-confirmed').textContent = confirmed;
            document.getElementById('stat-total').textContent = reservations.length;
        }
        
        // ìƒíƒœë³„ í•„í„°ë§
        function filterByStatus(status) {
            currentFilter = status;
            
            // í•„í„° ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-status="${status}"]`).classList.add('active');
            
            // í•„í„°ë§
            filterReservations();
        }
        
        // ê²€ìƒ‰ ë° í•„í„°
        function filterReservations() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            let filtered = allReservations;
            
            // ìƒíƒœ í•„í„°
            if (currentFilter !== 'all') {
                filtered = filtered.filter(r => r.status === currentFilter);
            }
            
            // ê¸°ë³¸ ê²€ìƒ‰ì–´ í•„í„°
            if (searchTerm) {
                filtered = filtered.filter(r => {
                    return (r.reservation_number && r.reservation_number.toLowerCase().includes(searchTerm)) ||
                           (r.hotel_name && r.hotel_name.toLowerCase().includes(searchTerm)) ||
                           (r.representative_name && r.representative_name.toLowerCase().includes(searchTerm));
                });
            }
            
            // ê³ ê¸‰ í•„í„°
            const dateType = document.getElementById('dateType')?.value;
            const startDate = document.getElementById('startDate')?.value;
            const endDate = document.getElementById('endDate')?.value;
            const agencyFilter = document.getElementById('agencyFilter')?.value;
            const countryFilter = document.getElementById('countryFilter')?.value;
            const hotelFilter = document.getElementById('hotelFilter')?.value;
            const assignedToFilter = document.getElementById('assignedToFilter')?.value;
            
            if (startDate || endDate) {
                filtered = filtered.filter(r => {
                    const targetDate = dateType === 'reservation' ? r.reservation_date : r.check_in_date;
                    if (startDate && targetDate < startDate) return false;
                    if (endDate && targetDate > endDate) return false;
                    return true;
                });
            }
            
            if (agencyFilter) {
                filtered = filtered.filter(r => r.agency_name === agencyFilter);
            }
            
            if (countryFilter) {
                filtered = filtered.filter(r => (r.region || 'ê´Œ') === countryFilter);
            }
            
            if (hotelFilter) {
                filtered = filtered.filter(r => r.hotel_name === hotelFilter);
            }
            
            if (assignedToFilter) {
                filtered = filtered.filter(r => r.assigned_to === assignedToFilter);
            }
            
            displayReservations(filtered);
        }
        
        // ìƒì„¸ í•„í„° í† ê¸€
        function toggleAdvancedFilter() {
            const filterArea = document.getElementById('advancedFilterArea');
            if (filterArea.style.display === 'none') {
                filterArea.style.display = 'block';
                // í•„í„° ì˜µì…˜ ë¡œë“œ
                loadFilterOptions();
            } else {
                filterArea.style.display = 'none';
            }
        }
        
        // í•„í„° ì˜µì…˜ ë¡œë“œ
        function loadFilterOptions() {
            // ê±°ë˜ì²˜ ëª©ë¡
            const agencies = [...new Set(allReservations.map(r => r.agency_name).filter(Boolean))];
            const agencySelect = document.getElementById('agencyFilter');
            agencySelect.innerHTML = '<option value="">ì „ì²´</option>' +
                agencies.map(a => `<option value="${a}">${a}</option>`).join('');
            
            // í˜¸í…” ëª©ë¡
            const hotels = [...new Set(allReservations.map(r => r.hotel_name).filter(Boolean))];
            const hotelSelect = document.getElementById('hotelFilter');
            hotelSelect.innerHTML = '<option value="">ì „ì²´</option>' +
                hotels.map(h => `<option value="${h}">${h}</option>`).join('');
            
            // ë‹´ë‹¹ì ëª©ë¡
            const assignedTos = [...new Set(allReservations.map(r => r.assigned_to).filter(Boolean))];
            const assignedToSelect = document.getElementById('assignedToFilter');
            assignedToSelect.innerHTML = '<option value="">ì „ì²´</option>' +
                assignedTos.map(a => `<option value="${a}">${a}</option>`).join('');
        }
        
        // í•„í„° ì´ˆê¸°í™”
        function resetFilters() {
            document.getElementById('searchBox').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('agencyFilter').value = '';
            document.getElementById('countryFilter').value = '';
            document.getElementById('hotelFilter').value = '';
            document.getElementById('assignedToFilter').value = '';
            filterReservations();
        }
        
        // ìƒíƒœ ìƒ‰ìƒ
        function getStatusColor(status) {
            const colorMap = {
                'pending': '#ffc107',
                'processing': '#17a2b8',
                'confirmed': '#28a745',
                'cancelled': '#dc3545',
                'modifying': '#6c757d'
            };
            return colorMap[status] || '#6c757d';
        }
        
        // ì§„í–‰ë„ ë°” ìƒì„± (ì»´íŒ©íŠ¸)
        function getProgressBarCompact(res) {
            const steps = [
                { key: 'pending', label: 'ì ‘ìˆ˜', color: '#17a2b8' },
                { key: 'processing', label: 'í˜¸í…”ìˆ˜ë°°ì¤‘', color: '#17a2b8' },
                { key: 'confirmed', label: 'í™•ì •', color: '#28a745' },
                { key: 'voucher', label: 'ë°”ìš°ì²˜ë°œí–‰', color: '#6f42c1' },
                { key: 'settlement', label: 'ì •ì‚°ì™„ë£Œ', color: '#ffc107' }
            ];
            
            const statusOrder = ['pending', 'processing', 'confirmed', 'voucher', 'settlement'];
            const currentIndex = statusOrder.indexOf(res.status);
            
            return steps.map((step, index) => {
                const isCompleted = index <= currentIndex;
                const bgColor = isCompleted ? step.color : '#e9ecef';
                const textColor = isCompleted ? 'white' : '#6c757d';
                
                return `<span class="badge me-1" style="background: ${bgColor}; color: ${textColor}; font-size: 0.6rem; padding: 3px 6px;">${step.label}</span>`;
            }).join('');
        }
        
        // ì§„í–‰ë„ ë°” ìƒì„± (ì „ì²´)
        function getProgressBar(res) {
            const steps = [
                { key: 'pending', label: 'ëŒ€ê¸°', icon: 'clock' },
                { key: 'processing', label: 'ìˆ˜ë°°', icon: 'paper-plane' },
                { key: 'confirmed', label: 'í™•ì •', icon: 'check' },
                { key: 'voucher', label: 'ë°”ìš°ì²˜', icon: 'ticket-alt' },
                { key: 'settlement', label: 'ì •ì‚°', icon: 'dollar-sign' }
            ];
            
            const statusOrder = ['pending', 'processing', 'confirmed', 'voucher', 'settlement'];
            const currentIndex = statusOrder.indexOf(res.status);
            
            return `
                <div class="progress-steps d-flex justify-content-between align-items-center" style="position: relative;">
                    ${steps.map((step, index) => {
                        const isCompleted = index <= currentIndex;
                        const isCurrent = index === currentIndex;
                        return `
                            <div class="step-item text-center" style="flex: 1; position: relative; z-index: 1;">
                                <div class="step-circle ${isCompleted ? 'active' : ''} ${isCurrent ? 'current' : ''}" 
                                     style="width: 32px; height: 32px; border-radius: 50%; margin: 0 auto 4px; 
                                            display: flex; align-items: center; justify-content: center; font-size: 0.8rem;
                                            background: ${isCompleted ? '#667eea' : '#e9ecef'}; 
                                            color: ${isCompleted ? 'white' : '#6c757d'};
                                            border: ${isCurrent ? '3px solid #667eea' : 'none'};
                                            box-shadow: ${isCurrent ? '0 0 0 4px rgba(102, 126, 234, 0.2)' : 'none'};">
                                    <i class="fas fa-${step.icon}"></i>
                                </div>
                                <div style="font-size: 0.65rem; color: ${isCompleted ? '#667eea' : '#6c757d'}; font-weight: ${isCurrent ? 'bold' : 'normal'};">
                                    ${step.label}
                                </div>
                            </div>
                            ${index < steps.length - 1 ? `
                                <div style="flex: 1; height: 2px; background: ${index < currentIndex ? '#667eea' : '#e9ecef'}; margin: 0 -5px; position: relative; top: -20px;"></div>
                            ` : ''}
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // ë‚ ì§œ í¬ë§· (ì „ì²´)
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // ë‚ ì§œ í¬ë§· (ì§§ê²Œ)
        function formatDateShort(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${month}-${day}`;
        }
        
        // ìƒíƒœ í…ìŠ¤íŠ¸
        function getStatusText(status) {
            const statusMap = {
                'pending': 'ëŒ€ê¸°ì¤‘',
                'processing': 'ìˆ˜ë°°ì¤‘',
                'confirmed': 'í™•ì •',
                'cancelled': 'ì˜ˆì•½ì·¨ì†Œ',
                'modifying': 'ìˆ˜ì •ì¤‘'
            };
            return statusMap[status] || status;
        }
        
        let currentEditingId = null;
        let allHotels = [];
        let allRoomTypes = [];
        let allAgencies = [];
        let roomCounter = 0;
        let extraCounter = 0;
        let currentPromotion = null;
        let roomPromotions = {};
        let isLoadingData = false;  // â­ ë°ì´í„° ë¡œë“œ ì¤‘ í”Œë˜ê·¸ (ì¡°ì‹ ì¤‘ë³µ ë°©ì§€)
        
        // ëª¨ë‹¬ ì˜¤í”ˆ ì‹œ í˜¸í…”/ê±°ë˜ì²˜ ë¡œë“œ
        document.getElementById('editReservationModal').addEventListener('show.bs.modal', async function() {
            await loadHotels();
            await loadAgencies();
        });
        
        // í˜¸í…” ëª©ë¡ ë¡œë“œ
        async function loadHotels() {
            try {
                const response = await fetch('/api/hotels?is_active=true');
                const hotels = await response.json();
                allHotels = hotels;
                
                const select = document.getElementById('hotel_id');
                select.innerHTML = '<option value="">í˜¸í…” ì„ íƒ</option>' +
                    hotels.map(h => `<option value="${h.id}">${h.hotel_name}</option>`).join('');
            } catch (error) {
                console.error('í˜¸í…” ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // ê±°ë˜ì²˜ ëª©ë¡ ë¡œë“œ
        async function loadAgencies() {
            try {
                const response = await fetch('/api/booking-agencies?is_active=true');
                const agencies = await response.json();
                allAgencies = agencies;
                
                const select = document.getElementById('booking_agency_id');
                select.innerHTML = '<option value="">ì§ì ‘ ì˜ˆì•½</option>' +
                    agencies.map(a => `<option value="${a.id}">${a.agency_name}</option>`).join('');
            } catch (error) {
                console.error('ê±°ë˜ì²˜ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // ê°ì‹¤ íƒ€ì… ë¡œë“œ
        async function loadRoomTypes() {
            const hotelId = document.getElementById('hotel_id').value;
            if (!hotelId) return;
            
            try {
                const response = await fetch(`/api/room-types?hotel_id=${hotelId}&is_active=true`);
                allRoomTypes = await response.json();
                
                // ëª¨ë“  ê°ì‹¤ì˜ selectë¥¼ ì—…ë°ì´íŠ¸
                document.querySelectorAll('.room-type-select').forEach(select => {
                    select.innerHTML = '<option value="">ê°ì‹¤ íƒ€ì… ì„ íƒ</option>' +
                        allRoomTypes.map(rt => `<option value="${rt.id}">${rt.room_type_name}</option>`).join('');
                });
            } catch (error) {
                console.error('ê°ì‹¤ íƒ€ì… ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // ë°•ìˆ˜ ê³„ì‚°
        function calculateNights() {
            const checkIn = document.getElementById('check_in_date').value;
            const checkOut = document.getElementById('check_out_date').value;
            
            if (checkIn && checkOut) {
                const date1 = new Date(checkIn);
                const date2 = new Date(checkOut);
                const diff = Math.ceil((date2 - date1) / (1000 * 60 * 60 * 24));
                
                document.getElementById('nights').value = diff > 0 ? diff : 0;
            }
        }
        
        // ì¡°ì‹ ìš”ê¸ˆ ë¼ë²¨ ì—…ë°ì´íŠ¸ (í¬í•¨/ë¶ˆí¬í•¨ ë™ì  í‘œì‹œ)
        function updateBreakfastLabel() {
            const label = document.getElementById('breakfastChargeLabel');
            if (!label) return;
            
            // ëª¨ë“  ê°ì‹¤ì˜ ì¡°ì‹ í¬í•¨ ì—¬ë¶€ í™•ì¸
            let hasBreakfast = false;
            const roomCards = document.querySelectorAll('.room-card');
            roomCards.forEach(card => {
                const roomId = card.dataset.roomId;
                const checkbox = document.getElementById(`breakfast_included_${roomId}`);
                if (checkbox && checkbox.checked) {
                    hasBreakfast = true;
                }
            });
            
            // ë¼ë²¨ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            label.textContent = hasBreakfast ? 'ì¡°ì‹ ìš”ê¸ˆ (í¬í•¨):' : 'ì¡°ì‹ ìš”ê¸ˆ (ë¶ˆí¬í•¨):';
        }
        
        // ì „ì²´ ê¸ˆì•¡ ê³„ì‚° (â­ ìˆ˜ë°°í”¼ëŠ” ì €ì¥ëœ ê°’ ì‚¬ìš© - ì¬ê³„ì‚° ì•ˆ í•¨)
        async function calculateTotal() {
            // â“ ê±°ë˜ì²˜ê°€ disabledì´ë¯€ë¡œ ìˆ˜ë°°í”¼ ì¬ê³„ì‚° ì•ˆ í•¨
            // const agencyId = document.getElementById('booking_agency_id').value;
            // if (agencyId) {
            //     await calculateAgencyFee();
            // }
            
            const totalRoomCharge = parseFloat(document.getElementById('totalRoomCharge').value) || 0;
            const totalBreakfastCharge = parseFloat(document.getElementById('totalBreakfastCharge').value) || 0;
            const totalExtrasCharge = parseFloat(document.getElementById('totalExtrasCharge').value) || 0;
            const agencyFee = parseFloat(document.getElementById('agencyFee').value) || 0; // â­ ì €ì¥ëœ ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            
            // â­ ì´ íŒë§¤ê°€ ê³„ì‚° (ì¡°ì‹ìš”ê¸ˆ í¬í•¨)
            const grandTotal = totalRoomCharge + totalBreakfastCharge + totalExtrasCharge + agencyFee;
            
            document.getElementById('grandTotal').textContent = `$${grandTotal.toFixed(2)}`;
            
            // ì¡°ì‹ ë¼ë²¨ ì—…ë°ì´íŠ¸
            updateBreakfastLabel();
        }
        
        // ìˆ˜ë°°í”¼ ê³„ì‚°
        async function calculateAgencyFee() {
            const agencyId = document.getElementById('booking_agency_id').value;
            if (agencyId) {
                const agency = allAgencies.find(a => a.id == agencyId);
                if (agency) {
                    document.getElementById('agencyFeeRow').style.display = 'flex';
                    document.getElementById('agencyFeeName').textContent = agency.agency_name;
                    
                    // â­ ìˆ˜ë°°í”¼ ê¸ˆì•¡ ê³„ì‚°
                    const totalRoomCharge = parseFloat(document.getElementById('totalRoomCharge').value) || 0;
                    const totalExtrasCharge = parseFloat(document.getElementById('totalExtrasCharge').value) || 0;
                    const totalAmount = totalRoomCharge + totalExtrasCharge;
                    
                    let agencyFee = 0;
                    
                    // fee_typeì— ë”°ë¼ ê³„ì‚°
                    if (agency.fee_type === 'percentage') {
                        // í¼ì„¼íŠ¸ ë°©ì‹
                        const feePercent = parseFloat(agency.fee_amount) || 0;
                        agencyFee = totalAmount * (feePercent / 100);
                        console.log(`ğŸ’° ìˆ˜ë°°í”¼ ê³„ì‚° (${agency.agency_name}): $${totalAmount} Ã— ${feePercent}% = $${agencyFee.toFixed(2)}`);
                    } else {
                        // ì •ì•¡ ë°©ì‹
                        agencyFee = parseFloat(agency.fee_amount) || 0;
                        console.log(`ğŸ’° ìˆ˜ë°°í”¼ ê³„ì‚° (${agency.agency_name}): $${agencyFee.toFixed(2)} (ì •ì•¡)`);
                    }
                    
                    document.getElementById('agencyFee').value = agencyFee.toFixed(2);
                } else {
                    document.getElementById('agencyFeeRow').style.display = 'none';
                    document.getElementById('agencyFee').value = 0;
                }
            } else {
                document.getElementById('agencyFeeRow').style.display = 'none';
                document.getElementById('agencyFee').value = 0;
            }
            calculateTotal();
        }
        
        // í”„ë¡œëª¨ì…˜ ìë™ ì ìš©
        async function autoApplyPromotion() {
            const hotelId = document.getElementById('hotel_id').value;
            const checkIn = document.getElementById('check_in_date').value;
            const checkOut = document.getElementById('check_out_date').value;
            
            // í•„ìˆ˜ ì¡°ê±´ í™•ì¸
            if (!hotelId || !checkIn || !checkOut) {
                return;
            }
            
            // ì²« ë²ˆì§¸ ê°ì‹¤ì˜ room_type_id ê°€ì ¸ì˜¤ê¸°
            const firstRoomType = document.querySelector('.room-type-select');
            if (!firstRoomType || !firstRoomType.value) {
                return;
            }
            
            // ë¡œë”© í‘œì‹œ
            document.getElementById('promoLoading').style.display = 'block';
            document.getElementById('promoResult').style.display = 'none';
            document.getElementById('noPromo').style.display = 'none';
            
            // í”„ë¡œëª¨ì…˜ ì¡°íšŒ (ìë™ìœ¼ë¡œ ê°€ì¥ ìœ ë¦¬í•œ í”„ë¡œëª¨ì…˜ ì°¾ê¸°)
            await findBestPromotion(hotelId, firstRoomType.value, checkIn, checkOut);
        }
        
        // ìµœì  í”„ë¡œëª¨ì…˜ ì°¾ê¸°
        async function findBestPromotion(hotelId, roomTypeId, checkIn, checkOut) {
            try {
                // ëª¨ë“  í™œì„± í”„ë¡œëª¨ì…˜ ì¡°íšŒ
                const response = await fetch('/api/hotel-promotions/list?hotel_id=' + hotelId + '&is_active=true');
                const promotions = await response.json();
                
                if (!promotions || promotions.length === 0) {
                    document.getElementById('promoLoading').style.display = 'none';
                    document.getElementById('noPromo').style.display = 'block';
                    return;
                }
                
                // ê° í”„ë¡œëª¨ì…˜ ìš”ê¸ˆ í™•ì¸ ë° ìµœì €ê°€ ì°¾ê¸°
                let bestPromotion = null;
                let lowestRate = Infinity;
                
                for (const promo of promotions) {
                    const rateResponse = await fetch('/api/hotel-promotions/check-and-get-rates', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            promo_code: promo.promo_code,
                            hotel_id: parseInt(hotelId),
                            room_type_id: parseInt(roomTypeId),
                            check_in_date: checkIn,
                            check_out_date: checkOut,
                            booking_date: new Date().toISOString().split('T')[0]
                        })
                    });
                    
                    const result = await rateResponse.json();
                    
                    if (result.valid && result.total_room_rate < lowestRate) {
                        lowestRate = result.total_room_rate;
                        bestPromotion = result;
                    }
                }
                
                document.getElementById('promoLoading').style.display = 'none';
                
                if (bestPromotion) {
                    currentPromotion = bestPromotion;
                    displayPromotionResult(bestPromotion);
                    updateRoomCharges();
                } else {
                    document.getElementById('noPromo').style.display = 'block';
                }
            } catch (error) {
                console.error('í”„ë¡œëª¨ì…˜ ì¡°íšŒ ì˜¤ë¥˜:', error);
                document.getElementById('promoLoading').style.display = 'none';
                document.getElementById('noPromo').style.display = 'block';
            }
        }
        
        // í”„ë¡œëª¨ì…˜ ê²°ê³¼ í‘œì‹œ
        function displayPromotionResult(result) {
            const promoResult = document.getElementById('promoResult');
            
            let benefitsHtml = '';
            if (result.benefits && result.benefits.length > 0) {
                benefitsHtml = '<div class="mt-2"><strong>ë² ë„¤í•:</strong><br>' +
                    result.benefits.map(b => {
                        let text = '';
                        if (b.benefit_type === 'drink_coupon') text = `ğŸ¹ ë“œë§í¬ ì¿ í° ${b.quantity}ë§¤`;
                        else if (b.benefit_type === 'late_checkout') text = `ğŸ• ë ˆì´íŠ¸ ì²´í¬ì•„ì›ƒ (${b.benefit_value || ''})`;
                        else if (b.benefit_type === 'breakfast') text = `ğŸ³ ì¡°ì‹ ${b.quantity}ì¸ë¶„`;
                        else if (b.benefit_type === 'credit') text = `ğŸ’µ í¬ë ˆë”§ $${b.benefit_value}`;
                        else text = b.description || b.benefit_name || b.benefit_type;
                        return `<span class="benefit-badge">${text}</span>`;
                    }).join('') +
                    '</div>';
            }
            
            promoResult.innerHTML = `
                <div class="alert alert-success py-2">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle me-2"></i>
                        <div class="flex-fill">
                            <strong>í”„ë¡œëª¨ì…˜ ì ìš© ì™„ë£Œ!</strong>
                            <span class="promo-badge">${result.promotion.promo_name}</span>
                            <div class="mt-2">
                                <strong>í”„ë¡œëª¨ì…˜ ì½”ë“œ:</strong> 
                                <code style="font-size: 1.1em; color: #667eea; background: #f0f4ff; padding: 4px 8px; border-radius: 4px;">${result.promotion.promo_code}</code>
                            </div>
                            <div class="small mt-2">
                                ì˜ˆì•½ ê¸°ê°„: ${result.promotion.booking_start_date} ~ ${result.promotion.booking_end_date}<br>
                                íˆ¬ìˆ™ ê¸°ê°„: ${result.promotion.stay_start_date} ~ ${result.promotion.stay_end_date}
                            </div>
                            ${benefitsHtml}
                        </div>
                    </div>
                </div>
                <div class="rate-display mt-2">
                    <h6 class="mb-2"><i class="fas fa-dollar-sign me-1"></i>ë‚ ì§œë³„ í”„ë¡œëª¨ì…˜ ìš”ê¸ˆ</h6>
                    ${result.daily_rates.map(r => `
                        <div class="d-flex justify-content-between">
                            <span>${r.stay_date}:</span>
                            <strong>$${r.rate_per_night.toFixed(2)}</strong>
                        </div>
                    `).join('')}
                    <hr>
                    <div class="d-flex justify-content-between">
                        <strong>1ê°ì‹¤ ì´ì•¡:</strong>
                        <strong class="text-primary fs-5">$${result.total_room_rate.toFixed(2)}</strong>
                    </div>
                </div>
            `;
            
            promoResult.style.display = 'block';
            document.getElementById('noPromo').style.display = 'none';
        }
        
        // ê°ì‹¤ ìš”ê¸ˆ ìë™ ì—…ë°ì´íŠ¸ (ëª¨ë“  ê°ì‹¤ì˜ í”„ë¡œëª¨ì…˜ í•©ì‚°)
        async function updateRoomCharges() {
            let totalRoomCharge = 0;
            let totalBreakfastCharge = 0;
            const appliedPromoCodes = new Set();
            
            // ê° ê°ì‹¤ì˜ í”„ë¡œëª¨ì…˜ ìš”ê¸ˆ í•©ì‚°
            document.querySelectorAll('.room-card').forEach(room => {
                const roomNum = room.dataset.roomId;
                if (roomPromotions[roomNum] && roomPromotions[roomNum].total_room_rate) {
                    totalRoomCharge += roomPromotions[roomNum].total_room_rate;
                    if (roomPromotions[roomNum].promotion && roomPromotions[roomNum].promotion.promo_code) {
                        appliedPromoCodes.add(roomPromotions[roomNum].promotion.promo_code);
                    }
                }
                
                // â­ ì¡°ì‹ ìš”ê¸ˆ ê³„ì‚°
                const breakfastCheckbox = document.getElementById(`breakfast_included_${roomNum}`);
                if (breakfastCheckbox && breakfastCheckbox.checked) {
                    const days = parseInt(document.getElementById(`breakfast_days_${roomNum}`)?.value) || 1;
                    const adultPrice = parseFloat(document.getElementById(`breakfast_adult_price_${roomNum}`)?.value) || 0;
                    const childPrice = parseFloat(document.getElementById(`breakfast_child_price_${roomNum}`)?.value) || 0;
                    
                    // íˆ¬ìˆ™ê° ìˆ˜ ê³„ì‚°
                    let adultCount = 0;
                    let childCount = 0;
                    room.querySelectorAll('.guest-card').forEach(guest => {
                        const ageCategory = guest.querySelector('[data-guest-field="age_category"]')?.value;
                        if (ageCategory === 'adult') adultCount++;
                        else if (ageCategory === 'child') childCount++;
                    });
                    
                    const breakfastCharge = (adultCount * adultPrice * days) + (childCount * childPrice * days);
                    totalBreakfastCharge += breakfastCharge;
                    
                    console.log(`ğŸ³ ê°ì‹¤ ${roomNum} ì¡°ì‹ìš”ê¸ˆ: ì„±ì¸${adultCount}ëª…Ã—$${adultPrice}Ã—${days}ì¼ + ì†Œì•„${childCount}ëª…Ã—$${childPrice}Ã—${days}ì¼ = $${breakfastCharge.toFixed(2)}`);
                }
            });
            
            // í”„ë¡œëª¨ì…˜ ì½”ë“œ í‘œì‹œ (ì—¬ëŸ¬ ê°ì‹¤)
            const promoResult = document.getElementById('promoResult');
            if (appliedPromoCodes.size > 0) {
                const promoCodesHtml = Array.from(appliedPromoCodes).map(code => 
                    `<code style="font-size: 1.1em; color: #667eea; background: #f0f4ff; padding: 4px 8px; border-radius: 4px; margin-right: 5px;">${code}</code>`
                ).join('');
                promoResult.innerHTML = `
                    <div class="alert alert-success py-2">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>í”„ë¡œëª¨ì…˜ ì ìš© ì™„ë£Œ!</strong>
                        <div class="mt-2">
                            <strong>ì ìš©ëœ í”„ë¡œëª¨ì…˜ ì½”ë“œ:</strong> ${promoCodesHtml}
                        </div>
                    </div>
                `;
                promoResult.style.display = 'block';
                document.getElementById('noPromo').style.display = 'none';
            } else {
                promoResult.style.display = 'none';
                document.getElementById('noPromo').style.display = 'block';
            }
            
            document.getElementById('totalRoomCharge').value = totalRoomCharge.toFixed(2);
            document.getElementById('totalBreakfastCharge').value = totalBreakfastCharge.toFixed(2);
            console.log(`ğŸ’° ì´ ê°ì‹¤ìš”ê¸ˆ: $${totalRoomCharge.toFixed(2)}, ì´ ì¡°ì‹ìš”ê¸ˆ: $${totalBreakfastCharge.toFixed(2)}`);
            
            // await calculateAgencyFee(); // â“ ì£¼ì„ ì²˜ë¦¬: ê±°ë˜ì²˜ disabled, ì €ì¥ëœ ìˆ˜ë°°í”¼ ê°’ ìœ ì§€
            calculateTotal();
        }
        
        // íŠ¹ì • ë£¸íƒ€ì…ì˜ ìµœì  í”„ë¡œëª¨ì…˜ ì°¾ê¸°
        async function findBestPromotionForRoom(hotelId, roomTypeId, checkIn, checkOut) {
            try {
                const response = await fetch('/api/hotel-promotions/list?hotel_id=' + hotelId + '&is_active=true');
                const promotions = await response.json();
                
                if (!promotions || promotions.length === 0) {
                    return null;
                }
                
                let bestPromotion = null;
                let lowestRate = Infinity;
                
                for (const promo of promotions) {
                    const checkResult = await fetch('/api/hotel-promotions/check-and-get-rates', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            promo_code: promo.promo_code,
                            hotel_id: hotelId,
                            room_type_id: roomTypeId,
                            check_in_date: checkIn,
                            check_out_date: checkOut,
                            booking_date: new Date().toISOString().split('T')[0]
                        })
                    });
                    
                    const result = await checkResult.json();
                    
                    if (result.valid && result.total_room_rate < lowestRate) {
                        lowestRate = result.total_room_rate;
                        bestPromotion = result;
                    }
                }
                
                return bestPromotion;
            } catch (error) {
                console.error('í”„ë¡œëª¨ì…˜ ì¡°íšŒ ì˜¤ë¥˜:', error);
                return null;
            }
        }
        
        // ê°ì‹¤ë³„ ë£¸íƒ€ì… ë³€ê²½ ì‹œ í”„ë¡œëª¨ì…˜ ì¡°íšŒ
        async function onRoomTypeChange(roomNum) {
            const roomTypeSelect = document.querySelector(`[data-room="${roomNum}"]`);
            const roomTypeId = roomTypeSelect.value;
            const hotelId = document.getElementById('hotel_id').value;
            const checkIn = document.getElementById('check_in_date').value;
            const checkOut = document.getElementById('check_out_date').value;
            
            if (!roomTypeId || !hotelId || !checkIn || !checkOut) {
                return;
            }
            
            try {
                // í•´ë‹¹ ë£¸íƒ€ì… ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const roomType = allRoomTypes.find(rt => rt.id == roomTypeId);
                
                // â­ ì¡°ì‹ ì •ë³´ë¥¼ ê°ì‹¤ ì¹´ë“œì— í‘œì‹œ (ì¶”ê°€ í•­ëª© X)
                if (roomType) {
                    displayBreakfastInfo(roomNum, roomType);
                }
                
                // í•´ë‹¹ ë£¸íƒ€ì…ì˜ ìµœì  í”„ë¡œëª¨ì…˜ ì°¾ê¸°
                const bestPromotion = await findBestPromotionForRoom(hotelId, roomTypeId, checkIn, checkOut);
                
                if (bestPromotion) {
                    roomPromotions[roomNum] = bestPromotion;
                    document.getElementById(`room_${roomNum}_rate`).value = `$${bestPromotion.total_room_rate.toFixed(2)} (í”„ë¡œëª¨ì…˜)`;
                    console.log(`âœ… ê°ì‹¤ ${roomNum} í”„ë¡œëª¨ì…˜ ì ìš©:`, bestPromotion.promotion.promo_code);
                } else {
                    roomPromotions[roomNum] = null;
                    document.getElementById(`room_${roomNum}_rate`).value = 'í”„ë¡œëª¨ì…˜ ì—†ìŒ';
                }
                
                // ì „ì²´ ê°ì‹¤ ìš”ê¸ˆ í•©ì‚°
                await updateRoomCharges();
            } catch (error) {
                console.error('ë£¸íƒ€ì… í”„ë¡œëª¨ì…˜ ì¡°íšŒ ì˜¤ë¥˜:', error);
            }
        }
        
        // â­ ì¡°ì‹ í¬í•¨/ë¶ˆí¬í•¨ ìƒíƒœë§Œ í‘œì‹œ (ë‹¨ìˆœí™”)
        function displayBreakfastInfo(roomNum, roomType) {
            if (!roomType) return;
            
            const breakfastIncluded = roomType.breakfast_included || false;
            const breakfastInfoDiv = document.getElementById(`breakfast_info_${roomNum}`);
            const breakfastAlertDiv = document.getElementById(`breakfast_alert_${roomNum}`);
            const breakfastStatusSpan = document.getElementById(`breakfast_status_${roomNum}`);
            
            if (!breakfastInfoDiv || !breakfastAlertDiv || !breakfastStatusSpan) return;
            
            if (breakfastIncluded) {
                // ì¡°ì‹ í¬í•¨
                breakfastAlertDiv.className = 'alert alert-success py-2 mb-2';
                breakfastStatusSpan.textContent = 'ì¡°ì‹ í¬í•¨';
                breakfastInfoDiv.style.display = 'block';
                console.log(`ğŸ³ ê°ì‹¤ ${roomNum}: ì¡°ì‹ í¬í•¨ âœ“`);
            } else {
                // ì¡°ì‹ ë¶ˆí¬í•¨
                breakfastAlertDiv.className = 'alert alert-secondary py-2 mb-2';
                breakfastStatusSpan.textContent = 'ì¡°ì‹ ë¶ˆí¬í•¨';
                breakfastInfoDiv.style.display = 'block';
                console.log(`ğŸ³ ê°ì‹¤ ${roomNum}: ì¡°ì‹ ë¶ˆí¬í•¨`);
            }
        }
        
        // â­ ê¸°ì¡´ addBreakfastFromRoomType í•¨ìˆ˜ (ì´ì œ ì‚¬ìš© ì•ˆ í•¨)
        async function addBreakfastFromRoomType(roomNum, roomType) {
            // ë” ì´ìƒ ì¶”ê°€ í•­ëª©ì— ì¡°ì‹ì„ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
            console.log(`â„¹ï¸ ì¡°ì‹ì€ ê°ì‹¤ ì •ë³´ì— í‘œì‹œë©ë‹ˆë‹¤ (ì¶”ê°€ í•­ëª© X)`);
            return;
            
            /* ê¸°ì¡´ ë¡œì§ ì£¼ì„ ì²˜ë¦¬
            if (!roomType) return;
            
            const breakfastIncluded = roomType.breakfast_included || false;
            const breakfastRateAdult = parseFloat(roomType.breakfast_rate_adult) || 0;
            const breakfastRateChild = parseFloat(roomType.breakfast_rate_child) || 0;
            
            // â­ ë°ì´í„° ë¡œë“œ ì¤‘ì—ëŠ” ì¡°ì‹ ìë™ ì¶”ê°€ ì•ˆ í•¨ (ì¤‘ë³µ ë°©ì§€)
            if (isLoadingData) {
                console.log(`ğŸš« ë°ì´í„° ë¡œë“œ ì¤‘ì´ë¯€ë¡œ ì¡°ì‹ ìë™ ì¶”ê°€ ê±´ë„ˆëœ€`);
                return;
            }
            */
            
            // í•´ë‹¹ ê°ì‹¤ì˜ íˆ¬ìˆ™ê° ìˆ˜ í™•ì¸
            const guestsContainer = document.getElementById(`guests_${roomNum}`);
            if (!guestsContainer) return;
            
            const guestCards = guestsContainer.querySelectorAll('.guest-card');
            
            let adultCount = 0;
            let childCount = 0;
            
            guestCards.forEach(card => {
                const ageCategory = card.querySelector('[data-guest-field="age_category"]')?.value || 'adult';
                if (ageCategory === 'adult') adultCount++;
                else if (ageCategory === 'child') childCount++;
            });
            
            // ê¸°ì¡´ ì¡°ì‹ í•­ëª© ì œê±° (ì¤‘ë³µ ë°©ì§€)
            const existingBreakfast = document.querySelector(`[data-breakfast-room="${roomNum}"]`);
            if (existingBreakfast) {
                existingBreakfast.remove();
            }
            
            // ì¡°ì‹ í¬í•¨/ë¶ˆí¬í•¨ í•­ëª© ì¶”ê°€
            extraCounter++;
            const extraId = `extra_${extraCounter}`;
            
            let itemName, quantity, unitPrice, notes;
            
            if (breakfastIncluded) {
                // ì¡°ì‹ í¬í•¨
                itemName = 'ì¡°ì‹ (í¬í•¨)';
                quantity = adultCount + childCount;
                unitPrice = 0;
                notes = `ê°ì‹¤ ${roomNum} - ì¡°ì‹ í¬í•¨`;
            } else {
                // ì¡°ì‹ ë¶ˆí¬í•¨
                itemName = 'ì¡°ì‹ (ë¶ˆí¬í•¨ - ì¶”ê°€ ì‹œ ë³„ë„ ìš”ê¸ˆ)';
                quantity = 0;
                unitPrice = breakfastRateAdult;
                notes = `ê°ì‹¤ ${roomNum} - ì„±ì¸: $${breakfastRateAdult}, ì†Œì•„: $${breakfastRateChild}`;
            }
            
            const extraHtml = `
                <div class="extra-item-card" id="${extraId}" data-breakfast-room="${roomNum}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong><i class="fas fa-utensils me-2"></i>ì¶”ê°€ í•­ëª© ${extraCounter}</strong>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeExtra('${extraId}')">
                            <i class="fas fa-times"></i> ì‚­ì œ
                        </button>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="form-label">í•­ëª©ëª…</label>
                            <input type="text" class="form-control form-control-sm" value="${itemName}" data-extra-field="item_name" data-extra="${extraCounter}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ìˆ˜ëŸ‰</label>
                            <input type="number" class="form-control form-control-sm" value="${quantity}" data-extra-field="quantity" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ë‹¨ê°€ (USD)</label>
                            <input type="number" step="0.01" class="form-control form-control-sm" value="${unitPrice}" data-extra-field="unit_price" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ì†Œê³„ (USD)</label>
                            <input type="text" class="form-control form-control-sm bg-light" readonly value="${(quantity * unitPrice).toFixed(2)}" id="extra_${extraCounter}_subtotal">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">ë¹„ê³ </label>
                            <input type="text" class="form-control form-control-sm" value="${notes}" data-extra-field="notes" data-extra="${extraCounter}">
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('extrasContainer').insertAdjacentHTML('beforeend', extraHtml);
            
            // ìë™ ì¶”ê°€ëœ ì¡°ì‹ì˜ ì†Œê³„ ê³„ì‚° (ì •ì•¡ ìš”ê¸ˆì´ë¯€ë¡œ flat íƒ€ì…)
            setTimeout(() => {
                const totalField = document.getElementById(`extra_${extraCounter}_subtotal`);
                if (totalField) {
                    totalField.value = (quantity * unitPrice).toFixed(2);
                }
                
                // ì „ì²´ ì¶”ê°€ í•­ëª© í•©ê³„ ì¬ê³„ì‚°
                let totalExtras = 0;
                document.querySelectorAll('.extra-item-card').forEach(extra => {
                    const subtotalField = extra.querySelector('[id$="_subtotal"]');
                    if (subtotalField && subtotalField.value) {
                        totalExtras += parseFloat(subtotalField.value) || 0;
                    }
                });
                document.getElementById('totalExtrasCharge').value = totalExtras.toFixed(2);
                calculateTotal();
            }, 100);
        }
        
        // ê°ì‹¤ ì¶”ê°€
        function addRoom() {
            roomCounter++;
            const roomId = `room_${roomCounter}`;
            
            const roomHtml = `
                <div class="room-card" id="${roomId}" data-room-id="${roomCounter}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0"><i class="fas fa-bed me-2"></i>ê°ì‹¤ ${roomCounter}</h6>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeRoom('${roomId}')">
                            <i class="fas fa-trash"></i> ì‚­ì œ
                        </button>
                    </div>
                    
                    <div class="d-flex align-items-center gap-1 mb-2">
                        <label class="form-label mb-0" style="min-width: 70px;">ê°ì‹¤íƒ€ì…*</label>
                        <select class="form-control form-control-sm room-type-select" data-room="${roomCounter}" onchange="onRoomTypeChange(${roomCounter})" style="flex: 1;">
                            <option value="">ê°ì‹¤ íƒ€ì… ì„ íƒ</option>
                        </select>
                        <label class="form-label mb-0 ms-1" style="min-width: 95px;">ì´ ê°ì‹¤ìš”ê¸ˆ(ìë™)</label>
                        <input type="text" class="form-control form-control-sm" id="room_${roomCounter}_rate" readonly style="background: #f0f0f0; flex: 1;">
                    </div>
                    
                    <!-- â­ ì¡°ì‹ ì •ë³´ ì„¹ì…˜ (ìˆ˜ì • ê°€ëŠ¥) -->
                    <div class="border rounded p-2 mb-3" style="background: #f8f9fa;">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="breakfast_included_${roomCounter}" onchange="toggleBreakfastFields(${roomCounter})">
                            <label class="form-check-label fw-bold" for="breakfast_included_${roomCounter}">
                                <i class="fas fa-utensils me-1"></i>ì¡°ì‹ í¬í•¨
                            </label>
                        </div>
                        <div id="breakfast_fields_${roomCounter}" style="display: none;">
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label small">íšŸìˆ˜(ì¼)</label>
                                    <input type="number" class="form-control form-control-sm" id="breakfast_days_${roomCounter}" value="1" min="1">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">ì„±ì¸ ë‹¨ê°€ ($)</label>
                                    <input type="number" class="form-control form-control-sm" id="breakfast_adult_price_${roomCounter}" value="0" step="0.01" min="0">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">ì†Œì•„ ë‹¨ê°€ ($)</label>
                                    <input type="number" class="form-control form-control-sm" id="breakfast_child_price_${roomCounter}" value="0" step="0.01" min="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <strong class="d-block mb-2"><i class="fas fa-users me-2"></i>íˆ¬ìˆ™ê° ì •ë³´</strong>
                        <div id="guests_${roomCounter}">
                            ${createGuestHtml(roomCounter, 1, true)}
                        </div>
                        <button type="button" class="btn btn-sm btn-add-guest mt-2" onclick="addGuest(${roomCounter})">
                            <i class="fas fa-user-plus me-1"></i>ë™ë°˜ íˆ¬ìˆ™ê° ì¶”ê°€
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('roomsContainer').insertAdjacentHTML('beforeend', roomHtml);
            
            // ê°ì‹¤ íƒ€ì… ì˜µì…˜ ì±„ìš°ê¸°
            if (allRoomTypes.length > 0) {
                const select = document.querySelector(`#${roomId} .room-type-select`);
                select.innerHTML = '<option value="">ê°ì‹¤ íƒ€ì… ì„ íƒ</option>' +
                    allRoomTypes.map(rt => `<option value="${rt.id}">${rt.room_type_name}</option>`).join('');
            }
        }
        
        // íˆ¬ìˆ™ê° HTML ìƒì„± (í•œ ì¤„ë¡œ ë³€ê²½)
        function createGuestHtml(roomNum, guestNum, isPrimary = false) {
            return `
                <div class="guest-card" id="guest_${roomNum}_${guestNum}" style="padding: 0.5rem; margin-bottom: 0.5rem;">
                    <div class="d-flex align-items-center gap-1">
                        <strong style="min-width: 90px; font-size: 0.7rem;">${isPrimary ? 'ëŒ€í‘œ íˆ¬ìˆ™ê°' : 'ë™ë°˜íˆ¬ìˆ™ê°' + guestNum}</strong>
                        <input type="text" class="form-control form-control-sm" placeholder="í•œê¸€ëª…" data-guest-field="guest_name_ko" data-room="${roomNum}" data-guest="${guestNum}" style="flex: 1;">
                        <span style="font-size: 0.7rem;">|</span>
                        <input type="text" class="form-control form-control-sm" placeholder="ì˜ë¬¸ëª…" data-guest-field="guest_name_en" data-room="${roomNum}" data-guest="${guestNum}" style="flex: 1;">
                        <span style="font-size: 0.7rem;">|</span>
                        <select class="form-control form-control-sm" data-guest-field="age_category" data-room="${roomNum}" data-guest="${guestNum}" style="width: 70px;">
                            <option value="adult">ì„±ì¸</option>
                            <option value="child">ì†Œì•„</option>
                            <option value="infant">ìœ ì•„</option>
                        </select>
                        <span style="font-size: 0.7rem;">|</span>
                        <input type="date" class="form-control form-control-sm" placeholder="ìƒë…„ì›”ì¼" data-guest-field="date_of_birth" data-room="${roomNum}" data-guest="${guestNum}" style="width: 130px;">
                        ${isPrimary ? `
                        <span style="font-size: 0.7rem;">|</span>
                        <input type="tel" class="form-control form-control-sm" placeholder="ì „í™”ë²ˆí˜¸" data-guest-field="phone" data-room="${roomNum}" data-guest="${guestNum}" style="width: 120px;">
                        <span style="font-size: 0.7rem;">|</span>
                        <input type="email" class="form-control form-control-sm" placeholder="ì´ë©”ì¼" data-guest-field="email" data-room="${roomNum}" data-guest="${guestNum}" style="flex: 1;">
                        ` : ''}
                        ${!isPrimary ? `<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeGuest(${roomNum}, ${guestNum})" style="padding: 0.2rem 0.5rem;"><i class="fas fa-times"></i></button>` : ''}
                    </div>
                </div>
            `;
        }
        
        // íˆ¬ìˆ™ê° ì¶”ê°€
        function addGuest(roomNum) {
            const guestsContainer = document.getElementById(`guests_${roomNum}`);
            const guestCount = guestsContainer.querySelectorAll('.guest-card').length + 1;
            
            guestsContainer.insertAdjacentHTML('beforeend', createGuestHtml(roomNum, guestCount, false));
        }
        
        // íˆ¬ìˆ™ê° ì œê±°
        function removeGuest(roomNum, guestNum) {
            const guestCard = document.getElementById(`guest_${roomNum}_${guestNum}`);
            if (guestCard) {
                guestCard.remove();
            }
        }
        
        // ==================== ì¡°ì‹ ê´€ë ¨ í•¨ìˆ˜ ====================
        
        // ì¡°ì‹ í•„ë“œ í† ê¸€ (ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ)
        function toggleBreakfastFields(roomNum) {
            const checkbox = document.getElementById(`breakfast_included_${roomNum}`);
            const fieldsDiv = document.getElementById(`breakfast_fields_${roomNum}`);
            const label = document.querySelector(`label[for="breakfast_included_${roomNum}"]`);
            const daysInput = document.getElementById(`breakfast_days_${roomNum}`);
            const adultPriceInput = document.getElementById(`breakfast_adult_price_${roomNum}`);
            const childPriceInput = document.getElementById(`breakfast_child_price_${roomNum}`);
            
            if (checkbox.checked) {
                fieldsDiv.style.display = 'block';
                
                // â­ ë ˆì´ë¸” í…ìŠ¤íŠ¸ ë³€ê²½
                if (label) {
                    label.innerHTML = '<i class="fas fa-utensils me-1"></i>ì¡°ì‹ í¬í•¨';
                }
                
                // â­ ì´ ìš”ê¸ˆ ì„¹ì…˜ì˜ ì¡°ì‹ ë¼ë²¨ë„ ì—…ë°ì´íŠ¸
                updateBreakfastLabel();
                
                // ì¡°ì‹ í¬í•¨ìœ¼ë¡œ ë³€ê²½ ì‹œ: ë°•ìˆ˜ì™€ ê°ì‹¤ íƒ€ì…ì˜ ì¡°ì‹ ìš”ê¸ˆ ìë™ ë¡œë“œ
                const nights = parseInt(document.getElementById('nights')?.textContent) || 1;
                daysInput.value = nights;
                
                // ê°ì‹¤ íƒ€ì…ì˜ ì¡°ì‹ ìš”ê¸ˆ ê°€ì ¸ì˜¤ê¸°
                const roomSelect = document.querySelector(`[data-room="${roomNum}"]`);
                if (roomSelect && roomSelect.value) {
                    const roomType = allRoomTypes.find(rt => rt.id == roomSelect.value);
                    if (roomType && (parseFloat(adultPriceInput.value) === 0 || parseFloat(childPriceInput.value) === 0)) {
                        adultPriceInput.value = parseFloat(roomType.breakfast_adult_price || 0).toFixed(2);
                        childPriceInput.value = parseFloat(roomType.breakfast_child_price || 0).toFixed(2);
                        console.log(`âœ… ê°ì‹¤ ${roomNum} ì¡°ì‹ ìš”ê¸ˆ ìë™ ë¡œë“œ: ì„±ì¸=$${roomType.breakfast_adult_price}, ì†Œì•„=$${roomType.breakfast_child_price}`);
                    }
                }
            } else {
                fieldsDiv.style.display = 'none';
                
                // â­ ë ˆì´ë¸” í…ìŠ¤íŠ¸ ë³€ê²½
                if (label) {
                    label.innerHTML = '<i class="fas fa-utensils me-1"></i>ì¡°ì‹ ë¶ˆí¬í•¨';
                }
                
                // â­ ì´ ìš”ê¸ˆ ì„¹ì…˜ì˜ ì¡°ì‹ ë¼ë²¨ë„ ì—…ë°ì´íŠ¸
                updateBreakfastLabel();
            }
            
            // â­ ì¡°ì‹ ìš”ê¸ˆ ì¬ê³„ì‚°
            updateRoomCharges();
        }
        
        // ê°ì‹¤ íƒ€ì… ë³€ê²½ ì‹œ ì¡°ì‹ ì •ë³´ í‘œì‹œ
        function displayBreakfastInfo(roomNum, roomType) {
            const checkbox = document.getElementById(`breakfast_included_${roomNum}`);
            const daysInput = document.getElementById(`breakfast_days_${roomNum}`);
            const adultPriceInput = document.getElementById(`breakfast_adult_price_${roomNum}`);
            const childPriceInput = document.getElementById(`breakfast_child_price_${roomNum}`);
            const fieldsDiv = document.getElementById(`breakfast_fields_${roomNum}`);
            const label = document.querySelector(`label[for="breakfast_included_${roomNum}"]`);
            
            if (!roomType) return;
            
            // ì¡°ì‹ í¬í•¨ ì—¬ë¶€ í™•ì¸
            const breakfastIncluded = roomType.breakfast_included === true || roomType.breakfast_included === 'true';
            
            if (breakfastIncluded) {
                // ì¡°ì‹ í¬í•¨ â†’ ì²´í¬ë°•ìŠ¤ ì²´í¬, ë°•ìˆ˜ì™€ ìš”ê¸ˆ ìë™ ì„¤ì •
                checkbox.checked = true;
                fieldsDiv.style.display = 'block';
                
                // â­ ë ˆì´ë¸” í…ìŠ¤íŠ¸ ë³€ê²½
                if (label) {
                    label.innerHTML = '<i class="fas fa-utensils me-1"></i>ì¡°ì‹ í¬í•¨';
                }
                
                const nights = parseInt(document.getElementById('nights')?.textContent) || 1;
                daysInput.value = nights;
                adultPriceInput.value = parseFloat(roomType.breakfast_adult_price || 0).toFixed(2);
                childPriceInput.value = parseFloat(roomType.breakfast_child_price || 0).toFixed(2);
                
                console.log(`âœ… ê°ì‹¤ ${roomNum} ì¡°ì‹ ìë™ ì„¤ì •: í¬í•¨, ${nights}ì¼, ì„±ì¸=$${roomType.breakfast_adult_price}, ì†Œì•„=$${roomType.breakfast_child_price}`);
            } else {
                // ì¡°ì‹ ë¶ˆí¬í•¨ â†’ ì²´í¬ë°•ìŠ¤ í•´ì œ
                checkbox.checked = false;
                fieldsDiv.style.display = 'none';
                
                // â­ ë ˆì´ë¸” í…ìŠ¤íŠ¸ ë³€ê²½
                if (label) {
                    label.innerHTML = '<i class="fas fa-utensils me-1"></i>ì¡°ì‹ ë¶ˆí¬í•¨';
                }
                
                // í•˜ì§€ë§Œ ìš”ê¸ˆì€ ë¯¸ë¦¬ ì±„ì›Œë‘ê¸° (ë‚˜ì¤‘ì— ì²´í¬í•  ë•Œ ì‚¬ìš©)
                const nights = parseInt(document.getElementById('nights')?.textContent) || 1;
                daysInput.value = nights;
                adultPriceInput.value = parseFloat(roomType.breakfast_adult_price || 0).toFixed(2);
                childPriceInput.value = parseFloat(roomType.breakfast_child_price || 0).toFixed(2);
                
                console.log(`â„¹ï¸  ê°ì‹¤ ${roomNum} ì¡°ì‹: ë¶ˆí¬í•¨ (ìš”ê¸ˆì€ ë¯¸ë¦¬ ì„¤ì •ë¨)`);
            }
        }
        
        // ê°ì‹¤ ì œê±°
        function removeRoom(roomId) {
            if (confirm('ì´ ê°ì‹¤ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById(roomId).remove();
                calculateTotal();
            }
        }
        
        // ì¶”ê°€ í•­ëª© ì¶”ê°€
        function addExtraItem() {
            extraCounter++;
            const extraId = `extra_${extraCounter}`;
            
            const extraHtml = `
                <div class="extra-item-card" id="${extraId}">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="fas fa-plus-circle me-2"></i>ì¶”ê°€ í•­ëª© ${extraCounter}</h6>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeExtra('${extraId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label small">í•­ëª©ëª… *</label>
                            <input type="text" class="form-control" placeholder="ì˜ˆ: ê³µí•­í”½ì—…, ê½ƒë°”êµ¬ë‹ˆ" data-extra-field="item_name" data-extra="${extraCounter}" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">ìˆ˜ëŸ‰</label>
                            <input type="number" class="form-control" value="1" min="1" data-extra-field="quantity" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">ìœ í˜•</label>
                            <select class="form-control" data-extra-field="pricing_type" data-extra="${extraCounter}" onchange="toggleExtraPricing(${extraCounter})">
                                <option value="per_person">ì¸ì›ë³„ ìš”ê¸ˆ</option>
                                <option value="flat">ì •ì•¡ ìš”ê¸ˆ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row g-2 mt-2" id="perPersonPricing_${extraCounter}">
                        <div class="col-md-3">
                            <label class="form-label small">ì„±ì¸ ìˆ˜</label>
                            <input type="number" class="form-control" value="0" min="0" data-extra-field="adult_count" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">ì„±ì¸ ë‹¨ê°€ ($)</label>
                            <input type="number" class="form-control" value="0" step="0.01" data-extra-field="adult_price" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">ì†Œì•„ ìˆ˜</label>
                            <input type="number" class="form-control" value="0" min="0" data-extra-field="child_count" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">ì†Œì•„ ë‹¨ê°€ ($)</label>
                            <input type="number" class="form-control" value="0" step="0.01" data-extra-field="child_price" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">ìœ ì•„ ìˆ˜</label>
                            <input type="number" class="form-control" value="0" min="0" data-extra-field="infant_count" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">ìœ ì•„ ë‹¨ê°€ ($)</label>
                            <input type="number" class="form-control" value="0" step="0.01" data-extra-field="infant_price" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                    </div>
                    
                    <div class="row g-2 mt-2" id="flatPricing_${extraCounter}" style="display:none;">
                        <div class="col-md-6">
                            <label class="form-label small">ë‹¨ê°€ ($)</label>
                            <input type="number" class="form-control" value="0" step="0.01" data-extra-field="unit_price" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                    </div>
                    
                    <div class="row g-2 mt-2">
                        <div class="col-md-12">
                            <label class="form-label small">ì†Œê³„</label>
                            <input type="text" class="form-control fw-bold" id="extra_${extraCounter}_total" readonly style="background: #e7f3ff; color: #2196F3;">
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('extrasContainer').insertAdjacentHTML('beforeend', extraHtml);
        }
        
        // ì¶”ê°€ í•­ëª© ê°€ê²© ìœ í˜• ì „í™˜
        function toggleExtraPricing(extraNum) {
            const type = document.querySelector(`[data-extra-field="pricing_type"][data-extra="${extraNum}"]`).value;
            
            if (type === 'per_person') {
                document.getElementById(`perPersonPricing_${extraNum}`).style.display = 'flex';
                document.getElementById(`flatPricing_${extraNum}`).style.display = 'none';
            } else {
                document.getElementById(`perPersonPricing_${extraNum}`).style.display = 'none';
                document.getElementById(`flatPricing_${extraNum}`).style.display = 'flex';
            }
            
            calculateExtraTotal(extraNum);
        }
        
        // ì¶”ê°€ í•­ëª© ì†Œê³„ ê³„ì‚°
        function calculateExtraTotal(extraNum) {
            const type = document.querySelector(`[data-extra-field="pricing_type"][data-extra="${extraNum}"]`).value;
            const quantity = parseInt(document.querySelector(`[data-extra-field="quantity"][data-extra="${extraNum}"]`).value) || 1;
            
            let total = 0;
            
            if (type === 'per_person') {
                const adultCount = parseInt(document.querySelector(`[data-extra-field="adult_count"][data-extra="${extraNum}"]`).value) || 0;
                const adultPrice = parseFloat(document.querySelector(`[data-extra-field="adult_price"][data-extra="${extraNum}"]`).value) || 0;
                const childCount = parseInt(document.querySelector(`[data-extra-field="child_count"][data-extra="${extraNum}"]`).value) || 0;
                const childPrice = parseFloat(document.querySelector(`[data-extra-field="child_price"][data-extra="${extraNum}"]`).value) || 0;
                const infantCount = parseInt(document.querySelector(`[data-extra-field="infant_count"][data-extra="${extraNum}"]`).value) || 0;
                const infantPrice = parseFloat(document.querySelector(`[data-extra-field="infant_price"][data-extra="${extraNum}"]`).value) || 0;
                
                total = (adultCount * adultPrice + childCount * childPrice + infantCount * infantPrice) * quantity;
            } else {
                const unitPrice = parseFloat(document.querySelector(`[data-extra-field="unit_price"][data-extra="${extraNum}"]`).value) || 0;
                total = unitPrice * quantity;
            }
            
            document.getElementById(`extra_${extraNum}_total`).value = `$${total.toFixed(2)}`;
            
            // ëª¨ë“  ì¶”ê°€ í•­ëª© í•©ê³„ ê³„ì‚°
            let totalExtras = 0;
            document.querySelectorAll('.extra-item-card').forEach(extra => {
                const totalInput = extra.querySelector('[id$="_total"]');
                if (totalInput && totalInput.value) {
                    const amount = parseFloat(totalInput.value.replace('$', '')) || 0;
                    totalExtras += amount;
                }
            });
            document.getElementById('totalExtrasCharge').value = totalExtras.toFixed(2);
            
            calculateTotal();
        }
        
        // ì¶”ê°€ í•­ëª© ì œê±°
        function removeExtra(extraId) {
            if (confirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById(extraId).remove();
                
                // í•©ê³„ ì¬ê³„ì‚°
                let totalExtras = 0;
                document.querySelectorAll('.extra-item-card').forEach(extra => {
                    const totalInput = extra.querySelector('[id$="_total"]');
                    if (totalInput && totalInput.value) {
                        const amount = parseFloat(totalInput.value.replace('$', '')) || 0;
                        totalExtras += amount;
                    }
                });
                document.getElementById('totalExtrasCharge').value = totalExtras.toFixed(2);
                calculateTotal();
                calculateTotal();
            }
        }
        
        // ì˜ˆì•½ ë³€ê²½ - ëª¨ë‹¬ë¡œ ì˜¤í”ˆ
        async function editReservation(reservationId) {
            currentEditingId = reservationId;
            
            // ë¨¼ì € ëª¨ë‹¬ ì˜¤í”ˆ
            const modal = new bootstrap.Modal(document.getElementById('editReservationModal'));
            modal.show();
            
            try {
                // ì˜ˆì•½ ìƒì„¸ ë°ì´í„° ë¡œë“œ
                const response = await fetch(`/api/hotel-reservations/${reservationId}`);
                const data = await response.json();
                
                console.log('ğŸ“¥ ë¡œë“œëœ ì˜ˆì•½ ë°ì´í„°:', data);
                
                // ëª¨ë‹¬ì´ ì™„ì „íˆ ì—´ë¦° í›„ì— ë°ì´í„° ì±„ìš°ê¸°
                setTimeout(async () => {
                    // â­ ë°ì´í„° ë¡œë“œ ì‹œì‘
                    isLoadingData = true;
                    
                    // ì´ˆê¸°í™”
                    roomCounter = 0;
                    extraCounter = 0;
                    document.getElementById('roomsContainer').innerHTML = '';
                    document.getElementById('extrasContainer').innerHTML = '';
                    
                    // ë‚ ì§œ í¬ë§· ë³€í™˜ í•¨ìˆ˜ (ISO â†’ YYYY-MM-DD)
                    function formatDateForInput(dateStr) {
                        if (!dateStr) return '';
                        try {
                            const date = new Date(dateStr);
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            return `${year}-${month}-${day}`;
                        } catch (e) {
                            return dateStr;
                        }
                    }
                    
                    // ê¸°ë³¸ ì •ë³´ ì±„ìš°ê¸°
                    document.getElementById('reservation_number').value = data.reservation_number || '';
                    document.getElementById('status').value = data.status || 'pending';
                    document.getElementById('reservation_date').value = formatDateForInput(data.reservation_date);
                    document.getElementById('check_in_date').value = formatDateForInput(data.check_in_date);
                    document.getElementById('check_out_date').value = formatDateForInput(data.check_out_date);
                    document.getElementById('arrival_flight').value = data.arrival_flight || '';
                    document.getElementById('departure_flight').value = data.departure_flight || '';
                    document.getElementById('special_requests').value = data.special_requests || '';
                    document.getElementById('internal_memo').value = data.internal_memo || '';
                    document.getElementById('totalRoomCharge').value = data.total_room_rate || 0;
                    document.getElementById('totalExtrasCharge').value = data.total_extras_rate || 0;
                    document.getElementById('agencyFee').value = data.agency_fee || 0;
                    
                    // ìˆ˜ë°°í”¼ í‘œì‹œ
                    if (data.agency_fee && data.agency_fee > 0) {
                        document.getElementById('agencyFeeRow').style.display = 'flex';
                    }
                    
                    console.log('âœ… ê¸°ë³¸ ì •ë³´ ì±„ì›€ (ì´ ê°ì‹¤: $' + (data.total_room_rate || 0) + ', ì´ ì¶”ê°€: $' + (data.total_extras_rate || 0) + ', ìˆ˜ë°°í”¼: $' + (data.agency_fee || 0) + ')');
                    
                    // í˜¸í…” ì„ íƒ (â­ ë³€ê²½ ë¶ˆê°€ - disabled ì„¤ì •)
                    if (data.hotel_id) {
                        const hotelSelect = document.getElementById('hotel_id');
                        hotelSelect.value = data.hotel_id;
                        hotelSelect.disabled = true; // â­ ë³€ê²½ ë¶ˆê°€
                        await loadRoomTypes();
                        console.log('âœ… í˜¸í…” ì„ íƒ (ê³ ì •):', data.hotel_id);
                    }
                    
                    // ê±°ë˜ì²˜ ì„ íƒ (â­ ë³€ê²½ ë¶ˆê°€ - disabled ì„¤ì •, ìˆ˜ë°°í”¼ëŠ” ì´ë¯¸ ë¡œë“œë¨)
                    if (data.booking_agency_id) {
                        const agencySelect = document.getElementById('booking_agency_id');
                        agencySelect.value = data.booking_agency_id;
                        agencySelect.disabled = true; // â­ ë³€ê²½ ë¶ˆê°€
                        // calculateAgencyFee(); // â“ ì£¼ì„ ì²˜ë¦¬: ì €ì¥ëœ ìˆ˜ë°°í”¼ ê°’ ìœ ì§€
                        
                        // ê±°ë˜ì²˜ ì´ë¦„ í‘œì‹œë§Œ ì—…ë°ì´íŠ¸
                        const agency = allAgencies.find(a => a.id == data.booking_agency_id);
                        if (agency && data.agency_fee && data.agency_fee > 0) {
                            document.getElementById('agencyFeeName').textContent = agency.agency_name;
                        }
                        
                        console.log('âœ… ê±°ë˜ì²˜ ì„ íƒ (ê³ ì •):', data.booking_agency_id, 'ìˆ˜ë°°í”¼: $' + (data.agency_fee || 0));
                    }
                    
                    // ë°•ìˆ˜ ê³„ì‚°
                    calculateNights();
                    
                    // í”„ë¡œëª¨ì…˜ ì •ë³´ í‘œì‹œ
                    if (data.promotion_code) {
                        document.getElementById('noPromo').style.display = 'none';
                        document.getElementById('promoResult').style.display = 'block';
                        document.getElementById('promoResult').innerHTML = `
                            <div class="alert alert-success py-2">
                                <strong>ğŸ“Œ í”„ë¡œëª¨ì…˜ ì½”ë“œ:</strong> ${data.promotion_code}
                                ${data.rate_condition_id ? `<br><small>Rate Condition ID: ${data.rate_condition_id}</small>` : ''}
                            </div>
                        `;
                        console.log('âœ… í”„ë¡œëª¨ì…˜ í‘œì‹œ:', data.promotion_code);
                    } else {
                        document.getElementById('noPromo').style.display = 'block';
                        document.getElementById('promoResult').style.display = 'none';
                    }
                    
                    // ê°ì‹¤ ë° íˆ¬ìˆ™ê° ì •ë³´ ì¶”ê°€
                    if (data.rooms && data.rooms.length > 0) {
                        console.log('ğŸ“¦ ê°ì‹¤ ìˆ˜:', data.rooms.length);
                        for (let i = 0; i < data.rooms.length; i++) {
                            const room = data.rooms[i];
                            addRoom();
                            
                            // â­ í´ë¡œì € ë²„ê·¸ ìˆ˜ì •: roomCounter í˜„ì¬ ê°’ì„ ì¦‰ì‹œ ìº¡ì²˜
                            const currentRoomNum = roomCounter;
                            
                            // ì•½ê°„ì˜ ì§€ì—° í›„ ê°ì‹¤ ì •ë³´ ì±„ìš°ê¸°
                            setTimeout(async () => {
                                console.log(`ğŸ¨ ê°ì‹¤ ${currentRoomNum} ë°ì´í„° ë¡œë“œ ì‹œì‘ (room_type_id: ${room.room_type_id})`);
                                
                                // ê°ì‹¤ íƒ€ì… ì„ íƒ
                                const roomSelect = document.querySelector(`[data-room="${currentRoomNum}"]`);
                                if (roomSelect && room.room_type_id) {
                                    roomSelect.value = room.room_type_id;
                                    console.log(`âœ… ê°ì‹¤ ${currentRoomNum} íƒ€ì… ì„ íƒ:`, room.room_type_id);
                                }
                                
                                // ê°ì‹¤ ìš”ê¸ˆ í‘œì‹œ
                                const rateInput = document.getElementById(`room_${currentRoomNum}_rate`);
                                if (rateInput && room.total_selling_price) {
                                    rateInput.value = `$${parseFloat(room.total_selling_price).toFixed(2)}`;
                                }
                                
                                // íˆ¬ìˆ™ê° ì •ë³´ ì±„ìš°ê¸°
                                if (room.guests && room.guests.length > 0) {
                                    console.log(`  ğŸ‘¥ ê°ì‹¤ ${currentRoomNum} íˆ¬ìˆ™ê° ìˆ˜:`, room.guests.length);
                                    room.guests.forEach((guest, guestIdx) => {
                                        if (guestIdx > 0) {
                                            addGuest(currentRoomNum);
                                        }
                                        
                                        setTimeout(() => {
                                            const guestCard = document.getElementById(`guest_${currentRoomNum}_${guestIdx + 1}`);
                                            if (guestCard) {
                                                const fields = guestCard.querySelectorAll('[data-guest-field]');
                                                fields.forEach(field => {
                                                    const fieldName = field.dataset.guestField;
                                                    let value = guest[fieldName] !== undefined && guest[fieldName] !== null ? guest[fieldName] : '';
                                                    
                                                    // â­ date_of_birthëŠ” ISO â†’ YYYY-MM-DD ë³€í™˜ í•„ìˆ˜!
                                                    if (fieldName === 'date_of_birth' && value) {
                                                        value = formatDateForInput(value);
                                                    }
                                                    
                                                    field.value = value;
                                                });
                                                console.log(`  âœ… ê°ì‹¤ ${currentRoomNum} íˆ¬ìˆ™ê° ${guestIdx + 1} ì •ë³´ ì±„ì›€ (ì´ë¦„: ${guest.guest_name_ko}, ìƒë…„ì›”ì¼: ${formatDateForInput(guest.date_of_birth)})`);
                                            }
                                        }, 100 * guestIdx);
                                    });
                                }
                                
                                // â­ ì¡°ì‹ ì •ë³´ í‘œì‹œ (ì €ì¥ëœ ê°’ ë˜ëŠ” ê°ì‹¤ íƒ€ì… ê¸°ë³¸ê°’)
                                setTimeout(() => {
                                    if (room.breakfast_included !== undefined && room.breakfast_included !== null) {
                                        // ì €ì¥ëœ ì¡°ì‹ ì •ë³´ê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ í‘œì‹œ
                                        console.log(`ğŸ³ ê°ì‹¤ ${currentRoomNum} ì €ì¥ëœ ì¡°ì‹ ë¡œë“œ:`, room.breakfast_included, room.breakfast_days, room.breakfast_adult_price, room.breakfast_child_price);
                                        
                                        const breakfastCheckbox = document.getElementById(`breakfast_included_${currentRoomNum}`);
                                        const breakfastDays = document.getElementById(`breakfast_days_${currentRoomNum}`);
                                        const breakfastAdultPrice = document.getElementById(`breakfast_adult_price_${currentRoomNum}`);
                                        const breakfastChildPrice = document.getElementById(`breakfast_child_price_${currentRoomNum}`);
                                        const breakfastFields = document.getElementById(`breakfast_fields_${currentRoomNum}`);
                                        const breakfastLabel = document.querySelector(`label[for="breakfast_included_${currentRoomNum}"]`);
                                        
                                        // â­ ì²´í¬ë°•ìŠ¤ ì„¤ì •
                                        if (breakfastCheckbox) breakfastCheckbox.checked = room.breakfast_included;
                                        
                                        // â­ í•„ë“œ ê°’ ì„¤ì • (ëœì–´ì“°ê¸° ë°©ì§€)
                                        if (breakfastDays) breakfastDays.value = room.breakfast_days || 1;
                                        if (breakfastAdultPrice) breakfastAdultPrice.value = parseFloat(room.breakfast_adult_price || 0).toFixed(2);
                                        if (breakfastChildPrice) breakfastChildPrice.value = parseFloat(room.breakfast_child_price || 0).toFixed(2);
                                        
                                        // â­ í•„ë“œ í‘œì‹œ ë° ë ˆì´ë¸” ì—…ë°ì´íŠ¸ (ê°’ ë³€ê²½ ì—†ìŒ)
                                        if (breakfastFields) {
                                            breakfastFields.style.display = room.breakfast_included ? 'block' : 'none';
                                        }
                                        if (breakfastLabel) {
                                            breakfastLabel.innerHTML = room.breakfast_included 
                                                ? '<i class="fas fa-utensils me-1"></i>ì¡°ì‹ í¬í•¨'
                                                : '<i class="fas fa-utensils me-1"></i>ì¡°ì‹ ë¶ˆí¬í•¨';
                                        }
                                        
                                        console.log(`  â†’ íšŒìˆ˜: ${room.breakfast_days}ì¼, ì„±ì¸: $${room.breakfast_adult_price}, ì†Œì•„: $${room.breakfast_child_price}`);
                                    } else {
                                        // ì €ì¥ëœ ì •ë³´ê°€ ì—†ìœ¼ë©´ ê°ì‹¤ íƒ€ì… ê¸°ë³¸ê°’ ì‚¬ìš©
                                        if (room.room_type_id) {
                                            const roomType = allRoomTypes.find(rt => rt.id == room.room_type_id);
                                            if (roomType) {
                                                displayBreakfastInfo(currentRoomNum, roomType);
                                            }
                                        }
                                    }
                                }, 150);
                                
                                // â­ í”„ë¡œëª¨ì…˜ ì •ë³´ í‘œì‹œ (ìƒˆë¡œ ì¡°íšŒí•˜ì§€ ì•Šê³  ì €ì¥ëœ ì •ë³´ í‘œì‹œ)
                                if (room.promotion_code) {
                                    // roomPromotionsì— ì €ì¥
                                    roomPromotions[currentRoomNum] = {
                                        promotion: { promo_code: room.promotion_code },
                                        rate_condition_id: room.rate_condition_id,
                                        total_room_rate: room.total_selling_price
                                    };
                                    
                                    // í”„ë¡œëª¨ì…˜ ì •ë³´ UIì— ì§ì ‘ í‘œì‹œ
                                    setTimeout(() => {
                                        const roomCard = document.querySelector(`[data-room-id="${currentRoomNum}"]`);
                                        if (roomCard) {
                                            // í”„ë¡œëª¨ì…˜ í‘œì‹œ ì˜ì—­ ì°¾ê¸° ë˜ëŠ” ìƒì„±
                                            let promoDisplayArea = roomCard.querySelector('.room-promo-display');
                                            if (!promoDisplayArea) {
                                                const roomTypeSelect = roomCard.querySelector(`[data-room="${currentRoomNum}"]`)?.parentElement;
                                                if (roomTypeSelect) {
                                                    promoDisplayArea = document.createElement('div');
                                                    promoDisplayArea.className = 'room-promo-display mt-2';
                                                    roomTypeSelect.after(promoDisplayArea);
                                                }
                                            }
                                            
                                            if (promoDisplayArea) {
                                                promoDisplayArea.innerHTML = `
                                                    <div class="alert alert-info py-2 mb-2">
                                                        <i class="fas fa-tag me-2"></i>
                                                        <strong>í”„ë¡œëª¨ì…˜:</strong> <code class="bg-light px-2 py-1">${room.promotion_code}</code>
                                                        ${room.rate_condition_id ? `<br><small class="text-muted">Rate ID: ${room.rate_condition_id}</small>` : ''}
                                                        <br><small class="text-muted">ê°ì‹¤ ìš”ê¸ˆ: <strong>$${parseFloat(room.total_selling_price).toFixed(2)}</strong></small>
                                                    </div>
                                                `;
                                                console.log(`ğŸ“Œ ê°ì‹¤ ${currentRoomNum} í”„ë¡œëª¨ì…˜ í‘œì‹œ: ${room.promotion_code} ($${room.total_selling_price})`);
                                            }
                                        }
                                    }, 200);
                                }
                            }, 100 * i);
                        }
                    } else {
                        addRoom();
                    }
                    
                    // ì¶”ê°€ í•­ëª© ë¡œë“œ
                    setTimeout(() => {
                        let totalExtras = 0;
                        let displayedExtras = 0;  // â­ ì‹¤ì œ í‘œì‹œëœ í•­ëª© ìˆ˜
                        
                        if (data.extras && data.extras.length > 0) {
                            console.log('ğŸ ì¶”ê°€ í•­ëª© ìˆ˜:', data.extras.length);
                            data.extras.forEach((extra, idx) => {
                                // â­ ì¡°ì‹ì€ ê°ì‹¤ ì •ë³´ì— í‘œì‹œë˜ë¯€ë¡œ ì¶”ê°€ í•­ëª©ì—ì„œ ì œì™¸
                                if (extra.item_name && extra.item_name.includes('ì¡°ì‹')) {
                                    console.log(`â­ï¸ ì¡°ì‹ í•­ëª© ê±´ë„ˆëœ€: ${extra.item_name} (ê°ì‹¤ ì •ë³´ì— í‘œì‹œë¨)`);
                                    return;
                                }
                                
                                displayedExtras++;
                                addExtraItem();
                                
                                // â­ í´ë¡œì € ë²„ê·¸ ìˆ˜ì •: extraCounter í˜„ì¬ ê°’ì„ ì¦‰ì‹œ ìº¡ì²˜
                                const currentExtraNum = extraCounter;
                                
                                setTimeout(() => {
                                    console.log(`ğŸ“ ì¶”ê°€í•­ëª© ${currentExtraNum} ë¡œë“œ ì‹œì‘:`, extra.item_name);
                                    const extraCard = document.getElementById(`extra_${currentExtraNum}`);
                                    if (extraCard) {
                                        const itemNameInput = extraCard.querySelector('[data-extra-field="item_name"]');
                                        const quantityInput = extraCard.querySelector('[data-extra-field="quantity"]');
                                        const pricingTypeInput = extraCard.querySelector('[data-extra-field="pricing_type"]');
                                        
                                        if (itemNameInput) itemNameInput.value = extra.item_name || '';
                                        if (quantityInput) quantityInput.value = extra.quantity || 1;
                                        
                                        // â­ pricing_type ì„¤ì • í›„ ì¦‰ì‹œ UI ì „í™˜
                                        const actualPricingType = extra.item_type || extra.pricing_type || 'flat';
                                        if (pricingTypeInput) pricingTypeInput.value = actualPricingType;
                                        toggleExtraPricing(currentExtraNum);  // â­ UI ë¨¼ì € ì „í™˜!
                                        
                                        console.log(`  â†’ í•­ëª©ëª…: ${extra.item_name}, ìˆ˜ëŸ‰: ${extra.quantity}, ìœ í˜•: ${actualPricingType}`);
                                        
                                        // pricing_typeì— ë”°ë¼ í•„ë“œ ì±„ìš°ê¸°
                                        if (actualPricingType === 'per_person') {
                                            // ì¸ì›ë³„ ìš”ê¸ˆ
                                            const adultCountInput = extraCard.querySelector('[data-extra-field="adult_count"]');
                                            const adultPriceInput = extraCard.querySelector('[data-extra-field="adult_price"]');
                                            const childCountInput = extraCard.querySelector('[data-extra-field="child_count"]');
                                            const childPriceInput = extraCard.querySelector('[data-extra-field="child_price"]');
                                            const infantCountInput = extraCard.querySelector('[data-extra-field="infant_count"]');
                                            const infantPriceInput = extraCard.querySelector('[data-extra-field="infant_price"]');
                                            
                                            if (adultCountInput) adultCountInput.value = extra.adult_count || 0;
                                            if (adultPriceInput) adultPriceInput.value = extra.adult_price || 0;
                                            if (childCountInput) childCountInput.value = extra.child_count || 0;
                                            if (childPriceInput) childPriceInput.value = extra.child_price || 0;
                                            if (infantCountInput) infantCountInput.value = extra.infant_count || 0;
                                            if (infantPriceInput) infantPriceInput.value = extra.infant_price || 0;
                                            
                                            console.log(`  â†’ ì¸ì›ë³„: ì„±ì¸ ${extra.adult_count}ëª…Ã—$${extra.adult_price}, ì†Œì•„ ${extra.child_count}ëª…Ã—$${extra.child_price}`);
                                        } else {
                                            // ì •ì•¡ ìš”ê¸ˆ
                                            const unitPriceInput = extraCard.querySelector('[data-extra-field="unit_price"]');
                                            if (unitPriceInput) unitPriceInput.value = extra.unit_price || 0;
                                            
                                            console.log(`  â†’ ì •ì•¡: $${extra.unit_price}`);
                                        }
                                        
                                        // â­ ì†Œê³„ ê³„ì‚° (ì´ë¯¸ toggleExtraPricing í˜¸ì¶œí•¨)
                                        calculateExtraTotal(currentExtraNum);
                                        
                                        console.log(`  âœ… ì¶”ê°€í•­ëª© ${idx + 1} ì™„ë£Œ`);
                                    } else {
                                        console.error(`âŒ ì¶”ê°€í•­ëª© ì¹´ë“œ ì°¾ì„ ìˆ˜ ì—†ìŒ: extra_${currentExtraNum}`);
                                    }
                                }, 100 * idx);
                            });
                            
                            // â­ displayedExtras ê¸°ë°˜ìœ¼ë¡œ íƒ€ì´ë° ì¡°ì •
                            const delayTime = displayedExtras > 0 ? (100 * displayedExtras + 100) : 200;
                            
                            setTimeout(() => {
                                if (displayedExtras === 0) {
                                    console.log('â„¹ï¸ í‘œì‹œí•  ì¶”ê°€ í•­ëª© ì—†ìŒ (ì¡°ì‹ í•­ëª©ì€ ê°ì‹¤ ì •ë³´ì— í¬í•¨)');
                                } else {
                                    console.log(`âœ… ì¶”ê°€ í•­ëª© ${displayedExtras}ê°œ ë¡œë“œ ì™„ë£Œ`);
                                }
                                
                                // â­ ì¡°ì‹ ìš”ê¸ˆ ì¬ê³„ì‚° (ê°ì‹¤ë³„ ì¡°ì‹ ì •ë³´ ë¡œë“œ ì™„ë£Œ í›„)
                                updateRoomCharges();
                                
                                // â­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ - ì´ì œ í”„ë¡œëª¨ì…˜ ì¡°íšŒ ê°€ëŠ¥
                                isLoadingData = false;
                                console.log('âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ - í”„ë¡œëª¨ì…˜ ì¡°íšŒ í™œì„±í™”');
                            }, delayTime);
                        } else {
                            // ì¶”ê°€ í•­ëª©ì´ ì—†ëŠ” ê²½ìš°ë„ ì¡°ì‹ ìš”ê¸ˆ ê³„ì‚°
                            setTimeout(() => {
                                updateRoomCharges();
                                isLoadingData = false;
                                console.log('âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ (ì¶”ê°€ í•­ëª© ì—†ìŒ)');
                            }, 200);
                        }
                    }, 500);
                    
                }, 300);
                
            } catch (error) {
                console.error('âŒ ì˜ˆì•½ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì˜ˆì•½ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ìˆ˜ì •ì‚¬í•­ ì €ì¥
        async function saveReservationChanges() {
            if (!currentEditingId) {
                alert('ì €ì¥í•  ì˜ˆì•½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ê¸°ë³¸ ì •ë³´ ìˆ˜ì§‘
            const hotelId = document.getElementById('hotel_id').value;
            const bookingAgencyId = document.getElementById('booking_agency_id').value;
            
            if (!hotelId) {
                alert('í˜¸í…”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ê°ì‹¤ ë°ì´í„° ìˆ˜ì§‘
            const rooms = [];
            document.querySelectorAll('.room-card').forEach(roomCard => {
                const roomNum = roomCard.dataset.roomId;
                const roomTypeSelect = roomCard.querySelector(`[data-room="${roomNum}"]`);
                const roomTypeId = roomTypeSelect?.value;
                
                if (!roomTypeId) return;
                
                // íˆ¬ìˆ™ê° ë°ì´í„° ìˆ˜ì§‘
                const guests = [];
                const guestCards = roomCard.querySelectorAll('.guest-card');
                guestCards.forEach(guestCard => {
                    const guestData = {};
                    const fields = guestCard.querySelectorAll('[data-guest-field]');
                    fields.forEach(field => {
                        const fieldName = field.dataset.guestField;
                        // â­ ë¹ˆ ë¬¸ìì—´ì€ nullë¡œ ë³€í™˜ (íŠ¹íˆ date_of_birth)
                        const value = field.value?.trim();
                        guestData[fieldName] = value && value !== '' ? value : null;
                    });
                    
                    // ìµœì†Œí•œ ì´ë¦„ì´ ìˆì–´ì•¼ ì¶”ê°€
                    if (guestData.guest_name_ko || guestData.guest_name_en) {
                        console.log(`  â†’ íˆ¬ìˆ™ê° ì €ì¥:`, guestData.guest_name_ko, `ìƒë…„ì›”ì¼: ${guestData.date_of_birth}`);
                        guests.push(guestData);
                    }
                });
                
                // í”„ë¡œëª¨ì…˜ ì •ë³´
                const roomPromo = roomPromotions[roomNum];
                
                // â­ ì¡°ì‹ ì •ë³´ ìˆ˜ì§‘
                const breakfastIncluded = document.getElementById(`breakfast_included_${roomNum}`)?.checked || false;
                const breakfastDays = parseInt(document.getElementById(`breakfast_days_${roomNum}`)?.value) || 1;
                const breakfastAdultPrice = parseFloat(document.getElementById(`breakfast_adult_price_${roomNum}`)?.value) || 0;
                const breakfastChildPrice = parseFloat(document.getElementById(`breakfast_child_price_${roomNum}`)?.value) || 0;
                
                rooms.push({
                    room_type_id: parseInt(roomTypeId),
                    guests: guests,
                    promotion_code: roomPromo?.promotion?.promo_code || null,
                    rate_condition_id: roomPromo?.rate_condition_id || null,
                    total_selling_price: roomPromo?.total_room_rate || 0,
                    // â­ ì¡°ì‹ ì •ë³´ ì¶”ê°€
                    breakfast_included: breakfastIncluded,
                    breakfast_days: breakfastIncluded ? breakfastDays : 0,
                    breakfast_adult_price: breakfastIncluded ? breakfastAdultPrice : 0,
                    breakfast_child_price: breakfastIncluded ? breakfastChildPrice : 0
                });
                
                console.log(`  â†’ ê°ì‹¤ ${roomNum} ì €ì¥: ë£¸íƒ€ì…=${roomTypeId}, í”„ë¡œëª¨ì…˜=${roomPromo?.promotion?.promo_code}, ìš”ê¸ˆ=$${roomPromo?.total_room_rate || 0}, ì¡°ì‹=${breakfastIncluded}`);
            });
            
            if (rooms.length === 0) {
                alert('ìµœì†Œ 1ê°œì˜ ê°ì‹¤ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì¶”ê°€ í•­ëª© ìˆ˜ì§‘
            const extras = [];
            document.querySelectorAll('.extra-item-card').forEach((extraCard, cardIndex) => {
                const extraNum = extraCard.querySelector('[data-extra-field="quantity"]')?.dataset.extra;
                if (!extraNum) {
                    console.warn(`âš ï¸ ì¶”ê°€í•­ëª© ì¹´ë“œ ${cardIndex}ì— data-extra ì†ì„±ì´ ì—†ìŠµë‹ˆë‹¤.`);
                    return;
                }
                
                const itemName = extraCard.querySelector('[data-extra-field="item_name"]')?.value?.trim();
                
                // â­ ì¡°ì‹ì€ ê°ì‹¤ ì •ë³´ì— í¬í•¨ë˜ë¯€ë¡œ ì €ì¥ì—ì„œ ì œì™¸
                if (itemName && itemName.includes('ì¡°ì‹')) {
                    console.log(`â­ï¸ ì¡°ì‹ í•­ëª© ì €ì¥ ì œì™¸: ${itemName} (ê°ì‹¤ íƒ€ì…ì— í¬í•¨ë¨)`);
                    return;
                }
                
                const pricingType = extraCard.querySelector('[data-extra-field="pricing_type"]')?.value || 'flat';
                const quantity = parseInt(extraCard.querySelector('[data-extra-field="quantity"]')?.value) || 1;
                
                console.log(`\nğŸ“ ì¶”ê°€í•­ëª© ${cardIndex + 1} (extraNum: ${extraNum}) ìˆ˜ì§‘ ì‹œì‘:`);
                console.log(`  í•­ëª©ëª…: ${itemName}, ìœ í˜•: ${pricingType}, ìˆ˜ëŸ‰: ${quantity}`);
                
                let totalPrice = 0;
                let extraData = {
                    item_name: itemName,
                    pricing_type: pricingType,
                    quantity: quantity
                };
                
                if (pricingType === 'per_person') {
                    const adultCount = parseInt(extraCard.querySelector('[data-extra-field="adult_count"]')?.value) || 0;
                    const adultPrice = parseFloat(extraCard.querySelector('[data-extra-field="adult_price"]')?.value) || 0;
                    const childCount = parseInt(extraCard.querySelector('[data-extra-field="child_count"]')?.value) || 0;
                    const childPrice = parseFloat(extraCard.querySelector('[data-extra-field="child_price"]')?.value) || 0;
                    const infantCount = parseInt(extraCard.querySelector('[data-extra-field="infant_count"]')?.value) || 0;
                    const infantPrice = parseFloat(extraCard.querySelector('[data-extra-field="infant_price"]')?.value) || 0;
                    
                    totalPrice = (adultCount * adultPrice + childCount * childPrice + infantCount * infantPrice) * quantity;
                    
                    extraData.adult_count = adultCount;
                    extraData.adult_price = adultPrice;
                    extraData.child_count = childCount;
                    extraData.child_price = childPrice;
                    extraData.infant_count = infantCount;
                    extraData.infant_price = infantPrice;
                    extraData.unit_price = null;
                    
                    console.log(`  â†’ ì¸ì›ë³„ ìš”ê¸ˆ ì €ì¥: ${itemName} - ì„±ì¸ ${adultCount}Ã—$${adultPrice}, ì†Œì•„ ${childCount}Ã—$${childPrice}, ì´: $${totalPrice}`);
                } else {
                    const unitPrice = parseFloat(extraCard.querySelector('[data-extra-field="unit_price"]')?.value) || 0;
                    totalPrice = unitPrice * quantity;
                    extraData.unit_price = unitPrice;
                    extraData.adult_count = null;
                    extraData.adult_price = null;
                    extraData.child_count = null;
                    extraData.child_price = null;
                    extraData.infant_count = null;
                    extraData.infant_price = null;
                    
                    console.log(`  â†’ ì •ì•¡ ìš”ê¸ˆ ì €ì¥: ${itemName} - ìˆ˜ëŸ‰ ${quantity}Ã—$${unitPrice}, ì´: $${totalPrice}`);
                }
                
                extraData.total_selling_price = totalPrice;
                
                if (itemName) {
                    extras.push(extraData);
                }
            });
            
            // ì „ì²´ ë°ì´í„° êµ¬ì„±
            const updatedData = {
                hotel_id: parseInt(hotelId),
                booking_agency_id: bookingAgencyId ? parseInt(bookingAgencyId) : null,
                reservation_date: document.getElementById('reservation_date').value,
                status: document.getElementById('status').value,
                check_in_date: document.getElementById('check_in_date').value,
                check_out_date: document.getElementById('check_out_date').value,
                arrival_flight: document.getElementById('arrival_flight').value || null,
                departure_flight: document.getElementById('departure_flight').value || null,
                special_requests: document.getElementById('special_requests').value || null,
                internal_memo: document.getElementById('internal_memo').value || null,
                total_selling_price: parseFloat(document.getElementById('totalRoomCharge').value) || 0,
                rooms: rooms,
                extras: extras
            };
            
            console.log('ğŸ’¾ ì €ì¥ ë°ì´í„°:', updatedData);
            
            try {
                const response = await fetch(`/api/hotel-reservations/${currentEditingId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('âœ… ì˜ˆì•½ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    bootstrap.Modal.getInstance(document.getElementById('editReservationModal')).hide();
                    loadReservations();
                } else {
                    console.error('ì €ì¥ ì‹¤íŒ¨:', result);
                    alert('âŒ ìˆ˜ì • ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('âŒ ìˆ˜ì • ì˜¤ë¥˜:', error);
                alert('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ìˆ˜ë°°ì„œ ìƒì„±/ë³´ê¸°
        async function createAssignment(reservationId) {
            try {
                // ì˜ˆì•½ ì •ë³´ ì¡°íšŒ
                const response = await fetch(`/api/hotel-reservations/${reservationId}`);
                const reservation = await response.json();
                
                if (!response.ok) {
                    throw new Error(reservation.message || 'ì˜ˆì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // ìˆ˜ë°°ì„œ ì´ë ¥ ì¡°íšŒ
                const historyResponse = await fetch(`/api/hotel-assignments/${reservationId}/history`);
                const historyData = await historyResponse.json();
                const history = historyData.success ? historyData.history : [];
                
                // ìˆ˜ë°°ì„œ ëª¨ë‹¬ ì—´ê¸°
                openAssignmentModal(reservation, history);
                
            } catch (error) {
                console.error('âŒ ìˆ˜ë°°ì„œ ì¡°íšŒ ì˜¤ë¥˜:', error);
                alert('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ìˆ˜ë°°ì„œ ëª¨ë‹¬ ì—´ê¸°
        function openAssignmentModal(reservation, history) {
            const modal = new bootstrap.Modal(document.getElementById('assignmentModal'));
            
            // ìˆ˜ë°°ì„œ HTML ìƒì„±
            const assignmentHTML = generateAssignmentPreview(reservation, history);
            document.getElementById('assignmentContent').innerHTML = assignmentHTML;
            
            // í˜„ì¬ ì˜ˆì•½ ID ì €ì¥
            window.currentAssignmentReservationId = reservation.id;
            window.currentAssignmentHistory = history;
            
            modal.show();
        }
        
        // ìˆ˜ë°°ì„œ ë¯¸ë¦¬ë³´ê¸° HTML ìƒì„±
        function generateAssignmentPreview(reservation, history) {
            const latestHistory = history[history.length - 1];
            const assignmentType = latestHistory ? latestHistory.assignment_type : 'NEW';
            const revisionNumber = latestHistory ? latestHistory.revision_number : 0;
            
            let title = 'NEW BOOKING REQUEST';
            if (assignmentType === 'REVISE') {
                title = `REVISE #${revisionNumber} REQUEST`;
            } else if (assignmentType === 'CANCEL') {
                title = 'CANCELLATION REQUEST';
            }
            
            let historyHTML = '';
            if (history.length > 0) {
                history.forEach(h => {
                    const date = new Date(h.sent_at);
                    const dateStr = date.toLocaleDateString('ko-KR');
                    const typeLabel = h.assignment_type === 'NEW' ? 'NEW' : (h.assignment_type === 'REVISE' ? `REV#${h.revision_number}` : 'CANCEL');
                    historyHTML += `
                        <div class="alert alert-info alert-sm py-1 px-2 mb-1" style="font-size: 0.75rem;">
                            <strong>[${typeLabel}]</strong> ${dateStr} â†’ ${h.sent_to_email} (${h.sent_by})
                            ${h.changes_description ? `<br>ë³€ê²½: ${h.changes_description}` : ''}
                        </div>
                    `;
                });
            } else {
                historyHTML = '<p class="text-muted">ì•„ì§ ì „ì†¡ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
            
            return `
                <div class="card mb-3">
                    <div class="card-header bg-dark text-white text-center">
                        <h5 class="mb-0">ğŸ¨ ${title}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-6"><strong>Hotel:</strong> ${reservation.hotel_name || '-'}</div>
                            <div class="col-6"><strong>Agency:</strong> ${reservation.booking_agency_name || '-'}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6"><strong>Check-in:</strong> ${reservation.check_in_date || '-'}</div>
                            <div class="col-6"><strong>Check-out:</strong> ${reservation.check_out_date || '-'}</div>
                        </div>
                        <div class="alert alert-warning">
                            <strong>âš ï¸ ì•ˆë‚´:</strong> ì‹¤ì œ ìˆ˜ë°°ì„œëŠ” ì´ë©”ì¼ë¡œ ì „ì†¡ë˜ë©°, í˜¸í…”ì—ì„œ ì¶œë ¥ ê°€ëŠ¥í•œ A4 ì–‘ì‹ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">ğŸ“œ ì „ì†¡ ì´ë ¥</h6>
                    </div>
                    <div class="card-body">
                        ${historyHTML}
                    </div>
                </div>
            `;
        }
        
        // ìˆ˜ë°°ì„œ ì´ë©”ì¼ ì „ì†¡
        async function sendAssignmentEmail() {
            const reservationId = window.currentAssignmentReservationId;
            if (!reservationId) {
                alert('ì˜ˆì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ì „ì†¡ íƒ€ì… ì„ íƒ
            const history = window.currentAssignmentHistory || [];
            let assignmentType = 'NEW';
            let message = 'ì‹ ê·œ ìˆ˜ë°°ì„œë¥¼ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
            
            if (history.length > 0) {
                const choice = confirm('ê¸°ì¡´ ìˆ˜ë°°ì„œê°€ ìˆìŠµë‹ˆë‹¤.\n\ní™•ì¸: ìˆ˜ì •(REVISE) ì „ì†¡\nì·¨ì†Œ: ì‹ ê·œ(NEW) ì „ì†¡');
                assignmentType = choice ? 'REVISE' : 'NEW';
                message = choice ? 'ìˆ˜ì •ëœ ìˆ˜ë°°ì„œë¥¼ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'ì‹ ê·œ ìˆ˜ë°°ì„œë¡œ ë‹¤ì‹œ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
            }
            
            if (!confirm(message)) return;
            
            // ë³€ê²½ ì‚¬í•­ ì…ë ¥ (REVISEì¸ ê²½ìš°)
            let changesDescription = '';
            if (assignmentType === 'REVISE') {
                changesDescription = prompt('ë³€ê²½ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì²´í¬ì¸ ë‚ ì§œ ë³€ê²½, ê°ì‹¤ ì¶”ê°€ ë“±):');
                if (changesDescription === null) return; // ì·¨ì†Œ
            }
            
            try {
                const response = await fetch('/api/hotel-assignments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reservation_id: reservationId,
                        assignment_type: assignmentType,
                        changes_description: changesDescription,
                        sent_by: 'Admin' // TODO: ë¡œê·¸ì¸ ì‚¬ìš©ìëª…ìœ¼ë¡œ ë³€ê²½
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`âœ… ìˆ˜ë°°ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!\n\në§í¬: ${result.assignment_link}`);
                    bootstrap.Modal.getInstance(document.getElementById('assignmentModal')).hide();
                    loadReservations();
                } else {
                    alert('âŒ ì „ì†¡ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('âŒ ì „ì†¡ ì˜¤ë¥˜:', error);
                alert('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ìˆ˜ë°°ì„œ ë§í¬ ë³µì‚¬
        function copyAssignmentLink() {
            const reservationId = window.currentAssignmentReservationId;
            if (!reservationId) {
                alert('ì˜ˆì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // TODO: assignment_token ê¸°ë°˜ ë§í¬ ìƒì„±
            alert('ë§í¬ ë³µì‚¬ ê¸°ëŠ¥ì€ ìˆ˜ë°°ì„œ ì „ì†¡ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        }
        
        // ìˆ˜ë°°ì„œ ì¶œë ¥
        function printAssignment() {
            const reservationId = window.currentAssignmentReservationId;
            if (!reservationId) {
                alert('ì˜ˆì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // TODO: ê³µê°œ ë§í¬ë¡œ ì´ë™í•˜ì—¬ ì¶œë ¥
            alert('ì¶œë ¥ ê¸°ëŠ¥ì€ ìˆ˜ë°°ì„œ ì „ì†¡ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        }
        
        // í™•ì •
        async function confirmReservation(reservationId) {
            if (!confirm('ì˜ˆì•½ì„ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const response = await fetch(`/api/hotel-reservations/${reservationId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'confirmed' })
                });
                
                if (response.ok) {
                    alert('âœ… ì˜ˆì•½ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadReservations();
                } else {
                    alert('âŒ í™•ì • ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('í™•ì • ì˜¤ë¥˜:', error);
                alert('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ë°”ìš°ì²˜+ì¸ë³´ì´ìŠ¤ ìƒì„±
        function createVoucher(reservationId) {
            if (confirm('ë°”ìš°ì²˜ì™€ ì¸ë³´ì´ìŠ¤ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                alert('ë°”ìš°ì²˜+ì¸ë³´ì´ìŠ¤ ìƒì„± ê¸°ëŠ¥ì€ ê³§ ì¶”ê°€ë©ë‹ˆë‹¤.');
            }
        }
        
        // ì •ì‚° ì´ê´€
        function createSettlement(reservationId) {
            if (confirm('ì •ì‚°ìœ¼ë¡œ ì´ê´€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                alert('ì •ì‚° ì´ê´€ ê¸°ëŠ¥ì€ ê³§ ì¶”ê°€ë©ë‹ˆë‹¤.');
            }
        }
    </script>
</body>
</html>