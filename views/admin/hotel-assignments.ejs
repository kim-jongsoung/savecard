<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Í¥åÏÑ∏Ïù¥Î∏åÏπ¥Îìú</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Î™®Îã¨ ÎÇ¥Î∂ÄÎäî Ïù∏Î∞ïÏä§ÏôÄ ÎèôÏùºÌïú Ìè∞Ìä∏ ÌÅ¨Í∏∞ (30% Ï∂ïÏÜå) */
        body {
            font-size: 0.8rem;
            background: #f5f7fa;
        }
        
        /* Î™®Îã¨ Ï†ÑÏö© Ïä§ÌÉÄÏùº - Ïù∏Î∞ïÏä§ÏôÄ ÎèôÏùº */
        .modal-body .form-label {
            font-size: 0.7rem !important;
            margin-bottom: 0.25rem;
        }
        .modal-body .form-control, .modal-body .form-select {
            font-size: 0.7rem !important;
            padding: 0.25rem 0.5rem !important;
        }
        .modal-body h2 {
            font-size: 1.4rem !important;
        }
        .modal-body h5 {
            font-size: 0.875rem !important;
        }
        .modal-body h6 {
            font-size: 0.75rem !important;
        }
        .modal-body .btn {
            font-size: 0.7rem !important;
            padding: 0.375rem 0.75rem !important;
        }
        
        .stats-card {
            border-radius: 12px;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .reservation-table {
            width: 100% !important;
            background: white !important;
            border-radius: 8px !important;
            overflow: hidden !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
            position: relative !important;
            margin: 0 !important;
        }
        .reservation-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
        }
        .reservation-table th {
            padding: 12px 8px !important;
            font-size: 0.75rem !important;
            font-weight: 600 !important;
            text-align: center !important;
            white-space: nowrap !important;
            border-right: 1px solid rgba(255,255,255,0.2) !important;
        }
        .reservation-table th:last-child {
            border-right: none !important;
        }
        .reservation-table tbody tr {
            border-bottom: 1px solid #e9ecef !important;
            transition: background 0.2s !important;
        }
        .reservation-table tbody tr:hover {
            background: #f8f9fa !important;
        }
        .reservation-table td {
            padding: 10px 8px !important;
            font-size: 0.75rem !important;
            vertical-align: middle !important;
            text-align: center !important;
            border-right: 1px solid #e9ecef !important;
        }
        .reservation-table td:last-child {
            border-right: none !important;
        }
        
        /* Î∞îÏö∞Ï≤ò Ïù∏Î≥¥Ïù¥Ïä§ Î™©Î°ù Í≤©Î¶¨ - Ïô∏Î∂Ä ÌÖåÏù¥Î∏îÏóê ÏòÅÌñ• Î∞©ÏßÄ */
        #voucherInvoicesList {
            isolation: isolate;
            position: relative;
        }
        
        .status-badge {
            padding: 0.35rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-processing { background: #d1ecf1; color: #0c5460; }
        .status-confirmed { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        .status-modifying { background: #e2e3e5; color: #383d41; }
        
        .action-btn {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 2px solid;
            transition: all 0.3s;
            margin: 0 4px;
            font-size: 1.2rem;
            cursor: pointer;
            background: white;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .btn-edit { border-color: #17a2b8; color: #17a2b8; }
        .btn-edit:hover { background: #17a2b8; color: white !important; }
        
        .btn-assignment { border-color: #6f42c1; color: #6f42c1; }
        .btn-assignment:hover { background: #6f42c1; color: white !important; }
        
        .btn-confirm { border-color: #28a745; color: #28a745; }
        .btn-confirm:hover { background: #28a745; color: white !important; }
        
        .btn-voucher { border-color: #fd7e14; color: #fd7e14; }
        .btn-voucher:hover { background: #fd7e14; color: white !important; }
        
        .btn-settlement { border-color: #dc3545; color: #dc3545; }
        .btn-settlement:hover { background: #dc3545; color: white !important; }
        
        .room-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }
        
        .date-info {
            background: #f8f9fa;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.75rem;
        }
        
        .search-box {
            border-radius: 25px;
            border: 2px solid #e0e0e0;
            padding: 0.5rem 1.5rem;
            transition: all 0.3s;
        }
        .search-box:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            outline: none;
        }
        
        .filter-btn {
            border-radius: 20px;
            padding: 0.4rem 1rem;
            font-size: 0.75rem;
            margin: 0 0.25rem;
            border: 2px solid #e0e0e0;
            background: white;
            transition: all 0.3s;
            cursor: pointer;
        }
        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .guest-list {
            font-size: 0.7rem;
            color: #666;
            margin-top: 0.5rem;
        }
        
        .price-tag {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .reservation-date-badge {
            background: #ffc107;
            color: #000;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        /* Ïù∏Î∞ïÏä§ Ïä§ÌÉÄÏùº Î≥µÏÇ¨ - Î™®Îã¨Ïö© */
        .modal-body .room-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f8f9fa;
        }
        .modal-body .room-card.active {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .modal-body .guest-card {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            background: white;
        }
        .modal-body .extra-item-card {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            background: #fff;
        }
        .modal-body .btn-add-room, 
        .modal-body .btn-add-guest, 
        .modal-body .btn-add-extra {
            border: 2px dashed #667eea;
            color: #667eea;
            background: white;
            font-weight: 600;
            transition: all 0.3s;
        }
        .modal-body .btn-add-room:hover, 
        .modal-body .btn-add-guest:hover, 
        .modal-body .btn-add-extra:hover {
            background: #667eea;
            color: white;
            border-style: solid;
        }
        .modal-body .total-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
        }
        .modal-body #status {
            font-weight: 600;
        }
        .modal-body #status option[value="pending"] {
            background-color: #fff3cd;
            color: #856404;
        }
        .modal-body #status option[value="processing"] {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .modal-body #status option[value="confirmed"] {
            background-color: #d4edda;
            color: #155724;
        }
        .modal-body #status option[value="cancelled"] {
            background-color: #f8d7da;
            color: #721c24;
        }
        .modal-body #status option[value="modifying"] {
            background-color: #e2e3e5;
            color: #383d41;
        }
        .modal-body #status.status-pending {
            background-color: #fff3cd;
            color: #856404;
            border-color: #ffc107;
        }
        .modal-body #status.status-processing {
            background-color: #d1ecf1;
            color: #0c5460;
            border-color: #17a2b8;
        }
        .modal-body #status.status-confirmed {
            background-color: #d4edda;
            color: #155724;
            border-color: #28a745;
        }
        .modal-body #status.status-cancelled {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }
        .modal-body #status.status-modifying {
            background-color: #e2e3e5;
            color: #383d41;
            border-color: #6c757d;
        }
        
        /* ÌîÑÎ°úÎ™®ÏÖò Ïä§ÌÉÄÏùº */
        .promo-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            font-weight: 600;
            margin-left: 0.5rem;
            font-size: 0.7rem;
        }
        .rate-display {
            background: #e7f3ff;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #2196F3;
            font-size: 0.7rem;
        }
        .benefit-badge {
            background: #4CAF50;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-right: 0.5rem;
            display: inline-block;
            margin-bottom: 0.25rem;
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar') %>

    <div class="container-fluid mt-4" style="max-width: 1400px;">
        <!-- Ìó§Îçî -->
        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="fas fa-clipboard-list me-2"></i>Ìò∏ÌÖî ÏàòÎ∞∞Í¥ÄÎ¶¨</h2>
            </div>
        </div>

        <!-- ÌÜµÍ≥Ñ Ïπ¥Îìú -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div style="font-size: 0.7rem; opacity: 0.9;">ÎåÄÍ∏∞Ï§ë</div>
                                <div style="font-size: 1.8rem; font-weight: bold;" id="stat-pending">0</div>
                            </div>
                            <i class="fas fa-clock" style="font-size: 2.5rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div style="font-size: 0.7rem; opacity: 0.9;">ÏàòÎ∞∞Ï§ë</div>
                                <div style="font-size: 1.8rem; font-weight: bold;" id="stat-processing">0</div>
                            </div>
                            <i class="fas fa-paper-plane" style="font-size: 2.5rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div style="font-size: 0.7rem; opacity: 0.9;">ÌôïÏ†ï</div>
                                <div style="font-size: 1.8rem; font-weight: bold;" id="stat-confirmed">0</div>
                            </div>
                            <i class="fas fa-check-circle" style="font-size: 2.5rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-secondary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div style="font-size: 0.7rem; opacity: 0.9;">Ï†ÑÏ≤¥</div>
                                <div style="font-size: 1.8rem; font-weight: bold;" id="stat-total">0</div>
                            </div>
                            <i class="fas fa-list" style="font-size: 2.5rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Í≥†Í∏â Í≤ÄÏÉâ Î∞è ÌïÑÌÑ∞ -->
        <div class="card mb-4" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div class="card-body">
                <!-- Ï≤´ Î≤àÏß∏ Ï§Ñ: Í∏∞Î≥∏ Í≤ÄÏÉâ -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <input type="text" class="form-control search-box" id="searchBox" placeholder="üîç ÏòàÏïΩÎ≤àÌò∏, Ìò∏ÌÖîÎ™Ö, Í≥†Í∞ùÎ™ÖÏúºÎ°ú Í≤ÄÏÉâ..." onkeyup="filterReservations()">
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleAdvancedFilter()">
                            <i class="fas fa-filter me-1"></i>ÏÉÅÏÑ∏ Í≤ÄÏÉâ
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="resetFilters()">
                            <i class="fas fa-redo me-1"></i>Ï¥àÍ∏∞Ìôî
                        </button>
                    </div>
                </div>

                <!-- Í≥†Í∏â ÌïÑÌÑ∞ ÏòÅÏó≠ (Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞) -->
                <div id="advancedFilterArea" style="display: none;">
                    <hr class="my-3">
                    <div class="row g-2">
                        <!-- ÎÇ†Ïßú Í≤ÄÏÉâ -->
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">ÎÇ†Ïßú Í∏∞Ï§Ä</label>
                            <select class="form-select form-select-sm" id="dateType">
                                <option value="check_in">Ï∂úÎ∞úÏùº(Ï≤¥ÌÅ¨Ïù∏)</option>
                                <option value="reservation">ÏòàÏïΩÏùº</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">ÏãúÏûëÏùº</label>
                            <input type="date" class="form-control form-control-sm" id="startDate">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">Ï¢ÖÎ£åÏùº</label>
                            <input type="date" class="form-control form-control-sm" id="endDate">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">Í±∞ÎûòÏ≤ò</label>
                            <select class="form-select form-select-sm" id="agencyFilter">
                                <option value="">Ï†ÑÏ≤¥</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">Íµ≠Í∞Ä/ÏßÄÏó≠</label>
                            <select class="form-select form-select-sm" id="countryFilter">
                                <option value="">Ï†ÑÏ≤¥</option>
                                <option value="Í¥å">Í¥å</option>
                                <option value="ÏÇ¨Ïù¥Ìåê">ÏÇ¨Ïù¥Ìåê</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">Ìò∏ÌÖîÎ™Ö</label>
                            <select class="form-select form-select-sm" id="hotelFilter">
                                <option value="">Ï†ÑÏ≤¥</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">Îã¥ÎãπÏûê</label>
                            <select class="form-select form-select-sm" id="assignedToFilter">
                                <option value="">Ï†ÑÏ≤¥</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">&nbsp;</label>
                            <button class="btn btn-sm btn-primary w-100" onclick="filterReservations()">
                                <i class="fas fa-search me-1"></i>Í≤ÄÏÉâ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ÏÉÅÌÉú ÌïÑÌÑ∞ Î≤ÑÌäº -->
                <div class="mt-3 d-flex justify-content-center flex-wrap gap-2">
                    <button class="filter-btn active" data-status="all" onclick="filterByStatus('all')">
                        <i class="fas fa-list me-1"></i>Ï†ÑÏ≤¥
                    </button>
                    <button class="filter-btn" data-status="pending" onclick="filterByStatus('pending')">
                        <i class="fas fa-clock me-1"></i>ÎåÄÍ∏∞Ï§ë
                    </button>
                    <button class="filter-btn" data-status="processing" onclick="filterByStatus('processing')">
                        <i class="fas fa-paper-plane me-1"></i>ÏàòÎ∞∞Ï§ë
                    </button>
                    <button class="filter-btn" data-status="confirmed" onclick="filterByStatus('confirmed')">
                        <i class="fas fa-check me-1"></i>ÌôïÏ†ï
                    </button>
                    <button class="filter-btn" data-status="modifying" onclick="filterByStatus('modifying')">
                        <i class="fas fa-edit me-1"></i>ÏàòÏ†ïÏ§ë
                    </button>
                    <button class="filter-btn" data-status="cancelled" onclick="filterByStatus('cancelled')">
                        <i class="fas fa-times me-1"></i>Ï∑®ÏÜå
                    </button>
                </div>
            </div>
        </div>

        <!-- ÏòàÏïΩ Î¶¨Ïä§Ìä∏ -->
        <div id="reservationsContainer">
            <!-- ÏòàÏïΩ Ïπ¥ÎìúÍ∞Ä ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê® -->
        </div>

        <!-- Î°úÎî© -->
        <div id="loading" class="text-center py-5" style="display: none;">
            <i class="fas fa-spinner fa-spin fa-3x text-primary"></i>
            <p class="mt-3">Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
        </div>

        <!-- Îπà ÏÉÅÌÉú -->
        <div id="emptyState" class="text-center py-5" style="display: none;">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <p class="text-muted">ÏòàÏïΩÏù¥ ÏóÜÏäµÎãàÎã§.</p>
        </div>
    </div>

    <!-- ÏòàÏïΩ ÏàòÏ†ï Î™®Îã¨ -->
    <div class="modal fade" id="editReservationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>ÏòàÏïΩ ÏàòÏ†ï
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
                    <!-- Ìò∏ÌÖîÏ†ïÎ≥¥ Î∞è Í∏∞Î≥∏Ï†ïÎ≥¥ ÏÑπÏÖò -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-hotel me-2"></i>Ìò∏ÌÖîÏ†ïÎ≥¥ Î∞è Í∏∞Î≥∏Ï†ïÎ≥¥
                            </h6>
                        </div>
                        <div class="col-12 mb-2">
                            <div class="d-flex align-items-center gap-1">
                                <label class="form-label mb-0" style="min-width: 55px;">Ìò∏ÌÖîÎ™Ö*</label>
                                <select class="form-control form-control-sm" id="hotel_id" required disabled style="background: #e9ecef; cursor: not-allowed; flex: 1.5;">
                                    <option value="">Ìò∏ÌÖî ÏÑ†ÌÉù</option>
                                </select>
                                <label class="form-label mb-0 ms-1" style="min-width: 75px;">ÏòàÏïΩÍ±∞ÎûòÏ≤ò</label>
                                <select class="form-control form-control-sm" id="booking_agency_id" disabled style="background: #e9ecef; cursor: not-allowed; flex: 1.5;">
                                    <option value="">Í±∞ÎûòÏ≤ò ÏÑ†ÌÉù</option>
                                </select>
                                <label class="form-label mb-0 ms-1" style="min-width: 65px;">ÏòàÏïΩÎ≤àÌò∏*</label>
                                <input type="text" class="form-control form-control-sm" id="reservation_number" required style="flex: 1;">
                                <label class="form-label mb-0 ms-1" style="min-width: 50px;">ÏòàÏïΩÏùº</label>
                                <input type="date" class="form-control form-control-sm fw-bold" id="reservation_date" readonly style="background: #f0f0f0; flex: 1;">
                                <label class="form-label mb-0 ms-1" style="min-width: 40px;">ÏÉÅÌÉú*</label>
                                <select class="form-control form-control-sm" id="status" style="flex: 0.8;" required>
                                    <option value="pending">ÎåÄÍ∏∞Ï§ë</option>
                                    <option value="processing">ÏàòÎ∞∞Ï§ë</option>
                                    <option value="confirmed">ÌôïÏ†ï</option>
                                    <option value="voucher">Î∞îÏö∞Ï≤ò</option>
                                    <option value="modifying">ÏàòÏ†ïÏ§ë</option>
                                    <option value="cancelled">ÏòàÏïΩÏ∑®ÏÜå</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ÎÇ†Ïßú Ï†ïÎ≥¥ ÏÑπÏÖò -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-calendar me-2"></i>ÎÇ†Ïßú Ï†ïÎ≥¥
                            </h6>
                        </div>
                        <div class="col-md-4 mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0" style="width: 40%;">Ï≤¥ÌÅ¨Ïù∏ *</label>
                                <input type="date" class="form-control" id="check_in_date" required onchange="calculateNights(); autoApplyPromotion();" style="width: 60%;">
                            </div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0" style="width: 40%;">Ï≤¥ÌÅ¨ÏïÑÏõÉ *</label>
                                <input type="date" class="form-control" id="check_out_date" required onchange="calculateNights(); autoApplyPromotion();" style="width: 60%;">
                            </div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0" style="width: 40%;">Î∞ïÏàò</label>
                                <input type="number" class="form-control fw-bold" id="nights" readonly style="background: #f0f0f0; width: 60%;">
                            </div>
                        </div>
                    </div>

                    <!-- Ìï≠Í≥µÌé∏ Ï†ïÎ≥¥ ÏÑπÏÖò -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-plane me-2"></i>Ìï≠Í≥µÌé∏ Ï†ïÎ≥¥
                            </h6>
                        </div>
                        <div class="col-md-6 mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0" style="width: 40%;">ÏûÖÍµ≠ Ìï≠Í≥µÌé∏Î™Ö</label>
                                <input type="text" class="form-control" id="arrival_flight" placeholder="Ïòà: KE123" style="width: 60%;">
                            </div>
                        </div>
                        <div class="col-md-6 mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0" style="width: 40%;">Ï∂úÍµ≠ Ìï≠Í≥µÌé∏Î™Ö</label>
                                <input type="text" class="form-control" id="departure_flight" placeholder="Ïòà: KE124" style="width: 60%;">
                            </div>
                        </div>
                    </div>

                    <!-- ÌîÑÎ°úÎ™®ÏÖò ÏΩîÎìú ÏÑπÏÖò -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-tag me-2"></i>ÌîÑÎ°úÎ™®ÏÖò ÏöîÍ∏à
                            </h6>
                        </div>
                        <div class="col-md-12">
                            <div id="promoResult" style="display: none;">
                                <!-- ÌîÑÎ°úÎ™®ÏÖò Í≤∞Í≥ºÍ∞Ä ÌëúÏãúÎê® -->
                            </div>
                            <div id="promoLoading" style="display: none;" class="text-center py-2">
                                <i class="fas fa-spinner fa-spin"></i> ÌîÑÎ°úÎ™®ÏÖò ÏöîÍ∏à Ï°∞Ìöå Ï§ë...
                            </div>
                            <div id="noPromo" class="alert alert-info py-2">
                                ÌîÑÎ°úÎ™®ÏÖò Ï†ïÎ≥¥ ÏóÜÏùå
                            </div>
                        </div>
                    </div>

                    <!-- Í∞ùÏã§ Ï†ïÎ≥¥ ÏÑπÏÖò -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-bed me-2"></i>Í∞ùÏã§ Ï†ïÎ≥¥
                            </h6>
                        </div>
                        <div class="col-12" id="roomsContainer">
                            <!-- Í∞ùÏã§Ïù¥ ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê® -->
                        </div>
                        <div class="col-12">
                            <button type="button" class="btn btn-add-room w-100" onclick="addRoom()">
                                <i class="fas fa-plus-circle me-2"></i>Í∞ùÏã§ Ï∂îÍ∞Ä
                            </button>
                        </div>
                    </div>

                    <!-- Ï∂îÍ∞Ä Ìï≠Î™© ÏÑπÏÖò -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-plus-square me-2"></i>Ï∂îÍ∞Ä Ìï≠Î™© (Í≥µÌï≠ÌîΩÏóÖ, ÍΩÉÎ∞îÍµ¨Îãà Îì±)
                            </h6>
                        </div>
                        <div class="col-12" id="extrasContainer">
                            <!-- Ï∂îÍ∞Ä Ìï≠Î™©Ïù¥ ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê® -->
                        </div>
                        <div class="col-12">
                            <button type="button" class="btn btn-add-extra w-100" onclick="addExtraItem()">
                                <i class="fas fa-plus-circle me-2"></i>Ìï≠Î™© Ï∂îÍ∞Ä
                            </button>
                        </div>
                    </div>

                    <!-- Ï¥ù ÏöîÍ∏à ÏÑπÏÖò -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="total-summary">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Ï¥ù Í∞ùÏã§ ÏöîÍ∏à:</span>
                                    <div class="input-group input-group-sm" style="width: 150px;">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="totalRoomCharge" value="0" step="0.01" min="0" onchange="calculateTotal()" style="text-align: right; font-weight: bold; max-width: 60%;">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span id="breakfastChargeLabel">Ï°∞Ïãù ÏöîÍ∏à (Î∂àÌè¨Ìï®):</span>
                                    <div class="input-group input-group-sm" style="width: 150px;">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="totalBreakfastCharge" value="0" step="0.01" min="0" readonly style="text-align: right; font-weight: bold; max-width: 60%; background: #e7f3ff;">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Ï∂îÍ∞Ä Ìï≠Î™© ÏöîÍ∏à:</span>
                                    <div class="input-group input-group-sm" style="width: 150px;">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="totalExtrasCharge" value="0" step="0.01" min="0" onchange="calculateTotal()" style="text-align: right; font-weight: bold; max-width: 60%;">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2" id="agencyFeeRow" style="display: none;">
                                    <span>ÏàòÎ∞∞Ìîº (<span id="agencyFeeName"></span>):</span>
                                    <div class="input-group input-group-sm" style="width: 150px;">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="agencyFee" value="0" step="0.01" min="0" onchange="calculateTotal()" style="text-align: right; font-weight: bold; max-width: 60%;">
                                    </div>
                                </div>
                                <hr style="border-color: rgba(255,255,255,0.3);">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Ï¥ù ÌåêÎß§Í∞Ä:</h5>
                                    <h4 class="mb-0" id="grandTotal">$0.00</h4>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Î©îÎ™® ÏÑπÏÖò -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-sticky-note me-2"></i>Î©îÎ™®
                            </h6>
                        </div>
                        <div class="col-12 mb-2">
                            <div class="d-flex gap-2">
                                <label class="form-label mb-0" style="width: 20%;">ÌäπÎ≥Ñ ÏöîÏ≤≠ÏÇ¨Ìï≠</label>
                                <textarea class="form-control" id="special_requests" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="col-12 mb-2">
                            <div class="d-flex gap-2">
                                <label class="form-label mb-0" style="width: 20%;">ÎÇ¥Î∂Ä Î©îÎ™®</label>
                                <textarea class="form-control" id="internal_memo" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ï∑®ÏÜå</button>
                    <button type="button" class="btn btn-success btn-lg" onclick="saveReservationChanges()">
                        <i class="fas fa-save me-1"></i>Ï†ÄÏû•
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="voucherInvoiceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h5 class="modal-title text-white">
                        <i class="fas fa-file-invoice-dollar me-2"></i>Î∞îÏö∞Ï≤ò Ïù∏Î≥¥Ïù¥Ïä§ Í¥ÄÎ¶¨
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- ÏòàÏïΩ Ï†ïÎ≥¥ ÏöîÏïΩ -->
                    <div class="alert alert-info mb-4">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>ÏòàÏïΩÎ≤àÌò∏:</strong> <span id="invoiceReservationNumber">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>ÏòàÏïΩÏûê:</strong> <span id="invoiceGuestName">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Ìò∏ÌÖî:</strong> <span id="invoiceHotelName">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Ï≤¥ÌÅ¨Ïù∏:</strong> <span id="invoiceCheckIn">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- ÏóÖÎ¨¥ ÌîÑÎ°úÏÑ∏Ïä§ Îã®Í≥Ñ -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="fas fa-tasks me-2"></i>ÏóÖÎ¨¥ ÌîÑÎ°úÏÑ∏Ïä§</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col">
                                    <div class="process-step" id="step1">
                                        <div class="step-icon">
                                            <i class="fas fa-calculator fa-2x text-primary"></i>
                                        </div>
                                        <div class="step-title mt-2">1. Í∏àÏï° ÌôïÏù∏</div>
                                        <div class="step-status">
                                            <span class="badge bg-secondary" id="step1Status">ÎåÄÍ∏∞</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="process-step" id="step2">
                                        <div class="step-icon">
                                            <i class="fas fa-file-invoice fa-2x text-muted"></i>
                                        </div>
                                        <div class="step-title mt-2">2. Ïù∏Î≥¥Ïù¥Ïä§ ÏÉùÏÑ±</div>
                                        <div class="step-status">
                                            <span class="badge bg-secondary" id="step2Status">ÎåÄÍ∏∞</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="process-step" id="step3">
                                        <div class="step-icon">
                                            <i class="fas fa-envelope fa-2x text-muted"></i>
                                        </div>
                                        <div class="step-title mt-2">3. Ïù¥Î©îÏùº Ï†ÑÏÜ°</div>
                                        <div class="step-status">
                                            <span class="badge bg-secondary" id="step3Status">ÎåÄÍ∏∞</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="process-step" id="step4">
                                        <div class="step-icon">
                                            <i class="fas fa-check-circle fa-2x text-muted"></i>
                                        </div>
                                        <div class="step-title mt-2">4. ÏôÑÎ£å</div>
                                        <div class="step-status">
                                            <span class="badge bg-secondary" id="step4Status">ÎåÄÍ∏∞</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- ÏôºÏ™Ω: Ï†ïÏÇ∞ Í∏àÏï° Î∞è ÏÉùÏÑ± -->
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>Ï†ïÏÇ∞ Í∏àÏï° ÏÉÅÏÑ∏ ÎÇ¥Ïó≠</h6>
                                </div>
                                <div class="card-body">
                                    <!-- Í∏àÏï° ÏÉÅÏÑ∏ ÎÇ¥Ïó≠ -->
                                    <div class="mb-3 p-3" style="background: #f8f9fa; border-radius: 8px;">
                                        <h6 class="mb-3 text-primary"><i class="fas fa-list-ul me-2"></i>Í∏àÏï° Íµ¨ÏÑ±</h6>
                                        
                                        <!-- Ï¥ù Í∞ùÏã§ ÏöîÍ∏à -->
                                        <div class="d-flex justify-content-between mb-2">
                                            <span><i class="fas fa-bed me-2 text-info"></i>Ï¥ù Í∞ùÏã§ ÏöîÍ∏à</span>
                                            <strong id="voucherRoomChargeDisplay">$0.00</strong>
                                        </div>
                                        
                                        <!-- Ï°∞Ïãù ÏöîÍ∏à -->
                                        <div class="mb-2" id="voucherBreakfastSection">
                                            <div class="d-flex justify-content-between">
                                                <span><i class="fas fa-utensils me-2 text-warning"></i>Ï°∞Ïãù ÏöîÍ∏à</span>
                                                <strong id="voucherBreakfastChargeDisplay">$0.00</strong>
                                            </div>
                                            <small class="text-muted ms-4" id="voucherBreakfastDetail">-</small>
                                        </div>
                                        
                                        <!-- Ï∂îÍ∞Ä Ìï≠Î™© ÏöîÍ∏à -->
                                        <div class="mb-2" id="voucherExtrasSection">
                                            <div class="d-flex justify-content-between">
                                                <span><i class="fas fa-plus-circle me-2 text-success"></i>Ï∂îÍ∞Ä Ìï≠Î™© ÏöîÍ∏à</span>
                                                <strong id="voucherExtrasChargeDisplay">$0.00</strong>
                                            </div>
                                            <small class="text-muted ms-4" id="voucherExtrasDetail">-</small>
                                        </div>
                                        
                                        <!-- ÏàòÎ∞∞Ìîº -->
                                        <div class="d-flex justify-content-between mb-2">
                                            <span><i class="fas fa-handshake me-2 text-danger"></i>ÏàòÎ∞∞Ìîº <span id="voucherAgencyNameDisplay" class="badge bg-secondary ms-1" style="font-size: 0.7rem;">-</span></span>
                                            <strong id="voucherAgencyFeeDisplay">$0.00</strong>
                                        </div>
                                        
                                        <hr class="my-2">
                                        
                                        <!-- Ìï©Í≥Ñ -->
                                        <div class="d-flex justify-content-between mb-3">
                                            <strong class="text-success"><i class="fas fa-equals me-2"></i>Ìï©Í≥Ñ (USD)</strong>
                                            <h5 class="mb-0 text-success" id="voucherTotalUSD">$0.00</h5>
                                        </div>
                                        
                                        <!-- ÌôòÏú® Ï†ÅÏö© ÏõêÌôî -->
                                        <div class="d-flex justify-content-between align-items-center p-2" style="background: white; border-radius: 6px;">
                                            <div>
                                                <strong class="text-primary"><i class="fas fa-won-sign me-2"></i>Ìï©Í≥Ñ (KRW)</strong>
                                                <br>
                                                <small class="text-muted" id="voucherFxRateLabel">ÌôòÏú® Ï†ïÎ≥¥ Î°úÎî© Ï§ë...</small>
                                            </div>
                                            <h5 class="mb-0 text-primary" id="voucherTotalKRW">‚Ç©0</h5>
                                        </div>
                                    </div>
                                    
                                    <input type="hidden" id="voucherBaseAmount">
                                    <input type="hidden" id="voucherDiscount" value="0">
                                    <input type="hidden" id="voucherSurcharge" value="0">
                                    <input type="hidden" id="voucherFinalAmountUSD">
                                    <input type="hidden" id="voucherFinalAmountKRW">
                                    
                                    <button type="button" class="btn btn-success w-100 btn-lg" onclick="saveVoucherInvoice()">
                                        <i class="fas fa-file-invoice me-2"></i>Ïù∏Î≥¥Ïù¥Ïä§ ÏÉùÏÑ±
                                    </button>
                                </div>
                            </div>

                            <!-- Ïù¥Î©îÏùº Ï†ÑÏÜ° -->
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-envelope me-2"></i>Ïù¥Î©îÏùº Ï†ÑÏÜ°</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Î∞õÎäî ÏÇ¨Îûå Ïù¥Î©îÏùº</label>
                                        <input type="email" class="form-control" id="invoiceRecipientEmail" placeholder="example@email.com">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Ï†úÎ™©</label>
                                        <input type="text" class="form-control" id="invoiceEmailSubject" value="[Í¥åÏÑ∏Ïù¥Î∏åÏπ¥Îìú] Ìò∏ÌÖî Î∞îÏö∞Ï≤ò Ïù∏Î≥¥Ïù¥Ïä§">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Î©îÏãúÏßÄ</label>
                                        <textarea class="form-control" id="invoiceEmailMessage" rows="3" placeholder="Ï∂îÍ∞Ä Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
                                    </div>
                                    <button type="button" class="btn btn-info w-100" onclick="sendInvoiceEmail()" id="btnSendEmail" disabled>
                                        <i class="fas fa-paper-plane me-2"></i>Ïù¥Î©îÏùº Ï†ÑÏÜ°
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Ïò§Î•∏Ï™Ω: Î∞úÌñâÎêú Ïù∏Î≥¥Ïù¥Ïä§ Î™©Î°ù -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="fas fa-list me-2"></i>Î∞úÌñâÎêú Ïù∏Î≥¥Ïù¥Ïä§</h6>
                                    <button class="btn btn-sm btn-outline-light" onclick="refreshInvoiceList()">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                                <div class="card-body p-0" id="voucherInvoicesList" style="max-height: 600px; overflow-y: auto;">
                                    <div class="text-center text-muted p-5">
                                        <i class="fas fa-inbox fa-3x mb-3"></i>
                                        <p class="mb-0">ÏïÑÏßÅ Î∞úÌñâÎêú Ïù∏Î≥¥Ïù¥Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§</p>
                                        <small>ÏúÑÏóêÏÑú Ïù∏Î≥¥Ïù¥Ïä§Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-check me-2"></i>Ìò∏ÌÖî Ïª®ÌéåÎ≤àÌò∏ ÏûÖÎ†•
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="confirmRoomsContainer"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ï∑®ÏÜå</button>
                    <button type="button" class="btn btn-success" onclick="saveConfirmationNumbers()">ÌôïÏ†ï Ï†ÄÏû•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÏàòÎ∞∞ÏÑú ÏÉùÏÑ±/Î≥¥Í∏∞ Î™®Îã¨ -->
    <div class="modal fade" id="assignmentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title" id="assignmentModalTitle">
                        <i class="fas fa-file-contract me-2"></i>Ìò∏ÌÖî ÏàòÎ∞∞ÏÑú ÏûëÏÑ± Î∞è Ï†ÑÏÜ°
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0" style="background: #f5f5f5;">
                    <div class="row g-0 h-100">
                        <!-- ÏôºÏ™Ω: ÏàòÎ∞∞ÏÑú ÎØ∏Î¶¨Î≥¥Í∏∞ (A4 ÏñëÏãù) -->
                        <div class="col-md-8 p-4" style="background: white; overflow-y: auto; max-height: 85vh;">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">üìÑ ÏàòÎ∞∞ÏÑú ÎØ∏Î¶¨Î≥¥Í∏∞</h5>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="printAssignment()" title="Ïù∏ÏáÑ">
                                        <i class="fas fa-print me-1"></i>Ïù∏ÏáÑ
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="downloadAssignmentPDF()" title="PDF Ï†ÄÏû•">
                                        <i class="fas fa-download me-1"></i>PDF Ï†ÄÏû•
                                    </button>
                                </div>
                            </div>
                            <div id="assignmentPreview" style="background: white; padding: 30px; border: 1px solid #ddd; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
                                <!-- A4 ÏàòÎ∞∞ÏÑú ÎÇ¥Ïö©Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                            </div>
                        </div>
                        
                        <!-- Ïò§Î•∏Ï™Ω: Ï†ÑÏÜ° Í¥ÄÎ¶¨ Ìå®ÎÑê -->
                        <div class="col-md-4 p-4" style="background: #f8f9fa; overflow-y: auto; max-height: 85vh;">
                            <h5 class="mb-3">üì® ÏàòÎ∞∞ÏÑú Í¥ÄÎ¶¨</h5>
                            
                            <!-- ÏÉà ÏàòÎ∞∞ÏÑú ÏÉùÏÑ± -->
                            <div class="card mb-3">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-plus-circle me-2"></i>ÏàòÎ∞∞ÏÑú ÏÉùÏÑ±</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label"><strong>Ï†ÑÏÜ° ÌÉÄÏûÖ</strong></label>
                                        <select class="form-select" id="newAssignmentTypeSelect">
                                            <option value="NEW">NEW - Ïã†Í∑ú ÏàòÎ∞∞ÏÑú</option>
                                            <option value="REVISE">REVISE - ÏàòÏ†ï ÏàòÎ∞∞ÏÑú</option>
                                            <option value="CANCEL">CANCEL - Ï∑®ÏÜå ÏàòÎ∞∞ÏÑú</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3" id="newChangesDescriptionGroup" style="display: none;">
                                        <label class="form-label"><strong>Î≥ÄÍ≤Ω/Ï∑®ÏÜå ÏÇ¨Ïú†</strong></label>
                                        <textarea class="form-control" id="newChangesDescriptionInput" rows="2" 
                                                  placeholder="Î≥ÄÍ≤Ω ÎòêÎäî Ï∑®ÏÜå ÏÇ¨Ïú†Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                                    </div>
                                    
                                    <!-- Ï†ÑÏÜ° Î∞©Ïãù ÏÑ†ÌÉù -->
                                    <div class="mb-3">
                                        <label class="form-label">Ï†ÑÏÜ° Î∞©Ïãù</label>
                                        <div class="d-flex flex-column gap-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="deliveryMethod" id="methodCreateOnly" value="create_only" checked onchange="toggleEmailInput()">
                                                <label class="form-check-label" for="methodCreateOnly">
                                                    ÏàòÎ∞∞ÏÑú ÏÉùÏÑ±Îßå (ÎÇòÏ§ëÏóê Ï†ÑÏÜ°)
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="deliveryMethod" id="methodEmail" value="email" onchange="toggleEmailInput()">
                                                <label class="form-check-label" for="methodEmail">
                                                    <i class="fas fa-envelope me-1 text-primary"></i>Ïù¥Î©îÏùº Ï¶âÏãú Ï†ÑÏÜ°
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="deliveryMethod" id="methodLink" value="link" onchange="toggleEmailInput()">
                                                <label class="form-check-label" for="methodLink">
                                                    <i class="fas fa-link me-1 text-info"></i>ÎßÅÌÅ¨ Î≥µÏÇ¨ (ÌÅ¥Î¶ΩÎ≥¥Îìú)
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Ïù¥Î©îÏùº ÏûÖÎ†• (Ï°∞Í±¥Î∂Ä ÌëúÏãú) -->
                                    <div class="mb-3" id="instantEmailGroup" style="display: none;">
                                        <label class="form-label">ÏàòÏã† Ïù¥Î©îÏùº</label>
                                        <input type="email" class="form-control" id="instantRecipientEmail" placeholder="Ìò∏ÌÖî Ïù¥Î©îÏùº Ï£ºÏÜå ÏûÖÎ†•">
                                    </div>
                                    
                                    <button class="btn btn-primary w-100" onclick="createNewAssignment()">
                                        <i class="fas fa-plus-circle me-2"></i>ÏàòÎ∞∞ÏÑú ÏÉùÏÑ± Î∞è Ï≤òÎ¶¨
                                    </button>
                                </div>
                            </div>
                            
                            <!-- ÏÉùÏÑ±Îêú ÏàòÎ∞∞ÏÑú Î™©Î°ù -->
                            <div class="card">
                                <div class="card-header bg-dark text-white">
                                    <h6 class="mb-0"><i class="fas fa-list me-2"></i>ÏÉùÏÑ±Îêú ÏàòÎ∞∞ÏÑú Î™©Î°ù</h6>
                                </div>
                                <div class="card-body p-0" id="assignmentsList" style="max-height: 500px; overflow-y: auto;">
                                    <div class="text-center text-muted p-4">
                                        <i class="fas fa-inbox fa-3x mb-2"></i>
                                        <p class="mb-0 small">ÏïÑÏßÅ ÏÉùÏÑ±Îêú ÏàòÎ∞∞ÏÑúÍ∞Ä ÏóÜÏäµÎãàÎã§</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allReservations = [];
        let currentFilter = 'all';
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú
        document.addEventListener('DOMContentLoaded', function() {
            loadReservations();
            
            // Î™®Îã¨Ïù¥ Îã´Ìûê Îïå ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏
            const editModal = document.getElementById('editReservationModal');
            const voucherModal = document.getElementById('voucherInvoiceModal');
            
            if (editModal) {
                editModal.addEventListener('hidden.bs.modal', function() {
                    console.log('ÏòàÏïΩ ÏàòÏ†ï Î™®Îã¨ Îã´Ìûò - ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏');
                    displayReservations(allReservations);
                });
            }
            
            if (voucherModal) {
                voucherModal.addEventListener('hidden.bs.modal', function() {
                    console.log('Î∞îÏö∞Ï≤ò Î™®Îã¨ Îã´Ìûò - ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏');
                    displayReservations(allReservations);
                });
            }
        });
        
        // ÏòàÏïΩ Î™©Î°ù Î°úÎìú
        async function loadReservations() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            
            try {
                const response = await fetch('/api/hotel-reservations');
                const data = await response.json();
                
                allReservations = data;
                displayReservations(allReservations);
                updateStats(allReservations);
                
            } catch (error) {
                console.error('ÏòàÏïΩ Î™©Î°ù Î°úÎìú Ïò§Î•ò:', error);
                alert('ÏòàÏïΩ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // ÏòàÏïΩ Ïπ¥Îìú ÌëúÏãú
        function displayReservations(reservations) {
            const container = document.getElementById('reservationsContainer');
            
            // Î™®Îã¨Ïù¥ Ïó¥Î†§ÏûàÏúºÎ©¥ ÌÖåÏù¥Î∏î Ïû¨ÏÉùÏÑ± Î∞©ÏßÄ
            const modalOpen = document.querySelector('.modal.show');
            if (modalOpen) {
                console.log('Î™®Îã¨ Ïó¥Î¶º - ÌÖåÏù¥Î∏î Ïû¨ÏÉùÏÑ± Ïä§ÌÇµ');
                return;
            }
            
            // Ï∫îÏä¨ Ï†úÏô∏ (ÌïÑÌÑ∞ÏóêÏÑúÎßå Ï°∞Ìöå)
            const activeReservations = reservations.filter(r => r.status !== 'cancelled');
            
            if (activeReservations.length === 0) {
                container.innerHTML = '';
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            
            document.getElementById('emptyState').style.display = 'none';
            
            // Ï†ïÎ†¨: Ï†ëÏàò/ÏàòÏ†ï ‚Üí ÏàòÎ∞∞Ï§ë/Ïó¥Îûå ‚Üí ÌôïÏ†ï(Ï∂úÎ∞úÏùºÏàú) ‚Üí Î∞îÏö∞Ï≤ò ‚Üí Ï†ïÏÇ∞
            const sorted = [...activeReservations].sort((a, b) => {
                const priority = { 'pending': 1, 'modifying': 1, 'processing': 2, 'confirmed': 3, 'voucher': 4, 'settlement': 5 };
                const aPri = priority[a.status] || 99;
                const bPri = priority[b.status] || 99;
                
                if (aPri !== bPri) return aPri - bPri;
                
                // ÌôïÏ†ï Í∑∏Î£π ÎÇ¥ÏóêÏÑúÎäî Ï∂úÎ∞úÏùº(Ï≤¥ÌÅ¨Ïù∏Ïùº) Í∞ÄÍπåÏö¥ Ïàú
                if (a.status === 'confirmed' && b.status === 'confirmed') {
                    const aDate = new Date(a.check_in_date || '9999-12-31');
                    const bDate = new Date(b.check_in_date || '9999-12-31');
                    return aDate - bDate;
                }
                
                return 0;
            });
            
            container.innerHTML = `
                <table class="reservation-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;">No</th>
                            <th style="width: 80px;">ÏòàÏïΩÏùº</th>
                            <th style="width: 120px;">ÏòàÏïΩÎ≤àÌò∏</th>
                            <th style="width: 80px;">Ï∂úÎ∞úÏùº</th>
                            <th style="width: 90px;">Í±∞ÎûòÏ≤ò</th>
                            <th style="width: 70px;">Îã¥ÎãπÏûê</th>
                            <th style="width: 350px;">ÏßÑÌñâÏÉÅÌÉú</th>
                            <th style="width: 80px;">ÎåÄÌëúÏòàÏïΩÏûê</th>
                            <th style="width: 50px;">ÏßÄÏó≠</th>
                            <th style="min-width: 150px;">Ìò∏ÌÖîÎ™Ö</th>
                            <th style="min-width: 150px;">Î£∏ÌÉÄÏûÖ</th>
                            <th style="width: 90px;">Î∞©Í∞úÏàò/Ïù∏Ïõê</th>
                            <th style="width: 280px;">Ïï°ÏÖò</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sorted.map((res, index) => {
                            // ÏÉÅÌÉúÎ≥Ñ Ìñâ Ïä§ÌÉÄÏùº
                            let rowStyle = '';
                            
                            // ÏµúÍ∑º ÏûëÏóÖÌïú ÏòàÏïΩ Í∞ïÏ°∞ (ÏµúÏö∞ÏÑ†)
                            if (res.id === lastClosedReservationId) {
                                rowStyle = 'background: #d4edda; border-left: 5px solid #28a745; box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);'; // Ï¥àÎ°ùÏÉâ Í∞ïÏ°∞
                            } else if (res.status === 'pending' || res.status === 'modifying') {
                                rowStyle = 'background: #fff3cd; border-left: 4px solid #ffc107;'; // ÎÖ∏ÎûÄÏÉâ Í∞ïÏ°∞
                            } else if (res.status === 'processing') {
                                rowStyle = 'background: #d1ecf1; border-left: 4px solid #17a2b8;'; // Ï≤≠Î°ùÏÉâ Í∞ïÏ°∞
                            }
                            
                            return `
                            <tr data-reservation-id="${res.id}" data-status="${res.status}" style="${rowStyle}">
                                <td>${index + 1}</td>
                                <td>${formatDateShort(res.reservation_date)}</td>
                                <td style="font-weight: 600; color: #2c3e50;">${res.reservation_number}</td>
                                <td>${formatDateShort(res.check_in_date)}</td>
                                <td style="font-size: 0.7rem;">${res.agency_name || '-'}</td>
                                <td>
                                    <span class="badge bg-info" style="font-size: 0.65rem;">${res.assigned_to || 'ÎØ∏Î∞∞Ï†ï'}</span>
                                    ${res.has_memo ? '<br><span class="badge bg-warning mt-1" style="font-size: 0.6rem;"><i class="fas fa-sticky-note"></i></span>' : ''}
                                </td>
                                <td style="padding: 5px; white-space: nowrap;">
                                    ${getProgressBarCompact(res)}
                                </td>
                                <td style="font-size: 0.7rem;">${res.representative_name || '-'}</td>
                                <td><span class="badge bg-secondary" style="font-size: 0.65rem;">${res.region || 'Í¥å'}</span></td>
                                <td style="text-align: left; font-size: 0.7rem;">${res.hotel_name || '-'}</td>
                                <td style="text-align: left; font-size: 0.65rem;">${res.room_types || '-'}</td>
                                <td>
                                    <span class="badge bg-primary" style="font-size: 0.65rem;">${res.total_rooms || 0}Í∞ú</span>
                                    <span class="badge bg-success" style="font-size: 0.65rem;">${res.total_guests || 0}Î™Ö</span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary btn-sm" onclick="editReservation(${res.id})" title="ÏòàÏïΩÎ≥ÄÍ≤Ω">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="createAssignment(${res.id})" title="ÏàòÎ∞∞ÏÑú">
                                            <i class="fas fa-file-alt"></i>
                                        </button>
                                        <button class="btn btn-outline-success btn-sm" onclick="confirmReservation(${res.id})" title="ÌôïÏ†ï">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn btn-outline-info btn-sm" onclick="createVoucher(${res.id})" title="Î∞îÏö∞Ï≤ò">
                                            <i class="fas fa-ticket-alt"></i>
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm" onclick="createSettlement(${res.id})" title="Ï†ïÏÇ∞">
                                            <i class="fas fa-dollar-sign"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateStats(reservations) {
            const pending = reservations.filter(r => r.status === 'pending').length;
            const processing = reservations.filter(r => r.status === 'processing').length;
            const confirmed = reservations.filter(r => r.status === 'confirmed').length;
            
            document.getElementById('stat-pending').textContent = pending;
            document.getElementById('stat-processing').textContent = processing;
            document.getElementById('stat-confirmed').textContent = confirmed;
            document.getElementById('stat-total').textContent = reservations.length;
        }
        
        // ÏÉÅÌÉúÎ≥Ñ ÌïÑÌÑ∞ÎßÅ
        function filterByStatus(status) {
            currentFilter = status;
            
            // ÌïÑÌÑ∞ Î≤ÑÌäº ÌôúÏÑ±Ìôî
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-status="${status}"]`).classList.add('active');
            
            // ÌïÑÌÑ∞ÎßÅ
            filterReservations();
        }
        
        // Í≤ÄÏÉâ Î∞è ÌïÑÌÑ∞
        function filterReservations() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            let filtered = allReservations;
            
            // ÏÉÅÌÉú ÌïÑÌÑ∞
            if (currentFilter !== 'all') {
                filtered = filtered.filter(r => r.status === currentFilter);
            }
            
            // Í∏∞Î≥∏ Í≤ÄÏÉâÏñ¥ ÌïÑÌÑ∞
            if (searchTerm) {
                filtered = filtered.filter(r => {
                    return (r.reservation_number && r.reservation_number.toLowerCase().includes(searchTerm)) ||
                           (r.hotel_name && r.hotel_name.toLowerCase().includes(searchTerm)) ||
                           (r.representative_name && r.representative_name.toLowerCase().includes(searchTerm));
                });
            }
            
            // Í≥†Í∏â ÌïÑÌÑ∞
            const dateType = document.getElementById('dateType')?.value;
            const startDate = document.getElementById('startDate')?.value;
            const endDate = document.getElementById('endDate')?.value;
            const agencyFilter = document.getElementById('agencyFilter')?.value;
            const countryFilter = document.getElementById('countryFilter')?.value;
            const hotelFilter = document.getElementById('hotelFilter')?.value;
            const assignedToFilter = document.getElementById('assignedToFilter')?.value;
            
            if (startDate || endDate) {
                filtered = filtered.filter(r => {
                    const targetDate = dateType === 'reservation' ? r.reservation_date : r.check_in_date;
                    if (startDate && targetDate < startDate) return false;
                    if (endDate && targetDate > endDate) return false;
                    return true;
                });
            }
            
            if (agencyFilter) {
                filtered = filtered.filter(r => r.agency_name === agencyFilter);
            }
            
            if (countryFilter) {
                filtered = filtered.filter(r => (r.region || 'Í¥å') === countryFilter);
            }
            
            if (hotelFilter) {
                filtered = filtered.filter(r => r.hotel_name === hotelFilter);
            }
            
            if (assignedToFilter) {
                filtered = filtered.filter(r => r.assigned_to === assignedToFilter);
            }
            
            displayReservations(filtered);
        }
        
        // ÏÉÅÏÑ∏ ÌïÑÌÑ∞ ÌÜ†Í∏Ä
        function toggleAdvancedFilter() {
            const filterArea = document.getElementById('advancedFilterArea');
            if (filterArea.style.display === 'none') {
                filterArea.style.display = 'block';
                // ÌïÑÌÑ∞ ÏòµÏÖò Î°úÎìú
                loadFilterOptions();
            } else {
                filterArea.style.display = 'none';
            }
        }
        
        // ÌïÑÌÑ∞ ÏòµÏÖò Î°úÎìú
        function loadFilterOptions() {
            // Í±∞ÎûòÏ≤ò Î™©Î°ù
            const agencies = [...new Set(allReservations.map(r => r.agency_name).filter(Boolean))];
            const agencySelect = document.getElementById('agencyFilter');
            agencySelect.innerHTML = '<option value="">Ï†ÑÏ≤¥</option>' +
                agencies.map(a => `<option value="${a}">${a}</option>`).join('');
            
            // Ìò∏ÌÖî Î™©Î°ù
            const hotels = [...new Set(allReservations.map(r => r.hotel_name).filter(Boolean))];
            const hotelSelect = document.getElementById('hotelFilter');
            hotelSelect.innerHTML = '<option value="">Ï†ÑÏ≤¥</option>' +
                hotels.map(h => `<option value="${h}">${h}</option>`).join('');
            
            // Îã¥ÎãπÏûê Î™©Î°ù
            const assignedTos = [...new Set(allReservations.map(r => r.assigned_to).filter(Boolean))];
            const assignedToSelect = document.getElementById('assignedToFilter');
            assignedToSelect.innerHTML = '<option value="">Ï†ÑÏ≤¥</option>' +
                assignedTos.map(a => `<option value="${a}">${a}</option>`).join('');
        }
        
        // ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî
        function resetFilters() {
            document.getElementById('searchBox').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('agencyFilter').value = '';
            document.getElementById('countryFilter').value = '';
            document.getElementById('hotelFilter').value = '';
            document.getElementById('assignedToFilter').value = '';
            filterReservations();
        }
        
        // ÏÉÅÌÉú ÏÉâÏÉÅ
        function getStatusColor(status) {
            const colorMap = {
                'pending': '#ffc107',
                'processing': '#17a2b8',
                'confirmed': '#28a745',
                'cancelled': '#dc3545',
                'modifying': '#6c757d'
            };
            return colorMap[status] || '#6c757d';
        }
        
        // ÏßÑÌñâÎèÑ Î∞î ÏÉùÏÑ± (Ïª¥Ìå©Ìä∏)
        function getProgressBarCompact(res) {
            // 1Îã®Í≥Ñ: Ï†ëÏàò ÏÉÅÌÉú ÏÑ∏Î∂ÑÌôî
            let step1Label = 'Ï†ëÏàò';
            let step1Color = '#17a2b8';
            if (res.status === 'pending') {
                step1Label = 'Ïã†Í∑ú';
                step1Color = '#ffc107'; // ÎÖ∏ÎûÄÏÉâ
            } else if (res.status === 'modifying') {
                step1Label = 'ÏàòÏ†ï';
                step1Color = '#fd7e14'; // Ïò§Î†åÏßÄ
            } else if (res.status === 'cancelled') {
                step1Label = 'Ï∫îÏä¨';
                step1Color = '#dc3545'; // Îπ®Í∞ÑÏÉâ
            }
            
            // 2Îã®Í≥Ñ: ÏàòÎ∞∞Ï§ë/Ïó¥Îûå Íµ¨Î∂Ñ (latest_assignment.viewed_at ÌôïÏù∏)
            let step2Label = 'Ìò∏ÌÖîÏàòÎ∞∞Ï§ë';
            let step2Color = '#17a2b8';
            // ÏÉÅÌÉúÍ∞Ä processingÏù¥Í±∞ÎÇò, latest_assignmentÍ∞Ä ÏûàÏúºÎ©¥ ÏàòÎ∞∞ Îã®Í≥ÑÎ°ú Í∞ÑÏ£º
            if (res.status === 'processing' || res.latest_assignment) {
                if (res.latest_assignment && res.latest_assignment.viewed_at) {
                    step2Label = 'Î©îÏùºÏó¥Îûå';
                    step2Color = '#20c997'; // Î∞ùÏùÄ Ï≤≠Î°ùÏÉâ
                } else {
                    step2Label = 'ÏàòÎ∞∞Ï§ë';
                    step2Color = '#17a2b8';
                }
            }
            
            const steps = [
                { key: 'pending', label: step1Label, color: step1Color },
                { key: 'processing', label: step2Label, color: step2Color },
                { key: 'confirmed', label: 'ÌôïÏ†ï', color: '#28a745' },
                { key: 'voucher', label: 'Î∞îÏö∞Ï≤ò', color: '#6f42c1' },
                { key: 'settlement', label: 'Ï†ïÏÇ∞', color: '#ffc107' }
            ];
            
            const statusOrder = ['pending', 'modifying', 'cancelled', 'processing', 'confirmed', 'voucher', 'settlement'];
            let currentIndex = statusOrder.indexOf(res.status);
            
            // latest_assignmentÍ∞Ä ÏûàÏúºÎ©¥ ÏµúÏÜåÌïú processing Îã®Í≥ÑÎ°ú Í∞ÑÏ£º
            if (res.latest_assignment && currentIndex < statusOrder.indexOf('processing')) {
                currentIndex = statusOrder.indexOf('processing');
            }
            
            return steps.map((step, index) => {
                const stepIndex = statusOrder.indexOf(step.key);
                const isCompleted = stepIndex !== -1 && stepIndex <= currentIndex;
                const isCurrent = (step.key === res.status || 
                                 (res.status === 'modifying' && step.key === 'pending') ||
                                 (res.status === 'cancelled' && step.key === 'pending') ||
                                 (res.latest_assignment && step.key === 'processing' && res.status === 'pending'));
                
                const bgColor = isCompleted || isCurrent ? step.color : '#e9ecef';
                const textColor = isCompleted || isCurrent ? 'white' : '#6c757d';
                const fontWeight = isCurrent ? 'bold' : 'normal';
                
                return `<span class="badge me-1" style="background: ${bgColor}; color: ${textColor}; font-size: 0.6rem; padding: 3px 6px; font-weight: ${fontWeight};">${step.label}</span>`;
            }).join('');
        }
        
        // ÏßÑÌñâÎèÑ Î∞î ÏÉùÏÑ± (Ï†ÑÏ≤¥)
        function getProgressBar(res) {
            const steps = [
                { key: 'pending', label: 'ÎåÄÍ∏∞', icon: 'clock' },
                { key: 'processing', label: 'ÏàòÎ∞∞', icon: 'paper-plane' },
                { key: 'confirmed', label: 'ÌôïÏ†ï', icon: 'check' },
                { key: 'voucher', label: 'Î∞îÏö∞Ï≤ò', icon: 'ticket-alt' },
                { key: 'settlement', label: 'Ï†ïÏÇ∞', icon: 'dollar-sign' }
            ];
            
            const statusOrder = ['pending', 'processing', 'confirmed', 'voucher', 'settlement'];
            const currentIndex = statusOrder.indexOf(res.status);
            
            return `
                <div class="progress-steps d-flex justify-content-between align-items-center" style="position: relative;">
                    ${steps.map((step, index) => {
                        const isCompleted = index <= currentIndex;
                        const isCurrent = index === currentIndex;
                        return `
                            <div class="step-item text-center" style="flex: 1; position: relative; z-index: 1;">
                                <div class="step-circle ${isCompleted ? 'active' : ''} ${isCurrent ? 'current' : ''}" 
                                     style="width: 32px; height: 32px; border-radius: 50%; margin: 0 auto 4px; 
                                            display: flex; align-items: center; justify-content: center; font-size: 0.8rem;
                                            background: ${isCompleted ? '#667eea' : '#e9ecef'}; 
                                            color: ${isCompleted ? 'white' : '#6c757d'};
                                            border: ${isCurrent ? '3px solid #667eea' : 'none'};
                                            box-shadow: ${isCurrent ? '0 0 0 4px rgba(102, 126, 234, 0.2)' : 'none'};">
                                    <i class="fas fa-${step.icon}"></i>
                                </div>
                                <div style="font-size: 0.65rem; color: ${isCompleted ? '#667eea' : '#6c757d'}; font-weight: ${isCurrent ? 'bold' : 'normal'};">
                                    ${step.label}
                                </div>
                            </div>
                            ${index < steps.length - 1 ? `
                                <div style="flex: 1; height: 2px; background: ${index < currentIndex ? '#667eea' : '#e9ecef'}; margin: 0 -5px; position: relative; top: -20px;"></div>
                            ` : ''}
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // ÎÇ†Ïßú Ìè¨Îß∑ (Ï†ÑÏ≤¥)
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // ÎÇ†Ïßú Ìè¨Îß∑ (ÏßßÍ≤å)
        function formatDateShort(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${month}-${day}`;
        }
        
        // ÏÉÅÌÉú ÌÖçÏä§Ìä∏
        function getStatusText(status) {
            const statusMap = {
                'pending': 'ÎåÄÍ∏∞Ï§ë',
                'processing': 'ÏàòÎ∞∞Ï§ë',
                'confirmed': 'ÌôïÏ†ï',
                'cancelled': 'ÏòàÏïΩÏ∑®ÏÜå',
                'modifying': 'ÏàòÏ†ïÏ§ë'
            };
            return statusMap[status] || status;
        }
        
        let currentEditingId = null;
        let lastClosedReservationId = null;
        let allHotels = [];
        let allRoomTypes = [];
        let allAgencies = [];
        let roomCounter = 0;
        let extraCounter = 0;
        let currentPromotion = null;
        let roomPromotions = {};
        let isLoadingData = false;  // ‚≠ê Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë ÌîåÎûòÍ∑∏ (Ï°∞Ïãù Ï§ëÎ≥µ Î∞©ÏßÄ)
        let currentConfirmReservationId = null;
        let currentVoucherReservationId = null;
        
        // ÌäπÏ†ï ÏòàÏïΩ ÌñâÎßå Í∞ïÏ°∞ (ÌÖåÏù¥Î∏î Ï†ÑÏ≤¥ Î¶¨Î°úÎìú ÏóÜÏù¥)
        function highlightReservationRow(reservationId) {
            // DOM ÏïàÏ†ïÌôîÎ•º ÏúÑÌï¥ ÏïΩÍ∞Ñ ÏßÄÏó∞
            setTimeout(() => {
                // Î™®Îì† ÌñâÏùò Í∞ïÏ°∞ Ï†úÍ±∞
                document.querySelectorAll('tr[data-reservation-id]').forEach(row => {
                    const rowId = parseInt(row.dataset.reservationId);
                    const status = row.dataset.status;
                    
                    // Í∏∞Î≥∏ Ïä§ÌÉÄÏùºÎ°ú Î≥µÏõê (Í∞úÎ≥Ñ ÏÜçÏÑ±Îßå Î≥ÄÍ≤Ω)
                    if (status === 'pending' || status === 'modifying') {
                        row.style.background = '#fff3cd';
                        row.style.borderLeft = '4px solid #ffc107';
                        row.style.boxShadow = '';
                    } else if (status === 'processing') {
                        row.style.background = '#d1ecf1';
                        row.style.borderLeft = '4px solid #17a2b8';
                        row.style.boxShadow = '';
                    } else {
                        row.style.background = '';
                        row.style.borderLeft = '';
                        row.style.boxShadow = '';
                    }
                });
                
                // ÏÑ†ÌÉùÎêú ÌñâÎßå Ï¥àÎ°ùÏÉâ Í∞ïÏ°∞
                const targetRow = document.querySelector(`tr[data-reservation-id="${reservationId}"]`);
                if (targetRow) {
                    targetRow.style.background = '#d4edda';
                    targetRow.style.borderLeft = '5px solid #28a745';
                    targetRow.style.boxShadow = '0 0 10px rgba(40, 167, 69, 0.3)';
                }
            }, 100);
        }
        let currentVoucherInvoiceId = null;
        let currentVoucherInvoiceLink = '';
        let currentVoucherAgencyEmail = '';
        let voucherBaseAmountUSD = 0;
        let voucherFxRate = 1300;
        
        // Î™®Îã¨ Ïò§Ìîà Ïãú Ìò∏ÌÖî/Í±∞ÎûòÏ≤ò Î°úÎìú
        document.getElementById('editReservationModal').addEventListener('show.bs.modal', async function() {
            await loadHotels();
            await loadAgencies();
        });
        
        // Ìò∏ÌÖî Î™©Î°ù Î°úÎìú
        async function loadHotels() {
            try {
                const response = await fetch('/api/hotels?is_active=true');
                const hotels = await response.json();
                allHotels = hotels;
                
                const select = document.getElementById('hotel_id');
                select.innerHTML = '<option value="">Ìò∏ÌÖî ÏÑ†ÌÉù</option>' +
                    hotels.map(h => `<option value="${h.id}">${h.hotel_name}</option>`).join('');
            } catch (error) {
                console.error('Ìò∏ÌÖî Î™©Î°ù Î°úÎìú Ïò§Î•ò:', error);
            }
        }
        
        // Í±∞ÎûòÏ≤ò Î™©Î°ù Î°úÎìú
        async function loadAgencies() {
            try {
                const response = await fetch('/api/booking-agencies?is_active=true');
                const agencies = await response.json();
                allAgencies = agencies;
                
                const select = document.getElementById('booking_agency_id');
                select.innerHTML = '<option value="">ÏßÅÏ†ë ÏòàÏïΩ</option>' +
                    agencies.map(a => `<option value="${a.id}">${a.agency_name}</option>`).join('');
            } catch (error) {
                console.error('Í±∞ÎûòÏ≤ò Î™©Î°ù Î°úÎìú Ïò§Î•ò:', error);
            }
        }
        
        // Í∞ùÏã§ ÌÉÄÏûÖ Î°úÎìú
        async function loadRoomTypes() {
            const hotelId = document.getElementById('hotel_id').value;
            if (!hotelId) return;
            
            try {
                const response = await fetch(`/api/room-types?hotel_id=${hotelId}&is_active=true`);
                allRoomTypes = await response.json();
                
                // Î™®Îì† Í∞ùÏã§Ïùò selectÎ•º ÏóÖÎç∞Ïù¥Ìä∏
                document.querySelectorAll('.room-type-select').forEach(select => {
                    select.innerHTML = '<option value="">Í∞ùÏã§ ÌÉÄÏûÖ ÏÑ†ÌÉù</option>' +
                        allRoomTypes.map(rt => `<option value="${rt.id}">${rt.room_type_name}</option>`).join('');
                });
            } catch (error) {
                console.error('Í∞ùÏã§ ÌÉÄÏûÖ Î°úÎìú Ïò§Î•ò:', error);
            }
        }
        
        // Î∞ïÏàò Í≥ÑÏÇ∞
        function calculateNights() {
            const checkIn = document.getElementById('check_in_date').value;
            const checkOut = document.getElementById('check_out_date').value;
            
            if (checkIn && checkOut) {
                const date1 = new Date(checkIn);
                const date2 = new Date(checkOut);
                const diff = Math.ceil((date2 - date1) / (1000 * 60 * 60 * 24));
                
                document.getElementById('nights').value = diff > 0 ? diff : 0;
            }
        }
        
        // Ï°∞Ïãù ÏöîÍ∏à ÎùºÎ≤® ÏóÖÎç∞Ïù¥Ìä∏ (Ìè¨Ìï®/Î∂àÌè¨Ìï® ÎèôÏ†Å ÌëúÏãú)
        function updateBreakfastLabel() {
            const label = document.getElementById('breakfastChargeLabel');
            if (!label) return;
            
            // Î™®Îì† Í∞ùÏã§Ïùò Ï°∞Ïãù Ìè¨Ìï® Ïó¨Î∂Ä ÌôïÏù∏
            let hasBreakfast = false;
            const roomCards = document.querySelectorAll('.room-card');
            roomCards.forEach(card => {
                const roomId = card.dataset.roomId;
                const checkbox = document.getElementById(`breakfast_included_${roomId}`);
                if (checkbox && checkbox.checked) {
                    hasBreakfast = true;
                }
            });
            
            // ÎùºÎ≤® ÌÖçÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            label.textContent = hasBreakfast ? 'Ï°∞Ïãù ÏöîÍ∏à (Ìè¨Ìï®):' : 'Ï°∞Ïãù ÏöîÍ∏à (Î∂àÌè¨Ìï®):';
        }
        
        // Ï†ÑÏ≤¥ Í∏àÏï° Í≥ÑÏÇ∞ (‚≠ê ÏàòÎ∞∞ÌîºÎäî Ï†ÄÏû•Îêú Í∞í ÏÇ¨Ïö© - Ïû¨Í≥ÑÏÇ∞ Ïïà Ìï®)
        async function calculateTotal() {
            // ‚ùì Í±∞ÎûòÏ≤òÍ∞Ä disabledÏù¥ÎØÄÎ°ú ÏàòÎ∞∞Ìîº Ïû¨Í≥ÑÏÇ∞ Ïïà Ìï®
            // const agencyId = document.getElementById('booking_agency_id').value;
            // if (agencyId) {
            //     await calculateAgencyFee();
            // }
            
            const totalRoomCharge = parseFloat(document.getElementById('totalRoomCharge').value) || 0;
            const totalBreakfastCharge = parseFloat(document.getElementById('totalBreakfastCharge').value) || 0;
            const totalExtrasCharge = parseFloat(document.getElementById('totalExtrasCharge').value) || 0;
            const agencyFee = parseFloat(document.getElementById('agencyFee').value) || 0; // ‚≠ê Ï†ÄÏû•Îêú Í∞í Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
            
            // ‚≠ê Ï¥ù ÌåêÎß§Í∞Ä Í≥ÑÏÇ∞ (Ï°∞ÏãùÏöîÍ∏à Ìè¨Ìï®)
            const grandTotal = totalRoomCharge + totalBreakfastCharge + totalExtrasCharge + agencyFee;
            
            document.getElementById('grandTotal').textContent = `$${grandTotal.toFixed(2)}`;
            
            // Ï°∞Ïãù ÎùºÎ≤® ÏóÖÎç∞Ïù¥Ìä∏
            updateBreakfastLabel();
        }
        
        // ÏàòÎ∞∞Ìîº Í≥ÑÏÇ∞
        async function calculateAgencyFee() {
            const agencyId = document.getElementById('booking_agency_id').value;
            if (agencyId) {
                const agency = allAgencies.find(a => a.id == agencyId);
                if (agency) {
                    document.getElementById('agencyFeeRow').style.display = 'flex';
                    document.getElementById('agencyFeeName').textContent = agency.agency_name;
                    
                    // ‚≠ê ÏàòÎ∞∞Ìîº Í∏àÏï° Í≥ÑÏÇ∞
                    const totalRoomCharge = parseFloat(document.getElementById('totalRoomCharge').value) || 0;
                    const totalExtrasCharge = parseFloat(document.getElementById('totalExtrasCharge').value) || 0;
                    const totalAmount = totalRoomCharge + totalExtrasCharge;
                    
                    let agencyFee = 0;
                    
                    // fee_typeÏóê Îî∞Îùº Í≥ÑÏÇ∞
                    if (agency.fee_type === 'percentage') {
                        // ÌçºÏÑºÌä∏ Î∞©Ïãù
                        const feePercent = parseFloat(agency.fee_amount) || 0;
                        agencyFee = totalAmount * (feePercent / 100);
                        console.log(`üí∞ ÏàòÎ∞∞Ìîº Í≥ÑÏÇ∞ (${agency.agency_name}): $${totalAmount} √ó ${feePercent}% = $${agencyFee.toFixed(2)}`);
                    } else {
                        // Ï†ïÏï° Î∞©Ïãù
                        agencyFee = parseFloat(agency.fee_amount) || 0;
                        console.log(`üí∞ ÏàòÎ∞∞Ìîº Í≥ÑÏÇ∞ (${agency.agency_name}): $${agencyFee.toFixed(2)} (Ï†ïÏï°)`);
                    }
                    
                    document.getElementById('agencyFee').value = agencyFee.toFixed(2);
                } else {
                    document.getElementById('agencyFeeRow').style.display = 'none';
                    document.getElementById('agencyFee').value = 0;
                }
            } else {
                document.getElementById('agencyFeeRow').style.display = 'none';
                document.getElementById('agencyFee').value = 0;
            }
            calculateTotal();
        }
        
        // ÌîÑÎ°úÎ™®ÏÖò ÏûêÎèô Ï†ÅÏö©
        async function autoApplyPromotion() {
            const hotelId = document.getElementById('hotel_id').value;
            const checkIn = document.getElementById('check_in_date').value;
            const checkOut = document.getElementById('check_out_date').value;
            
            // ÌïÑÏàò Ï°∞Í±¥ ÌôïÏù∏
            if (!hotelId || !checkIn || !checkOut) {
                return;
            }
            
            // Ï≤´ Î≤àÏß∏ Í∞ùÏã§Ïùò room_type_id Í∞ÄÏ†∏Ïò§Í∏∞
            const firstRoomType = document.querySelector('.room-type-select');
            if (!firstRoomType || !firstRoomType.value) {
                return;
            }
            
            // Î°úÎî© ÌëúÏãú
            document.getElementById('promoLoading').style.display = 'block';
            document.getElementById('promoResult').style.display = 'none';
            document.getElementById('noPromo').style.display = 'none';
            
            // ÌîÑÎ°úÎ™®ÏÖò Ï°∞Ìöå (ÏûêÎèôÏúºÎ°ú Í∞ÄÏû• Ïú†Î¶¨Ìïú ÌîÑÎ°úÎ™®ÏÖò Ï∞æÍ∏∞)
            await findBestPromotion(hotelId, firstRoomType.value, checkIn, checkOut);
        }
        
        // ÏµúÏ†Å ÌîÑÎ°úÎ™®ÏÖò Ï∞æÍ∏∞
        async function findBestPromotion(hotelId, roomTypeId, checkIn, checkOut) {
            try {
                // Î™®Îì† ÌôúÏÑ± ÌîÑÎ°úÎ™®ÏÖò Ï°∞Ìöå
                const response = await fetch('/api/hotel-promotions/list?hotel_id=' + hotelId + '&is_active=true');
                const promotions = await response.json();
                
                if (!promotions || promotions.length === 0) {
                    document.getElementById('promoLoading').style.display = 'none';
                    document.getElementById('noPromo').style.display = 'block';
                    return;
                }
                
                // Í∞Å ÌîÑÎ°úÎ™®ÏÖò ÏöîÍ∏à ÌôïÏù∏ Î∞è ÏµúÏ†ÄÍ∞Ä Ï∞æÍ∏∞
                let bestPromotion = null;
                let lowestRate = Infinity;
                
                for (const promo of promotions) {
                    const rateResponse = await fetch('/api/hotel-promotions/check-and-get-rates', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            promo_code: promo.promo_code,
                            hotel_id: parseInt(hotelId),
                            room_type_id: parseInt(roomTypeId),
                            check_in_date: checkIn,
                            check_out_date: checkOut,
                            booking_date: new Date().toISOString().split('T')[0]
                        })
                    });
                    
                    const result = await rateResponse.json();
                    
                    if (result.valid && result.total_room_rate < lowestRate) {
                        lowestRate = result.total_room_rate;
                        bestPromotion = result;
                    }
                }
                
                document.getElementById('promoLoading').style.display = 'none';
                
                if (bestPromotion) {
                    currentPromotion = bestPromotion;
                    displayPromotionResult(bestPromotion);
                    updateRoomCharges();
                } else {
                    document.getElementById('noPromo').style.display = 'block';
                }
            } catch (error) {
                console.error('ÌîÑÎ°úÎ™®ÏÖò Ï°∞Ìöå Ïò§Î•ò:', error);
                document.getElementById('promoLoading').style.display = 'none';
                document.getElementById('noPromo').style.display = 'block';
            }
        }
        
        // ÌîÑÎ°úÎ™®ÏÖò Í≤∞Í≥º ÌëúÏãú
        function displayPromotionResult(result) {
            const promoResult = document.getElementById('promoResult');
            
            let benefitsHtml = '';
            if (result.benefits && result.benefits.length > 0) {
                benefitsHtml = '<div class="mt-2"><strong>Î≤†ÎÑ§Ìïè:</strong><br>' +
                    result.benefits.map(b => {
                        let text = '';
                        if (b.benefit_type === 'drink_coupon') text = `üçπ ÎìúÎßÅÌÅ¨ Ïø†Ìè∞ ${b.quantity}Îß§`;
                        else if (b.benefit_type === 'late_checkout') text = `üïê Î†àÏù¥Ìä∏ Ï≤¥ÌÅ¨ÏïÑÏõÉ (${b.benefit_value || ''})`;
                        else if (b.benefit_type === 'breakfast') text = `üç≥ Ï°∞Ïãù ${b.quantity}Ïù∏Î∂Ñ`;
                        else if (b.benefit_type === 'credit') text = `üíµ ÌÅ¨Î†àÎîß $${b.benefit_value}`;
                        else text = b.description || b.benefit_name || b.benefit_type;
                        return `<span class="benefit-badge">${text}</span>`;
                    }).join('') +
                    '</div>';
            }
            
            promoResult.innerHTML = `
                <div class="alert alert-success py-2">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle me-2"></i>
                        <div class="flex-fill">
                            <strong>ÌîÑÎ°úÎ™®ÏÖò Ï†ÅÏö© ÏôÑÎ£å!</strong>
                            <span class="promo-badge">${result.promotion.promo_name}</span>
                            <div class="mt-2">
                                <strong>ÌîÑÎ°úÎ™®ÏÖò ÏΩîÎìú:</strong> 
                                <code style="font-size: 1.1em; color: #667eea; background: #f0f4ff; padding: 4px 8px; border-radius: 4px;">${result.promotion.promo_code}</code>
                            </div>
                            <div class="small mt-2">
                                ÏòàÏïΩ Í∏∞Í∞Ñ: ${result.promotion.booking_start_date} ~ ${result.promotion.booking_end_date}<br>
                                Ìà¨Ïàô Í∏∞Í∞Ñ: ${result.promotion.stay_start_date} ~ ${result.promotion.stay_end_date}
                            </div>
                            ${benefitsHtml}
                        </div>
                    </div>
                </div>
                <div class="rate-display mt-2">
                    <h6 class="mb-2"><i class="fas fa-dollar-sign me-1"></i>ÎÇ†ÏßúÎ≥Ñ ÌîÑÎ°úÎ™®ÏÖò ÏöîÍ∏à</h6>
                    ${result.daily_rates.map(r => `
                        <div class="d-flex justify-content-between">
                            <span>${r.stay_date}:</span>
                            <strong>$${r.rate_per_night.toFixed(2)}</strong>
                        </div>
                    `).join('')}
                    <hr>
                    <div class="d-flex justify-content-between">
                        <strong>1Í∞ùÏã§ Ï¥ùÏï°:</strong>
                        <strong class="text-primary fs-5">$${result.total_room_rate.toFixed(2)}</strong>
                    </div>
                </div>
            `;
            
            promoResult.style.display = 'block';
            document.getElementById('noPromo').style.display = 'none';
        }
        
        // Í∞ùÏã§ ÏöîÍ∏à ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏ (Î™®Îì† Í∞ùÏã§Ïùò ÌîÑÎ°úÎ™®ÏÖò Ìï©ÏÇ∞)
        async function updateRoomCharges() {
            let totalRoomCharge = 0;
            let totalBreakfastCharge = 0;
            const appliedPromoCodes = new Set();
            
            // Í∞Å Í∞ùÏã§Ïùò ÌîÑÎ°úÎ™®ÏÖò ÏöîÍ∏à Ìï©ÏÇ∞
            document.querySelectorAll('.room-card').forEach(room => {
                const roomNum = room.dataset.roomId;
                if (roomPromotions[roomNum] && roomPromotions[roomNum].total_room_rate) {
                    // ‚≠ê Î™ÖÏãúÏ†ÅÏúºÎ°ú Ïà´ÏûêÎ°ú Î≥ÄÌôò
                    totalRoomCharge += parseFloat(roomPromotions[roomNum].total_room_rate) || 0;
                    if (roomPromotions[roomNum].promotion && roomPromotions[roomNum].promotion.promo_code) {
                        appliedPromoCodes.add(roomPromotions[roomNum].promotion.promo_code);
                    }
                }
                
                // ‚≠ê Ï°∞Ïãù ÏöîÍ∏à Í≥ÑÏÇ∞ (Ïú†ÏïÑ Ï†úÏô∏)
                const breakfastCheckbox = document.getElementById(`breakfast_included_${roomNum}`);
                if (breakfastCheckbox && breakfastCheckbox.checked) {
                    const days = parseInt(document.getElementById(`breakfast_days_${roomNum}`)?.value) || 1;
                    const adultPrice = parseFloat(document.getElementById(`breakfast_adult_price_${roomNum}`)?.value) || 0;
                    const childPrice = parseFloat(document.getElementById(`breakfast_child_price_${roomNum}`)?.value) || 0;
                    
                    // Ìà¨ÏàôÍ∞ù Ïàò Í≥ÑÏÇ∞ (Ïú†ÏïÑÎäî Ï°∞Ïãù Ï†úÏô∏)
                    let adultCount = 0;
                    let childCount = 0;
                    room.querySelectorAll('.guest-card').forEach(guest => {
                        const ageCategory = guest.querySelector('[data-guest-field="age_category"]')?.value;
                        if (ageCategory === 'adult') adultCount++;
                        else if (ageCategory === 'child') childCount++;
                        // Ïú†ÏïÑ(infant)Îäî Ï°∞Ïãù ÏöîÍ∏à Í≥ÑÏÇ∞ÏóêÏÑú Ï†úÏô∏
                    });
                    
                    const breakfastCharge = (adultCount * adultPrice * days) + (childCount * childPrice * days);
                    totalBreakfastCharge += breakfastCharge;
                    
                    // ‚≠ê Ï°∞Ïãù ÏöîÍ∏à ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
                    const previewDiv = document.getElementById(`breakfast_charge_preview_${roomNum}`);
                    if (previewDiv) {
                        previewDiv.innerHTML = `
                            <strong>üí∞ Ï°∞Ïãù ÏöîÍ∏à:</strong> 
                            <span style="font-size: 1rem;">
                                ÏÑ±Ïù∏${adultCount}Î™Ö√ó$${adultPrice}√ó${days}Ïùº + ÏÜåÏïÑ${childCount}Î™Ö√ó$${childPrice}√ó${days}Ïùº 
                                = <strong style="color: #28a745;">$${breakfastCharge.toFixed(2)}</strong>
                            </span>
                        `;
                    }
                    
                    console.log(`üç≥ Í∞ùÏã§ ${roomNum} Ï°∞ÏãùÏöîÍ∏à: ÏÑ±Ïù∏${adultCount}Î™Ö√ó$${adultPrice}√ó${days}Ïùº + ÏÜåÏïÑ${childCount}Î™Ö√ó$${childPrice}√ó${days}Ïùº = $${breakfastCharge.toFixed(2)}`);
                }
            });
            
            // ÌîÑÎ°úÎ™®ÏÖò ÏΩîÎìú ÌëúÏãú (Ïó¨Îü¨ Í∞ùÏã§)
            const promoResult = document.getElementById('promoResult');
            if (appliedPromoCodes.size > 0) {
                const promoCodesHtml = Array.from(appliedPromoCodes).map(code => 
                    `<code style="font-size: 1.1em; color: #667eea; background: #f0f4ff; padding: 4px 8px; border-radius: 4px; margin-right: 5px;">${code}</code>`
                ).join('');
                promoResult.innerHTML = `
                    <div class="alert alert-success py-2">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>ÌîÑÎ°úÎ™®ÏÖò Ï†ÅÏö© ÏôÑÎ£å!</strong>
                        <div class="mt-2">
                            <strong>Ï†ÅÏö©Îêú ÌîÑÎ°úÎ™®ÏÖò ÏΩîÎìú:</strong> ${promoCodesHtml}
                        </div>
                    </div>
                `;
                promoResult.style.display = 'block';
                document.getElementById('noPromo').style.display = 'none';
            } else {
                promoResult.style.display = 'none';
                document.getElementById('noPromo').style.display = 'block';
            }
            
            document.getElementById('totalRoomCharge').value = totalRoomCharge.toFixed(2);
            document.getElementById('totalBreakfastCharge').value = totalBreakfastCharge.toFixed(2);
            console.log(`üí∞ Ï¥ù Í∞ùÏã§ÏöîÍ∏à: $${totalRoomCharge.toFixed(2)}, Ï¥ù Ï°∞ÏãùÏöîÍ∏à: $${totalBreakfastCharge.toFixed(2)}`);
            
            // await calculateAgencyFee(); // ‚ùì Ï£ºÏÑù Ï≤òÎ¶¨: Í±∞ÎûòÏ≤ò disabled, Ï†ÄÏû•Îêú ÏàòÎ∞∞Ìîº Í∞í Ïú†ÏßÄ
            calculateTotal();
        }
        
        // ÌäπÏ†ï Î£∏ÌÉÄÏûÖÏùò ÏµúÏ†Å ÌîÑÎ°úÎ™®ÏÖò Ï∞æÍ∏∞
        async function findBestPromotionForRoom(hotelId, roomTypeId, checkIn, checkOut) {
            try {
                const response = await fetch('/api/hotel-promotions/list?hotel_id=' + hotelId + '&is_active=true');
                const promotions = await response.json();
                
                if (!promotions || promotions.length === 0) {
                    return null;
                }
                
                let bestPromotion = null;
                let lowestRate = Infinity;
                
                for (const promo of promotions) {
                    const checkResult = await fetch('/api/hotel-promotions/check-and-get-rates', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            promo_code: promo.promo_code,
                            hotel_id: hotelId,
                            room_type_id: roomTypeId,
                            check_in_date: checkIn,
                            check_out_date: checkOut,
                            booking_date: new Date().toISOString().split('T')[0]
                        })
                    });
                    
                    const result = await checkResult.json();
                    
                    if (result.valid && result.total_room_rate < lowestRate) {
                        lowestRate = result.total_room_rate;
                        bestPromotion = result;
                    }
                }
                
                return bestPromotion;
            } catch (error) {
                console.error('ÌîÑÎ°úÎ™®ÏÖò Ï°∞Ìöå Ïò§Î•ò:', error);
                return null;
            }
        }
        
        // Í∞ùÏã§Î≥Ñ Î£∏ÌÉÄÏûÖ Î≥ÄÍ≤Ω Ïãú ÌîÑÎ°úÎ™®ÏÖò Ï°∞Ìöå
        async function onRoomTypeChange(roomNum) {
            const roomTypeSelect = document.querySelector(`[data-room="${roomNum}"]`);
            const roomTypeId = roomTypeSelect.value;
            const hotelId = document.getElementById('hotel_id').value;
            const checkIn = document.getElementById('check_in_date').value;
            const checkOut = document.getElementById('check_out_date').value;
            
            if (!roomTypeId || !hotelId || !checkIn || !checkOut) {
                return;
            }
            
            try {
                // Ìï¥Îãπ Î£∏ÌÉÄÏûÖ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                const roomType = allRoomTypes.find(rt => rt.id == roomTypeId);
                
                // ‚≠ê Ï°∞Ïãù Ï†ïÎ≥¥Î•º Í∞ùÏã§ Ïπ¥ÎìúÏóê ÌëúÏãú (Ï∂îÍ∞Ä Ìï≠Î™© X)
                if (roomType) {
                    displayBreakfastInfo(roomNum, roomType);
                }
                
                // Ìï¥Îãπ Î£∏ÌÉÄÏûÖÏùò ÏµúÏ†Å ÌîÑÎ°úÎ™®ÏÖò Ï∞æÍ∏∞
                const bestPromotion = await findBestPromotionForRoom(hotelId, roomTypeId, checkIn, checkOut);
                
                if (bestPromotion) {
                    roomPromotions[roomNum] = bestPromotion;
                    document.getElementById(`room_${roomNum}_rate`).value = `$${bestPromotion.total_room_rate.toFixed(2)} (ÌîÑÎ°úÎ™®ÏÖò)`;
                    console.log(`‚úÖ Í∞ùÏã§ ${roomNum} ÌîÑÎ°úÎ™®ÏÖò Ï†ÅÏö©:`, bestPromotion.promotion.promo_code);
                } else {
                    roomPromotions[roomNum] = null;
                    document.getElementById(`room_${roomNum}_rate`).value = 'ÌîÑÎ°úÎ™®ÏÖò ÏóÜÏùå';
                }
                
                // Ï†ÑÏ≤¥ Í∞ùÏã§ ÏöîÍ∏à Ìï©ÏÇ∞
                await updateRoomCharges();
            } catch (error) {
                console.error('Î£∏ÌÉÄÏûÖ ÌîÑÎ°úÎ™®ÏÖò Ï°∞Ìöå Ïò§Î•ò:', error);
            }
        }
        
        // ‚≠ê Ï°∞Ïãù Ìè¨Ìï®/Î∂àÌè¨Ìï® ÏÉÅÌÉúÎßå ÌëúÏãú (Îã®ÏàúÌôî)
        function displayBreakfastInfo(roomNum, roomType) {
            if (!roomType) return;
            
            const breakfastIncluded = roomType.breakfast_included || false;
            const breakfastInfoDiv = document.getElementById(`breakfast_info_${roomNum}`);
            const breakfastAlertDiv = document.getElementById(`breakfast_alert_${roomNum}`);
            const breakfastStatusSpan = document.getElementById(`breakfast_status_${roomNum}`);
            
            if (!breakfastInfoDiv || !breakfastAlertDiv || !breakfastStatusSpan) return;
            
            if (breakfastIncluded) {
                // Ï°∞Ïãù Ìè¨Ìï®
                breakfastAlertDiv.className = 'alert alert-success py-2 mb-2';
                breakfastStatusSpan.textContent = 'Ï°∞Ïãù Ìè¨Ìï®';
                breakfastInfoDiv.style.display = 'block';
                console.log(`üç≥ Í∞ùÏã§ ${roomNum}: Ï°∞Ïãù Ìè¨Ìï® ‚úì`);
            } else {
                // Ï°∞Ïãù Î∂àÌè¨Ìï®
                breakfastAlertDiv.className = 'alert alert-secondary py-2 mb-2';
                breakfastStatusSpan.textContent = 'Ï°∞Ïãù Î∂àÌè¨Ìï®';
                breakfastInfoDiv.style.display = 'block';
                console.log(`üç≥ Í∞ùÏã§ ${roomNum}: Ï°∞Ïãù Î∂àÌè¨Ìï®`);
            }
        }
        
        // ‚≠ê Í∏∞Ï°¥ addBreakfastFromRoomType Ìï®Ïàò (Ïù¥Ï†ú ÏÇ¨Ïö© Ïïà Ìï®)
        async function addBreakfastFromRoomType(roomNum, roomType) {
            // Îçî Ïù¥ÏÉÅ Ï∂îÍ∞Ä Ìï≠Î™©Ïóê Ï°∞ÏãùÏùÑ Ï∂îÍ∞ÄÌïòÏßÄ ÏïäÏùå
            console.log(`‚ÑπÔ∏è Ï°∞ÏãùÏùÄ Í∞ùÏã§ Ï†ïÎ≥¥Ïóê ÌëúÏãúÎê©ÎãàÎã§ (Ï∂îÍ∞Ä Ìï≠Î™© X)`);
            return;
            
            /* Í∏∞Ï°¥ Î°úÏßÅ Ï£ºÏÑù Ï≤òÎ¶¨
            if (!roomType) return;
            
            const breakfastIncluded = roomType.breakfast_included || false;
            const breakfastRateAdult = parseFloat(roomType.breakfast_rate_adult) || 0;
            const breakfastRateChild = parseFloat(roomType.breakfast_rate_child) || 0;
            
            // ‚≠ê Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ëÏóêÎäî Ï°∞Ïãù ÏûêÎèô Ï∂îÍ∞Ä Ïïà Ìï® (Ï§ëÎ≥µ Î∞©ÏßÄ)
            if (isLoadingData) {
                console.log(`üö´ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ëÏù¥ÎØÄÎ°ú Ï°∞Ïãù ÏûêÎèô Ï∂îÍ∞Ä Í±¥ÎÑàÎúÄ`);
                return;
            }
            */
            
            // Ìï¥Îãπ Í∞ùÏã§Ïùò Ìà¨ÏàôÍ∞ù Ïàò ÌôïÏù∏
            const guestsContainer = document.getElementById(`guests_${roomNum}`);
            if (!guestsContainer) return;
            
            const guestCards = guestsContainer.querySelectorAll('.guest-card');
            
            let adultCount = 0;
            let childCount = 0;
            
            guestCards.forEach(card => {
                const ageCategory = card.querySelector('[data-guest-field="age_category"]')?.value || 'adult';
                if (ageCategory === 'adult') adultCount++;
                else if (ageCategory === 'child') childCount++;
            });
            
            // Í∏∞Ï°¥ Ï°∞Ïãù Ìï≠Î™© Ï†úÍ±∞ (Ï§ëÎ≥µ Î∞©ÏßÄ)
            const existingBreakfast = document.querySelector(`[data-breakfast-room="${roomNum}"]`);
            if (existingBreakfast) {
                existingBreakfast.remove();
            }
            
            // Ï°∞Ïãù Ìè¨Ìï®/Î∂àÌè¨Ìï® Ìï≠Î™© Ï∂îÍ∞Ä
            extraCounter++;
            const extraId = `extra_${extraCounter}`;
            
            let itemName, quantity, unitPrice, notes;
            
            if (breakfastIncluded) {
                // Ï°∞Ïãù Ìè¨Ìï®
                itemName = 'Ï°∞Ïãù (Ìè¨Ìï®)';
                quantity = adultCount + childCount;
                unitPrice = 0;
                notes = `Í∞ùÏã§ ${roomNum} - Ï°∞Ïãù Ìè¨Ìï®`;
            } else {
                // Ï°∞Ïãù Î∂àÌè¨Ìï®
                itemName = 'Ï°∞Ïãù (Î∂àÌè¨Ìï® - Ï∂îÍ∞Ä Ïãú Î≥ÑÎèÑ ÏöîÍ∏à)';
                quantity = 0;
                unitPrice = breakfastRateAdult;
                notes = `Í∞ùÏã§ ${roomNum} - ÏÑ±Ïù∏: $${breakfastRateAdult}, ÏÜåÏïÑ: $${breakfastRateChild}`;
            }
            
            const extraHtml = `
                <div class="extra-item-card" id="${extraId}" data-breakfast-room="${roomNum}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong><i class="fas fa-utensils me-2"></i>Ï∂îÍ∞Ä Ìï≠Î™© ${extraCounter}</strong>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeExtra('${extraId}')">
                            <i class="fas fa-times"></i> ÏÇ≠Ï†ú
                        </button>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="form-label">Ìï≠Î™©Î™Ö</label>
                            <input type="text" class="form-control form-control-sm" value="${itemName}" data-extra-field="item_name" data-extra="${extraCounter}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ÏàòÎüâ</label>
                            <input type="number" class="form-control form-control-sm" value="${quantity}" data-extra-field="quantity" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Îã®Í∞Ä (USD)</label>
                            <input type="number" step="0.01" class="form-control form-control-sm" value="${unitPrice}" data-extra-field="unit_price" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ÏÜåÍ≥Ñ (USD)</label>
                            <input type="text" class="form-control form-control-sm bg-light" readonly value="${(quantity * unitPrice).toFixed(2)}" id="extra_${extraCounter}_subtotal">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">ÎπÑÍ≥†</label>
                            <input type="text" class="form-control form-control-sm" value="${notes}" data-extra-field="notes" data-extra="${extraCounter}">
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('extrasContainer').insertAdjacentHTML('beforeend', extraHtml);
            
            // ÏûêÎèô Ï∂îÍ∞ÄÎêú Ï°∞ÏãùÏùò ÏÜåÍ≥Ñ Í≥ÑÏÇ∞ (Ï†ïÏï° ÏöîÍ∏àÏù¥ÎØÄÎ°ú flat ÌÉÄÏûÖ)
            setTimeout(() => {
                const totalField = document.getElementById(`extra_${extraCounter}_subtotal`);
                if (totalField) {
                    totalField.value = (quantity * unitPrice).toFixed(2);
                }
                
                // Ï†ÑÏ≤¥ Ï∂îÍ∞Ä Ìï≠Î™© Ìï©Í≥Ñ Ïû¨Í≥ÑÏÇ∞
                let totalExtras = 0;
                document.querySelectorAll('.extra-item-card').forEach(extra => {
                    const subtotalField = extra.querySelector('[id$="_subtotal"]');
                    if (subtotalField && subtotalField.value) {
                        totalExtras += parseFloat(subtotalField.value) || 0;
                    }
                });
                document.getElementById('totalExtrasCharge').value = totalExtras.toFixed(2);
                calculateTotal();
            }, 100);
        }
        
        // Í∞ùÏã§ Ï∂îÍ∞Ä
        function addRoom() {
            roomCounter++;
            const roomId = `room_${roomCounter}`;
            
            const roomHtml = `
                <div class="room-card" id="${roomId}" data-room-id="${roomCounter}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">
                            <i class="fas fa-bed me-2"></i>Í∞ùÏã§ ${roomCounter}
                            <small class="text-success ms-2" id="room_${roomCounter}_cfn_label" style="font-size: 0.75rem;"></small>
                        </h6>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeRoom('${roomId}')">
                            <i class="fas fa-trash"></i> ÏÇ≠Ï†ú
                        </button>
                    </div>
                    
                    <div class="d-flex align-items-center gap-1 mb-2">
                        <label class="form-label mb-0" style="min-width: 70px;">Í∞ùÏã§ÌÉÄÏûÖ*</label>
                        <select class="form-control form-control-sm room-type-select" data-room="${roomCounter}" onchange="onRoomTypeChange(${roomCounter})" style="flex: 1;">
                            <option value="">Í∞ùÏã§ ÌÉÄÏûÖ ÏÑ†ÌÉù</option>
                        </select>
                        <label class="form-label mb-0 ms-1" style="min-width: 95px;">Ï¥ù Í∞ùÏã§ÏöîÍ∏à(ÏûêÎèô)</label>
                        <input type="text" class="form-control form-control-sm" id="room_${roomCounter}_rate" readonly style="background: #f0f0f0; flex: 1;">
                    </div>
                    
                    <!-- ‚≠ê Ï°∞Ïãù Ï†ïÎ≥¥ ÏÑπÏÖò (ÏàòÏ†ï Í∞ÄÎä•) -->
                    <div class="border rounded p-2 mb-3" style="background: #f8f9fa;">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="breakfast_included_${roomCounter}" onchange="toggleBreakfastFields(${roomCounter})">
                            <label class="form-check-label fw-bold" for="breakfast_included_${roomCounter}">
                                <i class="fas fa-utensils me-1"></i>Ï°∞Ïãù Ìè¨Ìï®
                            </label>
                        </div>
                        <div id="breakfast_fields_${roomCounter}" style="display: none;">
                            <!-- ‚≠ê Ìà¨Ïàô Ïù∏Ïõê ÌëúÏãú -->
                            <div id="breakfast_guest_count_${roomCounter}" class="alert alert-info py-2 px-3 mb-2" style="font-size: 0.85rem;">
                                <i class="fas fa-users me-1"></i>
                                <strong>Ìà¨Ïàô Ïù∏Ïõê:</strong>
                                <span class="ms-2">
                                    ÏÑ±Ïù∏ <strong id="breakfast_adult_count_${roomCounter}">0</strong>Î™Ö / 
                                    ÏÜåÏïÑ <strong id="breakfast_child_count_${roomCounter}">0</strong>Î™Ö / 
                                    Ïú†ÏïÑ <strong id="breakfast_infant_count_${roomCounter}">0</strong>Î™Ö
                                </span>
                            </div>
                            
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label small">ÌöüÏàò(Ïùº)</label>
                                    <input type="number" class="form-control form-control-sm" id="breakfast_days_${roomCounter}" value="1" min="1" onchange="updateRoomCharges()">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">ÏÑ±Ïù∏ Îã®Í∞Ä ($)</label>
                                    <input type="number" class="form-control form-control-sm" id="breakfast_adult_price_${roomCounter}" value="0" step="0.01" min="0" onchange="updateRoomCharges()">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">ÏÜåÏïÑ Îã®Í∞Ä ($)</label>
                                    <input type="number" class="form-control form-control-sm" id="breakfast_child_price_${roomCounter}" value="0" step="0.01" min="0" onchange="updateRoomCharges()">
                                </div>
                            </div>
                            
                            <!-- ‚≠ê Ï°∞Ïãù ÏöîÍ∏à ÎØ∏Î¶¨Î≥¥Í∏∞ -->
                            <div id="breakfast_charge_preview_${roomCounter}" class="mt-2 text-end" style="font-size: 0.85rem; color: #28a745;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <strong class="d-block mb-2"><i class="fas fa-users me-2"></i>Ìà¨ÏàôÍ∞ù Ï†ïÎ≥¥</strong>
                        <div id="guests_${roomCounter}">
                            ${createGuestHtml(roomCounter, 1, true)}
                        </div>
                        <button type="button" class="btn btn-sm btn-add-guest mt-2" onclick="addGuest(${roomCounter})">
                            <i class="fas fa-user-plus me-1"></i>ÎèôÎ∞ò Ìà¨ÏàôÍ∞ù Ï∂îÍ∞Ä
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('roomsContainer').insertAdjacentHTML('beforeend', roomHtml);
            
            // Í∞ùÏã§ ÌÉÄÏûÖ ÏòµÏÖò Ï±ÑÏö∞Í∏∞
            if (allRoomTypes.length > 0) {
                const select = document.querySelector(`#${roomId} .room-type-select`);
                select.innerHTML = '<option value="">Í∞ùÏã§ ÌÉÄÏûÖ ÏÑ†ÌÉù</option>' +
                    allRoomTypes.map(rt => `<option value="${rt.id}">${rt.room_type_name}</option>`).join('');
            }
        }
        
        // ‚≠ê Í∞ùÏã§Î≥Ñ Ìà¨Ïàô Ïù∏Ïõê Ïàò ÏóÖÎç∞Ïù¥Ìä∏
        function updateGuestCount(roomNum) {
            const roomCard = document.querySelector(`[data-room-id="${roomNum}"]`);
            if (!roomCard) return;
            
            let adultCount = 0;
            let childCount = 0;
            let infantCount = 0;
            
            roomCard.querySelectorAll('.guest-card').forEach(guest => {
                const ageCategory = guest.querySelector('[data-guest-field="age_category"]')?.value;
                if (ageCategory === 'adult') adultCount++;
                else if (ageCategory === 'child') childCount++;
                else if (ageCategory === 'infant') infantCount++;
            });
            
            // Ï°∞Ïãù ÌïÑÎìúÏùò Ïù∏Ïõê Ïàò ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
            const adultCountEl = document.getElementById(`breakfast_adult_count_${roomNum}`);
            const childCountEl = document.getElementById(`breakfast_child_count_${roomNum}`);
            const infantCountEl = document.getElementById(`breakfast_infant_count_${roomNum}`);
            
            if (adultCountEl) adultCountEl.textContent = adultCount;
            if (childCountEl) childCountEl.textContent = childCount;
            if (infantCountEl) infantCountEl.textContent = infantCount;
            
            // Ï°∞Ïãù ÏöîÍ∏à Ïû¨Í≥ÑÏÇ∞
            updateRoomCharges();
        }

        // Ìà¨ÏàôÍ∞ù HTML ÏÉùÏÑ± (Ìïú Ï§ÑÎ°ú Î≥ÄÍ≤Ω)
        function createGuestHtml(roomNum, guestNum, isPrimary = false) {
            return `
                <div class="guest-card" id="guest_${roomNum}_${guestNum}" style="padding: 0.5rem; margin-bottom: 0.5rem;">
                    <div class="d-flex align-items-center gap-1">
                        <strong style="min-width: 90px; font-size: 0.7rem;">${isPrimary ? 'ÎåÄÌëú Ìà¨ÏàôÍ∞ù' : 'ÎèôÎ∞òÌà¨ÏàôÍ∞ù' + guestNum}</strong>
                        <input type="text" class="form-control form-control-sm" placeholder="ÌïúÍ∏ÄÎ™Ö" data-guest-field="guest_name_ko" data-room="${roomNum}" data-guest="${guestNum}" style="flex: 1;">
                        <span style="font-size: 0.7rem;">|</span>
                        <input type="text" class="form-control form-control-sm" placeholder="ÏòÅÎ¨∏Î™Ö" data-guest-field="guest_name_en" data-room="${roomNum}" data-guest="${guestNum}" style="flex: 1;">
                        <span style="font-size: 0.7rem;">|</span>
                        <select class="form-control form-control-sm" data-guest-field="age_category" data-room="${roomNum}" data-guest="${guestNum}" style="width: 70px;" onchange="updateGuestCount(${roomNum})">
                            <option value="adult">ÏÑ±Ïù∏</option>
                            <option value="child">ÏÜåÏïÑ</option>
                            <option value="infant">Ïú†ÏïÑ</option>
                        </select>
                        <span style="font-size: 0.7rem;">|</span>
                        <input type="date" class="form-control form-control-sm" placeholder="ÏÉùÎÖÑÏõîÏùº" data-guest-field="date_of_birth" data-room="${roomNum}" data-guest="${guestNum}" style="width: 130px;">
                        ${isPrimary ? `
                        <span style="font-size: 0.7rem;">|</span>
                        <input type="tel" class="form-control form-control-sm" placeholder="Ï†ÑÌôîÎ≤àÌò∏" data-guest-field="phone" data-room="${roomNum}" data-guest="${guestNum}" style="width: 120px;">
                        <span style="font-size: 0.7rem;">|</span>
                        <input type="email" class="form-control form-control-sm" placeholder="Ïù¥Î©îÏùº" data-guest-field="email" data-room="${roomNum}" data-guest="${guestNum}" style="flex: 1;">
                        ` : ''}
                        ${!isPrimary ? `<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeGuest(${roomNum}, ${guestNum})" style="padding: 0.2rem 0.5rem;"><i class="fas fa-times"></i></button>` : ''}
                    </div>
                </div>
            `;
        }
        
        // Ìà¨ÏàôÍ∞ù Ï∂îÍ∞Ä
        function addGuest(roomNum) {
            const guestsContainer = document.getElementById(`guests_${roomNum}`);
            const guestCount = guestsContainer.querySelectorAll('.guest-card').length + 1;
            
            guestsContainer.insertAdjacentHTML('beforeend', createGuestHtml(roomNum, guestCount, false));
            
            // ‚≠ê Ïù∏Ïõê Ïàò ÏóÖÎç∞Ïù¥Ìä∏
            updateGuestCount(roomNum);
        }
        
        // Ìà¨ÏàôÍ∞ù Ï†úÍ±∞
        function removeGuest(roomNum, guestNum) {
            const guestCard = document.getElementById(`guest_${roomNum}_${guestNum}`);
            if (guestCard) {
                guestCard.remove();
                // ‚≠ê Ïù∏Ïõê Ïàò ÏóÖÎç∞Ïù¥Ìä∏
                updateGuestCount(roomNum);
            }
        }
        
        // ==================== Ï°∞Ïãù Í¥ÄÎ†® Ìï®Ïàò ====================
        
        // Ï°∞Ïãù ÌïÑÎìú ÌÜ†Í∏Ä (Ï≤¥ÌÅ¨Î∞ïÏä§ Î≥ÄÍ≤Ω Ïãú)
        function toggleBreakfastFields(roomNum) {
            const checkbox = document.getElementById(`breakfast_included_${roomNum}`);
            const fieldsDiv = document.getElementById(`breakfast_fields_${roomNum}`);
            const label = document.querySelector(`label[for="breakfast_included_${roomNum}"]`);
            const daysInput = document.getElementById(`breakfast_days_${roomNum}`);
            const adultPriceInput = document.getElementById(`breakfast_adult_price_${roomNum}`);
            const childPriceInput = document.getElementById(`breakfast_child_price_${roomNum}`);
            
            if (checkbox.checked) {
                fieldsDiv.style.display = 'block';
                
                // ‚≠ê Î†àÏù¥Î∏î ÌÖçÏä§Ìä∏ Î≥ÄÍ≤Ω
                if (label) {
                    label.innerHTML = '<i class="fas fa-utensils me-1"></i>Ï°∞Ïãù Ìè¨Ìï®';
                }
                
                // ‚≠ê Ï¥ù ÏöîÍ∏à ÏÑπÏÖòÏùò Ï°∞Ïãù ÎùºÎ≤®ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                updateBreakfastLabel();
                
                // Ï°∞Ïãù Ìè¨Ìï®ÏúºÎ°ú Î≥ÄÍ≤Ω Ïãú: Î∞ïÏàòÏôÄ Í∞ùÏã§ ÌÉÄÏûÖÏùò Ï°∞Ïãù ÏöîÍ∏à ÏûêÎèô Î°úÎìú
                const nights = parseInt(document.getElementById('nights')?.textContent) || 1;
                daysInput.value = nights;
                
                // Í∞ùÏã§ ÌÉÄÏûÖÏùò Ï°∞Ïãù ÏöîÍ∏à Í∞ÄÏ†∏Ïò§Í∏∞
                const roomSelect = document.querySelector(`[data-room="${roomNum}"]`);
                if (roomSelect && roomSelect.value) {
                    const roomType = allRoomTypes.find(rt => rt.id == roomSelect.value);
                    if (roomType && (parseFloat(adultPriceInput.value) === 0 || parseFloat(childPriceInput.value) === 0)) {
                        adultPriceInput.value = parseFloat(roomType.breakfast_adult_price || 0).toFixed(2);
                        childPriceInput.value = parseFloat(roomType.breakfast_child_price || 0).toFixed(2);
                        console.log(`‚úÖ Í∞ùÏã§ ${roomNum} Ï°∞Ïãù ÏöîÍ∏à ÏûêÎèô Î°úÎìú: ÏÑ±Ïù∏=$${roomType.breakfast_adult_price}, ÏÜåÏïÑ=$${roomType.breakfast_child_price}`);
                    }
                }
            } else {
                fieldsDiv.style.display = 'none';
                
                // ‚≠ê Î†àÏù¥Î∏î ÌÖçÏä§Ìä∏ Î≥ÄÍ≤Ω
                if (label) {
                    label.innerHTML = '<i class="fas fa-utensils me-1"></i>Ï°∞Ïãù Î∂àÌè¨Ìï®';
                }
                
                // ‚≠ê Ï¥ù ÏöîÍ∏à ÏÑπÏÖòÏùò Ï°∞Ïãù ÎùºÎ≤®ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                updateBreakfastLabel();
            }
            
            // ‚≠ê Ï°∞Ïãù ÏöîÍ∏à Ïû¨Í≥ÑÏÇ∞
            updateRoomCharges();
        }
        
        // Í∞ùÏã§ ÌÉÄÏûÖ Î≥ÄÍ≤Ω Ïãú Ï°∞Ïãù Ï†ïÎ≥¥ ÌëúÏãú
        function displayBreakfastInfo(roomNum, roomType) {
            const checkbox = document.getElementById(`breakfast_included_${roomNum}`);
            const daysInput = document.getElementById(`breakfast_days_${roomNum}`);
            const adultPriceInput = document.getElementById(`breakfast_adult_price_${roomNum}`);
            const childPriceInput = document.getElementById(`breakfast_child_price_${roomNum}`);
            const fieldsDiv = document.getElementById(`breakfast_fields_${roomNum}`);
            const label = document.querySelector(`label[for="breakfast_included_${roomNum}"]`);
            
            if (!roomType) return;
            
            // Ï°∞Ïãù Ìè¨Ìï® Ïó¨Î∂Ä ÌôïÏù∏
            const breakfastIncluded = roomType.breakfast_included === true || roomType.breakfast_included === 'true';
            
            if (breakfastIncluded) {
                // Ï°∞Ïãù Ìè¨Ìï® ‚Üí Ï≤¥ÌÅ¨Î∞ïÏä§ Ï≤¥ÌÅ¨, Î∞ïÏàòÏôÄ ÏöîÍ∏à ÏûêÎèô ÏÑ§Ï†ï
                checkbox.checked = true;
                fieldsDiv.style.display = 'block';
                
                // ‚≠ê Î†àÏù¥Î∏î ÌÖçÏä§Ìä∏ Î≥ÄÍ≤Ω
                if (label) {
                    label.innerHTML = '<i class="fas fa-utensils me-1"></i>Ï°∞Ïãù Ìè¨Ìï®';
                }
                
                const nights = parseInt(document.getElementById('nights')?.textContent) || 1;
                daysInput.value = nights;
                adultPriceInput.value = parseFloat(roomType.breakfast_adult_price || 0).toFixed(2);
                childPriceInput.value = parseFloat(roomType.breakfast_child_price || 0).toFixed(2);
                
                console.log(`‚úÖ Í∞ùÏã§ ${roomNum} Ï°∞Ïãù ÏûêÎèô ÏÑ§Ï†ï: Ìè¨Ìï®, ${nights}Ïùº, ÏÑ±Ïù∏=$${roomType.breakfast_adult_price}, ÏÜåÏïÑ=$${roomType.breakfast_child_price}`);
            } else {
                // Ï°∞Ïãù Î∂àÌè¨Ìï® ‚Üí Ï≤¥ÌÅ¨Î∞ïÏä§ Ìï¥Ï†ú
                checkbox.checked = false;
                fieldsDiv.style.display = 'none';
                
                // ‚≠ê Î†àÏù¥Î∏î ÌÖçÏä§Ìä∏ Î≥ÄÍ≤Ω
                if (label) {
                    label.innerHTML = '<i class="fas fa-utensils me-1"></i>Ï°∞Ïãù Î∂àÌè¨Ìï®';
                }
                
                // ÌïòÏßÄÎßå ÏöîÍ∏àÏùÄ ÎØ∏Î¶¨ Ï±ÑÏõåÎëêÍ∏∞ (ÎÇòÏ§ëÏóê Ï≤¥ÌÅ¨Ìï† Îïå ÏÇ¨Ïö©)
                const nights = parseInt(document.getElementById('nights')?.textContent) || 1;
                daysInput.value = nights;
                adultPriceInput.value = parseFloat(roomType.breakfast_adult_price || 0).toFixed(2);
                childPriceInput.value = parseFloat(roomType.breakfast_child_price || 0).toFixed(2);
                
                console.log(`‚ÑπÔ∏è  Í∞ùÏã§ ${roomNum} Ï°∞Ïãù: Î∂àÌè¨Ìï® (ÏöîÍ∏àÏùÄ ÎØ∏Î¶¨ ÏÑ§Ï†ïÎê®)`);
            }
            
            // ‚≠ê Ìà¨Ïàô Ïù∏Ïõê Ïàò ÏóÖÎç∞Ïù¥Ìä∏
            updateGuestCount(roomNum);
        }
        
        // Í∞ùÏã§ Ï†úÍ±∞
        function removeRoom(roomId) {
            if (confirm('Ïù¥ Í∞ùÏã§ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                document.getElementById(roomId).remove();
                calculateTotal();
            }
        }
        
        // Ï∂îÍ∞Ä Ìï≠Î™© Ï∂îÍ∞Ä
        function addExtraItem() {
            extraCounter++;
            const extraId = `extra_${extraCounter}`;
            
            const extraHtml = `
                <div class="extra-item-card" id="${extraId}">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Ï∂îÍ∞Ä Ìï≠Î™© ${extraCounter}</h6>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeExtra('${extraId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label small">Ìï≠Î™©Î™Ö *</label>
                            <input type="text" class="form-control" placeholder="Ïòà: Í≥µÌï≠ÌîΩÏóÖ, ÍΩÉÎ∞îÍµ¨Îãà" data-extra-field="item_name" data-extra="${extraCounter}" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">ÏàòÎüâ</label>
                            <input type="number" class="form-control" value="1" min="1" data-extra-field="quantity" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Ïú†Ìòï</label>
                            <select class="form-control" data-extra-field="pricing_type" data-extra="${extraCounter}" onchange="toggleExtraPricing(${extraCounter})">
                                <option value="per_person">Ïù∏ÏõêÎ≥Ñ ÏöîÍ∏à</option>
                                <option value="flat">Ï†ïÏï° ÏöîÍ∏à</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row g-2 mt-1">
                        <div class="col-md-4">
                            <label class="form-label small">Ïù∏/ÏïÑÏõÉ Ìò∏ÌÖî</label>
                            <select class="form-control" data-extra-field="in_hotel" data-extra="${extraCounter}">
                                <option value="in" selected>Ïù∏Ìò∏ÌÖî (Ìò∏ÌÖî Ï≤≠Íµ¨)</option>
                                <option value="out">ÏïÑÏõÉÌò∏ÌÖî (Ìò∏ÌÖî Ï≤≠Íµ¨ ÏïÑÎãò)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row g-2 mt-2" id="perPersonPricing_${extraCounter}">
                        <div class="col-md-3">
                            <label class="form-label small">ÏÑ±Ïù∏ Ïàò</label>
                            <input type="number" class="form-control" value="0" min="0" data-extra-field="adult_count" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">ÏÑ±Ïù∏ Îã®Í∞Ä ($)</label>
                            <input type="number" class="form-control" value="0" step="0.01" data-extra-field="adult_price" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">ÏÜåÏïÑ Ïàò</label>
                            <input type="number" class="form-control" value="0" min="0" data-extra-field="child_count" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">ÏÜåÏïÑ Îã®Í∞Ä ($)</label>
                            <input type="number" class="form-control" value="0" step="0.01" data-extra-field="child_price" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Ïú†ÏïÑ Ïàò</label>
                            <input type="number" class="form-control" value="0" min="0" data-extra-field="infant_count" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Ïú†ÏïÑ Îã®Í∞Ä ($)</label>
                            <input type="number" class="form-control" value="0" step="0.01" data-extra-field="infant_price" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                    </div>
                    
                    <div class="row g-2 mt-2" id="flatPricing_${extraCounter}" style="display:none;">
                        <div class="col-md-6">
                            <label class="form-label small">Îã®Í∞Ä ($)</label>
                            <input type="number" class="form-control" value="0" step="0.01" data-extra-field="unit_price" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                    </div>
                    
                    <div class="row g-2 mt-2">
                        <div class="col-md-12">
                            <label class="form-label small">ÏÜåÍ≥Ñ</label>
                            <input type="text" class="form-control fw-bold" id="extra_${extraCounter}_total" readonly style="background: #e7f3ff; color: #2196F3;">
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('extrasContainer').insertAdjacentHTML('beforeend', extraHtml);
        }
        
        // Ï∂îÍ∞Ä Ìï≠Î™© Í∞ÄÍ≤© Ïú†Ìòï Ï†ÑÌôò
        function toggleExtraPricing(extraNum) {
            const type = document.querySelector(`[data-extra-field="pricing_type"][data-extra="${extraNum}"]`).value;
            
            if (type === 'per_person') {
                document.getElementById(`perPersonPricing_${extraNum}`).style.display = 'flex';
                document.getElementById(`flatPricing_${extraNum}`).style.display = 'none';
            } else {
                document.getElementById(`perPersonPricing_${extraNum}`).style.display = 'none';
                document.getElementById(`flatPricing_${extraNum}`).style.display = 'flex';
            }
            
            calculateExtraTotal(extraNum);
        }
        
        // Ï∂îÍ∞Ä Ìï≠Î™© ÏÜåÍ≥Ñ Í≥ÑÏÇ∞
        function calculateExtraTotal(extraNum) {
            const type = document.querySelector(`[data-extra-field="pricing_type"][data-extra="${extraNum}"]`).value;
            const quantity = parseInt(document.querySelector(`[data-extra-field="quantity"][data-extra="${extraNum}"]`).value) || 1;
            
            let total = 0;
            
            if (type === 'per_person') {
                const adultCount = parseInt(document.querySelector(`[data-extra-field="adult_count"][data-extra="${extraNum}"]`).value) || 0;
                const adultPrice = parseFloat(document.querySelector(`[data-extra-field="adult_price"][data-extra="${extraNum}"]`).value) || 0;
                const childCount = parseInt(document.querySelector(`[data-extra-field="child_count"][data-extra="${extraNum}"]`).value) || 0;
                const childPrice = parseFloat(document.querySelector(`[data-extra-field="child_price"][data-extra="${extraNum}"]`).value) || 0;
                const infantCount = parseInt(document.querySelector(`[data-extra-field="infant_count"][data-extra="${extraNum}"]`).value) || 0;
                const infantPrice = parseFloat(document.querySelector(`[data-extra-field="infant_price"][data-extra="${extraNum}"]`).value) || 0;
                
                total = (adultCount * adultPrice + childCount * childPrice + infantCount * infantPrice) * quantity;
            } else {
                const unitPrice = parseFloat(document.querySelector(`[data-extra-field="unit_price"][data-extra="${extraNum}"]`).value) || 0;
                total = unitPrice * quantity;
            }
            
            document.getElementById(`extra_${extraNum}_total`).value = `$${total.toFixed(2)}`;
            
            // Î™®Îì† Ï∂îÍ∞Ä Ìï≠Î™© Ìï©Í≥Ñ Í≥ÑÏÇ∞
            let totalExtras = 0;
            document.querySelectorAll('.extra-item-card').forEach(extra => {
                const totalInput = extra.querySelector('[id$="_total"]');
                if (totalInput && totalInput.value) {
                    const amount = parseFloat(totalInput.value.replace('$', '')) || 0;
                    totalExtras += amount;
                }
            });
            document.getElementById('totalExtrasCharge').value = totalExtras.toFixed(2);
            
            calculateTotal();
        }
        
        // Ï∂îÍ∞Ä Ìï≠Î™© Ï†úÍ±∞
        function removeExtra(extraId) {
            if (confirm('Ïù¥ Ìï≠Î™©ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                document.getElementById(extraId).remove();
                
                // Ìï©Í≥Ñ Ïû¨Í≥ÑÏÇ∞
                let totalExtras = 0;
                document.querySelectorAll('.extra-item-card').forEach(extra => {
                    const totalInput = extra.querySelector('[id$="_total"]');
                    if (totalInput && totalInput.value) {
                        const amount = parseFloat(totalInput.value.replace('$', '')) || 0;
                        totalExtras += amount;
                    }
                });
                document.getElementById('totalExtrasCharge').value = totalExtras.toFixed(2);
                calculateTotal();
                calculateTotal();
            }
        }
        
        // ÏòàÏïΩ Î≥ÄÍ≤Ω - Î™®Îã¨Î°ú Ïò§Ìîà
        async function editReservation(reservationId) {
            currentEditingId = reservationId;
            lastClosedReservationId = reservationId;
            highlightReservationRow(reservationId); // Ìï¥Îãπ ÌñâÎßå Í∞ïÏ°∞
            
            // Î®ºÏ†Ä Î™®Îã¨ Ïò§Ìîà
            const modal = new bootstrap.Modal(document.getElementById('editReservationModal'));
            modal.show();
            
            try {
                // ÏòàÏïΩ ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const response = await fetch(`/api/hotel-reservations/${reservationId}`);
                const data = await response.json();
                
                console.log('üì• Î°úÎìúÎêú ÏòàÏïΩ Îç∞Ïù¥ÌÑ∞:', data);
                
                // Î™®Îã¨Ïù¥ ÏôÑÏ†ÑÌûà Ïó¥Î¶∞ ÌõÑÏóê Îç∞Ïù¥ÌÑ∞ Ï±ÑÏö∞Í∏∞
                setTimeout(async () => {
                    // ‚≠ê Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÏûë
                    isLoadingData = true;
                    
                    // Ï¥àÍ∏∞Ìôî
                    roomCounter = 0;
                    extraCounter = 0;
                    document.getElementById('roomsContainer').innerHTML = '';
                    document.getElementById('extrasContainer').innerHTML = '';
                    
                    // ÎÇ†Ïßú Ìè¨Îß∑ Î≥ÄÌôò Ìï®Ïàò (ISO ‚Üí YYYY-MM-DD)
                    function formatDateForInput(dateStr) {
                        if (!dateStr) return '';
                        try {
                            const date = new Date(dateStr);
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            return `${year}-${month}-${day}`;
                        } catch (e) {
                            return dateStr;
                        }
                    }
                    
                    // Í∏∞Î≥∏ Ï†ïÎ≥¥ Ï±ÑÏö∞Í∏∞
                    document.getElementById('reservation_number').value = data.reservation_number || '';
                    document.getElementById('status').value = data.status || 'pending';
                    document.getElementById('reservation_date').value = formatDateForInput(data.reservation_date);
                    document.getElementById('check_in_date').value = formatDateForInput(data.check_in_date);
                    document.getElementById('check_out_date').value = formatDateForInput(data.check_out_date);
                    document.getElementById('arrival_flight').value = data.arrival_flight || '';
                    document.getElementById('departure_flight').value = data.departure_flight || '';
                    document.getElementById('special_requests').value = data.special_requests || '';
                    document.getElementById('internal_memo').value = data.internal_memo || '';
                    document.getElementById('totalRoomCharge').value = data.total_room_rate || 0;
                    document.getElementById('totalBreakfastCharge').value = data.total_breakfast_charge || 0;
                    document.getElementById('totalExtrasCharge').value = data.total_extras_rate || 0;
                    document.getElementById('agencyFee').value = data.agency_fee || 0;
                    
                    // ÏàòÎ∞∞Ìîº ÌëúÏãú
                    if (data.agency_fee && data.agency_fee > 0) {
                        document.getElementById('agencyFeeRow').style.display = 'flex';
                    }
                    
                    console.log('‚úÖ Í∏∞Î≥∏ Ï†ïÎ≥¥ Ï±ÑÏõÄ (Ï¥ù Í∞ùÏã§: $' + (data.total_room_rate || 0) + ', Ï¥ù Ï°∞Ïãù: $' + (data.total_breakfast_charge || 0) + ', Ï¥ù Ï∂îÍ∞Ä: $' + (data.total_extras_rate || 0) + ', ÏàòÎ∞∞Ìîº: $' + (data.agency_fee || 0) + ')');
                    
                    // ‚≠ê Ï¥àÍ∏∞ Ï¥ùÏï° Í≥ÑÏÇ∞
                    calculateTotal();
                    
                    // Ìò∏ÌÖî ÏÑ†ÌÉù (‚≠ê Î≥ÄÍ≤Ω Î∂àÍ∞Ä - disabled ÏÑ§Ï†ï)
                    if (data.hotel_id) {
                        const hotelSelect = document.getElementById('hotel_id');
                        hotelSelect.value = data.hotel_id;
                        hotelSelect.disabled = true; // ‚≠ê Î≥ÄÍ≤Ω Î∂àÍ∞Ä
                        await loadRoomTypes();
                        console.log('‚úÖ Ìò∏ÌÖî ÏÑ†ÌÉù (Í≥†Ï†ï):', data.hotel_id);
                    }
                    
                    // Í±∞ÎûòÏ≤ò ÏÑ†ÌÉù (‚≠ê Î≥ÄÍ≤Ω Î∂àÍ∞Ä - disabled ÏÑ§Ï†ï, ÏàòÎ∞∞ÌîºÎäî Ïù¥ÎØ∏ Î°úÎìúÎê®)
                    if (data.booking_agency_id) {
                        const agencySelect = document.getElementById('booking_agency_id');
                        agencySelect.value = data.booking_agency_id;
                        agencySelect.disabled = true; // ‚≠ê Î≥ÄÍ≤Ω Î∂àÍ∞Ä
                        // calculateAgencyFee(); // ‚ùì Ï£ºÏÑù Ï≤òÎ¶¨: Ï†ÄÏû•Îêú ÏàòÎ∞∞Ìîº Í∞í Ïú†ÏßÄ
                        
                        // Í±∞ÎûòÏ≤ò Ïù¥Î¶Ñ ÌëúÏãúÎßå ÏóÖÎç∞Ïù¥Ìä∏
                        const agency = allAgencies.find(a => a.id == data.booking_agency_id);
                        if (agency && data.agency_fee && data.agency_fee > 0) {
                            document.getElementById('agencyFeeName').textContent = agency.agency_name;
                        }
                        
                        console.log('‚úÖ Í±∞ÎûòÏ≤ò ÏÑ†ÌÉù (Í≥†Ï†ï):', data.booking_agency_id, 'ÏàòÎ∞∞Ìîº: $' + (data.agency_fee || 0));
                    }
                    
                    // Î∞ïÏàò Í≥ÑÏÇ∞
                    calculateNights();
                    
                    // ÌîÑÎ°úÎ™®ÏÖò Ï†ïÎ≥¥ ÌëúÏãú
                    if (data.promotion_code) {
                        document.getElementById('noPromo').style.display = 'none';
                        document.getElementById('promoResult').style.display = 'block';
                        document.getElementById('promoResult').innerHTML = `
                            <div class="alert alert-success py-2">
                                <strong>üìå ÌîÑÎ°úÎ™®ÏÖò ÏΩîÎìú:</strong> ${data.promotion_code}
                                ${data.rate_condition_id ? `<br><small>Rate Condition ID: ${data.rate_condition_id}</small>` : ''}
                            </div>
                        `;
                        console.log('‚úÖ ÌîÑÎ°úÎ™®ÏÖò ÌëúÏãú:', data.promotion_code);
                    } else {
                        document.getElementById('noPromo').style.display = 'block';
                        document.getElementById('promoResult').style.display = 'none';
                    }
                    
                    // Í∞ùÏã§ Î∞è Ìà¨ÏàôÍ∞ù Ï†ïÎ≥¥ Ï∂îÍ∞Ä
                    if (data.rooms && data.rooms.length > 0) {
                        console.log('üì¶ Í∞ùÏã§ Ïàò:', data.rooms.length);
                        for (let i = 0; i < data.rooms.length; i++) {
                            const room = data.rooms[i];
                            addRoom();
                            
                            // ‚≠ê ÌÅ¥Î°úÏ†Ä Î≤ÑÍ∑∏ ÏàòÏ†ï: roomCounter ÌòÑÏû¨ Í∞íÏùÑ Ï¶âÏãú Ï∫°Ï≤ò
                            const currentRoomNum = roomCounter;
                            
                            // ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ Í∞ùÏã§ Ï†ïÎ≥¥ Ï±ÑÏö∞Í∏∞
                            setTimeout(async () => {
                                console.log(`üè® Í∞ùÏã§ ${currentRoomNum} Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÏûë (room_type_id: ${room.room_type_id})`);
                                
                                // Í∞ùÏã§ ÌÉÄÏûÖ ÏÑ†ÌÉù
                                const roomSelect = document.querySelector(`[data-room="${currentRoomNum}"]`);
                                if (roomSelect && room.room_type_id) {
                                    roomSelect.value = room.room_type_id;
                                    console.log(`‚úÖ Í∞ùÏã§ ${currentRoomNum} ÌÉÄÏûÖ ÏÑ†ÌÉù:`, room.room_type_id);
                                }
                                
                                // Í∞ùÏã§ ÏöîÍ∏à ÌëúÏãú
                                const rateInput = document.getElementById(`room_${currentRoomNum}_rate`);
                                if (rateInput && room.total_selling_price) {
                                    rateInput.value = `$${parseFloat(room.total_selling_price).toFixed(2)}`;
                                }
                                const cfnLabel = document.getElementById(`room_${currentRoomNum}_cfn_label`);
                                if (cfnLabel) {
                                    cfnLabel.textContent = room.confirmation_number ? `CFN - #${room.confirmation_number}` : '';
                                }

                                // Ìà¨ÏàôÍ∞ù Ï†ïÎ≥¥ Ï±ÑÏö∞Í∏∞
                                if (room.guests && room.guests.length > 0) {
                                    console.log(`  üë• Í∞ùÏã§ ${currentRoomNum} Ìà¨ÏàôÍ∞ù Ïàò:`, room.guests.length);
                                    room.guests.forEach((guest, guestIdx) => {
                                        if (guestIdx > 0) {
                                            addGuest(currentRoomNum);
                                        }
                                        
                                        setTimeout(() => {
                                            const guestCard = document.getElementById(`guest_${currentRoomNum}_${guestIdx + 1}`);
                                            if (guestCard) {
                                                const fields = guestCard.querySelectorAll('[data-guest-field]');
                                                fields.forEach(field => {
                                                    const fieldName = field.dataset.guestField;
                                                    let value = guest[fieldName] !== undefined && guest[fieldName] !== null ? guest[fieldName] : '';
                                                    
                                                    // ‚≠ê date_of_birthÎäî ISO ‚Üí YYYY-MM-DD Î≥ÄÌôò ÌïÑÏàò!
                                                    if (fieldName === 'date_of_birth' && value) {
                                                        value = formatDateForInput(value);
                                                    }
                                                    
                                                    field.value = value;
                                                });
                                                console.log(`  ‚úÖ Í∞ùÏã§ ${currentRoomNum} Ìà¨ÏàôÍ∞ù ${guestIdx + 1} Ï†ïÎ≥¥ Ï±ÑÏõÄ (Ïù¥Î¶Ñ: ${guest.guest_name_ko}, ÏÉùÎÖÑÏõîÏùº: ${formatDateForInput(guest.date_of_birth)})`);
                                            }
                                        }, 100 * guestIdx);
                                    });
                                }
                                
                                // ‚≠ê Ï°∞Ïãù Ï†ïÎ≥¥ ÌëúÏãú (Ï†ÄÏû•Îêú Í∞í ÎòêÎäî Í∞ùÏã§ ÌÉÄÏûÖ Í∏∞Î≥∏Í∞í)
                                setTimeout(() => {
                                    if (room.breakfast_included !== undefined && room.breakfast_included !== null) {
                                        // Ï†ÄÏû•Îêú Ï°∞Ïãù Ï†ïÎ≥¥Í∞Ä ÏûàÏúºÎ©¥ Í∑∏ÎåÄÎ°ú ÌëúÏãú
                                        console.log(`üç≥ Í∞ùÏã§ ${currentRoomNum} Ï†ÄÏû•Îêú Ï°∞Ïãù Î°úÎìú:`, room.breakfast_included, room.breakfast_days, room.breakfast_adult_price, room.breakfast_child_price);
                                        
                                        const breakfastCheckbox = document.getElementById(`breakfast_included_${currentRoomNum}`);
                                        const breakfastDays = document.getElementById(`breakfast_days_${currentRoomNum}`);
                                        const breakfastAdultPrice = document.getElementById(`breakfast_adult_price_${currentRoomNum}`);
                                        const breakfastChildPrice = document.getElementById(`breakfast_child_price_${currentRoomNum}`);
                                        const breakfastFields = document.getElementById(`breakfast_fields_${currentRoomNum}`);
                                        const breakfastLabel = document.querySelector(`label[for="breakfast_included_${currentRoomNum}"]`);
                                        
                                        // ‚≠ê Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÑ§Ï†ï
                                        if (breakfastCheckbox) breakfastCheckbox.checked = room.breakfast_included;
                                        
                                        // ‚≠ê ÌïÑÎìú Í∞í ÏÑ§Ï†ï (ÎçúÏñ¥Ïì∞Í∏∞ Î∞©ÏßÄ)
                                        if (breakfastDays) breakfastDays.value = room.breakfast_days || 1;
                                        if (breakfastAdultPrice) breakfastAdultPrice.value = parseFloat(room.breakfast_adult_price || 0).toFixed(2);
                                        if (breakfastChildPrice) breakfastChildPrice.value = parseFloat(room.breakfast_child_price || 0).toFixed(2);
                                        
                                        // ‚≠ê ÌïÑÎìú ÌëúÏãú Î∞è Î†àÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏ (Í∞í Î≥ÄÍ≤Ω ÏóÜÏùå)
                                        if (breakfastFields) {
                                            breakfastFields.style.display = room.breakfast_included ? 'block' : 'none';
                                        }
                                        if (breakfastLabel) {
                                            breakfastLabel.innerHTML = room.breakfast_included 
                                                ? '<i class="fas fa-utensils me-1"></i>Ï°∞Ïãù Ìè¨Ìï®'
                                                : '<i class="fas fa-utensils me-1"></i>Ï°∞Ïãù Î∂àÌè¨Ìï®';
                                        }
                                        
                                        console.log(`  ‚Üí ÌöåÏàò: ${room.breakfast_days}Ïùº, ÏÑ±Ïù∏: $${room.breakfast_adult_price}, ÏÜåÏïÑ: $${room.breakfast_child_price}`);
                                    } else {
                                        // Ï†ÄÏû•Îêú Ï†ïÎ≥¥Í∞Ä ÏóÜÏúºÎ©¥ Í∞ùÏã§ ÌÉÄÏûÖ Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©
                                        if (room.room_type_id) {
                                            const roomType = allRoomTypes.find(rt => rt.id == room.room_type_id);
                                            if (roomType) {
                                                displayBreakfastInfo(currentRoomNum, roomType);
                                            }
                                        }
                                    }
                                }, 150);
                                
                                // ‚≠ê ÌîÑÎ°úÎ™®ÏÖò Ï†ïÎ≥¥ ÌëúÏãú (ÏÉàÎ°ú Ï°∞ÌöåÌïòÏßÄ ÏïäÍ≥† Ï†ÄÏû•Îêú Ï†ïÎ≥¥ ÌëúÏãú)
                                if (room.promotion_code) {
                                    // roomPromotionsÏóê Ï†ÄÏû•
                                    roomPromotions[currentRoomNum] = {
                                        promotion: { promo_code: room.promotion_code },
                                        rate_condition_id: room.rate_condition_id,
                                        total_room_rate: room.total_selling_price
                                    };
                                    
                                    // ÌîÑÎ°úÎ™®ÏÖò Ï†ïÎ≥¥ UIÏóê ÏßÅÏ†ë ÌëúÏãú
                                    setTimeout(() => {
                                        const roomCard = document.querySelector(`[data-room-id="${currentRoomNum}"]`);
                                        if (roomCard) {
                                            // ÌîÑÎ°úÎ™®ÏÖò ÌëúÏãú ÏòÅÏó≠ Ï∞æÍ∏∞ ÎòêÎäî ÏÉùÏÑ±
                                            let promoDisplayArea = roomCard.querySelector('.room-promo-display');
                                            if (!promoDisplayArea) {
                                                const roomTypeSelect = roomCard.querySelector(`[data-room="${currentRoomNum}"]`)?.parentElement;
                                                if (roomTypeSelect) {
                                                    promoDisplayArea = document.createElement('div');
                                                    promoDisplayArea.className = 'room-promo-display mt-2';
                                                    roomTypeSelect.after(promoDisplayArea);
                                                }
                                            }
                                            
                                            if (promoDisplayArea) {
                                                promoDisplayArea.innerHTML = `
                                                    <div class="alert alert-info py-2 mb-2">
                                                        <i class="fas fa-tag me-2"></i>
                                                        <strong>ÌîÑÎ°úÎ™®ÏÖò:</strong> <code class="bg-light px-2 py-1">${room.promotion_code}</code>
                                                        ${room.rate_condition_id ? `<br><small class="text-muted">Rate ID: ${room.rate_condition_id}</small>` : ''}
                                                        <br><small class="text-muted">Í∞ùÏã§ ÏöîÍ∏à: <strong>$${parseFloat(room.total_selling_price).toFixed(2)}</strong></small>
                                                    </div>
                                                `;
                                                console.log(`üìå Í∞ùÏã§ ${currentRoomNum} ÌîÑÎ°úÎ™®ÏÖò ÌëúÏãú: ${room.promotion_code} ($${room.total_selling_price})`);
                                            }
                                        }
                                    }, 200);
                                }
                            }, 100 * i);
                        }
                    } else {
                        addRoom();
                    }
                    
                    // Ï∂îÍ∞Ä Ìï≠Î™© Î°úÎìú
                    setTimeout(() => {
                        let totalExtras = 0;
                        let displayedExtras = 0;  // ‚≠ê Ïã§Ï†ú ÌëúÏãúÎêú Ìï≠Î™© Ïàò
                        
                        if (data.extras && data.extras.length > 0) {
                            console.log('üéÅ Ï∂îÍ∞Ä Ìï≠Î™© Ïàò:', data.extras.length);
                            data.extras.forEach((extra, idx) => {
                                // ‚≠ê Ï°∞ÏãùÏùÄ Í∞ùÏã§ Ï†ïÎ≥¥Ïóê ÌëúÏãúÎêòÎØÄÎ°ú Ï∂îÍ∞Ä Ìï≠Î™©ÏóêÏÑú Ï†úÏô∏
                                if (extra.item_name && extra.item_name.includes('Ï°∞Ïãù')) {
                                    console.log(`‚è≠Ô∏è Ï°∞Ïãù Ìï≠Î™© Í±¥ÎÑàÎúÄ: ${extra.item_name} (Í∞ùÏã§ Ï†ïÎ≥¥Ïóê ÌëúÏãúÎê®)`);
                                    return;
                                }
                                
                                displayedExtras++;
                                addExtraItem();
                                
                                // ‚≠ê ÌÅ¥Î°úÏ†Ä Î≤ÑÍ∑∏ ÏàòÏ†ï: extraCounter ÌòÑÏû¨ Í∞íÏùÑ Ï¶âÏãú Ï∫°Ï≤ò
                                const currentExtraNum = extraCounter;
                                
                                setTimeout(() => {
                                    console.log(`üìù Ï∂îÍ∞ÄÌï≠Î™© ${currentExtraNum} Î°úÎìú ÏãúÏûë:`, extra.item_name);
                                    const extraCard = document.getElementById(`extra_${currentExtraNum}`);
                                    if (extraCard) {
                                        const itemNameInput = extraCard.querySelector('[data-extra-field="item_name"]');
                                        const quantityInput = extraCard.querySelector('[data-extra-field="quantity"]');
                                        const pricingTypeInput = extraCard.querySelector('[data-extra-field="pricing_type"]');
                                        const inHotelSelect = extraCard.querySelector('[data-extra-field="in_hotel"]');
                                        
                                        if (itemNameInput) itemNameInput.value = extra.item_name || '';
                                        if (quantityInput) quantityInput.value = extra.quantity || 1;
                                        // Ïù∏/ÏïÑÏõÉ Ìò∏ÌÖî ÏÑ§Ï†ï (notes Ïª¨Îüº Í∏∞Î∞ò, Í∏∞Î≥∏Í∞íÏùÄ IN_HOTEL)
                                        const scope = (extra.notes || 'IN_HOTEL');
                                        if (inHotelSelect) {
                                            inHotelSelect.value = scope === 'OUT_HOTEL' ? 'out' : 'in';
                                        }
                                        
                                        // ‚≠ê pricing_type ÏÑ§Ï†ï ÌõÑ Ï¶âÏãú UI Ï†ÑÌôò
                                        const actualPricingType = extra.item_type || extra.pricing_type || 'flat';
                                        if (pricingTypeInput) pricingTypeInput.value = actualPricingType;
                                        toggleExtraPricing(currentExtraNum);  // ‚≠ê UI Î®ºÏ†Ä Ï†ÑÌôò!
                                        
                                        console.log(`  ‚Üí Ìï≠Î™©Î™Ö: ${extra.item_name}, ÏàòÎüâ: ${extra.quantity}, Ïú†Ìòï: ${actualPricingType}`);
                                        
                                        // pricing_typeÏóê Îî∞Îùº ÌïÑÎìú Ï±ÑÏö∞Í∏∞
                                        if (actualPricingType === 'per_person') {
                                            // Ïù∏ÏõêÎ≥Ñ ÏöîÍ∏à
                                            const adultCountInput = extraCard.querySelector('[data-extra-field="adult_count"]');
                                            const adultPriceInput = extraCard.querySelector('[data-extra-field="adult_price"]');
                                            const childCountInput = extraCard.querySelector('[data-extra-field="child_count"]');
                                            const childPriceInput = extraCard.querySelector('[data-extra-field="child_price"]');
                                            const infantCountInput = extraCard.querySelector('[data-extra-field="infant_count"]');
                                            const infantPriceInput = extraCard.querySelector('[data-extra-field="infant_price"]');
                                            
                                            if (adultCountInput) adultCountInput.value = extra.adult_count || 0;
                                            if (adultPriceInput) adultPriceInput.value = extra.adult_price || 0;
                                            if (childCountInput) childCountInput.value = extra.child_count || 0;
                                            if (childPriceInput) childPriceInput.value = extra.child_price || 0;
                                            if (infantCountInput) infantCountInput.value = extra.infant_count || 0;
                                            if (infantPriceInput) infantPriceInput.value = extra.infant_price || 0;
                                            
                                            console.log(`  ‚Üí Ïù∏ÏõêÎ≥Ñ: ÏÑ±Ïù∏ ${extra.adult_count}Î™Ö√ó$${extra.adult_price}, ÏÜåÏïÑ ${extra.child_count}Î™Ö√ó$${extra.child_price}`);
                                        } else {
                                            // Ï†ïÏï° ÏöîÍ∏à
                                            const unitPriceInput = extraCard.querySelector('[data-extra-field="unit_price"]');
                                            if (unitPriceInput) unitPriceInput.value = extra.unit_price || 0;
                                            
                                            console.log(`  ‚Üí Ï†ïÏï°: $${extra.unit_price}`);
                                        }
                                        
                                        // ‚≠ê ÏÜåÍ≥Ñ Í≥ÑÏÇ∞ (Ïù¥ÎØ∏ toggleExtraPricing Ìò∏Ï∂úÌï®)
                                        calculateExtraTotal(currentExtraNum);
                                        
                                        console.log(`  ‚úÖ Ï∂îÍ∞ÄÌï≠Î™© ${idx + 1} ÏôÑÎ£å`);
                                    } else {
                                        console.error(`‚ùå Ï∂îÍ∞ÄÌï≠Î™© Ïπ¥Îìú Ï∞æÏùÑ Ïàò ÏóÜÏùå: extra_${currentExtraNum}`);
                                    }
                                }, 100 * idx);
                            });
                            
                            // ‚≠ê displayedExtras Í∏∞Î∞òÏúºÎ°ú ÌÉÄÏù¥Î∞ç Ï°∞Ï†ï
                            const delayTime = displayedExtras > 0 ? (100 * displayedExtras + 100) : 200;
                            
                            setTimeout(() => {
                                if (displayedExtras === 0) {
                                    console.log('‚ÑπÔ∏è ÌëúÏãúÌï† Ï∂îÍ∞Ä Ìï≠Î™© ÏóÜÏùå (Ï°∞Ïãù Ìï≠Î™©ÏùÄ Í∞ùÏã§ Ï†ïÎ≥¥Ïóê Ìè¨Ìï®)');
                                } else {
                                    console.log(`‚úÖ Ï∂îÍ∞Ä Ìï≠Î™© ${displayedExtras}Í∞ú Î°úÎìú ÏôÑÎ£å`);
                                }
                                
                                // ‚≠ê Ï°∞Ïãù ÏöîÍ∏à Ïû¨Í≥ÑÏÇ∞ (Í∞ùÏã§Î≥Ñ Ï°∞Ïãù Ï†ïÎ≥¥ Î°úÎìú ÏôÑÎ£å ÌõÑ)
                                updateRoomCharges();
                                
                                // ‚≠ê Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å - Ïù¥Ï†ú ÌîÑÎ°úÎ™®ÏÖò Ï°∞Ìöå Í∞ÄÎä•
                                isLoadingData = false;
                                console.log('‚úÖ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å - ÌîÑÎ°úÎ™®ÏÖò Ï°∞Ìöå ÌôúÏÑ±Ìôî');
                            }, delayTime);
                        } else {
                            // Ï∂îÍ∞Ä Ìï≠Î™©Ïù¥ ÏóÜÎäî Í≤ΩÏö∞ÎèÑ Ï°∞Ïãù ÏöîÍ∏à Í≥ÑÏÇ∞
                            setTimeout(() => {
                                updateRoomCharges();
                                isLoadingData = false;
                                console.log('‚úÖ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å (Ï∂îÍ∞Ä Ìï≠Î™© ÏóÜÏùå)');
                            }, 200);
                        }
                    }, 500);
                    
                }, 300);
                
            } catch (error) {
                console.error('‚ùå ÏòàÏïΩ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
                alert('ÏòàÏïΩ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        // ÏàòÏ†ïÏÇ¨Ìï≠ Ï†ÄÏû•
        async function saveReservationChanges() {
            if (!currentEditingId) {
                alert('Ï†ÄÏû•Ìï† ÏòàÏïΩÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            // Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏàòÏßë
            const hotelId = document.getElementById('hotel_id').value;
            const bookingAgencyId = document.getElementById('booking_agency_id').value;
            
            if (!hotelId) {
                alert('Ìò∏ÌÖîÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            // Í∞ùÏã§ Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
            const rooms = [];
            document.querySelectorAll('.room-card').forEach(roomCard => {
                const roomNum = roomCard.dataset.roomId;
                const roomTypeSelect = roomCard.querySelector(`[data-room="${roomNum}"]`);
                const roomTypeId = roomTypeSelect?.value;
                
                if (!roomTypeId) return;
                
                // Ìà¨ÏàôÍ∞ù Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
                const guests = [];
                const guestCards = roomCard.querySelectorAll('.guest-card');
                guestCards.forEach(guestCard => {
                    const guestData = {};
                    const fields = guestCard.querySelectorAll('[data-guest-field]');
                    fields.forEach(field => {
                        const fieldName = field.dataset.guestField;
                        // ‚≠ê Îπà Î¨∏ÏûêÏó¥ÏùÄ nullÎ°ú Î≥ÄÌôò (ÌäπÌûà date_of_birth)
                        const value = field.value?.trim();
                        guestData[fieldName] = value && value !== '' ? value : null;
                    });
                    
                    // ÏµúÏÜåÌïú Ïù¥Î¶ÑÏù¥ ÏûàÏñ¥Ïïº Ï∂îÍ∞Ä
                    if (guestData.guest_name_ko || guestData.guest_name_en) {
                        console.log(`  ‚Üí Ìà¨ÏàôÍ∞ù Ï†ÄÏû•:`, guestData.guest_name_ko, `ÏÉùÎÖÑÏõîÏùº: ${guestData.date_of_birth}`);
                        guests.push(guestData);
                    }
                });
                
                // ÌîÑÎ°úÎ™®ÏÖò Ï†ïÎ≥¥
                const roomPromo = roomPromotions[roomNum];
                
                // ‚≠ê Ï°∞Ïãù Ï†ïÎ≥¥ ÏàòÏßë
                const breakfastIncluded = document.getElementById(`breakfast_included_${roomNum}`)?.checked || false;
                const breakfastDays = parseInt(document.getElementById(`breakfast_days_${roomNum}`)?.value) || 1;
                const breakfastAdultPrice = parseFloat(document.getElementById(`breakfast_adult_price_${roomNum}`)?.value) || 0;
                const breakfastChildPrice = parseFloat(document.getElementById(`breakfast_child_price_${roomNum}`)?.value) || 0;
                
                rooms.push({
                    room_type_id: parseInt(roomTypeId),
                    guests: guests,
                    promotion_code: roomPromo?.promotion?.promo_code || null,
                    rate_condition_id: roomPromo?.rate_condition_id || null,
                    total_selling_price: roomPromo?.total_room_rate || 0,
                    // ‚≠ê Ï°∞Ïãù Ï†ïÎ≥¥ Ï∂îÍ∞Ä
                    breakfast_included: breakfastIncluded,
                    breakfast_days: breakfastIncluded ? breakfastDays : 0,
                    breakfast_adult_price: breakfastIncluded ? breakfastAdultPrice : 0,
                    breakfast_child_price: breakfastIncluded ? breakfastChildPrice : 0
                });
                
                console.log(`  ‚Üí Í∞ùÏã§ ${roomNum} Ï†ÄÏû•: Î£∏ÌÉÄÏûÖ=${roomTypeId}, ÌîÑÎ°úÎ™®ÏÖò=${roomPromo?.promotion?.promo_code}, ÏöîÍ∏à=$${roomPromo?.total_room_rate || 0}, Ï°∞Ïãù=${breakfastIncluded}`);
            });
            
            if (rooms.length === 0) {
                alert('ÏµúÏÜå 1Í∞úÏùò Í∞ùÏã§ÏùÑ Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            // Ï∂îÍ∞Ä Ìï≠Î™© ÏàòÏßë
            const extras = [];
            document.querySelectorAll('.extra-item-card').forEach((extraCard, cardIndex) => {
                const extraNum = extraCard.querySelector('[data-extra-field="quantity"]')?.dataset.extra;
                if (!extraNum) {
                    console.warn(`‚ö†Ô∏è Ï∂îÍ∞ÄÌï≠Î™© Ïπ¥Îìú ${cardIndex}Ïóê data-extra ÏÜçÏÑ±Ïù¥ ÏóÜÏäµÎãàÎã§.`);
                    return;
                }
                
                const itemName = extraCard.querySelector('[data-extra-field="item_name"]')?.value?.trim();
                
                // ‚≠ê Ï°∞ÏãùÏùÄ Í∞ùÏã§ Ï†ïÎ≥¥Ïóê Ìè¨Ìï®ÎêòÎØÄÎ°ú Ï†ÄÏû•ÏóêÏÑú Ï†úÏô∏
                if (itemName && itemName.includes('Ï°∞Ïãù')) {
                    console.log(`‚è≠Ô∏è Ï°∞Ïãù Ìï≠Î™© Ï†ÄÏû• Ï†úÏô∏: ${itemName} (Í∞ùÏã§ ÌÉÄÏûÖÏóê Ìè¨Ìï®Îê®)`);
                    return;
                }
                
                const pricingType = extraCard.querySelector('[data-extra-field="pricing_type"]')?.value || 'flat';
                const inHotel = extraCard.querySelector('[data-extra-field="in_hotel"]')?.value || 'in';
                const quantity = parseInt(extraCard.querySelector('[data-extra-field="quantity"]')?.value) || 1;
                
                console.log(`\nüìù Ï∂îÍ∞ÄÌï≠Î™© ${cardIndex + 1} (extraNum: ${extraNum}) ÏàòÏßë ÏãúÏûë:`);
                console.log(`  Ìï≠Î™©Î™Ö: ${itemName}, Ïú†Ìòï: ${pricingType}, ÏàòÎüâ: ${quantity}`);
                
                let totalPrice = 0;
                let extraData = {
                    item_name: itemName,
                    pricing_type: pricingType,
                    quantity: quantity,
                    in_hotel: inHotel
                };
                
                if (pricingType === 'per_person') {
                    const adultCount = parseInt(extraCard.querySelector('[data-extra-field="adult_count"]')?.value) || 0;
                    const adultPrice = parseFloat(extraCard.querySelector('[data-extra-field="adult_price"]')?.value) || 0;
                    const childCount = parseInt(extraCard.querySelector('[data-extra-field="child_count"]')?.value) || 0;
                    const childPrice = parseFloat(extraCard.querySelector('[data-extra-field="child_price"]')?.value) || 0;
                    const infantCount = parseInt(extraCard.querySelector('[data-extra-field="infant_count"]')?.value) || 0;
                    const infantPrice = parseFloat(extraCard.querySelector('[data-extra-field="infant_price"]')?.value) || 0;
                    
                    totalPrice = (adultCount * adultPrice + childCount * childPrice + infantCount * infantPrice) * quantity;
                    
                    extraData.adult_count = adultCount;
                    extraData.adult_price = adultPrice;
                    extraData.child_count = childCount;
                    extraData.child_price = childPrice;
                    extraData.infant_count = infantCount;
                    extraData.infant_price = infantPrice;
                    extraData.unit_price = null;
                    
                    console.log(`  ‚Üí Ïù∏ÏõêÎ≥Ñ ÏöîÍ∏à Ï†ÄÏû•: ${itemName} - ÏÑ±Ïù∏ ${adultCount}√ó$${adultPrice}, ÏÜåÏïÑ ${childCount}√ó$${childPrice}, Ï¥ù: $${totalPrice}`);
                } else {
                    const unitPrice = parseFloat(extraCard.querySelector('[data-extra-field="unit_price"]')?.value) || 0;
                    totalPrice = unitPrice * quantity;
                    extraData.unit_price = unitPrice;
                    extraData.adult_count = null;
                    extraData.adult_price = null;
                    extraData.child_count = null;
                    extraData.child_price = null;
                    extraData.infant_count = null;
                    extraData.infant_price = null;
                    
                    console.log(`  ‚Üí Ï†ïÏï° ÏöîÍ∏à Ï†ÄÏû•: ${itemName} - ÏàòÎüâ ${quantity}√ó$${unitPrice}, Ï¥ù: $${totalPrice}`);
                }
                
                extraData.total_selling_price = totalPrice;
                
                if (itemName) {
                    extras.push(extraData);
                }
            });
            
            // Ï†ÑÏ≤¥ ÏöîÍ∏à ÏöîÏïΩ Í∞í Í≥ÑÏÇ∞ (‚≠ê Ï°∞Ïãù + Ï∂îÍ∞ÄÏöîÍ∏à + ÏàòÎ∞∞Ìîº Ìè¨Ìï®)
            const totalRoomCharge = parseFloat(document.getElementById('totalRoomCharge').value) || 0;
            const totalBreakfastCharge = parseFloat(document.getElementById('totalBreakfastCharge').value) || 0;
            const totalExtrasCharge = parseFloat(document.getElementById('totalExtrasCharge').value) || 0;
            const agencyFee = parseFloat(document.getElementById('agencyFee').value) || 0;
            const grandTotal = totalRoomCharge + totalBreakfastCharge + totalExtrasCharge + agencyFee;

            // Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ Íµ¨ÏÑ±
            const updatedData = {
                hotel_id: parseInt(hotelId),
                booking_agency_id: bookingAgencyId ? parseInt(bookingAgencyId) : null,
                reservation_date: document.getElementById('reservation_date').value,
                status: document.getElementById('status').value,
                check_in_date: document.getElementById('check_in_date').value,
                check_out_date: document.getElementById('check_out_date').value,
                arrival_flight: document.getElementById('arrival_flight').value || null,
                departure_flight: document.getElementById('departure_flight').value || null,
                special_requests: document.getElementById('special_requests').value || null,
                internal_memo: document.getElementById('internal_memo').value || null,
                // ‚≠ê ÏöîÏïΩ Í∏àÏï° ÌïÑÎìúÎì§ (ÏàòÎ∞∞Ìîº Ìè¨Ìï®)
                total_room_rate: totalRoomCharge,
                total_extras_rate: totalExtrasCharge,
                agency_fee: agencyFee,
                grand_total: grandTotal,
                total_selling_price: grandTotal,
                rooms: rooms,
                extras: extras
            };
            
            console.log('üíæ Ï†ÄÏû• Îç∞Ïù¥ÌÑ∞:', updatedData);
            
            try {
                const response = await fetch(`/api/hotel-reservations/${currentEditingId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ ÏòàÏïΩÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.');
                    lastClosedReservationId = currentEditingId;
                    bootstrap.Modal.getInstance(document.getElementById('editReservationModal')).hide();
                    loadReservations();
                } else {
                    console.error('Ï†ÄÏû• Ïã§Ìå®:', result);
                    alert('‚ùå ÏàòÏ†ï Ïã§Ìå®: ' + (result.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                }
            } catch (error) {
                console.error('‚ùå ÏàòÏ†ï Ïò§Î•ò:', error);
                alert('‚ùå Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }
        
        // ÏàòÎ∞∞ÏÑú ÏÉùÏÑ±/Î≥¥Í∏∞
        async function createAssignment(reservationId) {
            lastClosedReservationId = reservationId;
            highlightReservationRow(reservationId); // Ìï¥Îãπ ÌñâÎßå Í∞ïÏ°∞
            
            try {
                // ÏòàÏïΩ Ï†ïÎ≥¥ Ï°∞Ìöå
                const response = await fetch(`/api/hotel-reservations/${reservationId}`);
                const reservation = await response.json();
                
                console.log('üìã ÏòàÏïΩ Ï†ïÎ≥¥ Ï°∞Ìöå Í≤∞Í≥º:', reservation);
                
                if (!response.ok) {
                    throw new Error(reservation.message || 'ÏòàÏïΩ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
                }
                
                // ‚≠ê Îç∞Ïù¥ÌÑ∞ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ Î∞è Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
                if (!reservation.rooms) reservation.rooms = [];
                if (!reservation.extras) reservation.extras = [];
                
                reservation.rooms.forEach((room, idx) => {
                    console.log(`  üì¶ Room ${idx+1} Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏:`, room);
                    // Ï°∞Ïãù ÌïÑÎìú ÌôïÏù∏
                    console.log(`    üç≥ Ï°∞Ïãù: included=${room.breakfast_included}, days=${room.breakfast_days}, adult=${room.breakfast_adult_count}`);
                });
                
                // ÏàòÎ∞∞ÏÑú Ïù¥Î†• Ï°∞Ìöå
                const historyResponse = await fetch(`/api/hotel-assignments/${reservationId}/history`);
                const historyData = await historyResponse.json();
                const history = historyData.success ? historyData.history : [];
                
                console.log('üìú ÏàòÎ∞∞ÏÑú Ïù¥Î†•:', history);
                
                // ÏàòÎ∞∞ÏÑú Î™®Îã¨ Ïó¥Í∏∞
                openAssignmentModal(reservation, history);
                
            } catch (error) {
                console.error('‚ùå ÏàòÎ∞∞ÏÑú Ï°∞Ìöå Ïò§Î•ò:', error);
                alert('‚ùå Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }
        
        // Ïù¥Î©îÏùº ÏûÖÎ†• ÌïÑÎìú ÌÜ†Í∏Ä
        function toggleEmailInput() {
            const method = document.querySelector('input[name="deliveryMethod"]:checked').value;
            const emailGroup = document.getElementById('instantEmailGroup');
            if (method === 'email') {
                emailGroup.style.display = 'block';
            } else {
                emailGroup.style.display = 'none';
            }
        }

        // ÏàòÎ∞∞ÏÑú Î™®Îã¨ Ïó¥Í∏∞
        function openAssignmentModal(reservation, history) {
            console.log('üîß Î™®Îã¨ Ïó¥Í∏∞ - ÏòàÏïΩ Îç∞Ïù¥ÌÑ∞:', reservation);
            console.log('- reservation:', reservation);
            console.log('- reservation.rooms:', reservation.rooms);
            console.log('- reservation.extras:', reservation.extras);
            
            const modal = new bootstrap.Modal(document.getElementById('assignmentModal'));
            
            // A4 ÏàòÎ∞∞ÏÑú ÎØ∏Î¶¨Î≥¥Í∏∞ ÏÉùÏÑ±
            const assignmentHTML = generateA4AssignmentPreview(reservation, history);
            document.getElementById('assignmentPreview').innerHTML = assignmentHTML;
            
            // ÌòÑÏû¨ ÏòàÏïΩ Ï†ïÎ≥¥ Ï†ÄÏû•
            window.currentAssignmentReservationId = reservation.id;
            window.currentAssignmentReservation = reservation;
            window.currentAssignmentHistory = history;
            
            // ÏÉùÏÑ±Îêú ÏàòÎ∞∞ÏÑú Î™©Î°ù Î°úÎìú
            loadAssignmentsList(reservation.id);
            
            // Î™®Îã¨ ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
            document.getElementById('newAssignmentTypeSelect').value = 'NEW';
            document.getElementById('newChangesDescriptionInput').value = '';
            document.getElementById('newChangesDescriptionGroup').style.display = 'none';
            
            // Ï†ÑÏÜ° Î∞©Ïãù Ï¥àÍ∏∞Ìôî (ÏÉùÏÑ±Îßå ÌïòÍ∏∞)
            document.getElementById('methodCreateOnly').checked = true;
            toggleEmailInput();
            
            // Ìò∏ÌÖî Ïù¥Î©îÏùºÏù¥ ÏûàÏúºÎ©¥ ÏûêÎèô Ï±ÑÏö∞Í∏∞
            if (reservation.hotel_email) {
                document.getElementById('instantRecipientEmail').value = reservation.hotel_email;
            } else {
                document.getElementById('instantRecipientEmail').value = '';
            }
            
            modal.show();
        }
        
        // Ï†ÑÏÜ° ÌÉÄÏûÖ/Î∞©ÏãùÏóê Îî∞Îùº Î™®Îã¨ ÌÉÄÏù¥ÌãÄ ÎèôÏ†Å Î≥ÄÍ≤Ω
        function updateAssignmentModalTitle() {
            const type = document.getElementById('newAssignmentTypeSelect').value;
            const method = document.querySelector('input[name="deliveryMethod"]:checked')?.value || 'create_only';
            const titleEl = document.getElementById('assignmentModalTitle');

            let typeLabel = '';
            if (type === 'NEW') typeLabel = 'Ïã†Í∑ú ÏàòÎ∞∞ÏÑú';
            else if (type === 'REVISE') typeLabel = 'ÏàòÏ†ï ÏàòÎ∞∞ÏÑú';
            else if (type === 'CANCEL') typeLabel = 'Ï∑®ÏÜå ÏàòÎ∞∞ÏÑú';

            let methodLabel = '';
            if (method === 'create_only') methodLabel = 'ÏÉùÏÑ±';
            else if (method === 'email') methodLabel = 'ÏÉùÏÑ± Î∞è Ïù¥Î©îÏùº Ï†ÑÏÜ°';
            else if (method === 'link') methodLabel = 'ÏÉùÏÑ± Î∞è ÎßÅÌÅ¨ Î≥µÏÇ¨';

            titleEl.innerHTML = `<i class="fas fa-file-contract me-2"></i>${typeLabel} ${methodLabel}`;
        }

        // Ï†ÑÏÜ° ÌÉÄÏûÖ Î≥ÄÍ≤Ω Ìï∏Îì§Îü¨ (ÏÉà ÏàòÎ∞∞ÏÑú ÏÉùÏÑ±Ïö©)
        document.getElementById('newAssignmentTypeSelect').addEventListener('change', function(e) {
            const descGroup = document.getElementById('newChangesDescriptionGroup');
            if (e.target.value === 'REVISE' || e.target.value === 'CANCEL') {
                descGroup.style.display = 'block';
            } else {
                descGroup.style.display = 'none';
            }
            updateAssignmentModalTitle();
        });
        
        // ÏàòÎ∞∞ÏÑú ÏÉùÏÑ± Î∞è Ï≤òÎ¶¨ Ìï®Ïàò
        async function createNewAssignment() {
            const reservationId = window.currentAssignmentReservationId;
            if (!reservationId) {
                alert('ÏòàÏïΩ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const assignmentType = document.getElementById('newAssignmentTypeSelect').value;
            const changesDescription = document.getElementById('newChangesDescriptionInput').value;
            
            // Ï†ÑÏÜ° Î∞©Ïãù ÌôïÏù∏
            const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked').value;
            const recipientEmail = document.getElementById('instantRecipientEmail').value;
            
            // Í≤ÄÏ¶ù
            if ((assignmentType === 'REVISE' || assignmentType === 'CANCEL') && !changesDescription.trim()) {
                alert('Î≥ÄÍ≤Ω/Ï∑®ÏÜå ÏÇ¨Ïú†Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            if (deliveryMethod === 'email' && !recipientEmail) {
                alert('ÏàòÏã† Ïù¥Î©îÏùº Ï£ºÏÜåÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                document.getElementById('instantRecipientEmail').focus();
                return;
            }
            
            // ÌôïÏù∏ Î©îÏãúÏßÄ Íµ¨ÏÑ±
            let typeLabel = assignmentType === 'NEW' ? 'Ïã†Í∑ú' : (assignmentType === 'REVISE' ? 'ÏàòÏ†ï' : 'Ï∑®ÏÜå');
            let actionLabel = 'ÏÉùÏÑ±';
            if (deliveryMethod === 'email') actionLabel = `ÏÉùÏÑ± ÌõÑ ${recipientEmail}Î°ú Ï†ÑÏÜ°`;
            else if (deliveryMethod === 'link') actionLabel = 'ÏÉùÏÑ± ÌõÑ ÎßÅÌÅ¨ Î≥µÏÇ¨';
            
            if (!confirm(`${typeLabel} ÏàòÎ∞∞ÏÑúÎ•º ${actionLabel}ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                return;
            }
            
            try {
                // 1. ÏàòÎ∞∞ÏÑú ÏÉùÏÑ±
                const response = await fetch('/api/hotel-assignment-management/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reservation_id: reservationId,
                        assignment_type: assignmentType,
                        changes_description: changesDescription || null,
                        sent_by: '<%= adminUsername %>' // ÌòÑÏû¨ Î°úÍ∑∏Ïù∏ ÏÇ¨Ïö©Ïûê
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    alert('‚ùå ÏÉùÏÑ± Ïã§Ìå®: ' + (result.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                    return;
                }
                
                const assignmentId = result.assignment_id;
                const assignmentToken = result.assignment_token;
                const link = `${window.location.origin}/hotel-assignment/view/${assignmentToken}`;
                
                // 2. ÌõÑÏÜç ÏûëÏóÖ ÏàòÌñâ
                if (deliveryMethod === 'email') {
                    // Ïù¥Î©îÏùº Ï†ÑÏÜ° API Ìò∏Ï∂ú
                    const sendResponse = await fetch(`/api/hotel-assignment-management/${assignmentId}/send`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ hotel_email: recipientEmail })
                    });
                    
                    const sendResult = await sendResponse.json();
                    
                    if (sendResult.success) {
                        alert(`‚úÖ ÏàòÎ∞∞ÏÑú ÏÉùÏÑ± Î∞è Ïù¥Î©îÏùº Ï†ÑÏÜ° ÏôÑÎ£å!\n\nÏàòÏã†: ${sendResult.sent_to}`);
                    } else {
                        alert(`‚ö†Ô∏è ÏàòÎ∞∞ÏÑúÎäî ÏÉùÏÑ±ÎêòÏóàÏúºÎÇò Ïù¥Î©îÏùº Ï†ÑÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\nÏò§Î•ò: ${sendResult.error}`);
                    }
                    
                } else if (deliveryMethod === 'link') {
                    // ÎßÅÌÅ¨ Î≥µÏÇ¨
                    try {
                        await navigator.clipboard.writeText(link);
                        alert(`‚úÖ ÏàòÎ∞∞ÏÑúÍ∞Ä ÏÉùÏÑ±ÎêòÍ≥† ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!\n\n${link}`);
                    } catch (err) {
                        // fallback
                        const tempInput = document.createElement('input');
                        tempInput.value = link;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        alert(`‚úÖ ÏàòÎ∞∞ÏÑúÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§. ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.\n\n${link}`);
                    }
                    
                } else {
                    // ÏÉùÏÑ±Îßå ÌïòÍ∏∞
                    alert(`‚úÖ ÏàòÎ∞∞ÏÑúÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!\n\nÌÉÄÏûÖ: ${result.assignment_type}${result.revision_number > 0 ? ' #' + result.revision_number : ''}`);
                }
                
                // 3. UI Ï¥àÍ∏∞Ìôî Î∞è Î™©Î°ù Í∞±Ïã†
                document.getElementById('newAssignmentTypeSelect').value = 'NEW';
                document.getElementById('newChangesDescriptionInput').value = '';
                document.getElementById('newChangesDescriptionGroup').style.display = 'none';
                document.getElementById('methodCreateOnly').checked = true;
                toggleEmailInput();
                updateAssignmentModalTitle();
                
                // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ® ÌõÑ Î™©Î°ù ÏòÅÏó≠ÏúºÎ°ú Ïä§ÌÅ¨Î°§
                await loadAssignmentsList(reservationId);
                const listContainer = document.getElementById('assignmentsList');
                if (listContainer) {
                    listContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
            } catch (error) {
                console.error('‚ùå ÏàòÎ∞∞ÏÑú Ï≤òÎ¶¨ Ïò§Î•ò:', error);
                alert('‚ùå Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }
        
        // ÏÉùÏÑ±Îêú ÏàòÎ∞∞ÏÑú Î™©Î°ù Î°úÎìú
        async function loadAssignmentsList(reservationId) {
            try {
                const response = await fetch(`/api/hotel-assignment-management/list/${reservationId}`);
                const result = await response.json();
                
                const listContainer = document.getElementById('assignmentsList');
                
                if (result.success && result.assignments && result.assignments.length > 0) {
                    let html = '<div class="list-group list-group-flush">';
                    
                    result.assignments.forEach(assignment => {
                        html += renderAssignmentItem(assignment);
                    });
                    
                    html += '</div>';
                    listContainer.innerHTML = html;
                } else {
                    listContainer.innerHTML = `
                        <div class="text-center text-muted p-4">
                            <i class="fas fa-inbox fa-3x mb-2"></i>
                            <p class="mb-0 small">ÏïÑÏßÅ ÏÉùÏÑ±Îêú ÏàòÎ∞∞ÏÑúÍ∞Ä ÏóÜÏäµÎãàÎã§</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Î™©Î°ù Î°úÎìú Ïò§Î•ò:', error);
            }
        }
        
        // ÏàòÎ∞∞ÏÑú Ìï≠Î™© Î†åÎçîÎßÅ
        function renderAssignmentItem(assignment) {
            const typeLabel = assignment.assignment_type === 'NEW' ? 'NEW' : 
                            (assignment.assignment_type === 'REVISE' ? `REV#${assignment.revision_number}` : 'CANCEL');
            const typeBadgeClass = assignment.assignment_type === 'NEW' ? 'bg-primary' : 
                                   (assignment.assignment_type === 'REVISE' ? 'bg-warning' : 'bg-danger');
            
            const createdDate = new Date(assignment.created_at).toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const assignmentLink = `${window.location.origin}/hotel-assignment/view/${assignment.assignment_token}`;

            // Î©îÏùº Ï†ÑÏÜ°/Ïó¥Îûå ÏÉÅÌÉú
            const emailSent = assignment.sent_to_email && assignment.sent_at;
            const emailViewed = assignment.email_viewed;

            let sentAtText = '-';
            let viewedText = '-';
            if (emailSent) {
                sentAtText = new Date(assignment.sent_at).toLocaleString('ko-KR', {
                    year: '2-digit', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                });
            }
            if (emailViewed && assignment.viewed_at) {
                viewedText = `${new Date(assignment.viewed_at).toLocaleString('ko-KR', {
                    year: '2-digit', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                })} (${assignment.view_count || 1}Ìöå)`;
            }

            return `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <div>
                            <span class="badge ${typeBadgeClass} me-2">${typeLabel}</span>
                            <small class="text-muted">${createdDate}</small>
                        </div>
                        <small class="text-muted">by ${assignment.sent_by || 'Admin'}</small>
                    </div>

                    ${assignment.changes_description ? `
                        <div class="alert alert-warning py-1 px-2 mb-2" style="font-size: 11px;">
                            <strong>ÏÇ¨Ïú†:</strong> ${assignment.changes_description}
                        </div>
                    ` : ''}

                    <div class="btn-group btn-group-sm w-100 mb-2" role="group">
                        <button class="btn btn-outline-secondary" onclick="window.open('${assignmentLink}', '_blank')">
                            <i class="fas fa-eye me-1"></i>ÎØ∏Î¶¨Î≥¥Í∏∞
                        </button>
                        <button class="btn btn-outline-primary" onclick="sendAssignmentEmailById('${assignment.id}', '${assignment.assignment_token}')">
                            <i class="fas fa-envelope me-1"></i>Î©îÏùº Î≥¥ÎÇ¥Í∏∞
                        </button>
                        <button class="btn btn-outline-info" onclick="copyAssignmentLinkById('${assignmentLink}')">
                            <i class="fas fa-link me-1"></i>ÎßÅÌÅ¨ Î≥µÏÇ¨
                        </button>
                    </div>

                    <div class="row" style="font-size: 11px;">
                        <div class="col-6">
                            <div class="text-muted">Ï†ÑÏÜ° Ïù¥Î©îÏùº</div>
                            <div>${assignment.sent_to_email || '-'}</div>
                        </div>
                        <div class="col-3">
                            <div class="text-muted">Ï†ÑÏÜ°ÏãúÍ∞Ñ</div>
                            <div>${sentAtText}</div>
                        </div>
                        <div class="col-3">
                            <div class="text-muted">Ïó¥ÎûåÏó¨Î∂Ä</div>
                            <div>${emailViewed ? '<span class="text-success">Ïó¥Îûå</span>' : '<span class="text-secondary">ÎØ∏Ïó¥Îûå</span>'}</div>
                        </div>
                    </div>

                    ${emailViewed && assignment.viewed_at ? `
                        <div class="mt-1" style="font-size: 11px;">
                            <span class="text-success">Ïó¥ÎûåÏãúÍ∞Ñ:</span> ${viewedText}
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // ÌäπÏ†ï ÏàòÎ∞∞ÏÑú Ïù¥Î©îÏùº Ï†ÑÏÜ°
        async function sendAssignmentEmailById(assignmentId, assignmentToken) {
            const hotelEmail = prompt('Ìò∏ÌÖî Ïù¥Î©îÏùº Ï£ºÏÜåÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', window.currentAssignmentReservation?.hotel_email || '');
            if (!hotelEmail) return;
            
            // Ïù¥Î©îÏùº ÌòïÏãù Í≤ÄÏ¶ù
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(hotelEmail)) {
                alert('Ïò¨Î∞îÎ•∏ Ïù¥Î©îÏùº Ï£ºÏÜåÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            if (!confirm(`${hotelEmail}Î°ú ÏàòÎ∞∞ÏÑúÎ•º Ï†ÑÏÜ°ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;
            
            try {
                const response = await fetch(`/api/hotel-assignment-management/${assignmentId}/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hotel_email: hotelEmail })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Ïù¥Î©îÏùºÏù¥ Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§!\n\nÏàòÏã†: ${result.sent_to}\nÎßÅÌÅ¨: ${result.assignment_link}`);
                    
                    // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                    loadAssignmentsList(window.currentAssignmentReservationId);
                } else {
                    alert('‚ùå Ï†ÑÏÜ° Ïã§Ìå®: ' + (result.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                }
            } catch (error) {
                console.error('‚ùå Ïù¥Î©îÏùº Ï†ÑÏÜ° Ïò§Î•ò:', error);
                alert('‚ùå Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }
        
        // ÌäπÏ†ï ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨ Î≥µÏÇ¨
        async function copyAssignmentLinkById(link) {
            try {
                await navigator.clipboard.writeText(link);
                alert(`‚úÖ ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!\n\n${link}\n\nÏù¥ ÎßÅÌÅ¨Î•º Ìò∏ÌÖîÏóê ÏßÅÏ†ë Ï†ÑÎã¨Ìï† Ïàò ÏûàÏäµÎãàÎã§.`);
            } catch (error) {
                console.error('‚ùå ÎßÅÌÅ¨ Î≥µÏÇ¨ Ïò§Î•ò:', error);
                // fallback: ÌÖçÏä§Ìä∏ ÏÑ†ÌÉù
                const tempInput = document.createElement('input');
                tempInput.value = link;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                alert(`‚úÖ ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!\n\n${link}`);
            }
        }
        
        // ÎÇ†Ïßú Ìè¨Îß∑ÌåÖ Ìï®Ïàò
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // A4 ÏàòÎ∞∞ÏÑú/Î∞îÏö∞Ï≤ò Ïù∏Î≥¥Ïù¥Ïä§ ÎØ∏Î¶¨Î≥¥Í∏∞ HTML ÏÉùÏÑ± (Ïã§Ï†ú Ï†ÑÏÜ°ÎêòÎäî ÏñëÏãù)
        function generateA4AssignmentPreview(reservation, history, options) {
            options = options || {};
            const isVoucherDoc = options.documentType === 'voucher_invoice';
            console.log('üìÑ A4 ÎØ∏Î¶¨Î≥¥Í∏∞ ÏÉùÏÑ± ÏãúÏûë');
            console.log('- reservation:', reservation);
            console.log('- reservation.rooms:', reservation.rooms);
            console.log('- reservation.extras:', reservation.extras);
            
            const rooms = reservation.rooms || [];
            const extras = reservation.extras || [];
            
            console.log('- rooms Î∞∞Ïó¥ Í∏∏Ïù¥:', rooms.length);
            console.log('- extras Î∞∞Ïó¥ Í∏∏Ïù¥:', extras.length);
            
            // ÏàôÎ∞ï ÏùºÏàò Í≥ÑÏÇ∞
            const checkInDate = new Date(reservation.check_in_date);
            const checkOutDate = new Date(reservation.check_out_date);
            const nights = Math.round((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));
            
            // Í∞ùÏã§Î≥Ñ ÌÖåÏù¥Î∏î ÏÉùÏÑ±
            let roomsTableHTML = '';
            let roomCharges = []; // Í∞Å Î£∏Î≥Ñ ÏöîÍ∏à Ï†ÄÏû•
            let breakfastCharges = []; // Í∞Å Î£∏Î≥Ñ Ï°∞Ïãù ÏöîÍ∏à Ï†ÄÏû•
            
            if (rooms.length > 0) {
                rooms.forEach((room, idx) => {
                    console.log(`  üì¶ Room ${idx + 1}:`, room);
                    const guests = room.guests || [];
                    console.log(`    üë• Guests (${guests.length}):`, guests);
                    
                    const roomNum = idx + 1;
                    
                    // room_rate Í≥ÑÏÇ∞ (ÏóÜÏúºÎ©¥ total_selling_priceÏóêÏÑú Ïó≠ÏÇ∞)
                    let roomRate = parseFloat(room.room_rate || 0);
                    if (roomRate === 0 && room.total_selling_price && nights > 0) {
                        roomRate = parseFloat(room.total_selling_price) / nights;
                    }
                    
                    const roomCharge = roomRate * nights;
                    roomCharges.push({ roomNum, roomRate, nights, roomCharge });
                    
                    let guestsHTML = '';
                    if (guests.length > 0) {
                        guests.forEach((g, gIdx) => {
                            // Pax Type ÏòÅÎ¨∏
                            let paxType = '';
                            if (g.age_category === 'adult') paxType = 'Adult';
                            else if (g.age_category === 'child') paxType = 'Child';
                            else if (g.age_category === 'infant') paxType = 'Infant';
                            else paxType = 'Adult'; // Í∏∞Î≥∏Í∞í
                            
                            guestsHTML += `
                                <tr>
                                    <td style="padding: 4px; border: 1px solid #ddd;">${gIdx + 1}</td>
                                    <td style="padding: 4px; border: 1px solid #ddd;">${g.guest_name_en || '-'}</td>
                                    <td style="padding: 4px; border: 1px solid #ddd;">${paxType}</td>
                                    <td style="padding: 4px; border: 1px solid #ddd;">${g.date_of_birth ? formatDate(g.date_of_birth) : '-'}</td>
                                </tr>
                            `;
                        });
                    } else {
                        guestsHTML = '<tr><td colspan="4" style="padding: 8px; text-align: center; color: #999;">No guest information</td></tr>';
                    }
                    
                    // Promo Code ÌëúÏãú
                    const promoCode = room.promotion_code ? `Promo: ${room.promotion_code} <span style="color: #e74c3c; font-weight: bold;">[PROMOTION APPLIED]</span>` : 'Promo: -';
                    
                    // Ï°∞Ïãù Ï†ïÎ≥¥ (ÌöüÏàòÎßå)
                    let breakfastInfo = '';
                    
                    // ‚≠ê Ï°∞Ïãù Ìè¨Ìï® Ïó¨Î∂Ä ÌôïÏù∏ (Î¨∏ÏûêÏó¥ 'true' Îì± Îã§ÏñëÌïú ÏºÄÏù¥Ïä§ ÎåÄÏùë)
                    const isBreakfastIncluded = room.breakfast_included === true || room.breakfast_included === 'true' || room.breakfast_included === 1;
                    
                    if (isBreakfastIncluded) {
                        // Ïù∏Ïõê Ïàò ÏóÜÏúºÎ©¥ guests Î∞∞Ïó¥ÏóêÏÑú Í≥ÑÏÇ∞ ÏãúÎèÑ
                        let adultCount = parseInt(room.breakfast_adult_count || 0);
                        let childCount = parseInt(room.breakfast_child_count || 0);
                        
                        if (adultCount === 0 && childCount === 0 && room.guests && room.guests.length > 0) {
                            room.guests.forEach(g => {
                                if (g.age_category === 'adult') adultCount++;
                                else if (g.age_category === 'child') childCount++;
                            });
                        }
                        
                        const adultPrice = parseFloat(room.breakfast_adult_price || 0);
                        const childPrice = parseFloat(room.breakfast_child_price || 0);
                        
                        // ÌöüÏàò(days)Í∞Ä ÏóÜÏúºÎ©¥ Î∞ïÏàò(nights) ÏÇ¨Ïö©
                        const breakfastDays = parseInt(room.breakfast_days || nights);
                        
                        const adultTotal = adultCount * breakfastDays;
                        const childTotal = childCount * breakfastDays;
                        
                        const breakfastCharge = (adultTotal * adultPrice) + (childTotal * childPrice);
                        breakfastCharges.push({ roomNum, adultCount, childCount, nights: breakfastDays, adultTotal, childTotal, adultPrice, childPrice, breakfastCharge });
                        
                        breakfastInfo = `<strong>Breakfast: ‚òë Included</strong> ‚îÇ Adult: ${adultCount}√ó${breakfastDays}=${adultTotal} ‚îÇ Child: ${childCount}√ó${breakfastDays}=${childTotal}`;
                    } else {
                        breakfastInfo = '<strong>Breakfast: ‚òê Not Included</strong>';
                    }
                    
                    roomsTableHTML += `
                        <div style="margin-bottom: 15px; page-break-inside: avoid;">
                            <h6 style="background: #34495e; color: white; padding: 5px; margin: 0;">
                                ROOM ${roomNum}: ${room.hotel_room_name || room.room_type_name || 'Room Type Not Specified'} ‚îÇ ${promoCode}
                            </h6>
                            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                                <tr>
                                    <td style="padding: 4px; border: 1px solid #000; width: 40px;"><strong>No</strong></td>
                                    <td style="padding: 4px; border: 1px solid #000; width: 150px;"><strong>English Name</strong></td>
                                    <td style="padding: 4px; border: 1px solid #000; width: 80px;"><strong>Pax Type</strong></td>
                                    <td style="padding: 4px; border: 1px solid #000; width: 100px;"><strong>Date of Birth</strong></td>
                                </tr>
                                ${guestsHTML}
                            </table>
                            <div style="margin-top: 5px; font-size: 11px; padding: 4px; border: 1px solid #000; background: #ffffff;">
                                ${breakfastInfo}
                            </div>
                        </div>
                    `;
                });
            } else {
                roomsTableHTML = '<div style="padding: 20px; text-align: center; color: #999; background: #f8f9fa; border: 1px dashed #ddd;"><strong>‚ö†Ô∏è No room information registered.</strong><br><small>Please add room details in the reservation edit page.</small></div>';
            }
            
            // PAYMENT TO HOTEL ÏÑπÏÖò ÏÉùÏÑ±
            let paymentHTML = '';
            let totalAmount = 0;
            
            // Î£∏ ÏöîÍ∏à
            roomCharges.forEach(r => {
                paymentHTML += `
                    <tr>
                        <td style="padding: 5px; border: 1px solid #ddd;">Room ${r.roomNum}:</td>
                        <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">$${r.roomRate}√ó${r.nights} nights = $${r.roomCharge.toFixed(2)}</td>
                    </tr>
                `;
                totalAmount += r.roomCharge;
            });
            
            // Ï°∞Ïãù ÏöîÍ∏à
            breakfastCharges.forEach(b => {
                let breakfastDetail = '';
                if (b.adultTotal > 0 && b.childTotal > 0) {
                    breakfastDetail = `Adult $${b.adultPrice}√ó${b.adultTotal} + Child $${b.childPrice}√ó${b.childTotal}`;
                } else if (b.adultTotal > 0) {
                    breakfastDetail = `Adult $${b.adultPrice}√ó${b.adultTotal}`;
                } else if (b.childTotal > 0) {
                    breakfastDetail = `Child $${b.childPrice}√ó${b.childTotal}`;
                }
                
                paymentHTML += `
                    <tr>
                        <td style="padding: 5px; border: 1px solid #ddd;">Breakfast Room ${b.roomNum}:</td>
                        <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">${breakfastDetail} = $${b.breakfastCharge.toFixed(2)}</td>
                    </tr>
                `;
                totalAmount += b.breakfastCharge;
            });
            
            // Ï∂îÍ∞Ä ÏÑúÎπÑÏä§ (Í∏∞Î≥∏: IN_HOTELÎßå ÌëúÏãú, Î∞îÏö∞Ï≤ò Ïù∏Î≥¥Ïù¥Ïä§ Î™®ÎìúÏóêÏÑúÎäî IN/OUT Î™®Îëê ÌëúÏãú)
            if (extras && extras.length > 0) {
                let effectiveExtras = extras;

                // hotel_reservation_extras Ï≤òÎüº notes Ïª¨ÎüºÏù¥ ÏûàÎäî Í≤ΩÏö∞ OUT_HOTEL Ï†úÏô∏
                // Îã®, Î∞îÏö∞Ï≤ò Ïù∏Î≥¥Ïù¥Ïä§ Î¨∏ÏÑúÏóêÏÑúÎäî IN/OUT Î™®Îëê Ìè¨Ìï®
                if (!isVoucherDoc && effectiveExtras.length > 0 && Object.prototype.hasOwnProperty.call(effectiveExtras[0], 'notes')) {
                    effectiveExtras = effectiveExtras.filter(e => (e.notes || 'IN_HOTEL') !== 'OUT_HOTEL');
                }

                if (effectiveExtras.length > 0) {
                    let extrasDetail = '';
                    let extrasTotal = 0;

                    effectiveExtras.forEach((extra, idx) => {
                        // hotel_assignment_extras: charge
                        // hotel_reservation_extras: total_selling_price
                        const rawCharge =
                            (typeof extra.charge !== 'undefined' && extra.charge !== null)
                                ? extra.charge
                                : extra.total_selling_price;
                        const charge = parseFloat(rawCharge || 0);

                        extrasTotal += charge;
                        extrasDetail += `${extra.item_name} $${charge.toFixed(2)}`;
                        if (idx < effectiveExtras.length - 1) extrasDetail += ' + ';
                    });
                    
                    paymentHTML += `
                        <tr>
                            <td style="padding: 5px; border: 1px solid #ddd;">Extra Services:</td>
                            <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">${extrasDetail} = $${extrasTotal.toFixed(2)}</td>
                        </tr>
                    `;
                    totalAmount += extrasTotal;
                }
            }

            // Î∞îÏö∞Ï≤ò Ïù∏Î≥¥Ïù¥Ïä§ ÎØ∏Î¶¨Î≥¥Í∏∞ÏóêÏÑúÎäî ÏàòÎ∞∞Ìîº(agency_fee)Î•º Î≥ÑÎèÑ ÎùºÏù∏ÏúºÎ°ú ÌëúÏãúÌïòÍ≥† Ï¥ùÏï°Ïóê Ìè¨Ìï®
            if (isVoucherDoc) {
                const agencyFee = parseFloat(reservation.agency_fee || 0) || 0;
                console.log('üîç Î∞îÏö∞Ï≤ò ÏàòÎ∞∞Ìîº:', agencyFee, 'reservation.agency_fee:', reservation.agency_fee);
                
                // ÏàòÎ∞∞ÌîºÍ∞Ä 0Ïù¥Ïñ¥ÎèÑ Ìï≠ÏÉÅ ÌëúÏãú
                paymentHTML += `
                    <tr>
                        <td style="padding: 5px; border: 1px solid #ddd;">Agency Handling Fee:</td>
                        <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">$${agencyFee.toFixed(2)}</td>
                    </tr>
                `;
                totalAmount += agencyFee;
            }
            
            // Contact Îã¥ÎãπÏûê Ï†ïÎ≥¥ (ÏòàÏïΩ Ï≤òÏùå ÏûÖÎ†•Ìïú Îã¥ÎãπÏûê)
            const contactPerson = reservation.created_by || 'LUXFIND Staff';

            const agencyName = reservation.booking_agency_name || reservation.agency_name || 'LUXFIND';
            const headerTitle = isVoucherDoc ? 'HOTEL VOUCHER INVOICE' : 'HOTEL BOOKING REQUEST';
            const headerSubtitle = isVoucherDoc
                ? (agencyName
                    ? `AGENCY: ${agencyName}${reservation.agency_contact_person ? ' ‚îÇ CONTACT: ' + reservation.agency_contact_person : ''}`
                    : 'LUXFIND (Îü≠Ïä§ÌååÏù∏Îìú)')
                : 'LUXFIND (Îü≠Ïä§ÌååÏù∏Îìú)';
            
            const sentDate = new Date().toLocaleString('ko-KR', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            return `
                <div style="max-width: 1000px; margin: 0 auto; font-size: 14px; line-height: 1.4;">
                    <!-- Ìó§Îçî -->
                    <div style="text-align: center; background: #2c3e50; color: white; padding: 20px; margin-bottom: 10px; -webkit-print-color-adjust: exact; print-color-adjust: exact;">
                        <h3 style="margin: 0; font-size: 26px; font-weight: 900; letter-spacing: 1px;">üè® ${headerTitle}</h3>
                        <p style="margin: 5px 0 0 0; font-size: 16px; font-weight: bold;">${headerSubtitle}</p>
                    </div>
                    
                    <!-- Î∞úÏã† Ï†ïÎ≥¥ -->
                    <div style="text-align: right; padding: 8px 12px; background: #f8f9fa; border: 1px solid #dee2e6; margin-bottom: 15px; font-size: 13px; -webkit-print-color-adjust: exact; print-color-adjust: exact;">
                        <strong>üìÖ Sent:</strong> ${sentDate} | <strong>üë§ Contact:</strong> ${contactPerson}
                    </div>
                    
                    <!-- Í∏∞Î≥∏ Ï†ïÎ≥¥ -->
                    <table style="width: 100%; margin-bottom: 15px; border-collapse: collapse; font-size: 13px;">
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd; background: #ecf0f1; width: 140px; font-weight: bold; -webkit-print-color-adjust: exact; print-color-adjust: exact;">Hotel</td>
                            <td style="padding: 6px; border: 1px solid #ddd;" colspan="3">${reservation.hotel_name_en || reservation.hotel_name || '-'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd; background: #ecf0f1; font-weight: bold; -webkit-print-color-adjust: exact; print-color-adjust: exact;">Check-in</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${formatDate(reservation.check_in_date)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; background: #ecf0f1; width: 140px; font-weight: bold; -webkit-print-color-adjust: exact; print-color-adjust: exact;">Check-out</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${formatDate(reservation.check_out_date)}</td>
                        </tr>
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd; background: #ecf0f1; font-weight: bold; -webkit-print-color-adjust: exact; print-color-adjust: exact;">Nights</td>
                            <td style="padding: 6px; border: 1px solid #ddd;"><strong>${nights}</strong></td>
                            <td style="padding: 6px; border: 1px solid #ddd; background: #ecf0f1; font-weight: bold; -webkit-print-color-adjust: exact; print-color-adjust: exact;">Flight</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${reservation.arrival_flight || '-'} / ${reservation.departure_flight || '-'}</td>
                        </tr>
                    </table>
                    
                    <!-- Í∞ùÏã§ Î∞è Ìà¨ÏàôÍ∞ù Ï†ïÎ≥¥ -->
                    ${roomsTableHTML || '<p>No room information</p>'}
                    
                    <!-- PAYMENT TO HOTEL -->
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 15px;">
                        ${paymentHTML}
                        <tr>
                            <td colspan="2" style="padding: 6px;">&nbsp;</td>
                        </tr>
                        <tr style="font-weight: bold; font-size: 15px;">
                            <td style="padding: 10px; border: 1px solid #000;">TOTAL AMOUNT:</td>
                            <td style="padding: 10px; border: 1px solid #000; text-align: right;">$${totalAmount.toFixed(2)}</td>
                        </tr>
                    </table>
                    
                    <!-- ÎÇ¥Î∂Ä Î©îÎ™® / Ï†ïÏÇ∞ Í≥ÑÏ¢å ÏïàÎÇ¥ -->
                    ${isVoucherDoc
                        ? `
                            <div style="margin-top: 20px; padding: 12px; border: 1px solid #ddd; background: #fffacd; font-size: 13px; -webkit-print-color-adjust: exact; print-color-adjust: exact;">
                                <div><strong>ÏõêÌôîÍ≥ÑÏ¢å:</strong> Ïã†ÌïúÏùÄÌñâ 140-013-623890  (Ï£º)Îü≠Ïä§ÌååÏù∏Îìú</div>
                                <div><strong>Ïô∏ÌôîÍ≥ÑÏ¢å:</strong> Ïã†ÌïúÏùÄÌñâ 180-011-678887  (Ï£º)Îü≠Ïä§ÌååÏù∏Îìú</div>
                            </div>
                        `
                        : (reservation.internal_memo ? `
                            <div style="margin-top: 20px; padding: 12px; border: 1px solid #ddd; background: #fffacd; font-size: 13px; -webkit-print-color-adjust: exact; print-color-adjust: exact;">
                                ${reservation.internal_memo}
                            </div>
                        ` : '')
                    }
                    
                    <!-- Hotel Confirmation Section -->
                    <div style="margin-top: 30px; padding: 20px; border: 2px solid #2c3e50; background: #f8f9fa; -webkit-print-color-adjust: exact; print-color-adjust: exact;">
                        
                        ${rooms.map((room, idx) => `
                            <div style="margin-bottom: 12px; font-size: 14px;">
                                <strong>Room ${idx + 1} Confirmation Number:</strong>
                                <span style="display: inline-block; border-bottom: 1px solid #000; width: 250px; margin-left: 10px;"></span>
                            </div>
                        `).join('')}
                        
                        <div style="margin-top: 20px; font-size: 14px;">
                            <strong>Hotel Notes/Comments:</strong><br>
                            <div style="border: 1px solid #999; min-height: 60px; padding: 8px; background: white; margin-top: 5px;"></div>
                        </div>
                        
                        <div style="margin-top: 25px; display: flex; justify-content: space-between; font-size: 14px;">
                            <div>
                                <strong>Hotel Staff Name:</strong> 
                                <span style="display: inline-block; border-bottom: 1px solid #000; width: 180px; margin-left: 10px;"></span>
                            </div>
                            <div>
                                <strong>Date:</strong> 
                                <span style="display: inline-block; border-bottom: 1px solid #000; width: 120px; margin-left: 10px;"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ìë∏ÌÑ∞ -->
                    <div style="margin-top: 25px; padding-top: 15px; border-top: 2px solid #2c3e50; text-align: center; font-size: 12px; color: #7f8c8d;">
                        <p><strong>Agency:</strong> ${agencyName}</p>
                        <p><strong>Date:</strong> ${new Date().toLocaleString('ko-KR')}</p>
                    </div>
                </div>
            `;
        }
        
        // Ï†ÑÏÜ° Ïù¥Î†• HTML ÏÉùÏÑ±
        function generateHistoryHTML(history) {
            if (history.length === 0) {
                return '<p class="text-muted small">ÏïÑÏßÅ Ï†ÑÏÜ° Ïù¥Î†•Ïù¥ ÏóÜÏäµÎãàÎã§.</p>';
            }
            
            let html = '';
            history.forEach(h => {
                const date = new Date(h.sent_at);
                const dateStr = formatDate(h.sent_at);
                const timeStr = date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                const typeLabel = h.assignment_type === 'NEW' ? 'NEW' : (h.assignment_type === 'REVISE' ? `REV#${h.revision_number}` : 'CANCEL');
                
                let badgeClass = 'bg-primary';
                if (h.assignment_type === 'REVISE') badgeClass = 'bg-warning';
                if (h.assignment_type === 'CANCEL') badgeClass = 'bg-danger';
                
                html += `
                    <div class="border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="badge ${badgeClass}">${typeLabel}</span>
                            <small class="text-muted">${dateStr} ${timeStr}</small>
                        </div>
                        <small>
                            <strong>ÏàòÏã†:</strong> ${h.sent_to_email}<br>
                            <strong>Î∞úÏã†:</strong> ${h.sent_by}
                            ${h.changes_description ? `<br><strong>ÏÇ¨Ïú†:</strong> ${h.changes_description}` : ''}
                        </small>
                        ${h.email_message_id ? '<br><span class="badge bg-success mt-1">‚úì Ï†ÑÏÜ°ÏôÑÎ£å</span>' : ''}
                    </div>
                `;
            });
            
            return html;
        }
        
        // ÏàòÎ∞∞ÏÑú Ïù¥Î©îÏùº Ï†ÑÏÜ°
        async function sendAssignmentEmail() {
            const reservationId = window.currentAssignmentReservationId;
            if (!reservationId) {
                alert('ÏòàÏïΩ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            // Ï†ÑÏÜ° ÌÉÄÏûÖ ÏÑ†ÌÉù
            const history = window.currentAssignmentHistory || [];
            let assignmentType = 'NEW';
            let changesDescription = '';
            
            if (history.length > 0) {
                // Í∏∞Ï°¥ ÏàòÎ∞∞ÏÑúÍ∞Ä ÏûàÎäî Í≤ΩÏö∞ - 3Í∞ÄÏßÄ ÏÑ†ÌÉùÏßÄ
                const typeChoice = prompt(
                    'ÏàòÎ∞∞ÏÑú Ï†ÑÏÜ° ÌÉÄÏûÖÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî:\n\n' +
                    '1 - NEW (Ïã†Í∑úÎ°ú Îã§Ïãú Ï†ÑÏÜ°)\n' +
                    '2 - REVISE (ÏàòÏ†ï Ï†ÑÏÜ°)\n' +
                    '3 - CANCEL (Ï∑®ÏÜå Ï†ÑÏÜ°)\n\n' +
                    'Ïà´ÏûêÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (1, 2, ÎòêÎäî 3):',
                    '2'
                );
                
                if (typeChoice === null) return; // Ï∑®ÏÜå
                
                if (typeChoice === '1') {
                    assignmentType = 'NEW';
                } else if (typeChoice === '2') {
                    assignmentType = 'REVISE';
                    changesDescription = prompt('Î≥ÄÍ≤Ω ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: Ï≤¥ÌÅ¨Ïù∏ ÎÇ†Ïßú Î≥ÄÍ≤Ω, Í∞ùÏã§ Ï∂îÍ∞Ä Îì±):');
                    if (changesDescription === null) return; // Ï∑®ÏÜå
                } else if (typeChoice === '3') {
                    assignmentType = 'CANCEL';
                    changesDescription = prompt('Ï∑®ÏÜå ÏÇ¨Ïú†Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: Í≥†Í∞ù ÏöîÏ≤≠, ÏùºÏ†ï Î≥ÄÍ≤Ω Îì±):');
                    if (changesDescription === null) return; // Ï∑®ÏÜå
                } else {
                    alert('Ïò¨Î∞îÎ•∏ Ïà´Ïûê(1, 2, ÎòêÎäî 3)Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
            } else {
                // Ï≤´ Ï†ÑÏÜ°
                assignmentType = 'NEW';
            }
            
            // ÏµúÏ¢Ö ÌôïÏù∏
            let confirmMessage = '';
            if (assignmentType === 'NEW') {
                confirmMessage = 'Ïã†Í∑ú ÏàòÎ∞∞ÏÑúÎ•º Ï†ÑÏÜ°ÌïòÏãúÍ≤†ÏäµÎãàÍπå?';
            } else if (assignmentType === 'REVISE') {
                confirmMessage = `ÏàòÏ†ï ÏàòÎ∞∞ÏÑú(REVISE #${history.filter(h => h.assignment_type === 'REVISE').length + 1})Î•º Ï†ÑÏÜ°ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`;
            } else if (assignmentType === 'CANCEL') {
                confirmMessage = 'Ï∑®ÏÜå ÏàòÎ∞∞ÏÑú(CANCELLATION)Î•º Ï†ÑÏÜ°ÌïòÏãúÍ≤†ÏäµÎãàÍπå?';
            }
            
            if (!confirm(confirmMessage)) return;
            
            try {
                const response = await fetch('/api/hotel-assignments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reservation_id: reservationId,
                        assignment_type: assignmentType,
                        changes_description: changesDescription,
                        sent_by: 'Admin' // TODO: Î°úÍ∑∏Ïù∏ ÏÇ¨Ïö©ÏûêÎ™ÖÏúºÎ°ú Î≥ÄÍ≤Ω
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ ÏàòÎ∞∞ÏÑúÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§!\n\nÌÉÄÏûÖ: ${assignmentType}\nÎßÅÌÅ¨: ${result.assignment_link}`);
                    
                    // Î™®Îã¨ ÏÉàÎ°úÍ≥†Ïπ® (ÏµúÏã† Ïù¥Î†• ÌëúÏãú)
                    await createAssignment(reservationId);
                    
                } else {
                    alert('‚ùå Ï†ÑÏÜ° Ïã§Ìå®: ' + (result.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                }
            } catch (error) {
                console.error('‚ùå Ï†ÑÏÜ° Ïò§Î•ò:', error);
                alert('‚ùå Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }
        
        // ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨ Î≥µÏÇ¨
        async function copyAssignmentLink() {
            const reservationId = window.currentAssignmentReservationId;
            if (!reservationId) {
                alert('ÏòàÏïΩ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            try {
                // ÏòàÏïΩ Ï†ïÎ≥¥ Ï°∞Ìöå (assignment_token Ìè¨Ìï®)
                const response = await fetch(`/api/hotel-reservations/${reservationId}`);
                const reservation = await response.json();
                
                if (!reservation.assignment_token) {
                    alert('‚ö†Ô∏è ÏàòÎ∞∞ÏÑúÎ•º Î®ºÏ†Ä Ï†ÑÏÜ°Ìï¥Ïïº ÎßÅÌÅ¨Í∞Ä ÏÉùÏÑ±Îê©ÎãàÎã§.\n\n"Send to Hotel" Î≤ÑÌäºÏùÑ ÎàåÎü¨ ÏàòÎ∞∞ÏÑúÎ•º Ï†ÑÏÜ°ÌïòÏÑ∏Ïöî.');
                    return;
                }
                
                const link = `${window.location.origin}/hotel-assignment/${reservation.assignment_token}`;
                
                // ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨
                await navigator.clipboard.writeText(link);
                alert(`‚úÖ ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!\n\n${link}\n\nÏù¥ ÎßÅÌÅ¨Î•º Ìò∏ÌÖîÏóê ÏßÅÏ†ë Ï†ÑÎã¨Ìï† Ïàò ÏûàÏäµÎãàÎã§.`);
                
            } catch (error) {
                console.error('‚ùå ÎßÅÌÅ¨ Î≥µÏÇ¨ Ïò§Î•ò:', error);
                alert('‚ùå ÎßÅÌÅ¨ Î≥µÏÇ¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        // ÏàòÎ∞∞ÏÑú Ïù∏ÏáÑ (Í∞úÏÑ†Îêú UI)
        function printAssignment() {
            const printContent = document.getElementById('assignmentPreview').innerHTML;
            const printWindow = window.open('', '', 'width=1000,height=1200');
            printWindow.document.write('<!DOCTYPE html><html><head><title>Ìò∏ÌÖî ÏàòÎ∞∞ÏÑú - LUXFIND</title>');
            printWindow.document.write(`
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap');
                    
                    body { 
                        margin: 0; 
                        padding: 30px; 
                        font-family: 'Noto Sans KR', 'Malgun Gothic', sans-serif; 
                        color: #2c3e50;
                        -webkit-font-smoothing: antialiased;
                    }
                    
                    /* Ï†ÑÏ≤¥ Ïª®ÌÖåÏù¥ÎÑà Ïû¨Ï†ïÏùò */
                    div[style*="max-width: 1000px"] {
                        max-width: 100% !important;
                        font-family: 'Noto Sans KR', sans-serif !important;
                        margin: 0 !important;
                    }
                    
                    /* ÌÖåÏù¥Î∏î Ïä§ÌÉÄÏùº Í∞úÏÑ† */
                    table { 
                        width: 100%; 
                        border-collapse: collapse; 
                        margin-bottom: 15px;
                        box-shadow: none !important;
                    }
                    
                    td, th { 
                        padding: 8px 12px !important; 
                        border: 1px solid #dfe6e9 !important; 
                        font-size: 13px !important;
                        vertical-align: middle;
                    }
                    
                    /* Í∞ïÏ°∞ ÏÖÄ Î∞∞Í≤Ω */
                    td[style*="background: #ecf0f1"] {
                        background-color: #f1f3f5 !important;
                        font-weight: 600 !important;
                        color: #2c3e50 !important;
                    }
                    
                    /* Ìó§Îçî Ïä§ÌÉÄÏùº */
                    h3 {
                        font-family: 'Noto Sans KR', sans-serif !important;
                        letter-spacing: -0.5px !important;
                    }
                    
                    /* ÏÑπÏÖò Ìó§Îçî */
                    h5 {
                        background-color: #2c3e50 !important;
                        color: #fff !important;
                        padding: 10px 15px !important;
                        font-size: 15px !important;
                        font-weight: 600 !important;
                        margin: 25px 0 15px 0 !important;
                        border-radius: 4px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        -webkit-print-color-adjust: exact !important;
                        print-color-adjust: exact !important;
                    }
                    
                    /* ÌôïÏù∏ ÏÑπÏÖò */
                    div[style*="border: 2px solid #2c3e50"] {
                        border: 2px solid #2c3e50 !important;
                        border-radius: 8px;
                        background-color: #fff !important;
                        padding: 25px !important;
                        margin-top: 40px !important;
                    }
                    
                    /* Ïù∏ÏáÑ Ï†ÑÏö© ÏÑ§Ï†ï */
                    @media print {
                        @page { 
                            size: A4; 
                            margin: 15mm; 
                        }
                        body { 
                            padding: 0; 
                        }
                        
                        /* ÌéòÏù¥ÏßÄ ÎÑòÍπÄ Î∞©ÏßÄ */
                        h5, tr, div[style*="border: 2px solid #2c3e50"] { 
                            page-break-inside: avoid; 
                        }
                        
                        /* Î∞∞Í≤ΩÏÉâ Ï∂úÎ†• Í∞ïÏ†ú */
                        * {
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                        
                        /* ÎßÅÌÅ¨ URL Ïà®Í∏∞Í∏∞ */
                        a[href]:after {
                            content: none !important;
                        }
                    }
                </style>
            `);
            printWindow.document.write('</head><body>' + printContent);
            printWindow.document.write('<script>window.onload = function() { window.print(); }<\/script>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();
        }
        
        // PDF Îã§Ïö¥Î°úÎìú (Î∏åÎùºÏö∞Ï†Ä Ïù∏ÏáÑ Îã§Ïù¥ÏñºÎ°úÍ∑∏ Ïù¥Ïö©)
        function downloadAssignmentPDF() {
            const printContent = document.getElementById('assignmentPreview').innerHTML;
            const printWindow = window.open('', '', 'width=1000,height=1200');
            printWindow.document.write('<!DOCTYPE html><html><head><title>Ìò∏ÌÖî ÏàòÎ∞∞ÏÑú - LUXFIND</title>');
            printWindow.document.write(`
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap');
                    
                    body { 
                        margin: 0; 
                        padding: 30px; 
                        font-family: 'Noto Sans KR', 'Malgun Gothic', sans-serif; 
                        color: #2c3e50;
                        -webkit-font-smoothing: antialiased;
                    }
                    
                    div[style*="max-width: 1000px"] {
                        max-width: 100% !important;
                        font-family: 'Noto Sans KR', sans-serif !important;
                        margin: 0 !important;
                    }
                    
                    table { 
                        width: 100%; 
                        border-collapse: collapse; 
                        margin-bottom: 15px;
                        box-shadow: none !important;
                    }
                    
                    td, th { 
                        padding: 8px 12px !important; 
                        border: 1px solid #dfe6e9 !important; 
                        font-size: 13px !important;
                        vertical-align: middle;
                    }
                    
                    td[style*="background: #ecf0f1"] {
                        background-color: #f1f3f5 !important;
                        font-weight: 600 !important;
                        color: #2c3e50 !important;
                    }
                    
                    h3 {
                        font-family: 'Noto Sans KR', sans-serif !important;
                        letter-spacing: -0.5px !important;
                    }
                    
                    h5 {
                        background-color: #2c3e50 !important;
                        color: #fff !important;
                        padding: 10px 15px !important;
                        font-size: 15px !important;
                        font-weight: 600 !important;
                        margin: 25px 0 15px 0 !important;
                        border-radius: 4px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        -webkit-print-color-adjust: exact !important;
                        print-color-adjust: exact !important;
                    }
                    
                    div[style*="border: 2px solid #2c3e50"] {
                        border: 2px solid #2c3e50 !important;
                        border-radius: 8px;
                        background-color: #fff !important;
                        padding: 25px !important;
                        margin-top: 40px !important;
                    }
                    
                    @media print {
                        @page { 
                            size: A4; 
                            margin: 15mm; 
                        }
                        body { 
                            padding: 0; 
                        }
                        h5, tr, div[style*="border: 2px solid #2c3e50"] { 
                            page-break-inside: avoid; 
                        }
                        * {
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                        a[href]:after {
                            content: none !important;
                        }
                    }
                </style>
            `);
            printWindow.document.write('</head><body>' + printContent);
            printWindow.document.write('<script>window.onload = function() { alert("PDFÎ°ú Ï†ÄÏû•ÌïòÎ†§Î©¥ Ïù∏ÏáÑ ÎåÄÌôîÏÉÅÏûêÏóêÏÑú PDFÎ°ú Ï†ÄÏû•ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî."); window.print(); }<\/script>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();
        }
        
        // ÏÉàÎ°úÏö¥ Ïù¥Î©îÏùº Ï†ÑÏÜ° Ìï®Ïàò (UI Ìèº ÏÇ¨Ïö©)
        async function sendAssignmentEmailNew() {
            const reservationId = window.currentAssignmentReservationId;
            if (!reservationId) {
                alert('ÏòàÏïΩ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const assignmentType = document.getElementById('assignmentTypeSelect').value;
            const changesDescription = document.getElementById('changesDescriptionInput').value;
            const recipientEmail = document.getElementById('recipientEmail').value;
            
            if (!recipientEmail) {
                alert('ÏàòÏã† Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            if ((assignmentType === 'REVISE' || assignmentType === 'CANCEL') && !changesDescription) {
                alert('Î≥ÄÍ≤Ω/Ï∑®ÏÜå ÏÇ¨Ïú†Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            // ÏµúÏ¢Ö ÌôïÏù∏
            let confirmMessage = '';
            if (assignmentType === 'NEW') {
                confirmMessage = `Ïã†Í∑ú ÏàòÎ∞∞ÏÑúÎ•º ${recipientEmail}Î°ú Ï†ÑÏÜ°ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`;
            } else if (assignmentType === 'REVISE') {
                confirmMessage = `ÏàòÏ†ï ÏàòÎ∞∞ÏÑúÎ•º ${recipientEmail}Î°ú Ï†ÑÏÜ°ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÎ≥ÄÍ≤ΩÏÇ¨Ïú†: ${changesDescription}`;
            } else if (assignmentType === 'CANCEL') {
                confirmMessage = `Ï∑®ÏÜå ÏàòÎ∞∞ÏÑúÎ•º ${recipientEmail}Î°ú Ï†ÑÏÜ°ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏ∑®ÏÜåÏÇ¨Ïú†: ${changesDescription}`;
            }
            
            if (!confirm(confirmMessage)) return;
            
            try {
                const response = await fetch(`/api/hotel-assignments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reservation_id: reservationId,
                        hotel_email: recipientEmail,
                        assignment_type: assignmentType,
                        changes_description: changesDescription,
                        sent_by: 'Admin'
                    })
                });
                
                const result = await response.json();
                console.log('üîç ÏàòÎ∞∞ÏÑú Ï†ÑÏÜ° ÏùëÎãµ:', result);
                console.log('üîç ÏùëÎãµ ÏÉÅÌÉú:', response.status);
                
                if (result.success) {
                    alert(`‚úÖ ÏàòÎ∞∞ÏÑúÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§!\n\nÌÉÄÏûÖ: ${assignmentType}\nÏàòÏã†: ${recipientEmail}`);
                    
                    // Î¶¨Ïä§Ìä∏ ÏÉàÎ°úÍ≥†Ïπ® (ÏÉÅÌÉú Î≥ÄÍ≤Ω Î∞òÏòÅ)
                    console.log('üîÑ Î¶¨Ïä§Ìä∏ ÏÉàÎ°úÍ≥†Ïπ® ÏãúÏûë...');
                    await loadReservations();
                    console.log('‚úÖ Î¶¨Ïä§Ìä∏ ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å');
                    
                    // Î™®Îã¨ ÏÉàÎ°úÍ≥†Ïπ® (ÏµúÏã† Ïù¥Î†• ÌëúÏãú)
                    await createAssignment(reservationId);
                    
                } else {
                    console.error('‚ùå Ï†ÑÏÜ° Ïã§Ìå®:', result);
                    alert('‚ùå Ï†ÑÏÜ° Ïã§Ìå®: ' + (result.message || result.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                }
                
            } catch (error) {
                console.error('‚ùå Ïù¥Î©îÏùº Ï†ÑÏÜ° Ïò§Î•ò:', error);
                alert('‚ùå Ï†ÑÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }
        
        // ÌôïÏ†ï - Í∞ùÏã§Î≥Ñ Ïª®ÌéåÎ≤àÌò∏ ÏûÖÎ†• Î™®Îã¨ Ïò§Ìîà
        async function confirmReservation(reservationId) {
            currentConfirmReservationId = reservationId;
            lastClosedReservationId = reservationId;
            highlightReservationRow(reservationId); // Ìï¥Îãπ ÌñâÎßå Í∞ïÏ°∞

            try {
                const response = await fetch(`/api/hotel-reservations/${reservationId}`);
                if (!response.ok) {
                    alert('ÏòàÏïΩ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.');
                    return;
                }
                const data = await response.json();

                const container = document.getElementById('confirmRoomsContainer');
                if (!container) {
                    alert('Ïª®ÌéåÎ≤àÌò∏ ÏûÖÎ†• ÏòÅÏó≠ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                    return;
                }

                const rooms = data.rooms || [];
                if (rooms.length === 0) {
                    container.innerHTML = '<p class="text-muted">Í∞ùÏã§ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                } else {
                    container.innerHTML = rooms.map((room, index) => {
                        const roomLabel = `Í∞ùÏã§ ${index + 1}`;
                        const roomType = room.hotel_room_name || room.room_type_name || '';
                        const guestSummary = (room.total_guests || room.total_guests === 0)
                            ? `${room.total_guests}Î™Ö`
                            : `${room.adults_count || 0}A ${room.children_count || 0}C ${room.infants_count || 0}I`;
                        const value = room.confirmation_number || '';
                        return `
                            <div class="border rounded p-2 mb-2" data-confirm-room-id="${room.id}">
                                <div class="small text-muted mb-1">
                                    <strong>${roomLabel}</strong> - ${roomType}
                                    ${guestSummary ? `<span class="ms-2">(${guestSummary})</span>` : ''}
                                </div>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">Ïª®ÌéåÎ≤àÌò∏</span>
                                    <input type="text" class="form-control" value="${value}" placeholder="Ïòà: 123456 / K12345">
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                const modalEl = document.getElementById('confirmModal');
                const modal = new bootstrap.Modal(modalEl);
                modal.show();

            } catch (error) {
                console.error('ÌôïÏ†ï Ï†ïÎ≥¥ Î°úÎìú Ïò§Î•ò:', error);
                alert('‚ùå Ïª®ÌéåÎ≤àÌò∏ ÏûÖÎ†• ÌôîÎ©¥ÏùÑ Ïó¨Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        async function saveConfirmationNumbers() {
            if (!currentConfirmReservationId) return;

            const container = document.getElementById('confirmRoomsContainer');
            if (!container) return;

            const roomBlocks = container.querySelectorAll('[data-confirm-room-id]');
            const rooms = [];
            roomBlocks.forEach(block => {
                const roomId = block.getAttribute('data-confirm-room-id');
                const input = block.querySelector('input');
                rooms.push({
                    id: parseInt(roomId, 10),
                    confirmation_number: input ? input.value.trim() : ''
                });
            });

            try {
                const response = await fetch(`/api/hotel-reservations/${currentConfirmReservationId}/confirm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rooms })
                });
                const result = await response.json();

                if (response.ok && result.success) {
                    alert('‚úÖ Ïª®ÌéåÎ≤àÌò∏Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
                    lastClosedReservationId = currentConfirmReservationId;
                    const modalEl = document.getElementById('confirmModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();
                    loadReservations();
                } else {
                    alert('‚ùå Ïª®ÌéåÎ≤àÌò∏ Ï†ÄÏû• Ïã§Ìå®: ' + (result.message || result.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                }
            } catch (error) {
                console.error('Ïª®ÌéåÎ≤àÌò∏ Ï†ÄÏû• Ïò§Î•ò:', error);
                alert('‚ùå Ïª®ÌéåÎ≤àÌò∏ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        // Î∞îÏö∞Ï≤ò+Ïù∏Î≥¥Ïù¥Ïä§ ÏÉùÏÑ± Î™®Îã¨ Ïò§Ìîà
        async function createVoucher(reservationId) {
            currentVoucherReservationId = reservationId;
            lastClosedReservationId = reservationId;
            currentVoucherInvoiceId = null;
            currentVoucherInvoiceLink = '';
            currentVoucherAgencyEmail = '';

            try {
                // ÏòàÏïΩ ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const response = await fetch(`/api/hotel-reservations/${reservationId}`);
                if (!response.ok) {
                    alert('ÏòàÏïΩ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.');
                    return;
                }
                const data = await response.json();

                // Î∞îÏö∞Ï≤ò TOTAL Í∏àÏï° Í≥ÑÏÇ∞ (rooms + breakfast + extras + agency_fee)
                let totalAmount = 0;
                let totalRoomCharge = 0;
                let totalBreakfastCharge = 0;
                let totalExtrasCharge = 0;
                const rooms = data.rooms || [];
                const extras = data.extras || [];
                
                // ÏàôÎ∞ï ÏùºÏàò
                const checkInDate = new Date(data.check_in_date);
                const checkOutDate = new Date(data.check_out_date);
                const nights = Math.round((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));
                
                // Ï°∞Ïãù ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÏàòÏßë
                let breakfastDetails = [];
                
                // Í∞ùÏã§ ÏöîÍ∏à
                rooms.forEach(room => {
                    let roomRate = parseFloat(room.room_rate || 0);
                    if (roomRate === 0 && room.total_selling_price && nights > 0) {
                        roomRate = parseFloat(room.total_selling_price) / nights;
                    }
                    const roomCharge = roomRate * nights;
                    totalRoomCharge += roomCharge;
                    totalAmount += roomCharge;
                    
                    // Ï°∞Ïãù ÏöîÍ∏à
                    const isBreakfastIncluded = room.breakfast_included === true || room.breakfast_included === 'true' || room.breakfast_included === 1;
                    if (isBreakfastIncluded) {
                        const adultCount = parseInt(room.breakfast_adult_count || 0);
                        const childCount = parseInt(room.breakfast_child_count || 0);
                        const adultPrice = parseFloat(room.breakfast_adult_price || 0);
                        const childPrice = parseFloat(room.breakfast_child_price || 0);
                        const breakfastDays = parseInt(room.breakfast_days || nights);
                        
                        const breakfastCharge = (adultCount * breakfastDays * adultPrice) + (childCount * breakfastDays * childPrice);
                        totalBreakfastCharge += breakfastCharge;
                        totalAmount += breakfastCharge;
                        
                        if (breakfastCharge > 0) {
                            let detail = '';
                            if (adultCount > 0) detail += `ÏÑ±Ïù∏ ${adultCount}Î™Ö x $${adultPrice} x ${breakfastDays}Ïùº`;
                            if (childCount > 0) {
                                if (detail) detail += ' + ';
                                detail += `ÏÜåÏïÑ ${childCount}Î™Ö x $${childPrice} x ${breakfastDays}Ïùº`;
                            }
                            breakfastDetails.push(detail);
                        }
                    }
                });
                
                // Ï∂îÍ∞Ä ÏÑúÎπÑÏä§ (IN_HOTEL + OUT_HOTEL Î™®Îëê Ìè¨Ìï®)
                let extrasDetails = [];
                extras.forEach(extra => {
                    const charge = parseFloat(extra.charge || extra.total_selling_price || 0);
                    totalExtrasCharge += charge;
                    totalAmount += charge;
                    if (charge > 0) {
                        extrasDetails.push(`${extra.service_name || extra.extra_name || 'Ï∂îÍ∞ÄÌï≠Î™©'}: $${charge.toFixed(2)}`);
                    }
                });
                
                // ÏàòÎ∞∞Ìîº (Î∞îÏö∞Ï≤òÏóê Ìè¨Ìï®)
                const agencyFee = parseFloat(data.agency_fee || 0);
                totalAmount += agencyFee;
                
                voucherBaseAmountUSD = totalAmount;

                // ÏµúÏã† USD ÌôòÏú® Ï°∞Ìöå
                voucherFxRate = 1300;
                let fxText = '';
                try {
                    const rateRes = await fetch('/api/exchange-rates?currency=USD');
                    const rateJson = await rateRes.json();
                    if (rateJson.success && rateJson.data && rateJson.data.length > 0) {
                        voucherFxRate = parseFloat(rateJson.data[0].rate) || 1300;
                        const rateDate = rateJson.data[0].rate_date;
                        fxText = `ÌôòÏú®: 1 USD = ${voucherFxRate.toLocaleString('ko-KR')} KRW${rateDate ? ` (${rateDate})` : ''}`;
                    } else {
                        fxText = `ÌôòÏú® Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌï¥ Í∏∞Î≥∏Í∞í ${voucherFxRate.toLocaleString('ko-KR')} KRW ÏÇ¨Ïö©`;
                    }
                } catch (e) {
                    console.error('Î∞îÏö∞Ï≤òÏù∏Î≥¥Ïù¥Ïä§ ÌôòÏú® Ï°∞Ìöå Ïò§Î•ò:', e);
                    fxText = `ÌôòÏú® Ï°∞Ìöå Ïò§Î•ò, Í∏∞Î≥∏Í∞í ${voucherFxRate.toLocaleString('ko-KR')} KRW ÏÇ¨Ïö©`;
                }

                // ÏÉàÎ°úÏö¥ UI ÏöîÏÜåÎì§ ÏóÖÎç∞Ïù¥Ìä∏
                const baseInput = document.getElementById('voucherBaseAmount');
                const discountInput = document.getElementById('voucherDiscount');
                const surchargeInput = document.getElementById('voucherSurcharge');
                const fxLabel = document.getElementById('voucherFxRateLabel');
                
                // ÏòàÏïΩ Ï†ïÎ≥¥ ÏöîÏïΩ ÏóÖÎç∞Ïù¥Ìä∏
                const guestName = data.rooms && data.rooms[0] && data.rooms[0].guests && data.rooms[0].guests[0]
                    ? (data.rooms[0].guests[0].guest_name_ko || data.rooms[0].guests[0].guest_name_en || '')
                    : '';
                document.getElementById('invoiceReservationNumber').textContent = data.reservation_number || '-';
                document.getElementById('invoiceGuestName').textContent = guestName || '-';
                document.getElementById('invoiceHotelName').textContent = data.hotel_name || '-';
                document.getElementById('invoiceCheckIn').textContent = data.check_in_date ? new Date(data.check_in_date).toLocaleDateString('ko-KR') : '-';

                if (baseInput) baseInput.value = voucherBaseAmountUSD.toFixed(2);
                if (discountInput) discountInput.value = '0';
                if (surchargeInput) surchargeInput.value = '0';
                if (fxLabel) fxLabel.textContent = fxText;

                // Ïù¥Î©îÏùº ÏûêÎèô ÏûÖÎ†•
                currentVoucherAgencyEmail = data.agency_contact_email || data.agency_email || '';
                if (currentVoucherAgencyEmail) {
                    document.getElementById('invoiceRecipientEmail').value = currentVoucherAgencyEmail;
                }
                
                // Í∏àÏï° ÏÉÅÏÑ∏ ÎÇ¥Ïó≠ ÌëúÏãú
                document.getElementById('voucherRoomChargeDisplay').textContent = '$' + totalRoomCharge.toFixed(2);
                document.getElementById('voucherBreakfastChargeDisplay').textContent = '$' + totalBreakfastCharge.toFixed(2);
                document.getElementById('voucherBreakfastDetail').textContent = breakfastDetails.length > 0 ? breakfastDetails.join(', ') : 'Ï°∞Ïãù ÎØ∏Ìè¨Ìï®';
                document.getElementById('voucherExtrasChargeDisplay').textContent = '$' + totalExtrasCharge.toFixed(2);
                document.getElementById('voucherExtrasDetail').textContent = extrasDetails.length > 0 ? extrasDetails.join(', ') : 'Ï∂îÍ∞ÄÌï≠Î™© ÏóÜÏùå';
                document.getElementById('voucherAgencyFeeDisplay').textContent = '$' + agencyFee.toFixed(2);
                document.getElementById('voucherAgencyNameDisplay').textContent = data.booking_agency_name || data.agency_name || '-';
                document.getElementById('voucherTotalUSD').textContent = '$' + voucherBaseAmountUSD.toFixed(2);
                document.getElementById('voucherTotalKRW').textContent = '‚Ç©' + (voucherBaseAmountUSD * voucherFxRate).toLocaleString('ko-KR', {maximumFractionDigits: 0});
                
                // ÌîÑÎ°úÏÑ∏Ïä§ Ï¥àÍ∏∞Ìôî
                updateProcessStep(1, 'success'); // Í∏àÏï° ÌôïÏù∏ ÏôÑÎ£å
                document.getElementById('btnSendEmail').disabled = true;

                // Í∏∞Ï°¥ Î∞îÏö∞Ï≤òÏù∏Î≥¥Ïù¥Ïä§Í∞Ä ÏûàÎäîÏßÄ Ï°∞Ìöå (Ïù∏Î≥¥Ïù¥Ïä§ Î™©Î°ù ÌëúÏãúÏö©)
                let hasExistingInvoice = false;
                try {
                    const invRes = await fetch(`/api/hotel-assignments/${reservationId}/invoice`);
                    if (invRes.ok) {
                        const invJson = await invRes.json();
                        if (invJson && invJson.success && invJson.invoice) {
                            hasExistingInvoice = true;
                            const invoice = invJson.invoice;

                            currentVoucherInvoiceId = invoice.id;
                            currentVoucherInvoiceLink = `${window.location.origin}/api/hotel-assignments/invoice/${invoice.id}/preview`;
                            
                            // ÌîÑÎ°úÏÑ∏Ïä§ Îã®Í≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ (Ïù¥ÎØ∏ ÏÉùÏÑ±Îêú Ïù∏Î≥¥Ïù¥Ïä§Í∞Ä ÏûàÏùå)
                            updateProcessStep(2, 'success');
                            document.getElementById('btnSendEmail').disabled = false;
                            
                            // ‚ö†Ô∏è Ï£ºÏùò: Í∏∞Ï°¥ Ïù∏Î≥¥Ïù¥Ïä§Í∞Ä ÏûàÏñ¥ÎèÑ Ìï≠ÏÉÅ ÏµúÏã† ÏòàÏïΩ Îç∞Ïù¥ÌÑ∞Î°ú Í∏àÏï°ÏùÑ Îã§Ïãú Í≥ÑÏÇ∞Ìï©ÎãàÎã§
                            // ÏòàÏïΩ ÏàòÏ†ï ÌõÑ Ïù∏Î≥¥Ïù¥Ïä§Î•º ÏÇ≠Ï†úÌïòÍ≥† Ïû¨ÏÉùÏÑ±ÌïòÎäî Í≤ΩÏö∞Î•º ÏúÑÌï®
                            console.log('‚ö†Ô∏è Í∏∞Ï°¥ Ïù∏Î≥¥Ïù¥Ïä§ Ï°¥Ïû¨ - ÌïòÏßÄÎßå ÏµúÏã† ÏòàÏïΩ Îç∞Ïù¥ÌÑ∞Î°ú Í∏àÏï° Ïû¨Í≥ÑÏÇ∞');
                        }
                    }
                } catch (e) {
                    console.error('Î∞îÏö∞Ï≤ò Ïù∏Î≥¥Ïù¥Ïä§ Ï°∞Ìöå Ïò§Î•ò:', e);
                }
                
                // Ïù∏Î≥¥Ïù¥Ïä§ Î™©Î°ù Î°úÎìú
                await loadVoucherInvoicesList(reservationId);

                updateVoucherInvoiceTotals();

                const modalEl = document.getElementById('voucherInvoiceModal');
                
                // ‚≠ê Bootstrap Î™®Îã¨Ïùò body Ïä§ÌÉÄÏùº Î≥ÄÍ≤ΩÏùÑ ÏôÑÏ†ÑÌûà Ï∞®Îã®
                const originalPadding = document.body.style.paddingRight || '';
                const originalOverflow = document.body.style.overflow || '';
                
                // MutationObserverÎ°ú body Ïä§ÌÉÄÏùº Î≥ÄÍ≤Ω Í∞êÏãú Î∞è Ï¶âÏãú Î≥µÍµ¨
                const bodyObserver = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            // body Ïä§ÌÉÄÏùºÏù¥ Î≥ÄÍ≤ΩÎêòÎ©¥ Ï¶âÏãú ÏõêÎûòÎåÄÎ°ú Î≥µÍµ¨
                            if (document.body.style.paddingRight !== originalPadding) {
                                document.body.style.paddingRight = originalPadding;
                            }
                            if (document.body.style.overflow !== originalOverflow) {
                                document.body.style.overflow = originalOverflow;
                            }
                        }
                    });
                });
                
                // body Í∞êÏãú ÏãúÏûë
                bodyObserver.observe(document.body, {
                    attributes: true,
                    attributeFilter: ['style', 'class']
                });
                
                // Bootstrap Î™®Îã¨ ÏÉùÏÑ±
                const modal = new bootstrap.Modal(modalEl, {
                    backdrop: true,
                    keyboard: true,
                    focus: true
                });
                
                // Î™®Îã¨Ïù¥ Ïó¥Î¶¨Îäî Ï§ëÏóêÎèÑ padding Ïú†ÏßÄ
                const preventPaddingChange = function(e) {
                    document.body.style.paddingRight = originalPadding;
                    document.body.style.overflow = originalOverflow;
                };
                
                // Î™®Îã¨Ïù¥ ÏôÑÏ†ÑÌûà Ïó¥Î¶∞ ÌõÑ Ïù∏Î≥¥Ïù¥Ïä§ Î™©Î°ù Î°úÎìú
                const onModalShown = async function() {
                    // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†úÍ±∞
                    modalEl.removeEventListener('show.bs.modal', preventPaddingChange);
                    modalEl.removeEventListener('shown.bs.modal', preventPaddingChange);
                    modalEl.removeEventListener('shown.bs.modal', onModalShown);
                    
                    // padding ÏµúÏ¢Ö ÌôïÏù∏
                    document.body.style.paddingRight = originalPadding;
                    
                    // Ïù∏Î≥¥Ïù¥Ïä§ Î™©Î°ù Î°úÎìú (Î™®Îã¨ Ïó¥Î¶∞ ÌõÑ)
                    await loadVoucherInvoicesList(reservationId);
                    
                    // Î™©Î°ù Î°úÎìú ÌõÑ Ìñâ Í∞ïÏ°∞
                    setTimeout(() => {
                        highlightReservationRow(reservationId);
                    }, 200);
                };
                
                // Î™®Îã¨Ïù¥ Îã´Ìûê Îïå Ï†ïÎ¶¨
                const onModalHidden = function() {
                    modalEl.removeEventListener('hidden.bs.modal', onModalHidden);
                    // Observer Ï§ëÏßÄ
                    bodyObserver.disconnect();
                    // ÏõêÎûò ÏÉÅÌÉú Î≥µÍµ¨
                    document.body.style.paddingRight = originalPadding;
                    document.body.style.overflow = originalOverflow;
                };
                
                // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù (Î™®Îã¨ Ïó¥Í∏∞ Ï†ÑÏóê)
                modalEl.addEventListener('show.bs.modal', preventPaddingChange);
                modalEl.addEventListener('shown.bs.modal', preventPaddingChange);
                modalEl.addEventListener('shown.bs.modal', onModalShown);
                modalEl.addEventListener('hidden.bs.modal', onModalHidden);
                
                // Î™®Îã¨ Ïó¥Í∏∞
                modal.show();

            } catch (error) {
                console.error('Î∞îÏö∞Ï≤òÏù∏Î≥¥Ïù¥Ïä§ ÏÉùÏÑ± Ï§ÄÎπÑ Ïò§Î•ò:', error);
                alert('‚ùå Î∞îÏö∞Ï≤òÏù∏Î≥¥Ïù¥Ïä§ ÏÉùÏÑ± ÌôîÎ©¥ÏùÑ Ïó¨Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        function updateVoucherInvoiceTotals() {
            const finalUSDInput = document.getElementById('voucherFinalAmountUSD');
            const finalKRWInput = document.getElementById('voucherFinalAmountKRW');
            const krwRow = document.getElementById('voucherFinalKRWRow');

            // Ïù∏Î≥¥Ïù¥Ïä§ ÏµúÏ¢Ö Í∏àÏï°ÏùÄ ÏôºÏ™Ω ÎØ∏Î¶¨Î≥¥Í∏∞ TOTAL(ÏòàÏïΩÏùò Ï¥ù ÌåêÎß§Í∞Ä/Í∑∏ÎûúÎìúÌÜ†ÌÉà) Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
            const finalUSD = voucherBaseAmountUSD || 0;
            if (finalUSDInput) finalUSDInput.value = finalUSD.toFixed(2);

            if (!finalKRWInput || !krwRow) return;

            const fx = voucherFxRate || 1300;
            const finalKRW = finalUSD * fx;
            finalKRWInput.value = Math.round(finalKRW).toLocaleString('ko-KR');
            krwRow.style.display = '';
        }

        async function saveVoucherInvoice() {
            if (!currentVoucherReservationId) {
                alert('ÏòàÏïΩ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }

            const discountInput = document.getElementById('voucherDiscount');
            const surchargeInput = document.getElementById('voucherSurcharge');

            const discount = parseFloat(discountInput && discountInput.value ? discountInput.value : 0) || 0;
            const surcharge = parseFloat(surchargeInput && surchargeInput.value ? surchargeInput.value : 0) || 0;

            try {
                const response = await fetch(`/api/hotel-assignments/${currentVoucherReservationId}/invoice`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        discount_usd: discount,
                        surcharge_usd: surcharge
                    })
                });
                const result = await response.json();

                if (response.ok && result.success) {
                    // ÌîÑÎ°úÏÑ∏Ïä§ Îã®Í≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                    updateProcessStep(2, 'success');
                    
                    alert('‚úÖ Î∞îÏö∞Ï≤òÏù∏Î≥¥Ïù¥Ïä§Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.');
                    lastClosedReservationId = currentVoucherReservationId;
                    
                    // Ïù∏Î≥¥Ïù¥Ïä§ Î™©Î°ù Îã§Ïãú Î°úÎìú
                    await loadVoucherInvoicesList(currentVoucherReservationId);
                    
                    // Ïù¥Î©îÏùº Ï†ÑÏÜ° Î≤ÑÌäº ÌôúÏÑ±Ìôî
                    document.getElementById('btnSendEmail').disabled = false;
                    
                    // ÏòàÏïΩ Î™©Î°ù Í∞±Ïã† (Î™®Îã¨Ïù¥ Ïó¥Î†§ÏûàÏúºÎ©¥ Ïä§ÌÇµ)
                    await loadReservations();
                } else {
                    alert('‚ùå Î∞îÏö∞Ï≤òÏù∏Î≥¥Ïù¥Ïä§ ÏÉùÏÑ± Ïã§Ìå®: ' + (result.message || result.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                }
            } catch (error) {
                console.error('Î∞îÏö∞Ï≤òÏù∏Î≥¥Ïù¥Ïä§ ÏÉùÏÑ± Ïò§Î•ò:', error);
                alert('‚ùå Î∞îÏö∞Ï≤òÏù∏Î≥¥Ïù¥Ïä§ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        // ÌîÑÎ°úÏÑ∏Ïä§ Îã®Í≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateProcessStep(step, status) {
            const stepEl = document.getElementById(`step${step}`);
            const statusEl = document.getElementById(`step${step}Status`);
            const iconEl = stepEl.querySelector('.step-icon i');
            
            if (status === 'success') {
                iconEl.classList.remove('text-muted', 'text-primary');
                iconEl.classList.add('text-success');
                statusEl.innerHTML = '<span class="badge bg-success">ÏôÑÎ£å</span>';
            } else if (status === 'progress') {
                iconEl.classList.remove('text-muted');
                iconEl.classList.add('text-primary');
                statusEl.innerHTML = '<span class="badge bg-primary">ÏßÑÌñâÏ§ë</span>';
            }
        }
        
        // Ïù∏Î≥¥Ïù¥Ïä§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
        function refreshInvoiceList() {
            if (currentVoucherReservationId) {
                loadVoucherInvoicesList(currentVoucherReservationId);
            }
        }
        
        // Ïù¥Î©îÏùº Ï†ÑÏÜ°
        async function sendInvoiceEmail() {
            const email = document.getElementById('invoiceRecipientEmail').value;
            const subject = document.getElementById('invoiceEmailSubject').value;
            const message = document.getElementById('invoiceEmailMessage').value;
            
            if (!email) {
                alert('Î∞õÎäî ÏÇ¨Îûå Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            if (!currentVoucherReservationId) {
                alert('ÏòàÏïΩ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            updateProcessStep(3, 'progress');
            
            try {
                // TODO: Ïù¥Î©îÏùº Ï†ÑÏÜ° API Ìò∏Ï∂ú
                const response = await fetch(`/api/hotel-assignments/${currentVoucherReservationId}/invoice/send-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        recipient_email: email,
                        subject: subject,
                        message: message
                    })
                });
                
                if (response.ok) {
                    updateProcessStep(3, 'success');
                    updateProcessStep(4, 'success');
                    alert('‚úÖ Ïù¥Î©îÏùºÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§!');
                } else {
                    throw new Error('Ïù¥Î©îÏùº Ï†ÑÏÜ° Ïã§Ìå®');
                }
            } catch (error) {
                console.error('Ïù¥Î©îÏùº Ï†ÑÏÜ° Ïò§Î•ò:', error);
                alert('‚ùå Ïù¥Î©îÏùº Ï†ÑÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }
        
        // Î∞îÏö∞Ï≤ò Ïù∏Î≥¥Ïù¥Ïä§ Î™©Î°ù Î°úÎìú
        async function loadVoucherInvoicesList(reservationId) {
            try {
                const response = await fetch(`/api/hotel-assignments/${reservationId}/invoices`);
                const result = await response.json();
                
                const listContainer = document.getElementById('voucherInvoicesList');
                
                if (result.success && result.invoices && result.invoices.length > 0) {
                    let html = '<div class="list-group list-group-flush">';
                    
                    result.invoices.forEach((invoice, index) => {
                        const invoiceDate = new Date(invoice.created_at).toLocaleDateString('ko-KR');
                        const link = `${window.location.origin}/api/hotel-assignments/invoice/${invoice.id}/preview`;
                        
                        html += `
                            <div class="list-group-item list-group-item-action">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-1">
                                            <span class="badge bg-success me-2">#${invoice.id}</span>
                                            <strong>${invoice.invoice_number || 'N/A'}</strong>
                                        </div>
                                        <div class="small text-muted">
                                            <i class="fas fa-calendar me-1"></i>${invoiceDate}
                                            <span class="mx-2">|</span>
                                            <i class="fas fa-dollar-sign me-1"></i>$${parseFloat(invoice.total_amount || 0).toFixed(2)}
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteVoucherInvoice(${invoice.id}); event.stopPropagation();" title="ÏÇ≠Ï†ú">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="window.open('${link}', '_blank'); event.stopPropagation();">
                                        <i class="fas fa-external-link-alt me-1"></i>ÏÉà Ï∞ΩÏóêÏÑú Î≥¥Í∏∞
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="copyInvoiceLink('${link}'); event.stopPropagation();">
                                        <i class="fas fa-copy me-1"></i>ÎßÅÌÅ¨ Î≥µÏÇ¨
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    listContainer.innerHTML = html;
                } else {
                    listContainer.innerHTML = `
                        <div class="text-center text-muted p-4">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p class="mb-0 small">ÏïÑÏßÅ Î∞úÌñâÎêú Ïù∏Î≥¥Ïù¥Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Ïù∏Î≥¥Ïù¥Ïä§ Î™©Î°ù Î°úÎìú Ïò§Î•ò:', error);
            }
        }
        
        // Ïù∏Î≥¥Ïù¥Ïä§ ÎßÅÌÅ¨ Î≥µÏÇ¨
        function copyInvoiceLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                alert('‚úÖ ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!');
            }).catch(err => {
                console.error('Î≥µÏÇ¨ Ïã§Ìå®:', err);
                alert('‚ùå ÎßÅÌÅ¨ Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            });
        }
        
        // Ïù∏Î≥¥Ïù¥Ïä§ ÎØ∏Î¶¨Î≥¥Í∏∞ Î°úÎìú
        async function loadInvoicePreview(invoiceId, link) {
            try {
                const previewContainer = document.getElementById('voucherInvoicePreview');
                if (previewContainer) {
                    // iframeÏúºÎ°ú Í≤©Î¶¨ÌïòÏó¨ Ïô∏Î∂Ä Ïä§ÌÉÄÏùºÏóê ÏòÅÌñ• Î∞©ÏßÄ
                    previewContainer.innerHTML = `
                        <iframe src="${link}" 
                                style="width: 100%; min-height: 800px; border: none; background: white;"
                                onload="this.style.height = (this.contentWindow.document.body.scrollHeight + 50) + 'px'">
                        </iframe>
                    `;
                }
            } catch (error) {
                console.error('ÎØ∏Î¶¨Î≥¥Í∏∞ Î°úÎìú Ïò§Î•ò:', error);
                alert('‚ùå ÎØ∏Î¶¨Î≥¥Í∏∞ Î°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }
        
        // Ïù∏Î≥¥Ïù¥Ïä§ ÏÇ≠Ï†ú
        async function deleteVoucherInvoice(invoiceId) {
            if (!confirm('Ïù¥ Ïù∏Î≥¥Ïù¥Ïä§Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/hotel-assignments/invoice/${invoiceId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Ïù∏Î≥¥Ïù¥Ïä§Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                    
                    // Ïù∏Î≥¥Ïù¥Ïä§ Î™©Î°ù Í∞±Ïã†
                    await loadVoucherInvoicesList(currentVoucherReservationId);
                    
                    // ‚≠ê ÏµúÏã† ÏòàÏïΩ Îç∞Ïù¥ÌÑ∞Î°ú Í∏àÏï° ÏÉÅÏÑ∏ ÎÇ¥Ïó≠ Ïû¨Í≥ÑÏÇ∞
                    await refreshVoucherAmountDetails(currentVoucherReservationId);
                    
                    // ÌîÑÎ°úÏÑ∏Ïä§ Ï¥àÍ∏∞Ìôî
                    updateProcessStep(1, 'success');
                    updateProcessStep(2, 'progress'); // Ïù∏Î≥¥Ïù¥Ïä§ ÏÇ≠Ï†úÎê®
                    document.getElementById('btnSendEmail').disabled = true;
                    
                    // ÏòàÏïΩ Î™©Î°ù Í∞±Ïã† (Î±ÉÏßÄ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏)
                    await loadReservations();
                    
                    // Î™©Î°ù Î°úÎìú ÌõÑ Ìñâ Í∞ïÏ°∞ Îã§Ïãú Ï†ÅÏö©
                    setTimeout(() => {
                        highlightReservationRow(currentVoucherReservationId);
                    }, 800);
                } else{
                    alert('‚ùå ÏÇ≠Ï†ú Ïã§Ìå®: ' + (result.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                }
            } catch (error) {
                console.error('Ïù∏Î≥¥Ïù¥Ïä§ ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                alert('‚ùå ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        // Í∏àÏï° ÏÉÅÏÑ∏ ÎÇ¥Ïó≠ ÏÉàÎ°úÍ≥†Ïπ®
        async function refreshVoucherAmountDetails(reservationId) {
            try {
                const response = await fetch(`/api/hotel-reservations/${reservationId}`);
                if (!response.ok) return;
                
                const data = await response.json();
                
                // Í∏àÏï° Ïû¨Í≥ÑÏÇ∞
                let totalAmount = 0;
                let totalRoomCharge = 0;
                let totalBreakfastCharge = 0;
                let totalExtrasCharge = 0;
                const rooms = data.rooms || [];
                const extras = data.extras || [];
                
                const checkInDate = new Date(data.check_in_date);
                const checkOutDate = new Date(data.check_out_date);
                const nights = Math.round((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));
                
                let breakfastDetails = [];
                
                // Í∞ùÏã§ ÏöîÍ∏à
                rooms.forEach(room => {
                    let roomRate = parseFloat(room.room_rate || 0);
                    if (roomRate === 0 && room.total_selling_price && nights > 0) {
                        roomRate = parseFloat(room.total_selling_price) / nights;
                    }
                    const roomCharge = roomRate * nights;
                    totalRoomCharge += roomCharge;
                    totalAmount += roomCharge;
                    
                    // Ï°∞Ïãù ÏöîÍ∏à
                    const isBreakfastIncluded = room.breakfast_included === true || room.breakfast_included === 'true' || room.breakfast_included === 1;
                    if (isBreakfastIncluded) {
                        const adultCount = parseInt(room.breakfast_adult_count || 0);
                        const childCount = parseInt(room.breakfast_child_count || 0);
                        const adultPrice = parseFloat(room.breakfast_adult_price || 0);
                        const childPrice = parseFloat(room.breakfast_child_price || 0);
                        const breakfastDays = parseInt(room.breakfast_days || nights);
                        
                        const breakfastCharge = (adultCount * breakfastDays * adultPrice) + (childCount * breakfastDays * childPrice);
                        totalBreakfastCharge += breakfastCharge;
                        totalAmount += breakfastCharge;
                        
                        if (breakfastCharge > 0) {
                            let detail = '';
                            if (adultCount > 0) detail += `ÏÑ±Ïù∏ ${adultCount}Î™Ö x $${adultPrice} x ${breakfastDays}Ïùº`;
                            if (childCount > 0) {
                                if (detail) detail += ' + ';
                                detail += `ÏÜåÏïÑ ${childCount}Î™Ö x $${childPrice} x ${breakfastDays}Ïùº`;
                            }
                            breakfastDetails.push(detail);
                        }
                    }
                });
                
                // Ï∂îÍ∞Ä ÏÑúÎπÑÏä§
                let extrasDetails = [];
                extras.forEach(extra => {
                    const charge = parseFloat(extra.charge || extra.total_selling_price || 0);
                    totalExtrasCharge += charge;
                    totalAmount += charge;
                    if (charge > 0) {
                        extrasDetails.push(`${extra.service_name || extra.extra_name || 'Ï∂îÍ∞ÄÌï≠Î™©'}: $${charge.toFixed(2)}`);
                    }
                });
                
                // ÏàòÎ∞∞Ìîº
                const agencyFee = parseFloat(data.agency_fee || 0);
                totalAmount += agencyFee;
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                document.getElementById('voucherRoomChargeDisplay').textContent = '$' + totalRoomCharge.toFixed(2);
                document.getElementById('voucherBreakfastChargeDisplay').textContent = '$' + totalBreakfastCharge.toFixed(2);
                document.getElementById('voucherBreakfastDetail').textContent = breakfastDetails.length > 0 ? breakfastDetails.join(', ') : 'Ï°∞Ïãù ÎØ∏Ìè¨Ìï®';
                document.getElementById('voucherExtrasChargeDisplay').textContent = '$' + totalExtrasCharge.toFixed(2);
                document.getElementById('voucherExtrasDetail').textContent = extrasDetails.length > 0 ? extrasDetails.join(', ') : 'Ï∂îÍ∞ÄÌï≠Î™© ÏóÜÏùå';
                document.getElementById('voucherAgencyFeeDisplay').textContent = '$' + agencyFee.toFixed(2);
                document.getElementById('voucherAgencyNameDisplay').textContent = data.booking_agency_name || data.agency_name || '-';
                document.getElementById('voucherTotalUSD').textContent = '$' + totalAmount.toFixed(2);
                document.getElementById('voucherTotalKRW').textContent = '‚Ç©' + (totalAmount * voucherFxRate).toLocaleString('ko-KR', {maximumFractionDigits: 0});
                
                // hidden input ÏóÖÎç∞Ïù¥Ìä∏
                document.getElementById('voucherBaseAmount').value = totalAmount.toFixed(2);
                voucherBaseAmountUSD = totalAmount;
                
                console.log('‚úÖ Í∏àÏï° ÏÉÅÏÑ∏ ÎÇ¥Ïó≠ Í∞±Ïã† ÏôÑÎ£å:', totalAmount);
            } catch (error) {
                console.error('Í∏àÏï° ÏÉÅÏÑ∏ ÎÇ¥Ïó≠ Í∞±Ïã† Ïò§Î•ò:', error);
            }
        }
        
        function openVoucherInvoicePreview(invoiceId) {
            if (!invoiceId) {
                alert('Ïù∏Î≥¥Ïù¥Ïä§ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            const url = `/api/hotel-assignments/invoice/${invoiceId}/preview`;
            window.open(url, '_blank', 'width=900,height=900');
        }
        
        function previewVoucherInvoice() {
            if (!currentVoucherInvoiceId) {
                alert('Î®ºÏ†Ä Î∞îÏö∞Ï≤ò Ïù∏Î≥¥Ïù¥Ïä§Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            openVoucherInvoicePreview(currentVoucherInvoiceId);
        }

        function copyVoucherInvoiceLink() {
            if (!currentVoucherInvoiceLink) {
                alert('Î®ºÏ†Ä Î∞îÏö∞Ï≤ò Ïù∏Î≥¥Ïù¥Ïä§Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            const linkInput = document.getElementById('voucherInvoiceLinkInput');
            if (linkInput) {
                linkInput.select();
                linkInput.setSelectionRange(0, 99999);
            }
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(currentVoucherInvoiceLink).then(() => {
                    alert('Ïù∏Î≥¥Ïù¥Ïä§ ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.');
                }).catch(() => {
                    alert('ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÏûÖÎ†•Ï∞ΩÏóêÏÑú ÏßÅÏ†ë Î≥µÏÇ¨Ìï¥Ï£ºÏÑ∏Ïöî.');
                });
            } else {
                alert('Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú ÏûêÎèô Î≥µÏÇ¨Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§. ÏûÖÎ†•Ï∞ΩÏóêÏÑú ÏßÅÏ†ë Î≥µÏÇ¨Ìï¥Ï£ºÏÑ∏Ïöî.');
            }
        }

        function sendVoucherInvoiceEmail() {
            if (!currentVoucherInvoiceLink) {
                alert('Î®ºÏ†Ä Î∞îÏö∞Ï≤ò Ïù∏Î≥¥Ïù¥Ïä§Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            const recipient = currentVoucherAgencyEmail || '';
            const subject = encodeURIComponent('[LUXFIND] Hotel Voucher Invoice');
            const body = encodeURIComponent(
                'ÏïàÎÖïÌïòÏÑ∏Ïöî,\n\n' +
                'ÏïÑÎûò ÎßÅÌÅ¨ÏóêÏÑú Ìò∏ÌÖî Î∞îÏö∞Ï≤ò Ïù∏Î≥¥Ïù¥Ïä§Î•º ÌôïÏù∏ÌïòÏã§ Ïàò ÏûàÏäµÎãàÎã§.\n' +
                currentVoucherInvoiceLink +
                '\n\nÍ∞êÏÇ¨Ìï©ÎãàÎã§.'
            );
            const mailtoUrl = `mailto:${recipient}?subject=${subject}&body=${body}`;
            window.location.href = mailtoUrl;
        }
        
        // Ï†ïÏÇ∞ Ïù¥Í¥Ä
        function createSettlement(reservationId) {
            if (confirm('Ï†ïÏÇ∞ÏúºÎ°ú Ïù¥Í¥ÄÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                alert('Ï†ïÏÇ∞ Ïù¥Í¥Ä Í∏∞Îä•ÏùÄ Í≥ß Ï∂îÍ∞ÄÎê©ÎãàÎã§.');
            }
        }
    </script>
</body>
</html>