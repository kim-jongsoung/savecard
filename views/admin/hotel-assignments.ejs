<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - ê´Œì„¸ì´ë¸Œì¹´ë“œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* ëª¨ë‹¬ ë‚´ë¶€ëŠ” ì¸ë°•ìŠ¤ì™€ ë™ì¼í•œ í°íŠ¸ í¬ê¸° (30% ì¶•ì†Œ) */
        body {
            font-size: 0.8rem;
            background: #f5f7fa;
        }
        
        /* ëª¨ë‹¬ ì „ìš© ìŠ¤íƒ€ì¼ - ì¸ë°•ìŠ¤ì™€ ë™ì¼ */
        .modal-body .form-label {
            font-size: 0.7rem !important;
            margin-bottom: 0.25rem;
        }
        .modal-body .form-control, .modal-body .form-select {
            font-size: 0.7rem !important;
            padding: 0.25rem 0.5rem !important;
        }
        .modal-body h2 {
            font-size: 1.4rem !important;
        }
        .modal-body h5 {
            font-size: 0.875rem !important;
        }
        .modal-body h6 {
            font-size: 0.75rem !important;
        }
        .modal-body .btn {
            font-size: 0.7rem !important;
            padding: 0.375rem 0.75rem !important;
        }
        
        .stats-card {
            border-radius: 12px;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .reservation-table {
            width: 100% !important;
            background: white !important;
            border-radius: 8px !important;
            overflow: hidden !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
            position: relative !important;
            margin: 0 !important;
        }
        .reservation-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
        }
        .reservation-table th {
            padding: 12px 8px !important;
            font-size: 0.75rem !important;
            font-weight: 600 !important;
            text-align: center !important;
            white-space: nowrap !important;
            border-right: 1px solid rgba(255,255,255,0.2) !important;
        }
        .reservation-table th:last-child {
            border-right: none !important;
        }
        .reservation-table tbody tr {
            border-bottom: 1px solid #e9ecef !important;
            transition: background 0.2s !important;
        }
        .reservation-table tbody tr:hover {
            background: #f8f9fa !important;
        }
        .reservation-table td {
            padding: 10px 8px !important;
            font-size: 0.75rem !important;
            vertical-align: middle !important;
            text-align: center !important;
            border-right: 1px solid #e9ecef !important;
        }
        .reservation-table td:last-child {
            border-right: none !important;
        }
        
        /* ë°”ìš°ì²˜ ì¸ë³´ì´ìŠ¤ ëª©ë¡ ê²©ë¦¬ - ì™¸ë¶€ í…Œì´ë¸”ì— ì˜í–¥ ë°©ì§€ */
        #voucherInvoicesList {
            isolation: isolate;
            position: relative;
        }
        
        .status-badge {
            padding: 0.35rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-processing { background: #d1ecf1; color: #0c5460; }
        .status-confirmed { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        .status-modifying { background: #e2e3e5; color: #383d41; }
        
        .action-btn {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 2px solid;
            transition: all 0.3s;
            margin: 0 4px;
            font-size: 1.2rem;
            cursor: pointer;
            background: white;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .btn-edit { border-color: #17a2b8; color: #17a2b8; }
        .btn-edit:hover { background: #17a2b8; color: white !important; }
        
        .btn-assignment { border-color: #6f42c1; color: #6f42c1; }
        .btn-assignment:hover { background: #6f42c1; color: white !important; }
        
        .btn-confirm { border-color: #28a745; color: #28a745; }
        .btn-confirm:hover { background: #28a745; color: white !important; }
        
        .btn-voucher { border-color: #fd7e14; color: #fd7e14; }
        .btn-voucher:hover { background: #fd7e14; color: white !important; }
        
        .btn-settlement { border-color: #dc3545; color: #dc3545; }
        .btn-settlement:hover { background: #dc3545; color: white !important; }
        
        .room-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }
        
        .date-info {
            background: #f8f9fa;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.75rem;
        }
        
        .search-box {
            border-radius: 25px;
            border: 2px solid #e0e0e0;
            padding: 0.5rem 1.5rem;
            transition: all 0.3s;
        }
        .search-box:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            outline: none;
        }
        
        .filter-btn {
            border-radius: 20px;
            padding: 0.4rem 1rem;
            font-size: 0.75rem;
            margin: 0 0.25rem;
            border: 2px solid #e0e0e0;
            background: white;
            transition: all 0.3s;
            cursor: pointer;
        }
        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .guest-list {
            font-size: 0.7rem;
            color: #666;
            margin-top: 0.5rem;
        }
        
        .price-tag {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .reservation-date-badge {
            background: #ffc107;
            color: #000;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        /* ì¸ë°•ìŠ¤ ìŠ¤íƒ€ì¼ ë³µì‚¬ - ëª¨ë‹¬ìš© */
        .modal-body .room-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f8f9fa;
        }
        .modal-body .room-card.active {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .modal-body .guest-card {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            background: white;
        }
        .modal-body .extra-item-card {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            background: #fff;
        }
        .modal-body .btn-add-room, 
        .modal-body .btn-add-guest, 
        .modal-body .btn-add-extra {
            border: 2px dashed #667eea;
            color: #667eea;
            background: white;
            font-weight: 600;
            transition: all 0.3s;
        }
        .modal-body .btn-add-room:hover, 
        .modal-body .btn-add-guest:hover, 
        .modal-body .btn-add-extra:hover {
            background: #667eea;
            color: white;
            border-style: solid;
        }
        .modal-body .total-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
        }
        .modal-body #status {
            font-weight: 600;
        }
        .modal-body #status option[value="pending"] {
            background-color: #fff3cd;
            color: #856404;
        }
        .modal-body #status option[value="processing"] {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .modal-body #status option[value="confirmed"] {
            background-color: #d4edda;
            color: #155724;
        }
        .modal-body #status option[value="cancelled"] {
            background-color: #f8d7da;
            color: #721c24;
        }
        .modal-body #status option[value="modifying"] {
            background-color: #e2e3e5;
            color: #383d41;
        }
        .modal-body #status.status-pending {
            background-color: #fff3cd;
            color: #856404;
            border-color: #ffc107;
        }
        .modal-body #status.status-processing {
            background-color: #d1ecf1;
            color: #0c5460;
            border-color: #17a2b8;
        }
        .modal-body #status.status-confirmed {
            background-color: #d4edda;
            color: #155724;
            border-color: #28a745;
        }
        .modal-body #status.status-cancelled {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }
        .modal-body #status.status-modifying {
            background-color: #e2e3e5;
            color: #383d41;
            border-color: #6c757d;
        }
        
        /* í”„ë¡œëª¨ì…˜ ìŠ¤íƒ€ì¼ */
        .promo-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            font-weight: 600;
            margin-left: 0.5rem;
            font-size: 0.7rem;
        }
        .rate-display {
            background: #e7f3ff;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #2196F3;
            font-size: 0.7rem;
        }
        .benefit-badge {
            background: #4CAF50;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-right: 0.5rem;
            display: inline-block;
            margin-bottom: 0.25rem;
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar') %>

    <div class="container-fluid mt-4" style="max-width: 1400px;">
        <!-- í—¤ë” -->
        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="fas fa-clipboard-list me-2"></i>í˜¸í…” ìˆ˜ë°°ê´€ë¦¬</h2>
            </div>
        </div>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div style="font-size: 0.7rem; opacity: 0.9;">ëŒ€ê¸°ì¤‘</div>
                                <div style="font-size: 1.8rem; font-weight: bold;" id="stat-pending">0</div>
                            </div>
                            <i class="fas fa-clock" style="font-size: 2.5rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div style="font-size: 0.7rem; opacity: 0.9;">ìˆ˜ë°°ì¤‘</div>
                                <div style="font-size: 1.8rem; font-weight: bold;" id="stat-processing">0</div>
                            </div>
                            <i class="fas fa-paper-plane" style="font-size: 2.5rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div style="font-size: 0.7rem; opacity: 0.9;">í™•ì •</div>
                                <div style="font-size: 1.8rem; font-weight: bold;" id="stat-confirmed">0</div>
                            </div>
                            <i class="fas fa-check-circle" style="font-size: 2.5rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-secondary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div style="font-size: 0.7rem; opacity: 0.9;">ì „ì²´</div>
                                <div style="font-size: 1.8rem; font-weight: bold;" id="stat-total">0</div>
                            </div>
                            <i class="fas fa-list" style="font-size: 2.5rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê³ ê¸‰ ê²€ìƒ‰ ë° í•„í„° -->
        <div class="card mb-4" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div class="card-body">
                <!-- ì²« ë²ˆì§¸ ì¤„: ê¸°ë³¸ ê²€ìƒ‰ -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <input type="text" class="form-control search-box" id="searchBox" placeholder="ğŸ” ì˜ˆì•½ë²ˆí˜¸, í˜¸í…”ëª…, ê³ ê°ëª…ìœ¼ë¡œ ê²€ìƒ‰..." onkeyup="filterReservations()">
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleAdvancedFilter()">
                            <i class="fas fa-filter me-1"></i>ìƒì„¸ ê²€ìƒ‰
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="resetFilters()">
                            <i class="fas fa-redo me-1"></i>ì´ˆê¸°í™”
                        </button>
                    </div>
                </div>

                <!-- ê³ ê¸‰ í•„í„° ì˜ì—­ (ì ‘ê¸°/í¼ì¹˜ê¸°) -->
                <div id="advancedFilterArea" style="display: none;">
                    <hr class="my-3">
                    <div class="row g-2">
                        <!-- ë‚ ì§œ ê²€ìƒ‰ -->
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">ë‚ ì§œ ê¸°ì¤€</label>
                            <select class="form-select form-select-sm" id="dateType">
                                <option value="check_in">ì¶œë°œì¼(ì²´í¬ì¸)</option>
                                <option value="reservation">ì˜ˆì•½ì¼</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">ì‹œì‘ì¼</label>
                            <input type="date" class="form-control form-control-sm" id="startDate">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">ì¢…ë£Œì¼</label>
                            <input type="date" class="form-control form-control-sm" id="endDate">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">ê±°ë˜ì²˜</label>
                            <select class="form-select form-select-sm" id="agencyFilter">
                                <option value="">ì „ì²´</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">êµ­ê°€/ì§€ì—­</label>
                            <select class="form-select form-select-sm" id="countryFilter">
                                <option value="">ì „ì²´</option>
                                <option value="ê´Œ">ê´Œ</option>
                                <option value="ì‚¬ì´íŒ">ì‚¬ì´íŒ</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">í˜¸í…”ëª…</label>
                            <select class="form-select form-select-sm" id="hotelFilter">
                                <option value="">ì „ì²´</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">ë‹´ë‹¹ì</label>
                            <select class="form-select form-select-sm" id="assignedToFilter">
                                <option value="">ì „ì²´</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem;">&nbsp;</label>
                            <button class="btn btn-sm btn-primary w-100" onclick="filterReservations()">
                                <i class="fas fa-search me-1"></i>ê²€ìƒ‰
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ìƒíƒœ í•„í„° ë²„íŠ¼ -->
                <div class="mt-3 d-flex justify-content-center flex-wrap gap-2">
                    <button class="filter-btn active" data-status="all" onclick="filterByStatus('all')">
                        <i class="fas fa-list me-1"></i>ì „ì²´
                    </button>
                    <button class="filter-btn" data-status="pending" onclick="filterByStatus('pending')">
                        <i class="fas fa-clock me-1"></i>ëŒ€ê¸°ì¤‘
                    </button>
                    <button class="filter-btn" data-status="processing" onclick="filterByStatus('processing')">
                        <i class="fas fa-paper-plane me-1"></i>ìˆ˜ë°°ì¤‘
                    </button>
                    <button class="filter-btn" data-status="confirmed" onclick="filterByStatus('confirmed')">
                        <i class="fas fa-check me-1"></i>í™•ì •
                    </button>
                    <button class="filter-btn" data-status="modifying" onclick="filterByStatus('modifying')">
                        <i class="fas fa-edit me-1"></i>ìˆ˜ì •ì¤‘
                    </button>
                    <button class="filter-btn" data-status="cancelled" onclick="filterByStatus('cancelled')">
                        <i class="fas fa-times me-1"></i>ì·¨ì†Œ
                    </button>
                </div>
            </div>
        </div>

        <!-- ì˜ˆì•½ ë¦¬ìŠ¤íŠ¸ -->
        <div id="reservationsContainer">
            <!-- ì˜ˆì•½ ì¹´ë“œê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
        </div>

        <!-- ë¡œë”© -->
        <div id="loading" class="text-center py-5" style="display: none;">
            <i class="fas fa-spinner fa-spin fa-3x text-primary"></i>
            <p class="mt-3">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <!-- ë¹ˆ ìƒíƒœ -->
        <div id="emptyState" class="text-center py-5" style="display: none;">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <p class="text-muted">ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
    </div>

    <!-- ì˜ˆì•½ ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal fade" id="editReservationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>ì˜ˆì•½ ìˆ˜ì •
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
                    <!-- í˜¸í…”ì •ë³´ ë° ê¸°ë³¸ì •ë³´ ì„¹ì…˜ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-hotel me-2"></i>í˜¸í…”ì •ë³´ ë° ê¸°ë³¸ì •ë³´
                            </h6>
                        </div>
                        <div class="col-12 mb-2">
                            <div class="d-flex align-items-center gap-1">
                                <label class="form-label mb-0" style="min-width: 55px;">í˜¸í…”ëª…*</label>
                                <select class="form-control form-control-sm" id="hotel_id" required disabled style="background: #e9ecef; cursor: not-allowed; flex: 1.5;">
                                    <option value="">í˜¸í…” ì„ íƒ</option>
                                </select>
                                <label class="form-label mb-0 ms-1" style="min-width: 75px;">ì˜ˆì•½ê±°ë˜ì²˜</label>
                                <select class="form-control form-control-sm" id="booking_agency_id" disabled style="background: #e9ecef; cursor: not-allowed; flex: 1.5;">
                                    <option value="">ê±°ë˜ì²˜ ì„ íƒ</option>
                                </select>
                                <label class="form-label mb-0 ms-1" style="min-width: 65px;">ì˜ˆì•½ë²ˆí˜¸*</label>
                                <input type="text" class="form-control form-control-sm" id="reservation_number" required style="flex: 1;">
                                <label class="form-label mb-0 ms-1" style="min-width: 50px;">ì˜ˆì•½ì¼</label>
                                <input type="date" class="form-control form-control-sm fw-bold" id="reservation_date" readonly style="background: #f0f0f0; flex: 1;">
                                <label class="form-label mb-0 ms-1" style="min-width: 40px;">ìƒíƒœ*</label>
                                <select class="form-control form-control-sm" id="status" style="flex: 0.8;" required>
                                    <option value="pending">ëŒ€ê¸°ì¤‘</option>
                                    <option value="processing">ìˆ˜ë°°ì¤‘</option>
                                    <option value="confirmed">í™•ì •</option>
                                    <option value="voucher">ë°”ìš°ì²˜</option>
                                    <option value="modifying">ìˆ˜ì •ì¤‘</option>
                                    <option value="cancelled">ì˜ˆì•½ì·¨ì†Œ</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ë‚ ì§œ ì •ë³´ ì„¹ì…˜ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-calendar me-2"></i>ë‚ ì§œ ì •ë³´
                            </h6>
                        </div>
                        <div class="col-md-4 mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0" style="width: 40%;">ì²´í¬ì¸ *</label>
                                <input type="date" class="form-control" id="check_in_date" required onchange="calculateNights(); autoApplyPromotion();" style="width: 60%;">
                            </div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0" style="width: 40%;">ì²´í¬ì•„ì›ƒ *</label>
                                <input type="date" class="form-control" id="check_out_date" required onchange="calculateNights(); autoApplyPromotion();" style="width: 60%;">
                            </div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0" style="width: 40%;">ë°•ìˆ˜</label>
                                <input type="number" class="form-control fw-bold" id="nights" readonly style="background: #f0f0f0; width: 60%;">
                            </div>
                        </div>
                    </div>

                    <!-- í•­ê³µí¸ ì •ë³´ ì„¹ì…˜ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-plane me-2"></i>í•­ê³µí¸ ì •ë³´
                            </h6>
                        </div>
                        <div class="col-md-6 mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0" style="width: 40%;">ì…êµ­ í•­ê³µí¸ëª…</label>
                                <input type="text" class="form-control" id="arrival_flight" placeholder="ì˜ˆ: KE123" style="width: 60%;">
                            </div>
                        </div>
                        <div class="col-md-6 mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0" style="width: 40%;">ì¶œêµ­ í•­ê³µí¸ëª…</label>
                                <input type="text" class="form-control" id="departure_flight" placeholder="ì˜ˆ: KE124" style="width: 60%;">
                            </div>
                        </div>
                    </div>

                    <!-- í”„ë¡œëª¨ì…˜ ì½”ë“œ ì„¹ì…˜ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-tag me-2"></i>í”„ë¡œëª¨ì…˜ ìš”ê¸ˆ
                            </h6>
                        </div>
                        <div class="col-md-12">
                            <div id="promoResult" style="display: none;">
                                <!-- í”„ë¡œëª¨ì…˜ ê²°ê³¼ê°€ í‘œì‹œë¨ -->
                            </div>
                            <div id="promoLoading" style="display: none;" class="text-center py-2">
                                <i class="fas fa-spinner fa-spin"></i> í”„ë¡œëª¨ì…˜ ìš”ê¸ˆ ì¡°íšŒ ì¤‘...
                            </div>
                            <div id="noPromo" class="alert alert-info py-2">
                                í”„ë¡œëª¨ì…˜ ì •ë³´ ì—†ìŒ
                            </div>
                        </div>
                    </div>

                    <!-- ê°ì‹¤ ì •ë³´ ì„¹ì…˜ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-bed me-2"></i>ê°ì‹¤ ì •ë³´
                            </h6>
                        </div>
                        <div class="col-12" id="roomsContainer">
                            <!-- ê°ì‹¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                        </div>
                        <div class="col-12">
                            <button type="button" class="btn btn-add-room w-100" onclick="addRoom()">
                                <i class="fas fa-plus-circle me-2"></i>ê°ì‹¤ ì¶”ê°€
                            </button>
                        </div>
                    </div>

                    <!-- ì¶”ê°€ í•­ëª© ì„¹ì…˜ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-plus-square me-2"></i>ì¶”ê°€ í•­ëª© (ê³µí•­í”½ì—…, ê½ƒë°”êµ¬ë‹ˆ ë“±)
                            </h6>
                        </div>
                        <div class="col-12" id="extrasContainer">
                            <!-- ì¶”ê°€ í•­ëª©ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                        </div>
                        <div class="col-12">
                            <button type="button" class="btn btn-add-extra w-100" onclick="addExtraItem()">
                                <i class="fas fa-plus-circle me-2"></i>í•­ëª© ì¶”ê°€
                            </button>
                        </div>
                    </div>

                    <!-- ì´ ìš”ê¸ˆ ì„¹ì…˜ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="total-summary">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>ì´ ê°ì‹¤ ìš”ê¸ˆ:</span>
                                    <div class="input-group input-group-sm" style="width: 150px;">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="totalRoomCharge" value="0" step="0.01" min="0" onchange="calculateTotal()" style="text-align: right; font-weight: bold; max-width: 60%;">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span id="breakfastChargeLabel">ì¡°ì‹ ìš”ê¸ˆ (ë¶ˆí¬í•¨):</span>
                                    <div class="input-group input-group-sm" style="width: 150px;">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="totalBreakfastCharge" value="0" step="0.01" min="0" readonly style="text-align: right; font-weight: bold; max-width: 60%; background: #e7f3ff;">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>ì¶”ê°€ í•­ëª© ìš”ê¸ˆ:</span>
                                    <div class="input-group input-group-sm" style="width: 150px;">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="totalExtrasCharge" value="0" step="0.01" min="0" onchange="calculateTotal()" style="text-align: right; font-weight: bold; max-width: 60%;">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2" id="agencyFeeRow" style="display: none;">
                                    <span>ìˆ˜ë°°í”¼ (<span id="agencyFeeName"></span>):</span>
                                    <div class="input-group input-group-sm" style="width: 150px;">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="agencyFee" value="0" step="0.01" min="0" onchange="calculateTotal()" style="text-align: right; font-weight: bold; max-width: 60%;">
                                    </div>
                                </div>
                                <hr style="border-color: rgba(255,255,255,0.3);">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">ì´ íŒë§¤ê°€:</h5>
                                    <h4 class="mb-0" id="grandTotal">$0.00</h4>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ë©”ëª¨ ì„¹ì…˜ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-sticky-note me-2"></i>ë©”ëª¨
                            </h6>
                        </div>
                        <div class="col-12 mb-2">
                            <div class="d-flex gap-2">
                                <label class="form-label mb-0" style="width: 20%;">ì—…ë¬´ë©”ëª¨</label>
                                <textarea class="form-control" id="special_requests" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="col-12 mb-2">
                            <div class="d-flex gap-2">
                                <label class="form-label mb-0" style="width: 20%;">í˜¸í…”ì „ë‹¬(ë‚´ë¶€ë©”ëª¨)</label>
                                <textarea class="form-control" id="internal_memo" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-success btn-lg" onclick="saveReservationChanges()">
                        <i class="fas fa-save me-1"></i>ì €ì¥
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="voucherInvoiceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h5 class="modal-title text-white">
                        <i class="fas fa-file-invoice-dollar me-2"></i>ë°”ìš°ì²˜ ì¸ë³´ì´ìŠ¤ ê´€ë¦¬
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- ì˜ˆì•½ ì •ë³´ ìš”ì•½ -->
                    <div class="alert alert-info mb-4">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>ì˜ˆì•½ë²ˆí˜¸:</strong> <span id="invoiceReservationNumber">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>ì˜ˆì•½ì:</strong> <span id="invoiceGuestName">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>í˜¸í…”:</strong> <span id="invoiceHotelName">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>ì²´í¬ì¸:</strong> <span id="invoiceCheckIn">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- ì™¼ìª½: ì •ì‚° ê¸ˆì•¡ ë° ìƒì„± -->
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>ì •ì‚° ê¸ˆì•¡ ìƒì„¸ ë‚´ì—­</h6>
                                </div>
                                <div class="card-body">
                                    <!-- ê¸ˆì•¡ ìƒì„¸ ë‚´ì—­ -->
                                    <div class="mb-3 p-3" style="background: #f8f9fa; border-radius: 8px;">
                                        <h6 class="mb-3 text-primary"><i class="fas fa-list-ul me-2"></i>ê¸ˆì•¡ êµ¬ì„±</h6>
                                        
                                        <!-- ì´ ê°ì‹¤ ìš”ê¸ˆ -->
                                        <div class="d-flex justify-content-between mb-2">
                                            <span><i class="fas fa-bed me-2 text-info"></i>ì´ ê°ì‹¤ ìš”ê¸ˆ</span>
                                            <strong id="voucherRoomChargeDisplay">$0.00</strong>
                                        </div>
                                        
                                        <!-- ì¡°ì‹ ìš”ê¸ˆ -->
                                        <div class="mb-3" id="voucherBreakfastSection">
                                            <div class="d-flex justify-content-between mb-1">
                                                <span><i class="fas fa-utensils me-2 text-warning"></i><strong>ì¡°ì‹ ìš”ê¸ˆ</strong></span>
                                                <strong id="voucherBreakfastChargeDisplay" class="text-warning">$0.00</strong>
                                            </div>
                                            <div class="ms-4" id="voucherBreakfastDetailContainer" style="font-size: 0.85rem;">
                                                <!-- ì¡°ì‹ ìƒì„¸ ë‚´ì—­ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                                            </div>
                                        </div>
                                        
                                        <!-- ì¶”ê°€ í•­ëª© ìš”ê¸ˆ -->
                                        <div class="mb-3" id="voucherExtrasSection">
                                            <div class="d-flex justify-content-between mb-1">
                                                <span><i class="fas fa-plus-circle me-2 text-success"></i><strong>ì¶”ê°€ í•­ëª©</strong></span>
                                                <strong id="voucherExtrasChargeDisplay" class="text-success">$0.00</strong>
                                            </div>
                                            <div class="ms-4" id="voucherExtrasDetailContainer" style="font-size: 0.85rem;">
                                                <!-- ì¶”ê°€ í•­ëª© ìƒì„¸ ë‚´ì—­ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                                            </div>
                                        </div>
                                        
                                        <!-- ìˆ˜ë°°í”¼ -->
                                        <div class="d-flex justify-content-between mb-2">
                                            <span><i class="fas fa-handshake me-2 text-danger"></i>ìˆ˜ë°°í”¼ <span id="voucherAgencyNameDisplay" class="badge bg-secondary ms-1" style="font-size: 0.7rem;">-</span></span>
                                            <strong id="voucherAgencyFeeDisplay">$0.00</strong>
                                        </div>
                                        
                                        <hr class="my-2">
                                        
                                        <!-- í•©ê³„ -->
                                        <div class="d-flex justify-content-between mb-3">
                                            <strong class="text-success"><i class="fas fa-equals me-2"></i>í•©ê³„ (USD)</strong>
                                            <h5 class="mb-0 text-success" id="voucherTotalUSD">$0.00</h5>
                                        </div>
                                        
                                        <!-- í™˜ìœ¨ ì ìš© ì›í™” -->
                                        <div class="d-flex justify-content-between align-items-center p-2" style="background: white; border-radius: 6px;">
                                            <div>
                                                <strong class="text-primary"><i class="fas fa-won-sign me-2"></i>í•©ê³„ (KRW)</strong>
                                                <br>
                                                <small class="text-muted" id="voucherFxRateLabel">í™˜ìœ¨ ì •ë³´ ë¡œë”© ì¤‘...</small>
                                            </div>
                                            <h5 class="mb-0 text-primary" id="voucherTotalKRW">â‚©0</h5>
                                        </div>
                                    </div>
                                    
                                    <input type="hidden" id="voucherBaseAmount">
                                    <input type="hidden" id="voucherDiscount" value="0">
                                    <input type="hidden" id="voucherSurcharge" value="0">
                                    <input type="hidden" id="voucherFinalAmountUSD">
                                    <input type="hidden" id="voucherFinalAmountKRW">
                                    
                                    <button type="button" class="btn btn-success w-100 btn-lg" onclick="saveVoucherInvoice()">
                                        <i class="fas fa-file-invoice me-2"></i>ì¸ë³´ì´ìŠ¤ ìƒì„±
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- ì˜¤ë¥¸ìª½: ë°œí–‰ëœ ì¸ë³´ì´ìŠ¤ ëª©ë¡ -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="fas fa-list me-2"></i>ë°œí–‰ëœ ì¸ë³´ì´ìŠ¤</h6>
                                    <button class="btn btn-sm btn-outline-light" onclick="refreshInvoiceList()" title="ìƒˆë¡œê³ ì¹¨">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                                <div class="card-body p-0" id="voucherInvoicesList" style="max-height: 700px; overflow-y: auto;">
                                    <div class="text-center text-muted p-5">
                                        <i class="fas fa-inbox fa-3x mb-3"></i>
                                        <p class="mb-0">ì•„ì§ ë°œí–‰ëœ ì¸ë³´ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                                        <small>ìœ„ì—ì„œ ì¸ë³´ì´ìŠ¤ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-check me-2"></i>í˜¸í…” ì»¨íŒë²ˆí˜¸ ì…ë ¥
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="confirmRoomsContainer"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-success" onclick="saveConfirmationNumbers()">í™•ì • ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ìˆ˜ë°°ì„œ ìƒì„±/ë³´ê¸° ëª¨ë‹¬ -->
    <div class="modal fade" id="assignmentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title" id="assignmentModalTitle">
                        <i class="fas fa-file-contract me-2"></i>í˜¸í…” ìˆ˜ë°°ì„œ ì‘ì„± ë° ì „ì†¡
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0" style="background: #f5f5f5;">
                    <div class="row g-0 h-100">
                        <!-- ì™¼ìª½: ìˆ˜ë°°ì„œ ë¯¸ë¦¬ë³´ê¸° (A4 ì–‘ì‹) -->
                        <div class="col-md-8 p-4" style="background: white; overflow-y: auto; max-height: 85vh;">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">ğŸ“„ ìˆ˜ë°°ì„œ ë¯¸ë¦¬ë³´ê¸°</h5>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="printAssignment()" title="ì¸ì‡„">
                                        <i class="fas fa-print me-1"></i>ì¸ì‡„
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="downloadAssignmentPDF()" title="PDF ì €ì¥">
                                        <i class="fas fa-download me-1"></i>PDF ì €ì¥
                                    </button>
                                </div>
                            </div>
                            <div id="assignmentPreview" style="background: white; padding: 30px; border: 1px solid #ddd; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
                                <!-- A4 ìˆ˜ë°°ì„œ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                            </div>
                        </div>
                        
                        <!-- ì˜¤ë¥¸ìª½: ì „ì†¡ ê´€ë¦¬ íŒ¨ë„ -->
                        <div class="col-md-4 p-4" style="background: #f8f9fa; overflow-y: auto; max-height: 85vh;">
                            <h5 class="mb-3">ğŸ“¨ ìˆ˜ë°°ì„œ ê´€ë¦¬</h5>
                            
                            <!-- ìƒˆ ìˆ˜ë°°ì„œ ìƒì„± -->
                            <div class="card mb-3">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-plus-circle me-2"></i>ìˆ˜ë°°ì„œ ìƒì„±</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label"><strong>ì „ì†¡ íƒ€ì…</strong></label>
                                        <select class="form-select" id="newAssignmentTypeSelect">
                                            <option value="NEW">NEW - ì‹ ê·œ ìˆ˜ë°°ì„œ</option>
                                            <option value="REVISE">REVISE - ìˆ˜ì • ìˆ˜ë°°ì„œ</option>
                                            <option value="CANCEL">CANCEL - ì·¨ì†Œ ìˆ˜ë°°ì„œ</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3" id="newChangesDescriptionGroup" style="display: none;">
                                        <label class="form-label"><strong>ë³€ê²½/ì·¨ì†Œ ì‚¬ìœ </strong></label>
                                        <textarea class="form-control" id="newChangesDescriptionInput" rows="2" 
                                                  placeholder="ë³€ê²½ ë˜ëŠ” ì·¨ì†Œ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                                    </div>
                                    
                                    <!-- ì „ì†¡ ë°©ì‹ ì„ íƒ -->
                                    <div class="mb-3">
                                        <label class="form-label">ì „ì†¡ ë°©ì‹</label>
                                        <div class="d-flex flex-column gap-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="deliveryMethod" id="methodCreateOnly" value="create_only" checked onchange="toggleEmailInput()">
                                                <label class="form-check-label" for="methodCreateOnly">
                                                    ìˆ˜ë°°ì„œ ìƒì„±ë§Œ (ë‚˜ì¤‘ì— ì „ì†¡)
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="deliveryMethod" id="methodEmail" value="email" onchange="toggleEmailInput()">
                                                <label class="form-check-label" for="methodEmail">
                                                    <i class="fas fa-envelope me-1 text-primary"></i>ì´ë©”ì¼ ì¦‰ì‹œ ì „ì†¡
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="deliveryMethod" id="methodLink" value="link" onchange="toggleEmailInput()">
                                                <label class="form-check-label" for="methodLink">
                                                    <i class="fas fa-link me-1 text-info"></i>ë§í¬ ë³µì‚¬ (í´ë¦½ë³´ë“œ)
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- ì´ë©”ì¼ ì…ë ¥ (ì¡°ê±´ë¶€ í‘œì‹œ) -->
                                    <div class="mb-3" id="instantEmailGroup" style="display: none;">
                                        <label class="form-label">ìˆ˜ì‹  ì´ë©”ì¼</label>
                                        <input type="email" class="form-control" id="instantRecipientEmail" placeholder="í˜¸í…” ì´ë©”ì¼ ì£¼ì†Œ ì…ë ¥">
                                    </div>
                                    
                                    <button class="btn btn-primary w-100" onclick="createNewAssignment()">
                                        <i class="fas fa-plus-circle me-2"></i>ìˆ˜ë°°ì„œ ìƒì„± ë° ì²˜ë¦¬
                                    </button>
                                </div>
                            </div>
                            
                            <!-- ìƒì„±ëœ ìˆ˜ë°°ì„œ ëª©ë¡ -->
                            <div class="card">
                                <div class="card-header bg-dark text-white">
                                    <h6 class="mb-0"><i class="fas fa-list me-2"></i>ìƒì„±ëœ ìˆ˜ë°°ì„œ ëª©ë¡</h6>
                                </div>
                                <div class="card-body p-0" id="assignmentsList" style="max-height: 500px; overflow-y: auto;">
                                    <div class="text-center text-muted p-4">
                                        <i class="fas fa-inbox fa-3x mb-2"></i>
                                        <p class="mb-0 small">ì•„ì§ ìƒì„±ëœ ìˆ˜ë°°ì„œê°€ ì—†ìŠµë‹ˆë‹¤</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allReservations = [];
        let currentFilter = 'all';
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        document.addEventListener('DOMContentLoaded', function() {
            loadReservations();
            
            // ëª¨ë‹¬ì´ ë‹«í ë•Œ í…Œì´ë¸” ì—…ë°ì´íŠ¸
            const editModal = document.getElementById('editReservationModal');
            const voucherModal = document.getElementById('voucherInvoiceModal');
            
            if (editModal) {
                editModal.addEventListener('hidden.bs.modal', function() {
                    console.log('ì˜ˆì•½ ìˆ˜ì • ëª¨ë‹¬ ë‹«í˜ - í…Œì´ë¸” ì—…ë°ì´íŠ¸');
                    displayReservations(allReservations);
                });
            }
            
            if (voucherModal) {
                voucherModal.addEventListener('hidden.bs.modal', function() {
                    console.log('ë°”ìš°ì²˜ ëª¨ë‹¬ ë‹«í˜ - í…Œì´ë¸” ì—…ë°ì´íŠ¸');
                    displayReservations(allReservations);
                });
            }
        });
        
        // ì˜ˆì•½ ëª©ë¡ ë¡œë“œ
        async function loadReservations() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            
            try {
                const response = await fetch('/api/hotel-reservations');
                const data = await response.json();
                
                allReservations = data;
                displayReservations(allReservations);
                updateStats(allReservations);
                
            } catch (error) {
                console.error('ì˜ˆì•½ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì˜ˆì•½ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // ì˜ˆì•½ ì¹´ë“œ í‘œì‹œ
        function displayReservations(reservations) {
            const container = document.getElementById('reservationsContainer');
            
            // ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ í…Œì´ë¸” ì¬ìƒì„± ë°©ì§€
            const modalOpen = document.querySelector('.modal.show');
            if (modalOpen) {
                console.log('ëª¨ë‹¬ ì—´ë¦¼ - í…Œì´ë¸” ì¬ìƒì„± ìŠ¤í‚µ');
                return;
            }
            
            // ìº”ìŠ¬ ì œì™¸ (í•„í„°ì—ì„œë§Œ ì¡°íšŒ)
            const activeReservations = reservations.filter(r => r.status !== 'cancelled');
            
            if (activeReservations.length === 0) {
                container.innerHTML = '';
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            
            document.getElementById('emptyState').style.display = 'none';
            
            // ì •ë ¬: ì ‘ìˆ˜/ìˆ˜ì • â†’ ìˆ˜ë°°ì¤‘/ì—´ëŒ â†’ í™•ì •(ì¶œë°œì¼ìˆœ) â†’ ë°”ìš°ì²˜ â†’ ì •ì‚°
            const sorted = [...activeReservations].sort((a, b) => {
                const priority = { 'pending': 1, 'modifying': 1, 'processing': 2, 'confirmed': 3, 'voucher': 4, 'settlement': 5 };
                const aPri = priority[a.status] || 99;
                const bPri = priority[b.status] || 99;
                
                if (aPri !== bPri) return aPri - bPri;
                
                // í™•ì • ê·¸ë£¹ ë‚´ì—ì„œëŠ” ì¶œë°œì¼(ì²´í¬ì¸ì¼) ê°€ê¹Œìš´ ìˆœ
                if (a.status === 'confirmed' && b.status === 'confirmed') {
                    const aDate = new Date(a.check_in_date || '9999-12-31');
                    const bDate = new Date(b.check_in_date || '9999-12-31');
                    return aDate - bDate;
                }
                
                return 0;
            });
            
            container.innerHTML = `
                <table class="reservation-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;">No</th>
                            <th style="width: 80px;">ì˜ˆì•½ì¼</th>
                            <th style="width: 120px;">ì˜ˆì•½ë²ˆí˜¸</th>
                            <th style="width: 80px;">ì¶œë°œì¼</th>
                            <th style="width: 90px;">ê±°ë˜ì²˜</th>
                            <th style="width: 70px;">ë‹´ë‹¹ì</th>
                            <th style="width: 350px;">ì§„í–‰ìƒíƒœ</th>
                            <th style="width: 80px;">ëŒ€í‘œì˜ˆì•½ì</th>
                            <th style="width: 50px;">ì§€ì—­</th>
                            <th style="min-width: 150px;">í˜¸í…”ëª…</th>
                            <th style="min-width: 150px;">ë£¸íƒ€ì…</th>
                            <th style="width: 90px;">ë°©ê°œìˆ˜/ì¸ì›</th>
                            <th style="width: 280px;">ì•¡ì…˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sorted.map((res, index) => {
                            // ìƒíƒœë³„ í–‰ ìŠ¤íƒ€ì¼
                            let rowStyle = '';
                            
                            // ìµœê·¼ ì‘ì—…í•œ ì˜ˆì•½ ê°•ì¡° (ìµœìš°ì„ )
                            if (res.id === lastClosedReservationId) {
                                rowStyle = 'background: #d4edda; border-left: 5px solid #28a745; box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);'; // ì´ˆë¡ìƒ‰ ê°•ì¡°
                            } else if (res.status === 'pending' || res.status === 'modifying') {
                                rowStyle = 'background: #fff3cd; border-left: 4px solid #ffc107;'; // ë…¸ë€ìƒ‰ ê°•ì¡°
                            } else if (res.status === 'processing') {
                                rowStyle = 'background: #d1ecf1; border-left: 4px solid #17a2b8;'; // ì²­ë¡ìƒ‰ ê°•ì¡°
                            }
                            
                            return `
                            <tr data-reservation-id="${res.id}" data-status="${res.status}" style="${rowStyle}">
                                <td>${index + 1}</td>
                                <td>${formatDateShort(res.reservation_date)}</td>
                                <td style="font-weight: 600; color: #2c3e50;">${res.reservation_number}</td>
                                <td>${formatDateShort(res.check_in_date)}</td>
                                <td style="font-size: 0.7rem;">${res.agency_name || '-'}</td>
                                <td>
                                    <span class="badge bg-info" style="font-size: 0.65rem;">${res.assigned_to || 'ë¯¸ë°°ì •'}</span>
                                    ${res.has_memo ? '<br><span class="badge bg-warning mt-1" style="font-size: 0.6rem;"><i class="fas fa-sticky-note"></i></span>' : ''}
                                </td>
                                <td style="padding: 5px; white-space: nowrap;">
                                    ${getProgressBarCompact(res)}
                                </td>
                                <td style="font-size: 0.7rem;">${res.representative_name || '-'}</td>
                                <td><span class="badge bg-secondary" style="font-size: 0.65rem;">${res.region || 'ê´Œ'}</span></td>
                                <td style="text-align: left; font-size: 0.7rem;">${res.hotel_name || '-'}</td>
                                <td style="text-align: left; font-size: 0.65rem;">${res.room_types || '-'}</td>
                                <td>
                                    <span class="badge bg-primary" style="font-size: 0.65rem;">${res.total_rooms || 0}ê°œ</span>
                                    <span class="badge bg-success" style="font-size: 0.65rem;">${res.total_guests || 0}ëª…</span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary btn-sm" onclick="editReservation(${res.id})" title="ì˜ˆì•½ë³€ê²½">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="createAssignment(${res.id})" title="ìˆ˜ë°°ì„œ">
                                            <i class="fas fa-file-alt"></i>
                                        </button>
                                        <button class="btn btn-outline-success btn-sm" onclick="confirmReservation(${res.id})" title="í™•ì •">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn btn-outline-info btn-sm" onclick="createVoucher(${res.id})" title="ë°”ìš°ì²˜">
                                            <i class="fas fa-ticket-alt"></i>
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm" onclick="createSettlement(${res.id})" title="ì •ì‚°">
                                            <i class="fas fa-dollar-sign"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats(reservations) {
            const pending = reservations.filter(r => r.status === 'pending').length;
            const processing = reservations.filter(r => r.status === 'processing').length;
            const confirmed = reservations.filter(r => r.status === 'confirmed').length;
            
            document.getElementById('stat-pending').textContent = pending;
            document.getElementById('stat-processing').textContent = processing;
            document.getElementById('stat-confirmed').textContent = confirmed;
            document.getElementById('stat-total').textContent = reservations.length;
        }
        
        // ìƒíƒœë³„ í•„í„°ë§
        function filterByStatus(status) {
            currentFilter = status;
            
            // í•„í„° ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-status="${status}"]`).classList.add('active');
            
            // í•„í„°ë§
            filterReservations();
        }
        
        // ê²€ìƒ‰ ë° í•„í„°
        function filterReservations() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            let filtered = allReservations;
            
            // ìƒíƒœ í•„í„°
            if (currentFilter !== 'all') {
                filtered = filtered.filter(r => r.status === currentFilter);
            }
            
            // ê¸°ë³¸ ê²€ìƒ‰ì–´ í•„í„°
            if (searchTerm) {
                filtered = filtered.filter(r => {
                    return (r.reservation_number && r.reservation_number.toLowerCase().includes(searchTerm)) ||
                           (r.hotel_name && r.hotel_name.toLowerCase().includes(searchTerm)) ||
                           (r.representative_name && r.representative_name.toLowerCase().includes(searchTerm));
                });
            }
            
            // ê³ ê¸‰ í•„í„°
            const dateType = document.getElementById('dateType')?.value;
            const startDate = document.getElementById('startDate')?.value;
            const endDate = document.getElementById('endDate')?.value;
            const agencyFilter = document.getElementById('agencyFilter')?.value;
            const countryFilter = document.getElementById('countryFilter')?.value;
            const hotelFilter = document.getElementById('hotelFilter')?.value;
            const assignedToFilter = document.getElementById('assignedToFilter')?.value;
            
            if (startDate || endDate) {
                filtered = filtered.filter(r => {
                    const targetDate = dateType === 'reservation' ? r.reservation_date : r.check_in_date;
                    if (startDate && targetDate < startDate) return false;
                    if (endDate && targetDate > endDate) return false;
                    return true;
                });
            }
            
            if (agencyFilter) {
                filtered = filtered.filter(r => r.agency_name === agencyFilter);
            }
            
            if (countryFilter) {
                filtered = filtered.filter(r => (r.region || 'ê´Œ') === countryFilter);
            }
            
            if (hotelFilter) {
                filtered = filtered.filter(r => r.hotel_name === hotelFilter);
            }
            
            if (assignedToFilter) {
                filtered = filtered.filter(r => r.assigned_to === assignedToFilter);
            }
            
            displayReservations(filtered);
        }
        
        // ìƒì„¸ í•„í„° í† ê¸€
        function toggleAdvancedFilter() {
            const filterArea = document.getElementById('advancedFilterArea');
            if (filterArea.style.display === 'none') {
                filterArea.style.display = 'block';
                // í•„í„° ì˜µì…˜ ë¡œë“œ
                loadFilterOptions();
            } else {
                filterArea.style.display = 'none';
            }
        }
        
        // í•„í„° ì˜µì…˜ ë¡œë“œ
        function loadFilterOptions() {
            // ê±°ë˜ì²˜ ëª©ë¡
            const agencies = [...new Set(allReservations.map(r => r.agency_name).filter(Boolean))];
            const agencySelect = document.getElementById('agencyFilter');
            agencySelect.innerHTML = '<option value="">ì „ì²´</option>' +
                agencies.map(a => `<option value="${a}">${a}</option>`).join('');
            
            // í˜¸í…” ëª©ë¡
            const hotels = [...new Set(allReservations.map(r => r.hotel_name).filter(Boolean))];
            const hotelSelect = document.getElementById('hotelFilter');
            hotelSelect.innerHTML = '<option value="">ì „ì²´</option>' +
                hotels.map(h => `<option value="${h}">${h}</option>`).join('');
            
            // ë‹´ë‹¹ì ëª©ë¡
            const assignedTos = [...new Set(allReservations.map(r => r.assigned_to).filter(Boolean))];
            const assignedToSelect = document.getElementById('assignedToFilter');
            assignedToSelect.innerHTML = '<option value="">ì „ì²´</option>' +
                assignedTos.map(a => `<option value="${a}">${a}</option>`).join('');
        }
        
        // í•„í„° ì´ˆê¸°í™”
        function resetFilters() {
            document.getElementById('searchBox').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('agencyFilter').value = '';
            document.getElementById('countryFilter').value = '';
            document.getElementById('hotelFilter').value = '';
            document.getElementById('assignedToFilter').value = '';
            filterReservations();
        }
        
        // ìƒíƒœ ìƒ‰ìƒ
        function getStatusColor(status) {
            const colorMap = {
                'pending': '#ffc107',
                'processing': '#17a2b8',
                'confirmed': '#28a745',
                'cancelled': '#dc3545',
                'modifying': '#6c757d'
            };
            return colorMap[status] || '#6c757d';
        }
        
        // ì§„í–‰ë„ ë°” ìƒì„± (ì»´íŒ©íŠ¸)
        function getProgressBarCompact(res) {
            // 1ë‹¨ê³„: ì ‘ìˆ˜ ìƒíƒœ ì„¸ë¶„í™”
            let step1Label = 'ì ‘ìˆ˜';
            let step1Color = '#17a2b8';
            if (res.status === 'pending') {
                step1Label = 'ì‹ ê·œ';
                step1Color = '#ffc107'; // ë…¸ë€ìƒ‰
            } else if (res.status === 'modifying') {
                step1Label = 'ìˆ˜ì •';
                step1Color = '#fd7e14'; // ì˜¤ë Œì§€
            } else if (res.status === 'cancelled') {
                step1Label = 'ìº”ìŠ¬';
                step1Color = '#dc3545'; // ë¹¨ê°„ìƒ‰
            }
            
            // 2ë‹¨ê³„: ìˆ˜ë°°ì¤‘/ì—´ëŒ êµ¬ë¶„ (latest_assignment.viewed_at í™•ì¸)
            let step2Label = 'í˜¸í…”ìˆ˜ë°°ì¤‘';
            let step2Color = '#6c757d'; // íšŒìƒ‰ (ì•„ì§ ìˆ˜ë°° ì „)
            // ìƒíƒœê°€ processingì´ê±°ë‚˜, latest_assignmentê°€ ìˆìœ¼ë©´ ìˆ˜ë°° ë‹¨ê³„ë¡œ ê°„ì£¼
            if (res.status === 'processing' || res.latest_assignment) {
                if (res.latest_assignment && res.latest_assignment.viewed_at) {
                    step2Label = 'ì—´ëŒ';
                    step2Color = '#20c997'; // ë°ì€ ì²­ë¡ìƒ‰ (ì—´ëŒ ì™„ë£Œ)
                } else {
                    step2Label = 'ìˆ˜ë°°ì¤‘';
                    step2Color = '#17a2b8'; // íŒŒë€ìƒ‰ (ìˆ˜ë°°ì„œ ë°œì†¡ë¨)
                }
            }
            
            const steps = [
                { key: 'pending', label: step1Label, color: step1Color },
                { key: 'processing', label: step2Label, color: step2Color },
                { key: 'confirmed', label: 'í™•ì •', color: '#28a745' },
                { key: 'voucher', label: 'ë°”ìš°ì²˜', color: '#6f42c1' },
                { key: 'settlement', label: 'ì •ì‚°', color: '#ffc107' }
            ];
            
            const statusOrder = ['pending', 'modifying', 'cancelled', 'processing', 'confirmed', 'voucher', 'settlement'];
            let currentIndex = statusOrder.indexOf(res.status);
            
            // latest_assignmentê°€ ìˆìœ¼ë©´ ìµœì†Œí•œ processing ë‹¨ê³„ë¡œ ê°„ì£¼
            if (res.latest_assignment && currentIndex < statusOrder.indexOf('processing')) {
                currentIndex = statusOrder.indexOf('processing');
            }
            
            return steps.map((step, index) => {
                const stepIndex = statusOrder.indexOf(step.key);
                const isCompleted = stepIndex !== -1 && stepIndex <= currentIndex;
                const isCurrent = (step.key === res.status || 
                                 (res.status === 'modifying' && step.key === 'pending') ||
                                 (res.status === 'cancelled' && step.key === 'pending') ||
                                 (res.latest_assignment && step.key === 'processing' && res.status === 'pending'));
                
                const bgColor = isCompleted || isCurrent ? step.color : '#e9ecef';
                const textColor = isCompleted || isCurrent ? 'white' : '#6c757d';
                const fontWeight = isCurrent ? 'bold' : 'normal';
                
                return `<span class="badge me-1" style="background: ${bgColor}; color: ${textColor}; font-size: 0.6rem; padding: 3px 6px; font-weight: ${fontWeight};">${step.label}</span>`;
            }).join('');
        }
        
        // ì§„í–‰ë„ ë°” ìƒì„± (ì „ì²´)
        function getProgressBar(res) {
            const steps = [
                { key: 'pending', label: 'ëŒ€ê¸°', icon: 'clock' },
                { key: 'processing', label: 'ìˆ˜ë°°', icon: 'paper-plane' },
                { key: 'confirmed', label: 'í™•ì •', icon: 'check' },
                { key: 'voucher', label: 'ë°”ìš°ì²˜', icon: 'ticket-alt' },
                { key: 'settlement', label: 'ì •ì‚°', icon: 'dollar-sign' }
            ];
            
            const statusOrder = ['pending', 'processing', 'confirmed', 'voucher', 'settlement'];
            const currentIndex = statusOrder.indexOf(res.status);
            
            return `
                <div class="progress-steps d-flex justify-content-between align-items-center" style="position: relative;">
                    ${steps.map((step, index) => {
                        const isCompleted = index <= currentIndex;
                        const isCurrent = index === currentIndex;
                        return `
                            <div class="step-item text-center" style="flex: 1; position: relative; z-index: 1;">
                                <div class="step-circle ${isCompleted ? 'active' : ''} ${isCurrent ? 'current' : ''}" 
                                     style="width: 32px; height: 32px; border-radius: 50%; margin: 0 auto 4px; 
                                            display: flex; align-items: center; justify-content: center; font-size: 0.8rem;
                                            background: ${isCompleted ? '#667eea' : '#e9ecef'}; 
                                            color: ${isCompleted ? 'white' : '#6c757d'};
                                            border: ${isCurrent ? '3px solid #667eea' : 'none'};
                                            box-shadow: ${isCurrent ? '0 0 0 4px rgba(102, 126, 234, 0.2)' : 'none'};">
                                    <i class="fas fa-${step.icon}"></i>
                                </div>
                                <div style="font-size: 0.65rem; color: ${isCompleted ? '#667eea' : '#6c757d'}; font-weight: ${isCurrent ? 'bold' : 'normal'};">
                                    ${step.label}
                                </div>
                            </div>
                            ${index < steps.length - 1 ? `
                                <div style="flex: 1; height: 2px; background: ${index < currentIndex ? '#667eea' : '#e9ecef'}; margin: 0 -5px; position: relative; top: -20px;"></div>
                            ` : ''}
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // ë‚ ì§œ í¬ë§· (ì „ì²´)
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // ë‚ ì§œ í¬ë§· (ì§§ê²Œ)
        function formatDateShort(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${month}-${day}`;
        }
        
        // ìƒíƒœ í…ìŠ¤íŠ¸
        function getStatusText(status) {
            const statusMap = {
                'pending': 'ëŒ€ê¸°ì¤‘',
                'processing': 'ìˆ˜ë°°ì¤‘',
                'confirmed': 'í™•ì •',
                'cancelled': 'ì˜ˆì•½ì·¨ì†Œ',
                'modifying': 'ìˆ˜ì •ì¤‘'
            };
            return statusMap[status] || status;
        }
        
        let currentEditingId = null;
        let lastClosedReservationId = null;
        let allHotels = [];
        let allRoomTypes = [];
        let allAgencies = [];
        let roomCounter = 0;
        let extraCounter = 0;
        let currentPromotion = null;
        let roomPromotions = {};
        let isLoadingData = false;  // â­ ë°ì´í„° ë¡œë“œ ì¤‘ í”Œë˜ê·¸ (ì¡°ì‹ ì¤‘ë³µ ë°©ì§€)
        let currentConfirmReservationId = null;
        let currentVoucherReservationId = null;
        
        // íŠ¹ì • ì˜ˆì•½ í–‰ë§Œ ê°•ì¡° (í…Œì´ë¸” ì „ì²´ ë¦¬ë¡œë“œ ì—†ì´)
        function highlightReservationRow(reservationId) {
            // DOM ì•ˆì •í™”ë¥¼ ìœ„í•´ ì•½ê°„ ì§€ì—°
            setTimeout(() => {
                // ëª¨ë“  í–‰ì˜ ê°•ì¡° ì œê±°
                document.querySelectorAll('tr[data-reservation-id]').forEach(row => {
                    const rowId = parseInt(row.dataset.reservationId);
                    const status = row.dataset.status;
                    
                    // ê¸°ë³¸ ìŠ¤íƒ€ì¼ë¡œ ë³µì› (ê°œë³„ ì†ì„±ë§Œ ë³€ê²½)
                    if (status === 'pending' || status === 'modifying') {
                        row.style.background = '#fff3cd';
                        row.style.borderLeft = '4px solid #ffc107';
                        row.style.boxShadow = '';
                    } else if (status === 'processing') {
                        row.style.background = '#d1ecf1';
                        row.style.borderLeft = '4px solid #17a2b8';
                        row.style.boxShadow = '';
                    } else {
                        row.style.background = '';
                        row.style.borderLeft = '';
                        row.style.boxShadow = '';
                    }
                });
                
                // ì„ íƒëœ í–‰ë§Œ ì´ˆë¡ìƒ‰ ê°•ì¡°
                const targetRow = document.querySelector(`tr[data-reservation-id="${reservationId}"]`);
                if (targetRow) {
                    targetRow.style.background = '#d4edda';
                    targetRow.style.borderLeft = '5px solid #28a745';
                    targetRow.style.boxShadow = '0 0 10px rgba(40, 167, 69, 0.3)';
                }
            }, 100);
        }
        let currentVoucherInvoiceId = null;
        let currentVoucherInvoiceLink = '';
        let currentVoucherAgencyEmail = '';
        let voucherBaseAmountUSD = 0;
        let voucherFxRate = 1300;
        
        // ëª¨ë‹¬ ì˜¤í”ˆ ì‹œ í˜¸í…”/ê±°ë˜ì²˜ ë¡œë“œ
        document.getElementById('editReservationModal').addEventListener('show.bs.modal', async function() {
            await loadHotels();
            await loadAgencies();
        });
        
        // í˜¸í…” ëª©ë¡ ë¡œë“œ
        async function loadHotels() {
            try {
                const response = await fetch('/api/hotels?is_active=true');
                const hotels = await response.json();
                allHotels = hotels;
                
                const select = document.getElementById('hotel_id');
                select.innerHTML = '<option value="">í˜¸í…” ì„ íƒ</option>' +
                    hotels.map(h => `<option value="${h.id}">${h.hotel_name}</option>`).join('');
            } catch (error) {
                console.error('í˜¸í…” ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // ê±°ë˜ì²˜ ëª©ë¡ ë¡œë“œ
        async function loadAgencies() {
            try {
                const response = await fetch('/api/booking-agencies?is_active=true');
                const agencies = await response.json();
                allAgencies = agencies;
                
                const select = document.getElementById('booking_agency_id');
                select.innerHTML = '<option value="">ì§ì ‘ ì˜ˆì•½</option>' +
                    agencies.map(a => `<option value="${a.id}">${a.agency_name}</option>`).join('');
            } catch (error) {
                console.error('ê±°ë˜ì²˜ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // ê°ì‹¤ íƒ€ì… ë¡œë“œ
        async function loadRoomTypes() {
            const hotelId = document.getElementById('hotel_id').value;
            if (!hotelId) return;
            
            try {
                const response = await fetch(`/api/room-types?hotel_id=${hotelId}&is_active=true`);
                allRoomTypes = await response.json();
                
                // ëª¨ë“  ê°ì‹¤ì˜ selectë¥¼ ì—…ë°ì´íŠ¸
                document.querySelectorAll('.room-type-select').forEach(select => {
                    select.innerHTML = '<option value="">ê°ì‹¤ íƒ€ì… ì„ íƒ</option>' +
                        allRoomTypes.map(rt => `<option value="${rt.id}">${rt.room_type_name}</option>`).join('');
                });
            } catch (error) {
                console.error('ê°ì‹¤ íƒ€ì… ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // ë°•ìˆ˜ ê³„ì‚°
        function calculateNights() {
            const checkIn = document.getElementById('check_in_date').value;
            const checkOut = document.getElementById('check_out_date').value;
            
            if (checkIn && checkOut) {
                const date1 = new Date(checkIn);
                const date2 = new Date(checkOut);
                const diff = Math.ceil((date2 - date1) / (1000 * 60 * 60 * 24));
                
                document.getElementById('nights').value = diff > 0 ? diff : 0;
            }
        }
        
        // ì¡°ì‹ ìš”ê¸ˆ ë¼ë²¨ ì—…ë°ì´íŠ¸ (í¬í•¨/ë¶ˆí¬í•¨ ë™ì  í‘œì‹œ)
        function updateBreakfastLabel() {
            const label = document.getElementById('breakfastChargeLabel');
            if (!label) return;
            
            // ëª¨ë“  ê°ì‹¤ì˜ ì¡°ì‹ í¬í•¨ ì—¬ë¶€ í™•ì¸
            let hasBreakfast = false;
            const roomCards = document.querySelectorAll('.room-card');
            roomCards.forEach(card => {
                const roomId = card.dataset.roomId;
                const checkbox = document.getElementById(`breakfast_included_${roomId}`);
                if (checkbox && checkbox.checked) {
                    hasBreakfast = true;
                }
            });
            
            // ë¼ë²¨ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            label.textContent = hasBreakfast ? 'ì¡°ì‹ ìš”ê¸ˆ (í¬í•¨):' : 'ì¡°ì‹ ìš”ê¸ˆ (ë¶ˆí¬í•¨):';
        }
        
        // ì „ì²´ ê¸ˆì•¡ ê³„ì‚° (â­ ìˆ˜ë°°í”¼ëŠ” ì €ì¥ëœ ê°’ ì‚¬ìš© - ì¬ê³„ì‚° ì•ˆ í•¨)
        async function calculateTotal() {
            // â“ ê±°ë˜ì²˜ê°€ disabledì´ë¯€ë¡œ ìˆ˜ë°°í”¼ ì¬ê³„ì‚° ì•ˆ í•¨
            // const agencyId = document.getElementById('booking_agency_id').value;
            // if (agencyId) {
            //     await calculateAgencyFee();
            // }
            
            // â­ ê° ê°ì‹¤ì˜ ì…ë ¥ í•„ë“œì—ì„œ ì§ì ‘ ê°’ì„ ì½ì–´ì„œ í•©ì‚°
            let totalRoomCharge = 0;
            document.querySelectorAll('.room-card').forEach(room => {
                const roomNum = room.dataset.roomId;
                const roomRateInput = document.getElementById(`room_${roomNum}_rate`);
                if (roomRateInput) {
                    totalRoomCharge += parseFloat(roomRateInput.value) || 0;
                }
            });
            
            // ì´ ê°ì‹¤ìš”ê¸ˆ í•„ë“œ ì—…ë°ì´íŠ¸
            document.getElementById('totalRoomCharge').value = totalRoomCharge.toFixed(2);
            
            const totalBreakfastCharge = parseFloat(document.getElementById('totalBreakfastCharge').value) || 0;
            const totalExtrasCharge = parseFloat(document.getElementById('totalExtrasCharge').value) || 0;
            const agencyFee = parseFloat(document.getElementById('agencyFee').value) || 0; // â­ ì €ì¥ëœ ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            
            // â­ ì´ íŒë§¤ê°€ ê³„ì‚° (ì¡°ì‹ìš”ê¸ˆ í¬í•¨)
            const grandTotal = totalRoomCharge + totalBreakfastCharge + totalExtrasCharge + agencyFee;
            
            document.getElementById('grandTotal').textContent = `$${grandTotal.toFixed(2)}`;
            
            // ì¡°ì‹ ë¼ë²¨ ì—…ë°ì´íŠ¸
            updateBreakfastLabel();
        }
        
        // ìˆ˜ë°°í”¼ ê³„ì‚°
        async function calculateAgencyFee() {
            const agencyId = document.getElementById('booking_agency_id').value;
            if (agencyId) {
                const agency = allAgencies.find(a => a.id == agencyId);
                if (agency) {
                    document.getElementById('agencyFeeRow').style.display = 'flex';
                    document.getElementById('agencyFeeName').textContent = agency.agency_name;
                    
                    // â­ ìˆ˜ë°°í”¼ ê¸ˆì•¡ ê³„ì‚°
                    const totalRoomCharge = parseFloat(document.getElementById('totalRoomCharge').value) || 0;
                    const totalExtrasCharge = parseFloat(document.getElementById('totalExtrasCharge').value) || 0;
                    const totalAmount = totalRoomCharge + totalExtrasCharge;
                    
                    let agencyFee = 0;
                    
                    // fee_typeì— ë”°ë¼ ê³„ì‚°
                    if (agency.fee_type === 'percentage') {
                        // í¼ì„¼íŠ¸ ë°©ì‹
                        const feePercent = parseFloat(agency.fee_amount) || 0;
                        agencyFee = totalAmount * (feePercent / 100);
                        console.log(`ğŸ’° ìˆ˜ë°°í”¼ ê³„ì‚° (${agency.agency_name}): $${totalAmount} Ã— ${feePercent}% = $${agencyFee.toFixed(2)}`);
                    } else {
                        // ì •ì•¡ ë°©ì‹
                        agencyFee = parseFloat(agency.fee_amount) || 0;
                        console.log(`ğŸ’° ìˆ˜ë°°í”¼ ê³„ì‚° (${agency.agency_name}): $${agencyFee.toFixed(2)} (ì •ì•¡)`);
                    }
                    
                    document.getElementById('agencyFee').value = agencyFee.toFixed(2);
                } else {
                    document.getElementById('agencyFeeRow').style.display = 'none';
                    document.getElementById('agencyFee').value = 0;
                }
            } else {
                document.getElementById('agencyFeeRow').style.display = 'none';
                document.getElementById('agencyFee').value = 0;
            }
            calculateTotal();
        }
        
        // í”„ë¡œëª¨ì…˜ ìë™ ì ìš©
        async function autoApplyPromotion() {
            const hotelId = document.getElementById('hotel_id').value;
            const checkIn = document.getElementById('check_in_date').value;
            const checkOut = document.getElementById('check_out_date').value;
            
            // í•„ìˆ˜ ì¡°ê±´ í™•ì¸
            if (!hotelId || !checkIn || !checkOut) {
                return;
            }
            
            // ì²« ë²ˆì§¸ ê°ì‹¤ì˜ room_type_id ê°€ì ¸ì˜¤ê¸°
            const firstRoomType = document.querySelector('.room-type-select');
            if (!firstRoomType || !firstRoomType.value) {
                return;
            }
            
            // ë¡œë”© í‘œì‹œ
            document.getElementById('promoLoading').style.display = 'block';
            document.getElementById('promoResult').style.display = 'none';
            document.getElementById('noPromo').style.display = 'none';
            
            // í”„ë¡œëª¨ì…˜ ì¡°íšŒ (ìë™ìœ¼ë¡œ ê°€ì¥ ìœ ë¦¬í•œ í”„ë¡œëª¨ì…˜ ì°¾ê¸°)
            await findBestPromotion(hotelId, firstRoomType.value, checkIn, checkOut);
        }
        
        // ìµœì  í”„ë¡œëª¨ì…˜ ì°¾ê¸°
        async function findBestPromotion(hotelId, roomTypeId, checkIn, checkOut) {
            try {
                // ëª¨ë“  í™œì„± í”„ë¡œëª¨ì…˜ ì¡°íšŒ
                const response = await fetch('/api/hotel-promotions/list?hotel_id=' + hotelId + '&is_active=true');
                const promotions = await response.json();
                
                if (!promotions || promotions.length === 0) {
                    document.getElementById('promoLoading').style.display = 'none';
                    document.getElementById('noPromo').style.display = 'block';
                    return;
                }
                
                // ê° í”„ë¡œëª¨ì…˜ ìš”ê¸ˆ í™•ì¸ ë° ìµœì €ê°€ ì°¾ê¸°
                let bestPromotion = null;
                let lowestRate = Infinity;
                
                for (const promo of promotions) {
                    const rateResponse = await fetch('/api/hotel-promotions/check-and-get-rates', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            promo_code: promo.promo_code,
                            hotel_id: parseInt(hotelId),
                            room_type_id: parseInt(roomTypeId),
                            check_in_date: checkIn,
                            check_out_date: checkOut,
                            booking_date: new Date().toISOString().split('T')[0]
                        })
                    });
                    
                    const result = await rateResponse.json();
                    
                    if (result.valid && result.total_room_rate < lowestRate) {
                        lowestRate = result.total_room_rate;
                        bestPromotion = result;
                    }
                }
                
                document.getElementById('promoLoading').style.display = 'none';
                
                if (bestPromotion) {
                    currentPromotion = bestPromotion;
                    displayPromotionResult(bestPromotion);
                    updateRoomCharges();
                } else {
                    document.getElementById('noPromo').style.display = 'block';
                }
            } catch (error) {
                console.error('í”„ë¡œëª¨ì…˜ ì¡°íšŒ ì˜¤ë¥˜:', error);
                document.getElementById('promoLoading').style.display = 'none';
                document.getElementById('noPromo').style.display = 'block';
            }
        }
        
        // í”„ë¡œëª¨ì…˜ ê²°ê³¼ í‘œì‹œ
        function displayPromotionResult(result) {
            const promoResult = document.getElementById('promoResult');
            
            let benefitsHtml = '';
            if (result.benefits && result.benefits.length > 0) {
                benefitsHtml = '<div class="mt-2"><strong>ë² ë„¤í•:</strong><br>' +
                    result.benefits.map(b => {
                        let text = '';
                        if (b.benefit_type === 'drink_coupon') text = `ğŸ¹ ë“œë§í¬ ì¿ í° ${b.quantity}ë§¤`;
                        else if (b.benefit_type === 'late_checkout') text = `ğŸ• ë ˆì´íŠ¸ ì²´í¬ì•„ì›ƒ (${b.benefit_value || ''})`;
                        else if (b.benefit_type === 'breakfast') text = `ğŸ³ ì¡°ì‹ ${b.quantity}ì¸ë¶„`;
                        else if (b.benefit_type === 'credit') text = `ğŸ’µ í¬ë ˆë”§ $${b.benefit_value}`;
                        else text = b.description || b.benefit_name || b.benefit_type;
                        return `<span class="benefit-badge">${text}</span>`;
                    }).join('') +
                    '</div>';
            }
            
            promoResult.innerHTML = `
                <div class="alert alert-success py-2">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle me-2"></i>
                        <div class="flex-fill">
                            <strong>í”„ë¡œëª¨ì…˜ ì ìš© ì™„ë£Œ!</strong>
                            <span class="promo-badge">${result.promotion.promo_name}</span>
                            <div class="mt-2">
                                <strong>í”„ë¡œëª¨ì…˜ ì½”ë“œ:</strong> 
                                <code style="font-size: 1.1em; color: #667eea; background: #f0f4ff; padding: 4px 8px; border-radius: 4px;">${result.promotion.promo_code}</code>
                            </div>
                            <div class="small mt-2">
                                ì˜ˆì•½ ê¸°ê°„: ${result.promotion.booking_start_date} ~ ${result.promotion.booking_end_date}<br>
                                íˆ¬ìˆ™ ê¸°ê°„: ${result.promotion.stay_start_date} ~ ${result.promotion.stay_end_date}
                            </div>
                            ${benefitsHtml}
                        </div>
                    </div>
                </div>
                <div class="rate-display mt-2">
                    <h6 class="mb-2"><i class="fas fa-dollar-sign me-1"></i>ë‚ ì§œë³„ í”„ë¡œëª¨ì…˜ ìš”ê¸ˆ</h6>
                    ${result.daily_rates.map(r => `
                        <div class="d-flex justify-content-between">
                            <span>${r.stay_date}:</span>
                            <strong>$${r.rate_per_night.toFixed(2)}</strong>
                        </div>
                    `).join('')}
                    <hr>
                    <div class="d-flex justify-content-between">
                        <strong>1ê°ì‹¤ ì´ì•¡:</strong>
                        <strong class="text-primary fs-5">$${result.total_room_rate.toFixed(2)}</strong>
                    </div>
                </div>
            `;
            
            promoResult.style.display = 'block';
            document.getElementById('noPromo').style.display = 'none';
        }
        
        // ê°ì‹¤ ìš”ê¸ˆ ìë™ ì—…ë°ì´íŠ¸ (ëª¨ë“  ê°ì‹¤ì˜ í”„ë¡œëª¨ì…˜ í•©ì‚°)
        async function updateRoomCharges() {
            let totalRoomCharge = 0;
            let totalBreakfastCharge = 0;
            const appliedPromoCodes = new Set();
            
            // ê° ê°ì‹¤ì˜ í”„ë¡œëª¨ì…˜ ìš”ê¸ˆ í•©ì‚°
            document.querySelectorAll('.room-card').forEach(room => {
                const roomNum = room.dataset.roomId;
                if (roomPromotions[roomNum] && roomPromotions[roomNum].total_room_rate) {
                    // â­ ëª…ì‹œì ìœ¼ë¡œ ìˆ«ìë¡œ ë³€í™˜
                    totalRoomCharge += parseFloat(roomPromotions[roomNum].total_room_rate) || 0;
                    if (roomPromotions[roomNum].promotion && roomPromotions[roomNum].promotion.promo_code) {
                        appliedPromoCodes.add(roomPromotions[roomNum].promotion.promo_code);
                    }
                }
                
                // â­ ì¡°ì‹ ìš”ê¸ˆ ê³„ì‚° (ìœ ì•„ ì œì™¸)
                const breakfastCheckbox = document.getElementById(`breakfast_included_${roomNum}`);
                if (breakfastCheckbox && breakfastCheckbox.checked) {
                    const days = parseInt(document.getElementById(`breakfast_days_${roomNum}`)?.value) || 1;
                    const adultPrice = parseFloat(document.getElementById(`breakfast_adult_price_${roomNum}`)?.value) || 0;
                    const childPrice = parseFloat(document.getElementById(`breakfast_child_price_${roomNum}`)?.value) || 0;
                    
                    // íˆ¬ìˆ™ê° ìˆ˜ ê³„ì‚° (ìœ ì•„ëŠ” ì¡°ì‹ ì œì™¸)
                    let adultCount = 0;
                    let childCount = 0;
                    room.querySelectorAll('.guest-card').forEach(guest => {
                        const ageCategory = guest.querySelector('[data-guest-field="age_category"]')?.value;
                        if (ageCategory === 'adult') adultCount++;
                        else if (ageCategory === 'child') childCount++;
                        // ìœ ì•„(infant)ëŠ” ì¡°ì‹ ìš”ê¸ˆ ê³„ì‚°ì—ì„œ ì œì™¸
                    });
                    
                    const breakfastCharge = (adultCount * adultPrice * days) + (childCount * childPrice * days);
                    totalBreakfastCharge += breakfastCharge;
                    
                    // â­ ì¡°ì‹ ìš”ê¸ˆ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                    const previewDiv = document.getElementById(`breakfast_charge_preview_${roomNum}`);
                    if (previewDiv) {
                        previewDiv.innerHTML = `
                            <strong>ğŸ’° ì¡°ì‹ ìš”ê¸ˆ:</strong> 
                            <span style="font-size: 1rem;">
                                ì„±ì¸${adultCount}ëª…Ã—$${adultPrice}Ã—${days}ì¼ + ì†Œì•„${childCount}ëª…Ã—$${childPrice}Ã—${days}ì¼ 
                                = <strong style="color: #28a745;">$${breakfastCharge.toFixed(2)}</strong>
                            </span>
                        `;
                    }
                    
                    console.log(`ğŸ³ ê°ì‹¤ ${roomNum} ì¡°ì‹ìš”ê¸ˆ: ì„±ì¸${adultCount}ëª…Ã—$${adultPrice}Ã—${days}ì¼ + ì†Œì•„${childCount}ëª…Ã—$${childPrice}Ã—${days}ì¼ = $${breakfastCharge.toFixed(2)}`);
                }
            });
            
            // í”„ë¡œëª¨ì…˜ ì½”ë“œ í‘œì‹œ (ì—¬ëŸ¬ ê°ì‹¤)
            const promoResult = document.getElementById('promoResult');
            if (appliedPromoCodes.size > 0) {
                const promoCodesHtml = Array.from(appliedPromoCodes).map(code => 
                    `<code style="font-size: 1.1em; color: #667eea; background: #f0f4ff; padding: 4px 8px; border-radius: 4px; margin-right: 5px;">${code}</code>`
                ).join('');
                promoResult.innerHTML = `
                    <div class="alert alert-success py-2">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>í”„ë¡œëª¨ì…˜ ì ìš© ì™„ë£Œ!</strong>
                        <div class="mt-2">
                            <strong>ì ìš©ëœ í”„ë¡œëª¨ì…˜ ì½”ë“œ:</strong> ${promoCodesHtml}
                        </div>
                    </div>
                `;
                promoResult.style.display = 'block';
                document.getElementById('noPromo').style.display = 'none';
            } else {
                promoResult.style.display = 'none';
                document.getElementById('noPromo').style.display = 'block';
            }
            
            document.getElementById('totalRoomCharge').value = totalRoomCharge.toFixed(2);
            document.getElementById('totalBreakfastCharge').value = totalBreakfastCharge.toFixed(2);
            console.log(`ğŸ’° ì´ ê°ì‹¤ìš”ê¸ˆ: $${totalRoomCharge.toFixed(2)}, ì´ ì¡°ì‹ìš”ê¸ˆ: $${totalBreakfastCharge.toFixed(2)}`);
            
            // await calculateAgencyFee(); // â“ ì£¼ì„ ì²˜ë¦¬: ê±°ë˜ì²˜ disabled, ì €ì¥ëœ ìˆ˜ë°°í”¼ ê°’ ìœ ì§€
            calculateTotal();
        }
        
        // íŠ¹ì • ë£¸íƒ€ì…ì˜ ìµœì  í”„ë¡œëª¨ì…˜ ì°¾ê¸°
        async function findBestPromotionForRoom(hotelId, roomTypeId, checkIn, checkOut) {
            try {
                const response = await fetch('/api/hotel-promotions/list?hotel_id=' + hotelId + '&is_active=true');
                const promotions = await response.json();
                
                if (!promotions || promotions.length === 0) {
                    return null;
                }
                
                let bestPromotion = null;
                let lowestRate = Infinity;
                
                for (const promo of promotions) {
                    const checkResult = await fetch('/api/hotel-promotions/check-and-get-rates', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            promo_code: promo.promo_code,
                            hotel_id: hotelId,
                            room_type_id: roomTypeId,
                            check_in_date: checkIn,
                            check_out_date: checkOut,
                            booking_date: new Date().toISOString().split('T')[0]
                        })
                    });
                    
                    const result = await checkResult.json();
                    
                    if (result.valid && result.total_room_rate < lowestRate) {
                        lowestRate = result.total_room_rate;
                        bestPromotion = result;
                    }
                }
                
                return bestPromotion;
            } catch (error) {
                console.error('í”„ë¡œëª¨ì…˜ ì¡°íšŒ ì˜¤ë¥˜:', error);
                return null;
            }
        }
        
        // ê°ì‹¤ë³„ ë£¸íƒ€ì… ë³€ê²½ ì‹œ í”„ë¡œëª¨ì…˜ ì¡°íšŒ
        async function onRoomTypeChange(roomNum) {
            const roomTypeSelect = document.querySelector(`[data-room="${roomNum}"]`);
            const roomTypeId = roomTypeSelect.value;
            const hotelId = document.getElementById('hotel_id').value;
            const checkIn = document.getElementById('check_in_date').value;
            const checkOut = document.getElementById('check_out_date').value;
            
            if (!roomTypeId || !hotelId || !checkIn || !checkOut) {
                return;
            }
            
            try {
                // í•´ë‹¹ ë£¸íƒ€ì… ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const roomType = allRoomTypes.find(rt => rt.id == roomTypeId);
                
                // â­ ì¡°ì‹ ì •ë³´ë¥¼ ê°ì‹¤ ì¹´ë“œì— í‘œì‹œ (ì¶”ê°€ í•­ëª© X)
                if (roomType) {
                    displayBreakfastInfo(roomNum, roomType);
                }
                
                // í•´ë‹¹ ë£¸íƒ€ì…ì˜ ìµœì  í”„ë¡œëª¨ì…˜ ì°¾ê¸°
                const bestPromotion = await findBestPromotionForRoom(hotelId, roomTypeId, checkIn, checkOut);
                
                if (bestPromotion) {
                    roomPromotions[roomNum] = bestPromotion;
                    document.getElementById(`room_${roomNum}_rate`).value = `$${bestPromotion.total_room_rate.toFixed(2)} (í”„ë¡œëª¨ì…˜)`;
                    console.log(`âœ… ê°ì‹¤ ${roomNum} í”„ë¡œëª¨ì…˜ ì ìš©:`, bestPromotion.promotion.promo_code);
                } else {
                    roomPromotions[roomNum] = null;
                    document.getElementById(`room_${roomNum}_rate`).value = 'í”„ë¡œëª¨ì…˜ ì—†ìŒ';
                }
                
                // ì „ì²´ ê°ì‹¤ ìš”ê¸ˆ í•©ì‚°
                await updateRoomCharges();
            } catch (error) {
                console.error('ë£¸íƒ€ì… í”„ë¡œëª¨ì…˜ ì¡°íšŒ ì˜¤ë¥˜:', error);
            }
        }
        
        // â­ ì¡°ì‹ í¬í•¨/ë¶ˆí¬í•¨ ìƒíƒœë§Œ í‘œì‹œ (ë‹¨ìˆœí™”)
        function displayBreakfastInfo(roomNum, roomType) {
            if (!roomType) return;
            
            const breakfastIncluded = roomType.breakfast_included || false;
            const breakfastInfoDiv = document.getElementById(`breakfast_info_${roomNum}`);
            const breakfastAlertDiv = document.getElementById(`breakfast_alert_${roomNum}`);
            const breakfastStatusSpan = document.getElementById(`breakfast_status_${roomNum}`);
            
            if (!breakfastInfoDiv || !breakfastAlertDiv || !breakfastStatusSpan) return;
            
            if (breakfastIncluded) {
                // ì¡°ì‹ í¬í•¨
                breakfastAlertDiv.className = 'alert alert-success py-2 mb-2';
                breakfastStatusSpan.textContent = 'ì¡°ì‹ í¬í•¨';
                breakfastInfoDiv.style.display = 'block';
                console.log(`ğŸ³ ê°ì‹¤ ${roomNum}: ì¡°ì‹ í¬í•¨ âœ“`);
            } else {
                // ì¡°ì‹ ë¶ˆí¬í•¨
                breakfastAlertDiv.className = 'alert alert-secondary py-2 mb-2';
                breakfastStatusSpan.textContent = 'ì¡°ì‹ ë¶ˆí¬í•¨';
                breakfastInfoDiv.style.display = 'block';
                console.log(`ğŸ³ ê°ì‹¤ ${roomNum}: ì¡°ì‹ ë¶ˆí¬í•¨`);
            }
        }
        
        // â­ ê¸°ì¡´ addBreakfastFromRoomType í•¨ìˆ˜ (ì´ì œ ì‚¬ìš© ì•ˆ í•¨)
        async function addBreakfastFromRoomType(roomNum, roomType) {
            // ë” ì´ìƒ ì¶”ê°€ í•­ëª©ì— ì¡°ì‹ì„ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
            console.log(`â„¹ï¸ ì¡°ì‹ì€ ê°ì‹¤ ì •ë³´ì— í‘œì‹œë©ë‹ˆë‹¤ (ì¶”ê°€ í•­ëª© X)`);
            return;
            
            /* ê¸°ì¡´ ë¡œì§ ì£¼ì„ ì²˜ë¦¬
            if (!roomType) return;
            
            const breakfastIncluded = roomType.breakfast_included || false;
            const breakfastRateAdult = parseFloat(roomType.breakfast_rate_adult) || 0;
            const breakfastRateChild = parseFloat(roomType.breakfast_rate_child) || 0;
            
            // â­ ë°ì´í„° ë¡œë“œ ì¤‘ì—ëŠ” ì¡°ì‹ ìë™ ì¶”ê°€ ì•ˆ í•¨ (ì¤‘ë³µ ë°©ì§€)
            if (isLoadingData) {
                console.log(`ğŸš« ë°ì´í„° ë¡œë“œ ì¤‘ì´ë¯€ë¡œ ì¡°ì‹ ìë™ ì¶”ê°€ ê±´ë„ˆëœ€`);
                return;
            }
            */
            
            // í•´ë‹¹ ê°ì‹¤ì˜ íˆ¬ìˆ™ê° ìˆ˜ í™•ì¸
            const guestsContainer = document.getElementById(`guests_${roomNum}`);
            if (!guestsContainer) return;
            
            const guestCards = guestsContainer.querySelectorAll('.guest-card');
            
            let adultCount = 0;
            let childCount = 0;
            
            guestCards.forEach(card => {
                const ageCategory = card.querySelector('[data-guest-field="age_category"]')?.value || 'adult';
                if (ageCategory === 'adult') adultCount++;
                else if (ageCategory === 'child') childCount++;
            });
            
            // ê¸°ì¡´ ì¡°ì‹ í•­ëª© ì œê±° (ì¤‘ë³µ ë°©ì§€)
            const existingBreakfast = document.querySelector(`[data-breakfast-room="${roomNum}"]`);
            if (existingBreakfast) {
                existingBreakfast.remove();
            }
            
            // ì¡°ì‹ í¬í•¨/ë¶ˆí¬í•¨ í•­ëª© ì¶”ê°€
            extraCounter++;
            const extraId = `extra_${extraCounter}`;
            
            let itemName, quantity, unitPrice, notes;
            
            if (breakfastIncluded) {
                // ì¡°ì‹ í¬í•¨
                itemName = 'ì¡°ì‹ (í¬í•¨)';
                quantity = adultCount + childCount;
                unitPrice = 0;
                notes = `ê°ì‹¤ ${roomNum} - ì¡°ì‹ í¬í•¨`;
            } else {
                // ì¡°ì‹ ë¶ˆí¬í•¨
                itemName = 'ì¡°ì‹ (ë¶ˆí¬í•¨ - ì¶”ê°€ ì‹œ ë³„ë„ ìš”ê¸ˆ)';
                quantity = 0;
                unitPrice = breakfastRateAdult;
                notes = `ê°ì‹¤ ${roomNum} - ì„±ì¸: $${breakfastRateAdult}, ì†Œì•„: $${breakfastRateChild}`;
            }
            
            const extraHtml = `
                <div class="extra-item-card" id="${extraId}" data-breakfast-room="${roomNum}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong><i class="fas fa-utensils me-2"></i>ì¶”ê°€ í•­ëª© ${extraCounter}</strong>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeExtra('${extraId}')">
                            <i class="fas fa-times"></i> ì‚­ì œ
                        </button>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="form-label">í•­ëª©ëª…</label>
                            <input type="text" class="form-control form-control-sm" value="${itemName}" data-extra-field="item_name" data-extra="${extraCounter}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ìˆ˜ëŸ‰</label>
                            <input type="number" class="form-control form-control-sm" value="${quantity}" data-extra-field="quantity" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ë‹¨ê°€ (USD)</label>
                            <input type="number" step="0.01" class="form-control form-control-sm" value="${unitPrice}" data-extra-field="unit_price" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ì†Œê³„ (USD)</label>
                            <input type="text" class="form-control form-control-sm bg-light" readonly value="${(quantity * unitPrice).toFixed(2)}" id="extra_${extraCounter}_subtotal">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">ë¹„ê³ </label>
                            <input type="text" class="form-control form-control-sm" value="${notes}" data-extra-field="notes" data-extra="${extraCounter}">
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('extrasContainer').insertAdjacentHTML('beforeend', extraHtml);
            
            // ìë™ ì¶”ê°€ëœ ì¡°ì‹ì˜ ì†Œê³„ ê³„ì‚° (ì •ì•¡ ìš”ê¸ˆì´ë¯€ë¡œ flat íƒ€ì…)
            setTimeout(() => {
                const totalField = document.getElementById(`extra_${extraCounter}_subtotal`);
                if (totalField) {
                    totalField.value = (quantity * unitPrice).toFixed(2);
                }
                
                // ì „ì²´ ì¶”ê°€ í•­ëª© í•©ê³„ ì¬ê³„ì‚°
                let totalExtras = 0;
                document.querySelectorAll('.extra-item-card').forEach(extra => {
                    const subtotalField = extra.querySelector('[id$="_subtotal"]');
                    if (subtotalField && subtotalField.value) {
                        totalExtras += parseFloat(subtotalField.value) || 0;
                    }
                });
                document.getElementById('totalExtrasCharge').value = totalExtras.toFixed(2);
                calculateTotal();
            }, 100);
        }
        
        // ê°ì‹¤ ì¶”ê°€
        function addRoom() {
            roomCounter++;
            const roomId = `room_${roomCounter}`;
            
            const roomHtml = `
                <div class="room-card" id="${roomId}" data-room-id="${roomCounter}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">
                            <i class="fas fa-bed me-2"></i>ê°ì‹¤ ${roomCounter}
                            <small class="text-success ms-2" id="room_${roomCounter}_cfn_label" style="font-size: 0.75rem;"></small>
                        </h6>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeRoom('${roomId}')">
                            <i class="fas fa-trash"></i> ì‚­ì œ
                        </button>
                    </div>
                    
                    <div class="d-flex align-items-center gap-1 mb-2">
                        <label class="form-label mb-0" style="min-width: 70px;">ê°ì‹¤íƒ€ì…*</label>
                        <select class="form-control form-control-sm room-type-select" data-room="${roomCounter}" onchange="onRoomTypeChange(${roomCounter})" style="flex: 1;">
                            <option value="">ê°ì‹¤ íƒ€ì… ì„ íƒ</option>
                        </select>
                        <label class="form-label mb-0 ms-1" style="min-width: 95px;">ì´ ê°ì‹¤ìš”ê¸ˆ(ìë™)</label>
                        <input type="text" class="form-control form-control-sm" id="room_${roomCounter}_rate" oninput="calculateTotal()" style="flex: 1;">
                    </div>
                    
                    <!-- â­ ì¡°ì‹ ì •ë³´ ì„¹ì…˜ (ìˆ˜ì • ê°€ëŠ¥) -->
                    <div class="border rounded p-2 mb-3" style="background: #f8f9fa;">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="breakfast_included_${roomCounter}" onchange="toggleBreakfastFields(${roomCounter})">
                            <label class="form-check-label fw-bold" for="breakfast_included_${roomCounter}">
                                <i class="fas fa-utensils me-1"></i>ì¡°ì‹ í¬í•¨
                            </label>
                        </div>
                        <div id="breakfast_fields_${roomCounter}" style="display: none;">
                            <!-- â­ íˆ¬ìˆ™ ì¸ì› í‘œì‹œ -->
                            <div id="breakfast_guest_count_${roomCounter}" class="alert alert-info py-2 px-3 mb-2" style="font-size: 0.85rem;">
                                <i class="fas fa-users me-1"></i>
                                <strong>íˆ¬ìˆ™ ì¸ì›:</strong>
                                <span class="ms-2">
                                    ì„±ì¸ <strong id="breakfast_adult_count_${roomCounter}">0</strong>ëª… / 
                                    ì†Œì•„ <strong id="breakfast_child_count_${roomCounter}">0</strong>ëª… / 
                                    ìœ ì•„ <strong id="breakfast_infant_count_${roomCounter}">0</strong>ëª…
                                </span>
                            </div>
                            
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label small">íšŸìˆ˜(ì¼)</label>
                                    <input type="number" class="form-control form-control-sm" id="breakfast_days_${roomCounter}" value="1" min="1" onchange="updateRoomCharges()">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">ì„±ì¸ ë‹¨ê°€ ($)</label>
                                    <input type="number" class="form-control form-control-sm" id="breakfast_adult_price_${roomCounter}" value="0" step="0.01" min="0" onchange="updateRoomCharges()">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">ì†Œì•„ ë‹¨ê°€ ($)</label>
                                    <input type="number" class="form-control form-control-sm" id="breakfast_child_price_${roomCounter}" value="0" step="0.01" min="0" onchange="updateRoomCharges()">
                                </div>
                            </div>
                            
                            <!-- â­ ì¡°ì‹ ìš”ê¸ˆ ë¯¸ë¦¬ë³´ê¸° -->
                            <div id="breakfast_charge_preview_${roomCounter}" class="mt-2 text-end" style="font-size: 0.85rem; color: #28a745;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <strong class="d-block mb-2"><i class="fas fa-users me-2"></i>íˆ¬ìˆ™ê° ì •ë³´</strong>
                        <div id="guests_${roomCounter}">
                            ${createGuestHtml(roomCounter, 1, true)}
                        </div>
                        <button type="button" class="btn btn-sm btn-add-guest mt-2" onclick="addGuest(${roomCounter})">
                            <i class="fas fa-user-plus me-1"></i>ë™ë°˜ íˆ¬ìˆ™ê° ì¶”ê°€
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('roomsContainer').insertAdjacentHTML('beforeend', roomHtml);
            
            // ê°ì‹¤ íƒ€ì… ì˜µì…˜ ì±„ìš°ê¸°
            if (allRoomTypes.length > 0) {
                const select = document.querySelector(`#${roomId} .room-type-select`);
                select.innerHTML = '<option value="">ê°ì‹¤ íƒ€ì… ì„ íƒ</option>' +
                    allRoomTypes.map(rt => `<option value="${rt.id}">${rt.room_type_name}</option>`).join('');
            }
        }
        
        // â­ ê°ì‹¤ë³„ íˆ¬ìˆ™ ì¸ì› ìˆ˜ ì—…ë°ì´íŠ¸
        function updateGuestCount(roomNum) {
            const roomCard = document.querySelector(`[data-room-id="${roomNum}"]`);
            if (!roomCard) return;
            
            let adultCount = 0;
            let childCount = 0;
            let infantCount = 0;
            
            roomCard.querySelectorAll('.guest-card').forEach(guest => {
                const ageCategory = guest.querySelector('[data-guest-field="age_category"]')?.value;
                if (ageCategory === 'adult') adultCount++;
                else if (ageCategory === 'child') childCount++;
                else if (ageCategory === 'infant') infantCount++;
            });
            
            // ì¡°ì‹ í•„ë“œì˜ ì¸ì› ìˆ˜ í‘œì‹œ ì—…ë°ì´íŠ¸
            const adultCountEl = document.getElementById(`breakfast_adult_count_${roomNum}`);
            const childCountEl = document.getElementById(`breakfast_child_count_${roomNum}`);
            const infantCountEl = document.getElementById(`breakfast_infant_count_${roomNum}`);
            
            if (adultCountEl) adultCountEl.textContent = adultCount;
            if (childCountEl) childCountEl.textContent = childCount;
            if (infantCountEl) infantCountEl.textContent = infantCount;
            
            // ì¡°ì‹ ìš”ê¸ˆ ì¬ê³„ì‚°
            updateRoomCharges();
        }

        // íˆ¬ìˆ™ê° HTML ìƒì„± (í•œ ì¤„ë¡œ ë³€ê²½)
        function createGuestHtml(roomNum, guestNum, isPrimary = false) {
            return `
                <div class="guest-card" id="guest_${roomNum}_${guestNum}" style="padding: 0.5rem; margin-bottom: 0.5rem;">
                    <div class="d-flex align-items-center gap-1">
                        <strong style="min-width: 90px; font-size: 0.7rem;">${isPrimary ? 'ëŒ€í‘œ íˆ¬ìˆ™ê°' : 'ë™ë°˜íˆ¬ìˆ™ê°' + guestNum}</strong>
                        <input type="text" class="form-control form-control-sm" placeholder="í•œê¸€ëª…" data-guest-field="guest_name_ko" data-room="${roomNum}" data-guest="${guestNum}" style="flex: 1;">
                        <span style="font-size: 0.7rem;">|</span>
                        <input type="text" class="form-control form-control-sm" placeholder="ì˜ë¬¸ëª…" data-guest-field="guest_name_en" data-room="${roomNum}" data-guest="${guestNum}" style="flex: 1;">
                        <span style="font-size: 0.7rem;">|</span>
                        <select class="form-control form-control-sm" data-guest-field="age_category" data-room="${roomNum}" data-guest="${guestNum}" style="width: 70px;" onchange="updateGuestCount(${roomNum})">
                            <option value="adult">ì„±ì¸</option>
                            <option value="child">ì†Œì•„</option>
                            <option value="infant">ìœ ì•„</option>
                        </select>
                        <span style="font-size: 0.7rem;">|</span>
                        <input type="date" class="form-control form-control-sm" placeholder="ìƒë…„ì›”ì¼" data-guest-field="date_of_birth" data-room="${roomNum}" data-guest="${guestNum}" style="width: 130px;">
                        ${isPrimary ? `
                        <span style="font-size: 0.7rem;">|</span>
                        <input type="tel" class="form-control form-control-sm" placeholder="ì „í™”ë²ˆí˜¸" data-guest-field="phone" data-room="${roomNum}" data-guest="${guestNum}" style="width: 120px;">
                        <span style="font-size: 0.7rem;">|</span>
                        <input type="email" class="form-control form-control-sm" placeholder="ì´ë©”ì¼" data-guest-field="email" data-room="${roomNum}" data-guest="${guestNum}" style="flex: 1;">
                        ` : ''}
                        ${!isPrimary ? `<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeGuest(${roomNum}, ${guestNum})" style="padding: 0.2rem 0.5rem;"><i class="fas fa-times"></i></button>` : ''}
                    </div>
                </div>
            `;
        }
        
        // íˆ¬ìˆ™ê° ì¶”ê°€
        function addGuest(roomNum) {
            const guestsContainer = document.getElementById(`guests_${roomNum}`);
            const guestCount = guestsContainer.querySelectorAll('.guest-card').length + 1;
            
            guestsContainer.insertAdjacentHTML('beforeend', createGuestHtml(roomNum, guestCount, false));
            
            // â­ ì¸ì› ìˆ˜ ì—…ë°ì´íŠ¸
            updateGuestCount(roomNum);
        }
        
        // íˆ¬ìˆ™ê° ì œê±°
        function removeGuest(roomNum, guestNum) {
            const guestCard = document.getElementById(`guest_${roomNum}_${guestNum}`);
            if (guestCard) {
                guestCard.remove();
                // â­ ì¸ì› ìˆ˜ ì—…ë°ì´íŠ¸
                updateGuestCount(roomNum);
            }
        }
        
        // ==================== ì¡°ì‹ ê´€ë ¨ í•¨ìˆ˜ ====================
        
        // ì¡°ì‹ í•„ë“œ í† ê¸€ (ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ)
        function toggleBreakfastFields(roomNum) {
            const checkbox = document.getElementById(`breakfast_included_${roomNum}`);
            const fieldsDiv = document.getElementById(`breakfast_fields_${roomNum}`);
            const label = document.querySelector(`label[for="breakfast_included_${roomNum}"]`);
            const daysInput = document.getElementById(`breakfast_days_${roomNum}`);
            const adultPriceInput = document.getElementById(`breakfast_adult_price_${roomNum}`);
            const childPriceInput = document.getElementById(`breakfast_child_price_${roomNum}`);
            
            if (checkbox.checked) {
                fieldsDiv.style.display = 'block';
                
                // â­ ë ˆì´ë¸” í…ìŠ¤íŠ¸ ë³€ê²½
                if (label) {
                    label.innerHTML = '<i class="fas fa-utensils me-1"></i>ì¡°ì‹ í¬í•¨';
                }
                
                // â­ ì´ ìš”ê¸ˆ ì„¹ì…˜ì˜ ì¡°ì‹ ë¼ë²¨ë„ ì—…ë°ì´íŠ¸
                updateBreakfastLabel();
                
                // ì¡°ì‹ í¬í•¨ìœ¼ë¡œ ë³€ê²½ ì‹œ: ë°•ìˆ˜ì™€ ê°ì‹¤ íƒ€ì…ì˜ ì¡°ì‹ ìš”ê¸ˆ ìë™ ë¡œë“œ
                const nights = parseInt(document.getElementById('nights')?.textContent) || 1;
                daysInput.value = nights;
                
                // ê°ì‹¤ íƒ€ì…ì˜ ì¡°ì‹ ìš”ê¸ˆ ê°€ì ¸ì˜¤ê¸°
                const roomSelect = document.querySelector(`[data-room="${roomNum}"]`);
                if (roomSelect && roomSelect.value) {
                    const roomType = allRoomTypes.find(rt => rt.id == roomSelect.value);
                    if (roomType && (parseFloat(adultPriceInput.value) === 0 || parseFloat(childPriceInput.value) === 0)) {
                        adultPriceInput.value = parseFloat(roomType.breakfast_adult_price || 0).toFixed(2);
                        childPriceInput.value = parseFloat(roomType.breakfast_child_price || 0).toFixed(2);
                        console.log(`âœ… ê°ì‹¤ ${roomNum} ì¡°ì‹ ìš”ê¸ˆ ìë™ ë¡œë“œ: ì„±ì¸=$${roomType.breakfast_adult_price}, ì†Œì•„=$${roomType.breakfast_child_price}`);
                    }
                }
            } else {
                fieldsDiv.style.display = 'none';
                
                // â­ ë ˆì´ë¸” í…ìŠ¤íŠ¸ ë³€ê²½
                if (label) {
                    label.innerHTML = '<i class="fas fa-utensils me-1"></i>ì¡°ì‹ ë¶ˆí¬í•¨';
                }
                
                // â­ ì´ ìš”ê¸ˆ ì„¹ì…˜ì˜ ì¡°ì‹ ë¼ë²¨ë„ ì—…ë°ì´íŠ¸
                updateBreakfastLabel();
            }
            
            // â­ ì¡°ì‹ ìš”ê¸ˆ ì¬ê³„ì‚°
            updateRoomCharges();
        }
        
        // ê°ì‹¤ íƒ€ì… ë³€ê²½ ì‹œ ì¡°ì‹ ì •ë³´ í‘œì‹œ
        function displayBreakfastInfo(roomNum, roomType) {
            const checkbox = document.getElementById(`breakfast_included_${roomNum}`);
            const daysInput = document.getElementById(`breakfast_days_${roomNum}`);
            const adultPriceInput = document.getElementById(`breakfast_adult_price_${roomNum}`);
            const childPriceInput = document.getElementById(`breakfast_child_price_${roomNum}`);
            const fieldsDiv = document.getElementById(`breakfast_fields_${roomNum}`);
            const label = document.querySelector(`label[for="breakfast_included_${roomNum}"]`);
            
            if (!roomType) return;
            
            // ì¡°ì‹ í¬í•¨ ì—¬ë¶€ í™•ì¸
            const breakfastIncluded = roomType.breakfast_included === true || roomType.breakfast_included === 'true';
            
            if (breakfastIncluded) {
                // ì¡°ì‹ í¬í•¨ â†’ ì²´í¬ë°•ìŠ¤ ì²´í¬, ë°•ìˆ˜ì™€ ìš”ê¸ˆ ìë™ ì„¤ì •
                checkbox.checked = true;
                fieldsDiv.style.display = 'block';
                
                // â­ ë ˆì´ë¸” í…ìŠ¤íŠ¸ ë³€ê²½
                if (label) {
                    label.innerHTML = '<i class="fas fa-utensils me-1"></i>ì¡°ì‹ í¬í•¨';
                }
                
                const nights = parseInt(document.getElementById('nights')?.textContent) || 1;
                daysInput.value = nights;
                adultPriceInput.value = parseFloat(roomType.breakfast_adult_price || 0).toFixed(2);
                childPriceInput.value = parseFloat(roomType.breakfast_child_price || 0).toFixed(2);
                
                console.log(`âœ… ê°ì‹¤ ${roomNum} ì¡°ì‹ ìë™ ì„¤ì •: í¬í•¨, ${nights}ì¼, ì„±ì¸=$${roomType.breakfast_adult_price}, ì†Œì•„=$${roomType.breakfast_child_price}`);
            } else {
                // ì¡°ì‹ ë¶ˆí¬í•¨ â†’ ì²´í¬ë°•ìŠ¤ í•´ì œ
                checkbox.checked = false;
                fieldsDiv.style.display = 'none';
                
                // â­ ë ˆì´ë¸” í…ìŠ¤íŠ¸ ë³€ê²½
                if (label) {
                    label.innerHTML = '<i class="fas fa-utensils me-1"></i>ì¡°ì‹ ë¶ˆí¬í•¨';
                }
                
                // í•˜ì§€ë§Œ ìš”ê¸ˆì€ ë¯¸ë¦¬ ì±„ì›Œë‘ê¸° (ë‚˜ì¤‘ì— ì²´í¬í•  ë•Œ ì‚¬ìš©)
                const nights = parseInt(document.getElementById('nights')?.textContent) || 1;
                daysInput.value = nights;
                adultPriceInput.value = parseFloat(roomType.breakfast_adult_price || 0).toFixed(2);
                childPriceInput.value = parseFloat(roomType.breakfast_child_price || 0).toFixed(2);
                
                console.log(`â„¹ï¸  ê°ì‹¤ ${roomNum} ì¡°ì‹: ë¶ˆí¬í•¨ (ìš”ê¸ˆì€ ë¯¸ë¦¬ ì„¤ì •ë¨)`);
            }
            
            // â­ íˆ¬ìˆ™ ì¸ì› ìˆ˜ ì—…ë°ì´íŠ¸
            updateGuestCount(roomNum);
        }
        
        // ê°ì‹¤ ì œê±°
        function removeRoom(roomId) {
            if (confirm('ì´ ê°ì‹¤ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById(roomId).remove();
                calculateTotal();
            }
        }
        
        // ì¶”ê°€ í•­ëª© ì¶”ê°€
        function addExtraItem() {
            extraCounter++;
            const extraId = `extra_${extraCounter}`;
            
            const extraHtml = `
                <div class="extra-item-card" id="${extraId}">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="fas fa-plus-circle me-2"></i>ì¶”ê°€ í•­ëª© ${extraCounter}</h6>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeExtra('${extraId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label small">í•­ëª©ëª… *</label>
                            <input type="text" class="form-control" placeholder="ì˜ˆ: ê³µí•­í”½ì—…, ê½ƒë°”êµ¬ë‹ˆ" data-extra-field="item_name" data-extra="${extraCounter}" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">ìˆ˜ëŸ‰</label>
                            <input type="number" class="form-control" value="1" min="1" data-extra-field="quantity" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">ìœ í˜•</label>
                            <select class="form-control" data-extra-field="pricing_type" data-extra="${extraCounter}" onchange="toggleExtraPricing(${extraCounter})">
                                <option value="per_person">ì¸ì›ë³„ ìš”ê¸ˆ</option>
                                <option value="flat">ì •ì•¡ ìš”ê¸ˆ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row g-2 mt-1">
                        <div class="col-md-4">
                            <label class="form-label small">ì¸/ì•„ì›ƒ í˜¸í…”</label>
                            <select class="form-control" data-extra-field="in_hotel" data-extra="${extraCounter}">
                                <option value="in" selected>ì¸í˜¸í…” (í˜¸í…” ì²­êµ¬)</option>
                                <option value="out">ì•„ì›ƒí˜¸í…” (í˜¸í…” ì²­êµ¬ ì•„ë‹˜)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row g-2 mt-2" id="perPersonPricing_${extraCounter}">
                        <div class="col-md-3">
                            <label class="form-label small">ì„±ì¸ ìˆ˜</label>
                            <input type="number" class="form-control" value="0" min="0" data-extra-field="adult_count" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">ì„±ì¸ ë‹¨ê°€ ($)</label>
                            <input type="number" class="form-control" value="0" step="0.01" data-extra-field="adult_price" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">ì†Œì•„ ìˆ˜</label>
                            <input type="number" class="form-control" value="0" min="0" data-extra-field="child_count" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">ì†Œì•„ ë‹¨ê°€ ($)</label>
                            <input type="number" class="form-control" value="0" step="0.01" data-extra-field="child_price" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">ìœ ì•„ ìˆ˜</label>
                            <input type="number" class="form-control" value="0" min="0" data-extra-field="infant_count" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">ìœ ì•„ ë‹¨ê°€ ($)</label>
                            <input type="number" class="form-control" value="0" step="0.01" data-extra-field="infant_price" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                    </div>
                    
                    <div class="row g-2 mt-2" id="flatPricing_${extraCounter}" style="display:none;">
                        <div class="col-md-6">
                            <label class="form-label small">ë‹¨ê°€ ($)</label>
                            <input type="number" class="form-control" value="0" step="0.01" data-extra-field="unit_price" data-extra="${extraCounter}" onchange="calculateExtraTotal(${extraCounter})">
                        </div>
                    </div>
                    
                    <div class="row g-2 mt-2">
                        <div class="col-md-12">
                            <label class="form-label small">ì†Œê³„</label>
                            <input type="text" class="form-control fw-bold" id="extra_${extraCounter}_total" readonly style="background: #e7f3ff; color: #2196F3;">
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('extrasContainer').insertAdjacentHTML('beforeend', extraHtml);
        }
        
        // ì¶”ê°€ í•­ëª© ê°€ê²© ìœ í˜• ì „í™˜
        function toggleExtraPricing(extraNum) {
            const type = document.querySelector(`[data-extra-field="pricing_type"][data-extra="${extraNum}"]`).value;
            
            if (type === 'per_person') {
                document.getElementById(`perPersonPricing_${extraNum}`).style.display = 'flex';
                document.getElementById(`flatPricing_${extraNum}`).style.display = 'none';
            } else {
                document.getElementById(`perPersonPricing_${extraNum}`).style.display = 'none';
                document.getElementById(`flatPricing_${extraNum}`).style.display = 'flex';
            }
            
            calculateExtraTotal(extraNum);
        }
        
        // ì¶”ê°€ í•­ëª© ì†Œê³„ ê³„ì‚°
        function calculateExtraTotal(extraNum) {
            const type = document.querySelector(`[data-extra-field="pricing_type"][data-extra="${extraNum}"]`).value;
            const quantity = parseInt(document.querySelector(`[data-extra-field="quantity"][data-extra="${extraNum}"]`).value) || 1;
            
            let total = 0;
            
            if (type === 'per_person') {
                const adultCount = parseInt(document.querySelector(`[data-extra-field="adult_count"][data-extra="${extraNum}"]`).value) || 0;
                const adultPrice = parseFloat(document.querySelector(`[data-extra-field="adult_price"][data-extra="${extraNum}"]`).value) || 0;
                const childCount = parseInt(document.querySelector(`[data-extra-field="child_count"][data-extra="${extraNum}"]`).value) || 0;
                const childPrice = parseFloat(document.querySelector(`[data-extra-field="child_price"][data-extra="${extraNum}"]`).value) || 0;
                const infantCount = parseInt(document.querySelector(`[data-extra-field="infant_count"][data-extra="${extraNum}"]`).value) || 0;
                const infantPrice = parseFloat(document.querySelector(`[data-extra-field="infant_price"][data-extra="${extraNum}"]`).value) || 0;
                
                total = (adultCount * adultPrice + childCount * childPrice + infantCount * infantPrice) * quantity;
            } else {
                const unitPrice = parseFloat(document.querySelector(`[data-extra-field="unit_price"][data-extra="${extraNum}"]`).value) || 0;
                total = unitPrice * quantity;
            }
            
            document.getElementById(`extra_${extraNum}_total`).value = `$${total.toFixed(2)}`;
            
            // ëª¨ë“  ì¶”ê°€ í•­ëª© í•©ê³„ ê³„ì‚°
            let totalExtras = 0;
            document.querySelectorAll('.extra-item-card').forEach(extra => {
                const totalInput = extra.querySelector('[id$="_total"]');
                if (totalInput && totalInput.value) {
                    const amount = parseFloat(totalInput.value.replace('$', '')) || 0;
                    totalExtras += amount;
                }
            });
            document.getElementById('totalExtrasCharge').value = totalExtras.toFixed(2);
            
            calculateTotal();
        }
        
        // ì¶”ê°€ í•­ëª© ì œê±°
        function removeExtra(extraId) {
            if (confirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById(extraId).remove();
                
                // í•©ê³„ ì¬ê³„ì‚°
                let totalExtras = 0;
                document.querySelectorAll('.extra-item-card').forEach(extra => {
                    const totalInput = extra.querySelector('[id$="_total"]');
                    if (totalInput && totalInput.value) {
                        const amount = parseFloat(totalInput.value.replace('$', '')) || 0;
                        totalExtras += amount;
                    }
                });
                document.getElementById('totalExtrasCharge').value = totalExtras.toFixed(2);
                calculateTotal();
                calculateTotal();
            }
        }
        
        // ì˜ˆì•½ ë³€ê²½ - ëª¨ë‹¬ë¡œ ì˜¤í”ˆ
        async function editReservation(reservationId) {
            currentEditingId = reservationId;
            lastClosedReservationId = reservationId;
            highlightReservationRow(reservationId); // í•´ë‹¹ í–‰ë§Œ ê°•ì¡°
            
            // ë¨¼ì € ëª¨ë‹¬ ì˜¤í”ˆ
            const modal = new bootstrap.Modal(document.getElementById('editReservationModal'));
            modal.show();
            
            try {
                // ì˜ˆì•½ ìƒì„¸ ë°ì´í„° ë¡œë“œ
                const response = await fetch(`/api/hotel-reservations/${reservationId}`);
                const data = await response.json();
                
                console.log('ğŸ“¥ ë¡œë“œëœ ì˜ˆì•½ ë°ì´í„°:', data);
                
                // ëª¨ë‹¬ì´ ì™„ì „íˆ ì—´ë¦° í›„ì— ë°ì´í„° ì±„ìš°ê¸°
                setTimeout(async () => {
                    // â­ ë°ì´í„° ë¡œë“œ ì‹œì‘
                    isLoadingData = true;
                    
                    // ì´ˆê¸°í™”
                    roomCounter = 0;
                    extraCounter = 0;
                    document.getElementById('roomsContainer').innerHTML = '';
                    document.getElementById('extrasContainer').innerHTML = '';
                    
                    // ë‚ ì§œ í¬ë§· ë³€í™˜ í•¨ìˆ˜ (ISO â†’ YYYY-MM-DD)
                    function formatDateForInput(dateStr) {
                        if (!dateStr) return '';
                        try {
                            const date = new Date(dateStr);
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            return `${year}-${month}-${day}`;
                        } catch (e) {
                            return dateStr;
                        }
                    }
                    
                    // ê¸°ë³¸ ì •ë³´ ì±„ìš°ê¸°
                    document.getElementById('reservation_number').value = data.reservation_number || '';
                    document.getElementById('status').value = data.status || 'pending';
                    document.getElementById('reservation_date').value = formatDateForInput(data.reservation_date);
                    document.getElementById('check_in_date').value = formatDateForInput(data.check_in_date);
                    document.getElementById('check_out_date').value = formatDateForInput(data.check_out_date);
                    document.getElementById('arrival_flight').value = data.arrival_flight || '';
                    document.getElementById('departure_flight').value = data.departure_flight || '';
                    document.getElementById('special_requests').value = data.special_requests || '';
                    document.getElementById('internal_memo').value = data.internal_memo || '';
                    document.getElementById('totalRoomCharge').value = data.total_room_rate || 0;
                    document.getElementById('totalBreakfastCharge').value = data.total_breakfast_charge || 0;
                    document.getElementById('totalExtrasCharge').value = data.total_extras_rate || 0;
                    document.getElementById('agencyFee').value = data.agency_fee || 0;
                    
                    // ìˆ˜ë°°í”¼ í‘œì‹œ
                    if (data.agency_fee && data.agency_fee > 0) {
                        document.getElementById('agencyFeeRow').style.display = 'flex';
                    }
                    
                    console.log('âœ… ê¸°ë³¸ ì •ë³´ ì±„ì›€ (ì´ ê°ì‹¤: $' + (data.total_room_rate || 0) + ', ì´ ì¡°ì‹: $' + (data.total_breakfast_charge || 0) + ', ì´ ì¶”ê°€: $' + (data.total_extras_rate || 0) + ', ìˆ˜ë°°í”¼: $' + (data.agency_fee || 0) + ')');
                    
                    // â­ ì´ˆê¸° ì´ì•¡ ê³„ì‚° (ê°ì‹¤ ë¡œë“œ ì „ì´ë¯€ë¡œ ì¼ë‹¨ ê¸°ë³¸ê°’ìœ¼ë¡œ í‘œì‹œ)
                    // calculateTotal(); // ê°ì‹¤ ë¡œë“œ í›„ ë‹¤ì‹œ ê³„ì‚°
                    
                    // í˜¸í…” ì„ íƒ (â­ ë³€ê²½ ë¶ˆê°€ - disabled ì„¤ì •)
                    if (data.hotel_id) {
                        const hotelSelect = document.getElementById('hotel_id');
                        hotelSelect.value = data.hotel_id;
                        hotelSelect.disabled = true; // â­ ë³€ê²½ ë¶ˆê°€
                        await loadRoomTypes();
                        console.log('âœ… í˜¸í…” ì„ íƒ (ê³ ì •):', data.hotel_id);
                    }
                    
                    // ê±°ë˜ì²˜ ì„ íƒ (â­ ë³€ê²½ ë¶ˆê°€ - disabled ì„¤ì •, ìˆ˜ë°°í”¼ëŠ” ì´ë¯¸ ë¡œë“œë¨)
                    if (data.booking_agency_id) {
                        const agencySelect = document.getElementById('booking_agency_id');
                        agencySelect.value = data.booking_agency_id;
                        agencySelect.disabled = true; // â­ ë³€ê²½ ë¶ˆê°€
                        // calculateAgencyFee(); // â“ ì£¼ì„ ì²˜ë¦¬: ì €ì¥ëœ ìˆ˜ë°°í”¼ ê°’ ìœ ì§€
                        
                        // ê±°ë˜ì²˜ ì´ë¦„ í‘œì‹œë§Œ ì—…ë°ì´íŠ¸
                        const agency = allAgencies.find(a => a.id == data.booking_agency_id);
                        if (agency && data.agency_fee && data.agency_fee > 0) {
                            document.getElementById('agencyFeeName').textContent = agency.agency_name;
                        }
                        
                        console.log('âœ… ê±°ë˜ì²˜ ì„ íƒ (ê³ ì •):', data.booking_agency_id, 'ìˆ˜ë°°í”¼: $' + (data.agency_fee || 0));
                    }
                    
                    // ë°•ìˆ˜ ê³„ì‚°
                    calculateNights();
                    
                    // í”„ë¡œëª¨ì…˜ ì •ë³´ í‘œì‹œ
                    if (data.promotion_code) {
                        document.getElementById('noPromo').style.display = 'none';
                        document.getElementById('promoResult').style.display = 'block';
                        document.getElementById('promoResult').innerHTML = `
                            <div class="alert alert-success py-2">
                                <strong>ğŸ“Œ í”„ë¡œëª¨ì…˜ ì½”ë“œ:</strong> ${data.promotion_code}
                                ${data.rate_condition_id ? `<br><small>Rate Condition ID: ${data.rate_condition_id}</small>` : ''}
                            </div>
                        `;
                        console.log('âœ… í”„ë¡œëª¨ì…˜ í‘œì‹œ:', data.promotion_code);
                    } else {
                        document.getElementById('noPromo').style.display = 'block';
                        document.getElementById('promoResult').style.display = 'none';
                    }
                    
                    // ê°ì‹¤ ë° íˆ¬ìˆ™ê° ì •ë³´ ì¶”ê°€
                    if (data.rooms && data.rooms.length > 0) {
                        console.log('ğŸ“¦ ê°ì‹¤ ìˆ˜:', data.rooms.length);
                        for (let i = 0; i < data.rooms.length; i++) {
                            const room = data.rooms[i];
                            addRoom();
                            
                            // â­ í´ë¡œì € ë²„ê·¸ ìˆ˜ì •: roomCounter í˜„ì¬ ê°’ì„ ì¦‰ì‹œ ìº¡ì²˜
                            const currentRoomNum = roomCounter;
                            
                            // ì•½ê°„ì˜ ì§€ì—° í›„ ê°ì‹¤ ì •ë³´ ì±„ìš°ê¸°
                            setTimeout(async () => {
                                console.log(`ğŸ¨ ê°ì‹¤ ${currentRoomNum} ë°ì´í„° ë¡œë“œ ì‹œì‘ (room_type_id: ${room.room_type_id})`);
                                
                                // ê°ì‹¤ íƒ€ì… ì„ íƒ
                                const roomSelect = document.querySelector(`[data-room="${currentRoomNum}"]`);
                                if (roomSelect && room.room_type_id) {
                                    roomSelect.value = room.room_type_id;
                                    console.log(`âœ… ê°ì‹¤ ${currentRoomNum} íƒ€ì… ì„ íƒ:`, room.room_type_id);
                                }
                                
                                // ê°ì‹¤ ìš”ê¸ˆ í‘œì‹œ (â­ $ ê¸°í˜¸ ì—†ì´ ìˆ«ìë§Œ ì €ì¥)
                                const rateInput = document.getElementById(`room_${currentRoomNum}_rate`);
                                if (rateInput && room.total_selling_price) {
                                    rateInput.value = parseFloat(room.total_selling_price).toFixed(2);
                                }
                                const cfnLabel = document.getElementById(`room_${currentRoomNum}_cfn_label`);
                                if (cfnLabel) {
                                    cfnLabel.textContent = room.confirmation_number ? `CFN - #${room.confirmation_number}` : '';
                                }

                                // íˆ¬ìˆ™ê° ì •ë³´ ì±„ìš°ê¸°
                                if (room.guests && room.guests.length > 0) {
                                    console.log(`  ğŸ‘¥ ê°ì‹¤ ${currentRoomNum} íˆ¬ìˆ™ê° ìˆ˜:`, room.guests.length);
                                    room.guests.forEach((guest, guestIdx) => {
                                        if (guestIdx > 0) {
                                            addGuest(currentRoomNum);
                                        }
                                        
                                        setTimeout(() => {
                                            const guestCard = document.getElementById(`guest_${currentRoomNum}_${guestIdx + 1}`);
                                            if (guestCard) {
                                                const fields = guestCard.querySelectorAll('[data-guest-field]');
                                                fields.forEach(field => {
                                                    const fieldName = field.dataset.guestField;
                                                    let value = guest[fieldName] !== undefined && guest[fieldName] !== null ? guest[fieldName] : '';
                                                    
                                                    // â­ date_of_birthëŠ” ISO â†’ YYYY-MM-DD ë³€í™˜ í•„ìˆ˜!
                                                    if (fieldName === 'date_of_birth' && value) {
                                                        value = formatDateForInput(value);
                                                    }
                                                    
                                                    field.value = value;
                                                });
                                                console.log(`  âœ… ê°ì‹¤ ${currentRoomNum} íˆ¬ìˆ™ê° ${guestIdx + 1} ì •ë³´ ì±„ì›€ (ì´ë¦„: ${guest.guest_name_ko}, ìƒë…„ì›”ì¼: ${formatDateForInput(guest.date_of_birth)})`);
                                            }
                                        }, 100 * guestIdx);
                                    });
                                }
                                
                                // â­ ì¡°ì‹ ì •ë³´ í‘œì‹œ (ì €ì¥ëœ ê°’ ë˜ëŠ” ê°ì‹¤ íƒ€ì… ê¸°ë³¸ê°’)
                                setTimeout(() => {
                                    if (room.breakfast_included !== undefined && room.breakfast_included !== null) {
                                        // ì €ì¥ëœ ì¡°ì‹ ì •ë³´ê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ í‘œì‹œ
                                        console.log(`ğŸ³ ê°ì‹¤ ${currentRoomNum} ì €ì¥ëœ ì¡°ì‹ ë¡œë“œ:`, room.breakfast_included, room.breakfast_days, room.breakfast_adult_price, room.breakfast_child_price);
                                        
                                        const breakfastCheckbox = document.getElementById(`breakfast_included_${currentRoomNum}`);
                                        const breakfastDays = document.getElementById(`breakfast_days_${currentRoomNum}`);
                                        const breakfastAdultPrice = document.getElementById(`breakfast_adult_price_${currentRoomNum}`);
                                        const breakfastChildPrice = document.getElementById(`breakfast_child_price_${currentRoomNum}`);
                                        const breakfastFields = document.getElementById(`breakfast_fields_${currentRoomNum}`);
                                        const breakfastLabel = document.querySelector(`label[for="breakfast_included_${currentRoomNum}"]`);
                                        
                                        // â­ ì²´í¬ë°•ìŠ¤ ì„¤ì •
                                        if (breakfastCheckbox) breakfastCheckbox.checked = room.breakfast_included;
                                        
                                        // â­ í•„ë“œ ê°’ ì„¤ì • (ëœì–´ì“°ê¸° ë°©ì§€)
                                        if (breakfastDays) breakfastDays.value = room.breakfast_days || 1;
                                        if (breakfastAdultPrice) breakfastAdultPrice.value = parseFloat(room.breakfast_adult_price || 0).toFixed(2);
                                        if (breakfastChildPrice) breakfastChildPrice.value = parseFloat(room.breakfast_child_price || 0).toFixed(2);
                                        
                                        // â­ í•„ë“œ í‘œì‹œ ë° ë ˆì´ë¸” ì—…ë°ì´íŠ¸ (ê°’ ë³€ê²½ ì—†ìŒ)
                                        if (breakfastFields) {
                                            breakfastFields.style.display = room.breakfast_included ? 'block' : 'none';
                                        }
                                        if (breakfastLabel) {
                                            breakfastLabel.innerHTML = room.breakfast_included 
                                                ? '<i class="fas fa-utensils me-1"></i>ì¡°ì‹ í¬í•¨'
                                                : '<i class="fas fa-utensils me-1"></i>ì¡°ì‹ ë¶ˆí¬í•¨';
                                        }
                                        
                                        console.log(`  â†’ íšŒìˆ˜: ${room.breakfast_days}ì¼, ì„±ì¸: $${room.breakfast_adult_price}, ì†Œì•„: $${room.breakfast_child_price}`);
                                    } else {
                                        // ì €ì¥ëœ ì •ë³´ê°€ ì—†ìœ¼ë©´ ê°ì‹¤ íƒ€ì… ê¸°ë³¸ê°’ ì‚¬ìš©
                                        if (room.room_type_id) {
                                            const roomType = allRoomTypes.find(rt => rt.id == room.room_type_id);
                                            if (roomType) {
                                                displayBreakfastInfo(currentRoomNum, roomType);
                                            }
                                        }
                                    }
                                }, 150);
                                
                                // â­ í”„ë¡œëª¨ì…˜ ì •ë³´ í‘œì‹œ (ìƒˆë¡œ ì¡°íšŒí•˜ì§€ ì•Šê³  ì €ì¥ëœ ì •ë³´ í‘œì‹œ)
                                if (room.promotion_code) {
                                    // roomPromotionsì— ì €ì¥
                                    roomPromotions[currentRoomNum] = {
                                        promotion: { promo_code: room.promotion_code },
                                        rate_condition_id: room.rate_condition_id,
                                        total_room_rate: room.total_selling_price
                                    };
                                    
                                    // í”„ë¡œëª¨ì…˜ ì •ë³´ UIì— ì§ì ‘ í‘œì‹œ
                                    setTimeout(() => {
                                        const roomCard = document.querySelector(`[data-room-id="${currentRoomNum}"]`);
                                        if (roomCard) {
                                            // í”„ë¡œëª¨ì…˜ í‘œì‹œ ì˜ì—­ ì°¾ê¸° ë˜ëŠ” ìƒì„±
                                            let promoDisplayArea = roomCard.querySelector('.room-promo-display');
                                            if (!promoDisplayArea) {
                                                const roomTypeSelect = roomCard.querySelector(`[data-room="${currentRoomNum}"]`)?.parentElement;
                                                if (roomTypeSelect) {
                                                    promoDisplayArea = document.createElement('div');
                                                    promoDisplayArea.className = 'room-promo-display mt-2';
                                                    roomTypeSelect.after(promoDisplayArea);
                                                }
                                            }
                                            
                                            if (promoDisplayArea) {
                                                promoDisplayArea.innerHTML = `
                                                    <div class="alert alert-info py-2 mb-2">
                                                        <i class="fas fa-tag me-2"></i>
                                                        <strong>í”„ë¡œëª¨ì…˜:</strong> <code class="bg-light px-2 py-1">${room.promotion_code}</code>
                                                        ${room.rate_condition_id ? `<br><small class="text-muted">Rate ID: ${room.rate_condition_id}</small>` : ''}
                                                        <br><small class="text-muted">ê°ì‹¤ ìš”ê¸ˆ: <strong>$${parseFloat(room.total_selling_price).toFixed(2)}</strong></small>
                                                    </div>
                                                `;
                                                console.log(`ğŸ“Œ ê°ì‹¤ ${currentRoomNum} í”„ë¡œëª¨ì…˜ í‘œì‹œ: ${room.promotion_code} ($${room.total_selling_price})`);
                                            }
                                        }
                                    }, 200);
                                }
                            }, 100 * i);
                        }
                    } else {
                        addRoom();
                    }
                    
                    // ì¶”ê°€ í•­ëª© ë¡œë“œ
                    setTimeout(() => {
                        let totalExtras = 0;
                        let displayedExtras = 0;  // â­ ì‹¤ì œ í‘œì‹œëœ í•­ëª© ìˆ˜
                        
                        if (data.extras && data.extras.length > 0) {
                            console.log('ğŸ ì¶”ê°€ í•­ëª© ìˆ˜:', data.extras.length);
                            data.extras.forEach((extra, idx) => {
                                // â­ ì¡°ì‹ì€ ê°ì‹¤ ì •ë³´ì— í‘œì‹œë˜ë¯€ë¡œ ì¶”ê°€ í•­ëª©ì—ì„œ ì œì™¸
                                if (extra.item_name && extra.item_name.includes('ì¡°ì‹')) {
                                    console.log(`â­ï¸ ì¡°ì‹ í•­ëª© ê±´ë„ˆëœ€: ${extra.item_name} (ê°ì‹¤ ì •ë³´ì— í‘œì‹œë¨)`);
                                    return;
                                }
                                
                                displayedExtras++;
                                addExtraItem();
                                
                                // â­ í´ë¡œì € ë²„ê·¸ ìˆ˜ì •: extraCounter í˜„ì¬ ê°’ì„ ì¦‰ì‹œ ìº¡ì²˜
                                const currentExtraNum = extraCounter;
                                
                                setTimeout(() => {
                                    console.log(`ğŸ“ ì¶”ê°€í•­ëª© ${currentExtraNum} ë¡œë“œ ì‹œì‘:`, extra.item_name);
                                    const extraCard = document.getElementById(`extra_${currentExtraNum}`);
                                    if (extraCard) {
                                        const itemNameInput = extraCard.querySelector('[data-extra-field="item_name"]');
                                        const quantityInput = extraCard.querySelector('[data-extra-field="quantity"]');
                                        const pricingTypeInput = extraCard.querySelector('[data-extra-field="pricing_type"]');
                                        const inHotelSelect = extraCard.querySelector('[data-extra-field="in_hotel"]');
                                        
                                        if (itemNameInput) itemNameInput.value = extra.item_name || '';
                                        if (quantityInput) quantityInput.value = extra.quantity || 1;
                                        // ì¸/ì•„ì›ƒ í˜¸í…” ì„¤ì • (notes ì»¬ëŸ¼ ê¸°ë°˜, ê¸°ë³¸ê°’ì€ IN_HOTEL)
                                        const scope = (extra.notes || 'IN_HOTEL');
                                        if (inHotelSelect) {
                                            inHotelSelect.value = scope === 'OUT_HOTEL' ? 'out' : 'in';
                                        }
                                        
                                        // â­ pricing_type ì„¤ì • í›„ ì¦‰ì‹œ UI ì „í™˜
                                        const actualPricingType = extra.item_type || extra.pricing_type || 'flat';
                                        if (pricingTypeInput) pricingTypeInput.value = actualPricingType;
                                        toggleExtraPricing(currentExtraNum);  // â­ UI ë¨¼ì € ì „í™˜!
                                        
                                        console.log(`  â†’ í•­ëª©ëª…: ${extra.item_name}, ìˆ˜ëŸ‰: ${extra.quantity}, ìœ í˜•: ${actualPricingType}`);
                                        
                                        // pricing_typeì— ë”°ë¼ í•„ë“œ ì±„ìš°ê¸°
                                        if (actualPricingType === 'per_person') {
                                            // ì¸ì›ë³„ ìš”ê¸ˆ
                                            const adultCountInput = extraCard.querySelector('[data-extra-field="adult_count"]');
                                            const adultPriceInput = extraCard.querySelector('[data-extra-field="adult_price"]');
                                            const childCountInput = extraCard.querySelector('[data-extra-field="child_count"]');
                                            const childPriceInput = extraCard.querySelector('[data-extra-field="child_price"]');
                                            const infantCountInput = extraCard.querySelector('[data-extra-field="infant_count"]');
                                            const infantPriceInput = extraCard.querySelector('[data-extra-field="infant_price"]');
                                            
                                            if (adultCountInput) adultCountInput.value = extra.adult_count || 0;
                                            if (adultPriceInput) adultPriceInput.value = extra.adult_price || 0;
                                            if (childCountInput) childCountInput.value = extra.child_count || 0;
                                            if (childPriceInput) childPriceInput.value = extra.child_price || 0;
                                            if (infantCountInput) infantCountInput.value = extra.infant_count || 0;
                                            if (infantPriceInput) infantPriceInput.value = extra.infant_price || 0;
                                            
                                            console.log(`  â†’ ì¸ì›ë³„: ì„±ì¸ ${extra.adult_count}ëª…Ã—$${extra.adult_price}, ì†Œì•„ ${extra.child_count}ëª…Ã—$${extra.child_price}`);
                                        } else {
                                            // ì •ì•¡ ìš”ê¸ˆ
                                            const unitPriceInput = extraCard.querySelector('[data-extra-field="unit_price"]');
                                            if (unitPriceInput) unitPriceInput.value = extra.unit_price || 0;
                                            
                                            console.log(`  â†’ ì •ì•¡: $${extra.unit_price}`);
                                        }
                                        
                                        // â­ ì†Œê³„ ê³„ì‚° (ì´ë¯¸ toggleExtraPricing í˜¸ì¶œí•¨)
                                        calculateExtraTotal(currentExtraNum);
                                        
                                        console.log(`  âœ… ì¶”ê°€í•­ëª© ${idx + 1} ì™„ë£Œ`);
                                    } else {
                                        console.error(`âŒ ì¶”ê°€í•­ëª© ì¹´ë“œ ì°¾ì„ ìˆ˜ ì—†ìŒ: extra_${currentExtraNum}`);
                                    }
                                }, 100 * idx);
                            });
                            
                            // â­ displayedExtras ê¸°ë°˜ìœ¼ë¡œ íƒ€ì´ë° ì¡°ì •
                            const delayTime = displayedExtras > 0 ? (100 * displayedExtras + 100) : 200;
                            
                            setTimeout(() => {
                                if (displayedExtras === 0) {
                                    console.log('â„¹ï¸ í‘œì‹œí•  ì¶”ê°€ í•­ëª© ì—†ìŒ (ì¡°ì‹ í•­ëª©ì€ ê°ì‹¤ ì •ë³´ì— í¬í•¨)');
                                } else {
                                    console.log(`âœ… ì¶”ê°€ í•­ëª© ${displayedExtras}ê°œ ë¡œë“œ ì™„ë£Œ`);
                                }
                                
                                // â­ ì¡°ì‹ ìš”ê¸ˆ ì¬ê³„ì‚° (ê°ì‹¤ë³„ ì¡°ì‹ ì •ë³´ ë¡œë“œ ì™„ë£Œ í›„)
                                updateRoomCharges();
                                
                                // â­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ - ì´ì œ í”„ë¡œëª¨ì…˜ ì¡°íšŒ ê°€ëŠ¥
                                isLoadingData = false;
                                console.log('âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ - í”„ë¡œëª¨ì…˜ ì¡°íšŒ í™œì„±í™”');
                                
                                // â­ ëª¨ë“  ë°ì´í„° ë¡œë“œ í›„ ìµœì¢… í•©ê³„ ê³„ì‚°
                                setTimeout(() => {
                                    calculateTotal();
                                    console.log('ğŸ’° ìµœì¢… í•©ê³„ ê³„ì‚° ì™„ë£Œ');
                                }, 100);
                            }, delayTime);
                        } else {
                            // ì¶”ê°€ í•­ëª©ì´ ì—†ëŠ” ê²½ìš°ë„ ì¡°ì‹ ìš”ê¸ˆ ê³„ì‚°
                            setTimeout(() => {
                                updateRoomCharges();
                                isLoadingData = false;
                                console.log('âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ (ì¶”ê°€ í•­ëª© ì—†ìŒ)');
                                
                                // â­ ëª¨ë“  ë°ì´í„° ë¡œë“œ í›„ ìµœì¢… í•©ê³„ ê³„ì‚°
                                setTimeout(() => {
                                    calculateTotal();
                                    console.log('ğŸ’° ìµœì¢… í•©ê³„ ê³„ì‚° ì™„ë£Œ');
                                }, 100);
                            }, 200);
                        }
                    }, 500);
                    
                }, 300);
                
            } catch (error) {
                console.error('âŒ ì˜ˆì•½ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì˜ˆì•½ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ìˆ˜ì •ì‚¬í•­ ì €ì¥
        async function saveReservationChanges() {
            if (!currentEditingId) {
                alert('ì €ì¥í•  ì˜ˆì•½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ê¸°ë³¸ ì •ë³´ ìˆ˜ì§‘
            const hotelId = document.getElementById('hotel_id').value;
            const bookingAgencyId = document.getElementById('booking_agency_id').value;
            
            if (!hotelId) {
                alert('í˜¸í…”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ê°ì‹¤ ë°ì´í„° ìˆ˜ì§‘
            const rooms = [];
            document.querySelectorAll('.room-card').forEach(roomCard => {
                const roomNum = roomCard.dataset.roomId;
                const roomTypeSelect = roomCard.querySelector(`[data-room="${roomNum}"]`);
                const roomTypeId = roomTypeSelect?.value;
                
                if (!roomTypeId) return;
                
                // íˆ¬ìˆ™ê° ë°ì´í„° ìˆ˜ì§‘
                const guests = [];
                const guestCards = roomCard.querySelectorAll('.guest-card');
                guestCards.forEach(guestCard => {
                    const guestData = {};
                    const fields = guestCard.querySelectorAll('[data-guest-field]');
                    fields.forEach(field => {
                        const fieldName = field.dataset.guestField;
                        // â­ ë¹ˆ ë¬¸ìì—´ì€ nullë¡œ ë³€í™˜ (íŠ¹íˆ date_of_birth)
                        const value = field.value?.trim();
                        guestData[fieldName] = value && value !== '' ? value : null;
                    });
                    
                    // ìµœì†Œí•œ ì´ë¦„ì´ ìˆì–´ì•¼ ì¶”ê°€
                    if (guestData.guest_name_ko || guestData.guest_name_en) {
                        console.log(`  â†’ íˆ¬ìˆ™ê° ì €ì¥:`, guestData.guest_name_ko, `ìƒë…„ì›”ì¼: ${guestData.date_of_birth}`);
                        guests.push(guestData);
                    }
                });
                
                // í”„ë¡œëª¨ì…˜ ì •ë³´
                const roomPromo = roomPromotions[roomNum];
                
                // â­ ê°ì‹¤ ìš”ê¸ˆ (ì…ë ¥ í•„ë“œì—ì„œ ì§ì ‘ ì½ê¸°)
                const roomRateInput = document.getElementById(`room_${roomNum}_rate`);
                const totalSellingPrice = parseFloat(roomRateInput?.value) || 0;
                
                // â­ ì¡°ì‹ ì •ë³´ ìˆ˜ì§‘
                const breakfastIncluded = document.getElementById(`breakfast_included_${roomNum}`)?.checked || false;
                const breakfastDays = parseInt(document.getElementById(`breakfast_days_${roomNum}`)?.value) || 1;
                const breakfastAdultPrice = parseFloat(document.getElementById(`breakfast_adult_price_${roomNum}`)?.value) || 0;
                const breakfastChildPrice = parseFloat(document.getElementById(`breakfast_child_price_${roomNum}`)?.value) || 0;
                
                rooms.push({
                    room_type_id: parseInt(roomTypeId),
                    guests: guests,
                    promotion_code: roomPromo?.promotion?.promo_code || null,
                    rate_condition_id: roomPromo?.rate_condition_id || null,
                    total_selling_price: totalSellingPrice, // â­ ì…ë ¥ í•„ë“œì—ì„œ ì§ì ‘ ì½ì€ ê°’ ì‚¬ìš©
                    // â­ ì¡°ì‹ ì •ë³´ ì¶”ê°€
                    breakfast_included: breakfastIncluded,
                    breakfast_days: breakfastIncluded ? breakfastDays : 0,
                    breakfast_adult_price: breakfastIncluded ? breakfastAdultPrice : 0,
                    breakfast_child_price: breakfastIncluded ? breakfastChildPrice : 0
                });
                
                console.log(`  â†’ ê°ì‹¤ ${roomNum} ì €ì¥: ë£¸íƒ€ì…=${roomTypeId}, í”„ë¡œëª¨ì…˜=${roomPromo?.promotion?.promo_code}, ìš”ê¸ˆ=$${totalSellingPrice}, ì¡°ì‹=${breakfastIncluded}`);
            });
            
            if (rooms.length === 0) {
                alert('ìµœì†Œ 1ê°œì˜ ê°ì‹¤ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì¶”ê°€ í•­ëª© ìˆ˜ì§‘
            const extras = [];
            document.querySelectorAll('.extra-item-card').forEach((extraCard, cardIndex) => {
                const extraNum = extraCard.querySelector('[data-extra-field="quantity"]')?.dataset.extra;
                if (!extraNum) {
                    console.warn(`âš ï¸ ì¶”ê°€í•­ëª© ì¹´ë“œ ${cardIndex}ì— data-extra ì†ì„±ì´ ì—†ìŠµë‹ˆë‹¤.`);
                    return;
                }
                
                const itemName = extraCard.querySelector('[data-extra-field="item_name"]')?.value?.trim();
                
                // â­ ì¡°ì‹ì€ ê°ì‹¤ ì •ë³´ì— í¬í•¨ë˜ë¯€ë¡œ ì €ì¥ì—ì„œ ì œì™¸
                if (itemName && itemName.includes('ì¡°ì‹')) {
                    console.log(`â­ï¸ ì¡°ì‹ í•­ëª© ì €ì¥ ì œì™¸: ${itemName} (ê°ì‹¤ íƒ€ì…ì— í¬í•¨ë¨)`);
                    return;
                }
                
                const pricingType = extraCard.querySelector('[data-extra-field="pricing_type"]')?.value || 'flat';
                const inHotel = extraCard.querySelector('[data-extra-field="in_hotel"]')?.value || 'in';
                const quantity = parseInt(extraCard.querySelector('[data-extra-field="quantity"]')?.value) || 1;
                
                console.log(`\nğŸ“ ì¶”ê°€í•­ëª© ${cardIndex + 1} (extraNum: ${extraNum}) ìˆ˜ì§‘ ì‹œì‘:`);
                console.log(`  í•­ëª©ëª…: ${itemName}, ìœ í˜•: ${pricingType}, ìˆ˜ëŸ‰: ${quantity}`);
                
                let totalPrice = 0;
                let extraData = {
                    item_name: itemName,
                    pricing_type: pricingType,
                    quantity: quantity,
                    in_hotel: inHotel
                };
                
                if (pricingType === 'per_person') {
                    const adultCount = parseInt(extraCard.querySelector('[data-extra-field="adult_count"]')?.value) || 0;
                    const adultPrice = parseFloat(extraCard.querySelector('[data-extra-field="adult_price"]')?.value) || 0;
                    const childCount = parseInt(extraCard.querySelector('[data-extra-field="child_count"]')?.value) || 0;
                    const childPrice = parseFloat(extraCard.querySelector('[data-extra-field="child_price"]')?.value) || 0;
                    const infantCount = parseInt(extraCard.querySelector('[data-extra-field="infant_count"]')?.value) || 0;
                    const infantPrice = parseFloat(extraCard.querySelector('[data-extra-field="infant_price"]')?.value) || 0;
                    
                    totalPrice = (adultCount * adultPrice + childCount * childPrice + infantCount * infantPrice) * quantity;
                    
                    extraData.adult_count = adultCount;
                    extraData.adult_price = adultPrice;
                    extraData.child_count = childCount;
                    extraData.child_price = childPrice;
                    extraData.infant_count = infantCount;
                    extraData.infant_price = infantPrice;
                    extraData.unit_price = null;
                    
                    console.log(`  â†’ ì¸ì›ë³„ ìš”ê¸ˆ ì €ì¥: ${itemName} - ì„±ì¸ ${adultCount}Ã—$${adultPrice}, ì†Œì•„ ${childCount}Ã—$${childPrice}, ì´: $${totalPrice}`);
                } else {
                    const unitPrice = parseFloat(extraCard.querySelector('[data-extra-field="unit_price"]')?.value) || 0;
                    totalPrice = unitPrice * quantity;
                    extraData.unit_price = unitPrice;
                    extraData.adult_count = null;
                    extraData.adult_price = null;
                    extraData.child_count = null;
                    extraData.child_price = null;
                    extraData.infant_count = null;
                    extraData.infant_price = null;
                    
                    console.log(`  â†’ ì •ì•¡ ìš”ê¸ˆ ì €ì¥: ${itemName} - ìˆ˜ëŸ‰ ${quantity}Ã—$${unitPrice}, ì´: $${totalPrice}`);
                }
                
                extraData.total_selling_price = totalPrice;
                
                if (itemName) {
                    extras.push(extraData);
                }
            });
            
            // ì „ì²´ ìš”ê¸ˆ ìš”ì•½ ê°’ ê³„ì‚° (â­ ì¡°ì‹ + ì¶”ê°€ìš”ê¸ˆ + ìˆ˜ë°°í”¼ í¬í•¨)
            const totalRoomCharge = parseFloat(document.getElementById('totalRoomCharge').value) || 0;
            const totalBreakfastCharge = parseFloat(document.getElementById('totalBreakfastCharge').value) || 0;
            const totalExtrasCharge = parseFloat(document.getElementById('totalExtrasCharge').value) || 0;
            const agencyFee = parseFloat(document.getElementById('agencyFee').value) || 0;
            const grandTotal = totalRoomCharge + totalBreakfastCharge + totalExtrasCharge + agencyFee;

            // ì „ì²´ ë°ì´í„° êµ¬ì„±
            const updatedData = {
                hotel_id: parseInt(hotelId),
                booking_agency_id: bookingAgencyId ? parseInt(bookingAgencyId) : null,
                reservation_date: document.getElementById('reservation_date').value,
                status: document.getElementById('status').value,
                check_in_date: document.getElementById('check_in_date').value,
                check_out_date: document.getElementById('check_out_date').value,
                arrival_flight: document.getElementById('arrival_flight').value || null,
                departure_flight: document.getElementById('departure_flight').value || null,
                special_requests: document.getElementById('special_requests').value || null,
                internal_memo: document.getElementById('internal_memo').value || null,
                // â­ ìš”ì•½ ê¸ˆì•¡ í•„ë“œë“¤ (ìˆ˜ë°°í”¼ í¬í•¨)
                total_room_rate: totalRoomCharge,
                total_extras_rate: totalExtrasCharge,
                agency_fee: agencyFee,
                grand_total: grandTotal,
                total_selling_price: grandTotal,
                rooms: rooms,
                extras: extras
            };
            
            console.log('ğŸ’¾ ì €ì¥ ë°ì´í„°:', updatedData);
            
            try {
                const response = await fetch(`/api/hotel-reservations/${currentEditingId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('âœ… ì˜ˆì•½ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    lastClosedReservationId = currentEditingId;
                    bootstrap.Modal.getInstance(document.getElementById('editReservationModal')).hide();
                    loadReservations();
                } else {
                    console.error('ì €ì¥ ì‹¤íŒ¨:', result);
                    alert('âŒ ìˆ˜ì • ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('âŒ ìˆ˜ì • ì˜¤ë¥˜:', error);
                alert('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ìˆ˜ë°°ì„œ ìƒì„±/ë³´ê¸°
        async function createAssignment(reservationId) {
            lastClosedReservationId = reservationId;
            highlightReservationRow(reservationId); // í•´ë‹¹ í–‰ë§Œ ê°•ì¡°
            
            try {
                // ì˜ˆì•½ ì •ë³´ ì¡°íšŒ
                const response = await fetch(`/api/hotel-reservations/${reservationId}`);
                const reservation = await response.json();
                
                console.log('ğŸ“‹ ì˜ˆì•½ ì •ë³´ ì¡°íšŒ ê²°ê³¼:', reservation);
                
                if (!response.ok) {
                    throw new Error(reservation.message || 'ì˜ˆì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // â­ ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬ ë° ê¸°ë³¸ê°’ ì„¤ì •
                if (!reservation.rooms) reservation.rooms = [];
                if (!reservation.extras) reservation.extras = [];
                
                reservation.rooms.forEach((room, idx) => {
                    console.log(`  ğŸ“¦ Room ${idx+1} ë°ì´í„° í™•ì¸:`, room);
                    // ì¡°ì‹ í•„ë“œ í™•ì¸
                    console.log(`    ğŸ³ ì¡°ì‹: included=${room.breakfast_included}, days=${room.breakfast_days}, adult=${room.breakfast_adult_count}`);
                });
                
                // ìˆ˜ë°°ì„œ ì´ë ¥ ì¡°íšŒ
                const historyResponse = await fetch(`/api/hotel-assignments/${reservationId}/history`);
                const historyData = await historyResponse.json();
                const history = historyData.success ? historyData.history : [];
                
                console.log('ğŸ“œ ìˆ˜ë°°ì„œ ì´ë ¥:', history);
                
                // ìˆ˜ë°°ì„œ ëª¨ë‹¬ ì—´ê¸°
                openAssignmentModal(reservation, history);
                
            } catch (error) {
                console.error('âŒ ìˆ˜ë°°ì„œ ì¡°íšŒ ì˜¤ë¥˜:', error);
                alert('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ì´ë©”ì¼ ì…ë ¥ í•„ë“œ í† ê¸€
        function toggleEmailInput() {
            const method = document.querySelector('input[name="deliveryMethod"]:checked').value;
            const emailGroup = document.getElementById('instantEmailGroup');
            if (method === 'email') {
                emailGroup.style.display = 'block';
            } else {
                emailGroup.style.display = 'none';
            }
        }

        // ìˆ˜ë°°ì„œ ëª¨ë‹¬ ì—´ê¸°
        function openAssignmentModal(reservation, history) {
            console.log('ğŸ”§ ëª¨ë‹¬ ì—´ê¸° - ì˜ˆì•½ ë°ì´í„°:', reservation);
            console.log('- reservation:', reservation);
            console.log('- reservation.rooms:', reservation.rooms);
            console.log('- reservation.extras:', reservation.extras);
            
            const modal = new bootstrap.Modal(document.getElementById('assignmentModal'));
            
            // A4 ìˆ˜ë°°ì„œ ë¯¸ë¦¬ë³´ê¸° ìƒì„±
            const assignmentHTML = generateA4AssignmentPreview(reservation, history);
            document.getElementById('assignmentPreview').innerHTML = assignmentHTML;
            
            // í˜„ì¬ ì˜ˆì•½ ì •ë³´ ì €ì¥
            window.currentAssignmentReservationId = reservation.id;
            window.currentAssignmentReservation = reservation;
            window.currentAssignmentHistory = history;
            
            // ìƒì„±ëœ ìˆ˜ë°°ì„œ ëª©ë¡ ë¡œë“œ
            loadAssignmentsList(reservation.id);
            
            // ëª¨ë‹¬ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('newAssignmentTypeSelect').value = 'NEW';
            document.getElementById('newChangesDescriptionInput').value = '';
            document.getElementById('newChangesDescriptionGroup').style.display = 'none';
            
            // ì „ì†¡ ë°©ì‹ ì´ˆê¸°í™” (ìƒì„±ë§Œ í•˜ê¸°)
            document.getElementById('methodCreateOnly').checked = true;
            toggleEmailInput();
            
            // í˜¸í…” ì´ë©”ì¼ì´ ìˆìœ¼ë©´ ìë™ ì±„ìš°ê¸°
            if (reservation.hotel_email) {
                document.getElementById('instantRecipientEmail').value = reservation.hotel_email;
            } else {
                document.getElementById('instantRecipientEmail').value = '';
            }
            
            modal.show();
        }
        
        // ì „ì†¡ íƒ€ì…/ë°©ì‹ì— ë”°ë¼ ëª¨ë‹¬ íƒ€ì´í‹€ ë™ì  ë³€ê²½
        function updateAssignmentModalTitle() {
            const type = document.getElementById('newAssignmentTypeSelect').value;
            const method = document.querySelector('input[name="deliveryMethod"]:checked')?.value || 'create_only';
            const titleEl = document.getElementById('assignmentModalTitle');

            let typeLabel = '';
            if (type === 'NEW') typeLabel = 'ì‹ ê·œ ìˆ˜ë°°ì„œ';
            else if (type === 'REVISE') typeLabel = 'ìˆ˜ì • ìˆ˜ë°°ì„œ';
            else if (type === 'CANCEL') typeLabel = 'ì·¨ì†Œ ìˆ˜ë°°ì„œ';

            let methodLabel = '';
            if (method === 'create_only') methodLabel = 'ìƒì„±';
            else if (method === 'email') methodLabel = 'ìƒì„± ë° ì´ë©”ì¼ ì „ì†¡';
            else if (method === 'link') methodLabel = 'ìƒì„± ë° ë§í¬ ë³µì‚¬';

            titleEl.innerHTML = `<i class="fas fa-file-contract me-2"></i>${typeLabel} ${methodLabel}`;
        }

        // ì „ì†¡ íƒ€ì… ë³€ê²½ í•¸ë“¤ëŸ¬ (ìƒˆ ìˆ˜ë°°ì„œ ìƒì„±ìš©)
        document.getElementById('newAssignmentTypeSelect').addEventListener('change', function(e) {
            const descGroup = document.getElementById('newChangesDescriptionGroup');
            if (e.target.value === 'REVISE' || e.target.value === 'CANCEL') {
                descGroup.style.display = 'block';
            } else {
                descGroup.style.display = 'none';
            }
            updateAssignmentModalTitle();
        });
        
        // ìˆ˜ë°°ì„œ ìƒì„± ë° ì²˜ë¦¬ í•¨ìˆ˜
        async function createNewAssignment() {
            const reservationId = window.currentAssignmentReservationId;
            if (!reservationId) {
                alert('ì˜ˆì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const assignmentType = document.getElementById('newAssignmentTypeSelect').value;
            const changesDescription = document.getElementById('newChangesDescriptionInput').value;
            
            // ì „ì†¡ ë°©ì‹ í™•ì¸
            const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked').value;
            const recipientEmail = document.getElementById('instantRecipientEmail').value;
            
            // ê²€ì¦
            if ((assignmentType === 'REVISE' || assignmentType === 'CANCEL') && !changesDescription.trim()) {
                alert('ë³€ê²½/ì·¨ì†Œ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            if (deliveryMethod === 'email' && !recipientEmail) {
                alert('ìˆ˜ì‹  ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                document.getElementById('instantRecipientEmail').focus();
                return;
            }
            
            // í™•ì¸ ë©”ì‹œì§€ êµ¬ì„±
            let typeLabel = assignmentType === 'NEW' ? 'ì‹ ê·œ' : (assignmentType === 'REVISE' ? 'ìˆ˜ì •' : 'ì·¨ì†Œ');
            let actionLabel = 'ìƒì„±';
            if (deliveryMethod === 'email') actionLabel = `ìƒì„± í›„ ${recipientEmail}ë¡œ ì „ì†¡`;
            else if (deliveryMethod === 'link') actionLabel = 'ìƒì„± í›„ ë§í¬ ë³µì‚¬';
            
            if (!confirm(`${typeLabel} ìˆ˜ë°°ì„œë¥¼ ${actionLabel}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            try {
                // 1. ìˆ˜ë°°ì„œ ìƒì„±
                const response = await fetch('/api/hotel-assignment-management/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reservation_id: reservationId,
                        assignment_type: assignmentType,
                        changes_description: changesDescription || null,
                        sent_by: '<%= adminUsername %>' // í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    alert('âŒ ìƒì„± ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    return;
                }
                
                const assignmentId = result.assignment_id;
                const assignmentToken = result.assignment_token;
                const link = `${window.location.origin}/hotel-assignment/view/${assignmentToken}`;
                
                // 2. í›„ì† ì‘ì—… ìˆ˜í–‰
                if (deliveryMethod === 'email') {
                    // ì´ë©”ì¼ ì „ì†¡ API í˜¸ì¶œ
                    const sendResponse = await fetch(`/api/hotel-assignment-management/${assignmentId}/send`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ hotel_email: recipientEmail })
                    });
                    
                    const sendResult = await sendResponse.json();
                    
                    if (sendResult.success) {
                        alert(`âœ… ìˆ˜ë°°ì„œ ìƒì„± ë° ì´ë©”ì¼ ì „ì†¡ ì™„ë£Œ!\n\nìˆ˜ì‹ : ${sendResult.sent_to}`);
                    } else {
                        alert(`âš ï¸ ìˆ˜ë°°ì„œëŠ” ìƒì„±ë˜ì—ˆìœ¼ë‚˜ ì´ë©”ì¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ${sendResult.error}`);
                    }
                    
                } else if (deliveryMethod === 'link') {
                    // ë§í¬ ë³µì‚¬
                    try {
                        await navigator.clipboard.writeText(link);
                        alert(`âœ… ìˆ˜ë°°ì„œê°€ ìƒì„±ë˜ê³  ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n${link}`);
                    } catch (err) {
                        // fallback
                        const tempInput = document.createElement('input');
                        tempInput.value = link;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        alert(`âœ… ìˆ˜ë°°ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n${link}`);
                    }
                    
                } else {
                    // ìƒì„±ë§Œ í•˜ê¸°
                    alert(`âœ… ìˆ˜ë°°ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\n\níƒ€ì…: ${result.assignment_type}${result.revision_number > 0 ? ' #' + result.revision_number : ''}`);
                }
                
                // 3. UI ì´ˆê¸°í™” ë° ëª©ë¡ ê°±ì‹ 
                document.getElementById('newAssignmentTypeSelect').value = 'NEW';
                document.getElementById('newChangesDescriptionInput').value = '';
                document.getElementById('newChangesDescriptionGroup').style.display = 'none';
                document.getElementById('methodCreateOnly').checked = true;
                toggleEmailInput();
                updateAssignmentModalTitle();
                
                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨ í›„ ëª©ë¡ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
                await loadAssignmentsList(reservationId);
                const listContainer = document.getElementById('assignmentsList');
                if (listContainer) {
                    listContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
            } catch (error) {
                console.error('âŒ ìˆ˜ë°°ì„œ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                alert('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ìƒì„±ëœ ìˆ˜ë°°ì„œ ëª©ë¡ ë¡œë“œ
        async function loadAssignmentsList(reservationId) {
            try {
                const response = await fetch(`/api/hotel-assignment-management/list/${reservationId}`);
                const result = await response.json();
                
                const listContainer = document.getElementById('assignmentsList');
                
                if (result.success && result.assignments && result.assignments.length > 0) {
                    let html = '<div class="list-group list-group-flush">';
                    
                    result.assignments.forEach(assignment => {
                        html += renderAssignmentItem(assignment);
                    });
                    
                    html += '</div>';
                    listContainer.innerHTML = html;
                } else {
                    listContainer.innerHTML = `
                        <div class="text-center text-muted p-4">
                            <i class="fas fa-inbox fa-3x mb-2"></i>
                            <p class="mb-0 small">ì•„ì§ ìƒì„±ëœ ìˆ˜ë°°ì„œê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('âŒ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // ìˆ˜ë°°ì„œ í•­ëª© ë Œë”ë§
        function renderAssignmentItem(assignment) {
            const typeLabel = assignment.assignment_type === 'NEW' ? 'NEW' : 
                            (assignment.assignment_type === 'REVISE' ? `REV#${assignment.revision_number}` : 'CANCEL');
            const typeBadgeClass = assignment.assignment_type === 'NEW' ? 'bg-primary' : 
                                   (assignment.assignment_type === 'REVISE' ? 'bg-warning' : 'bg-danger');
            
            const createdDate = new Date(assignment.created_at).toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const assignmentLink = `${window.location.origin}/hotel-assignment/view/${assignment.assignment_token}`;

            // ë©”ì¼ ì „ì†¡/ì—´ëŒ ìƒíƒœ
            const emailSent = assignment.sent_to_email && assignment.sent_at;
            const emailViewed = assignment.email_viewed;

            let sentAtText = '-';
            let viewedText = '-';
            if (emailSent) {
                sentAtText = new Date(assignment.sent_at).toLocaleString('ko-KR', {
                    year: '2-digit', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                });
            }
            if (emailViewed && assignment.viewed_at) {
                viewedText = `${new Date(assignment.viewed_at).toLocaleString('ko-KR', {
                    year: '2-digit', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                })} (${assignment.view_count || 1}íšŒ)`;
            }

            return `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <div>
                            <span class="badge ${typeBadgeClass} me-2">${typeLabel}</span>
                            <small class="text-muted">${createdDate}</small>
                        </div>
                        <small class="text-muted">by ${assignment.sent_by || 'Admin'}</small>
                    </div>

                    ${assignment.changes_description ? `
                        <div class="alert alert-warning py-1 px-2 mb-2" style="font-size: 11px;">
                            <strong>ì‚¬ìœ :</strong> ${assignment.changes_description}
                        </div>
                    ` : ''}

                    <div class="btn-group btn-group-sm w-100 mb-2" role="group">
                        <button class="btn btn-outline-secondary" onclick="window.open('${assignmentLink}', '_blank')">
                            <i class="fas fa-eye me-1"></i>ë¯¸ë¦¬ë³´ê¸°
                        </button>
                        <button class="btn btn-outline-primary" onclick="sendAssignmentEmailById('${assignment.id}', '${assignment.assignment_token}')">
                            <i class="fas fa-envelope me-1"></i>ë©”ì¼ ë³´ë‚´ê¸°
                        </button>
                        <button class="btn btn-outline-info" onclick="copyAssignmentLinkById('${assignmentLink}')">
                            <i class="fas fa-link me-1"></i>ë§í¬ ë³µì‚¬
                        </button>
                    </div>

                    <div class="row" style="font-size: 11px;">
                        <div class="col-6">
                            <div class="text-muted">ì „ì†¡ ì´ë©”ì¼</div>
                            <div>${assignment.sent_to_email || '-'}</div>
                        </div>
                        <div class="col-3">
                            <div class="text-muted">ì „ì†¡ì‹œê°„</div>
                            <div>${sentAtText}</div>
                        </div>
                        <div class="col-3">
                            <div class="text-muted">ì—´ëŒì—¬ë¶€</div>
                            <div>${emailViewed ? '<span class="text-success">ì—´ëŒ</span>' : '<span class="text-secondary">ë¯¸ì—´ëŒ</span>'}</div>
                        </div>
                    </div>

                    ${emailViewed && assignment.viewed_at ? `
                        <div class="mt-1" style="font-size: 11px;">
                            <span class="text-success">ì—´ëŒì‹œê°„:</span> ${viewedText}
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // íŠ¹ì • ìˆ˜ë°°ì„œ ì´ë©”ì¼ ì „ì†¡
        async function sendAssignmentEmailById(assignmentId, assignmentToken) {
            const hotelEmail = prompt('í˜¸í…” ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”:', window.currentAssignmentReservation?.hotel_email || '');
            if (!hotelEmail) return;
            
            // ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(hotelEmail)) {
                alert('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            if (!confirm(`${hotelEmail}ë¡œ ìˆ˜ë°°ì„œë¥¼ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            try {
                const response = await fetch(`/api/hotel-assignment-management/${assignmentId}/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hotel_email: hotelEmail })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`âœ… ì´ë©”ì¼ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nìˆ˜ì‹ : ${result.sent_to}\në§í¬: ${result.assignment_link}`);
                    
                    // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadAssignmentsList(window.currentAssignmentReservationId);
                } else {
                    alert('âŒ ì „ì†¡ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('âŒ ì´ë©”ì¼ ì „ì†¡ ì˜¤ë¥˜:', error);
                alert('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // íŠ¹ì • ìˆ˜ë°°ì„œ ë§í¬ ë³µì‚¬
        async function copyAssignmentLinkById(link) {
            try {
                await navigator.clipboard.writeText(link);
                alert(`âœ… ìˆ˜ë°°ì„œ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n${link}\n\nì´ ë§í¬ë¥¼ í˜¸í…”ì— ì§ì ‘ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
            } catch (error) {
                console.error('âŒ ë§í¬ ë³µì‚¬ ì˜¤ë¥˜:', error);
                // fallback: í…ìŠ¤íŠ¸ ì„ íƒ
                const tempInput = document.createElement('input');
                tempInput.value = link;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                alert(`âœ… ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n${link}`);
            }
        }
        
        // ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // A4 ìˆ˜ë°°ì„œ/ë°”ìš°ì²˜ ì¸ë³´ì´ìŠ¤ ë¯¸ë¦¬ë³´ê¸° HTML ìƒì„± (ì‹¤ì œ ì „ì†¡ë˜ëŠ” ì–‘ì‹)
        function generateA4AssignmentPreview(reservation, history, options) {
            options = options || {};
            const isVoucherDoc = options.documentType === 'voucher_invoice';
            console.log('ğŸ“„ A4 ë¯¸ë¦¬ë³´ê¸° ìƒì„± ì‹œì‘');
            console.log('- reservation:', reservation);
            console.log('- reservation.rooms:', reservation.rooms);
            console.log('- reservation.extras:', reservation.extras);
            
            const rooms = reservation.rooms || [];
            const extras = reservation.extras || [];
            
            console.log('- rooms ë°°ì—´ ê¸¸ì´:', rooms.length);
            console.log('- extras ë°°ì—´ ê¸¸ì´:', extras.length);
            
            // ìˆ™ë°• ì¼ìˆ˜ ê³„ì‚°
            const checkInDate = new Date(reservation.check_in_date);
            const checkOutDate = new Date(reservation.check_out_date);
            const nights = Math.round((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));
            
            // ê°ì‹¤ë³„ í…Œì´ë¸” ìƒì„±
            let roomsTableHTML = '';
            let roomCharges = []; // ê° ë£¸ë³„ ìš”ê¸ˆ ì €ì¥
            let breakfastCharges = []; // ê° ë£¸ë³„ ì¡°ì‹ ìš”ê¸ˆ ì €ì¥
            
            if (rooms.length > 0) {
                rooms.forEach((room, idx) => {
                    console.log(`  ğŸ“¦ Room ${idx + 1}:`, room);
                    const guests = room.guests || [];
                    console.log(`    ğŸ‘¥ Guests (${guests.length}):`, guests);
                    
                    const roomNum = idx + 1;
                    
                    // room_rate ê³„ì‚° (ì—†ìœ¼ë©´ total_selling_priceì—ì„œ ì—­ì‚°)
                    let roomRate = parseFloat(room.room_rate || 0);
                    if (roomRate === 0 && room.total_selling_price && nights > 0) {
                        roomRate = parseFloat(room.total_selling_price) / nights;
                    }
                    
                    const roomCharge = roomRate * nights;
                    roomCharges.push({ roomNum, roomRate, nights, roomCharge });
                    
                    let guestsHTML = '';
                    if (guests.length > 0) {
                        guests.forEach((g, gIdx) => {
                            // Pax Type ì˜ë¬¸
                            let paxType = '';
                            if (g.age_category === 'adult') paxType = 'Adult';
                            else if (g.age_category === 'child') paxType = 'Child';
                            else if (g.age_category === 'infant') paxType = 'Infant';
                            else paxType = 'Adult'; // ê¸°ë³¸ê°’
                            
                            guestsHTML += `
                                <tr>
                                    <td style="padding: 4px; border: 1px solid #ddd;">${gIdx + 1}</td>
                                    <td style="padding: 4px; border: 1px solid #ddd;">${g.guest_name_en || '-'}</td>
                                    <td style="padding: 4px; border: 1px solid #ddd;">${paxType}</td>
                                    <td style="padding: 4px; border: 1px solid #ddd;">${g.date_of_birth ? formatDate(g.date_of_birth) : '-'}</td>
                                </tr>
                            `;
                        });
                    } else {
                        guestsHTML = '<tr><td colspan="4" style="padding: 8px; text-align: center; color: #999;">No guest information</td></tr>';
                    }
                    
                    // Promo Code í‘œì‹œ
                    const promoCode = room.promotion_code ? `Promo: ${room.promotion_code} <span style="color: #e74c3c; font-weight: bold;">[PROMOTION APPLIED]</span>` : 'Promo: -';
                    
                    // ì¡°ì‹ ì •ë³´ (íšŸìˆ˜ë§Œ)
                    let breakfastInfo = '';
                    
                    // â­ ì¡°ì‹ í¬í•¨ ì—¬ë¶€ í™•ì¸ (ë¬¸ìì—´ 'true' ë“± ë‹¤ì–‘í•œ ì¼€ì´ìŠ¤ ëŒ€ì‘)
                    const isBreakfastIncluded = room.breakfast_included === true || room.breakfast_included === 'true' || room.breakfast_included === 1;
                    
                    if (isBreakfastIncluded) {
                        // ì¸ì› ìˆ˜ ì—†ìœ¼ë©´ guests ë°°ì—´ì—ì„œ ê³„ì‚° ì‹œë„
                        let adultCount = parseInt(room.breakfast_adult_count || 0);
                        let childCount = parseInt(room.breakfast_child_count || 0);
                        
                        if (adultCount === 0 && childCount === 0 && room.guests && room.guests.length > 0) {
                            room.guests.forEach(g => {
                                if (g.age_category === 'adult') adultCount++;
                                else if (g.age_category === 'child') childCount++;
                            });
                        }
                        
                        const adultPrice = parseFloat(room.breakfast_adult_price || 0);
                        const childPrice = parseFloat(room.breakfast_child_price || 0);
                        
                        // íšŸìˆ˜(days)ê°€ ì—†ìœ¼ë©´ ë°•ìˆ˜(nights) ì‚¬ìš©
                        const breakfastDays = parseInt(room.breakfast_days || nights);
                        
                        const adultTotal = adultCount * breakfastDays;
                        const childTotal = childCount * breakfastDays;
                        
                        const breakfastCharge = (adultTotal * adultPrice) + (childTotal * childPrice);
                        breakfastCharges.push({ roomNum, adultCount, childCount, nights: breakfastDays, adultTotal, childTotal, adultPrice, childPrice, breakfastCharge });
                        
                        breakfastInfo = `<strong>Breakfast: â˜‘ Included</strong> â”‚ Adult: ${adultCount}Ã—${breakfastDays}=${adultTotal} â”‚ Child: ${childCount}Ã—${breakfastDays}=${childTotal}`;
                    } else {
                        breakfastInfo = '<strong>Breakfast: â˜ Not Included</strong>';
                    }
                    
                    roomsTableHTML += `
                        <div style="margin-bottom: 15px; page-break-inside: avoid;">
                            <h6 style="background: #34495e; color: white; padding: 5px; margin: 0;">
                                ROOM ${roomNum}: ${room.hotel_room_name || room.room_type_name || 'Room Type Not Specified'} â”‚ ${promoCode}
                            </h6>
                            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                                <tr>
                                    <td style="padding: 4px; border: 1px solid #000; width: 40px;"><strong>No</strong></td>
                                    <td style="padding: 4px; border: 1px solid #000; width: 150px;"><strong>English Name</strong></td>
                                    <td style="padding: 4px; border: 1px solid #000; width: 80px;"><strong>Pax Type</strong></td>
                                    <td style="padding: 4px; border: 1px solid #000; width: 100px;"><strong>Date of Birth</strong></td>
                                </tr>
                                ${guestsHTML}
                            </table>
                            <div style="margin-top: 5px; font-size: 11px; padding: 4px; border: 1px solid #000; background: #ffffff;">
                                ${breakfastInfo}
                            </div>
                        </div>
                    `;
                });
            } else {
                roomsTableHTML = '<div style="padding: 20px; text-align: center; color: #999; background: #f8f9fa; border: 1px dashed #ddd;"><strong>âš ï¸ No room information registered.</strong><br><small>Please add room details in the reservation edit page.</small></div>';
            }
            
            // PAYMENT TO HOTEL ì„¹ì…˜ ìƒì„±
            let paymentHTML = '';
            let totalAmount = 0;
            
            // ë£¸ ìš”ê¸ˆ
            roomCharges.forEach(r => {
                paymentHTML += `
                    <tr>
                        <td style="padding: 5px; border: 1px solid #ddd;">Room ${r.roomNum}:</td>
                        <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">$${r.roomRate}Ã—${r.nights} nights = $${r.roomCharge.toFixed(2)}</td>
                    </tr>
                `;
                totalAmount += r.roomCharge;
            });
            
            // ì¡°ì‹ ìš”ê¸ˆ
            breakfastCharges.forEach(b => {
                let breakfastDetail = '';
                if (b.adultTotal > 0 && b.childTotal > 0) {
                    breakfastDetail = `Adult $${b.adultPrice}Ã—${b.adultTotal} + Child $${b.childPrice}Ã—${b.childTotal}`;
                } else if (b.adultTotal > 0) {
                    breakfastDetail = `Adult $${b.adultPrice}Ã—${b.adultTotal}`;
                } else if (b.childTotal > 0) {
                    breakfastDetail = `Child $${b.childPrice}Ã—${b.childTotal}`;
                }
                
                paymentHTML += `
                    <tr>
                        <td style="padding: 5px; border: 1px solid #ddd;">Breakfast Room ${b.roomNum}:</td>
                        <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">${breakfastDetail} = $${b.breakfastCharge.toFixed(2)}</td>
                    </tr>
                `;
                totalAmount += b.breakfastCharge;
            });
            
            // ì¶”ê°€ ì„œë¹„ìŠ¤ (ê¸°ë³¸: IN_HOTELë§Œ í‘œì‹œ, ë°”ìš°ì²˜ ì¸ë³´ì´ìŠ¤ ëª¨ë“œì—ì„œëŠ” IN/OUT ëª¨ë‘ í‘œì‹œ)
            if (extras && extras.length > 0) {
                let effectiveExtras = extras;

                // hotel_reservation_extras ì²˜ëŸ¼ notes ì»¬ëŸ¼ì´ ìˆëŠ” ê²½ìš° OUT_HOTEL ì œì™¸
                // ë‹¨, ë°”ìš°ì²˜ ì¸ë³´ì´ìŠ¤ ë¬¸ì„œì—ì„œëŠ” IN/OUT ëª¨ë‘ í¬í•¨
                if (!isVoucherDoc && effectiveExtras.length > 0 && Object.prototype.hasOwnProperty.call(effectiveExtras[0], 'notes')) {
                    effectiveExtras = effectiveExtras.filter(e => (e.notes || 'IN_HOTEL') !== 'OUT_HOTEL');
                }

                if (effectiveExtras.length > 0) {
                    let extrasDetail = '';
                    let extrasTotal = 0;

                    effectiveExtras.forEach((extra, idx) => {
                        // hotel_assignment_extras: charge
                        // hotel_reservation_extras: total_selling_price
                        const rawCharge =
                            (typeof extra.charge !== 'undefined' && extra.charge !== null)
                                ? extra.charge
                                : extra.total_selling_price;
                        const charge = parseFloat(rawCharge || 0);

                        extrasTotal += charge;
                        extrasDetail += `${extra.item_name} $${charge.toFixed(2)}`;
                        if (idx < effectiveExtras.length - 1) extrasDetail += ' + ';
                    });
                    
                    paymentHTML += `
                        <tr>
                            <td style="padding: 5px; border: 1px solid #ddd;">Extra Services:</td>
                            <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">${extrasDetail} = $${extrasTotal.toFixed(2)}</td>
                        </tr>
                    `;
                    totalAmount += extrasTotal;
                }
            }

            // ë°”ìš°ì²˜ ì¸ë³´ì´ìŠ¤ ë¯¸ë¦¬ë³´ê¸°ì—ì„œëŠ” ìˆ˜ë°°í”¼(agency_fee)ë¥¼ ë³„ë„ ë¼ì¸ìœ¼ë¡œ í‘œì‹œí•˜ê³  ì´ì•¡ì— í¬í•¨
            if (isVoucherDoc) {
                const agencyFee = parseFloat(reservation.agency_fee || 0) || 0;
                console.log('ğŸ” ë°”ìš°ì²˜ ìˆ˜ë°°í”¼:', agencyFee, 'reservation.agency_fee:', reservation.agency_fee);
                
                // ìˆ˜ë°°í”¼ê°€ 0ì´ì–´ë„ í•­ìƒ í‘œì‹œ
                paymentHTML += `
                    <tr>
                        <td style="padding: 5px; border: 1px solid #ddd;">Agency Handling Fee:</td>
                        <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">$${agencyFee.toFixed(2)}</td>
                    </tr>
                `;
                totalAmount += agencyFee;
            }
            
            // Contact ë‹´ë‹¹ì ì •ë³´ (ì˜ˆì•½ ì²˜ìŒ ì…ë ¥í•œ ë‹´ë‹¹ì)
            const contactPerson = reservation.created_by || 'LUXFIND Staff';

            const agencyName = reservation.booking_agency_name || reservation.agency_name || 'LUXFIND';
            const headerTitle = isVoucherDoc ? 'HOTEL VOUCHER INVOICE' : 'HOTEL BOOKING REQUEST';
            const headerSubtitle = isVoucherDoc
                ? (agencyName
                    ? `AGENCY: ${agencyName}${reservation.agency_contact_person ? ' â”‚ CONTACT: ' + reservation.agency_contact_person : ''}`
                    : 'LUXFIND (ëŸ­ìŠ¤íŒŒì¸ë“œ)')
                : 'LUXFIND (ëŸ­ìŠ¤íŒŒì¸ë“œ)';
            
            const sentDate = new Date().toLocaleString('ko-KR', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            return `
                <div style="max-width: 1000px; margin: 0 auto; font-size: 14px; line-height: 1.4;">
                    <!-- í—¤ë” -->
                    <div style="text-align: center; background: #2c3e50; color: white; padding: 20px; margin-bottom: 10px; -webkit-print-color-adjust: exact; print-color-adjust: exact;">
                        <h3 style="margin: 0; font-size: 26px; font-weight: 900; letter-spacing: 1px;">ğŸ¨ ${headerTitle}</h3>
                        <p style="margin: 5px 0 0 0; font-size: 16px; font-weight: bold;">${headerSubtitle}</p>
                    </div>
                    
                    <!-- ë°œì‹  ì •ë³´ -->
                    <div style="text-align: right; padding: 8px 12px; background: #f8f9fa; border: 1px solid #dee2e6; margin-bottom: 15px; font-size: 13px; -webkit-print-color-adjust: exact; print-color-adjust: exact;">
                        <strong>ğŸ“… Sent:</strong> ${sentDate} | <strong>ğŸ‘¤ Contact:</strong> ${contactPerson}
                    </div>
                    
                    <!-- ê¸°ë³¸ ì •ë³´ -->
                    <table style="width: 100%; margin-bottom: 15px; border-collapse: collapse; font-size: 13px;">
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd; background: #ecf0f1; width: 140px; font-weight: bold; -webkit-print-color-adjust: exact; print-color-adjust: exact;">Hotel</td>
                            <td style="padding: 6px; border: 1px solid #ddd;" colspan="3">${reservation.hotel_name_en || reservation.hotel_name || '-'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd; background: #ecf0f1; font-weight: bold; -webkit-print-color-adjust: exact; print-color-adjust: exact;">Check-in</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${formatDate(reservation.check_in_date)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; background: #ecf0f1; width: 140px; font-weight: bold; -webkit-print-color-adjust: exact; print-color-adjust: exact;">Check-out</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${formatDate(reservation.check_out_date)}</td>
                        </tr>
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd; background: #ecf0f1; font-weight: bold; -webkit-print-color-adjust: exact; print-color-adjust: exact;">Nights</td>
                            <td style="padding: 6px; border: 1px solid #ddd;"><strong>${nights}</strong></td>
                            <td style="padding: 6px; border: 1px solid #ddd; background: #ecf0f1; font-weight: bold; -webkit-print-color-adjust: exact; print-color-adjust: exact;">Flight</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${reservation.arrival_flight || '-'} / ${reservation.departure_flight || '-'}</td>
                        </tr>
                    </table>
                    
                    <!-- ê°ì‹¤ ë° íˆ¬ìˆ™ê° ì •ë³´ -->
                    ${roomsTableHTML || '<p>No room information</p>'}
                    
                    <!-- PAYMENT TO HOTEL -->
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 15px;">
                        ${paymentHTML}
                        <tr>
                            <td colspan="2" style="padding: 6px;">&nbsp;</td>
                        </tr>
                        <tr style="font-weight: bold; font-size: 15px;">
                            <td style="padding: 10px; border: 1px solid #000;">TOTAL AMOUNT:</td>
                            <td style="padding: 10px; border: 1px solid #000; text-align: right;">$${totalAmount.toFixed(2)}</td>
                        </tr>
                    </table>
                    
                    <!-- ë‚´ë¶€ ë©”ëª¨ / ì •ì‚° ê³„ì¢Œ ì•ˆë‚´ -->
                    ${isVoucherDoc
                        ? `
                            <div style="margin-top: 20px; padding: 12px; border: 1px solid #ddd; background: #fffacd; font-size: 13px; -webkit-print-color-adjust: exact; print-color-adjust: exact;">
                                <div><strong>ì›í™”ê³„ì¢Œ:</strong> ì‹ í•œì€í–‰ 140-013-623890  (ì£¼)ëŸ­ìŠ¤íŒŒì¸ë“œ</div>
                                <div><strong>ì™¸í™”ê³„ì¢Œ:</strong> ì‹ í•œì€í–‰ 180-011-678887  (ì£¼)ëŸ­ìŠ¤íŒŒì¸ë“œ</div>
                            </div>
                        `
                        : (reservation.internal_memo ? `
                            <div style="margin-top: 20px; padding: 12px; border: 1px solid #ddd; background: #fffacd; font-size: 13px; -webkit-print-color-adjust: exact; print-color-adjust: exact;">
                                ${reservation.internal_memo}
                            </div>
                        ` : '')
                    }
                    
                    <!-- Hotel Confirmation Section -->
                    <div style="margin-top: 30px; padding: 20px; border: 2px solid #2c3e50; background: #f8f9fa; -webkit-print-color-adjust: exact; print-color-adjust: exact;">
                        
                        ${rooms.map((room, idx) => `
                            <div style="margin-bottom: 12px; font-size: 14px;">
                                <strong>Room ${idx + 1} Confirmation Number:</strong>
                                <span style="display: inline-block; border-bottom: 1px solid #000; width: 250px; margin-left: 10px;"></span>
                            </div>
                        `).join('')}
                        
                        <div style="margin-top: 20px; font-size: 14px;">
                            <strong>Hotel Notes/Comments:</strong><br>
                            <div style="border: 1px solid #999; min-height: 60px; padding: 8px; background: white; margin-top: 5px;"></div>
                        </div>
                        
                        <div style="margin-top: 25px; display: flex; justify-content: space-between; font-size: 14px;">
                            <div>
                                <strong>Hotel Staff Name:</strong> 
                                <span style="display: inline-block; border-bottom: 1px solid #000; width: 180px; margin-left: 10px;"></span>
                            </div>
                            <div>
                                <strong>Date:</strong> 
                                <span style="display: inline-block; border-bottom: 1px solid #000; width: 120px; margin-left: 10px;"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- í‘¸í„° -->
                    <div style="margin-top: 25px; padding-top: 15px; border-top: 2px solid #2c3e50; text-align: center; font-size: 12px; color: #7f8c8d;">
                        <p><strong>Agency:</strong> ${agencyName}</p>
                        <p><strong>Date:</strong> ${new Date().toLocaleString('ko-KR')}</p>
                    </div>
                </div>
            `;
        }
        
        // ì „ì†¡ ì´ë ¥ HTML ìƒì„±
        function generateHistoryHTML(history) {
            if (history.length === 0) {
                return '<p class="text-muted small">ì•„ì§ ì „ì†¡ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
            
            let html = '';
            history.forEach(h => {
                const date = new Date(h.sent_at);
                const dateStr = formatDate(h.sent_at);
                const timeStr = date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                const typeLabel = h.assignment_type === 'NEW' ? 'NEW' : (h.assignment_type === 'REVISE' ? `REV#${h.revision_number}` : 'CANCEL');
                
                let badgeClass = 'bg-primary';
                if (h.assignment_type === 'REVISE') badgeClass = 'bg-warning';
                if (h.assignment_type === 'CANCEL') badgeClass = 'bg-danger';
                
                html += `
                    <div class="border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="badge ${badgeClass}">${typeLabel}</span>
                            <small class="text-muted">${dateStr} ${timeStr}</small>
                        </div>
                        <small>
                            <strong>ìˆ˜ì‹ :</strong> ${h.sent_to_email}<br>
                            <strong>ë°œì‹ :</strong> ${h.sent_by}
                            ${h.changes_description ? `<br><strong>ì‚¬ìœ :</strong> ${h.changes_description}` : ''}
                        </small>
                        ${h.email_message_id ? '<br><span class="badge bg-success mt-1">âœ“ ì „ì†¡ì™„ë£Œ</span>' : ''}
                    </div>
                `;
            });
            
            return html;
        }
        
        // ìˆ˜ë°°ì„œ ì´ë©”ì¼ ì „ì†¡
        async function sendAssignmentEmail() {
            const reservationId = window.currentAssignmentReservationId;
            if (!reservationId) {
                alert('ì˜ˆì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ì „ì†¡ íƒ€ì… ì„ íƒ
            const history = window.currentAssignmentHistory || [];
            let assignmentType = 'NEW';
            let changesDescription = '';
            
            if (history.length > 0) {
                // ê¸°ì¡´ ìˆ˜ë°°ì„œê°€ ìˆëŠ” ê²½ìš° - 3ê°€ì§€ ì„ íƒì§€
                const typeChoice = prompt(
                    'ìˆ˜ë°°ì„œ ì „ì†¡ íƒ€ì…ì„ ì„ íƒí•˜ì„¸ìš”:\n\n' +
                    '1 - NEW (ì‹ ê·œë¡œ ë‹¤ì‹œ ì „ì†¡)\n' +
                    '2 - REVISE (ìˆ˜ì • ì „ì†¡)\n' +
                    '3 - CANCEL (ì·¨ì†Œ ì „ì†¡)\n\n' +
                    'ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš” (1, 2, ë˜ëŠ” 3):',
                    '2'
                );
                
                if (typeChoice === null) return; // ì·¨ì†Œ
                
                if (typeChoice === '1') {
                    assignmentType = 'NEW';
                } else if (typeChoice === '2') {
                    assignmentType = 'REVISE';
                    changesDescription = prompt('ë³€ê²½ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì²´í¬ì¸ ë‚ ì§œ ë³€ê²½, ê°ì‹¤ ì¶”ê°€ ë“±):');
                    if (changesDescription === null) return; // ì·¨ì†Œ
                } else if (typeChoice === '3') {
                    assignmentType = 'CANCEL';
                    changesDescription = prompt('ì·¨ì†Œ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ê³ ê° ìš”ì²­, ì¼ì • ë³€ê²½ ë“±):');
                    if (changesDescription === null) return; // ì·¨ì†Œ
                } else {
                    alert('ì˜¬ë°”ë¥¸ ìˆ«ì(1, 2, ë˜ëŠ” 3)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
            } else {
                // ì²« ì „ì†¡
                assignmentType = 'NEW';
            }
            
            // ìµœì¢… í™•ì¸
            let confirmMessage = '';
            if (assignmentType === 'NEW') {
                confirmMessage = 'ì‹ ê·œ ìˆ˜ë°°ì„œë¥¼ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
            } else if (assignmentType === 'REVISE') {
                confirmMessage = `ìˆ˜ì • ìˆ˜ë°°ì„œ(REVISE #${history.filter(h => h.assignment_type === 'REVISE').length + 1})ë¥¼ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            } else if (assignmentType === 'CANCEL') {
                confirmMessage = 'ì·¨ì†Œ ìˆ˜ë°°ì„œ(CANCELLATION)ë¥¼ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
            }
            
            if (!confirm(confirmMessage)) return;
            
            try {
                const response = await fetch('/api/hotel-assignments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reservation_id: reservationId,
                        assignment_type: assignmentType,
                        changes_description: changesDescription,
                        sent_by: 'Admin' // TODO: ë¡œê·¸ì¸ ì‚¬ìš©ìëª…ìœ¼ë¡œ ë³€ê²½
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`âœ… ìˆ˜ë°°ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!\n\níƒ€ì…: ${assignmentType}\në§í¬: ${result.assignment_link}`);
                    
                    // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨ (ìµœì‹  ì´ë ¥ í‘œì‹œ)
                    await createAssignment(reservationId);
                    
                } else {
                    alert('âŒ ì „ì†¡ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('âŒ ì „ì†¡ ì˜¤ë¥˜:', error);
                alert('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ìˆ˜ë°°ì„œ ë§í¬ ë³µì‚¬
        async function copyAssignmentLink() {
            const reservationId = window.currentAssignmentReservationId;
            if (!reservationId) {
                alert('ì˜ˆì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                // ì˜ˆì•½ ì •ë³´ ì¡°íšŒ (assignment_token í¬í•¨)
                const response = await fetch(`/api/hotel-reservations/${reservationId}`);
                const reservation = await response.json();
                
                if (!reservation.assignment_token) {
                    alert('âš ï¸ ìˆ˜ë°°ì„œë¥¼ ë¨¼ì € ì „ì†¡í•´ì•¼ ë§í¬ê°€ ìƒì„±ë©ë‹ˆë‹¤.\n\n"Send to Hotel" ë²„íŠ¼ì„ ëˆŒëŸ¬ ìˆ˜ë°°ì„œë¥¼ ì „ì†¡í•˜ì„¸ìš”.');
                    return;
                }
                
                const link = `${window.location.origin}/hotel-assignment/${reservation.assignment_token}`;
                
                // í´ë¦½ë³´ë“œ ë³µì‚¬
                await navigator.clipboard.writeText(link);
                alert(`âœ… ìˆ˜ë°°ì„œ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n${link}\n\nì´ ë§í¬ë¥¼ í˜¸í…”ì— ì§ì ‘ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                
            } catch (error) {
                console.error('âŒ ë§í¬ ë³µì‚¬ ì˜¤ë¥˜:', error);
                alert('âŒ ë§í¬ ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ìˆ˜ë°°ì„œ ì¸ì‡„ (ê°œì„ ëœ UI)
        function printAssignment() {
            const printContent = document.getElementById('assignmentPreview').innerHTML;
            const printWindow = window.open('', '', 'width=1000,height=1200');
            printWindow.document.write('<!DOCTYPE html><html><head><title>í˜¸í…” ìˆ˜ë°°ì„œ - LUXFIND</title>');
            printWindow.document.write(`
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap');
                    
                    body { 
                        margin: 0; 
                        padding: 30px; 
                        font-family: 'Noto Sans KR', 'Malgun Gothic', sans-serif; 
                        color: #2c3e50;
                        -webkit-font-smoothing: antialiased;
                    }
                    
                    /* ì „ì²´ ì»¨í…Œì´ë„ˆ ì¬ì •ì˜ */
                    div[style*="max-width: 1000px"] {
                        max-width: 100% !important;
                        font-family: 'Noto Sans KR', sans-serif !important;
                        margin: 0 !important;
                    }
                    
                    /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ ê°œì„  */
                    table { 
                        width: 100%; 
                        border-collapse: collapse; 
                        margin-bottom: 15px;
                        box-shadow: none !important;
                    }
                    
                    td, th { 
                        padding: 8px 12px !important; 
                        border: 1px solid #dfe6e9 !important; 
                        font-size: 13px !important;
                        vertical-align: middle;
                    }
                    
                    /* ê°•ì¡° ì…€ ë°°ê²½ */
                    td[style*="background: #ecf0f1"] {
                        background-color: #f1f3f5 !important;
                        font-weight: 600 !important;
                        color: #2c3e50 !important;
                    }
                    
                    /* í—¤ë” ìŠ¤íƒ€ì¼ */
                    h3 {
                        font-family: 'Noto Sans KR', sans-serif !important;
                        letter-spacing: -0.5px !important;
                    }
                    
                    /* ì„¹ì…˜ í—¤ë” */
                    h5 {
                        background-color: #2c3e50 !important;
                        color: #fff !important;
                        padding: 10px 15px !important;
                        font-size: 15px !important;
                        font-weight: 600 !important;
                        margin: 25px 0 15px 0 !important;
                        border-radius: 4px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        -webkit-print-color-adjust: exact !important;
                        print-color-adjust: exact !important;
                    }
                    
                    /* í™•ì¸ ì„¹ì…˜ */
                    div[style*="border: 2px solid #2c3e50"] {
                        border: 2px solid #2c3e50 !important;
                        border-radius: 8px;
                        background-color: #fff !important;
                        padding: 25px !important;
                        margin-top: 40px !important;
                    }
                    
                    /* ì¸ì‡„ ì „ìš© ì„¤ì • */
                    @media print {
                        @page { 
                            size: A4; 
                            margin: 15mm; 
                        }
                        body { 
                            padding: 0; 
                        }
                        
                        /* í˜ì´ì§€ ë„˜ê¹€ ë°©ì§€ */
                        h5, tr, div[style*="border: 2px solid #2c3e50"] { 
                            page-break-inside: avoid; 
                        }
                        
                        /* ë°°ê²½ìƒ‰ ì¶œë ¥ ê°•ì œ */
                        * {
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                        
                        /* ë§í¬ URL ìˆ¨ê¸°ê¸° */
                        a[href]:after {
                            content: none !important;
                        }
                    }
                </style>
            `);
            printWindow.document.write('</head><body>' + printContent);
            printWindow.document.write('<script>window.onload = function() { window.print(); }<\/script>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();
        }
        
        // PDF ë‹¤ìš´ë¡œë“œ (ë¸Œë¼ìš°ì € ì¸ì‡„ ë‹¤ì´ì–¼ë¡œê·¸ ì´ìš©)
        function downloadAssignmentPDF() {
            const printContent = document.getElementById('assignmentPreview').innerHTML;
            const printWindow = window.open('', '', 'width=1000,height=1200');
            printWindow.document.write('<!DOCTYPE html><html><head><title>í˜¸í…” ìˆ˜ë°°ì„œ - LUXFIND</title>');
            printWindow.document.write(`
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap');
                    
                    body { 
                        margin: 0; 
                        padding: 30px; 
                        font-family: 'Noto Sans KR', 'Malgun Gothic', sans-serif; 
                        color: #2c3e50;
                        -webkit-font-smoothing: antialiased;
                    }
                    
                    div[style*="max-width: 1000px"] {
                        max-width: 100% !important;
                        font-family: 'Noto Sans KR', sans-serif !important;
                        margin: 0 !important;
                    }
                    
                    table { 
                        width: 100%; 
                        border-collapse: collapse; 
                        margin-bottom: 15px;
                        box-shadow: none !important;
                    }
                    
                    td, th { 
                        padding: 8px 12px !important; 
                        border: 1px solid #dfe6e9 !important; 
                        font-size: 13px !important;
                        vertical-align: middle;
                    }
                    
                    td[style*="background: #ecf0f1"] {
                        background-color: #f1f3f5 !important;
                        font-weight: 600 !important;
                        color: #2c3e50 !important;
                    }
                    
                    h3 {
                        font-family: 'Noto Sans KR', sans-serif !important;
                        letter-spacing: -0.5px !important;
                    }
                    
                    h5 {
                        background-color: #2c3e50 !important;
                        color: #fff !important;
                        padding: 10px 15px !important;
                        font-size: 15px !important;
                        font-weight: 600 !important;
                        margin: 25px 0 15px 0 !important;
                        border-radius: 4px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        -webkit-print-color-adjust: exact !important;
                        print-color-adjust: exact !important;
                    }
                    
                    div[style*="border: 2px solid #2c3e50"] {
                        border: 2px solid #2c3e50 !important;
                        border-radius: 8px;
                        background-color: #fff !important;
                        padding: 25px !important;
                        margin-top: 40px !important;
                    }
                    
                    @media print {
                        @page { 
                            size: A4; 
                            margin: 15mm; 
                        }
                        body { 
                            padding: 0; 
                        }
                        h5, tr, div[style*="border: 2px solid #2c3e50"] { 
                            page-break-inside: avoid; 
                        }
                        * {
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                        a[href]:after {
                            content: none !important;
                        }
                    }
                </style>
            `);
            printWindow.document.write('</head><body>' + printContent);
            printWindow.document.write('<script>window.onload = function() { alert("PDFë¡œ ì €ì¥í•˜ë ¤ë©´ ì¸ì‡„ ëŒ€í™”ìƒìì—ì„œ PDFë¡œ ì €ì¥ì„ ì„ íƒí•˜ì„¸ìš”."); window.print(); }<\/script>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();
        }
        
        // ìƒˆë¡œìš´ ì´ë©”ì¼ ì „ì†¡ í•¨ìˆ˜ (UI í¼ ì‚¬ìš©)
        async function sendAssignmentEmailNew() {
            const reservationId = window.currentAssignmentReservationId;
            if (!reservationId) {
                alert('ì˜ˆì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const assignmentType = document.getElementById('assignmentTypeSelect').value;
            const changesDescription = document.getElementById('changesDescriptionInput').value;
            const recipientEmail = document.getElementById('recipientEmail').value;
            
            if (!recipientEmail) {
                alert('ìˆ˜ì‹  ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            if ((assignmentType === 'REVISE' || assignmentType === 'CANCEL') && !changesDescription) {
                alert('ë³€ê²½/ì·¨ì†Œ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            // ìµœì¢… í™•ì¸
            let confirmMessage = '';
            if (assignmentType === 'NEW') {
                confirmMessage = `ì‹ ê·œ ìˆ˜ë°°ì„œë¥¼ ${recipientEmail}ë¡œ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            } else if (assignmentType === 'REVISE') {
                confirmMessage = `ìˆ˜ì • ìˆ˜ë°°ì„œë¥¼ ${recipientEmail}ë¡œ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në³€ê²½ì‚¬ìœ : ${changesDescription}`;
            } else if (assignmentType === 'CANCEL') {
                confirmMessage = `ì·¨ì†Œ ìˆ˜ë°°ì„œë¥¼ ${recipientEmail}ë¡œ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì·¨ì†Œì‚¬ìœ : ${changesDescription}`;
            }
            
            if (!confirm(confirmMessage)) return;
            
            try {
                const response = await fetch(`/api/hotel-assignments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reservation_id: reservationId,
                        hotel_email: recipientEmail,
                        assignment_type: assignmentType,
                        changes_description: changesDescription,
                        sent_by: 'Admin'
                    })
                });
                
                const result = await response.json();
                console.log('ğŸ” ìˆ˜ë°°ì„œ ì „ì†¡ ì‘ë‹µ:', result);
                console.log('ğŸ” ì‘ë‹µ ìƒíƒœ:', response.status);
                
                if (result.success) {
                    alert(`âœ… ìˆ˜ë°°ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!\n\níƒ€ì…: ${assignmentType}\nìˆ˜ì‹ : ${recipientEmail}`);
                    
                    // ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨ (ìƒíƒœ ë³€ê²½ ë°˜ì˜)
                    console.log('ğŸ”„ ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨ ì‹œì‘...');
                    await loadReservations();
                    console.log('âœ… ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
                    
                    // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨ (ìµœì‹  ì´ë ¥ í‘œì‹œ)
                    await createAssignment(reservationId);
                    
                } else {
                    console.error('âŒ ì „ì†¡ ì‹¤íŒ¨:', result);
                    alert('âŒ ì „ì†¡ ì‹¤íŒ¨: ' + (result.message || result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
                
            } catch (error) {
                console.error('âŒ ì´ë©”ì¼ ì „ì†¡ ì˜¤ë¥˜:', error);
                alert('âŒ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // í™•ì • - ê°ì‹¤ë³„ ì»¨íŒë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ ì˜¤í”ˆ
        async function confirmReservation(reservationId) {
            currentConfirmReservationId = reservationId;
            lastClosedReservationId = reservationId;
            highlightReservationRow(reservationId); // í•´ë‹¹ í–‰ë§Œ ê°•ì¡°

            try {
                const response = await fetch(`/api/hotel-reservations/${reservationId}`);
                if (!response.ok) {
                    alert('ì˜ˆì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                const data = await response.json();

                const container = document.getElementById('confirmRoomsContainer');
                if (!container) {
                    alert('ì»¨íŒë²ˆí˜¸ ì…ë ¥ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const rooms = data.rooms || [];
                if (rooms.length === 0) {
                    container.innerHTML = '<p class="text-muted">ê°ì‹¤ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    container.innerHTML = rooms.map((room, index) => {
                        const roomLabel = `ê°ì‹¤ ${index + 1}`;
                        const roomType = room.hotel_room_name || room.room_type_name || '';
                        const guestSummary = (room.total_guests || room.total_guests === 0)
                            ? `${room.total_guests}ëª…`
                            : `${room.adults_count || 0}A ${room.children_count || 0}C ${room.infants_count || 0}I`;
                        const value = room.confirmation_number || '';
                        return `
                            <div class="border rounded p-2 mb-2" data-confirm-room-id="${room.id}">
                                <div class="small text-muted mb-1">
                                    <strong>${roomLabel}</strong> - ${roomType}
                                    ${guestSummary ? `<span class="ms-2">(${guestSummary})</span>` : ''}
                                </div>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">ì»¨íŒë²ˆí˜¸</span>
                                    <input type="text" class="form-control" value="${value}" placeholder="ì˜ˆ: 123456 / K12345">
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                const modalEl = document.getElementById('confirmModal');
                const modal = new bootstrap.Modal(modalEl);
                modal.show();

            } catch (error) {
                console.error('í™•ì • ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('âŒ ì»¨íŒë²ˆí˜¸ ì…ë ¥ í™”ë©´ì„ ì—¬ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function saveConfirmationNumbers() {
            if (!currentConfirmReservationId) return;

            const container = document.getElementById('confirmRoomsContainer');
            if (!container) return;

            const roomBlocks = container.querySelectorAll('[data-confirm-room-id]');
            const rooms = [];
            roomBlocks.forEach(block => {
                const roomId = block.getAttribute('data-confirm-room-id');
                const input = block.querySelector('input');
                rooms.push({
                    id: parseInt(roomId, 10),
                    confirmation_number: input ? input.value.trim() : ''
                });
            });

            try {
                const response = await fetch(`/api/hotel-reservations/${currentConfirmReservationId}/confirm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rooms })
                });
                const result = await response.json();

                if (response.ok && result.success) {
                    alert('âœ… ì»¨íŒë²ˆí˜¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    lastClosedReservationId = currentConfirmReservationId;
                    const modalEl = document.getElementById('confirmModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();
                    loadReservations();
                } else {
                    alert('âŒ ì»¨íŒë²ˆí˜¸ ì €ì¥ ì‹¤íŒ¨: ' + (result.message || result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('ì»¨íŒë²ˆí˜¸ ì €ì¥ ì˜¤ë¥˜:', error);
                alert('âŒ ì»¨íŒë²ˆí˜¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ë°”ìš°ì²˜+ì¸ë³´ì´ìŠ¤ ìƒì„± ëª¨ë‹¬ ì˜¤í”ˆ
        async function createVoucher(reservationId) {
            currentVoucherReservationId = reservationId;
            lastClosedReservationId = reservationId;
            currentVoucherInvoiceId = null;
            currentVoucherInvoiceLink = '';
            currentVoucherAgencyEmail = '';

            try {
                // ì˜ˆì•½ ìƒì„¸ ë°ì´í„° ë¡œë“œ
                const response = await fetch(`/api/hotel-reservations/${reservationId}`);
                if (!response.ok) {
                    alert('ì˜ˆì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                const data = await response.json();
                
                console.log('ğŸ” createVoucher - ì˜ˆì•½ ë°ì´í„°:', data);

                // ë°”ìš°ì²˜ TOTAL ê¸ˆì•¡ ê³„ì‚° (rooms + breakfast + extras + agency_fee)
                let totalAmount = 0;
                let totalRoomCharge = 0;
                let totalBreakfastCharge = 0;
                let totalExtrasCharge = 0;
                const rooms = data.rooms || [];
                const extras = data.extras || [];
                
                console.log('ğŸ” createVoucher - ê°ì‹¤ ìˆ˜:', rooms.length);
                
                // ìˆ™ë°• ì¼ìˆ˜
                const checkInDate = new Date(data.check_in_date);
                const checkOutDate = new Date(data.check_out_date);
                const nights = Math.round((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));
                
                // ì¡°ì‹ ìƒì„¸ ì •ë³´ ìˆ˜ì§‘
                let breakfastDetails = [];
                
                // ê°ì‹¤ ìš”ê¸ˆ
                rooms.forEach((room, idx) => {
                    let roomRate = parseFloat(room.room_rate || 0);
                    if (roomRate === 0 && room.total_selling_price && nights > 0) {
                        roomRate = parseFloat(room.total_selling_price) / nights;
                    }
                    const roomCharge = roomRate * nights;
                    totalRoomCharge += roomCharge;
                    totalAmount += roomCharge;
                    
                    // ì¡°ì‹ ìš”ê¸ˆ
                    const isBreakfastIncluded = room.breakfast_included === true || room.breakfast_included === 'true' || room.breakfast_included === 1;
                    console.log(`ğŸ” createVoucher - Room ${idx + 1} breakfast_included:`, room.breakfast_included, 'â†’', isBreakfastIncluded);
                    
                    if (isBreakfastIncluded) {
                        console.log(`ğŸ” createVoucher - Room ${idx + 1} ì›ë³¸ ì¡°ì‹ ë°ì´í„°:`, {
                            breakfast_adult_count: room.breakfast_adult_count,
                            breakfast_child_count: room.breakfast_child_count,
                            breakfast_adult_price: room.breakfast_adult_price,
                            breakfast_child_price: room.breakfast_child_price,
                            breakfast_days: room.breakfast_days
                        });
                        
                        const adultCount = parseInt(room.breakfast_adult_count || 0);
                        const childCount = parseInt(room.breakfast_child_count || 0);
                        const adultPrice = parseFloat(room.breakfast_adult_price || 0);
                        const childPrice = parseFloat(room.breakfast_child_price || 0);
                        const breakfastDays = parseInt(room.breakfast_days || nights);
                        
                        console.log(`ğŸ” createVoucher - Room ${idx + 1} íŒŒì‹±ëœ ì¡°ì‹ ì •ë³´:`, { adultCount, childCount, adultPrice, childPrice, breakfastDays });
                        
                        const breakfastCharge = (adultCount * breakfastDays * adultPrice) + (childCount * breakfastDays * childPrice);
                        console.log(`ğŸ” createVoucher - Room ${idx + 1} ê³„ì‚°ì‹: (${adultCount} Ã— ${breakfastDays} Ã— ${adultPrice}) + (${childCount} Ã— ${breakfastDays} Ã— ${childPrice}) = ${breakfastCharge}`);
                        
                        totalBreakfastCharge += breakfastCharge;
                        totalAmount += breakfastCharge;
                        
                        if (breakfastCharge > 0) {
                            let detail = '';
                            if (adultCount > 0) detail += `ì„±ì¸ ${adultCount}ëª… x $${adultPrice} x ${breakfastDays}ì¼`;
                            if (childCount > 0) {
                                if (detail) detail += ' + ';
                                detail += `ì†Œì•„ ${childCount}ëª… x $${childPrice} x ${breakfastDays}ì¼`;
                            }
                            breakfastDetails.push(detail);
                        }
                    }
                });
                
                // ì¶”ê°€ ì„œë¹„ìŠ¤ (IN_HOTEL + OUT_HOTEL ëª¨ë‘ í¬í•¨)
                let extrasDetails = [];
                extras.forEach(extra => {
                    const charge = parseFloat(extra.charge || extra.total_selling_price || 0);
                    totalExtrasCharge += charge;
                    totalAmount += charge;
                    if (charge > 0) {
                        const itemName = extra.service_name || extra.item_name || extra.extra_name || 'ì¶”ê°€í•­ëª©';
                        let detail = `${itemName}: $${charge.toFixed(2)}`;
                        
                        // ìˆ˜ëŸ‰ ì •ë³´ ì¶”ê°€
                        const quantity = parseInt(extra.quantity || 1);
                        if (quantity > 1) {
                            detail += ` (ìˆ˜ëŸ‰: ${quantity})`;
                        }
                        
                        // ì¸ì›ë³„ ê°€ê²© ì •ë³´ ì¶”ê°€
                        const adultCount = parseInt(extra.adult_count || 0);
                        const childCount = parseInt(extra.child_count || 0);
                        const infantCount = parseInt(extra.infant_count || 0);
                        
                        if (adultCount > 0 || childCount > 0 || infantCount > 0) {
                            const details = [];
                            if (adultCount > 0) {
                                const adultPrice = parseFloat(extra.adult_price || 0);
                                details.push(`ì„±ì¸ ${adultCount}ëª…Ã—$${adultPrice}`);
                            }
                            if (childCount > 0) {
                                const childPrice = parseFloat(extra.child_price || 0);
                                details.push(`ì†Œì•„ ${childCount}ëª…Ã—$${childPrice}`);
                            }
                            if (infantCount > 0) {
                                const infantPrice = parseFloat(extra.infant_price || 0);
                                details.push(`ìœ ì•„ ${infantCount}ëª…Ã—$${infantPrice}`);
                            }
                            if (details.length > 0) {
                                detail += ` (${details.join(', ')})`;
                            }
                        }
                        
                        extrasDetails.push(detail);
                    }
                });
                
                // ìˆ˜ë°°í”¼ (ë°”ìš°ì²˜ì— í¬í•¨)
                const agencyFee = parseFloat(data.agency_fee || 0);
                totalAmount += agencyFee;
                
                voucherBaseAmountUSD = totalAmount;

                // ìµœì‹  USD í™˜ìœ¨ ì¡°íšŒ
                voucherFxRate = 1300;
                let fxText = '';
                try {
                    const rateRes = await fetch('/api/exchange-rates?currency=USD');
                    const rateJson = await rateRes.json();
                    if (rateJson.success && rateJson.data && rateJson.data.length > 0) {
                        voucherFxRate = parseFloat(rateJson.data[0].rate) || 1300;
                        const rateDate = rateJson.data[0].rate_date;
                        fxText = `í™˜ìœ¨: 1 USD = ${voucherFxRate.toLocaleString('ko-KR')} KRW${rateDate ? ` (${rateDate})` : ''}`;
                    } else {
                        fxText = `í™˜ìœ¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•´ ê¸°ë³¸ê°’ ${voucherFxRate.toLocaleString('ko-KR')} KRW ì‚¬ìš©`;
                    }
                } catch (e) {
                    console.error('ë°”ìš°ì²˜ì¸ë³´ì´ìŠ¤ í™˜ìœ¨ ì¡°íšŒ ì˜¤ë¥˜:', e);
                    fxText = `í™˜ìœ¨ ì¡°íšŒ ì˜¤ë¥˜, ê¸°ë³¸ê°’ ${voucherFxRate.toLocaleString('ko-KR')} KRW ì‚¬ìš©`;
                }

                // ìƒˆë¡œìš´ UI ìš”ì†Œë“¤ ì—…ë°ì´íŠ¸
                const baseInput = document.getElementById('voucherBaseAmount');
                const discountInput = document.getElementById('voucherDiscount');
                const surchargeInput = document.getElementById('voucherSurcharge');
                const fxLabel = document.getElementById('voucherFxRateLabel');
                
                // ì˜ˆì•½ ì •ë³´ ìš”ì•½ ì—…ë°ì´íŠ¸
                const guestName = data.rooms && data.rooms[0] && data.rooms[0].guests && data.rooms[0].guests[0]
                    ? (data.rooms[0].guests[0].guest_name_ko || data.rooms[0].guests[0].guest_name_en || '')
                    : '';
                document.getElementById('invoiceReservationNumber').textContent = data.reservation_number || '-';
                document.getElementById('invoiceGuestName').textContent = guestName || '-';
                document.getElementById('invoiceHotelName').textContent = data.hotel_name || '-';
                document.getElementById('invoiceCheckIn').textContent = data.check_in_date ? new Date(data.check_in_date).toLocaleDateString('ko-KR') : '-';

                if (baseInput) baseInput.value = voucherBaseAmountUSD.toFixed(2);
                if (discountInput) discountInput.value = '0';
                if (surchargeInput) surchargeInput.value = '0';
                if (fxLabel) fxLabel.textContent = fxText;

                // ì´ë©”ì¼ ì£¼ì†Œ ì €ì¥ (ì¸ë³´ì´ìŠ¤ ëª©ë¡ì—ì„œ ì‚¬ìš©)
                currentVoucherAgencyEmail = data.agency_contact_email || data.agency_email || '';
                
                // ê¸ˆì•¡ ìƒì„¸ ë‚´ì—­ í‘œì‹œ
                document.getElementById('voucherRoomChargeDisplay').textContent = '$' + totalRoomCharge.toFixed(2);
                
                // ì¡°ì‹ ìƒì„¸ ë‚´ì—­
                document.getElementById('voucherBreakfastChargeDisplay').textContent = '$' + totalBreakfastCharge.toFixed(2);
                const breakfastContainer = document.getElementById('voucherBreakfastDetailContainer');
                if (breakfastDetails.length > 0) {
                    breakfastContainer.innerHTML = breakfastDetails.map(detail => 
                        `<div class="text-muted mb-1">â€¢ ${detail}</div>`
                    ).join('');
                } else {
                    breakfastContainer.innerHTML = '<div class="text-muted">ì¡°ì‹ ë¯¸í¬í•¨</div>';
                }
                
                // ì¶”ê°€ í•­ëª© ìƒì„¸ ë‚´ì—­
                document.getElementById('voucherExtrasChargeDisplay').textContent = '$' + totalExtrasCharge.toFixed(2);
                const extrasContainer = document.getElementById('voucherExtrasDetailContainer');
                if (extrasDetails.length > 0) {
                    extrasContainer.innerHTML = extrasDetails.map(detail => 
                        `<div class="text-muted mb-1">â€¢ ${detail}</div>`
                    ).join('');
                } else {
                    extrasContainer.innerHTML = '<div class="text-muted">ì¶”ê°€í•­ëª© ì—†ìŒ</div>';
                }
                
                document.getElementById('voucherAgencyFeeDisplay').textContent = '$' + agencyFee.toFixed(2);
                document.getElementById('voucherAgencyNameDisplay').textContent = data.booking_agency_name || data.agency_name || '-';
                document.getElementById('voucherTotalUSD').textContent = '$' + voucherBaseAmountUSD.toFixed(2);
                document.getElementById('voucherTotalKRW').textContent = 'â‚©' + (voucherBaseAmountUSD * voucherFxRate).toLocaleString('ko-KR', {maximumFractionDigits: 0});
                
                // ì¸ë³´ì´ìŠ¤ ëª©ë¡ ë¡œë“œ
                await loadVoucherInvoicesList(reservationId);

                updateVoucherInvoiceTotals();

                const modalEl = document.getElementById('voucherInvoiceModal');
                
                // â­ Bootstrap ëª¨ë‹¬ì˜ body ìŠ¤íƒ€ì¼ ë³€ê²½ì„ ì™„ì „íˆ ì°¨ë‹¨
                const originalPadding = document.body.style.paddingRight || '';
                const originalOverflow = document.body.style.overflow || '';
                
                // MutationObserverë¡œ body ìŠ¤íƒ€ì¼ ë³€ê²½ ê°ì‹œ ë° ì¦‰ì‹œ ë³µêµ¬
                const bodyObserver = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            // body ìŠ¤íƒ€ì¼ì´ ë³€ê²½ë˜ë©´ ì¦‰ì‹œ ì›ë˜ëŒ€ë¡œ ë³µêµ¬
                            if (document.body.style.paddingRight !== originalPadding) {
                                document.body.style.paddingRight = originalPadding;
                            }
                            if (document.body.style.overflow !== originalOverflow) {
                                document.body.style.overflow = originalOverflow;
                            }
                        }
                    });
                });
                
                // body ê°ì‹œ ì‹œì‘
                bodyObserver.observe(document.body, {
                    attributes: true,
                    attributeFilter: ['style', 'class']
                });
                
                // Bootstrap ëª¨ë‹¬ ìƒì„±
                const modal = new bootstrap.Modal(modalEl, {
                    backdrop: true,
                    keyboard: true,
                    focus: true
                });
                
                // ëª¨ë‹¬ì´ ì—´ë¦¬ëŠ” ì¤‘ì—ë„ padding ìœ ì§€
                const preventPaddingChange = function(e) {
                    document.body.style.paddingRight = originalPadding;
                    document.body.style.overflow = originalOverflow;
                };
                
                // ëª¨ë‹¬ì´ ì™„ì „íˆ ì—´ë¦° í›„ ì¸ë³´ì´ìŠ¤ ëª©ë¡ ë¡œë“œ
                const onModalShown = async function() {
                    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
                    modalEl.removeEventListener('show.bs.modal', preventPaddingChange);
                    modalEl.removeEventListener('shown.bs.modal', preventPaddingChange);
                    modalEl.removeEventListener('shown.bs.modal', onModalShown);
                    
                    // padding ìµœì¢… í™•ì¸
                    document.body.style.paddingRight = originalPadding;
                    
                    // ì¸ë³´ì´ìŠ¤ ëª©ë¡ ë¡œë“œ (ëª¨ë‹¬ ì—´ë¦° í›„)
                    await loadVoucherInvoicesList(reservationId);
                    
                    // ëª©ë¡ ë¡œë“œ í›„ í–‰ ê°•ì¡°
                    setTimeout(() => {
                        highlightReservationRow(reservationId);
                    }, 200);
                };
                
                // ëª¨ë‹¬ì´ ë‹«í ë•Œ ì •ë¦¬
                const onModalHidden = function() {
                    modalEl.removeEventListener('hidden.bs.modal', onModalHidden);
                    // Observer ì¤‘ì§€
                    bodyObserver.disconnect();
                    // ì›ë˜ ìƒíƒœ ë³µêµ¬
                    document.body.style.paddingRight = originalPadding;
                    document.body.style.overflow = originalOverflow;
                };
                
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ëª¨ë‹¬ ì—´ê¸° ì „ì—)
                modalEl.addEventListener('show.bs.modal', preventPaddingChange);
                modalEl.addEventListener('shown.bs.modal', preventPaddingChange);
                modalEl.addEventListener('shown.bs.modal', onModalShown);
                modalEl.addEventListener('hidden.bs.modal', onModalHidden);
                
                // ëª¨ë‹¬ ì—´ê¸°
                modal.show();

            } catch (error) {
                console.error('ë°”ìš°ì²˜ì¸ë³´ì´ìŠ¤ ìƒì„± ì¤€ë¹„ ì˜¤ë¥˜:', error);
                alert('âŒ ë°”ìš°ì²˜ì¸ë³´ì´ìŠ¤ ìƒì„± í™”ë©´ì„ ì—¬ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function updateVoucherInvoiceTotals() {
            const finalUSDInput = document.getElementById('voucherFinalAmountUSD');
            const finalKRWInput = document.getElementById('voucherFinalAmountKRW');
            const krwRow = document.getElementById('voucherFinalKRWRow');

            // ì¸ë³´ì´ìŠ¤ ìµœì¢… ê¸ˆì•¡ì€ ì™¼ìª½ ë¯¸ë¦¬ë³´ê¸° TOTAL(ì˜ˆì•½ì˜ ì´ íŒë§¤ê°€/ê·¸ëœë“œí† íƒˆ) ê·¸ëŒ€ë¡œ ì‚¬ìš©
            const finalUSD = voucherBaseAmountUSD || 0;
            if (finalUSDInput) finalUSDInput.value = finalUSD.toFixed(2);

            if (!finalKRWInput || !krwRow) return;

            const fx = voucherFxRate || 1300;
            const finalKRW = finalUSD * fx;
            finalKRWInput.value = Math.round(finalKRW).toLocaleString('ko-KR');
            krwRow.style.display = '';
        }

        async function saveVoucherInvoice() {
            if (!currentVoucherReservationId) {
                alert('ì˜ˆì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const discountInput = document.getElementById('voucherDiscount');
            const surchargeInput = document.getElementById('voucherSurcharge');

            const discount = parseFloat(discountInput && discountInput.value ? discountInput.value : 0) || 0;
            const surcharge = parseFloat(surchargeInput && surchargeInput.value ? surchargeInput.value : 0) || 0;

            try {
                const response = await fetch(`/api/hotel-assignments/${currentVoucherReservationId}/invoice`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        discount_usd: discount,
                        surcharge_usd: surcharge
                    })
                });
                const result = await response.json();

                if (response.ok && result.success) {
                    alert('âœ… ë°”ìš°ì²˜ì¸ë³´ì´ìŠ¤ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    lastClosedReservationId = currentVoucherReservationId;
                    
                    // ì¸ë³´ì´ìŠ¤ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
                    await loadVoucherInvoicesList(currentVoucherReservationId);
                    
                    // ì˜ˆì•½ ëª©ë¡ ê°±ì‹  (ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ìŠ¤í‚µ)
                    await loadReservations();
                } else {
                    alert('âŒ ë°”ìš°ì²˜ì¸ë³´ì´ìŠ¤ ìƒì„± ì‹¤íŒ¨: ' + (result.message || result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('ë°”ìš°ì²˜ì¸ë³´ì´ìŠ¤ ìƒì„± ì˜¤ë¥˜:', error);
                alert('âŒ ë°”ìš°ì²˜ì¸ë³´ì´ìŠ¤ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ì¸ë³´ì´ìŠ¤ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        function refreshInvoiceList() {
            if (currentVoucherReservationId) {
                loadVoucherInvoicesList(currentVoucherReservationId);
            }
        }
        
        // ì´ë©”ì¼ ì „ì†¡ (ì¸ë³´ì´ìŠ¤ë³„)
        async function sendInvoiceEmail(invoiceId) {
            const email = document.getElementById(`email${invoiceId}Recipient`).value;
            const subject = document.getElementById(`email${invoiceId}Subject`).value;
            const message = document.getElementById(`email${invoiceId}Message`).value;
            
            if (!email) {
                alert('ë°›ëŠ” ì‚¬ëŒ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì´ë©”ì¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            const statusEl = document.getElementById(`invoice${invoiceId}EmailStatus`);
            if (statusEl) {
                statusEl.innerHTML = '<i class="fas fa-spinner fa-spin text-primary"></i>';
            }
            
            try {
                // ì´ë©”ì¼ ì „ì†¡ API í˜¸ì¶œ
                const response = await fetch(`/api/hotel-assignments/invoice/${invoiceId}/send-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        recipient_email: email,
                        subject: subject,
                        message: message
                    })
                });
                
                if (response.ok) {
                    if (statusEl) {
                        statusEl.innerHTML = '<i class="fas fa-check-circle text-success"></i>';
                    }
                    alert('âœ… ì´ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    // ì´ë©”ì¼ í¼ ì ‘ê¸°
                    const collapseEl = document.getElementById(`emailForm${invoiceId}`);
                    if (collapseEl) {
                        bootstrap.Collapse.getInstance(collapseEl)?.hide();
                    }
                } else {
                    throw new Error('ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('ì´ë©”ì¼ ì „ì†¡ ì˜¤ë¥˜:', error);
                if (statusEl) {
                    statusEl.innerHTML = '<i class="fas fa-exclamation-circle text-danger"></i>';
                }
                alert('âŒ ì´ë©”ì¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ë°”ìš°ì²˜ ì¸ë³´ì´ìŠ¤ ëª©ë¡ ë¡œë“œ
        async function loadVoucherInvoicesList(reservationId) {
            try {
                const response = await fetch(`/api/hotel-assignments/${reservationId}/invoices`);
                const result = await response.json();
                
                const listContainer = document.getElementById('voucherInvoicesList');
                
                if (result.success && result.invoices && result.invoices.length > 0) {
                    let html = '';
                    
                    result.invoices.forEach((invoice, index) => {
                        const invoiceDate = new Date(invoice.created_at).toLocaleDateString('ko-KR', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        const link = `${window.location.origin}/api/hotel-assignments/invoice/${invoice.id}/preview`;
                        const amount = parseFloat(invoice.total_amount || 0);
                        const amountKRW = parseFloat(invoice.total_amount_krw || 0);
                        
                        html += `
                            <div class="border-bottom p-3" style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                                <!-- ì¸ë³´ì´ìŠ¤ í—¤ë” -->
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h6 class="mb-1">
                                            <i class="fas fa-file-invoice text-success me-2"></i>
                                            <strong>${invoice.invoice_number || 'N/A'}</strong>
                                        </h6>
                                        <div class="small text-muted">
                                            <i class="fas fa-calendar me-1"></i>${invoiceDate}
                                        </div>
                                        <div class="mt-2">
                                            <span class="badge bg-success">$${amount.toFixed(2)}</span>
                                            ${amountKRW > 0 ? `<span class="badge bg-info ms-1">â‚©${Math.round(amountKRW).toLocaleString('ko-KR')}</span>` : ''}
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteVoucherInvoice(${invoice.id})" title="ì‚­ì œ">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                
                                <!-- ì—…ë¬´ í”„ë¡œì„¸ìŠ¤ (ì¸ë³´ì´ìŠ¤ë³„) -->
                                <div class="mb-3 p-2" style="background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                                    <div class="d-flex justify-content-around text-center small">
                                        <div class="flex-fill">
                                            <div class="text-success"><i class="fas fa-check-circle"></i></div>
                                            <div class="mt-1" style="font-size: 0.75rem;">ìƒì„±ì™„ë£Œ</div>
                                        </div>
                                        <div class="flex-fill">
                                            <div class="text-muted" id="invoice${invoice.id}EmailStatus"><i class="fas fa-envelope"></i></div>
                                            <div class="mt-1" style="font-size: 0.75rem;">ì´ë©”ì¼</div>
                                        </div>
                                        <div class="flex-fill">
                                            <div class="text-muted"><i class="fas fa-check-circle"></i></div>
                                            <div class="mt-1" style="font-size: 0.75rem;">ì™„ë£Œ</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- ì´ë©”ì¼ ì „ì†¡ í¼ (ì ‘ê¸°/í¼ì¹˜ê¸°) -->
                                <div class="mb-2">
                                    <button class="btn btn-sm btn-outline-info w-100" type="button" data-bs-toggle="collapse" data-bs-target="#emailForm${invoice.id}">
                                        <i class="fas fa-envelope me-1"></i>ì´ë©”ì¼ ì „ì†¡
                                    </button>
                                </div>
                                <div class="collapse" id="emailForm${invoice.id}">
                                    <div class="card card-body p-2 mb-2" style="background: #f0f8ff;">
                                        <div class="mb-2">
                                            <input type="email" class="form-control form-control-sm" id="email${invoice.id}Recipient" placeholder="ë°›ëŠ” ì‚¬ëŒ ì´ë©”ì¼" value="${currentVoucherAgencyEmail || ''}">
                                        </div>
                                        <div class="mb-2">
                                            <input type="text" class="form-control form-control-sm" id="email${invoice.id}Subject" value="[ê´Œì„¸ì´ë¸Œì¹´ë“œ] í˜¸í…” ë°”ìš°ì²˜ ì¸ë³´ì´ìŠ¤">
                                        </div>
                                        <div class="mb-2">
                                            <textarea class="form-control form-control-sm" id="email${invoice.id}Message" rows="2" placeholder="ì¶”ê°€ ë©”ì‹œì§€..."></textarea>
                                        </div>
                                        <button class="btn btn-sm btn-info w-100" onclick="sendInvoiceEmail(${invoice.id})">
                                            <i class="fas fa-paper-plane me-1"></i>ì „ì†¡
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- ì•¡ì…˜ ë²„íŠ¼ -->
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="window.open('${link}', '_blank')">
                                        <i class="fas fa-external-link-alt me-1"></i>ë¯¸ë¦¬ë³´ê¸°
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="copyInvoiceLink('${link}')">
                                        <i class="fas fa-copy me-1"></i>ë§í¬ë³µì‚¬
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    listContainer.innerHTML = html;
                } else {
                    listContainer.innerHTML = `
                        <div class="text-center text-muted p-4">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p class="mb-0 small">ì•„ì§ ë°œí–‰ëœ ì¸ë³´ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('ì¸ë³´ì´ìŠ¤ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // ì¸ë³´ì´ìŠ¤ ë§í¬ ë³µì‚¬
        function copyInvoiceLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                alert('âœ… ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }).catch(err => {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                alert('âŒ ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }
        
        // ì¸ë³´ì´ìŠ¤ ë¯¸ë¦¬ë³´ê¸° ë¡œë“œ
        async function loadInvoicePreview(invoiceId, link) {
            try {
                const previewContainer = document.getElementById('voucherInvoicePreview');
                if (previewContainer) {
                    // iframeìœ¼ë¡œ ê²©ë¦¬í•˜ì—¬ ì™¸ë¶€ ìŠ¤íƒ€ì¼ì— ì˜í–¥ ë°©ì§€
                    previewContainer.innerHTML = `
                        <iframe src="${link}" 
                                style="width: 100%; min-height: 800px; border: none; background: white;"
                                onload="this.style.height = (this.contentWindow.document.body.scrollHeight + 50) + 'px'">
                        </iframe>
                    `;
                }
            } catch (error) {
                console.error('ë¯¸ë¦¬ë³´ê¸° ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('âŒ ë¯¸ë¦¬ë³´ê¸° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ì¸ë³´ì´ìŠ¤ ì‚­ì œ
        async function deleteVoucherInvoice(invoiceId) {
            if (!confirm('ì´ ì¸ë³´ì´ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/hotel-assignments/invoice/${invoiceId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… ì¸ë³´ì´ìŠ¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                    // ì¸ë³´ì´ìŠ¤ ëª©ë¡ ê°±ì‹ 
                    await loadVoucherInvoicesList(currentVoucherReservationId);
                    
                    // â­ ìµœì‹  ì˜ˆì•½ ë°ì´í„°ë¡œ ê¸ˆì•¡ ìƒì„¸ ë‚´ì—­ ì¬ê³„ì‚°
                    await refreshVoucherAmountDetails(currentVoucherReservationId);
                    
                    // ì˜ˆì•½ ëª©ë¡ ê°±ì‹  (ë±ƒì§€ ìƒíƒœ ì—…ë°ì´íŠ¸)
                    await loadReservations();
                    
                    // ëª©ë¡ ë¡œë“œ í›„ í–‰ ê°•ì¡° ë‹¤ì‹œ ì ìš©
                    setTimeout(() => {
                        highlightReservationRow(currentVoucherReservationId);
                    }, 800);
                } else{
                    alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('ì¸ë³´ì´ìŠ¤ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ê¸ˆì•¡ ìƒì„¸ ë‚´ì—­ ìƒˆë¡œê³ ì¹¨
        async function refreshVoucherAmountDetails(reservationId) {
            try {
                const response = await fetch(`/api/hotel-reservations/${reservationId}`);
                if (!response.ok) return;
                
                const data = await response.json();
                
                console.log('ğŸ” refreshVoucherAmountDetails - ì˜ˆì•½ ë°ì´í„°:', data);
                
                // ê¸ˆì•¡ ì¬ê³„ì‚°
                let totalAmount = 0;
                let totalRoomCharge = 0;
                let totalBreakfastCharge = 0;
                let totalExtrasCharge = 0;
                const rooms = data.rooms || [];
                const extras = data.extras || [];
                
                console.log('ğŸ” ê°ì‹¤ ìˆ˜:', rooms.length);
                
                const checkInDate = new Date(data.check_in_date);
                const checkOutDate = new Date(data.check_out_date);
                const nights = Math.round((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));
                
                let breakfastDetails = [];
                
                // ê°ì‹¤ ìš”ê¸ˆ
                rooms.forEach((room, idx) => {
                    let roomRate = parseFloat(room.room_rate || 0);
                    if (roomRate === 0 && room.total_selling_price && nights > 0) {
                        roomRate = parseFloat(room.total_selling_price) / nights;
                    }
                    const roomCharge = roomRate * nights;
                    totalRoomCharge += roomCharge;
                    totalAmount += roomCharge;
                    
                    // ì¡°ì‹ ìš”ê¸ˆ
                    const isBreakfastIncluded = room.breakfast_included === true || room.breakfast_included === 'true' || room.breakfast_included === 1;
                    console.log(`ğŸ” Room ${idx + 1} - breakfast_included:`, room.breakfast_included, 'â†’', isBreakfastIncluded);
                    
                    if (isBreakfastIncluded) {
                        const adultCount = parseInt(room.breakfast_adult_count || 0);
                        const childCount = parseInt(room.breakfast_child_count || 0);
                        const adultPrice = parseFloat(room.breakfast_adult_price || 0);
                        const childPrice = parseFloat(room.breakfast_child_price || 0);
                        const breakfastDays = parseInt(room.breakfast_days || nights);
                        
                        console.log(`ğŸ” Room ${idx + 1} ì¡°ì‹ ì •ë³´:`, { adultCount, childCount, adultPrice, childPrice, breakfastDays });
                        
                        const breakfastCharge = (adultCount * breakfastDays * adultPrice) + (childCount * breakfastDays * childPrice);
                        totalBreakfastCharge += breakfastCharge;
                        totalAmount += breakfastCharge;
                        
                        if (breakfastCharge > 0) {
                            let detail = '';
                            if (adultCount > 0) detail += `ì„±ì¸ ${adultCount}ëª… x $${adultPrice} x ${breakfastDays}ì¼`;
                            if (childCount > 0) {
                                if (detail) detail += ' + ';
                                detail += `ì†Œì•„ ${childCount}ëª… x $${childPrice} x ${breakfastDays}ì¼`;
                            }
                            breakfastDetails.push(detail);
                        }
                    }
                });
                
                // ì¶”ê°€ ì„œë¹„ìŠ¤
                let extrasDetails = [];
                extras.forEach(extra => {
                    const charge = parseFloat(extra.charge || extra.total_selling_price || 0);
                    totalExtrasCharge += charge;
                    totalAmount += charge;
                    if (charge > 0) {
                        const itemName = extra.service_name || extra.item_name || extra.extra_name || 'ì¶”ê°€í•­ëª©';
                        let detail = `${itemName}: $${charge.toFixed(2)}`;
                        
                        // ìˆ˜ëŸ‰ ì •ë³´ ì¶”ê°€
                        const quantity = parseInt(extra.quantity || 1);
                        if (quantity > 1) {
                            detail += ` (ìˆ˜ëŸ‰: ${quantity})`;
                        }
                        
                        // ì¸ì›ë³„ ê°€ê²© ì •ë³´ ì¶”ê°€
                        const adultCount = parseInt(extra.adult_count || 0);
                        const childCount = parseInt(extra.child_count || 0);
                        const infantCount = parseInt(extra.infant_count || 0);
                        
                        if (adultCount > 0 || childCount > 0 || infantCount > 0) {
                            const details = [];
                            if (adultCount > 0) {
                                const adultPrice = parseFloat(extra.adult_price || 0);
                                details.push(`ì„±ì¸ ${adultCount}ëª…Ã—$${adultPrice}`);
                            }
                            if (childCount > 0) {
                                const childPrice = parseFloat(extra.child_price || 0);
                                details.push(`ì†Œì•„ ${childCount}ëª…Ã—$${childPrice}`);
                            }
                            if (infantCount > 0) {
                                const infantPrice = parseFloat(extra.infant_price || 0);
                                details.push(`ìœ ì•„ ${infantCount}ëª…Ã—$${infantPrice}`);
                            }
                            if (details.length > 0) {
                                detail += ` (${details.join(', ')})`;
                            }
                        }
                        
                        extrasDetails.push(detail);
                    }
                });
                
                // ìˆ˜ë°°í”¼
                const agencyFee = parseFloat(data.agency_fee || 0);
                totalAmount += agencyFee;
                
                // UI ì—…ë°ì´íŠ¸
                document.getElementById('voucherRoomChargeDisplay').textContent = '$' + totalRoomCharge.toFixed(2);
                
                // ì¡°ì‹ ìƒì„¸ ë‚´ì—­
                document.getElementById('voucherBreakfastChargeDisplay').textContent = '$' + totalBreakfastCharge.toFixed(2);
                const breakfastContainer = document.getElementById('voucherBreakfastDetailContainer');
                if (breakfastContainer) {
                    if (breakfastDetails.length > 0) {
                        breakfastContainer.innerHTML = breakfastDetails.map(detail => 
                            `<div class="text-muted mb-1">â€¢ ${detail}</div>`
                        ).join('');
                    } else {
                        breakfastContainer.innerHTML = '<div class="text-muted">ì¡°ì‹ ë¯¸í¬í•¨</div>';
                    }
                }
                
                // ì¶”ê°€ í•­ëª© ìƒì„¸ ë‚´ì—­
                document.getElementById('voucherExtrasChargeDisplay').textContent = '$' + totalExtrasCharge.toFixed(2);
                const extrasContainer = document.getElementById('voucherExtrasDetailContainer');
                if (extrasContainer) {
                    if (extrasDetails.length > 0) {
                        extrasContainer.innerHTML = extrasDetails.map(detail => 
                            `<div class="text-muted mb-1">â€¢ ${detail}</div>`
                        ).join('');
                    } else {
                        extrasContainer.innerHTML = '<div class="text-muted">ì¶”ê°€í•­ëª© ì—†ìŒ</div>';
                    }
                }
                
                document.getElementById('voucherAgencyFeeDisplay').textContent = '$' + agencyFee.toFixed(2);
                document.getElementById('voucherAgencyNameDisplay').textContent = data.booking_agency_name || data.agency_name || '-';
                document.getElementById('voucherTotalUSD').textContent = '$' + totalAmount.toFixed(2);
                document.getElementById('voucherTotalKRW').textContent = 'â‚©' + (totalAmount * voucherFxRate).toLocaleString('ko-KR', {maximumFractionDigits: 0});
                
                // hidden input ì—…ë°ì´íŠ¸
                document.getElementById('voucherBaseAmount').value = totalAmount.toFixed(2);
                voucherBaseAmountUSD = totalAmount;
                
                console.log('âœ… ê¸ˆì•¡ ìƒì„¸ ë‚´ì—­ ê°±ì‹  ì™„ë£Œ:', totalAmount);
            } catch (error) {
                console.error('ê¸ˆì•¡ ìƒì„¸ ë‚´ì—­ ê°±ì‹  ì˜¤ë¥˜:', error);
            }
        }
        
        function openVoucherInvoicePreview(invoiceId) {
            if (!invoiceId) {
                alert('ì¸ë³´ì´ìŠ¤ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const url = `/api/hotel-assignments/invoice/${invoiceId}/preview`;
            window.open(url, '_blank', 'width=900,height=900');
        }
        
        function previewVoucherInvoice() {
            if (!currentVoucherInvoiceId) {
                alert('ë¨¼ì € ë°”ìš°ì²˜ ì¸ë³´ì´ìŠ¤ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }
            openVoucherInvoicePreview(currentVoucherInvoiceId);
        }

        function copyVoucherInvoiceLink() {
            if (!currentVoucherInvoiceLink) {
                alert('ë¨¼ì € ë°”ìš°ì²˜ ì¸ë³´ì´ìŠ¤ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }
            const linkInput = document.getElementById('voucherInvoiceLinkInput');
            if (linkInput) {
                linkInput.select();
                linkInput.setSelectionRange(0, 99999);
            }
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(currentVoucherInvoiceLink).then(() => {
                    alert('ì¸ë³´ì´ìŠ¤ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }).catch(() => {
                    alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì…ë ¥ì°½ì—ì„œ ì§ì ‘ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
                });
            } else {
                alert('ë¸Œë¼ìš°ì €ì—ì„œ ìë™ ë³µì‚¬ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì…ë ¥ì°½ì—ì„œ ì§ì ‘ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
            }
        }

        function sendVoucherInvoiceEmail() {
            if (!currentVoucherInvoiceLink) {
                alert('ë¨¼ì € ë°”ìš°ì²˜ ì¸ë³´ì´ìŠ¤ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }
            const recipient = currentVoucherAgencyEmail || '';
            const subject = encodeURIComponent('[LUXFIND] Hotel Voucher Invoice');
            const body = encodeURIComponent(
                'ì•ˆë…•í•˜ì„¸ìš”,\n\n' +
                'ì•„ë˜ ë§í¬ì—ì„œ í˜¸í…” ë°”ìš°ì²˜ ì¸ë³´ì´ìŠ¤ë¥¼ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n' +
                currentVoucherInvoiceLink +
                '\n\nê°ì‚¬í•©ë‹ˆë‹¤.'
            );
            const mailtoUrl = `mailto:${recipient}?subject=${subject}&body=${body}`;
            window.location.href = mailtoUrl;
        }
        
        // ì •ì‚° ì´ê´€ ëª¨ë‹¬ ì—´ê¸°
        async function createSettlement(reservationId) {
            try {
                // ì˜ˆì•½ ì •ë³´ ì¡°íšŒ
                const response = await fetch(`/api/hotel-reservations/${reservationId}`);
                const reservation = await response.json();
                
                // ëª¨ë‹¬ì— ë°ì´í„° ì±„ìš°ê¸°
                document.getElementById('settlementReservationId').value = reservationId;
                document.getElementById('settlementReservationNumber').textContent = reservation.reservation_number || 'N/A';
                document.getElementById('settlementHotelName').textContent = reservation.hotel_name || 'N/A';
                document.getElementById('settlementCheckIn').textContent = formatDateShort(reservation.check_in_date);
                document.getElementById('settlementCheckOut').textContent = formatDateShort(reservation.check_out_date);
                document.getElementById('settlementAgencyName').textContent = reservation.agency_name || 'N/A';
                
                // ê¸ˆì•¡ ì •ë³´
                document.getElementById('settlementSellingPrice').value = reservation.total_selling_price || 0;
                document.getElementById('settlementCostPrice').value = reservation.total_cost_price || 0;
                document.getElementById('settlementAgencyFee').value = reservation.agency_fee || 0;
                document.getElementById('settlementExchangeRate').value = reservation.exchange_rate || 1300;
                
                // ë§ˆì§„ ê³„ì‚°
                calculateSettlementMargin();
                
                // ëª¨ë‹¬ ì—´ê¸°
                new bootstrap.Modal(document.getElementById('settlementModal')).show();
            } catch (error) {
                console.error('ì •ì‚° ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ì •ì‚° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ì •ì‚° ë§ˆì§„ ê³„ì‚°
        function calculateSettlementMargin() {
            const sellingPrice = parseFloat(document.getElementById('settlementSellingPrice').value) || 0;
            const costPrice = parseFloat(document.getElementById('settlementCostPrice').value) || 0;
            const agencyFee = parseFloat(document.getElementById('settlementAgencyFee').value) || 0;
            const exchangeRate = parseFloat(document.getElementById('settlementExchangeRate').value) || 1300;
            
            const revenueKRW = Math.round(sellingPrice * exchangeRate);
            const costKRW = Math.round(costPrice * exchangeRate);
            const margin = revenueKRW - costKRW - agencyFee;
            
            document.getElementById('settlementRevenueKRW').textContent = formatCurrency(revenueKRW);
            document.getElementById('settlementCostKRW').textContent = formatCurrency(costKRW);
            document.getElementById('settlementMargin').textContent = formatCurrency(margin);
        }
        
        // ì •ì‚° ì´ê´€ ì²˜ë¦¬
        async function processSettlement() {
            const reservationId = document.getElementById('settlementReservationId').value;
            const sellingPrice = parseFloat(document.getElementById('settlementSellingPrice').value) || 0;
            const costPrice = parseFloat(document.getElementById('settlementCostPrice').value) || 0;
            const agencyFee = parseFloat(document.getElementById('settlementAgencyFee').value) || 0;
            const exchangeRate = parseFloat(document.getElementById('settlementExchangeRate').value) || 1300;
            const memo = document.getElementById('settlementMemo').value || '';
            
            if (!confirm('ì •ì‚°ìœ¼ë¡œ ì´ê´€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ê´€ í›„ ìˆ˜ë°°ê´€ë¦¬ ëª©ë¡ì—ì„œ ì œê±°ë˜ê³  ì •ì‚°ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/hotel-reservations/${reservationId}/settlement`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        total_selling_price: sellingPrice,
                        total_cost_price: costPrice,
                        agency_fee: agencyFee,
                        exchange_rate: exchangeRate,
                        settlement_memo: memo
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… ì •ì‚°ìœ¼ë¡œ ì´ê´€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    bootstrap.Modal.getInstance(document.getElementById('settlementModal')).hide();
                    
                    // ì˜ˆì•½ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    await loadReservations();
                } else {
                    alert('âŒ ì´ê´€ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('ì •ì‚° ì´ê´€ ì‹¤íŒ¨:', error);
                alert('âŒ ì •ì‚° ì´ê´€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // í†µí™” í¬ë§·
        function formatCurrency(amount) {
            return 'â‚©' + Math.round(amount).toLocaleString('ko-KR');
        }
    </script>
    
    <!-- ì •ì‚° ì´ê´€ ëª¨ë‹¬ -->
    <div class="modal fade" id="settlementModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="fas fa-dollar-sign me-2"></i>ì •ì‚° ì´ê´€</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="settlementReservationId">
                    
                    <!-- ì˜ˆì•½ ì •ë³´ -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>ì˜ˆì•½ ì •ë³´</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-2"><strong>ì˜ˆì•½ë²ˆí˜¸:</strong> <span id="settlementReservationNumber"></span></p>
                                    <p class="mb-2"><strong>í˜¸í…”ëª…:</strong> <span id="settlementHotelName"></span></p>
                                    <p class="mb-2"><strong>ê±°ë˜ì²˜:</strong> <span id="settlementAgencyName"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-2"><strong>ì²´í¬ì¸:</strong> <span id="settlementCheckIn"></span></p>
                                    <p class="mb-2"><strong>ì²´í¬ì•„ì›ƒ:</strong> <span id="settlementCheckOut"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì •ì‚° ê¸ˆì•¡ -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>ì •ì‚° ê¸ˆì•¡</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">ê±°ë˜ì•¡ (íŒë§¤ê°€ USD)</label>
                                        <input type="number" class="form-control" id="settlementSellingPrice" 
                                               onchange="calculateSettlementMargin()" step="0.01">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">í™˜ìœ¨ (KRW)</label>
                                        <input type="number" class="form-control" id="settlementExchangeRate" 
                                               onchange="calculateSettlementMargin()" step="0.01">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">ë§¤ì…ì•¡ (í˜¸í…” ì†¡ê¸ˆì•¡ USD)</label>
                                        <input type="number" class="form-control" id="settlementCostPrice" 
                                               onchange="calculateSettlementMargin()" step="0.01">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">ìˆ˜ë°°í”¼ (KRW)</label>
                                        <input type="number" class="form-control" id="settlementAgencyFee" 
                                               onchange="calculateSettlementMargin()" step="1">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ê³„ì‚° ê²°ê³¼ -->
                            <div class="alert alert-info">
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>ê±°ë˜ì•¡(ì›í™”):</strong><br>
                                        <span id="settlementRevenueKRW" class="fs-5">â‚©0</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>ë§¤ì…ì•¡(ì›í™”):</strong><br>
                                        <span id="settlementCostKRW" class="fs-5">â‚©0</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>ë§ˆì§„:</strong><br>
                                        <span id="settlementMargin" class="fs-5 text-success">â‚©0</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">ì •ì‚° ë©”ëª¨</label>
                                <textarea class="form-control" id="settlementMemo" rows="3" 
                                          placeholder="ì •ì‚° ê´€ë ¨ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>ì£¼ì˜:</strong> ì •ì‚° ì´ê´€ í›„ ì´ ì˜ˆì•½ì€ ìˆ˜ë°°ê´€ë¦¬ ëª©ë¡ì—ì„œ ì œê±°ë˜ê³  ì •ì‚°ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-warning" onclick="processSettlement()">
                        <i class="fas fa-check me-1"></i>ì •ì‚° ì´ê´€
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>