<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒ¨í‚¤ì§€ ì •ì‚°ê´€ë¦¬ - ê´Œì„¸ì´ë¸Œì¹´ë“œ ê´€ë¦¬ì</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .editable-cell {
            cursor: pointer;
            border: 1px solid transparent;
            padding: 4px 8px;
            border-radius: 3px;
        }
        .editable-cell:hover {
            background-color: #f0f8ff;
            border-color: #007bff;
        }
        .editable-cell.editing {
            background-color: #fff3cd;
            border-color: #ffc107;
        }
        .cost-input {
            width: 120px;
            text-align: right;
        }
        .vendor-row {
            background-color: #f8f9fa;
        }
        .vendor-row:hover {
            background-color: #e9ecef;
        }
        .sent-row {
            background-color: #d4edda;
        }
        .pending-row {
            background-color: #fff3cd;
        }
        
        /* ì •ì‚°ì„œ ì¸ì‡„ ìŠ¤íƒ€ì¼ */
        @media print {
            @page {
                size: A4;
                margin: 8mm;
            }
            
            body * {
                visibility: hidden;
            }
            #settlementDocument, #settlementDocument * {
                visibility: visible;
            }
            #settlementDocument {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
            
            .settlement-document {
                padding: 0 !important;
                max-width: 100% !important;
            }
            
            .doc-header {
                padding-bottom: 4px !important;
                margin-bottom: 6px !important;
                border-bottom: 1px solid #000 !important;
            }
            
            .doc-title {
                font-size: 16px !important;
                margin-bottom: 2px !important;
                line-height: 1.2 !important;
            }
            
            .doc-number {
                font-size: 8px !important;
                line-height: 1.2 !important;
            }
            
            .doc-section {
                margin-bottom: 6px !important;
            }
            
            .doc-section-title {
                font-size: 11px !important;
                padding: 2px 4px !important;
                margin-bottom: 3px !important;
                border-left: 2px solid #000 !important;
                background-color: #f0f0f0 !important;
                line-height: 1.2 !important;
            }
            
            .doc-table {
                margin-bottom: 4px !important;
                font-size: 8px !important;
            }
            
            .doc-table th,
            .doc-table td {
                padding: 1px 2px !important;
                border: 1px solid #000 !important;
                line-height: 1.1 !important;
            }
            
            .doc-table th {
                background-color: #e9ecef !important;
            }
            
            .doc-summary {
                background-color: #f0f0f0 !important;
                border: 1px solid #000 !important;
                padding: 4px !important;
                margin-top: 6px !important;
            }
            
            .doc-summary-title {
                font-size: 11px !important;
                margin-bottom: 3px !important;
                line-height: 1.2 !important;
            }
            
            .doc-summary .doc-table {
                font-size: 8px !important;
            }
            
            .doc-footer {
                margin-top: 6px !important;
                font-size: 8px !important;
                line-height: 1.2 !important;
            }
            
            .doc-footer p {
                margin-bottom: 2px !important;
            }
            
            * {
                color: #000 !important;
                background-color: transparent !important;
            }
            
            .doc-table th {
                background-color: #e9ecef !important;
            }
            
            .doc-section-title {
                background-color: #f0f0f0 !important;
            }
            
            .doc-summary {
                background-color: #f0f0f0 !important;
            }
        }
        
        .settlement-document {
            background: white;
            padding: 20px;
            max-width: 210mm;
            margin: 0 auto;
        }
        
        .doc-header {
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        .doc-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .doc-number {
            font-size: 11px;
            color: #666;
        }
        
        .doc-section {
            margin-bottom: 15px;
        }
        
        .doc-section-title {
            font-size: 14px;
            font-weight: bold;
            background-color: #f0f0f0;
            padding: 5px 8px;
            border-left: 3px solid #007bff;
            margin-bottom: 8px;
        }
        
        .doc-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            font-size: 11px;
        }
        
        .doc-table th,
        .doc-table td {
            border: 1px solid #000;
            padding: 4px 6px;
            text-align: left;
        }
        
        .doc-table th {
            background-color: #e9ecef;
            font-weight: bold;
        }
        
        .doc-table td.text-end {
            text-align: right;
        }
        
        .doc-summary {
            background-color: #f0f0f0;
            border: 2px solid #000;
            padding: 10px;
            margin-top: 15px;
        }
        
        .doc-summary-title {
            font-size: 15px;
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .doc-footer {
            margin-top: 15px;
            text-align: right;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar', { currentPage: 'package-settlements', adminUsername: adminName || 'ê´€ë¦¬ì' }) %>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-calculator me-2"></i>íŒ¨í‚¤ì§€ ì •ì‚°ê´€ë¦¬</h2>
                    <a href="/admin/package-reservations" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-1"></i>ì˜ˆì•½ê´€ë¦¬ë¡œ ëŒì•„ê°€ê¸°
                    </a>
                </div>
            </div>
        </div>

        <!-- ê²€ìƒ‰ í•„í„° -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label">ì¶œë°œì¼ (ì‹œì‘)</label>
                        <input type="date" class="form-control" id="filter_start_date">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ì¶œë°œì¼ (ì¢…ë£Œ)</label>
                        <input type="date" class="form-control" id="filter_end_date">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ì˜ˆì•½ì±„ë„</label>
                        <select class="form-select" id="filter_platform">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ì†¡ê¸ˆìƒíƒœ</label>
                        <select class="form-select" id="filter_status">
                            <option value="all">ì „ì²´</option>
                            <option value="pending">ë¯¸ì†¡ê¸ˆ</option>
                            <option value="partial">ë¶€ë¶„ì†¡ê¸ˆ</option>
                            <option value="completed">ì†¡ê¸ˆì™„ë£Œ</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ê²€ìƒ‰</label>
                        <input type="text" class="form-control" id="filter_search" placeholder="ì˜ˆì•½ë²ˆí˜¸, ê³ ê°ëª…">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ë§¤ì…ì²˜ / êµ¬ì„±ìš”ì†Œ</label>
                        <input type="text" class="form-control" id="filter_vendor" placeholder="ë§¤ì…ì²˜ëª…, í•­ê³µê¶Œ...">
                    </div>
                    <div class="col-md-2 d-flex align-items-end gap-2">
                        <button class="btn btn-primary flex-grow-1" onclick="filterAndRender()">
                            <i class="fas fa-search me-1"></i>ê²€ìƒ‰
                        </button>
                        <button class="btn btn-outline-secondary" onclick="resetFilters()" title="í•„í„° ì´ˆê¸°í™”">
                            <i class="fas fa-undo"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- í†µê³„ ì˜ì—­ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body">
                        <h6><i class="fas fa-clock me-2"></i>ì†¡ê¸ˆì „</h6>
                        <h3 id="stat_pending_count">0</h3>
                        <small>ì…ê¸ˆì™„ë£Œ, ì†¡ê¸ˆëŒ€ê¸°</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h6><i class="fas fa-check-circle me-2"></i>ì†¡ê¸ˆì™„ë£Œ</h6>
                        <h3 id="stat_completed_count">0</h3>
                        <small>ì •ì‚°ì™„ë£Œ</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h6><i class="fas fa-money-bill-wave me-2"></i>ë¯¸ì†¡ê¸ˆ ì´ì•¡</h6>
                        <h3 id="stat_pending_amount">â‚©0</h3>
                        <small>ì†¡ê¸ˆí•´ì•¼ í•  ê¸ˆì•¡</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h6><i class="fas fa-paper-plane me-2"></i>ì†¡ê¸ˆì™„ë£Œ ì´ì•¡</h6>
                        <h3 id="stat_completed_amount">â‚©0</h3>
                        <small>ì´ë²ˆ ë‹¬ ì†¡ê¸ˆì•¡</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <ul class="nav nav-tabs mb-3" id="settlementTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" onclick="currentTab='pending'; filterAndRender();">
                    <i class="fas fa-clock me-2"></i>ì†¡ê¸ˆì „ (<span id="pending_count">0</span>)
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed" type="button" onclick="currentTab='completed'; filterAndRender();">
                    <i class="fas fa-check-circle me-2"></i>ì†¡ê¸ˆì™„ë£Œ (<span id="completed_count">0</span>)
                </button>
            </li>
        </ul>

        <!-- ì¼ê´„ ì²˜ë¦¬ ë²„íŠ¼ -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="me-3">ì„ íƒ: <strong id="selected_count">0</strong>ê±´</span>
                        <span class="me-3">ì´ ë§¤ì…ì•¡: <strong id="selected_total">â‚©0</strong></span>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="bulkSendPayment()">
                            <i class="fas fa-paper-plane me-1"></i>ì„ íƒ í•­ëª© ì¼ê´„ ì†¡ê¸ˆì™„ë£Œ
                        </button>
                        <button class="btn btn-outline-secondary ms-2" onclick="clearSelection()">
                            <i class="fas fa-times me-1"></i>ì„ íƒ í•´ì œ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- íƒ­ ì»¨í…ì¸  -->
        <div class="tab-content" id="settlementTabContent">
            <div class="tab-pane fade show active" id="pending" role="tabpanel">
                <div id="pending_list">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="completed" role="tabpanel">
                <div id="completed_list">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì •ì‚°ì„œ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
    <div class="modal fade" id="settlementDocumentModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header no-print">
                    <h5 class="modal-title"><i class="fas fa-file-invoice me-2"></i>ì •ì‚°ì„œ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="settlementDocument">
                    <!-- ì •ì‚°ì„œ ë‚´ìš©ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
                <div class="modal-footer no-print">
                    <button type="button" class="btn btn-primary" onclick="printSettlement()">
                        <i class="fas fa-print me-1"></i>ì¸ì‡„
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>ë‹«ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allReservations = [];
        let selectedItems = new Set();
        let currentTab = 'pending';

        // ì •ì‚° ëª©ë¡ ë¡œë“œ
        async function loadSettlements() {
            try {
                const response = await fetch('/api/package-settlements/list');
                const result = await response.json();
                
                if (!result.success) {
                    alert('ì •ì‚° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const { pending, completed, stats } = result.data;
                
                // í†µê³„ ì—…ë°ì´íŠ¸
                document.getElementById('stat_pending_count').textContent = stats.pending_count;
                document.getElementById('stat_completed_count').textContent = stats.completed_count;
                document.getElementById('stat_pending_amount').textContent = `â‚©${stats.pending_amount.toLocaleString()}`;
                document.getElementById('stat_completed_amount').textContent = `â‚©${stats.completed_amount.toLocaleString()}`;
                
                document.getElementById('pending_count').textContent = pending.length;
                document.getElementById('completed_count').textContent = completed.length;
                
                // ì˜ˆì•½ ë°ì´í„° ì €ì¥
                allReservations = { pending, completed };
                
                // ì±„ë„ í•„í„° ì˜µì…˜ ì—…ë°ì´íŠ¸
                updatePlatformFilter();
                
                // í•„í„° ì ìš© ë° ë Œë”ë§
                filterAndRender();
                
            } catch (error) {
                console.error('ì •ì‚° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ì •ì‚° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì±„ë„ í•„í„° ì˜µì…˜ ì—…ë°ì´íŠ¸
        function updatePlatformFilter() {
            const allItems = [...allReservations.pending, ...allReservations.completed];
            const platforms = [...new Set(allItems.map(r => r.platform_name))];
            const select = document.getElementById('filter_platform');
            select.innerHTML = '<option value="">ì „ì²´</option>' + 
                platforms.map(p => `<option value="${p}">${p}</option>`).join('');
        }

        // í•„í„° ì´ˆê¸°í™”
        function resetFilters() {
            document.getElementById('filter_start_date').value = '';
            document.getElementById('filter_end_date').value = '';
            document.getElementById('filter_platform').value = '';
            document.getElementById('filter_status').value = 'all';
            document.getElementById('filter_search').value = '';
            document.getElementById('filter_vendor').value = '';
            filterAndRender();
        }

        // í•„í„°ë§ ë° ë Œë”ë§
        function filterAndRender() {
            const startDate = document.getElementById('filter_start_date').value;
            const endDate = document.getElementById('filter_end_date').value;
            const platform = document.getElementById('filter_platform').value;
            const search = document.getElementById('filter_search').value.toLowerCase().trim();
            const vendorSearch = document.getElementById('filter_vendor').value.toLowerCase().trim();

            // í˜„ì¬ íƒ­ì— ë”°ë¼ ë°ì´í„° ì„ íƒ
            const items = currentTab === 'pending' ? allReservations.pending : allReservations.completed;

            let filtered = items.filter(reservation => {
                // ë‚ ì§œ í•„í„°
                if (startDate && new Date(reservation.travel_period.departure_date) < new Date(startDate)) return false;
                if (endDate && new Date(reservation.travel_period.departure_date) > new Date(endDate)) return false;
                
                // ì‰¡ë„ í•„í„°
                if (platform && reservation.platform_name !== platform) return false;
                
                // ì˜ˆì•½ë²ˆí˜¸/ê³ ê°ëª… ê²€ìƒ‰
                if (search && !reservation.reservation_number.toLowerCase().includes(search) && 
                    !reservation.customer.korean_name.toLowerCase().includes(search)) return false;
                
                // ë§¤ì…ì²˜/êµ¬ì„±ìš”ì†Œ ê²€ìƒ‰ - í•´ë‹¹ ì˜ˆì•½ì— ì¼ì¹˜í•˜ëŠ” ë§¤ì…ì²˜ê°€ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ í¬í•¨
                if (vendorSearch) {
                    const components = reservation.cost_components || [];
                    const typeNames = { flight: 'í•­ê³µê¶Œ', hotel: 'í˜¸í…”', tour: 'íˆ¬ì–´', ground: 'ì§€ìƒêµí†µ' };
                    const hasMatch = components.some(c =>
                        (c.vendor_name || '').toLowerCase().includes(vendorSearch) ||
                        (c.component_type || '').toLowerCase().includes(vendorSearch) ||
                        (typeNames[c.component_type] || '').includes(vendorSearch)
                    );
                    if (!hasMatch) return false;
                }
                
                return true;
            });

            renderReservations(filtered, vendorSearch);
        }

        // ì˜ˆì•½ ëª©ë¡ ë Œë”ë§ (ì˜ˆì•½ë³„ ê·¸ë£¹í™”)
        function renderReservations(reservations, vendorSearch = '') {
            const container = currentTab === 'pending' ? document.getElementById('pending_list') : document.getElementById('completed_list');
            
            if (reservations.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-5">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            container.innerHTML = reservations.map(reservation => {
                const components = reservation.cost_components || [];
                const totalCost = components.reduce((sum, c) => sum + (c.cost_krw || 0), 0);
                const sentCount = components.filter(c => c.payment_sent_date).length;
                
                return `
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <div class="row align-items-center">
                                <div class="col-md-2">
                                    <strong>ì¶œë°œì¼:</strong> ${new Date(reservation.travel_period.departure_date).toLocaleDateString('ko-KR')}
                                </div>
                                <div class="col-md-2">
                                    <strong>ì±„ë„:</strong> ${reservation.platform_name}
                                </div>
                                <div class="col-md-2">
                                    <strong>ì˜ˆì•½ë²ˆí˜¸:</strong> ${reservation.reservation_number}
                                </div>
                                <div class="col-md-2">
                                    <strong>ê³ ê°ëª…:</strong> ${reservation.customer.korean_name}
                                </div>
                                <div class="col-md-2">
                                    <strong>ì´ ë§¤ì…ì•¡:</strong> <span class="text-primary">â‚©${totalCost.toLocaleString()}</span>
                                </div>
                                <div class="col-md-2 text-end">
                                    <span class="badge ${sentCount === components.length ? 'bg-success' : sentCount > 0 ? 'bg-warning' : 'bg-secondary'}">
                                        ${sentCount}/${components.length} ì†¡ê¸ˆì™„ë£Œ
                                    </span>
                                    ${currentTab === 'completed' && sentCount === components.length ? `
                                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="openSettlementDocument('${reservation._id}')">
                                            <i class="fas fa-file-invoice me-1"></i>ì •ì‚°ì„œ
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 40px;">
                                            <input type="checkbox" onchange="toggleReservationAll('${reservation._id}', this.checked)">
                                        </th>
                                        <th>ë§¤ì…ì²˜</th>
                                        <th>êµ¬ì„±ìš”ì†Œ</th>
                                        <th>ë§¤ì…ì•¡</th>
                                        <th>ì†¡ê¸ˆì¼</th>
                                        <th>ìƒíƒœ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${components.map((comp, idx) => {
                                        const itemKey = `${reservation._id}_${idx}`;
                                        const isSelected = selectedItems.has(itemKey);
                                        const isSent = !!comp.payment_sent_date;
                                        
                                        const typeIcon = comp.component_type === 'flight' ? 'âœˆï¸' : 
                                                       comp.component_type === 'hotel' ? 'ğŸ¨' : 
                                                       comp.component_type === 'tour' ? 'ğŸ¯' : 
                                                       comp.component_type === 'ground' ? 'ğŸš—' : 'ğŸ“¦';
                                        const typeName = comp.component_type === 'flight' ? 'í•­ê³µê¶Œ' : 
                                                       comp.component_type === 'hotel' ? 'í˜¸í…”' : 
                                                       comp.component_type === 'tour' ? 'íˆ¬ì–´' : 
                                                       comp.component_type === 'ground' ? 'ì§€ìƒ' : 'ê¸°íƒ€';

                                        // ë§¤ì…ì²˜ ê²€ìƒ‰ í•˜ì´ë¼ì´íŠ¸
                                        const isVendorMatch = vendorSearch && (
                                            (comp.vendor_name || '').toLowerCase().includes(vendorSearch) ||
                                            (comp.component_type || '').toLowerCase().includes(vendorSearch) ||
                                            typeName.includes(vendorSearch)
                                        );
                                        const rowClass = isVendorMatch ? 'table-info' : (isSent ? 'sent-row' : 'pending-row');

                                        return `
                                            <tr class="${rowClass}" ${isVendorMatch ? 'style="outline: 2px solid #0d6efd;"' : ''}>
                                                <td class="text-center">
                                                    <input type="checkbox" 
                                                           class="vendor-checkbox"
                                                           data-reservation-id="${reservation._id}"
                                                           data-item-key="${itemKey}"
                                                           ${isSent ? 'disabled' : ''}
                                                           ${isSelected ? 'checked' : ''}
                                                           onchange="toggleItemSelection('${itemKey}')">
                                                </td>
                                                <td><strong>${comp.vendor_name}</strong></td>
                                                <td>${typeIcon} ${typeName}</td>
                                                <td>
                                                    <div class="editable-cell" 
                                                         onclick="editCost('${itemKey}', ${comp.cost_krw || 0})"
                                                         id="cost_${itemKey}">
                                                        â‚©${(comp.cost_krw || 0).toLocaleString()}
                                                    </div>
                                                </td>
                                                <td>
                                                    <input type="date" 
                                                           class="form-control form-control-sm" 
                                                           value="${comp.payment_sent_date ? new Date(comp.payment_sent_date).toISOString().split('T')[0] : ''}"
                                                           onchange="updateSentDate('${itemKey}', this.value)"
                                                           ${isSent ? 'readonly' : ''}>
                                                </td>
                                                <td>
                                                    ${isSent 
                                                        ? '<span class="badge bg-success">ì†¡ê¸ˆì™„ë£Œ</span>' 
                                                        : '<span class="badge bg-warning">ë¯¸ì†¡ê¸ˆ</span>'}
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }).join('');

            updateSelectionInfo();
        }

        // ì˜ˆì•½ ì „ì²´ ì„ íƒ/í•´ì œ
        function toggleReservationAll(reservationId, checked) {
            document.querySelectorAll(`input.vendor-checkbox[data-reservation-id="${reservationId}"]:not([disabled])`).forEach(checkbox => {
                checkbox.checked = checked;
                const itemKey = checkbox.dataset.itemKey;
                if (checked) {
                    selectedItems.add(itemKey);
                } else {
                    selectedItems.delete(itemKey);
                }
            });
            updateSelectionInfo();
        }

        // ë§¤ì…ì•¡ ì¸ë¼ì¸ í¸ì§‘
        function editCost(itemKey, currentCost) {
            const cell = document.getElementById(`cost_${itemKey}`);
            const [reservationId, componentIndex] = itemKey.split('_');
            
            // ì†¡ê¸ˆ ì™„ë£Œ ì—¬ë¶€ í™•ì¸
            const allItems = [...allReservations.pending, ...allReservations.completed];
            const reservation = allItems.find(r => r._id === reservationId);
            if (reservation && reservation.cost_components[parseInt(componentIndex)].payment_sent_date) {
                alert('ì†¡ê¸ˆ ì™„ë£Œëœ í•­ëª©ì€ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            cell.classList.add('editing');
            cell.innerHTML = `
                <input type="number" 
                       class="form-control form-control-sm cost-input" 
                       value="${currentCost}" 
                       id="input_${itemKey}"
                       onblur="saveCost('${itemKey}')"
                       onkeypress="if(event.key==='Enter') saveCost('${itemKey}')">
            `;
            document.getElementById(`input_${itemKey}`).focus();
        }

        // ë§¤ì…ì•¡ ì €ì¥
        async function saveCost(itemKey) {
            const input = document.getElementById(`input_${itemKey}`);
            const newCost = parseInt(input.value) || 0;
            const [reservationId, componentIndex] = itemKey.split('_');

            try {
                const response = await fetch(`/api/package-reservations/${reservationId}`);
                const result = await response.json();
                
                if (!result.success) {
                    alert('ì˜ˆì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }

                const reservation = result.data;
                reservation.cost_components[parseInt(componentIndex)].cost_krw = newCost;

                // ì´ ë§¤ì…ì•¡ ì¬ê³„ì‚°
                const totalCost = reservation.cost_components.reduce((sum, c) => sum + (c.cost_krw || 0), 0);
                reservation.settlement.total_cost_krw = totalCost;

                const updateResponse = await fetch(`/api/package-reservations/${reservationId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cost_components: reservation.cost_components,
                        settlement: reservation.settlement
                    })
                });

                const updateResult = await updateResponse.json();
                
                if (updateResult.success) {
                    alert('ë§¤ì…ì•¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadSettlements(); // ì „ì²´ ìƒˆë¡œê³ ì¹¨
                } else {
                    alert('ë§¤ì…ì•¡ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    loadSettlements(); // ì‹¤íŒ¨ ì‹œ ìƒˆë¡œê³ ì¹¨
                }
            } catch (error) {
                console.error('ë§¤ì…ì•¡ ìˆ˜ì • ì‹¤íŒ¨:', error);
                alert('ë§¤ì…ì•¡ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                loadSettlements();
            }
        }

        // ì†¡ê¸ˆì¼ ì—…ë°ì´íŠ¸
        async function updateSentDate(itemKey, date) {
            const [reservationId, componentIndex] = itemKey.split('_');

            try {
                const response = await fetch(`/api/package-reservations/${reservationId}`);
                const result = await response.json();
                
                if (!result.success) {
                    alert('ì˜ˆì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }

                const reservation = result.data;
                reservation.cost_components[parseInt(componentIndex)].payment_sent_date = date || null;

                const updateResponse = await fetch(`/api/package-reservations/${reservationId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cost_components: reservation.cost_components })
                });

                const updateResult = await updateResponse.json();
                
                if (updateResult.success) {
                    loadSettlements(); // ìƒˆë¡œê³ ì¹¨
                } else {
                    alert('ì†¡ê¸ˆì¼ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì†¡ê¸ˆì¼ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                alert('ì†¡ê¸ˆì¼ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í•­ëª© ì„ íƒ/í•´ì œ
        function toggleItemSelection(itemKey) {
            if (selectedItems.has(itemKey)) {
                selectedItems.delete(itemKey);
            } else {
                selectedItems.add(itemKey);
            }
            updateSelectionInfo();
        }

        // ì „ì²´ ì„ íƒ/í•´ì œ (ì‚¬ìš© ì•ˆ í•¨ - ì˜ˆì•½ë³„ ì²´í¬ë°•ìŠ¤ ì‚¬ìš©)
        function toggleSelectAll(checked) {
            // ì‚¬ìš© ì•ˆ í•¨
        }

        // ì„ íƒ í•´ì œ
        function clearSelection() {
            selectedItems.clear();
            document.querySelectorAll('input[data-item-key]').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.getElementById('select_all').checked = false;
            updateSelectionInfo();
        }

        // ì„ íƒ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateSelectionInfo() {
            const count = selectedItems.size;
            let total = 0;
            
            const allItems = [...allReservations.pending, ...allReservations.completed];
            selectedItems.forEach(itemKey => {
                const [reservationId, componentIndex] = itemKey.split('_');
                const reservation = allItems.find(r => r._id === reservationId);
                if (reservation && reservation.cost_components[parseInt(componentIndex)]) {
                    total += reservation.cost_components[parseInt(componentIndex)].cost_krw || 0;
                }
            });

            document.getElementById('selected_count').textContent = count;
            document.getElementById('selected_total').textContent = `â‚©${total.toLocaleString()}`;
        }

        // ì¼ê´„ ì†¡ê¸ˆ ì²˜ë¦¬
        async function bulkSendPayment() {
            if (selectedItems.size === 0) {
                alert('ì†¡ê¸ˆ ì²˜ë¦¬í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            const sentDate = prompt('ì†¡ê¸ˆì¼ì„ ì…ë ¥í•˜ì„¸ìš” (YYYY-MM-DD):', today);
            
            if (!sentDate) return;
            
            if (!confirm(`ì„ íƒí•œ ${selectedItems.size}ê°œ í•­ëª©ì„ ì†¡ê¸ˆ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                // ì˜ˆì•½ë³„ë¡œ ê·¸ë£¹í™”
                const reservationGroups = {};
                selectedItems.forEach(itemKey => {
                    const [reservationId, componentIndex] = itemKey.split('_');
                    if (!reservationGroups[reservationId]) {
                        reservationGroups[reservationId] = [];
                    }
                    reservationGroups[reservationId].push(parseInt(componentIndex));
                });

                // ê° ì˜ˆì•½ë³„ë¡œ ì—…ë°ì´íŠ¸
                for (const [reservationId, indices] of Object.entries(reservationGroups)) {
                    const response = await fetch(`/api/package-reservations/${reservationId}`);
                    const result = await response.json();
                    
                    if (!result.success) continue;

                    const reservation = result.data;
                    indices.forEach(index => {
                        reservation.cost_components[index].payment_sent_date = sentDate;
                    });

                    await fetch(`/api/package-reservations/${reservationId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ cost_components: reservation.cost_components })
                    });
                }

                alert('ì¼ê´„ ì†¡ê¸ˆ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                clearSelection();
                loadSettlements();

            } catch (error) {
                console.error('ì¼ê´„ ì†¡ê¸ˆ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                alert('ì¼ê´„ ì†¡ê¸ˆ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì •ì‚°ì„œ ì—´ê¸°
        async function openSettlementDocument(reservationId) {
            try {
                const response = await fetch(`/api/package-reservations/${reservationId}`);
                const result = await response.json();
                
                if (!result.success) {
                    alert('ì˜ˆì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const r = result.data;
                
                // ì…ê¸ˆ ë‚´ì—­ ê³„ì‚°
                const billings = r.billings || [];
                const completedBillings = billings.filter(b => b.status === 'completed');
                const totalReceived = completedBillings.reduce((sum, b) => sum + (b.amount || 0), 0);
                
                // ë§¤ì… ë‚´ì—­ ê³„ì‚°
                const components = r.cost_components || [];
                const totalCost = components.reduce((sum, c) => sum + (c.cost_krw || 0), 0);
                
                // ìˆ˜ìµ ê³„ì‚°
                const profit = totalReceived - totalCost;
                
                // ë¶€ê°€ì„¸ ê³„ì‚° (ìˆ˜ìµì˜ 10%)
                const vat = Math.round(profit * 0.1);
                
                // ìˆœìˆ˜ìµ (ìˆ˜ìµ - ë¶€ê°€ì„¸)
                const netProfit = profit - vat;
                
                // ì •ì‚°ì„œ HTML ìƒì„±
                const documentHtml = `
                    <div class="settlement-document">
                        <div class="doc-header">
                            <div class="doc-title">íŒ¨í‚¤ì§€ ì—¬í–‰ ì •ì‚°ì„œ</div>
                            <div class="doc-number">ë¬¸ì„œë²ˆí˜¸: PKG-${r.reservation_number}-${new Date().getFullYear()}</div>
                            <div class="doc-number">ë°œí–‰ì¼ì: ${new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                        </div>
                        
                        <!-- ê¸°ë³¸ ì •ë³´ -->
                        <div class="doc-section">
                            <div class="doc-section-title">1. ì˜ˆì•½ ê¸°ë³¸ ì •ë³´</div>
                            <table class="doc-table">
                                <tr>
                                    <th style="width: 150px;">ì˜ˆì•½ë²ˆí˜¸</th>
                                    <td>${r.reservation_number}</td>
                                    <th style="width: 150px;">ì˜ˆì•½ì±„ë„</th>
                                    <td>${r.platform_name}</td>
                                </tr>
                                <tr>
                                    <th>ê³ ê°ëª…</th>
                                    <td>${r.customer.korean_name}</td>
                                    <th>ì—°ë½ì²˜</th>
                                    <td>${r.customer.phone || '-'}</td>
                                </tr>
                                <tr>
                                    <th>ì¶œë°œì¼</th>
                                    <td>${new Date(r.travel_period.departure_date).toLocaleDateString('ko-KR')}</td>
                                    <th>ê·€êµ­ì¼</th>
                                    <td>${new Date(r.travel_period.return_date).toLocaleDateString('ko-KR')}</td>
                                </tr>
                                <tr>
                                    <th>ì—¬í–‰ì¸ì›</th>
                                    <td colspan="3">ì„±ì¸ ${r.traveler_count?.adults || 0}ëª…, ì†Œì•„ ${r.traveler_count?.children || 0}ëª…, ìœ ì•„ ${r.traveler_count?.infants || 0}ëª…</td>
                                </tr>
                            </table>
                        </div>
                        
                        <!-- ì…ê¸ˆ ë‚´ì—­ -->
                        <div class="doc-section">
                            <div class="doc-section-title">2. ì…ê¸ˆ ë‚´ì—­ (ë§¤ì¶œ)</div>
                            <table class="doc-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">ë²ˆí˜¸</th>
                                        <th>ê²°ì œìˆ˜ë‹¨</th>
                                        <th>ì…ê¸ˆì¼ì</th>
                                        <th style="width: 150px;" class="text-end">ê¸ˆì•¡</th>
                                        <th>ë¹„ê³ </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${completedBillings.map((b, idx) => {
                                        const typeIcon = b.type === 'cash' ? 'ğŸ’µ' : b.type === 'card' ? 'ğŸ’³' : 'ğŸ';
                                        const typeName = b.type === 'cash' ? 'í˜„ê¸ˆ' : b.type === 'card' ? 'ì¹´ë“œ' : 'í• ì¸';
                                        return `
                                            <tr>
                                                <td class="text-center">${idx + 1}</td>
                                                <td>${typeIcon} ${typeName}</td>
                                                <td>${b.date ? new Date(b.date).toLocaleDateString('ko-KR') : '-'}</td>
                                                <td class="text-end"><strong>â‚©${(b.amount || 0).toLocaleString()}</strong></td>
                                                <td>${b.notes || '-'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                    <tr style="background-color: #e9ecef;">
                                        <td colspan="3" class="text-end"><strong>ì…ê¸ˆ ì´ì•¡ (ë§¤ì¶œì•¡)</strong></td>
                                        <td class="text-end"><strong style="font-size: 1.2em; color: #28a745;">â‚©${totalReceived.toLocaleString()}</strong></td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- ë§¤ì… ë‚´ì—­ -->
                        <div class="doc-section">
                            <div class="doc-section-title">3. ë§¤ì… ë‚´ì—­ (ì›ê°€)</div>
                            <table class="doc-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">ë²ˆí˜¸</th>
                                        <th>êµ¬ì„±ìš”ì†Œ</th>
                                        <th>ë§¤ì…ì²˜</th>
                                        <th>ì†¡ê¸ˆì¼ì</th>
                                        <th style="width: 150px;" class="text-end">ë§¤ì…ì•¡</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${components.map((c, idx) => {
                                        const typeIcon = c.component_type === 'flight' ? 'âœˆï¸' : 
                                                       c.component_type === 'hotel' ? 'ğŸ¨' : 
                                                       c.component_type === 'tour' ? 'ğŸ¯' : 
                                                       c.component_type === 'ground' ? 'ğŸš—' : 'ğŸ“¦';
                                        const typeName = c.component_type === 'flight' ? 'í•­ê³µê¶Œ' : 
                                                       c.component_type === 'hotel' ? 'í˜¸í…”' : 
                                                       c.component_type === 'tour' ? 'íˆ¬ì–´' : 
                                                       c.component_type === 'ground' ? 'ì§€ìƒêµí†µ' : 'ê¸°íƒ€';
                                        return `
                                            <tr>
                                                <td class="text-center">${idx + 1}</td>
                                                <td>${typeIcon} ${typeName}</td>
                                                <td>${c.vendor_name}</td>
                                                <td>${c.payment_sent_date ? new Date(c.payment_sent_date).toLocaleDateString('ko-KR') : '-'}</td>
                                                <td class="text-end"><strong>â‚©${(c.cost_krw || 0).toLocaleString()}</strong></td>
                                            </tr>
                                        `;
                                    }).join('')}
                                    <tr style="background-color: #e9ecef;">
                                        <td colspan="4" class="text-end"><strong>ë§¤ì… ì´ì•¡ (ì›ê°€)</strong></td>
                                        <td class="text-end"><strong style="font-size: 1.2em; color: #dc3545;">â‚©${totalCost.toLocaleString()}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- ì •ì‚° ìš”ì•½ -->
                        <div class="doc-summary">
                            <div class="doc-summary-title">ì •ì‚° ìš”ì•½</div>
                            <table class="doc-table">
                                <tr>
                                    <th style="width: 200px;">í•­ëª©</th>
                                    <th class="text-end">ê¸ˆì•¡</th>
                                    <th style="width: 300px;">ë¹„ê³ </th>
                                </tr>
                                <tr>
                                    <td><strong>â‘  ì´ ì…ê¸ˆì•¡ (ë§¤ì¶œ)</strong></td>
                                    <td class="text-end"><strong style="color: #28a745;">â‚©${totalReceived.toLocaleString()}</strong></td>
                                    <td>ê³ ê°ìœ¼ë¡œë¶€í„° ë°›ì€ ì´ ê¸ˆì•¡</td>
                                </tr>
                                <tr>
                                    <td><strong>â‘¡ ì´ ë§¤ì…ì•¡ (ì›ê°€)</strong></td>
                                    <td class="text-end"><strong style="color: #dc3545;">â‚©${totalCost.toLocaleString()}</strong></td>
                                    <td>ë§¤ì…ì²˜ì— ì§€ê¸‰í•œ ì´ ê¸ˆì•¡</td>
                                </tr>
                                <tr style="background-color: #fff;">
                                    <td><strong>â‘¢ ì´ ìˆ˜ìµ (â‘  - â‘¡)</strong></td>
                                    <td class="text-end"><strong style="color: #007bff; font-size: 1.2em;">â‚©${profit.toLocaleString()}</strong></td>
                                    <td>ë§¤ì¶œ - ì›ê°€</td>
                                </tr>
                                <tr>
                                    <td><strong>â‘£ ë¶€ê°€ê°€ì¹˜ì„¸ (10%)</strong></td>
                                    <td class="text-end"><strong style="color: #6c757d;">â‚©${vat.toLocaleString()}</strong></td>
                                    <td>ìˆ˜ìµì˜ 10% (êµ­ì„¸ì²­ ì‹ ê³ ìš©)</td>
                                </tr>
                                <tr style="background-color: #d4edda;">
                                    <td><strong>â‘¤ ìˆœìˆ˜ìµ (â‘¢ - â‘£)</strong></td>
                                    <td class="text-end"><strong style="color: #155724; font-size: 1.3em;">â‚©${netProfit.toLocaleString()}</strong></td>
                                    <td>ë¶€ê°€ì„¸ ì œì™¸ ì‹¤ì œ ìˆ˜ìµ</td>
                                </tr>
                            </table>
                        </div>
                        
                        <!-- ë¬¸ì„œ í•˜ë‹¨ -->
                        <div class="doc-footer">
                            <p style="margin-bottom: 10px;">ìœ„ ë‚´ìš©ì€ ì‚¬ì‹¤ê³¼ ë‹¤ë¦„ì—†ìŒì„ í™•ì¸í•©ë‹ˆë‹¤.</p>
                            <p><strong>ë°œí–‰ì¼ì:</strong> ${new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        </div>
                        
                    </div>
                `;
                
                document.getElementById('settlementDocument').innerHTML = documentHtml;
                
                const modal = new bootstrap.Modal(document.getElementById('settlementDocumentModal'));
                modal.show();
                
            } catch (error) {
                console.error('ì •ì‚°ì„œ ìƒì„± ì‹¤íŒ¨:', error);
                alert('ì •ì‚°ì„œë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ì •ì‚°ì„œ ì¸ì‡„
        function printSettlement() {
            window.print();
        }
        
        // Enter í‚¤ ê²€ìƒ‰ ì´ë²¤íŠ¸
        ['filter_search', 'filter_vendor'].forEach(id => {
            document.getElementById(id)?.addEventListener('keydown', e => {
                if (e.key === 'Enter') filterAndRender();
            });
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('load', () => {
            loadSettlements();
        });
    </script>
</body>
</html>
