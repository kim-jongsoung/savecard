<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒ¨í‚¤ì§€ ì •ì‚°ê´€ë¦¬ - ê´Œì„¸ì´ë¸Œì¹´ë“œ ê´€ë¦¬ì</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .editable-cell {
            cursor: pointer;
            border: 1px solid transparent;
            padding: 4px 8px;
            border-radius: 3px;
        }
        .editable-cell:hover {
            background-color: #f0f8ff;
            border-color: #007bff;
        }
        .editable-cell.editing {
            background-color: #fff3cd;
            border-color: #ffc107;
        }
        .cost-input {
            width: 120px;
            text-align: right;
        }
        .vendor-row {
            background-color: #f8f9fa;
        }
        .vendor-row:hover {
            background-color: #e9ecef;
        }
        .sent-row {
            background-color: #d4edda;
        }
        .pending-row {
            background-color: #fff3cd;
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar', { currentPage: 'package-settlements', adminUsername: adminName || 'ê´€ë¦¬ì' }) %>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-calculator me-2"></i>íŒ¨í‚¤ì§€ ì •ì‚°ê´€ë¦¬</h2>
                    <a href="/admin/package-reservations" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-1"></i>ì˜ˆì•½ê´€ë¦¬ë¡œ ëŒì•„ê°€ê¸°
                    </a>
                </div>
            </div>
        </div>

        <!-- ê²€ìƒ‰ í•„í„° -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label">ì¶œë°œì¼ (ì‹œì‘)</label>
                        <input type="date" class="form-control" id="filter_start_date">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ì¶œë°œì¼ (ì¢…ë£Œ)</label>
                        <input type="date" class="form-control" id="filter_end_date">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ì˜ˆì•½ì±„ë„</label>
                        <select class="form-select" id="filter_platform">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ì†¡ê¸ˆìƒíƒœ</label>
                        <select class="form-select" id="filter_status">
                            <option value="all">ì „ì²´</option>
                            <option value="pending">ë¯¸ì†¡ê¸ˆ</option>
                            <option value="partial">ë¶€ë¶„ì†¡ê¸ˆ</option>
                            <option value="completed">ì†¡ê¸ˆì™„ë£Œ</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ê²€ìƒ‰</label>
                        <input type="text" class="form-control" id="filter_search" placeholder="ì˜ˆì•½ë²ˆí˜¸, ê³ ê°ëª…">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="loadSettlements()">
                            <i class="fas fa-search me-1"></i>ê²€ìƒ‰
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì¼ê´„ ì²˜ë¦¬ ë²„íŠ¼ -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="me-3">ì„ íƒ: <strong id="selected_count">0</strong>ê±´</span>
                        <span class="me-3">ì´ ë§¤ì…ì•¡: <strong id="selected_total">â‚©0</strong></span>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="bulkSendPayment()">
                            <i class="fas fa-paper-plane me-1"></i>ì„ íƒ í•­ëª© ì¼ê´„ ì†¡ê¸ˆì™„ë£Œ
                        </button>
                        <button class="btn btn-outline-secondary ms-2" onclick="clearSelection()">
                            <i class="fas fa-times me-1"></i>ì„ íƒ í•´ì œ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì •ì‚° ëª©ë¡ í…Œì´ë¸” -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="select_all" onchange="toggleSelectAll(this.checked)">
                                </th>
                                <th>ì¶œë°œì¼</th>
                                <th>ì±„ë„</th>
                                <th>ì˜ˆì•½ë²ˆí˜¸</th>
                                <th>ê³ ê°ëª…</th>
                                <th>ë§¤ì…ì²˜</th>
                                <th>êµ¬ì„±ìš”ì†Œ</th>
                                <th>ë§¤ì…ì•¡</th>
                                <th>ì†¡ê¸ˆì¼</th>
                                <th>ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody id="settlements_tbody">
                            <tr>
                                <td colspan="10" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allSettlements = [];
        let selectedItems = new Set();

        // ì •ì‚° ëª©ë¡ ë¡œë“œ
        async function loadSettlements() {
            try {
                const response = await fetch('/api/package-settlements/list');
                const result = await response.json();
                
                if (!result.success) {
                    alert('ì •ì‚° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const { pending, completed } = result.data;
                
                // ëª¨ë“  ì˜ˆì•½ì„ í‰íƒ„í™”í•˜ì—¬ ë§¤ì…ì²˜ë³„ë¡œ í–‰ ìƒì„±
                allSettlements = [];
                [...pending, ...completed].forEach(reservation => {
                    const components = reservation.cost_components || [];
                    components.forEach((component, index) => {
                        allSettlements.push({
                            reservation_id: reservation._id,
                            component_index: index,
                            departure_date: reservation.travel_period.departure_date,
                            platform_name: reservation.platform_name,
                            reservation_number: reservation.reservation_number,
                            customer_name: reservation.customer.korean_name,
                            vendor_name: component.vendor_name,
                            component_type: component.component_type,
                            cost_krw: component.cost_krw || 0,
                            payment_sent_date: component.payment_sent_date,
                            is_sent: !!component.payment_sent_date
                        });
                    });
                });
                
                // ì±„ë„ í•„í„° ì˜µì…˜ ì—…ë°ì´íŠ¸
                updatePlatformFilter();
                
                // í•„í„° ì ìš© ë° ë Œë”ë§
                filterAndRender();
                
            } catch (error) {
                console.error('ì •ì‚° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ì •ì‚° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì±„ë„ í•„í„° ì˜µì…˜ ì—…ë°ì´íŠ¸
        function updatePlatformFilter() {
            const platforms = [...new Set(allSettlements.map(s => s.platform_name))];
            const select = document.getElementById('filter_platform');
            select.innerHTML = '<option value="">ì „ì²´</option>' + 
                platforms.map(p => `<option value="${p}">${p}</option>`).join('');
        }

        // í•„í„°ë§ ë° ë Œë”ë§
        function filterAndRender() {
            const startDate = document.getElementById('filter_start_date').value;
            const endDate = document.getElementById('filter_end_date').value;
            const platform = document.getElementById('filter_platform').value;
            const status = document.getElementById('filter_status').value;
            const search = document.getElementById('filter_search').value.toLowerCase();

            let filtered = allSettlements.filter(item => {
                // ë‚ ì§œ í•„í„°
                if (startDate && new Date(item.departure_date) < new Date(startDate)) return false;
                if (endDate && new Date(item.departure_date) > new Date(endDate)) return false;
                
                // ì±„ë„ í•„í„°
                if (platform && item.platform_name !== platform) return false;
                
                // ìƒíƒœ í•„í„°
                if (status === 'pending' && item.is_sent) return false;
                if (status === 'completed' && !item.is_sent) return false;
                
                // ê²€ìƒ‰
                if (search && !item.reservation_number.toLowerCase().includes(search) && 
                    !item.customer_name.toLowerCase().includes(search)) return false;
                
                return true;
            });

            renderSettlements(filtered);
        }

        // ì •ì‚° ëª©ë¡ ë Œë”ë§
        function renderSettlements(items) {
            const tbody = document.getElementById('settlements_tbody');
            
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-5">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            tbody.innerHTML = items.map((item, idx) => {
                const itemKey = `${item.reservation_id}_${item.component_index}`;
                const isSelected = selectedItems.has(itemKey);
                const isSent = item.is_sent;
                const rowClass = isSent ? 'sent-row' : 'pending-row';
                
                const typeIcon = item.component_type === 'flight' ? 'âœˆï¸' : 
                               item.component_type === 'hotel' ? 'ğŸ¨' : 
                               item.component_type === 'tour' ? 'ğŸ¯' : 
                               item.component_type === 'ground' ? 'ğŸš—' : 'ğŸ“¦';
                const typeName = item.component_type === 'flight' ? 'í•­ê³µê¶Œ' : 
                               item.component_type === 'hotel' ? 'í˜¸í…”' : 
                               item.component_type === 'tour' ? 'íˆ¬ì–´' : 
                               item.component_type === 'ground' ? 'ì§€ìƒ' : 'ê¸°íƒ€';

                return `
                    <tr class="${rowClass} vendor-row">
                        <td class="text-center">
                            <input type="checkbox" 
                                   data-item-key="${itemKey}"
                                   ${isSent ? 'disabled' : ''}
                                   ${isSelected ? 'checked' : ''}
                                   onchange="toggleItemSelection('${itemKey}')">
                        </td>
                        <td>${new Date(item.departure_date).toLocaleDateString('ko-KR')}</td>
                        <td>${item.platform_name}</td>
                        <td>${item.reservation_number}</td>
                        <td>${item.customer_name}</td>
                        <td><strong>${item.vendor_name}</strong></td>
                        <td>${typeIcon} ${typeName}</td>
                        <td>
                            <div class="editable-cell" 
                                 onclick="editCost('${itemKey}', ${item.cost_krw})"
                                 id="cost_${itemKey}">
                                â‚©${item.cost_krw.toLocaleString()}
                            </div>
                        </td>
                        <td>
                            <input type="date" 
                                   class="form-control form-control-sm" 
                                   value="${item.payment_sent_date ? new Date(item.payment_sent_date).toISOString().split('T')[0] : ''}"
                                   onchange="updateSentDate('${itemKey}', this.value)"
                                   ${isSent ? 'readonly' : ''}>
                        </td>
                        <td>
                            ${isSent 
                                ? '<span class="badge bg-success">ì†¡ê¸ˆì™„ë£Œ</span>' 
                                : '<span class="badge bg-warning">ë¯¸ì†¡ê¸ˆ</span>'}
                        </td>
                    </tr>
                `;
            }).join('');

            updateSelectionInfo();
        }

        // ë§¤ì…ì•¡ ì¸ë¼ì¸ í¸ì§‘
        function editCost(itemKey, currentCost) {
            const cell = document.getElementById(`cost_${itemKey}`);
            const item = allSettlements.find(s => `${s.reservation_id}_${s.component_index}` === itemKey);
            
            if (item.is_sent) {
                alert('ì†¡ê¸ˆ ì™„ë£Œëœ í•­ëª©ì€ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            cell.classList.add('editing');
            cell.innerHTML = `
                <input type="number" 
                       class="form-control form-control-sm cost-input" 
                       value="${currentCost}" 
                       id="input_${itemKey}"
                       onblur="saveCost('${itemKey}')"
                       onkeypress="if(event.key==='Enter') saveCost('${itemKey}')">
            `;
            document.getElementById(`input_${itemKey}`).focus();
        }

        // ë§¤ì…ì•¡ ì €ì¥
        async function saveCost(itemKey) {
            const input = document.getElementById(`input_${itemKey}`);
            const newCost = parseInt(input.value) || 0;
            const [reservationId, componentIndex] = itemKey.split('_');

            try {
                const response = await fetch(`/api/package-reservations/${reservationId}`);
                const result = await response.json();
                
                if (!result.success) {
                    alert('ì˜ˆì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }

                const reservation = result.data;
                reservation.cost_components[parseInt(componentIndex)].cost_krw = newCost;

                // ì´ ë§¤ì…ì•¡ ì¬ê³„ì‚°
                const totalCost = reservation.cost_components.reduce((sum, c) => sum + (c.cost_krw || 0), 0);
                reservation.settlement.total_cost_krw = totalCost;

                const updateResponse = await fetch(`/api/package-reservations/${reservationId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cost_components: reservation.cost_components,
                        settlement: reservation.settlement
                    })
                });

                const updateResult = await updateResponse.json();
                
                if (updateResult.success) {
                    // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
                    const item = allSettlements.find(s => `${s.reservation_id}_${s.component_index}` === itemKey);
                    item.cost_krw = newCost;
                    
                    // ì…€ ì—…ë°ì´íŠ¸
                    const cell = document.getElementById(`cost_${itemKey}`);
                    cell.classList.remove('editing');
                    cell.innerHTML = `â‚©${newCost.toLocaleString()}`;
                    
                    alert('ë§¤ì…ì•¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ë§¤ì…ì•¡ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    loadSettlements(); // ì‹¤íŒ¨ ì‹œ ìƒˆë¡œê³ ì¹¨
                }
            } catch (error) {
                console.error('ë§¤ì…ì•¡ ìˆ˜ì • ì‹¤íŒ¨:', error);
                alert('ë§¤ì…ì•¡ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                loadSettlements();
            }
        }

        // ì†¡ê¸ˆì¼ ì—…ë°ì´íŠ¸
        async function updateSentDate(itemKey, date) {
            const [reservationId, componentIndex] = itemKey.split('_');

            try {
                const response = await fetch(`/api/package-reservations/${reservationId}`);
                const result = await response.json();
                
                if (!result.success) {
                    alert('ì˜ˆì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }

                const reservation = result.data;
                reservation.cost_components[parseInt(componentIndex)].payment_sent_date = date || null;

                const updateResponse = await fetch(`/api/package-reservations/${reservationId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cost_components: reservation.cost_components })
                });

                const updateResult = await updateResponse.json();
                
                if (updateResult.success) {
                    loadSettlements(); // ìƒˆë¡œê³ ì¹¨
                } else {
                    alert('ì†¡ê¸ˆì¼ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì†¡ê¸ˆì¼ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                alert('ì†¡ê¸ˆì¼ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í•­ëª© ì„ íƒ/í•´ì œ
        function toggleItemSelection(itemKey) {
            if (selectedItems.has(itemKey)) {
                selectedItems.delete(itemKey);
            } else {
                selectedItems.add(itemKey);
            }
            updateSelectionInfo();
        }

        // ì „ì²´ ì„ íƒ/í•´ì œ
        function toggleSelectAll(checked) {
            selectedItems.clear();
            if (checked) {
                document.querySelectorAll('input[data-item-key]:not([disabled])').forEach(checkbox => {
                    selectedItems.add(checkbox.dataset.itemKey);
                    checkbox.checked = true;
                });
            } else {
                document.querySelectorAll('input[data-item-key]').forEach(checkbox => {
                    checkbox.checked = false;
                });
            }
            updateSelectionInfo();
        }

        // ì„ íƒ í•´ì œ
        function clearSelection() {
            selectedItems.clear();
            document.querySelectorAll('input[data-item-key]').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.getElementById('select_all').checked = false;
            updateSelectionInfo();
        }

        // ì„ íƒ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateSelectionInfo() {
            const count = selectedItems.size;
            let total = 0;
            
            selectedItems.forEach(itemKey => {
                const item = allSettlements.find(s => `${s.reservation_id}_${s.component_index}` === itemKey);
                if (item) total += item.cost_krw;
            });

            document.getElementById('selected_count').textContent = count;
            document.getElementById('selected_total').textContent = `â‚©${total.toLocaleString()}`;
        }

        // ì¼ê´„ ì†¡ê¸ˆ ì²˜ë¦¬
        async function bulkSendPayment() {
            if (selectedItems.size === 0) {
                alert('ì†¡ê¸ˆ ì²˜ë¦¬í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            const sentDate = prompt('ì†¡ê¸ˆì¼ì„ ì…ë ¥í•˜ì„¸ìš” (YYYY-MM-DD):', today);
            
            if (!sentDate) return;
            
            if (!confirm(`ì„ íƒí•œ ${selectedItems.size}ê°œ í•­ëª©ì„ ì†¡ê¸ˆ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                // ì˜ˆì•½ë³„ë¡œ ê·¸ë£¹í™”
                const reservationGroups = {};
                selectedItems.forEach(itemKey => {
                    const [reservationId, componentIndex] = itemKey.split('_');
                    if (!reservationGroups[reservationId]) {
                        reservationGroups[reservationId] = [];
                    }
                    reservationGroups[reservationId].push(parseInt(componentIndex));
                });

                // ê° ì˜ˆì•½ë³„ë¡œ ì—…ë°ì´íŠ¸
                for (const [reservationId, indices] of Object.entries(reservationGroups)) {
                    const response = await fetch(`/api/package-reservations/${reservationId}`);
                    const result = await response.json();
                    
                    if (!result.success) continue;

                    const reservation = result.data;
                    indices.forEach(index => {
                        reservation.cost_components[index].payment_sent_date = sentDate;
                    });

                    await fetch(`/api/package-reservations/${reservationId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ cost_components: reservation.cost_components })
                    });
                }

                alert('ì¼ê´„ ì†¡ê¸ˆ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                clearSelection();
                loadSettlements();

            } catch (error) {
                console.error('ì¼ê´„ ì†¡ê¸ˆ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                alert('ì¼ê´„ ì†¡ê¸ˆ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('load', () => {
            loadSettlements();
        });
    </script>
</body>
</html>
