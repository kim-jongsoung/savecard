<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒ¨í‚¤ì§€ ì •ì‚°ê´€ë¦¬ - ê´Œì„¸ì´ë¸Œì¹´ë“œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8f9fa;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .nav-tabs .nav-link {
            color: #495057;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            color: #667eea;
            font-weight: 600;
        }
        .settlement-card {
            transition: all 0.3s;
            cursor: pointer;
            border-left: 4px solid #667eea;
        }
        .settlement-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .badge-pending {
            background-color: #ffc107;
            color: #000;
        }
        .badge-completed {
            background-color: #28a745;
            color: #fff;
        }
        .component-item {
            border-left: 3px solid #17a2b8;
            padding-left: 10px;
            margin-bottom: 8px;
        }
        .stats-card {
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin/dashboard">
                <i class="fas fa-calculator me-2"></i>íŒ¨í‚¤ì§€ ì •ì‚°ê´€ë¦¬
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/package-reservations">
                            <i class="fas fa-arrow-left me-1"></i>ì˜ˆì•½ê´€ë¦¬
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/dashboard">
                            <i class="fas fa-home me-1"></i>ëŒ€ì‹œë³´ë“œ
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- í†µê³„ ì˜ì—­ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card bg-warning text-dark">
                    <h6><i class="fas fa-clock me-2"></i>ë§¤ì…ì „</h6>
                    <h3 id="stat_pending_count">0</h3>
                    <small>ì…ê¸ˆì™„ë£Œ, ì†¡ê¸ˆëŒ€ê¸°</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card bg-success text-white">
                    <h6><i class="fas fa-check-circle me-2"></i>ì •ì‚°ì™„ë£Œ</h6>
                    <h3 id="stat_completed_count">0</h3>
                    <small>ì†¡ê¸ˆì™„ë£Œ</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card bg-info text-white">
                    <h6><i class="fas fa-money-bill-wave me-2"></i>ë¯¸ì†¡ê¸ˆ ì´ì•¡</h6>
                    <h3 id="stat_pending_amount">â‚©0</h3>
                    <small>ì†¡ê¸ˆí•´ì•¼ í•  ê¸ˆì•¡</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card bg-primary text-white">
                    <h6><i class="fas fa-paper-plane me-2"></i>ì†¡ê¸ˆì™„ë£Œ ì´ì•¡</h6>
                    <h3 id="stat_completed_amount">â‚©0</h3>
                    <small>ì´ë²ˆ ë‹¬ ì†¡ê¸ˆì•¡</small>
                </div>
            </div>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <ul class="nav nav-tabs mb-3" id="settlementTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button">
                    <i class="fas fa-clock me-2"></i>ë§¤ì…ì „ (<span id="pending_count">0</span>)
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed" type="button">
                    <i class="fas fa-check-circle me-2"></i>ë§¤ì…ì™„ë£Œ (ì •ì‚°ì™„ë£Œ) (<span id="completed_count">0</span>)
                </button>
            </li>
        </ul>

        <!-- íƒ­ ì»¨í…ì¸  -->
        <div class="tab-content" id="settlementTabContent">
            <!-- ë§¤ì…ì „ íƒ­ -->
            <div class="tab-pane fade show active" id="pending" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div id="pending_list">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë§¤ì…ì™„ë£Œ íƒ­ -->
            <div class="tab-pane fade" id="completed" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div id="completed_list">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì •ì‚° ìƒì„¸ ëª¨ë‹¬ -->
    <div class="modal fade" id="settlementDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-file-invoice me-2"></i>ì •ì‚° ìƒì„¸ ë° ì†¡ê¸ˆ ê´€ë¦¬</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <input type="hidden" id="detail_reservation_id">
                    
                    <!-- ê¸°ë³¸ ì˜ˆì•½ ì •ë³´ -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>ê¸°ë³¸ ì˜ˆì•½ ì •ë³´</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>ì¶œë°œì¼:</strong> <span id="detail_departure_date"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>ì˜ˆì•½ì±„ë„:</strong> <span id="detail_platform_name"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>ì˜ˆì•½ë²ˆí˜¸:</strong> <span id="detail_reservation_number"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>ê³ ê°ëª…:</strong> <span id="detail_customer_name"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì…ê¸ˆ ë‚´ì—­ (ì½ê¸° ì „ìš©) -->
                    <div class="card mb-3">
                        <div class="card-header" style="background-color: #d1ecf1;">
                            <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>ì…ê¸ˆ ì™„ë£Œ ë‚´ì—­</h6>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-success mb-3">
                                <strong>ì´ ì…ê¸ˆ ì™„ë£Œ ê¸ˆì•¡:</strong> <span id="detail_total_received" style="font-size: 1.2rem; font-weight: bold;"></span>
                            </div>
                            <div id="detail_billings_list"></div>
                        </div>
                    </div>

                    <!-- ë§¤ì… ì†¡ê¸ˆ ê´€ë¦¬ -->
                    <div class="card mb-3">
                        <div class="card-header" style="background-color: #fff3cd;">
                            <h6 class="mb-0"><i class="fas fa-paper-plane me-2"></i>ë§¤ì… ì†¡ê¸ˆ ê´€ë¦¬</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <strong>ì´ ë§¤ì…ì•¡:</strong> <span id="detail_total_cost" style="font-size: 1.2rem; font-weight: bold;"></span>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-primary" onclick="bulkCompletePayment()">
                                        <i class="fas fa-check-double me-1"></i>ì„ íƒ í•­ëª© ì¼ê´„ ì†¡ê¸ˆì™„ë£Œ
                                    </button>
                                </div>
                            </div>
                            
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 40px;">
                                            <input type="checkbox" id="select_all_items" onchange="toggleAllItems(this.checked)">
                                        </th>
                                        <th>êµ¬ì„±ìš”ì†Œ</th>
                                        <th>ì—…ì²´ëª…</th>
                                        <th>ì†¡ê¸ˆê¸ˆì•¡</th>
                                        <th>ì†¡ê¸ˆì¼</th>
                                        <th>ìƒíƒœ</th>
                                        <th>ê´€ë¦¬</th>
                                    </tr>
                                </thead>
                                <tbody id="detail_components_list">
                                    <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
                                </tbody>
                            </table>
                            
                            <div class="mt-2">
                                <strong>ì†¡ê¸ˆ ì™„ë£Œ ê¸ˆì•¡:</strong> <span id="detail_sent_amount" class="text-success"></span> / 
                                <strong>ë¯¸ì†¡ê¸ˆ ê¸ˆì•¡:</strong> <span id="detail_pending_cost" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>ë‹«ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ì •ì‚° ëª©ë¡ ë¡œë“œ
        async function loadSettlements() {
            try {
                const response = await fetch('/api/package-settlements/api/list');
                const result = await response.json();
                
                if (!result.success) {
                    alert('ì •ì‚° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const { pending, completed, stats } = result.data;
                
                // í†µê³„ ì—…ë°ì´íŠ¸
                document.getElementById('stat_pending_count').textContent = stats.pending_count;
                document.getElementById('stat_completed_count').textContent = stats.completed_count;
                document.getElementById('stat_pending_amount').textContent = `â‚©${stats.pending_amount.toLocaleString()}`;
                document.getElementById('stat_completed_amount').textContent = `â‚©${stats.completed_amount.toLocaleString()}`;
                
                document.getElementById('pending_count').textContent = pending.length;
                document.getElementById('completed_count').textContent = completed.length;
                
                // ëª©ë¡ ë Œë”ë§
                renderPendingList(pending);
                renderCompletedList(completed);
                
            } catch (error) {
                console.error('ì •ì‚° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ì •ì‚° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ë§¤ì…ì „ ëª©ë¡ ë Œë”ë§
        function renderPendingList(items) {
            const container = document.getElementById('pending_list');
            
            if (items.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-5">ë§¤ì…ì „ ì •ì‚° ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            container.innerHTML = items.map(item => `
                <div class="settlement-card card mb-3" onclick="openSettlementDetail('${item._id}')">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <strong>${new Date(item.travel_period.departure_date).toLocaleDateString('ko-KR')}</strong>
                                <br><small class="text-muted">${item.platform_name}</small>
                            </div>
                            <div class="col-md-2">
                                <strong>${item.reservation_number}</strong>
                                <br><small class="text-muted">${item.customer.korean_name}</small>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">ì…ê¸ˆì™„ë£Œ</small>
                                <br><strong class="text-success">â‚©${(item.pricing.total_selling_price || 0).toLocaleString()}</strong>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">ë§¤ì…ì•¡ (ë¯¸ì†¡ê¸ˆ)</small>
                                <br><strong class="text-danger">â‚©${(item.settlement.total_cost_krw || 0).toLocaleString()}</strong>
                            </div>
                            <div class="col-md-2 text-end">
                                <span class="badge badge-pending">
                                    <i class="fas fa-clock me-1"></i>ì†¡ê¸ˆëŒ€ê¸°
                                </span>
                                <br><small class="text-muted mt-1">${item.cost_components.length}ê°œ êµ¬ì„±ìš”ì†Œ</small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // ë§¤ì…ì™„ë£Œ ëª©ë¡ ë Œë”ë§
        function renderCompletedList(items) {
            const container = document.getElementById('completed_list');
            
            if (items.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-5">ì •ì‚°ì™„ë£Œ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            container.innerHTML = items.map(item => {
                const allSent = item.cost_components.every(c => c.payment_sent_date);
                return `
                    <div class="settlement-card card mb-3" onclick="openSettlementDetail('${item._id}')">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-2">
                                    <strong>${new Date(item.travel_period.departure_date).toLocaleDateString('ko-KR')}</strong>
                                    <br><small class="text-muted">${item.platform_name}</small>
                                </div>
                                <div class="col-md-2">
                                    <strong>${item.reservation_number}</strong>
                                    <br><small class="text-muted">${item.customer.korean_name}</small>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">ì…ê¸ˆì™„ë£Œ</small>
                                    <br><strong class="text-success">â‚©${(item.pricing.total_selling_price || 0).toLocaleString()}</strong>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">ë§¤ì…ì•¡ (ì†¡ê¸ˆì™„ë£Œ)</small>
                                    <br><strong class="text-success">â‚©${(item.settlement.total_cost_krw || 0).toLocaleString()}</strong>
                                </div>
                                <div class="col-md-2 text-end">
                                    <span class="badge badge-completed">
                                        <i class="fas fa-check-circle me-1"></i>ì •ì‚°ì™„ë£Œ
                                    </span>
                                    <br><small class="text-muted mt-1">${item.cost_components.length}ê°œ êµ¬ì„±ìš”ì†Œ</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ì •ì‚° ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
        async function openSettlementDetail(id) {
            try {
                const response = await fetch(`/api/package-reservations/${id}`);
                const result = await response.json();
                
                if (!result.success) {
                    alert('ì •ì‚° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const r = result.data;
                
                // ê¸°ë³¸ ì •ë³´
                document.getElementById('detail_reservation_id').value = r._id;
                document.getElementById('detail_departure_date').textContent = new Date(r.travel_period.departure_date).toLocaleDateString('ko-KR');
                document.getElementById('detail_platform_name').textContent = r.platform_name;
                document.getElementById('detail_reservation_number').textContent = r.reservation_number;
                document.getElementById('detail_customer_name').textContent = r.customer.korean_name;
                
                // ì…ê¸ˆ ë‚´ì—­
                const totalReceived = (r.billings || [])
                    .filter(b => b.status === 'completed')
                    .reduce((sum, b) => sum + (b.amount || 0), 0);
                document.getElementById('detail_total_received').textContent = `â‚©${totalReceived.toLocaleString()}`;
                
                const billingsHtml = (r.billings || [])
                    .filter(b => b.status === 'completed')
                    .map(b => {
                        const typeIcon = b.type === 'cash' ? 'ğŸ’µ' : b.type === 'card' ? 'ğŸ’³' : 'ğŸ';
                        const typeName = b.type === 'cash' ? 'í˜„ê¸ˆ' : b.type === 'card' ? 'ì¹´ë“œ' : 'í• ì¸';
                        return `
                            <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
                                <span>${typeIcon} ${typeName}</span>
                                <span><strong>â‚©${(b.amount || 0).toLocaleString()}</strong></span>
                                <span class="text-muted">${b.date ? new Date(b.date).toLocaleDateString('ko-KR') : '-'}</span>
                            </div>
                        `;
                    }).join('');
                document.getElementById('detail_billings_list').innerHTML = billingsHtml || '<p class="text-muted">ì…ê¸ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                
                // ë§¤ì… êµ¬ì„±ìš”ì†Œ
                document.getElementById('detail_total_cost').textContent = `â‚©${(r.settlement.total_cost_krw || 0).toLocaleString()}`;
                renderComponentsList(r.cost_components || []);
                
                // ëª¨ë‹¬ í‘œì‹œ
                const modal = new bootstrap.Modal(document.getElementById('settlementDetailModal'));
                modal.show();
                
            } catch (error) {
                console.error('ì •ì‚° ìƒì„¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ì •ì‚° ìƒì„¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ë§¤ì… êµ¬ì„±ìš”ì†Œ ë Œë”ë§
        function renderComponentsList(components) {
            const container = document.getElementById('detail_components_list');
            
            let sentAmount = 0;
            let pendingCost = 0;
            
            if (components.length === 0) {
                container.innerHTML = '<tr><td colspan="7" class="text-center text-muted">ë§¤ì… êµ¬ì„±ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            container.innerHTML = components.map((comp, index) => {
                const typeIcon = comp.component_type === 'flight' ? 'âœˆï¸' : 
                               comp.component_type === 'hotel' ? 'ğŸ¨' : 
                               comp.component_type === 'tour' ? 'ğŸ¯' : 
                               comp.component_type === 'ground' ? 'ğŸš—' : 'ğŸ“¦';
                const typeName = comp.component_type === 'flight' ? 'í•­ê³µê¶Œ' : 
                               comp.component_type === 'hotel' ? 'í˜¸í…”' : 
                               comp.component_type === 'tour' ? 'íˆ¬ì–´' : 
                               comp.component_type === 'ground' ? 'ì§€ìƒ' : 'ê¸°íƒ€';
                const hasSent = comp.payment_sent_date ? true : false;
                const statusBadge = hasSent 
                    ? '<span class="badge bg-success">ì†¡ê¸ˆì™„ë£Œ</span>' 
                    : '<span class="badge bg-warning">ë¯¸ì†¡ê¸ˆ</span>';
                
                if (hasSent) {
                    sentAmount += comp.cost_krw || 0;
                } else {
                    pendingCost += comp.cost_krw || 0;
                }
                
                return `
                    <tr>
                        <td class="text-center">
                            <input type="checkbox" class="item-checkbox" data-index="${index}" ${hasSent ? 'disabled' : ''}>
                        </td>
                        <td>${typeIcon} ${typeName}</td>
                        <td>${comp.vendor_name}</td>
                        <td class="text-end">â‚©${(comp.cost_krw || 0).toLocaleString()}</td>
                        <td>
                            <input type="date" class="form-control form-control-sm" 
                                   value="${comp.payment_sent_date ? new Date(comp.payment_sent_date).toISOString().split('T')[0] : ''}" 
                                   onchange="updateSentDate(${index}, this.value)" 
                                   ${hasSent ? 'readonly' : ''}>
                        </td>
                        <td>${statusBadge}</td>
                        <td>
                            ${!hasSent 
                                ? `<button class="btn btn-sm btn-primary" onclick="completePayment(${index})">
                                    <i class="fas fa-paper-plane"></i> ì†¡ê¸ˆì™„ë£Œ
                                   </button>` 
                                : `<button class="btn btn-sm btn-secondary" onclick="revertPayment(${index})">
                                    <i class="fas fa-undo"></i> ì·¨ì†Œ
                                   </button>`}
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('detail_sent_amount').textContent = `â‚©${sentAmount.toLocaleString()}`;
            document.getElementById('detail_pending_cost').textContent = `â‚©${pendingCost.toLocaleString()}`;
        }
        
        // ì†¡ê¸ˆì¼ ì—…ë°ì´íŠ¸
        function updateSentDate(index, date) {
            console.log(`ì†¡ê¸ˆì¼ ì—…ë°ì´íŠ¸: ${index}, ${date}`);
        }
        
        // ê°œë³„ ì†¡ê¸ˆ ì™„ë£Œ
        async function completePayment(index) {
            const dateInput = document.querySelector(`input[onchange="updateSentDate(${index}, this.value)"]`);
            const sentDate = dateInput.value;
            
            if (!sentDate) {
                alert('ì†¡ê¸ˆì¼ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!confirm('ì†¡ê¸ˆ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            await updateComponentPayment([index], sentDate);
        }
        
        // ì†¡ê¸ˆ ì™„ë£Œ ì·¨ì†Œ
        async function revertPayment(index) {
            if (!confirm('ì†¡ê¸ˆ ì™„ë£Œë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            await updateComponentPayment([index], null);
        }
        
        // ì „ì²´ ì„ íƒ/í•´ì œ
        function toggleAllItems(checked) {
            document.querySelectorAll('.item-checkbox:not([disabled])').forEach(checkbox => {
                checkbox.checked = checked;
            });
        }
        
        // ì¼ê´„ ì†¡ê¸ˆ ì™„ë£Œ
        async function bulkCompletePayment() {
            const checkedBoxes = document.querySelectorAll('.item-checkbox:checked');
            
            if (checkedBoxes.length === 0) {
                alert('ì†¡ê¸ˆ ì™„ë£Œ ì²˜ë¦¬í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            const sentDate = prompt('ì†¡ê¸ˆì¼ì„ ì…ë ¥í•˜ì„¸ìš” (YYYY-MM-DD):', today);
            
            if (!sentDate) return;
            
            if (!confirm(`ì„ íƒí•œ ${checkedBoxes.length}ê°œ í•­ëª©ì„ ì†¡ê¸ˆ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            const indices = Array.from(checkedBoxes).map(cb => parseInt(cb.dataset.index));
            await updateComponentPayment(indices, sentDate);
        }
        
        // ë§¤ì… êµ¬ì„±ìš”ì†Œ ì†¡ê¸ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
        async function updateComponentPayment(indices, sentDate) {
            try {
                const reservationId = document.getElementById('detail_reservation_id').value;
                const response = await fetch(`/api/package-reservations/${reservationId}`);
                const result = await response.json();
                
                if (!result.success) {
                    alert('ì˜ˆì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const reservation = result.data;
                
                indices.forEach(index => {
                    reservation.cost_components[index].payment_sent_date = sentDate;
                });
                
                const updateResponse = await fetch(`/api/package-reservations/${reservationId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cost_components: reservation.cost_components })
                });
                
                const updateResult = await updateResponse.json();
                
                if (updateResult.success) {
                    alert(sentDate ? 'ì†¡ê¸ˆ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì†¡ê¸ˆ ì™„ë£Œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                    // ëª¨ë‹¬ ë‹«ê¸°
                    const modal = bootstrap.Modal.getInstance(document.getElementById('settlementDetailModal'));
                    modal.hide();
                    
                    // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadSettlements();
                } else {
                    alert('ì†¡ê¸ˆ ìƒíƒœ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì†¡ê¸ˆ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                alert('ì†¡ê¸ˆ ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('load', () => {
            loadSettlements();
        });
    </script>
</body>
</html>
