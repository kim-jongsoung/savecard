<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì •ì‚°ê´€ë¦¬ - ê´Œì„¸ì´ë¸Œì¹´ë“œ ê´€ë¦¬ì</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* PC í™”ë©´ì—ì„œ ê°€ë¡œí­ 1200px ê³ ì • */
        @media (min-width: 1200px) {
            .container-fluid {
                max-width: 1200px;
                margin: 0 auto;
            }
        }
        
        .status-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        .status-settled { background-color: #28a745; color: #fff; }
        .status-pending { background-color: #ffc107; color: #000; }
        .status-overdue { background-color: #dc3545; color: #fff; }
        
        .settlement-card {
            border-left: 4px solid #dee2e6;
            transition: all 0.3s ease;
        }
        .settlement-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .settlement-card.settled { border-left-color: #28a745; }
        .settlement-card.pending { border-left-color: #ffc107; }
        .settlement-card.overdue { border-left-color: #dc3545; }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
        }
        
        .profit-positive { color: #28a745; font-weight: bold; }
        .profit-negative { color: #dc3545; font-weight: bold; }
        .profit-neutral { color: #6c757d; font-weight: bold; }
    </style>
</head>
<body>
    <%- include('../partials/navbar', { currentPage: 'settlements' }) %>
    
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-calculator me-2"></i>ì •ì‚°ê´€ë¦¬</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-info" onclick="openExchangeRateModal()">
                            <i class="fas fa-exchange-alt me-1"></i>í™˜ìœ¨ ê´€ë¦¬
                        </button>
                        <button class="btn btn-outline-primary" onclick="openBulkCalculateModal()">
                            <i class="fas fa-calculator me-1"></i>ëŒ€ëŸ‰ ì •ì‚° ê³„ì‚°
                        </button>
                    </div>
                </div>

                <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
                <ul class="nav nav-tabs mb-4" id="settlementTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#listPane" type="button" role="tab">
                            <i class="fas fa-list me-1"></i>ì •ì‚° ëª©ë¡
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="rag-tab" data-bs-toggle="tab" data-bs-target="#ragPane" type="button" role="tab">
                            <i class="fas fa-dollar-sign me-1"></i>ìš”ê¸ˆ RAG ë¬¸ì„œ
                        </button>
                    </li>
                </ul>

                <!-- íƒ­ ì»¨í…ì¸  -->
                <div class="tab-content" id="settlementTabContent">
                    <!-- ì •ì‚° ëª©ë¡ íƒ­ -->
                    <div class="tab-pane fade show active" id="listPane" role="tabpanel">
                        <!-- ì •ì‚° í†µê³„ -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                                <h5 class="mb-1">ì´ ê±°ë˜ì•¡</h5>
                                <h3 id="totalRevenue">$0</h3>
                                <small>ì´ë²ˆ ë‹¬</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                                <h5 class="mb-1">ì´ ë§¤ì…</h5>
                                <h3 id="totalCost">$0</h3>
                                <small>ì´ë²ˆ ë‹¬</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <i class="fas fa-chart-line fa-2x mb-2"></i>
                                <h5 class="mb-1">ì´ ë§ˆì§„</h5>
                                <h3 id="totalProfit">$0</h3>
                                <small>ì´ë²ˆ ë‹¬</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <i class="fas fa-percentage fa-2x mb-2"></i>
                                <h5 class="mb-1">ë§ˆì§„ìœ¨</h5>
                                <h3 id="profitRate">0%</h3>
                                <small>ì´ë²ˆ ë‹¬</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì •ì‚° ìƒíƒœ íƒ­ -->
                <ul class="nav nav-pills mb-3" id="settlementStatusTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="incomplete-tab" data-bs-toggle="pill" data-bs-target="#incompletePane" type="button" role="tab" onclick="loadSettlementsByStatus('incomplete')">
                            <i class="fas fa-clock me-1"></i>ë¯¸ì™„ë£Œ <span class="badge bg-warning text-dark ms-1" id="incompleteCount">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="completed-tab" data-bs-toggle="pill" data-bs-target="#completedPane" type="button" role="tab" onclick="loadSettlementsByStatus('completed')">
                            <i class="fas fa-check-circle me-1"></i>ì „ì²´ì™„ë£Œ <span class="badge bg-success ms-1" id="completedCount">0</span>
                        </button>
                    </li>
                </ul>

                <!-- í•„í„° ë° ê²€ìƒ‰ -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label small">ê¸°ê°„ ì¡°íšŒ</label>
                                <div class="input-group">
                                    <input type="date" class="form-control form-control-sm" id="startDate">
                                    <span class="input-group-text">~</span>
                                    <input type="date" class="form-control form-control-sm" id="endDate">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">ì˜ˆì•½ì—…ì²´</label>
                                <select class="form-select form-select-sm" id="platformFilter">
                                    <option value="">ì „ì²´</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">ìˆ˜ë°°ì—…ì²´</label>
                                <select class="form-select form-select-sm" id="vendorFilter">
                                    <option value="">ì „ì²´</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">ì…ê¸ˆìƒíƒœ</label>
                                <select class="form-select form-select-sm" id="paymentReceivedFilter">
                                    <option value="">ì „ì²´</option>
                                    <option value="completed">ì™„ë£Œ</option>
                                    <option value="pending">ë¯¸ì™„ë£Œ</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">ì†¡ê¸ˆìƒíƒœ</label>
                                <select class="form-select form-select-sm" id="paymentSentFilter">
                                    <option value="">ì „ì²´</option>
                                    <option value="completed">ì™„ë£Œ</option>
                                    <option value="pending">ë¯¸ì™„ë£Œ</option>
                                </select>
                            </div>
                            <div class="col-md-1">
                                <label class="form-label small">&nbsp;</label>
                                <button class="btn btn-outline-primary btn-sm w-100" onclick="searchSettlements()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-10">
                                <label class="form-label small">ì†ë‹˜ì´ë¦„/ìƒí’ˆëª… ê²€ìƒ‰</label>
                                <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="ì†ë‹˜ì´ë¦„ ë˜ëŠ” ìƒí’ˆëª… ì…ë ¥...">
                            </div>
                            <div class="col-md-1">
                                <label class="form-label small">&nbsp;</label>
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="resetFilters()">
                                    <i class="fas fa-undo"></i>
                                </button>
                            </div>
                            <div class="col-md-1">
                                <label class="form-label small">&nbsp;</label>
                                <button class="btn btn-success btn-sm w-100" onclick="exportSettlements()">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì •ì‚° ëª©ë¡ íƒ­ ì»¨í…ì¸  -->
                <div class="tab-content" id="settlementStatusContent">
                    <!-- ë¯¸ì™„ë£Œ ëª©ë¡ -->
                    <div class="tab-pane fade show active" id="incompletePane" role="tabpanel">
                        <div id="incompleteList">
                            <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
                        </div>
                    </div>
                    
                    <!-- ì „ì²´ì™„ë£Œ ëª©ë¡ -->
                    <div class="tab-pane fade" id="completedPane" role="tabpanel">
                        <div id="completedList">
                            <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
                        </div>
                    </div>
                </div>

                <!-- í˜ì´ì§• -->
                <nav aria-label="ì •ì‚° ëª©ë¡ í˜ì´ì§•">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
                    </ul>
                </nav>
                    </div>
                    <!-- ì •ì‚° ëª©ë¡ íƒ­ ë -->

                    <!-- ìš”ê¸ˆ RAG ë¬¸ì„œ ê´€ë¦¬ íƒ­ -->
                    <div class="tab-pane fade" id="ragPane" role="tabpanel">
                        <div class="row">
                            <div class="col-12">
                                <!-- ìš”ê¸ˆ ì •ë³´ ë“±ë¡ -->
                                <div class="card mb-4">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>ìš”ê¸ˆ ì •ë³´ ë“±ë¡</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-1"></i>
                                            <strong>ìš”ê¸ˆ RAG ë¬¸ì„œë€?</strong> ìƒí’ˆë³„/íŒ¨í‚¤ì§€ë³„ íŒë§¤ê°€, ì›ê°€, ìˆ˜ìˆ˜ë£Œìœ¨ì„ ë“±ë¡í•˜ì—¬ ì •ì‚°ì´ê´€ ì‹œ AIê°€ ìë™ìœ¼ë¡œ ê¸ˆì•¡ì„ íŒŒì‹±í•©ë‹ˆë‹¤.
                                        </div>
                                        <form id="priceRagForm">
                                            <!-- ê¸°ë³¸ ì •ë³´ -->
                                            <div class="row g-3 mb-3">
                                                <div class="col-md-4">
                                                    <label class="form-label"><strong>ìƒí’ˆëª…</strong> <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" id="productName" placeholder="ì˜ˆ: ëŒí•€íˆ¬ì–´" required>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label"><strong>íŒ¨í‚¤ì§€ëª…</strong></label>
                                                    <input type="text" class="form-control" id="packageName" placeholder="ì˜ˆ: ê¸°ë³¸íˆ¬ì–´, í”„ë¦¬ë¯¸ì—„íˆ¬ì–´">
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label"><strong>ìˆ˜ë°°ì—…ì²´ëª…</strong></label>
                                                    <input type="text" class="form-control" id="supplierName" placeholder="ì˜ˆ: ABC Tours">
                                                </div>
                                            </div>

                                            <hr>

                                            <!-- íŒë§¤ê°€ (ê±°ë˜ì•¡) -->
                                            <h6 class="text-primary"><i class="fas fa-arrow-down me-1"></i>íŒë§¤ê°€ (ë°›ì„ ëˆ)</h6>
                                            <div class="row g-3 mb-3">
                                                <div class="col-md-2">
                                                    <label class="form-label">í™”í</label>
                                                    <select class="form-select" id="saleCurrency">
                                                        <option value="KRW">ì›í™”(â‚©)</option>
                                                        <option value="USD">ë‹¬ëŸ¬($)</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-2">
                                                    <label class="form-label">ì„±ì¸ íŒë§¤ê°€</label>
                                                    <input type="number" class="form-control" id="saleAdultPrice" step="0.01" placeholder="0">
                                                </div>
                                                <div class="col-md-2">
                                                    <label class="form-label">ì†Œì•„ íŒë§¤ê°€</label>
                                                    <input type="number" class="form-control" id="saleChildPrice" step="0.01" placeholder="0">
                                                </div>
                                                <div class="col-md-2">
                                                    <label class="form-label">ìœ ì•„ íŒë§¤ê°€</label>
                                                    <input type="number" class="form-control" id="saleInfantPrice" step="0.01" placeholder="0">
                                                </div>
                                                <div class="col-md-2">
                                                    <label class="form-label">ìˆ˜ìˆ˜ë£Œìœ¨ (%)</label>
                                                    <input type="number" class="form-control" id="commissionRate" step="0.01" placeholder="10">
                                                </div>
                                            </div>

                                            <hr>

                                            <!-- ì›ê°€ (ë§¤ì…) -->
                                            <h6 class="text-danger"><i class="fas fa-arrow-up me-1"></i>ì›ê°€ (ì¤„ ëˆ)</h6>
                                            <div class="row g-3 mb-3">
                                                <div class="col-md-2">
                                                    <label class="form-label">í™”í</label>
                                                    <select class="form-select" id="costCurrency">
                                                        <option value="USD">ë‹¬ëŸ¬($)</option>
                                                        <option value="KRW">ì›í™”(â‚©)</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-2">
                                                    <label class="form-label">ì„±ì¸ ì›ê°€</label>
                                                    <input type="number" class="form-control" id="costAdultPrice" step="0.01" placeholder="0">
                                                </div>
                                                <div class="col-md-2">
                                                    <label class="form-label">ì†Œì•„ ì›ê°€</label>
                                                    <input type="number" class="form-control" id="costChildPrice" step="0.01" placeholder="0">
                                                </div>
                                                <div class="col-md-2">
                                                    <label class="form-label">ìœ ì•„ ì›ê°€</label>
                                                    <input type="number" class="form-control" id="costInfantPrice" step="0.01" placeholder="0">
                                                </div>
                                            </div>

                                            <div class="text-end">
                                                <button type="button" class="btn btn-outline-secondary me-2" onclick="resetPriceForm()">
                                                    <i class="fas fa-redo me-1"></i>ì´ˆê¸°í™”
                                                </button>
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-save me-1"></i>ë“±ë¡
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>

                                <!-- ë“±ë¡ëœ ìš”ê¸ˆ ì •ë³´ ëª©ë¡ -->
                                <div class="card">
                                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>ë“±ë¡ëœ ìš”ê¸ˆ ì •ë³´</h5>
                                        <div>
                                            <input type="text" class="form-control form-control-sm d-inline-block me-2" style="width: 200px;" id="priceSearchInput" placeholder="ìƒí’ˆëª… ê²€ìƒ‰...">
                                            <button class="btn btn-sm btn-outline-primary" onclick="loadPriceRagDocuments()">
                                                <i class="fas fa-sync me-1"></i>ìƒˆë¡œê³ ì¹¨
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>ìƒí’ˆëª…</th>
                                                        <th>íŒ¨í‚¤ì§€</th>
                                                        <th>ìˆ˜ë°°ì—…ì²´</th>
                                                        <th>íŒë§¤ê°€</th>
                                                        <th>ì›ê°€</th>
                                                        <th>ìˆ˜ìˆ˜ë£Œìœ¨</th>
                                                        <th>ë“±ë¡ì¼</th>
                                                        <th>ì‘ì—…</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="priceRagDocumentList">
                                                    <tr>
                                                        <td colspan="8" class="text-center text-muted">
                                                            <i class="fas fa-spinner fa-spin me-1"></i>ë¡œë”© ì¤‘...
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- RAG ë¬¸ì„œ ê´€ë¦¬ íƒ­ ë -->
                </div>
                <!-- íƒ­ ì»¨í…ì¸  ë -->
            </div>
        </div>
    </div>

    <!-- ì •ì‚° ì²˜ë¦¬ ëª¨ë‹¬ -->
    <div class="modal fade" id="settlementModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ì •ì‚° ì²˜ë¦¬</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="settlementForm">
                        <input type="hidden" id="reservationId">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">ê±°ë˜ì•¡ ê¸ˆì•¡</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="saleAmount" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ë§¤ì… ê¸ˆì•¡</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="costAmount" step="0.01" required>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">ë§ˆì§„</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="profitAmount" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ë§ˆì§„ìœ¨</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="profitRate" readonly>
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">ì •ì‚° ë©”ëª¨</label>
                            <textarea class="form-control" id="settlementNotes" rows="3" placeholder="ì •ì‚° ê´€ë ¨ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-success" onclick="processSettlement()">ì •ì‚° ì²˜ë¦¬</button>
                </div>
            </div>
        </div>
    </div>

    <!-- í™˜ìœ¨ ê´€ë¦¬ ëª¨ë‹¬ -->
    <div class="modal fade" id="exchangeRateModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-exchange-alt me-2"></i>í™˜ìœ¨ ê´€ë¦¬</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- í™˜ìœ¨ ë“±ë¡ í¼ -->
                    <div class="card mb-3">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="fas fa-plus me-1"></i>í™˜ìœ¨ ë“±ë¡</h6>
                        </div>
                        <div class="card-body">
                            <form id="exchangeRateForm" class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">í†µí™” ì½”ë“œ</label>
                                    <select class="form-select" id="currencyCode" required>
                                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                        <option value="USD">USD (ë¯¸êµ­ ë‹¬ëŸ¬)</option>
                                        <option value="JPY">JPY (ì¼ë³¸ ì—”)</option>
                                        <option value="CNY">CNY (ì¤‘êµ­ ìœ„ì•ˆ)</option>
                                        <option value="EUR">EUR (ìœ ë¡œ)</option>
                                        <option value="VND">VND (ë² íŠ¸ë‚¨ ë™)</option>
                                        <option value="THB">THB (íƒœêµ­ ë°”íŠ¸)</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ê¸°ì¤€ ë‚ ì§œ</label>
                                    <input type="date" class="form-control" id="rateDate" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">ê¸°ì¤€ ì‹œê°„</label>
                                    <input type="time" class="form-control" id="rateTime" value="16:00" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">í™˜ìœ¨ (KRW)</label>
                                    <input type="number" class="form-control" id="exchangeRate" step="0.0001" placeholder="1330.50" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-save me-1"></i>ë“±ë¡
                                    </button>
                                </div>
                            </form>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    í™˜ìœ¨ì€ KRW ê¸°ì¤€ì…ë‹ˆë‹¤. ì˜ˆ: USD 1 = 1330.50 KRW
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- í™˜ìœ¨ ëª©ë¡ -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-list me-1"></i>ìµœê·¼ í™˜ìœ¨ ì´ë ¥</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>í†µí™”</th>
                                            <th>ê¸°ì¤€ì¼ì‹œ</th>
                                            <th>í™˜ìœ¨ (KRW)</th>
                                            <th>ì¶œì²˜</th>
                                            <th>ë“±ë¡ì¼ì‹œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="exchangeRateList">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">
                                                <i class="fas fa-spinner fa-spin me-1"></i>ë¡œë”© ì¤‘...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ëŒ€ëŸ‰ ì •ì‚° ê³„ì‚° ëª¨ë‹¬ -->
    <div class="modal fade" id="bulkCalculateModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-calculator me-2"></i>ëŒ€ëŸ‰ ì •ì‚° ê³„ì‚°</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>ëŒ€ëŸ‰ ì •ì‚° ê³„ì‚° ê¸°ëŠ¥</strong><br>
                        ì—¬ëŸ¬ ì˜ˆì•½ì˜ ì •ì‚° ê¸ˆì•¡ì„ AI ê¸°ë°˜ìœ¼ë¡œ ìë™ ê³„ì‚°í•©ë‹ˆë‹¤. í™˜ìœ¨, ìˆ˜ìˆ˜ë£Œ ë“±ì´ ìë™ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤.
                    </div>

                    <!-- ì„ íƒ ì˜µì…˜ -->
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="fas fa-filter me-1"></i>ê³„ì‚° ëŒ€ìƒ ì„ íƒ</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">í”Œë«í¼ ì„ íƒ (ì„ íƒì‚¬í•­)</label>
                                    <select class="form-select" id="bulkPlatformId">
                                        <option value="">ì „ì²´ í”Œë«í¼</option>
                                        <option value="nol">NOL</option>
                                        <option value="klook">KLOOK</option>
                                        <option value="viator">VIATOR</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">ê³µê¸‰ì‚¬ ì„ íƒ (ì„ íƒì‚¬í•­)</label>
                                    <select class="form-select" id="bulkSupplierId">
                                        <option value="">ì „ì²´ ê³µê¸‰ì‚¬</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">ê¸°ì¤€ ê¸°ê°„</label>
                                    <select class="form-select" id="bulkPeriod">
                                        <option value="current_month">ì´ë²ˆ ë‹¬</option>
                                        <option value="last_month">ì§€ë‚œ ë‹¬</option>
                                        <option value="custom">ì§ì ‘ ì„ íƒ</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ëŒ€ìƒ ì˜ˆì•½ ëª©ë¡ -->
                    <div class="card">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-list-check me-1"></i>ê³„ì‚° ëŒ€ìƒ ì˜ˆì•½</h6>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="selectAllBulkReservations()">
                                    <i class="fas fa-check-square me-1"></i>ì „ì²´ ì„ íƒ
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="deselectAllBulkReservations()">
                                    <i class="fas fa-square me-1"></i>ì „ì²´ í•´ì œ
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="bulkReservationList" style="max-height: 400px; overflow-y: auto;">
                                <p class="text-center text-muted">
                                    <i class="fas fa-search me-1"></i>ì¡°ê±´ì„ ì„ íƒí•œ í›„ "ëŒ€ìƒ ì¡°íšŒ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- ê³„ì‚° ê²°ê³¼ -->
                    <div id="bulkCalculateResult" class="mt-3" style="display: none;">
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check-circle me-1"></i>ê³„ì‚° ì™„ë£Œ</h6>
                            <div id="bulkResultSummary"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    <button type="button" class="btn btn-info" onclick="loadBulkReservations()">
                        <i class="fas fa-search me-1"></i>ëŒ€ìƒ ì¡°íšŒ
                    </button>
                    <button type="button" class="btn btn-primary" onclick="executeBulkCalculate()" id="bulkCalculateBtn" disabled>
                        <i class="fas fa-calculator me-1"></i>ì •ì‚° ê³„ì‚° ì‹¤í–‰
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 1;
        let currentStatus = '';
        let currentMonth = '';
        let currentSearch = '';

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ì •ì‚°ê´€ë¦¬ í˜ì´ì§€ ë¡œë“œ ì‹œì‘');
            loadSettlementsByStatus('incomplete');
            loadStats();
            
            // ê¸ˆì•¡ ì…ë ¥ ì‹œ ìë™ ê³„ì‚° (ìš”ì†Œê°€ ì¡´ì¬í•  ë•Œë§Œ)
            const saleAmountEl = document.getElementById('saleAmount');
            const costAmountEl = document.getElementById('costAmount');
            
            if (saleAmountEl && costAmountEl) {
                saleAmountEl.addEventListener('input', calculateProfit);
                costAmountEl.addEventListener('input', calculateProfit);
            }
        });

        // ì •ì‚° í†µê³„ ë¡œë“œ
        async function loadStats() {
            try {
                console.log('ì •ì‚° í†µê³„ ë¡œë“œ ì‹œì‘');
                const response = await fetch('/api/settlements/stats');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('ì •ì‚° í†µê³„ ì‘ë‹µ:', data);
                
                if (data.success) {
                    const stats = data.data;
                    const totalRevenueEl = document.getElementById('totalRevenue');
                    const totalCostEl = document.getElementById('totalCost');
                    const totalProfitEl = document.getElementById('totalProfit');
                    const profitRateEl = document.getElementById('profitRate');
                    
                    if (totalRevenueEl) totalRevenueEl.textContent = `$${stats.totalRevenue.toLocaleString()}`;
                    if (totalCostEl) totalCostEl.textContent = `$${stats.totalCost.toLocaleString()}`;
                    if (totalProfitEl) totalProfitEl.textContent = `$${stats.totalProfit.toLocaleString()}`;
                    if (profitRateEl) profitRateEl.textContent = `${stats.profitRate.toFixed(1)}%`;
                } else {
                    console.error('í†µê³„ API ì˜¤ë¥˜:', data.message);
                    showAlert('í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.message, 'danger');
                }
            } catch (error) {
                console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
                showAlert('í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        // ì •ì‚° ëª©ë¡ ë¡œë“œ (ìƒíƒœë³„)
        let currentSettlementStatus = 'incomplete';
        
        async function loadSettlementsByStatus(status) {
            currentSettlementStatus = status;
            
            try {
                console.log('ğŸ’° ì •ì‚° ëª©ë¡ ë¡œë“œ:', status);
                
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const searchText = document.getElementById('searchInput').value;
                const platformFilter = document.getElementById('platformFilter').value;
                const vendorFilter = document.getElementById('vendorFilter').value;
                const paymentReceivedFilter = document.getElementById('paymentReceivedFilter').value;
                const paymentSentFilter = document.getElementById('paymentSentFilter').value;
                
                const params = new URLSearchParams({
                    status: status,
                    start_date: startDate || '',
                    end_date: endDate || '',
                    search: searchText || '',
                    platform: platformFilter || '',
                    vendor: vendorFilter || '',
                    payment_received: paymentReceivedFilter || '',
                    payment_sent: paymentSentFilter || ''
                });
                
                const response = await fetch(`/api/settlements/list?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    renderSettlementsList(data.data || [], status);
                    updateCounts(data.counts || {});
                } else {
                    showAlert(data.message || 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', 'danger');
                }
            } catch (error) {
                console.error('âŒ ì •ì‚° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                showAlert('ì •ì‚° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }
        
        // ì •ì‚° ëª©ë¡ ë Œë”ë§
        function renderSettlementsList(settlements, status) {
            const containerId = status === 'incomplete' ? 'incompleteList' : 'completedList';
            const container = document.getElementById(containerId);
            
            if (!settlements || settlements.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">${status === 'incomplete' ? 'ë¯¸ì™„ë£Œ ì •ì‚°ì´ ì—†ìŠµë‹ˆë‹¤' : 'ì™„ë£Œëœ ì •ì‚°ì´ ì—†ìŠµë‹ˆë‹¤'}</h5>
                    </div>
                `;
                return;
            }
            
            // ì´ì•¡ ê³„ì‚°
            let totalRevenue = 0;
            let totalCost = 0;
            let totalMargin = 0;
            let totalTax = 0;
            
            const rows = settlements.map(s => {
                const isPaymentReceived = !!s.payment_received_date;
                const isPaymentSent = !!s.payment_sent_date;
                
                // ê±°ë˜ì•¡ (KRW í™˜ì‚°)
                const revenueKRW = s.sale_currency === 'KRW' ? (s.net_revenue || 0) : (s.net_revenue || 0) * (s.exchange_rate || 1330);
                // ë§¤ì…ì•¡ (KRW í™˜ì‚°)
                const costKRW = s.cost_krw || 0;
                // ë§ˆì§„
                const marginKRW = s.margin_krw || 0;
                // ë¶€ê°€ì„¸ = ë§ˆì§„*10% - ì˜ˆì•½ì—…ì²´ìˆ˜ìˆ˜ë£Œ*10%
                const saleTax = marginKRW * 0.1;
                const commissionTax = (s.commission_amount || 0) * 0.1;
                const tax = saleTax - commissionTax;
                
                totalRevenue += revenueKRW;
                totalCost += costKRW;
                totalMargin += marginKRW;
                totalTax += tax;
                
                return `
                    <tr>
                        <td><small>${s.usage_date || '-'}</small></td>
                        <td><strong>${s.korean_name || '-'}</strong></td>
                        <td><small>${s.product_name || '-'}</small></td>
                        <td><small>${s.platform_name || '-'}</small></td>
                        <td><small>${s.vendor_name || '-'}</small></td>
                        <td class="text-end"><strong>${formatCurrency(revenueKRW, 'KRW')}</strong></td>
                        <td class="text-end text-danger"><strong>${formatCurrency(costKRW, 'KRW')}</strong></td>
                        <td class="text-end text-primary"><strong>${formatCurrency(marginKRW, 'KRW')}</strong></td>
                        <td class="text-end text-info"><small>${formatCurrency(tax, 'KRW')}</small></td>
                        <td class="text-center">
                            ${status === 'incomplete' ? `
                                <button class="btn btn-sm ${isPaymentReceived ? 'btn-outline-success' : 'btn-success'} btn-sm" 
                                        onclick="processPayment(${s.id}, 'received')" 
                                        ${isPaymentReceived ? 'disabled' : ''}>
                                    <i class="fas fa-arrow-down"></i>
                                </button>
                                <button class="btn btn-sm ${isPaymentSent ? 'btn-outline-danger' : 'btn-danger'} btn-sm" 
                                        onclick="processPayment(${s.id}, 'sent')"
                                        ${isPaymentSent ? 'disabled' : ''}>
                                    <i class="fas fa-arrow-up"></i>
                                </button>
                            ` : `
                                <span class="badge bg-success"><i class="fas fa-check"></i></span>
                            `}
                        </td>
                    </tr>
                `;
            }).join('');
            
            const html = `
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>ì´ìš©ì¼</th>
                                <th>ì†ë‹˜ì´ë¦„</th>
                                <th>ìƒí’ˆëª…</th>
                                <th>ì˜ˆì•½ì—…ì²´</th>
                                <th>ìˆ˜ë°°ì—…ì²´</th>
                                <th class="text-end">ê±°ë˜ì•¡</th>
                                <th class="text-end">ë§¤ì…ì•¡</th>
                                <th class="text-end">ë§ˆì§„</th>
                                <th class="text-end">ë¶€ê°€ì„¸</th>
                                <th class="text-center">ì²˜ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <th colspan="5" class="text-end">ì´ì•¡</th>
                                <th class="text-end">${formatCurrency(totalRevenue, 'KRW')}</th>
                                <th class="text-end text-danger">${formatCurrency(totalCost, 'KRW')}</th>
                                <th class="text-end text-primary">${formatCurrency(totalMargin, 'KRW')}</th>
                                <th class="text-end text-info">${formatCurrency(totalTax, 'KRW')}</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        function updateCounts(counts) {
            document.getElementById('incompleteCount').textContent = counts.incomplete || 0;
            document.getElementById('completedCount').textContent = counts.completed || 0;
        }
        
        // í™”í í¬ë§·
        function formatCurrency(amount, currency) {
            if (!amount) return '0';
            const symbol = currency === 'KRW' ? 'â‚©' : '$';
            return `${symbol}${parseFloat(amount).toLocaleString()}`;
        }
        
        // ì…ê¸ˆ/ì†¡ê¸ˆ ì²˜ë¦¬
        async function processPayment(settlementId, type) {
            const typeText = type === 'received' ? 'ì…ê¸ˆ' : 'ì†¡ê¸ˆ';
            const today = new Date().toISOString().split('T')[0];
            
            const dateInput = prompt(`${typeText} ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš” (YYYY-MM-DD):`, today);
            
            if (!dateInput) return;
            
            try {
                console.log(`ğŸ’° ${typeText} ì²˜ë¦¬:`, settlementId, dateInput);
                
                const response = await fetch(`/api/settlements/${settlementId}/payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: type,
                        date: dateInput
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`âœ… ${typeText} ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    
                    // ë‘˜ ë‹¤ ì™„ë£Œë˜ë©´ ì „ì²´ì™„ë£Œ íƒ­ìœ¼ë¡œ ì´ë™
                    if (result.all_completed) {
                        alert('âœ… ì…ê¸ˆê³¼ ì†¡ê¸ˆì´ ëª¨ë‘ ì™„ë£Œë˜ì–´ ì „ì²´ì™„ë£Œ íƒ­ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                        document.getElementById('completed-tab').click();
                    } else {
                        // í˜„ì¬ íƒ­ ìƒˆë¡œê³ ì¹¨
                        loadSettlementsByStatus(currentSettlementStatus);
                    }
                } else {
                    alert(`âŒ ${typeText} ì²˜ë¦¬ ì‹¤íŒ¨: ` + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error(`âŒ ${typeText} ì²˜ë¦¬ ì˜¤ë¥˜:`, error);
                alert(`${typeText} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);
            }
        }

        // ì •ì‚° ìƒíƒœ í…ìŠ¤íŠ¸ ë³€í™˜
        function getSettlementStatusText(status) {
            const statusMap = {
                'pending': 'ì •ì‚° ëŒ€ê¸°',
                'settled': 'ì •ì‚° ì™„ë£Œ',
                'overdue': 'ì—°ì²´'
            };
            return statusMap[status] || 'ì •ì‚° ëŒ€ê¸°';
        }

        // ì •ì‚° ìƒíƒœ CSS í´ë˜ìŠ¤ ë³€í™˜
        function getSettlementStatusClass(status) {
            const classMap = {
                'pending': 'pending',
                'settled': 'settled',
                'overdue': 'overdue'
            };
            return classMap[status] || 'pending';
        }

        // ë§ˆì§„ ìƒ‰ìƒ í´ë˜ìŠ¤
        function getProfitClass(profit) {
            if (profit > 0) return 'profit-positive';
            if (profit < 0) return 'profit-negative';
            return 'profit-neutral';
        }

        // ë§ˆì§„ ìë™ ê³„ì‚°
        function calculateProfit() {
            const saleAmount = parseFloat(document.getElementById('saleAmount').value) || 0;
            const costAmount = parseFloat(document.getElementById('costAmount').value) || 0;
            const profit = saleAmount - costAmount;
            const profitRate = saleAmount > 0 ? (profit / saleAmount * 100) : 0;
            
            document.getElementById('profitAmount').value = profit.toFixed(2);
            document.getElementById('profitRate').value = profitRate.toFixed(1);
        }

        // ì •ì‚° ëª¨ë‹¬ ì—´ê¸°
        function openSettlementModal(reservationId) {
            document.getElementById('reservationId').value = reservationId;
            document.getElementById('settlementForm').reset();
            
            // ê¸°ì¡´ ì˜ˆì•½ ì •ë³´ë¡œ ì´ˆê¸°ê°’ ì„¤ì • (í•„ìš”ì‹œ)
            
            const modal = new bootstrap.Modal(document.getElementById('settlementModal'));
            modal.show();
        }

        // ì •ì‚° ì²˜ë¦¬
        async function processSettlement() {
            const reservationId = document.getElementById('reservationId').value;
            const saleAmount = document.getElementById('saleAmount').value;
            const costAmount = document.getElementById('costAmount').value;
            const settlementNotes = document.getElementById('settlementNotes').value;
            
            if (!saleAmount || !costAmount) {
                showAlert('ê±°ë˜ì•¡ ê¸ˆì•¡ê³¼ ë§¤ì… ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`/api/settlements/${reservationId}/process`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sale_amount: parseFloat(saleAmount),
                        cost_amount: parseFloat(costAmount),
                        settlement_notes: settlementNotes
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert('ì •ì‚°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('settlementModal')).hide();
                    loadSettlements();
                    loadStats();
                } else {
                    showAlert(result.message || 'ì •ì‚° ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
                }
            } catch (error) {
                console.error('ì •ì‚° ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                showAlert('ì •ì‚° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        // ê²€ìƒ‰ ë° í•„í„°ë§
        function searchSettlements() {
            currentStatus = document.getElementById('statusFilter').value;
            currentMonth = document.getElementById('monthFilter').value;
            currentSearch = document.getElementById('searchInput').value;
            loadSettlements(1);
        }

        function resetFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('monthFilter').value = '';
            document.getElementById('searchInput').value = '';
            currentStatus = '';
            currentMonth = '';
            currentSearch = '';
            loadSettlements(1);
        }

        // ì •ì‚° ë‚´ë³´ë‚´ê¸°
        function exportSettlements() {
            const params = new URLSearchParams({
                status: currentStatus,
                month: currentMonth,
                search: currentSearch,
                export: 'csv'
            });
            
            window.open(`/api/settlements/export?${params}`, '_blank');
        }

        // ê¸°íƒ€ í•¨ìˆ˜ë“¤
        function viewSettlementDetail(id) {
            showAlert('ì •ì‚° ìƒì„¸ ë³´ê¸° ê¸°ëŠ¥ì€ ê³§ ì¶”ê°€ë©ë‹ˆë‹¤.', 'info');
        }

        function printSettlement(id) {
            showAlert('ì •ì‚°ì„œ ì¶œë ¥ ê¸°ëŠ¥ì€ ê³§ ì¶”ê°€ë©ë‹ˆë‹¤.', 'info');
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
        }

        function renderPagination(pagination) {
            const container = document.getElementById('pagination');
            if (!pagination || pagination.totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            
            if (pagination.currentPage > 1) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadSettlements(${pagination.currentPage - 1})">ì´ì „</a></li>`;
            }

            for (let i = Math.max(1, pagination.currentPage - 2); i <= Math.min(pagination.totalPages, pagination.currentPage + 2); i++) {
                html += `<li class="page-item ${i === pagination.currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadSettlements(${i})">${i}</a>
                </li>`;
            }

            if (pagination.currentPage < pagination.totalPages) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadSettlements(${pagination.currentPage + 1})">ë‹¤ìŒ</a></li>`;
            }

            container.innerHTML = html;
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // ==================== í™˜ìœ¨ ê´€ë¦¬ ê¸°ëŠ¥ ====================

        // í™˜ìœ¨ ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°
        function openExchangeRateModal() {
            const modal = new bootstrap.Modal(document.getElementById('exchangeRateModal'));
            modal.show();
            loadExchangeRates();
            
            // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('rateDate').value = today;
        }

        // í™˜ìœ¨ ëª©ë¡ ë¡œë“œ
        async function loadExchangeRates() {
            try {
                const response = await fetch('/api/exchange-rates');
                const data = await response.json();
                
                if (data.success) {
                    renderExchangeRates(data.data);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('í™˜ìœ¨ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('exchangeRateList').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle me-1"></i>í™˜ìœ¨ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
            }
        }

        // í™˜ìœ¨ ëª©ë¡ ë Œë”ë§
        function renderExchangeRates(rates) {
            const tbody = document.getElementById('exchangeRateList');
            
            if (rates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            <i class="fas fa-inbox me-1"></i>ë“±ë¡ëœ í™˜ìœ¨ì´ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = rates.map(rate => `
                <tr>
                    <td><strong>${rate.currency_code}</strong></td>
                    <td>${rate.rate_date} ${rate.rate_time || '16:00'}</td>
                    <td><strong class="text-primary">â‚©${parseFloat(rate.rate).toLocaleString('ko-KR', {minimumFractionDigits: 2})}</strong></td>
                    <td><span class="badge bg-secondary">${rate.source || 'ìˆ˜ë™'}</span></td>
                    <td><small class="text-muted">${formatDate(rate.created_at)}</small></td>
                </tr>
            `).join('');
        }

        // í™˜ìœ¨ í¼ ì œì¶œ ì´ë²¤íŠ¸
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('exchangeRateForm');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = {
                        currency_code: document.getElementById('currencyCode').value,
                        rate_date: document.getElementById('rateDate').value,
                        rate_time: document.getElementById('rateTime').value,
                        rate: parseFloat(document.getElementById('exchangeRate').value),
                        source: 'manual'
                    };
                    
                    try {
                        const response = await fetch('/api/exchange-rates', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formData)
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            showAlert('í™˜ìœ¨ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                            form.reset();
                            document.getElementById('rateTime').value = '16:00';
                            const today = new Date().toISOString().split('T')[0];
                            document.getElementById('rateDate').value = today;
                            loadExchangeRates();
                        } else {
                            showAlert(result.message || 'í™˜ìœ¨ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
                        }
                    } catch (error) {
                        console.error('í™˜ìœ¨ ë“±ë¡ ì‹¤íŒ¨:', error);
                        showAlert('í™˜ìœ¨ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                    }
                });
            }
        });

        // ==================== ëŒ€ëŸ‰ ì •ì‚° ê³„ì‚° ê¸°ëŠ¥ ====================

        let selectedReservations = [];

        // ëŒ€ëŸ‰ ì •ì‚° ëª¨ë‹¬ ì—´ê¸°
        function openBulkCalculateModal() {
            const modal = new bootstrap.Modal(document.getElementById('bulkCalculateModal'));
            modal.show();
            selectedReservations = [];
            document.getElementById('bulkCalculateResult').style.display = 'none';
        }

        // ëŒ€ìƒ ì˜ˆì•½ ì¡°íšŒ
        async function loadBulkReservations() {
            try {
                const platformId = document.getElementById('bulkPlatformId').value;
                const supplierId = document.getElementById('bulkSupplierId').value;
                const period = document.getElementById('bulkPeriod').value;

                // ë°”ìš°ì²˜ ì „ì†¡ ì™„ë£Œëœ ì˜ˆì•½ ì¡°íšŒ (ì •ì‚° ëŒ€ìƒ)
                const params = new URLSearchParams({
                    status: 'voucher_sent',
                    limit: 100
                });

                if (platformId) params.append('platform', platformId);
                if (supplierId) params.append('supplier', supplierId);

                const response = await fetch(`/api/assignments?${params}`);
                const data = await response.json();

                if (data.success && data.data) {
                    renderBulkReservations(data.data);
                } else {
                    throw new Error(data.message || 'ì˜ˆì•½ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ëŒ€ìƒ ì˜ˆì•½ ì¡°íšŒ ì‹¤íŒ¨:', error);
                showAlert('ëŒ€ìƒ ì˜ˆì•½ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        // ëŒ€ìƒ ì˜ˆì•½ ë Œë”ë§
        function renderBulkReservations(reservations) {
            const container = document.getElementById('bulkReservationList');
            
            if (!reservations || reservations.length === 0) {
                container.innerHTML = `
                    <p class="text-center text-muted">
                        <i class="fas fa-inbox me-1"></i>ì¡°ê±´ì— ë§ëŠ” ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.
                    </p>
                `;
                document.getElementById('bulkCalculateBtn').disabled = true;
                return;
            }

            container.innerHTML = reservations.map(res => `
                <div class="form-check border-bottom py-2">
                    <input class="form-check-input" type="checkbox" value="${res.id}" id="bulk_${res.id}" 
                           onchange="updateBulkSelection()">
                    <label class="form-check-label w-100" for="bulk_${res.id}">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>${res.reservation_number || 'N/A'}</strong> - ${res.product_name || 'ìƒí’ˆëª… ì—†ìŒ'}
                                <br>
                                <small class="text-muted">
                                    <i class="fas fa-user me-1"></i>${res.korean_name || 'N/A'}
                                    <i class="fas fa-calendar ms-2 me-1"></i>${res.usage_date || 'N/A'}
                                </small>
                            </div>
                            <div class="text-end">
                                <strong class="text-primary">â‚©${(res.total_amount || 0).toLocaleString()}</strong>
                            </div>
                        </div>
                    </label>
                </div>
            `).join('');

            document.getElementById('bulkCalculateBtn').disabled = false;
        }

        // ì„ íƒ ì—…ë°ì´íŠ¸
        function updateBulkSelection() {
            const checkboxes = document.querySelectorAll('#bulkReservationList input[type="checkbox"]:checked');
            selectedReservations = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            const btn = document.getElementById('bulkCalculateBtn');
            btn.disabled = selectedReservations.length === 0;
            btn.innerHTML = `<i class="fas fa-calculator me-1"></i>ì •ì‚° ê³„ì‚° ì‹¤í–‰ (${selectedReservations.length}ê±´)`;
        }

        // ì „ì²´ ì„ íƒ
        function selectAllBulkReservations() {
            document.querySelectorAll('#bulkReservationList input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            updateBulkSelection();
        }

        // ì „ì²´ í•´ì œ
        function deselectAllBulkReservations() {
            document.querySelectorAll('#bulkReservationList input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            updateBulkSelection();
        }

        // ëŒ€ëŸ‰ ì •ì‚° ê³„ì‚° ì‹¤í–‰
        async function executeBulkCalculate() {
            if (selectedReservations.length === 0) {
                showAlert('ê³„ì‚°í•  ì˜ˆì•½ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            const btn = document.getElementById('bulkCalculateBtn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ê³„ì‚° ì¤‘...';

            try {
                const response = await fetch('/api/settlements/bulk-calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reservation_ids: selectedReservations,
                        platform_id: document.getElementById('bulkPlatformId').value || null,
                        supplier_id: document.getElementById('bulkSupplierId').value || null
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(`${result.data.processed}ê±´ì˜ ì •ì‚°ì´ ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                    
                    // ê²°ê³¼ í‘œì‹œ
                    const resultDiv = document.getElementById('bulkCalculateResult');
                    const summaryDiv = document.getElementById('bulkResultSummary');
                    
                    summaryDiv.innerHTML = `
                        <p class="mb-1"><strong>ì²˜ë¦¬ ì™„ë£Œ:</strong> ${result.data.processed}ê±´</p>
                        ${result.data.errors && result.data.errors.length > 0 ? 
                            `<p class="mb-1 text-danger"><strong>ì‹¤íŒ¨:</strong> ${result.data.errors.length}ê±´</p>` : 
                            ''}
                        <p class="mb-0"><small>ì •ì‚° ëª©ë¡ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.</small></p>
                    `;
                    resultDiv.style.display = 'block';

                    // 3ì´ˆ í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    setTimeout(() => {
                        loadSettlements();
                        loadStats();
                    }, 3000);
                } else {
                    showAlert(result.message || 'ì •ì‚° ê³„ì‚°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
                }
            } catch (error) {
                console.error('ëŒ€ëŸ‰ ì •ì‚° ê³„ì‚° ì‹¤íŒ¨:', error);
                showAlert('ì •ì‚° ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        // ==================== ìš”ê¸ˆ RAG ë¬¸ì„œ ê´€ë¦¬ ê¸°ëŠ¥ ====================

        // ìš”ê¸ˆ RAG ë¬¸ì„œ ëª©ë¡ ë¡œë“œ
        async function loadPriceRagDocuments() {
            try {
                console.log('ğŸ’° ìš”ê¸ˆ RAG ë¬¸ì„œ ëª©ë¡ ë¡œë“œ ì‹œì‘');
                const tbody = document.getElementById('priceRagDocumentList');
                const searchTerm = document.getElementById('priceSearchInput').value;
                
                const response = await fetch(`/api/price-rag/documents?search=${encodeURIComponent(searchTerm)}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    renderPriceRagDocuments(data.data);
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                                ë“±ë¡ëœ ìš”ê¸ˆ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('âŒ ìš”ê¸ˆ RAG ë¬¸ì„œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                const tbody = document.getElementById('priceRagDocumentList');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-danger py-3">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
            }
        }
        
        // ìš”ê¸ˆ RAG ë¬¸ì„œ ë Œë”ë§
        function renderPriceRagDocuments(documents) {
            const tbody = document.getElementById('priceRagDocumentList');
            
            tbody.innerHTML = documents.map(doc => {
                const salePrice = `${doc.sale_adult_price || 0}/${doc.sale_child_price || 0}/${doc.sale_infant_price || 0} ${doc.sale_currency}`;
                const costPrice = `${doc.cost_adult_price || 0}/${doc.cost_child_price || 0}/${doc.cost_infant_price || 0} ${doc.cost_currency}`;
                
                return `
                    <tr>
                        <td><strong>${doc.product_name}</strong></td>
                        <td>${doc.package_name || '-'}</td>
                        <td>${doc.supplier_name || '-'}</td>
                        <td>
                            <small class="text-success">${salePrice}</small>
                        </td>
                        <td>
                            <small class="text-danger">${costPrice}</small>
                        </td>
                        <td>${doc.commission_rate || 0}%</td>
                        <td><small class="text-muted">${formatDate(doc.created_at)}</small></td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editPriceRag(${doc.id})" title="ìˆ˜ì •">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deletePriceRag(${doc.id})" title="ì‚­ì œ">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // ìš”ê¸ˆ RAG í¼ ì´ˆê¸°í™”
        function resetPriceForm() {
            document.getElementById('priceRagForm').reset();
        }
        
        // ìš”ê¸ˆ RAG ìˆ˜ì •
        async function editPriceRag(id) {
            try {
                const response = await fetch(`/api/price-rag/documents/${id}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const doc = data.data;
                    
                    document.getElementById('productName').value = doc.product_name || '';
                    document.getElementById('packageName').value = doc.package_name || '';
                    document.getElementById('supplierName').value = doc.supplier_name || '';
                    
                    document.getElementById('saleCurrency').value = doc.sale_currency || 'KRW';
                    document.getElementById('saleAdultPrice').value = doc.sale_adult_price || 0;
                    document.getElementById('saleChildPrice').value = doc.sale_child_price || 0;
                    document.getElementById('saleInfantPrice').value = doc.sale_infant_price || 0;
                    document.getElementById('commissionRate').value = doc.commission_rate || 0;
                    
                    document.getElementById('costCurrency').value = doc.cost_currency || 'USD';
                    document.getElementById('costAdultPrice').value = doc.cost_adult_price || 0;
                    document.getElementById('costChildPrice').value = doc.cost_child_price || 0;
                    document.getElementById('costInfantPrice').value = doc.cost_infant_price || 0;
                    
                    // í¼ì— ìˆ˜ì • ID ì €ì¥
                    document.getElementById('priceRagForm').dataset.editId = id;
                    
                    // ìŠ¤í¬ë¡¤ ì´ë™
                    document.querySelector('#priceRagForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    showAlert('ìˆ˜ì •í•˜ë ¤ëŠ” ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'info');
                } else {
                    showAlert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
                }
            } catch (error) {
                console.error('âŒ ìš”ê¸ˆ RAG ì¡°íšŒ ì‹¤íŒ¨:', error);
                showAlert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }
        
        // ìš”ê¸ˆ RAG ì‚­ì œ
        async function deletePriceRag(id) {
            if (!confirm('ì´ ìš”ê¸ˆ ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/price-rag/documents/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('âœ… ìš”ê¸ˆ ì •ë³´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    loadPriceRagDocuments();
                } else {
                    showAlert(result.message || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
                }
            } catch (error) {
                console.error('âŒ ìš”ê¸ˆ RAG ì‚­ì œ ì‹¤íŒ¨:', error);
                showAlert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        // RAG ë¬¸ì„œ ë Œë”ë§
        function renderRagDocuments(documents) {
            const tbody = document.getElementById('ragDocumentList');
            
            tbody.innerHTML = documents.map(doc => {
                const typeLabels = {
                    'platform_policy': 'í”Œë«í¼ ì •ì±…',
                    'supplier_policy': 'ê³µê¸‰ì‚¬ ì •ì±…',
                    'settlement_guide': 'ì •ì‚° ê°€ì´ë“œ',
                    'exchange_rate_policy': 'í™˜ìœ¨ ì •ì±…',
                    'other': 'ê¸°íƒ€'
                };
                
                return `
                    <tr>
                        <td><span class="badge bg-info">${typeLabels[doc.document_type] || doc.document_type}</span></td>
                        <td><strong>${doc.document_name}</strong></td>
                        <td>${doc.platform_name || doc.supplier_name || '-'}</td>
                        <td><small class="text-muted">${doc.content ? doc.content.substring(0, 50) + '...' : '-'}</small></td>
                        <td><small class="text-muted">${formatDate(doc.created_at)}</small></td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="viewRagDocument(${doc.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteRagDocument(${doc.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ì˜ˆì•½ì—…ì²´ ë° ìˆ˜ë°°ì—…ì²´ ëª©ë¡ ë¡œë“œ
        async function loadFilterOptions() {
            try {
                // ì˜ˆì•½ì—…ì²´ ëª©ë¡ ë¡œë“œ
                const platformsResponse = await fetch('/api/settlements/platforms');
                if (platformsResponse.ok) {
                    const platformsData = await platformsResponse.json();
                    const platformSelect = document.getElementById('platformFilter');
                    if (platformsData.success && platformsData.data) {
                        platformsData.data.forEach(platform => {
                            const option = document.createElement('option');
                            option.value = platform;
                            option.textContent = platform;
                            platformSelect.appendChild(option);
                        });
                    }
                }
                
                // ìˆ˜ë°°ì—…ì²´ ëª©ë¡ ë¡œë“œ
                const vendorsResponse = await fetch('/api/settlements/vendors');
                if (vendorsResponse.ok) {
                    const vendorsData = await vendorsResponse.json();
                    const vendorSelect = document.getElementById('vendorFilter');
                    if (vendorsData.success && vendorsData.data) {
                        vendorsData.data.forEach(vendor => {
                            const option = document.createElement('option');
                            option.value = vendor;
                            option.textContent = vendor;
                            vendorSelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('âŒ í•„í„° ì˜µì…˜ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        // ìš”ê¸ˆ RAG í¼ ì œì¶œ ì´ë²¤íŠ¸
        document.addEventListener('DOMContentLoaded', function() {
            // í•„í„° ì˜µì…˜ ë¡œë“œ
            loadFilterOptions();
            
            const priceRagForm = document.getElementById('priceRagForm');
            if (priceRagForm) {
                priceRagForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const editId = priceRagForm.dataset.editId;
                    const formData = {
                        product_name: document.getElementById('productName').value,
                        package_name: document.getElementById('packageName').value || null,
                        supplier_name: document.getElementById('supplierName').value || null,
                        
                        sale_currency: document.getElementById('saleCurrency').value,
                        sale_adult_price: parseFloat(document.getElementById('saleAdultPrice').value) || 0,
                        sale_child_price: parseFloat(document.getElementById('saleChildPrice').value) || 0,
                        sale_infant_price: parseFloat(document.getElementById('saleInfantPrice').value) || 0,
                        commission_rate: parseFloat(document.getElementById('commissionRate').value) || 0,
                        
                        cost_currency: document.getElementById('costCurrency').value,
                        cost_adult_price: parseFloat(document.getElementById('costAdultPrice').value) || 0,
                        cost_child_price: parseFloat(document.getElementById('costChildPrice').value) || 0,
                        cost_infant_price: parseFloat(document.getElementById('costInfantPrice').value) || 0
                    };
                    
                    try {
                        const url = editId 
                            ? `/api/price-rag/documents/${editId}` 
                            : '/api/price-rag/documents';
                        const method = editId ? 'PUT' : 'POST';
                        
                        const response = await fetch(url, {
                            method: method,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formData)
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            showAlert(`âœ… ìš”ê¸ˆ ì •ë³´ê°€ ${editId ? 'ìˆ˜ì •' : 'ë“±ë¡'}ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                            priceRagForm.reset();
                            delete priceRagForm.dataset.editId;
                            loadPriceRagDocuments();
                        } else {
                            showAlert(result.message || `ìš”ê¸ˆ ì •ë³´ ${editId ? 'ìˆ˜ì •' : 'ë“±ë¡'}ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`, 'danger');
                        }
                    } catch (error) {
                        console.error('âŒ ìš”ê¸ˆ RAG ë“±ë¡/ìˆ˜ì • ì‹¤íŒ¨:', error);
                        showAlert('ìš”ê¸ˆ ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                    }
                });
            }
            
            // ìš”ê¸ˆ RAG íƒ­ í´ë¦­ ì‹œ ë¬¸ì„œ ë¡œë“œ
            const ragTab = document.getElementById('rag-tab');
            if (ragTab) {
                ragTab.addEventListener('shown.bs.tab', function() {
                    loadPriceRagDocuments();
                });
            }
            
            // ê²€ìƒ‰ ì…ë ¥ ì‹œ ì‹¤ì‹œê°„ ê²€ìƒ‰
            const searchInput = document.getElementById('priceSearchInput');
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        loadPriceRagDocuments();
                    }, 500);
                });
            }
        });
    </script>
</body>
</html>
