<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>설정 - 괌세이브카드 관리자</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans KR', sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
        }
        
        /* PC 화면에서 가로폭 1200px 고정 */
        @media (min-width: 1200px) {
            .container-fluid {
                max-width: 1200px;
                margin: 0 auto;
            }
        }
        
        .settings-nav {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .settings-nav .nav-link {
            color: #6c757d;
            border-radius: 8px;
            margin: 5px;
            transition: all 0.3s;
        }
        
        .settings-nav .nav-link.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .settings-nav .nav-link:hover {
            background-color: #f8f9fa;
            color: #495057;
        }
        
        .settings-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 30px;
        }
        
        .vendor-card {
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .vendor-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .vendor-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .vendor-active {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .vendor-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .product-tag {
            background-color: #e7f3ff;
            color: #0066cc;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin: 2px;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 8px;
        }
        
        .modal-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .alert-custom {
            border-radius: 12px;
            border: none;
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar', { currentPage: 'settings', adminUsername: adminUsername || 'admin' }) %>

    <div class="container-fluid mt-4">
        <!-- 설정 네비게이션 -->
        <div class="settings-nav">
            <ul class="nav nav-pills p-3" id="settingsTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="platforms-tab" data-bs-toggle="pill" data-bs-target="#platforms" type="button" role="tab">
                        <i class="fas fa-store me-2"></i>예약업체 관리
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="vendors-tab" data-bs-toggle="pill" data-bs-target="#vendors" type="button" role="tab">
                        <i class="fas fa-building me-2"></i>수배업체 관리
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="staff-tab" data-bs-toggle="pill" data-bs-target="#staff" type="button" role="tab">
                        <i class="fas fa-users me-2"></i>직원 계정 관리
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="notifications-tab" data-bs-toggle="pill" data-bs-target="#notifications" type="button" role="tab">
                        <i class="fas fa-bell me-2"></i>알림 설정
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="system-tab" data-bs-toggle="pill" data-bs-target="#system" type="button" role="tab">
                        <i class="fas fa-cog me-2"></i>시스템 설정
                    </button>
                </li>
            </ul>
        </div>

        <!-- 설정 내용 -->
        <div class="tab-content" id="settingsTabContent">
            <!-- 예약업체 관리 탭 -->
            <div class="tab-pane fade show active" id="platforms" role="tabpanel">
                <div class="settings-content">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h4><i class="fas fa-store me-2"></i>예약업체 관리</h4>
                            <p class="text-muted mb-0">예약을 받는 플랫폼/업체를 등록하고 관리합니다. (정산 관리용)</p>
                        </div>
                        <button class="btn btn-primary" onclick="openPlatformModal()">
                            <i class="fas fa-plus me-2"></i>예약업체 등록
                        </button>
                    </div>

                    <!-- 알림 영역 -->
                    <div id="platformAlertArea"></div>

                    <!-- 예약업체 목록 -->
                    <div id="platformsList">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">로딩중...</span>
                            </div>
                            <p class="mt-3 text-muted">예약업체 목록을 불러오는 중...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 수배업체 관리 탭 -->
            <div class="tab-pane fade" id="vendors" role="tabpanel">
                <div class="settings-content">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h4><i class="fas fa-building me-2"></i>수배업체 관리</h4>
                            <p class="text-muted mb-0">예약 수배를 담당할 업체들을 등록하고 관리합니다.</p>
                        </div>
                        <button class="btn btn-primary" onclick="openVendorModal()">
                            <i class="fas fa-plus me-2"></i>수배업체 등록
                        </button>
                    </div>

                    <!-- 알림 영역 -->
                    <div id="alertArea"></div>

                    <!-- 수배업체 목록 -->
                    <div id="vendorsList">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">로딩중...</span>
                            </div>
                            <p class="mt-3 text-muted">수배업체 목록을 불러오는 중...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 직원 계정 관리 탭 -->
            <div class="tab-pane fade" id="staff" role="tabpanel">
                <div class="settings-content">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h4><i class="fas fa-users me-2"></i>직원 계정 관리</h4>
                            <p class="text-muted mb-0">시스템에 접근할 수 있는 직원 계정을 관리합니다.</p>
                        </div>
                        <button class="btn btn-primary" onclick="openStaffModal()">
                            <i class="fas fa-plus me-2"></i>직원 등록
                        </button>
                    </div>

                    <!-- 알림 영역 -->
                    <div id="staffAlertArea"></div>

                    <!-- 직원 목록 -->
                    <div id="staffList">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">로딩중...</span>
                            </div>
                            <p class="mt-3 text-muted">직원 목록을 불러오는 중...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 알림 설정 탭 -->
            <div class="tab-pane fade" id="notifications" role="tabpanel">
                <div class="settings-content">
                    <h4><i class="fas fa-bell me-2"></i>알림 설정</h4>
                    <p class="text-muted">수배 알림 및 시스템 알림을 설정합니다.</p>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        알림 설정 기능은 곧 추가될 예정입니다.
                    </div>
                </div>
            </div>

            <!-- 시스템 설정 탭 -->
            <div class="tab-pane fade" id="system" role="tabpanel">
                <div class="settings-content">
                    <h4><i class="fas fa-cog me-2"></i>시스템 설정</h4>
                    <p class="text-muted">시스템 전반의 설정을 관리합니다.</p>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        시스템 설정 기능은 곧 추가될 예정입니다.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 수배업체 등록/수정 모달 -->
    <div class="modal fade" id="vendorModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="vendorModalTitle">수배업체 등록</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="vendorForm">
                        <input type="hidden" id="vendorId">
                        
                        <!-- 기본 정보 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2"><i class="fas fa-info-circle me-2"></i>기본 정보</h6>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">업체명 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="vendor_name" name="vendor_name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">로그인 아이디 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="vendor_id" name="vendor_id" required>
                                <div class="form-text">업체 전용 포털 로그인용 아이디</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">패스워드 <span class="text-danger">*</span></label>
                                <input type="password" class="form-control" id="password" name="password">
                                <div class="form-text" id="passwordHelp">수정 시에는 변경할 경우에만 입력</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">업종</label>
                                <select class="form-select" id="business_type" name="business_type">
                                    <option value="">선택하세요</option>
                                    <option value="해양관광">해양관광</option>
                                    <option value="자연관광">자연관광</option>
                                    <option value="공연/엔터테인먼트">공연/엔터테인먼트</option>
                                    <option value="골프/스포츠">골프/스포츠</option>
                                    <option value="레스토랑">레스토랑</option>
                                    <option value="쇼핑">쇼핑</option>
                                    <option value="기타">기타</option>
                                </select>
                            </div>
                        </div>

                        <!-- 연락처 정보 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2"><i class="fas fa-phone me-2"></i>연락처 정보</h6>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">이메일 <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">전화번호</label>
                                <input type="tel" class="form-control" id="phone" name="phone">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">담당자명</label>
                                <input type="text" class="form-control" id="contact_person" name="contact_person">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">수배 알림 이메일</label>
                                <input type="email" class="form-control" id="notification_email" name="notification_email">
                                <div class="form-text">수배 알림을 받을 이메일 (기본 이메일과 다른 경우)</div>
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label">업체 설명</label>
                                <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                            </div>
                        </div>

                        <!-- 담당 상품 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2"><i class="fas fa-tags me-2"></i>담당 상품명</h6>
                                <p class="text-muted small">
                                    <strong>정확한 상품명</strong> 또는 <strong>상품명 패턴</strong>을 입력하세요.<br>
                                    예: "스타돌핀크루즈", "괌 별빛투어 탕기슨비치", "레오팔레스 골프" 등<br>
                                    입력한 텍스트가 예약 상품명에 <strong>포함되면</strong> 자동 매칭됩니다.
                                </p>
                            </div>
                            <div class="col-12">
                                <div id="productKeywords">
                                    <div class="row mb-2 product-keyword-row">
                                        <div class="col-md-8">
                                            <input type="text" class="form-control" placeholder="예: 스타돌핀크루즈, 괌 별빛투어, 레오팔레스 골프 18홀" name="product_keyword">
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select" name="product_priority">
                                                <option value="1">높음 (1)</option>
                                                <option value="2">보통 (2)</option>
                                                <option value="3">낮음 (3)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-1">
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeProductKeyword(this)">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addProductKeyword()">
                                    <i class="fas fa-plus me-1"></i>상품명 추가
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="saveVendor()">
                        <i class="fas fa-save me-1"></i>저장
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 예약업체 등록/수정 모달 -->
    <div class="modal fade" id="platformModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="platformModalTitle">예약업체 등록</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="platformForm">
                        <input type="hidden" id="platformId">
                        
                        <!-- 기본 정보 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2"><i class="fas fa-info-circle me-2"></i>기본 정보</h6>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">업체명 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="platform_name" name="platform_name" required>
                                <div class="form-text">예: 놀공, 클룩, 카톡, 마이리얼트립</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">업체 코드 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="platform_code" name="platform_code" required>
                                <div class="form-text">예: NOL, KLOOK, KAKAO, MRT</div>
                            </div>
                        </div>

                        <!-- 연락처 정보 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2"><i class="fas fa-phone me-2"></i>연락처 정보</h6>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">담당자명</label>
                                <input type="text" class="form-control" id="platform_contact_person" name="contact_person">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">이메일</label>
                                <input type="email" class="form-control" id="platform_email" name="email">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">전화번호</label>
                                <input type="tel" class="form-control" id="platform_phone" name="phone">
                            </div>
                        </div>

                        <!-- 정산 정보 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2"><i class="fas fa-calculator me-2"></i>정산 정보</h6>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">수수료율 (%)</label>
                                <input type="number" step="0.01" class="form-control" id="commission_rate" name="commission_rate" value="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">정산 주기</label>
                                <select class="form-select" id="settlement_cycle" name="settlement_cycle">
                                    <option value="weekly">주간</option>
                                    <option value="biweekly">격주</option>
                                    <option value="monthly" selected>월간</option>
                                    <option value="quarterly">분기</option>
                                </select>
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label">결제 조건</label>
                                <input type="text" class="form-control" id="payment_terms" name="payment_terms" placeholder="예: 월말 마감 익월 15일 지급">
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label">메모</label>
                                <textarea class="form-control" id="platform_memo" name="memo" rows="3"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="savePlatform()">
                        <i class="fas fa-save me-1"></i>저장
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 직원 등록/수정 모달 -->
    <div class="modal fade" id="staffModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staffModalTitle">직원 등록</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="staffForm">
                        <input type="hidden" id="staffId">
                        
                        <div class="mb-3">
                            <label class="form-label">아이디 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="staff_username" required>
                            <div class="form-text">로그인 시 사용할 아이디</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">비밀번호 <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="staff_password">
                            <div class="form-text" id="staffPasswordHelp">수정 시에는 변경할 경우에만 입력</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">이름 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="staff_full_name" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">이메일</label>
                            <input type="email" class="form-control" id="staff_email">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">전화번호</label>
                            <input type="tel" class="form-control" id="staff_phone">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">권한</label>
                            <select class="form-select" id="staff_role">
                                <option value="staff">일반 직원</option>
                                <option value="manager">매니저</option>
                                <option value="admin">관리자</option>
                            </select>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="staff_is_active" checked>
                            <label class="form-check-label" for="staff_is_active">
                                계정 활성화
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="saveStaff()">
                        <i class="fas fa-save me-1"></i>저장
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let platforms = [];
        let editingPlatformId = null;
        let vendors = [];
        let editingVendorId = null;
        let staffList = [];
        let editingStaffId = null;

        // 페이지 로드시 예약업체, 수배업체 및 직원 목록 가져오기
        document.addEventListener('DOMContentLoaded', function() {
            loadPlatforms();
            loadVendors();
            loadStaff();
        });

        // ============================================
        // 예약업체 관리 함수들
        // ============================================

        // 예약업체 목록 로드
        async function loadPlatforms() {
            try {
                const response = await fetch('/api/platforms');
                const data = await response.json();
                
                if (data.success) {
                    platforms = data.platforms;
                    renderPlatforms();
                } else {
                    showPlatformAlert('danger', '예약업체 목록을 불러오는데 실패했습니다.');
                }
            } catch (error) {
                console.error('예약업체 목록 로드 실패:', error);
                showPlatformAlert('danger', '예약업체 목록을 불러오는데 실패했습니다.');
            }
        }

        // 예약업체 목록 렌더링
        function renderPlatforms() {
            const platformsList = document.getElementById('platformsList');
            
            if (platforms.length === 0) {
                platformsList.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-store fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">등록된 예약업체가 없습니다</h5>
                        <p class="text-muted">첫 번째 예약업체를 등록해보세요.</p>
                        <button class="btn btn-primary" onclick="openPlatformModal()">
                            <i class="fas fa-plus me-2"></i>예약업체 등록
                        </button>
                    </div>
                `;
                return;
            }

            platformsList.innerHTML = platforms.map(platform => `
                <div class="vendor-card">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center mb-2">
                                <h5 class="mb-0 me-3">${platform.platform_name}</h5>
                                <span class="badge bg-secondary">${platform.platform_code}</span>
                                <span class="vendor-status ms-2 ${platform.is_active ? 'vendor-active' : 'vendor-inactive'}">
                                    ${platform.is_active ? '활성' : '비활성'}
                                </span>
                            </div>
                            <div class="text-muted mb-2">
                                ${platform.contact_person ? `<i class="fas fa-user me-1"></i>${platform.contact_person}` : ''}
                                ${platform.email ? `<i class="fas fa-envelope ms-3 me-1"></i>${platform.email}` : ''}
                                ${platform.phone ? `<i class="fas fa-phone ms-3 me-1"></i>${platform.phone}` : ''}
                            </div>
                            <div class="text-muted mb-2">
                                <i class="fas fa-percent me-1"></i>수수료 ${platform.commission_rate}%
                                <i class="fas fa-calendar ms-3 me-1"></i>${getSettlementCycleText(platform.settlement_cycle)}
                                <i class="fas fa-file-invoice-dollar ms-3 me-1"></i>예약 ${platform.reservation_count}건
                                <i class="fas fa-money-bill-wave ms-3 me-1"></i>${formatCurrency(platform.total_amount)}
                            </div>
                            ${platform.memo ? `<p class="text-muted small mb-0">${platform.memo}</p>` : ''}
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="editPlatform(${platform.id})">
                                <i class="fas fa-edit me-1"></i>수정
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deletePlatform(${platform.id}, '${platform.platform_name}')">
                                <i class="fas fa-trash me-1"></i>삭제
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 예약업체 등록 모달 열기
        function openPlatformModal(platformId = null) {
            editingPlatformId = platformId;
            const modal = new bootstrap.Modal(document.getElementById('platformModal'));
            const title = document.getElementById('platformModalTitle');
            
            if (platformId) {
                title.textContent = '예약업체 수정';
                loadPlatformForEdit(platformId);
            } else {
                title.textContent = '예약업체 등록';
                document.getElementById('platformForm').reset();
                document.getElementById('platformId').value = '';
            }
            
            modal.show();
        }

        // 예약업체 정보 로드 (수정용)
        async function loadPlatformForEdit(platformId) {
            try {
                const response = await fetch(`/api/platforms/${platformId}`);
                const data = await response.json();
                
                if (data.success) {
                    const platform = data.platform;
                    
                    document.getElementById('platformId').value = platform.id;
                    document.getElementById('platform_name').value = platform.platform_name;
                    document.getElementById('platform_code').value = platform.platform_code;
                    document.getElementById('platform_contact_person').value = platform.contact_person || '';
                    document.getElementById('platform_email').value = platform.email || '';
                    document.getElementById('platform_phone').value = platform.phone || '';
                    document.getElementById('commission_rate').value = platform.commission_rate || 0;
                    document.getElementById('settlement_cycle').value = platform.settlement_cycle || 'monthly';
                    document.getElementById('payment_terms').value = platform.payment_terms || '';
                    document.getElementById('platform_memo').value = platform.memo || '';
                } else {
                    showPlatformAlert('danger', '예약업체 정보를 불러오는데 실패했습니다.');
                }
            } catch (error) {
                console.error('예약업체 정보 로드 실패:', error);
                showPlatformAlert('danger', '예약업체 정보를 불러오는데 실패했습니다.');
            }
        }

        // 예약업체 저장
        async function savePlatform() {
            const form = document.getElementById('platformForm');
            const formData = new FormData(form);
            
            const platformData = {
                platform_name: formData.get('platform_name'),
                platform_code: formData.get('platform_code'),
                contact_person: formData.get('contact_person'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                commission_rate: parseFloat(formData.get('commission_rate')) || 0,
                settlement_cycle: formData.get('settlement_cycle'),
                payment_terms: formData.get('payment_terms'),
                memo: formData.get('memo')
            };
            
            try {
                const url = editingPlatformId ? `/api/platforms/${editingPlatformId}` : '/api/platforms';
                const method = editingPlatformId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(platformData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showPlatformAlert('success', data.message);
                    bootstrap.Modal.getInstance(document.getElementById('platformModal')).hide();
                    loadPlatforms();
                } else {
                    showPlatformAlert('danger', data.message);
                }
                
            } catch (error) {
                console.error('예약업체 저장 실패:', error);
                showPlatformAlert('danger', '예약업체 저장에 실패했습니다.');
            }
        }

        // 예약업체 수정
        function editPlatform(platformId) {
            openPlatformModal(platformId);
        }

        // 예약업체 삭제
        async function deletePlatform(platformId, platformName) {
            if (!confirm(`'${platformName}' 업체를 정말 삭제하시겠습니까?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/platforms/${platformId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showPlatformAlert('success', data.message);
                    loadPlatforms();
                } else {
                    showPlatformAlert('danger', data.message);
                }
                
            } catch (error) {
                console.error('예약업체 삭제 실패:', error);
                showPlatformAlert('danger', '예약업체 삭제에 실패했습니다.');
            }
        }

        // 정산 주기 텍스트
        function getSettlementCycleText(cycle) {
            const cycleMap = {
                'weekly': '주간',
                'biweekly': '격주',
                'monthly': '월간',
                'quarterly': '분기'
            };
            return cycleMap[cycle] || cycle;
        }

        // 예약업체 알림 표시
        function showPlatformAlert(type, message) {
            const alertArea = document.getElementById('platformAlertArea');
            alertArea.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show alert-custom" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            setTimeout(() => {
                alertArea.innerHTML = '';
            }, 5000);
        }

        // ============================================
        // 수배업체 관리 함수들
        // ============================================

        // 수배업체 목록 로드
        async function loadVendors() {
            try {
                const response = await fetch('/api/vendors');
                const data = await response.json();
                
                if (data.success) {
                    vendors = data.vendors;
                    renderVendors();
                } else {
                    showAlert('danger', '수배업체 목록을 불러오는데 실패했습니다.');
                }
            } catch (error) {
                console.error('수배업체 목록 로드 실패:', error);
                showAlert('danger', '수배업체 목록을 불러오는데 실패했습니다.');
            }
        }

        // 수배업체 목록 렌더링
        function renderVendors() {
            const vendorsList = document.getElementById('vendorsList');
            
            if (vendors.length === 0) {
                vendorsList.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-building fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">등록된 수배업체가 없습니다</h5>
                        <p class="text-muted">첫 번째 수배업체를 등록해보세요.</p>
                        <button class="btn btn-primary" onclick="openVendorModal()">
                            <i class="fas fa-plus me-2"></i>수배업체 등록
                        </button>
                    </div>
                `;
                return;
            }

            vendorsList.innerHTML = vendors.map(vendor => `
                <div class="vendor-card">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center mb-2">
                                <h5 class="mb-0 me-3">${vendor.vendor_name}</h5>
                                <span class="vendor-status ${vendor.is_active ? 'vendor-active' : 'vendor-inactive'}">
                                    ${vendor.is_active ? '활성' : '비활성'}
                                </span>
                            </div>
                            <div class="text-muted mb-2">
                                <i class="fas fa-user me-1"></i>${vendor.contact_person || '담당자 미등록'}
                                <i class="fas fa-envelope ms-3 me-1"></i>${vendor.email}
                                ${vendor.phone ? `<i class="fas fa-phone ms-3 me-1"></i>${vendor.phone}` : ''}
                            </div>
                            <div class="text-muted mb-2">
                                <i class="fas fa-briefcase me-1"></i>${vendor.business_type || '업종 미분류'}
                                <i class="fas fa-chart-bar ms-3 me-1"></i>담당상품 ${vendor.product_count}개
                                <i class="fas fa-tasks ms-3 me-1"></i>수배내역 ${vendor.assignment_count}건
                            </div>
                            ${vendor.description ? `<p class="text-muted small mb-0">${vendor.description}</p>` : ''}
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="editVendor(${vendor.id})">
                                <i class="fas fa-edit me-1"></i>수정
                            </button>
                            <button class="btn btn-outline-info btn-sm me-2" onclick="viewVendorDetails(${vendor.id})">
                                <i class="fas fa-eye me-1"></i>상세
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteVendor(${vendor.id}, '${vendor.vendor_name}')">
                                <i class="fas fa-trash me-1"></i>삭제
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 수배업체 등록 모달 열기
        function openVendorModal(vendorId = null) {
            editingVendorId = vendorId;
            const modal = new bootstrap.Modal(document.getElementById('vendorModal'));
            const title = document.getElementById('vendorModalTitle');
            const passwordHelp = document.getElementById('passwordHelp');
            
            if (vendorId) {
                title.textContent = '수배업체 수정';
                passwordHelp.style.display = 'block';
                loadVendorForEdit(vendorId);
            } else {
                title.textContent = '수배업체 등록';
                passwordHelp.style.display = 'none';
                document.getElementById('vendorForm').reset();
                document.getElementById('vendorId').value = '';
                resetProductKeywords();
            }
            
            modal.show();
        }

        // 수배업체 정보 로드 (수정용)
        async function loadVendorForEdit(vendorId) {
            try {
                const response = await fetch(`/api/vendors/${vendorId}`);
                const data = await response.json();
                
                if (data.success) {
                    const vendor = data.vendor;
                    
                    // 기본 정보 채우기
                    document.getElementById('vendorId').value = vendor.id;
                    document.getElementById('vendor_name').value = vendor.vendor_name;
                    document.getElementById('vendor_id').value = vendor.vendor_id;
                    document.getElementById('email').value = vendor.email;
                    document.getElementById('phone').value = vendor.phone || '';
                    document.getElementById('contact_person').value = vendor.contact_person || '';
                    document.getElementById('business_type').value = vendor.business_type || '';
                    document.getElementById('description').value = vendor.description || '';
                    document.getElementById('notification_email').value = vendor.notification_email || '';
                    
                    // 담당 상품 키워드 채우기
                    resetProductKeywords();
                    data.products.forEach((product, index) => {
                        if (index > 0) addProductKeyword();
                        const rows = document.querySelectorAll('.product-keyword-row');
                        const row = rows[index];
                        row.querySelector('input[name="product_keyword"]').value = product.product_keyword;
                        row.querySelector('select[name="product_priority"]').value = product.priority;
                    });
                    
                } else {
                    showAlert('danger', '수배업체 정보를 불러오는데 실패했습니다.');
                }
            } catch (error) {
                console.error('수배업체 정보 로드 실패:', error);
                showAlert('danger', '수배업체 정보를 불러오는데 실패했습니다.');
            }
        }

        // 수배업체 저장
        async function saveVendor() {
            const form = document.getElementById('vendorForm');
            const formData = new FormData(form);
            
            // 담당 상품 키워드 수집
            const products = [];
            const keywordInputs = document.querySelectorAll('input[name="product_keyword"]');
            const prioritySelects = document.querySelectorAll('select[name="product_priority"]');
            
            keywordInputs.forEach((input, index) => {
                if (input.value.trim()) {
                    products.push({
                        keyword: input.value.trim(),
                        priority: parseInt(prioritySelects[index].value)
                    });
                }
            });
            
            const vendorData = {
                vendor_name: formData.get('vendor_name'),
                vendor_id: formData.get('vendor_id'),
                password: formData.get('password'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                contact_person: formData.get('contact_person'),
                business_type: formData.get('business_type'),
                description: formData.get('description'),
                notification_email: formData.get('notification_email'),
                products: products
            };
            
            try {
                const url = editingVendorId ? `/api/vendors/${editingVendorId}` : '/api/vendors';
                const method = editingVendorId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(vendorData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('success', data.message);
                    bootstrap.Modal.getInstance(document.getElementById('vendorModal')).hide();
                    loadVendors();
                } else {
                    showAlert('danger', data.message);
                }
                
            } catch (error) {
                console.error('수배업체 저장 실패:', error);
                showAlert('danger', '수배업체 저장에 실패했습니다.');
            }
        }

        // 수배업체 수정
        function editVendor(vendorId) {
            openVendorModal(vendorId);
        }

        // 수배업체 삭제
        async function deleteVendor(vendorId, vendorName) {
            if (!confirm(`'${vendorName}' 업체를 정말 삭제하시겠습니까?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/vendors/${vendorId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('success', data.message);
                    loadVendors();
                } else {
                    showAlert('danger', data.message);
                }
                
            } catch (error) {
                console.error('수배업체 삭제 실패:', error);
                showAlert('danger', '수배업체 삭제에 실패했습니다.');
            }
        }

        // 수배업체 상세 보기
        function viewVendorDetails(vendorId) {
            // TODO: 상세 모달 구현
            alert('상세 보기 기능은 곧 추가될 예정입니다.');
        }

        // 상품명 추가
        function addProductKeyword() {
            const container = document.getElementById('productKeywords');
            const newRow = document.createElement('div');
            newRow.className = 'row mb-2 product-keyword-row';
            newRow.innerHTML = `
                <div class="col-md-8">
                    <input type="text" class="form-control" placeholder="예: 스타돌핀크루즈, 괌 별빛투어, 레오팔레스 골프 18홀" name="product_keyword">
                </div>
                <div class="col-md-3">
                    <select class="form-select" name="product_priority">
                        <option value="1">높음 (1)</option>
                        <option value="2">보통 (2)</option>
                        <option value="3">낮음 (3)</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeProductKeyword(this)">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            `;
            container.appendChild(newRow);
        }

        // 상품 키워드 제거
        function removeProductKeyword(button) {
            const rows = document.querySelectorAll('.product-keyword-row');
            if (rows.length > 1) {
                button.closest('.product-keyword-row').remove();
            }
        }

        // 상품명 초기화
        function resetProductKeywords() {
            const container = document.getElementById('productKeywords');
            container.innerHTML = `
                <div class="row mb-2 product-keyword-row">
                    <div class="col-md-8">
                        <input type="text" class="form-control" placeholder="예: 스타돌핀크루즈, 괌 별빛투어, 레오팔레스 골프 18홀" name="product_keyword">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" name="product_priority">
                            <option value="1">높음 (1)</option>
                            <option value="2">보통 (2)</option>
                            <option value="3">낮음 (3)</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeProductKeyword(this)">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        // 알림 표시
        function showAlert(type, message, targetArea = 'alertArea') {
            const alertArea = document.getElementById(targetArea);
            const alertId = 'alert-' + Date.now();
            
            alertArea.innerHTML = `
                <div class="alert alert-${type} alert-custom alert-dismissible fade show" id="${alertId}" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // 5초 후 자동 제거
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    bootstrap.Alert.getOrCreateInstance(alert).close();
                }
            }, 5000);
        }

        // 금액 포맷팅
        function formatCurrency(amount) {
            if (!amount) return '$0';
            return '$' + Number(amount).toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            });
        }

        // ==================== 직원 관리 기능 ====================

        // 직원 목록 로드
        async function loadStaff() {
            try {
                const response = await fetch('/api/admin-users');
                const data = await response.json();
                
                if (data.success) {
                    staffList = data.users;
                    renderStaff();
                } else {
                    showAlert('danger', '직원 목록을 불러오는데 실패했습니다.', 'staffAlertArea');
                }
            } catch (error) {
                console.error('직원 목록 로드 실패:', error);
                showAlert('danger', '직원 목록을 불러오는데 실패했습니다.', 'staffAlertArea');
            }
        }

        // 직원 목록 렌더링
        function renderStaff() {
            const staffListEl = document.getElementById('staffList');
            
            if (staffList.length === 0) {
                staffListEl.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">등록된 직원이 없습니다</h5>
                        <p class="text-muted">첫 번째 직원을 등록해보세요.</p>
                        <button class="btn btn-primary" onclick="openStaffModal()">
                            <i class="fas fa-plus me-2"></i>직원 등록
                        </button>
                    </div>
                `;
                return;
            }

            const getRoleBadge = (role) => {
                const roles = {
                    'admin': { class: 'danger', text: '관리자' },
                    'manager': { class: 'warning', text: '매니저' },
                    'staff': { class: 'info', text: '일반직원' }
                };
                const roleInfo = roles[role] || roles['staff'];
                return `<span class="badge bg-${roleInfo.class}">${roleInfo.text}</span>`;
            };

            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                return new Date(dateStr).toLocaleString('ko-KR');
            };

            staffListEl.innerHTML = staffList.map(staff => `
                <div class="vendor-card">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center mb-2">
                                <h5 class="mb-0 me-3">${staff.full_name}</h5>
                                ${getRoleBadge(staff.role)}
                                <span class="vendor-status ms-2 ${staff.is_active ? 'vendor-active' : 'vendor-inactive'}">
                                    ${staff.is_active ? '활성' : '비활성'}
                                </span>
                            </div>
                            <div class="text-muted mb-2">
                                <i class="fas fa-user me-1"></i>아이디: ${staff.username}
                                ${staff.email ? `<i class="fas fa-envelope ms-3 me-1"></i>${staff.email}` : ''}
                                ${staff.phone ? `<i class="fas fa-phone ms-3 me-1"></i>${staff.phone}` : ''}
                            </div>
                            <div class="text-muted small">
                                <i class="fas fa-calendar me-1"></i>등록일: ${formatDate(staff.created_at)}
                                ${staff.last_login ? `<i class="fas fa-clock ms-3 me-1"></i>마지막 로그인: ${formatDate(staff.last_login)}` : ''}
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="editStaff(${staff.id})">
                                <i class="fas fa-edit me-1"></i>수정
                            </button>
                            ${staff.username !== 'admin' ? `
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteStaff(${staff.id}, '${staff.full_name}')">
                                    <i class="fas fa-trash me-1"></i>삭제
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 직원 등록 모달 열기
        function openStaffModal(staffId = null) {
            editingStaffId = staffId;
            const modal = new bootstrap.Modal(document.getElementById('staffModal'));
            const title = document.getElementById('staffModalTitle');
            const passwordHelp = document.getElementById('staffPasswordHelp');
            const passwordInput = document.getElementById('staff_password');
            const usernameInput = document.getElementById('staff_username');
            
            if (staffId) {
                title.textContent = '직원 수정';
                passwordHelp.style.display = 'block';
                passwordInput.removeAttribute('required');
                usernameInput.setAttribute('readonly', true);
                loadStaffForEdit(staffId);
            } else {
                title.textContent = '직원 등록';
                passwordHelp.style.display = 'none';
                passwordInput.setAttribute('required', true);
                usernameInput.removeAttribute('readonly');
                document.getElementById('staffForm').reset();
                document.getElementById('staffId').value = '';
                document.getElementById('staff_is_active').checked = true;
            }
            
            modal.show();
        }

        // 직원 정보 로드 (수정용)
        async function loadStaffForEdit(staffId) {
            const staff = staffList.find(s => s.id === staffId);
            if (staff) {
                document.getElementById('staffId').value = staff.id;
                document.getElementById('staff_username').value = staff.username;
                document.getElementById('staff_full_name').value = staff.full_name;
                document.getElementById('staff_email').value = staff.email || '';
                document.getElementById('staff_phone').value = staff.phone || '';
                document.getElementById('staff_role').value = staff.role;
                document.getElementById('staff_is_active').checked = staff.is_active;
            }
        }

        // 직원 저장
        async function saveStaff() {
            const staffId = document.getElementById('staffId').value;
            const username = document.getElementById('staff_username').value.trim();
            const password = document.getElementById('staff_password').value;
            const full_name = document.getElementById('staff_full_name').value.trim();
            const email = document.getElementById('staff_email').value.trim();
            const phone = document.getElementById('staff_phone').value.trim();
            const role = document.getElementById('staff_role').value;
            const is_active = document.getElementById('staff_is_active').checked;

            // 필수 필드 검증
            if (!username || !full_name) {
                showAlert('danger', '아이디와 이름은 필수입니다.', 'staffAlertArea');
                return;
            }

            if (!staffId && !password) {
                showAlert('danger', '비밀번호는 필수입니다.', 'staffAlertArea');
                return;
            }

            const staffData = {
                username,
                full_name,
                email,
                phone,
                role,
                is_active
            };

            if (password) {
                staffData.password = password;
            }

            try {
                const url = staffId ? `/api/admin-users/${staffId}` : '/api/admin-users';
                const method = staffId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(staffData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('success', data.message, 'staffAlertArea');
                    bootstrap.Modal.getInstance(document.getElementById('staffModal')).hide();
                    loadStaff();
                } else {
                    showAlert('danger', data.message, 'staffAlertArea');
                }
                
            } catch (error) {
                console.error('직원 저장 실패:', error);
                showAlert('danger', '직원 저장에 실패했습니다.', 'staffAlertArea');
            }
        }

        // 직원 수정
        function editStaff(staffId) {
            openStaffModal(staffId);
        }

        // 직원 삭제
        async function deleteStaff(staffId, staffName) {
            if (!confirm(`'${staffName}' 직원을 정말 삭제하시겠습니까?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin-users/${staffId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('success', data.message, 'staffAlertArea');
                    loadStaff();
                } else {
                    showAlert('danger', data.message, 'staffAlertArea');
                }
                
            } catch (error) {
                console.error('직원 삭제 실패:', error);
                showAlert('danger', '직원 삭제에 실패했습니다.', 'staffAlertArea');
            }
        }
    </script>
</body>
</html>
