<div class="alert alert-info">
  <i class="bi bi-info-circle"></i>
  <strong>날짜별 + 연박별 요금 등록</strong><br>
  각 날짜마다 연박 조건에 따라 다른 요금을 설정할 수 있습니다.<br>
  예: 7월 15일 - 1박 $200, 2박 $180, 3박 이상 $160
</div>

<div class="row mb-3">
  <div class="col-md-6">
    <label class="form-label">객실 타입 선택</label>
    <select class="form-select" id="rateRoomType" onchange="renderRateCalendar()">
      <option value="">먼저 Step 1에서 호텔을 선택하세요</option>
    </select>
  </div>
  <div class="col-md-6">
    <label class="form-label">통화</label>
    <select class="form-select" id="rateCurrency">
      <option value="USD">USD</option>
      <option value="KRW">KRW</option>
    </select>
  </div>
</div>

<div class="alert alert-success" id="rateDateRangeInfo" style="display:none;">
  <i class="bi bi-calendar-range"></i>
  투숙 기간: <strong><span id="rateDateRangeText"></span></strong>
  <span class="text-muted ms-2">(Step 1에서 설정된 기간의 달력이 표시됩니다)</span>
</div>

<div class="row mb-3">
  <div class="col-12">
    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAllDates()">
      <i class="bi bi-check-square"></i> 전체 선택
    </button>
    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllDates()">
      <i class="bi bi-square"></i> 선택 해제
    </button>
    <span class="ms-3 text-muted">
      <i class="bi bi-info-circle"></i> 날짜를 클릭하여 선택 후 아래에서 요금을 입력하세요
    </span>
  </div>
</div>

<!-- 달력 표시 -->
<div id="rateCalendarContainer"></div>

<!-- 선택된 날짜 요금 입력 -->
<div id="rateInputSection" style="display: none;">
  <hr>
  <h6>
    <i class="bi bi-calendar-check"></i> 선택된 날짜 요금 입력
    <span class="badge bg-primary ms-2" id="selectedDateCount">0</span>개 날짜 선택됨
  </h6>
  
  <div class="rate-input-group">
    <div class="row g-2 mb-2">
      <div class="col-md-2">
        <label class="form-label small">1박 요금</label>
        <input type="number" class="form-control" id="rate1Night" placeholder="200.00" step="0.01">
      </div>
      <div class="col-md-2">
        <label class="form-label small">2박 요금</label>
        <input type="number" class="form-control" id="rate2Nights" placeholder="180.00" step="0.01">
      </div>
      <div class="col-md-2">
        <label class="form-label small">3박 요금</label>
        <input type="number" class="form-control" id="rate3Nights" placeholder="160.00" step="0.01">
      </div>
      <div class="col-md-2">
        <label class="form-label small">4박+ 요금</label>
        <input type="number" class="form-control" id="rate4PlusNights" placeholder="150.00" step="0.01">
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <button type="button" class="btn btn-primary w-100" onclick="applyRatesToSelected()">
          <i class="bi bi-check-circle"></i> 선택 날짜에 적용
        </button>
      </div>
    </div>
    <div class="text-muted small">
      <i class="bi bi-info-circle"></i> 각 연박 조건별로 1박당 요금을 입력하세요. 
      예: 3박 예약시 총 요금 = $160 × 3박 = $480 / 4박 이상은 4박+ 요금 적용
    </div>
  </div>
</div>

<!-- 저장된 요금 목록 -->
<div class="mt-4">
  <h6><i class="bi bi-list-check"></i> 등록된 요금 목록</h6>
  <div id="savedRatesList"></div>
</div>

<script>
  let selectedDates = new Set();
  let rateCalendarData = {};  // { 'YYYY-MM-DD_roomTypeId': { room_type_id, rates: [{ min_nights, rate }] } }
  let currentRoomTypes = [];
  
  // 호텔 변경 시 객실 타입 로드
  document.getElementById('hotelId').addEventListener('change', async function() {
    const hotelId = this.value;
    if (!hotelId) {
      document.getElementById('rateRoomType').innerHTML = '<option value="">먼저 호텔을 선택하세요</option>';
      return;
    }
    
    const res = await fetch(`/api/room-types?hotel_id=${hotelId}&is_active=true`);
    currentRoomTypes = await res.json();
    
    const select = document.getElementById('rateRoomType');
    select.innerHTML = '<option value="">객실 타입 선택</option>' + 
      currentRoomTypes.map(rt => `<option value="${rt.id}">${rt.room_type_name}</option>`).join('');
  });
  
  // 프로모션 수정 시 요금 데이터 로드
  async function loadPromoRates(promoId) {
    const res = await fetch(`/api/promotions/${promoId}/rates`);
    const rates = await res.json();
    
    rateCalendarData = {};
    
    rates.forEach(r => {
      const dateStr = r.stay_date.split('T')[0];  // 날짜 포맷팅
      const key = `${dateStr}_${r.room_type_id}`;  // 날짜_룸타입 조합 키
      if (!rateCalendarData[key]) {
        rateCalendarData[key] = {
          room_type_id: r.room_type_id,
          rates: []
        };
      }
      rateCalendarData[key].rates.push({
        min_nights: r.min_nights,
        max_nights: r.max_nights,
        rate_per_night: parseFloat(r.rate_per_night)
      });
    });
    
    renderRateCalendar();
    renderSavedRates();
  }
  
  function renderRateCalendar() {
    const roomTypeId = document.getElementById('rateRoomType').value;
    const stayStartDate = document.getElementById('stayStartDate').value;
    const stayEndDate = document.getElementById('stayEndDate').value;
    
    if (!roomTypeId) {
      document.getElementById('rateCalendarContainer').innerHTML = '<div class="text-muted">객실 타입을 선택하세요</div>';
      return;
    }
    
    if (!stayStartDate || !stayEndDate) {
      document.getElementById('rateCalendarContainer').innerHTML = '<div class="text-muted">Step 1에서 투숙 기간을 먼저 입력하세요</div>';
      document.getElementById('rateDateRangeInfo').style.display = 'none';
      return;
    }
    
    // 기간 정보 표시
    document.getElementById('rateDateRangeInfo').style.display = 'block';
    document.getElementById('rateDateRangeText').textContent = `${stayStartDate} ~ ${stayEndDate}`;
    
    // 시작일과 종료일 파싱
    const startDate = new Date(stayStartDate);
    const endDate = new Date(stayEndDate);
    
    // 시작 월과 종료 월 계산
    const startYear = startDate.getFullYear();
    const startMonth = startDate.getMonth() + 1;
    const endYear = endDate.getFullYear();
    const endMonth = endDate.getMonth() + 1;
    
    const container = document.getElementById('rateCalendarContainer');
    let html = '';
    
    // 투숙 기간의 모든 월 렌더링
    let currentYear = startDate.getFullYear();
    let currentMonth = startDate.getMonth() + 1;
    
    while (currentYear < endDate.getFullYear() || (currentYear === endDate.getFullYear() && currentMonth <= endDate.getMonth() + 1)) {
      const firstDay = new Date(currentYear, currentMonth - 1, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
      
      html += `<div class="mb-4">`;
      html += `<h6>${currentYear}년 ${currentMonth}월</h6>`;
      html += `<div class="calendar-grid">`;
      
      // 요일 헤더
      const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
      weekdays.forEach(day => {
        html += `<div class="calendar-header">${day}</div>`;
      });
      
      // 빈 칸
      for (let i = 0; i < firstDay; i++) {
        html += `<div></div>`;
      }
      
      // 날짜
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const currentDate = new Date(dateStr);
        const key = `${dateStr}_${roomTypeId}`;  // 날짜_룸타입 조합 키
        
        // 투숙 기간 내의 날짜인지 확인
        const isInRange = currentDate >= startDate && currentDate <= endDate;
        const hasRate = rateCalendarData[key] && rateCalendarData[key].room_type_id == roomTypeId;
        const isSelected = selectedDates.has(dateStr);
        
        // 요금 표시
        let rateDisplay = '';
        if (hasRate) {
          const rates = rateCalendarData[key].rates;
          const rate1 = rates.find(r => r.min_nights === 1)?.rate_per_night;
          const rate2 = rates.find(r => r.min_nights === 2)?.rate_per_night;
          const rate3 = rates.find(r => r.min_nights === 3)?.rate_per_night;
          const rate4 = rates.find(r => r.min_nights === 4)?.rate_per_night;
          rateDisplay = `<div class="small" style="font-size:0.65rem;line-height:1.1;">`;
          if (rate1) rateDisplay += `1박:$${rate1}<br>`;
          if (rate2) rateDisplay += `2박:$${rate2}<br>`;
          if (rate3) rateDisplay += `3박:$${rate3}<br>`;
          if (rate4) rateDisplay += `4박:$${rate4}`;
          rateDisplay += `</div>`;
        }
        
        // 기간 외 날짜는 비활성화
        const disabledClass = !isInRange ? 'disabled' : '';
        const clickHandler = isInRange ? `onclick="toggleDate('${dateStr}')"` : '';
        
        html += `<div class="calendar-day ${isSelected ? 'selected' : ''} ${hasRate ? 'has-rate' : ''} ${disabledClass}" 
                      ${clickHandler}>
                  <div><strong>${day}</strong></div>
                  ${rateDisplay}
                </div>`;
      }
      
      html += `</div></div>`;
      
      // 다음 월로 이동
      currentMonth++;
      if (currentMonth > 12) {
        currentMonth = 1;
        currentYear++;
      }
    }
    
    container.innerHTML = html;
  }
  
  function toggleDate(dateStr) {
    if (selectedDates.has(dateStr)) {
      selectedDates.delete(dateStr);
    } else {
      selectedDates.add(dateStr);
    }
    
    renderRateCalendar();
    updateRateInputSection();
  }
  
  function selectAllDates() {
    const stayStartDate = document.getElementById('stayStartDate').value;
    const stayEndDate = document.getElementById('stayEndDate').value;
    
    if (!stayStartDate || !stayEndDate) {
      alert('Step 1에서 투숙 기간을 먼저 입력하세요');
      return;
    }
    
    const startDate = new Date(stayStartDate);
    const endDate = new Date(stayEndDate);
    
    // 기간 내 모든 날짜 선택
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
      const dateStr = d.toISOString().split('T')[0];
      selectedDates.add(dateStr);
    }
    
    renderRateCalendar();
    updateRateInputSection();
  }
  
  function deselectAllDates() {
    selectedDates.clear();
    renderRateCalendar();
    updateRateInputSection();
  }
  
  function updateRateInputSection() {
    const section = document.getElementById('rateInputSection');
    const count = document.getElementById('selectedDateCount');
    
    if (selectedDates.size > 0) {
      section.style.display = 'block';
      count.textContent = selectedDates.size;
    } else {
      section.style.display = 'none';
    }
  }
  
  function applyRatesToSelected() {
    const roomTypeId = document.getElementById('rateRoomType').value;
    const rate1 = parseFloat(document.getElementById('rate1Night').value);
    const rate2 = parseFloat(document.getElementById('rate2Nights').value);
    const rate3 = parseFloat(document.getElementById('rate3Nights').value);
    const rate4 = parseFloat(document.getElementById('rate4PlusNights').value);
    
    if (!roomTypeId) {
      alert('객실 타입을 선택하세요');
      return;
    }
    
    if (!rate1 && !rate2 && !rate3 && !rate4) {
      alert('최소 하나의 요금을 입력하세요');
      return;
    }
    
    const count = selectedDates.size;
    
    selectedDates.forEach(dateStr => {
      const key = `${dateStr}_${roomTypeId}`;  // 날짜_룸타입 조합 키
      if (!rateCalendarData[key]) {
        rateCalendarData[key] = {
          room_type_id: parseInt(roomTypeId),
          rates: []
        };
      }
      
      // 기존 요금 제거
      rateCalendarData[key].rates = [];
      
      // 새 요금 추가
      if (rate1) {
        rateCalendarData[key].rates.push({ min_nights: 1, max_nights: 1, rate_per_night: rate1 });
      }
      if (rate2) {
        rateCalendarData[key].rates.push({ min_nights: 2, max_nights: 2, rate_per_night: rate2 });
      }
      if (rate3) {
        rateCalendarData[key].rates.push({ min_nights: 3, max_nights: 3, rate_per_night: rate3 });
      }
      if (rate4) {
        rateCalendarData[key].rates.push({ min_nights: 4, max_nights: null, rate_per_night: rate4 });
      }
    });
    
    // 입력 필드 초기화
    document.getElementById('rate1Night').value = '';
    document.getElementById('rate2Nights').value = '';
    document.getElementById('rate3Nights').value = '';
    document.getElementById('rate4PlusNights').value = '';
    
    selectedDates.clear();
    renderRateCalendar();
    updateRateInputSection();
    renderSavedRates();
    
    alert(`${count}개 날짜에 요금이 적용되었습니다`);
  }
  
  function renderSavedRates() {
    const container = document.getElementById('savedRatesList');
    const roomTypeId = document.getElementById('rateRoomType').value;
    
    if (!roomTypeId) {
      container.innerHTML = '<div class="text-muted">객실 타입을 선택하세요</div>';
      return;
    }
    
    const roomTypeName = currentRoomTypes.find(rt => rt.id == roomTypeId)?.room_type_name || '';
    const dates = Object.keys(rateCalendarData)
      .filter(key => key.endsWith(`_${roomTypeId}`))
      .map(key => key.split('_')[0])  // 날짜 부분만 추출
      .sort();
    
    if (dates.length === 0) {
      container.innerHTML = '<div class="text-muted">등록된 요금이 없습니다</div>';
      return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-sm table-bordered">';
    html += '<thead><tr><th>날짜</th><th>1박</th><th>2박</th><th>3박</th><th>4박+</th><th></th></tr></thead><tbody>';
    
    dates.forEach(date => {
      const key = `${date}_${roomTypeId}`;
      const data = rateCalendarData[key];
      const rate1 = data.rates.find(r => r.min_nights === 1)?.rate_per_night || '-';
      const rate2 = data.rates.find(r => r.min_nights === 2)?.rate_per_night || '-';
      const rate3 = data.rates.find(r => r.min_nights === 3)?.rate_per_night || '-';
      const rate4 = data.rates.find(r => r.min_nights === 4)?.rate_per_night || '-';
      
      html += `<tr>
        <td>${date}</td>
        <td>${rate1}</td>
        <td>${rate2}</td>
        <td>${rate3}</td>
        <td>${rate4}</td>
        <td><button class="btn btn-sm btn-danger" onclick="deleteRate('${date}')"><i class="bi bi-trash"></i></button></td>
      </tr>`;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
  }
  
  function deleteRate(dateStr) {
    const roomTypeId = document.getElementById('rateRoomType').value;
    const key = `${dateStr}_${roomTypeId}`;
    if (confirm(`${dateStr} 요금을 삭제하시겠습니까?`)) {
      delete rateCalendarData[key];
      renderRateCalendar();
      renderSavedRates();
    }
  }
  
  // 요금 저장 함수 (메인 파일에서 호출)
  async function savePromoRates(promoId) {
    const currency = document.getElementById('rateCurrency').value;
    const rates = [];
    
    Object.keys(rateCalendarData).forEach(dateStr => {
      const data = rateCalendarData[dateStr];
      data.rates.forEach(r => {
        rates.push({
          room_type_id: data.room_type_id,
          stay_date: dateStr,
          min_nights: r.min_nights,
          max_nights: r.max_nights,
          rate_per_night: r.rate_per_night,
          currency: currency
        });
      });
    });
    
    if (rates.length === 0) {
      return;  // 요금이 없으면 스킵
    }
    
    const res = await fetch(`/api/promotions/${promoId}/rates`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ rates })
    });
    
    const result = await res.json();
    if (result.error) {
      alert('요금 저장 실패: ' + result.error);
      throw new Error(result.error);
    }
    
    console.log(`${result.count}개 요금 저장 완료`);
  }
</script>
