<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - 괌세이브카드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(45deg, #667eea, #764ba2) !important;
        }
        
        .content-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        
        .pagination {
            justify-content: center;
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar', { currentPage: 'users', adminUsername: adminUsername }) %>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-users me-2"></i><%= title %></h2>
                <p class="text-muted">발급된 할인카드를 관리합니다</p>
            </div>
        </div>

        <!-- 검색 필터 -->
        <div class="content-card mb-3">
            <h5><i class="fas fa-search me-2"></i>고객 검색</h5>
            <form method="GET" action="/admin/users" class="row g-3">
                <div class="col-md-8">
                    <input type="text" class="form-control" name="search" 
                           placeholder="고객명 또는 이메일로 검색..." 
                           value="<%= search %>" autocomplete="off">
                </div>
                <div class="col-md-4">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i>검색
                        </button>
                        <% if (search) { %>
                            <a href="/admin/users" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-1"></i>초기화
                            </a>
                        <% } %>
                    </div>
                </div>
            </form>
            
            <% if (search) { %>
                <div class="mt-3">
                    <small class="text-muted">
                        '<%= search %>' 검색 결과: <strong><%= totalUsers %>명</strong>
                    </small>
                </div>
            <% } else { %>
                <div class="mt-3">
                    <small class="text-muted">
                        전체 고객: <strong><%= totalUsers %>명</strong> (최신 발급순)
                    </small>
                </div>
            <% } %>
        </div>

        <!-- 고객 목록 -->
        <div class="content-card">
            <h5><i class="fas fa-list me-2"></i>발급된 카드 목록</h5>
            
            <% if (users && users.length > 0) { %>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>고객명</th>
                                <th>이메일</th>
                                <th>여행사</th>
                                <th>토큰</th>
                                <th>사용 횟수</th>
                                <th>발급일</th>
                                <th>액션</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% users.forEach(user => { %>
                                <tr>
                                    <td><strong><%= user.name || user.customer_name || '-' %></strong></td>
                                    <td><%= user.email || '-' %></td>
                                    <td><%= user.agency_name || '-' %></td>
                                    <td>
                                        <code class="small"><%= user.token.substring(0, 8) %>...</code>
                                        <button class="btn btn-sm btn-outline-secondary ms-1" 
                                                onclick="copyToken('<%= user.token %>')">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary"><%= user.usage_count %>회</span>
                                    </td>
                                    <td><%= new Date(user.created_at).toLocaleDateString('ko-KR') %></td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button onclick="viewCard('<%= user.token %>')" 
                                                    class="btn btn-sm btn-outline-primary"
                                                    title="카드 정보 보기">
                                                <i class="fas fa-credit-card me-1"></i>카드 보기
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger btn-delete-user"
                                                    data-user-id="<%= user.id %>"
                                                    data-user-name="<%= user.name || user.customer_name || '고객' %>"
                                                    title="카드 삭제">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>

                <!-- 페이지네이션 -->
                <% if (totalPages > 1) { %>
                    <nav>
                        <ul class="pagination">
                            <% 
                                // 검색 파라미터를 URL에 유지하기 위한 함수
                                function buildPageUrl(page) {
                                    const params = new URLSearchParams();
                                    params.set('page', page);
                                    if (search) params.set('search', search);
                                    return '?' + params.toString();
                                }
                            %>
                            <% if (currentPage > 1) { %>
                                <li class="page-item">
                                    <a class="page-link" href="<%= buildPageUrl(currentPage - 1) %>">이전</a>
                                </li>
                            <% } %>
                            
                            <% for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) { %>
                                <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                    <a class="page-link" href="<%= buildPageUrl(i) %>"><%= i %></a>
                                </li>
                            <% } %>
                            
                            <% if (currentPage < totalPages) { %>
                                <li class="page-item">
                                    <a class="page-link" href="<%= buildPageUrl(currentPage + 1) %>">다음</a>
                                </li>
                            <% } %>
                        </ul>
                    </nav>
                <% } %>
            <% } else { %>
                <div class="text-center text-muted py-5">
                    <i class="fas fa-users fa-3x mb-3"></i>
                    <p>발급된 카드가 없습니다.</p>
                </div>
            <% } %>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 카드 정보 모달 -->
    <div class="modal fade" id="cardInfoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-credit-card me-2"></i>카드 정보</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="cardInfoContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">로딩 중...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function copyToken(token) {
            navigator.clipboard.writeText(token).then(() => {
                alert('토큰이 클립보드에 복사되었습니다.');
            }).catch(() => {
                prompt('토큰을 복사하세요:', token);
            });
        }

        // 삭제 버튼 이벤트 리스너
        document.addEventListener('DOMContentLoaded', function() {
            const deleteButtons = document.querySelectorAll('.btn-delete-user');
            deleteButtons.forEach(btn => {
                btn.addEventListener('click', async function() {
                    const userId = this.dataset.userId;
                    const userName = this.dataset.userName;
                    
                    if (!confirm(`정말로 "${userName}" 고객의 카드를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없으며, 해당 고객의 모든 사용 이력도 함께 삭제됩니다.`)) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/admin/users/${userId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            alert('카드가 성공적으로 삭제되었습니다.');
                            location.reload();
                        } else {
                            alert('삭제 실패: ' + (data.message || '알 수 없는 오류가 발생했습니다.'));
                        }
                    } catch (error) {
                        console.error('삭제 오류:', error);
                        alert('삭제 중 오류가 발생했습니다.');
                    }
                });
            });
        });

        async function viewCard(token) {
            const modal = new bootstrap.Modal(document.getElementById('cardInfoModal'));
            const content = document.getElementById('cardInfoContent');
            
            // 로딩 표시
            content.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">로딩 중...</span>
                    </div>
                </div>
            `;
            
            modal.show();
            
            try {
                const response = await fetch(`/admin/card-info/${token}`);
                const data = await response.json();
                
                if (data.success) {
                    const user = data.user;
                    const usages = data.usages;
                    
                    content.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-user me-2"></i>고객 정보</h6>
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <p><strong>이름:</strong> ${user.name || user.customer_name || '-'}</p>
                                        <p><strong>이메일:</strong> ${user.email || '-'}</p>
                                        <p><strong>여행사:</strong> ${user.agency_name || '-'}</p>
                                        <p><strong>발급일:</strong> ${new Date(user.created_at).toLocaleDateString('ko-KR')}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-qrcode me-2"></i>QR 코드</h6>
                                <div class="text-center">
                                    <img src="${user.qr_code}" alt="QR Code" class="img-fluid" style="max-width: 200px;">
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <h6><i class="fas fa-history me-2"></i>최근 사용 이력 (최대 10개)</h6>
                        ${usages.length > 0 ? `
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>사용일시</th>
                                            <th>매장명</th>
                                            <th>할인금액</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${usages.map(usage => `
                                            <tr>
                                                <td>${new Date(usage.used_at).toLocaleString('ko-KR')}</td>
                                                <td>${usage.store_name || '-'}</td>
                                                <td class="text-success">$${usage.discount_amount || 0}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<p class="text-muted">아직 사용 이력이 없습니다.</p>'}
                    `;
                } else {
                    content.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>${data.message}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('카드 정보 조회 오류:', error);
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>카드 정보를 불러오는 중 오류가 발생했습니다.
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
