<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í˜¸í…” ì •ì‚°ê´€ë¦¬ - ê´Œì„¸ì´ë¸Œì¹´ë“œ ê´€ë¦¬ì</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* PC í™”ë©´ì—ì„œ ê°€ë¡œí­ 1200px ê³ ì • */
        @media (min-width: 1200px) {
            .container-fluid {
                max-width: 1200px;
                margin: 0 auto;
            }
        }
        
        .status-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        .status-settled { background-color: #28a745; color: #fff; }
        .status-pending { background-color: #ffc107; color: #000; }
        .status-overdue { background-color: #dc3545; color: #fff; }
        
        .settlement-card {
            border-left: 4px solid #dee2e6;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .settlement-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .settlement-card.settled { border-left-color: #28a745; }
        .settlement-card.pending { border-left-color: #ffc107; }
        .settlement-card.overdue { border-left-color: #dc3545; }
        
        .stats-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #333;
            border-radius: 15px;
            border: 1px solid #dee2e6;
        }
        
        .stats-card .card-body {
            padding: 1rem;
        }
        
        .stats-card h3 {
            margin-bottom: 0.25rem;
            font-size: 1.5rem;
        }
        
        .stats-card h5 {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .stats-card .fa-2x {
            font-size: 1.5rem;
        }
        
        .stats-card small {
            font-size: 0.75rem;
        }
        
        .profit-positive { color: #28a745; font-weight: bold; }
        .profit-negative { color: #dc3545; font-weight: bold; }
        .profit-neutral { color: #6c757d; font-weight: bold; }

        .table-sm td, .table-sm th {
            padding: 0.3rem;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar', { currentPage: 'hotel-settlements' }) %>
    
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-hotel me-2"></i>í˜¸í…” ì •ì‚°ê´€ë¦¬</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-info" onclick="loadSettlements()">
                            <i class="fas fa-sync-alt me-1"></i>ìƒˆë¡œê³ ì¹¨
                        </button>
                        <button class="btn btn-outline-primary" onclick="openBulkPaymentModal()">
                            <i class="fas fa-money-bill-wave me-1"></i>ì¼ê´„ ì…ì¶œê¸ˆ
                        </button>
                    </div>
                </div>

                <!-- ì •ì‚° í†µê³„ -->
                <div class="row mb-3">
                    <!-- ë¯¸ì…ê¸ˆ ê±°ë˜ì•¡ -->
                    <div class="col-md-6">
                        <div class="card stats-card border-warning">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0"><i class="fas fa-arrow-down text-warning me-2"></i>ë¯¸ì…ê¸ˆ ê±°ë˜ì•¡</h5>
                                    <small class="text-muted">í˜„ì¬ ì‹œì </small>
                                </div>
                                <h3 class="text-warning mb-2" id="unpaidRevenue">â‚©0</h3>
                                <div id="unpaidByAgency" class="mt-2">
                                    <small class="text-muted">ê±°ë˜ì²˜ë³„ ì§‘ê³„ ë¡œë”© ì¤‘...</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ë¯¸ì†¡ê¸ˆ ë§¤ì…ì•¡ -->
                    <div class="col-md-6">
                        <div class="card stats-card border-danger">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0"><i class="fas fa-arrow-up text-danger me-2"></i>ë¯¸ì†¡ê¸ˆ ë§¤ì…ì•¡</h5>
                                    <small class="text-muted">í˜„ì¬ ì‹œì </small>
                                </div>
                                <h3 class="text-danger mb-2" id="unpaidCost">â‚©0</h3>
                                <div id="unpaidByHotel" class="mt-2">
                                    <small class="text-muted">í˜¸í…”ë³„ ì§‘ê³„ ë¡œë”© ì¤‘...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì›”ê°„ í†µê³„ -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card stats-card border-primary">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0"><i class="fas fa-chart-line text-primary me-2"></i>ì´ ë§ˆì§„</h5>
                                    <small class="text-muted">ì´ë²ˆ ë‹¬</small>
                                </div>
                                <h3 class="text-primary" id="monthlyMargin">â‚©0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card stats-card border-success">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0"><i class="fas fa-dollar-sign text-success me-2"></i>ê±°ë˜ì•¡ ì´ì•¡</h5>
                                    <small class="text-muted">ì´ë²ˆ ë‹¬</small>
                                </div>
                                <h3 class="text-success" id="monthlyRevenue">â‚©0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card stats-card border-info">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0"><i class="fas fa-shopping-cart text-info me-2"></i>ë§¤ì…ì•¡ ì´ì•¡</h5>
                                    <small class="text-muted">ì´ë²ˆ ë‹¬</small>
                                </div>
                                <h3 class="text-info" id="monthlyCost">â‚©0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- íƒ­ ë©”ë‰´ -->
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#pending">
                            <i class="fas fa-clock me-1"></i>ë¯¸ì™„ë£Œ ì •ì‚°
                            <span class="badge bg-warning text-dark ms-1" id="pendingCount">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#completed">
                            <i class="fas fa-check-circle me-1"></i>ì™„ë£Œëœ ì •ì‚°
                            <span class="badge bg-success ms-1" id="completedCount">0</span>
                        </a>
                    </li>
                </ul>

                <!-- íƒ­ ì»¨í…ì¸  -->
                <div class="tab-content">
                    <!-- ë¯¸ì™„ë£Œ ì •ì‚° -->
                    <div class="tab-pane fade show active" id="pending">
                        <div id="pendingList" class="row">
                            <div class="col-12 text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                                </div>
                                <p class="mt-2 text-muted">ì •ì‚° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                            </div>
                        </div>
                    </div>

                    <!-- ì™„ë£Œëœ ì •ì‚° -->
                    <div class="tab-pane fade" id="completed">
                        <div id="completedList" class="row">
                            <div class="col-12 text-center py-5">
                                <p class="text-muted">ì™„ë£Œëœ ì •ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì •ì‚° ìƒì„¸/ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal fade" id="settlementModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ì •ì‚° ìƒì„¸</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="settlementId">
                    
                    <!-- ì˜ˆì•½ ì •ë³´ -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>ì˜ˆì•½ ì •ë³´</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-2"><strong>ì˜ˆì•½ë²ˆí˜¸:</strong> <span id="detailReservationNumber"></span></p>
                                    <p class="mb-2"><strong>í˜¸í…”ëª…:</strong> <span id="detailHotelName"></span></p>
                                    <p class="mb-2"><strong>ê±°ë˜ì²˜:</strong> <span id="detailAgencyName"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-2"><strong>ì²´í¬ì¸:</strong> <span id="detailCheckIn"></span></p>
                                    <p class="mb-2"><strong>ì²´í¬ì•„ì›ƒ:</strong> <span id="detailCheckOut"></span></p>
                                    <p class="mb-2"><strong>íˆ¬ìˆ™ê°:</strong> <span id="detailGuestName"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì •ì‚° ê¸ˆì•¡ -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>ì •ì‚° ê¸ˆì•¡</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">ê±°ë˜ì•¡ (íŒë§¤ê°€)</label>
                                        <input type="number" class="form-control" id="detailSellingPrice" onchange="calculateProfit()">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">í™˜ìœ¨</label>
                                        <input type="number" class="form-control" id="detailExchangeRate" onchange="calculateProfit()">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">ë§¤ì…ì•¡ (í˜¸í…” ì†¡ê¸ˆì•¡)</label>
                                        <input type="number" class="form-control" id="detailCostPrice" onchange="calculateProfit()">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">ìˆ˜ë°°í”¼</label>
                                        <input type="number" class="form-control" id="detailAgencyFee" onchange="calculateProfit()">
                                    </div>
                                </div>
                            </div>

                            <!-- ê³„ì‚° ê²°ê³¼ -->
                            <div class="alert alert-info">
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>ë§ˆì§„:</strong> <span id="calculatedMargin">â‚©0</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>ê±°ë˜ì•¡(ì›í™”):</strong> <span id="calculatedRevenueKRW">â‚©0</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>ë§¤ì…ì•¡(ì›í™”):</strong> <span id="calculatedCostKRW">â‚©0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì…ì¶œê¸ˆ ì •ë³´ -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>ì…ì¶œê¸ˆ ì •ë³´</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">ì…ê¸ˆì¼</label>
                                        <input type="date" class="form-control" id="detailPaymentDate">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">ì†¡ê¸ˆì¼</label>
                                        <input type="date" class="form-control" id="detailTransferDate">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ë©”ëª¨</label>
                                <textarea class="form-control" id="detailMemo" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="deleteSettlement()">
                        <i class="fas fa-trash me-1"></i>ì‚­ì œ
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    <button type="button" class="btn btn-primary" onclick="saveSettlement()">
                        <i class="fas fa-save me-1"></i>ì €ì¥
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì¼ê´„ ì…ì¶œê¸ˆ ëª¨ë‹¬ -->
    <div class="modal fade" id="bulkPaymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ì¼ê´„ ì…ì¶œê¸ˆ ì²˜ë¦¬</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ì²˜ë¦¬ ìœ í˜•</label>
                        <select class="form-select" id="bulkPaymentType">
                            <option value="payment">ì…ê¸ˆ ì²˜ë¦¬</option>
                            <option value="transfer">ì†¡ê¸ˆ ì²˜ë¦¬</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì²˜ë¦¬ ë‚ ì§œ</label>
                        <input type="date" class="form-control" id="bulkPaymentDate">
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ë¯¸ì™„ë£Œ ì •ì‚° ì¤‘ ì„ íƒëœ í•­ëª©ë“¤ì´ ì¼ê´„ ì²˜ë¦¬ë©ë‹ˆë‹¤.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-primary" onclick="processBulkPayment()">
                        <i class="fas fa-check me-1"></i>ì²˜ë¦¬
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let settlements = [];
        let stats = {};

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        document.addEventListener('DOMContentLoaded', function() {
            loadSettlements();
        });

        // ì •ì‚° ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadSettlements() {
            try {
                console.log('ğŸ”„ ì •ì‚° ë°ì´í„° ë¡œë”© ì‹œì‘...');
                const response = await fetch('/api/hotel-settlements');
                console.log('ğŸ“¡ API ì‘ë‹µ ìƒíƒœ:', response.status);
                
                const data = await response.json();
                console.log('ğŸ“Š ë°›ì€ ë°ì´í„°:', data);
                
                settlements = data.settlements || [];
                stats = data.stats || {};
                
                console.log('âœ… ì •ì‚° ëª©ë¡ ê°œìˆ˜:', settlements.length);
                console.log('ğŸ“ˆ í†µê³„ ë°ì´í„°:', stats);
                
                renderStats();
                renderSettlements();
            } catch (error) {
                console.error('âŒ ì •ì‚° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ì •ì‚° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // í†µê³„ ë Œë”ë§
        function renderStats() {
            // ë¯¸ì…ê¸ˆ ê±°ë˜ì•¡
            document.getElementById('unpaidRevenue').textContent = formatCurrency(stats.unpaidRevenue || 0);
            
            // ë¯¸ì†¡ê¸ˆ ë§¤ì…ì•¡
            document.getElementById('unpaidCost').textContent = formatCurrency(stats.unpaidCost || 0);
            
            // ì›”ê°„ í†µê³„
            document.getElementById('monthlyMargin').textContent = formatCurrency(stats.monthlyMargin || 0);
            document.getElementById('monthlyRevenue').textContent = formatCurrency(stats.monthlyRevenue || 0);
            document.getElementById('monthlyCost').textContent = formatCurrency(stats.monthlyCost || 0);

            // ê±°ë˜ì²˜ë³„ ë¯¸ì…ê¸ˆ
            if (stats.unpaidByAgency && stats.unpaidByAgency.length > 0) {
                const html = stats.unpaidByAgency.map(item => 
                    `<small class="d-block"><strong>${item.agency_name}:</strong> ${formatCurrency(item.total)}</small>`
                ).join('');
                document.getElementById('unpaidByAgency').innerHTML = html;
            } else {
                document.getElementById('unpaidByAgency').innerHTML = '<small class="text-muted">ë¯¸ì…ê¸ˆ ë‚´ì—­ ì—†ìŒ</small>';
            }

            // í˜¸í…”ë³„ ë¯¸ì†¡ê¸ˆ
            if (stats.unpaidByHotel && stats.unpaidByHotel.length > 0) {
                const html = stats.unpaidByHotel.map(item => 
                    `<small class="d-block"><strong>${item.hotel_name}:</strong> ${formatCurrency(item.total)}</small>`
                ).join('');
                document.getElementById('unpaidByHotel').innerHTML = html;
            } else {
                document.getElementById('unpaidByHotel').innerHTML = '<small class="text-muted">ë¯¸ì†¡ê¸ˆ ë‚´ì—­ ì—†ìŒ</small>';
            }
        }

        // ì •ì‚° ëª©ë¡ ë Œë”ë§
        function renderSettlements() {
            const pending = settlements.filter(s => !s.is_settled);
            const completed = settlements.filter(s => s.is_settled);

            document.getElementById('pendingCount').textContent = pending.length;
            document.getElementById('completedCount').textContent = completed.length;

            renderSettlementList(pending, 'pendingList', false);
            renderSettlementList(completed, 'completedList', true);
        }

        function renderSettlementList(items, containerId, isCompleted) {
            const container = document.getElementById(containerId);
            
            if (items.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <p class="text-muted">${isCompleted ? 'ì™„ë£Œëœ' : 'ë¯¸ì™„ë£Œ'} ì •ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }

            // í•©ê³„ ê³„ì‚°
            let totalRevenueUSD = 0;
            let totalRevenueKRW = 0;
            let totalHotelCostUSD = 0;
            let totalHotelCostKRW = 0;
            let totalOutCostUSD = 0;
            let totalOutCostKRW = 0;
            let totalAgencyFee = 0;
            let totalMargin = 0;
            let totalTax = 0;

            const rows = items.map(item => {
                const revenueUSD = parseFloat(item.total_selling_price) || 0;
                const hotelCostUSD = parseFloat(item.total_cost_price) || 0;
                const outCostUSD = 0; // TODO: ì™¸ë¶€ ì•„ì›ƒí˜¸í…” ë§¤ì…ì•¡ í•„ë“œ ì¶”ê°€ í•„ìš”
                const exchangeRate = parseFloat(item.exchange_rate) || 1300;
                const agencyFee = parseFloat(item.agency_fee) || 0;
                
                const revenueKRW = Math.round(revenueUSD * exchangeRate);
                const hotelCostKRW = Math.round(hotelCostUSD * exchangeRate);
                const outCostKRW = Math.round(outCostUSD * exchangeRate);
                
                // ìˆ˜ë°°í”¼(ë§ˆì§„) = ê±°ë˜ì•¡(KRW) - í˜¸í…”ë§¤ì…ì•¡(KRW) - ì•„ì›ƒí˜¸í…”ë§¤ì…ì•¡(KRW) - ìˆ˜ë°°í”¼(KRW)
                // ì‹¤ì œë¡œëŠ” ë°±ì—”ë“œì—ì„œ ê³„ì‚°ëœ margin ì‚¬ìš©
                const margin = parseFloat(item.margin) || 0;
                
                // ë¶€ê°€ì„¸ = ë§ˆì§„ Ã— 10% - ìˆ˜ë°°í”¼ Ã— 10%
                const marginTax = Math.round(margin * 0.1);
                const agencyFeeTax = Math.round(agencyFee * 0.1);
                const tax = marginTax - agencyFeeTax;

                totalRevenueUSD += revenueUSD;
                totalRevenueKRW += revenueKRW;
                totalHotelCostUSD += hotelCostUSD;
                totalHotelCostKRW += hotelCostKRW;
                totalOutCostUSD += outCostUSD;
                totalOutCostKRW += outCostKRW;
                totalAgencyFee += agencyFee;
                totalMargin += margin;
                totalTax += tax;

                return `
                    <tr>
                        <td class="text-center">
                            <input type="checkbox" class="form-check-input settlement-checkbox" 
                                   value="${item.id}" 
                                   ${item.is_settled ? 'disabled' : ''}>
                        </td>
                        <td style="cursor: pointer;" onclick="openSettlementModal(${item.id})">${formatDate(item.check_in_date)}</td>
                        <td style="cursor: pointer;" onclick="openSettlementModal(${item.id})">${item.reservation_number || 'N/A'}</td>
                        <td style="cursor: pointer;" onclick="openSettlementModal(${item.id})">${item.hotel_name || 'í˜¸í…” ë¯¸ì •'}</td>
                        <td style="cursor: pointer;" onclick="openSettlementModal(${item.id})">${item.agency_name || 'N/A'}</td>
                        <td style="cursor: pointer;" onclick="openSettlementModal(${item.id})">${item.guest_name || 'N/A'}</td>
                        <td class="text-end" style="cursor: pointer;" onclick="openSettlementModal(${item.id})">
                            $${revenueUSD.toLocaleString()}<br>
                            <small class="text-muted">â‚©${revenueKRW.toLocaleString()}</small>
                        </td>
                        <td class="text-end" style="cursor: pointer;" onclick="openSettlementModal(${item.id})">
                            $${hotelCostUSD.toLocaleString()}<br>
                            <small class="text-muted">â‚©${hotelCostKRW.toLocaleString()}</small>
                        </td>
                        <td class="text-end" style="cursor: pointer;" onclick="openSettlementModal(${item.id})">
                            $${outCostUSD.toLocaleString()}<br>
                            <small class="text-muted">â‚©${outCostKRW.toLocaleString()}</small>
                        </td>
                        <td class="text-end" style="cursor: pointer;" onclick="openSettlementModal(${item.id})">
                            â‚©${agencyFee.toLocaleString()}
                        </td>
                        <td class="text-end ${margin > 0 ? 'text-success' : 'text-muted'}" style="cursor: pointer;" onclick="openSettlementModal(${item.id})">
                            â‚©${margin.toLocaleString()}
                        </td>
                        <td class="text-end" style="cursor: pointer; background-color: #ffe0cc;" onclick="openSettlementModal(${item.id})">
                            â‚©${tax.toLocaleString()}
                        </td>
                        <td class="text-center" style="cursor: pointer;" onclick="openSettlementModal(${item.id})">
                            <small>â‚©${exchangeRate.toLocaleString()}</small>
                        </td>
                        <td class="text-center">${item.payment_date ? formatDate(item.payment_date) : '-'}</td>
                        <td class="text-center">${item.transfer_date ? formatDate(item.transfer_date) : '-'}</td>
                    </tr>
                `;
            }).join('');

            // ì¼ê´„ ì²˜ë¦¬ ë²„íŠ¼ (ë¯¸ì™„ë£Œ íƒ­ì—ë§Œ í‘œì‹œ)
            const bulkActionButtons = !isCompleted ? `
                <div class="mb-3 d-flex gap-2">
                    <button class="btn btn-sm btn-primary" onclick="bulkPayment()">
                        <i class="fas fa-download me-1"></i>ì„ íƒ í•­ëª© ì…ê¸ˆ ì²˜ë¦¬
                    </button>
                    <button class="btn btn-sm btn-success" onclick="bulkTransfer()">
                        <i class="fas fa-upload me-1"></i>ì„ íƒ í•­ëª© ì†¡ê¸ˆ ì²˜ë¦¬
                    </button>
                </div>
            ` : '';

            const html = `
                ${bulkActionButtons}
                <div class="table-responsive">
                    <table class="table table-hover table-sm" style="font-size: 0.75rem;">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center">
                                    <input type="checkbox" class="form-check-input" id="selectAll${containerId}" 
                                           onchange="toggleSelectAll('${containerId}')" ${isCompleted ? 'style="display:none;"' : ''}>
                                </th>
                                <th>ì´ìš©ì¼</th>
                                <th>ì˜ˆì•½ë²ˆí˜¸</th>
                                <th>í˜¸í…”ëª…</th>
                                <th>ì˜ˆì•½ì—…ì²´</th>
                                <th>íˆ¬ìˆ™ê°</th>
                                <th class="text-end">ê±°ë˜ì•¡<br><small>(USD / KRW)</small></th>
                                <th class="text-end">í˜¸í…”ë§¤ì…ì•¡<br><small>(USD / KRW)</small></th>
                                <th class="text-end">ì•„ì›ƒí˜¸í…”ë§¤ì…ì•¡<br><small>(USD / KRW)</small></th>
                                <th class="text-end">ìˆ˜ë°°í”¼</th>
                                <th class="text-end">ë§ˆì§„</th>
                                <th class="text-end" style="background-color: #ffe0cc;">ë¶€ê°€ì„¸</th>
                                <th class="text-center">í™˜ìœ¨</th>
                                <th class="text-center">ì…ê¸ˆì¼</th>
                                <th class="text-center">ì†¡ê¸ˆì¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <th colspan="6" class="text-end">ì´ì•¡</th>
                                <th class="text-end">
                                    $${totalRevenueUSD.toLocaleString()}<br>
                                    <small>â‚©${totalRevenueKRW.toLocaleString()}</small>
                                </th>
                                <th class="text-end text-danger">
                                    $${totalHotelCostUSD.toLocaleString()}<br>
                                    <small>â‚©${totalHotelCostKRW.toLocaleString()}</small>
                                </th>
                                <th class="text-end text-warning">
                                    $${totalOutCostUSD.toLocaleString()}<br>
                                    <small>â‚©${totalOutCostKRW.toLocaleString()}</small>
                                </th>
                                <th class="text-end">â‚©${totalAgencyFee.toLocaleString()}</th>
                                <th class="text-end text-success">â‚©${totalMargin.toLocaleString()}</th>
                                <th class="text-end" style="background-color: #ffe0cc;">â‚©${totalTax.toLocaleString()}</th>
                                <th colspan="3"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        // ì •ì‚° ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
        async function openSettlementModal(id) {
            try {
                const response = await fetch(`/api/hotel-settlements/${id}`);
                const settlement = await response.json();

                document.getElementById('settlementId').value = settlement.id;
                document.getElementById('detailReservationNumber').textContent = settlement.reservation_number || 'N/A';
                document.getElementById('detailHotelName').textContent = settlement.hotel_name || 'N/A';
                document.getElementById('detailAgencyName').textContent = settlement.agency_name || 'N/A';
                document.getElementById('detailCheckIn').textContent = formatDate(settlement.check_in_date);
                document.getElementById('detailCheckOut').textContent = formatDate(settlement.check_out_date);
                document.getElementById('detailGuestName').textContent = settlement.guest_name || 'N/A';

                document.getElementById('detailSellingPrice').value = settlement.total_selling_price || 0;
                document.getElementById('detailCostPrice').value = settlement.total_cost_price || 0;
                document.getElementById('detailExchangeRate').value = settlement.exchange_rate || 1300;
                document.getElementById('detailAgencyFee').value = settlement.agency_fee || 0;
                document.getElementById('detailPaymentDate').value = settlement.payment_date ? settlement.payment_date.split('T')[0] : '';
                document.getElementById('detailTransferDate').value = settlement.transfer_date ? settlement.transfer_date.split('T')[0] : '';
                document.getElementById('detailMemo').value = settlement.settlement_memo || '';

                calculateProfit();

                new bootstrap.Modal(document.getElementById('settlementModal')).show();
            } catch (error) {
                console.error('ì •ì‚° ìƒì„¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ì •ì‚° ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ë§ˆì§„ ê³„ì‚°
        function calculateProfit() {
            const sellingPrice = parseFloat(document.getElementById('detailSellingPrice').value) || 0;
            const costPrice = parseFloat(document.getElementById('detailCostPrice').value) || 0;
            const exchangeRate = parseFloat(document.getElementById('detailExchangeRate').value) || 1300;
            const agencyFee = parseFloat(document.getElementById('detailAgencyFee').value) || 0;

            const revenueKRW = Math.round(sellingPrice * exchangeRate);
            const costKRW = Math.round(costPrice * exchangeRate);
            const margin = revenueKRW - costKRW - agencyFee;

            document.getElementById('calculatedMargin').textContent = formatCurrency(margin);
            document.getElementById('calculatedRevenueKRW').textContent = formatCurrency(revenueKRW);
            document.getElementById('calculatedCostKRW').textContent = formatCurrency(costKRW);
        }

        // ì •ì‚° ì €ì¥
        async function saveSettlement() {
            const id = document.getElementById('settlementId').value;
            const data = {
                total_selling_price: parseFloat(document.getElementById('detailSellingPrice').value) || 0,
                total_cost_price: parseFloat(document.getElementById('detailCostPrice').value) || 0,
                exchange_rate: parseFloat(document.getElementById('detailExchangeRate').value) || 1300,
                agency_fee: parseFloat(document.getElementById('detailAgencyFee').value) || 0,
                payment_date: document.getElementById('detailPaymentDate').value || null,
                transfer_date: document.getElementById('detailTransferDate').value || null,
                settlement_memo: document.getElementById('detailMemo').value || ''
            };

            try {
                const response = await fetch(`/api/hotel-settlements/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('ì •ì‚° ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    bootstrap.Modal.getInstance(document.getElementById('settlementModal')).hide();
                    loadSettlements();
                } else {
                    alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì €ì¥ ì‹¤íŒ¨:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì •ì‚° ì‚­ì œ
        async function deleteSettlement() {
            if (!confirm('ì´ ì •ì‚° ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const id = document.getElementById('settlementId').value;

            try {
                const response = await fetch(`/api/hotel-settlements/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('ì •ì‚° ë‚´ì—­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    bootstrap.Modal.getInstance(document.getElementById('settlementModal')).hide();
                    loadSettlements();
                } else {
                    alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì¼ê´„ ì…ì¶œê¸ˆ ëª¨ë‹¬
        function openBulkPaymentModal() {
            document.getElementById('bulkPaymentDate').value = new Date().toISOString().split('T')[0];
            new bootstrap.Modal(document.getElementById('bulkPaymentModal')).show();
        }

        // ì¼ê´„ ì…ì¶œê¸ˆ ì²˜ë¦¬
        async function processBulkPayment() {
            const type = document.getElementById('bulkPaymentType').value;
            const date = document.getElementById('bulkPaymentDate').value;

            if (!date) {
                alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!confirm(`ë¯¸ì™„ë£Œ ì •ì‚°ì„ ì¼ê´„ ${type === 'payment' ? 'ì…ê¸ˆ' : 'ì†¡ê¸ˆ'} ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                const response = await fetch('/api/hotel-settlements/bulk-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, date })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`${result.count}ê±´ì´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    bootstrap.Modal.getInstance(document.getElementById('bulkPaymentModal')).hide();
                    loadSettlements();
                } else {
                    alert('ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì¼ê´„ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì „ì²´ ì„ íƒ/í•´ì œ
        let selectedSettlements = new Set();
        
        function toggleSelectAll(containerId) {
            const selectAllCheckbox = document.getElementById('selectAll' + containerId);
            const checkboxes = document.querySelectorAll(`#${containerId} .settlement-checkbox:not(:disabled)`);

            selectedSettlements.clear();

            if (selectAllCheckbox.checked) {
                checkboxes.forEach(cb => {
                    cb.checked = true;
                    selectedSettlements.add(parseInt(cb.value));
                });
            } else {
                checkboxes.forEach(cb => cb.checked = false);
            }

            console.log('ì„ íƒëœ ì •ì‚°:', Array.from(selectedSettlements));
        }

        // ì¼ê´„ ì…ê¸ˆ ì²˜ë¦¬
        async function bulkPayment() {
            const checkboxes = document.querySelectorAll('.settlement-checkbox:checked:not(:disabled)');
            if (checkboxes.length === 0) {
                alert('ì…ê¸ˆ ì²˜ë¦¬í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const date = prompt('ì…ê¸ˆì¼ì„ ì…ë ¥í•˜ì„¸ìš” (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
            if (!date) return;

            const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (!confirm(`${ids.length}ê±´ì„ ì…ê¸ˆ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                const response = await fetch('/api/hotel-settlements/bulk-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids, type: 'payment', date })
                });

                if (response.ok) {
                    alert(`${ids.length}ê±´ì´ ì…ê¸ˆ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    loadSettlements();
                } else {
                    alert('ì…ê¸ˆ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì…ê¸ˆ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì¼ê´„ ì†¡ê¸ˆ ì²˜ë¦¬
        async function bulkTransfer() {
            const checkboxes = document.querySelectorAll('.settlement-checkbox:checked:not(:disabled)');
            if (checkboxes.length === 0) {
                alert('ì†¡ê¸ˆ ì²˜ë¦¬í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const date = prompt('ì†¡ê¸ˆì¼ì„ ì…ë ¥í•˜ì„¸ìš” (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
            if (!date) return;

            const exchangeRate = prompt('í™˜ìœ¨ì„ ì…ë ¥í•˜ì„¸ìš”:', '1300');
            if (!exchangeRate) return;

            const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (!confirm(`${ids.length}ê±´ì„ ì†¡ê¸ˆ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (í™˜ìœ¨: ${exchangeRate})`)) return;

            try {
                const response = await fetch('/api/hotel-settlements/bulk-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids, type: 'transfer', date, exchange_rate: parseFloat(exchangeRate) })
                });

                if (response.ok) {
                    alert(`${ids.length}ê±´ì´ ì†¡ê¸ˆ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    loadSettlements();
                } else {
                    alert('ì†¡ê¸ˆ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì†¡ê¸ˆ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í†µí™” í¬ë§·
        function formatCurrency(amount) {
            return 'â‚©' + Math.round(amount).toLocaleString('ko-KR');
        }

        // ë‚ ì§œ í¬ë§·
        function formatDate(dateString) {
            if (!dateString) return '-';
            return dateString.split('T')[0];
        }
    </script>
</body>
</html>
