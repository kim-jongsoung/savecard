<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>호텔 정산관리 - 괌세이브카드 관리자</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* PC 화면에서 가로폭 1200px 고정 */
        @media (min-width: 1200px) {
            .container-fluid {
                max-width: 1200px;
                margin: 0 auto;
            }
        }
        
        .status-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        .status-settled { background-color: #28a745; color: #fff; }
        .status-pending { background-color: #ffc107; color: #000; }
        .status-overdue { background-color: #dc3545; color: #fff; }
        
        .settlement-card {
            border-left: 4px solid #dee2e6;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .settlement-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .settlement-card.settled { border-left-color: #28a745; }
        .settlement-card.pending { border-left-color: #ffc107; }
        .settlement-card.overdue { border-left-color: #dc3545; }
        
        .stats-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #333;
            border-radius: 15px;
            border: 1px solid #dee2e6;
        }
        
        .stats-card .card-body {
            padding: 1rem;
        }
        
        .stats-card h3 {
            margin-bottom: 0.25rem;
            font-size: 1.5rem;
        }
        
        .stats-card h5 {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .stats-card .fa-2x {
            font-size: 1.5rem;
        }
        
        .stats-card small {
            font-size: 0.75rem;
        }
        
        .profit-positive { color: #28a745; font-weight: bold; }
        .profit-negative { color: #dc3545; font-weight: bold; }
        .profit-neutral { color: #6c757d; font-weight: bold; }

        .table-sm td, .table-sm th {
            padding: 0.3rem;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar', { currentPage: 'hotel-settlements' }) %>
    
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-hotel me-2"></i>호텔 정산관리</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-info" onclick="loadSettlements()">
                            <i class="fas fa-sync-alt me-1"></i>새로고침
                        </button>
                        <button class="btn btn-outline-primary" onclick="openBulkPaymentModal()">
                            <i class="fas fa-money-bill-wave me-1"></i>일괄 입출금
                        </button>
                    </div>
                </div>

                <!-- 정산 통계 -->
                <div class="row mb-3">
                    <!-- 미입금 거래액 -->
                    <div class="col-md-6">
                        <div class="card stats-card border-warning">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0"><i class="fas fa-arrow-down text-warning me-2"></i>미입금 거래액</h5>
                                    <small class="text-muted">현재 시점</small>
                                </div>
                                <h3 class="text-warning mb-2" id="unpaidRevenue">₩0</h3>
                                <div id="unpaidByAgency" class="mt-2">
                                    <small class="text-muted">거래처별 집계 로딩 중...</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 미송금 매입액 -->
                    <div class="col-md-6">
                        <div class="card stats-card border-danger">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0"><i class="fas fa-arrow-up text-danger me-2"></i>미송금 매입액</h5>
                                    <small class="text-muted">현재 시점</small>
                                </div>
                                <h3 class="text-danger mb-2" id="unpaidCost">₩0</h3>
                                <div id="unpaidByHotel" class="mt-2">
                                    <small class="text-muted">호텔별 집계 로딩 중...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 월간 통계 -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card stats-card border-primary">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0"><i class="fas fa-chart-line text-primary me-2"></i>총 마진</h5>
                                    <small class="text-muted">이번 달</small>
                                </div>
                                <h3 class="text-primary" id="monthlyMargin">₩0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card stats-card border-success">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0"><i class="fas fa-dollar-sign text-success me-2"></i>거래액 총액</h5>
                                    <small class="text-muted">이번 달</small>
                                </div>
                                <h3 class="text-success" id="monthlyRevenue">₩0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card stats-card border-info">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0"><i class="fas fa-shopping-cart text-info me-2"></i>매입액 총액</h5>
                                    <small class="text-muted">이번 달</small>
                                </div>
                                <h3 class="text-info" id="monthlyCost">₩0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 탭 메뉴 -->
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#pending">
                            <i class="fas fa-clock me-1"></i>미완료 정산
                            <span class="badge bg-warning text-dark ms-1" id="pendingCount">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#completed">
                            <i class="fas fa-check-circle me-1"></i>완료된 정산
                            <span class="badge bg-success ms-1" id="completedCount">0</span>
                        </a>
                    </li>
                </ul>

                <!-- 탭 컨텐츠 -->
                <div class="tab-content">
                    <!-- 미완료 정산 -->
                    <div class="tab-pane fade show active" id="pending">
                        <div id="pendingList" class="row">
                            <div class="col-12 text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">로딩 중...</span>
                                </div>
                                <p class="mt-2 text-muted">정산 데이터를 불러오는 중...</p>
                            </div>
                        </div>
                    </div>

                    <!-- 완료된 정산 -->
                    <div class="tab-pane fade" id="completed">
                        <div id="completedList" class="row">
                            <div class="col-12 text-center py-5">
                                <p class="text-muted">완료된 정산 내역이 없습니다.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 정산 상세/수정 모달 -->
    <div class="modal fade" id="settlementModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">정산 상세</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="settlementId">
                    
                    <!-- 예약 정보 -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>예약 정보</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-2"><strong>예약번호:</strong> <span id="detailReservationNumber"></span></p>
                                    <p class="mb-2"><strong>호텔명:</strong> <span id="detailHotelName"></span></p>
                                    <p class="mb-2"><strong>거래처:</strong> <span id="detailAgencyName"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-2"><strong>체크인:</strong> <span id="detailCheckIn"></span></p>
                                    <p class="mb-2"><strong>체크아웃:</strong> <span id="detailCheckOut"></span></p>
                                    <p class="mb-2"><strong>투숙객:</strong> <span id="detailGuestName"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 정산 금액 -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>정산 금액</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">거래액 (판매가)</label>
                                        <input type="number" class="form-control" id="detailSellingPrice" onchange="calculateProfit()">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">환율</label>
                                        <input type="number" class="form-control" id="detailExchangeRate" onchange="calculateProfit()">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">매입액 (호텔 송금액)</label>
                                        <input type="number" class="form-control" id="detailCostPrice" onchange="calculateProfit()">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">수배피</label>
                                        <input type="number" class="form-control" id="detailAgencyFee" onchange="calculateProfit()">
                                    </div>
                                </div>
                            </div>

                            <!-- 계산 결과 -->
                            <div class="alert alert-info">
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>마진:</strong> <span id="calculatedMargin">₩0</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>거래액(원화):</strong> <span id="calculatedRevenueKRW">₩0</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>매입액(원화):</strong> <span id="calculatedCostKRW">₩0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 입출금 정보 -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>입출금 정보</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">입금일</label>
                                        <input type="date" class="form-control" id="detailPaymentDate">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">송금일</label>
                                        <input type="date" class="form-control" id="detailTransferDate">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">메모</label>
                                <textarea class="form-control" id="detailMemo" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="deleteSettlement()">
                        <i class="fas fa-trash me-1"></i>삭제
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" onclick="saveSettlement()">
                        <i class="fas fa-save me-1"></i>저장
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 일괄 입출금 모달 -->
    <div class="modal fade" id="bulkPaymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">일괄 입출금 처리</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">처리 유형</label>
                        <select class="form-select" id="bulkPaymentType">
                            <option value="payment">입금 처리</option>
                            <option value="transfer">송금 처리</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">처리 날짜</label>
                        <input type="date" class="form-control" id="bulkPaymentDate">
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        미완료 정산 중 선택된 항목들이 일괄 처리됩니다.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="processBulkPayment()">
                        <i class="fas fa-check me-1"></i>처리
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let settlements = [];
        let stats = {};

        // 페이지 로드 시 데이터 불러오기
        document.addEventListener('DOMContentLoaded', function() {
            loadSettlements();
        });

        // 정산 데이터 불러오기
        async function loadSettlements() {
            try {
                const response = await fetch('/api/hotel-settlements');
                const data = await response.json();
                
                settlements = data.settlements || [];
                stats = data.stats || {};
                
                renderStats();
                renderSettlements();
            } catch (error) {
                console.error('정산 데이터 로드 실패:', error);
                alert('정산 데이터를 불러오는데 실패했습니다.');
            }
        }

        // 통계 렌더링
        function renderStats() {
            // 미입금 거래액
            document.getElementById('unpaidRevenue').textContent = formatCurrency(stats.unpaidRevenue || 0);
            
            // 미송금 매입액
            document.getElementById('unpaidCost').textContent = formatCurrency(stats.unpaidCost || 0);
            
            // 월간 통계
            document.getElementById('monthlyMargin').textContent = formatCurrency(stats.monthlyMargin || 0);
            document.getElementById('monthlyRevenue').textContent = formatCurrency(stats.monthlyRevenue || 0);
            document.getElementById('monthlyCost').textContent = formatCurrency(stats.monthlyCost || 0);

            // 거래처별 미입금
            if (stats.unpaidByAgency && stats.unpaidByAgency.length > 0) {
                const html = stats.unpaidByAgency.map(item => 
                    `<small class="d-block"><strong>${item.agency_name}:</strong> ${formatCurrency(item.total)}</small>`
                ).join('');
                document.getElementById('unpaidByAgency').innerHTML = html;
            } else {
                document.getElementById('unpaidByAgency').innerHTML = '<small class="text-muted">미입금 내역 없음</small>';
            }

            // 호텔별 미송금
            if (stats.unpaidByHotel && stats.unpaidByHotel.length > 0) {
                const html = stats.unpaidByHotel.map(item => 
                    `<small class="d-block"><strong>${item.hotel_name}:</strong> ${formatCurrency(item.total)}</small>`
                ).join('');
                document.getElementById('unpaidByHotel').innerHTML = html;
            } else {
                document.getElementById('unpaidByHotel').innerHTML = '<small class="text-muted">미송금 내역 없음</small>';
            }
        }

        // 정산 목록 렌더링
        function renderSettlements() {
            const pending = settlements.filter(s => !s.is_settled);
            const completed = settlements.filter(s => s.is_settled);

            document.getElementById('pendingCount').textContent = pending.length;
            document.getElementById('completedCount').textContent = completed.length;

            renderSettlementList(pending, 'pendingList', false);
            renderSettlementList(completed, 'completedList', true);
        }

        function renderSettlementList(items, containerId, isCompleted) {
            const container = document.getElementById(containerId);
            
            if (items.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <p class="text-muted">${isCompleted ? '완료된' : '미완료'} 정산 내역이 없습니다.</p>
                    </div>
                `;
                return;
            }

            const html = items.map(item => `
                <div class="col-md-6 mb-3">
                    <div class="card settlement-card ${item.is_settled ? 'settled' : 'pending'}" onclick="openSettlementModal(${item.id})">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1">${item.hotel_name || '호텔 미정'}</h6>
                                    <small class="text-muted">${item.reservation_number || 'N/A'}</small>
                                </div>
                                <span class="badge ${item.is_settled ? 'bg-success' : 'bg-warning text-dark'}">
                                    ${item.is_settled ? '정산완료' : '미완료'}
                                </span>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">체크인</small>
                                    <p class="mb-1"><strong>${formatDate(item.check_in_date)}</strong></p>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">거래처</small>
                                    <p class="mb-1"><strong>${item.agency_name || 'N/A'}</strong></p>
                                </div>
                            </div>
                            <hr class="my-2">
                            <div class="row">
                                <div class="col-4">
                                    <small class="text-muted">거래액</small>
                                    <p class="mb-0"><strong>${formatCurrency(item.total_selling_price)}</strong></p>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">매입액</small>
                                    <p class="mb-0"><strong>${formatCurrency(item.total_cost_price)}</strong></p>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">마진</small>
                                    <p class="mb-0 ${item.margin > 0 ? 'profit-positive' : 'profit-neutral'}">
                                        <strong>${formatCurrency(item.margin)}</strong>
                                    </p>
                                </div>
                            </div>
                            ${item.is_settled ? `
                                <div class="mt-2">
                                    <small class="text-success">
                                        <i class="fas fa-check-circle me-1"></i>
                                        입금: ${formatDate(item.payment_date)} / 송금: ${formatDate(item.transfer_date)}
                                    </small>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // 정산 상세 모달 열기
        async function openSettlementModal(id) {
            try {
                const response = await fetch(`/api/hotel-settlements/${id}`);
                const settlement = await response.json();

                document.getElementById('settlementId').value = settlement.id;
                document.getElementById('detailReservationNumber').textContent = settlement.reservation_number || 'N/A';
                document.getElementById('detailHotelName').textContent = settlement.hotel_name || 'N/A';
                document.getElementById('detailAgencyName').textContent = settlement.agency_name || 'N/A';
                document.getElementById('detailCheckIn').textContent = formatDate(settlement.check_in_date);
                document.getElementById('detailCheckOut').textContent = formatDate(settlement.check_out_date);
                document.getElementById('detailGuestName').textContent = settlement.guest_name || 'N/A';

                document.getElementById('detailSellingPrice').value = settlement.total_selling_price || 0;
                document.getElementById('detailCostPrice').value = settlement.total_cost_price || 0;
                document.getElementById('detailExchangeRate').value = settlement.exchange_rate || 1300;
                document.getElementById('detailAgencyFee').value = settlement.agency_fee || 0;
                document.getElementById('detailPaymentDate').value = settlement.payment_date ? settlement.payment_date.split('T')[0] : '';
                document.getElementById('detailTransferDate').value = settlement.transfer_date ? settlement.transfer_date.split('T')[0] : '';
                document.getElementById('detailMemo').value = settlement.settlement_memo || '';

                calculateProfit();

                new bootstrap.Modal(document.getElementById('settlementModal')).show();
            } catch (error) {
                console.error('정산 상세 로드 실패:', error);
                alert('정산 상세 정보를 불러오는데 실패했습니다.');
            }
        }

        // 마진 계산
        function calculateProfit() {
            const sellingPrice = parseFloat(document.getElementById('detailSellingPrice').value) || 0;
            const costPrice = parseFloat(document.getElementById('detailCostPrice').value) || 0;
            const exchangeRate = parseFloat(document.getElementById('detailExchangeRate').value) || 1300;
            const agencyFee = parseFloat(document.getElementById('detailAgencyFee').value) || 0;

            const revenueKRW = Math.round(sellingPrice * exchangeRate);
            const costKRW = Math.round(costPrice * exchangeRate);
            const margin = revenueKRW - costKRW - agencyFee;

            document.getElementById('calculatedMargin').textContent = formatCurrency(margin);
            document.getElementById('calculatedRevenueKRW').textContent = formatCurrency(revenueKRW);
            document.getElementById('calculatedCostKRW').textContent = formatCurrency(costKRW);
        }

        // 정산 저장
        async function saveSettlement() {
            const id = document.getElementById('settlementId').value;
            const data = {
                total_selling_price: parseFloat(document.getElementById('detailSellingPrice').value) || 0,
                total_cost_price: parseFloat(document.getElementById('detailCostPrice').value) || 0,
                exchange_rate: parseFloat(document.getElementById('detailExchangeRate').value) || 1300,
                agency_fee: parseFloat(document.getElementById('detailAgencyFee').value) || 0,
                payment_date: document.getElementById('detailPaymentDate').value || null,
                transfer_date: document.getElementById('detailTransferDate').value || null,
                settlement_memo: document.getElementById('detailMemo').value || ''
            };

            try {
                const response = await fetch(`/api/hotel-settlements/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('정산 정보가 저장되었습니다.');
                    bootstrap.Modal.getInstance(document.getElementById('settlementModal')).hide();
                    loadSettlements();
                } else {
                    alert('저장에 실패했습니다.');
                }
            } catch (error) {
                console.error('저장 실패:', error);
                alert('저장 중 오류가 발생했습니다.');
            }
        }

        // 정산 삭제
        async function deleteSettlement() {
            if (!confirm('이 정산 내역을 삭제하시겠습니까?')) return;

            const id = document.getElementById('settlementId').value;

            try {
                const response = await fetch(`/api/hotel-settlements/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('정산 내역이 삭제되었습니다.');
                    bootstrap.Modal.getInstance(document.getElementById('settlementModal')).hide();
                    loadSettlements();
                } else {
                    alert('삭제에 실패했습니다.');
                }
            } catch (error) {
                console.error('삭제 실패:', error);
                alert('삭제 중 오류가 발생했습니다.');
            }
        }

        // 일괄 입출금 모달
        function openBulkPaymentModal() {
            document.getElementById('bulkPaymentDate').value = new Date().toISOString().split('T')[0];
            new bootstrap.Modal(document.getElementById('bulkPaymentModal')).show();
        }

        // 일괄 입출금 처리
        async function processBulkPayment() {
            const type = document.getElementById('bulkPaymentType').value;
            const date = document.getElementById('bulkPaymentDate').value;

            if (!date) {
                alert('날짜를 선택해주세요.');
                return;
            }

            if (!confirm(`미완료 정산을 일괄 ${type === 'payment' ? '입금' : '송금'} 처리하시겠습니까?`)) return;

            try {
                const response = await fetch('/api/hotel-settlements/bulk-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, date })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`${result.count}건이 처리되었습니다.`);
                    bootstrap.Modal.getInstance(document.getElementById('bulkPaymentModal')).hide();
                    loadSettlements();
                } else {
                    alert('처리에 실패했습니다.');
                }
            } catch (error) {
                console.error('일괄 처리 실패:', error);
                alert('처리 중 오류가 발생했습니다.');
            }
        }

        // 통화 포맷
        function formatCurrency(amount) {
            return '₩' + Math.round(amount).toLocaleString('ko-KR');
        }

        // 날짜 포맷
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR');
        }
    </script>
</body>
</html>
