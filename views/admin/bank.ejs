<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>계좌입출금 - 관리자</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background:#f4f6fb; }
        .page-header { background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%); color:white; padding:20px 0; margin-bottom:24px; }
        .section-card { background:white; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.08); margin-bottom:20px; overflow:hidden; }
        .section-header { background:#f8f9fa; border-bottom:1px solid #e9ecef; padding:13px 20px; font-weight:600; font-size:.9rem; }
        .stat-box { background:white; border-radius:10px; padding:16px 20px; box-shadow:0 2px 8px rgba(0,0,0,.08); }
        .stat-label { font-size:.78rem; color:#888; margin-bottom:4px; }
        .stat-value { font-size:1.15rem; font-weight:700; }
        .c-green{color:#11998e;} .c-red{color:#dc3545;} .c-blue{color:#667eea;} .c-orange{color:#fd7e14;}
        .account-tab { cursor:pointer; border:2px solid #dee2e6; border-radius:8px; padding:10px 14px; font-size:.83rem; transition:all .15s; text-align:center; min-width:110px; }
        .account-tab:hover,.account-tab.active { border-color:#11998e; background:#e6fff8; }
        .account-tab .acc-name { font-weight:700; color:#11998e; font-size:.85rem; }
        .account-tab .acc-num  { font-size:.72rem; color:#888; margin-top:2px; }
        .filter-bar { background:white; border-radius:10px; padding:14px 18px; box-shadow:0 2px 8px rgba(0,0,0,.06); margin-bottom:16px; }
        .tx-row-in  { border-left:4px solid #11998e; }
        .tx-row-out { border-left:4px solid #dc3545; }
        .badge-in  { background:#d4edda; color:#155724; font-size:.73rem; padding:2px 8px; border-radius:20px; }
        .badge-out { background:#f8d7da; color:#721c24; font-size:.73rem; padding:2px 8px; border-radius:20px; }
        .cat-badge { font-size:.71rem; padding:2px 7px; border-radius:20px; background:#e9ecef; color:#495057; }
        .cat-badge.uncat     { background:#fff3cd; color:#856404; }
        .cat-badge.confirmed { background:#d4edda; color:#155724; }
        @media(max-width:768px){ .hide-sm{display:none!important;} }
    </style>
</head>
<body>
<%- include('../partials/navbar', { currentPage: 'bank' }) %>

<div class="page-header">
    <div class="container-fluid">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div>
                <h4 class="mb-1 fw-bold"><i class="fas fa-university me-2"></i>계좌 입출금 장부</h4>
                <small class="opacity-75">신한은행 문자 자동수신 · 여행사 회계 항목 분류</small>
            </div>
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-light btn-sm fw-bold" id="btnAddManual"><i class="fas fa-plus me-1"></i>수동 등록</button>
                <button class="btn btn-outline-light btn-sm" id="btnWebhookInfo"><i class="fas fa-link me-1"></i>웹훅 주소</button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- 계좌 탭 -->
    <div class="d-flex flex-wrap gap-2 mb-3" id="accountTabs">
        <div class="account-tab active" data-account="all">
            <div class="acc-name"><i class="fas fa-list me-1"></i>전체</div>
            <div class="acc-num">모든 계좌</div>
        </div>
    </div>
    <div class="d-flex gap-2 mb-3">
        <button class="btn btn-warning btn-sm fw-bold" id="btnCardList" onclick="openCardModal()">
            <i class="fas fa-credit-card me-1"></i>신한해외카드 승인내역
        </button>
    </div>


    <!-- 필터 -->
    <div class="filter-bar">
        <div class="row g-2 align-items-end">
            <div class="col-6 col-md-2">
                <label class="form-label small mb-1 fw-bold">기간 시작</label>
                <input type="date" class="form-control form-control-sm" id="filterStart">
            </div>
            <div class="col-6 col-md-2">
                <label class="form-label small mb-1 fw-bold">기간 종료</label>
                <input type="date" class="form-control form-control-sm" id="filterEnd">
            </div>
            <div class="col-6 col-md-2">
                <label class="form-label small mb-1 fw-bold">구분</label>
                <select class="form-select form-select-sm" id="filterType">
                    <option value="all">전체</option>
                    <option value="in">입금</option>
                    <option value="out">출금</option>
                </select>
            </div>
            <div class="col-6 col-md-3">
                <label class="form-label small mb-1 fw-bold">분류 항목</label>
                <select class="form-select form-select-sm" id="filterCategory">
                    <option value="all">전체</option>
                </select>
            </div>
            <div class="col-12 col-md-3 d-flex gap-2">
                <button class="btn btn-primary btn-sm w-100" id="btnSearch"><i class="fas fa-search me-1"></i>조회</button>
                <button class="btn btn-outline-secondary btn-sm px-3" id="btnReset" title="초기화"><i class="fas fa-undo"></i></button>
            </div>
        </div>
    </div>

    <!-- 거래 내역 -->
    <div class="section-card">
        <div class="section-header d-flex justify-content-between align-items-center">
            <span><i class="fas fa-list-ul me-2 c-green"></i>거래 내역</span>
            <span class="text-muted" style="font-size:.8rem" id="txCount"></span>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle" style="font-size:.82rem">
                <thead class="table-dark">
                    <tr>
                        <th>일시</th>
                        <th class="hide-sm">계좌</th>
                        <th>구분</th>
                        <th class="text-end">금액</th>
                        <th>적요</th>
                        <th>분류 항목</th>
                        <th class="hide-sm">메모</th>
                        <th>처리</th>
                    </tr>
                </thead>
                <tbody id="txTableBody">
                    <tr><td colspan="8" class="text-center py-5 text-muted">데이터를 불러오는 중...</td></tr>
                </tbody>
            </table>
        </div>
        <div id="paginationArea" class="d-none d-flex justify-content-between align-items-center px-3 py-2 border-top">
            <small class="text-muted" id="paginationInfo"></small>
            <div id="paginationBtns" class="d-flex gap-1"></div>
        </div>
    </div>

    <!-- 카테고리별 합계 -->
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="section-card">
                <div class="section-header"><i class="fas fa-arrow-down me-2 c-green"></i>입금 항목별 합계</div>
                <div class="table-responsive">
                    <table class="table table-sm mb-0" style="font-size:.82rem">
                        <thead><tr><th>항목</th><th class="text-end">건수</th><th class="text-end">합계</th></tr></thead>
                        <tbody id="inCatTable"><tr><td colspan="3" class="text-center text-muted py-3">-</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="section-card">
                <div class="section-header"><i class="fas fa-arrow-up me-2 c-red"></i>출금 항목별 합계</div>
                <div class="table-responsive">
                    <table class="table table-sm mb-0" style="font-size:.82rem">
                        <thead><tr><th>항목</th><th class="text-end">건수</th><th class="text-end">합계</th></tr></thead>
                        <tbody id="outCatTable"><tr><td colspan="3" class="text-center text-muted py-3">-</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div><!-- /container-fluid -->

<!-- ===== 분류 수정 모달 ===== -->
<div class="modal fade" id="catModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header" style="background:linear-gradient(135deg,#11998e,#38ef7d);color:white;">
            <h5 class="modal-title fw-bold"><i class="fas fa-tag me-2"></i>항목 분류</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="catTxId">
            <div class="mb-3">
                <label class="form-label fw-bold small">거래 정보</label>
                <div id="catTxInfo" class="p-2 bg-light rounded small"></div>
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">분류 항목 <span class="text-danger">*</span></label>
                <select class="form-select" id="catSelect"></select>
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">메모</label>
                <input type="text" class="form-control" id="catNotes" placeholder="추가 메모">
            </div>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="catConfirmed">
                <label class="form-check-label fw-bold" for="catConfirmed">회계 확정 처리</label>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            <button type="button" class="btn btn-success px-4" id="btnSaveCat"><i class="fas fa-save me-1"></i>저장</button>
        </div>
    </div></div>
</div>

<!-- ===== 수동 등록 모달 ===== -->
<div class="modal fade" id="manualModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;">
            <h5 class="modal-title fw-bold"><i class="fas fa-plus me-2"></i>거래 수동 등록</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label fw-bold">계좌 <span class="text-danger">*</span></label>
                    <select class="form-select" id="mAccount"></select>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">구분 <span class="text-danger">*</span></label>
                    <select class="form-select" id="mType">
                        <option value="in">입금</option>
                        <option value="out">출금</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">금액 <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="mAmount" placeholder="0" min="1">
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">일시 <span class="text-danger">*</span></label>
                    <input type="datetime-local" class="form-control" id="mDate">
                </div>
                <div class="col-12">
                    <label class="form-label fw-bold">적요</label>
                    <input type="text" class="form-control" id="mMemo" placeholder="거래 내용">
                </div>
                <div class="col-12">
                    <label class="form-label fw-bold">분류 항목</label>
                    <select class="form-select" id="mCategory"></select>
                </div>
                <div class="col-12">
                    <label class="form-label fw-bold">메모</label>
                    <input type="text" class="form-control" id="mNotes" placeholder="">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            <button type="button" class="btn btn-primary px-4" id="btnSaveManual"><i class="fas fa-save me-1"></i>등록</button>
        </div>
    </div></div>
</div>

<!-- ===== 신한해외카드 승인내역 모달 ===== -->
<div class="modal fade" id="cardModal" tabindex="-1">
    <div class="modal-dialog modal-xl"><div class="modal-content">
        <div class="modal-header" style="background:linear-gradient(135deg,#f7971e,#ffd200);color:#333;">
            <h5 class="modal-title fw-bold"><i class="fas fa-credit-card me-2"></i>신한해외카드 승인내역</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <div class="d-flex gap-2 mb-3 flex-wrap align-items-end">
                <div>
                    <label class="form-label small fw-bold mb-1">기간 시작</label>
                    <input type="date" class="form-control form-control-sm" id="cardFilterStart" style="width:140px">
                </div>
                <div>
                    <label class="form-label small fw-bold mb-1">기간 종료</label>
                    <input type="date" class="form-control form-control-sm" id="cardFilterEnd" style="width:140px">
                </div>
                <button class="btn btn-primary btn-sm" onclick="loadCardTransactions()"><i class="fas fa-search me-1"></i>조회</button>
                <span class="ms-auto text-muted small" id="cardTxCount"></span>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" style="font-size:.82rem">
                    <thead class="table-dark">
                        <tr>
                            <th>일시</th>
                            <th>카드번호</th>
                            <th class="text-end">금액(USD)</th>
                            <th>가맹점</th>
                            <th>원문</th>
                        </tr>
                    </thead>
                    <tbody id="cardTableBody">
                        <tr><td colspan="5" class="text-center py-4 text-muted">조회 버튼을 눌러주세요</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <small class="text-muted me-auto">웹훅: <code>https://www.guamsavecard.com/api/bank/card-webhook</code></small>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        </div>
    </div></div>
</div>

<!-- ===== 웹훅 안내 모달 ===== -->
<div class="modal fade" id="webhookModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title fw-bold"><i class="fas fa-link me-2"></i>매크로드로이드 웹훅 설정</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <div class="mb-3">
                <label class="form-label fw-bold">계좌입출금 웹훅 URL</label>
                <div class="input-group">
                    <input type="text" class="form-control font-monospace small" id="webhookUrl" readonly>
                    <button class="btn btn-outline-secondary" id="btnCopyWebhook"><i class="fas fa-copy"></i></button>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">카드승인 웹훅 URL</label>
                <div class="input-group">
                    <input type="text" class="form-control font-monospace small" id="cardWebhookUrl" value="https://www.guamsavecard.com/api/bank/card-webhook" readonly>
                    <button class="btn btn-outline-secondary" onclick="navigator.clipboard.writeText(document.getElementById('cardWebhookUrl').value);this.innerHTML='<i class=\'fas fa-check\'></i>'"><i class="fas fa-copy"></i></button>
                </div>
            </div>
            <div class="alert alert-info small mb-2">
                <strong>매크로드로이드 설정:</strong><br>
                1. 트리거: SMS 수신 (신한은행)<br>
                2. 액션: HTTP 요청 → POST<br>
                3. URL: 위 웹훅 주소<br>
                4. Content-Type: application/json<br>
                5. Body: <code>{"message": "%SMS_BODY%"}</code>
            </div>
            <div class="alert alert-warning small mb-0">
                <strong>카드승인 문자 예시:</strong><br>
                <code>신한법인해외승인 9073 02/27 10:53 2,640.00 달러 (GU)DUSIT THANI</code>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        </div>
    </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/bank.js"></script>
</body>
</html>
