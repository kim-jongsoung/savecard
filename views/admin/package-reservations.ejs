<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒ¨í‚¤ì§€ ì˜ˆì•½ ê´€ë¦¬ - ê´Œì„¸ì´ë¸Œì¹´ë“œ ê´€ë¦¬ì</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-confirmed { background-color: #d4edda; color: #155724; }
        .status-cancelled { background-color: #f8d7da; color: #721c24; }
        .action-icons .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .component-icons {
            font-size: 1.2rem;
        }
        .margin-positive { color: #198754; font-weight: bold; }
        .margin-negative { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <%- include('../partials/navbar', { currentPage: 'package-reservations', adminUsername: adminUsername || 'ê´€ë¦¬ì' }) %>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-box-open me-2"></i>íŒ¨í‚¤ì§€ ì˜ˆì•½ ê´€ë¦¬</h2>
                    <a href="/admin/package-inbox" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>ìƒˆ íŒ¨í‚¤ì§€ ì˜ˆì•½ ë“±ë¡
                    </a>
                </div>

                <!-- í•„í„° -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-md-2">
                                <label class="form-label">ë‚ ì§œ ê¸°ì¤€</label>
                                <select class="form-select" id="dateTypeFilter">
                                    <option value="departure">ì¶œë°œì¼</option>
                                    <option value="created">ì˜ˆì•½ì¼</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">ì‹œì‘ì¼</label>
                                <input type="date" class="form-control" id="startDateFilter">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">ì¢…ë£Œì¼</label>
                                <input type="date" class="form-control" id="endDateFilter">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">ì˜ˆì•½ ì±„ë„</label>
                                <select class="form-select" id="platformFilter">
                                    <option value="">ì „ì²´</option>
                                    <option value="VASCO">VASCO</option>
                                    <option value="NOL">NOL</option>
                                    <option value="ë¡±í˜¼ìŠ¤í…Œì´í¬">ë¡±í˜¼ìŠ¤í…Œì´í¬</option>
                                    <option value="ì§ì ‘ì˜ˆì•½">ì§ì ‘ì˜ˆì•½</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">ìƒíƒœ</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="all">ì „ì²´</option>
                                    <option value="pending">ëŒ€ê¸°</option>
                                    <option value="confirmed">í™•ì •</option>
                                    <option value="cancelled">ì·¨ì†Œ</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">ê²€ìƒ‰</label>
                                <input type="text" class="form-control" id="searchInput" 
                                       placeholder="ì˜ˆì•½ë²ˆí˜¸, ê³ ê°ëª…">
                            </div>
                        </div>
                        <div class="row g-2">
                            <div class="col-md-12 text-end">
                                <button class="btn btn-primary" onclick="loadReservations()">
                                    <i class="fas fa-search me-1"></i>ê²€ìƒ‰í•˜ê¸°
                                </button>
                                <button class="btn btn-outline-secondary" onclick="resetFilters()">
                                    <i class="fas fa-redo me-1"></i>ì´ˆê¸°í™”
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- í†µê³„ -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="text-muted">ì´ ì˜ˆì•½</h6>
                                <h3 id="stat-total">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="text-muted">ì´ ê±°ë˜ì•¡</h6>
                                <h3 id="stat-revenue">â‚©0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="text-muted">ì´ ë§¤ì…ì•¡</h6>
                                <h3 id="stat-cost">â‚©0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="text-muted">ì´ ë§ˆì§„</h6>
                                <h3 id="stat-margin" class="margin-positive">â‚©0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì˜ˆì•½ ëª©ë¡ -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ì¶œë°œì¼</th>
                                        <th>ì˜ˆì•½ì¼</th>
                                        <th>ì˜ˆì•½ì±„ë„</th>
                                        <th>ìƒí’ˆëª…</th>
                                        <th>ê³ ê°ëª…</th>
                                        <th>ì—¬í–‰ê¸°ê°„</th>
                                        <th>ì¸ì›</th>
                                        <th>êµ¬ì„±ìš”ì†Œ</th>
                                        <th>ìƒíƒœ</th>
                                        <th>ê´€ë¦¬</th>
                                    </tr>
                                </thead>
                                <tbody id="reservations-tbody">
                                    <tr>
                                        <td colspan="10" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ìƒì„¸ ëª¨ë‹¬ -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">íŒ¨í‚¤ì§€ ì˜ˆì•½ ìƒì„¸</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modal-body-content">
                    <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    <a href="#" id="edit-link" class="btn btn-primary">ìˆ˜ì •</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allReservations = [];

        // ì˜ˆì•½ ëª©ë¡ ë¡œë“œ
        async function loadReservations() {
            try {
                const dateType = document.getElementById('dateTypeFilter').value;
                const startDate = document.getElementById('startDateFilter').value;
                const endDate = document.getElementById('endDateFilter').value;
                const status = document.getElementById('statusFilter').value;
                const platform = document.getElementById('platformFilter').value;
                const search = document.getElementById('searchInput').value;

                const params = new URLSearchParams();
                if (dateType && startDate && endDate) {
                    params.append('dateType', dateType);
                    params.append('startDate', startDate);
                    params.append('endDate', endDate);
                }
                if (status !== 'all') params.append('status', status);
                if (platform) params.append('platform', platform);
                if (search) params.append('search', search);

                const response = await fetch(`/api/package-reservations?${params}`);
                const result = await response.json();

                if (result.success) {
                    allReservations = result.data;
                    renderReservations(result.data);
                    updateStats(result.data);
                } else {
                    alert('ì˜ˆì•½ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                console.error('ì˜ˆì•½ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('reservations-tbody').innerHTML = `
                    <tr><td colspan="10" class="text-center text-danger">
                        ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}
                    </td></tr>
                `;
            }
        }

        // ì˜ˆì•½ ëª©ë¡ ë Œë”ë§
        function renderReservations(reservations) {
            const tbody = document.getElementById('reservations-tbody');

            if (reservations.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="10" class="text-center text-muted">
                        ë“±ë¡ëœ íŒ¨í‚¤ì§€ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.
                    </td></tr>
                `;
                return;
            }

            tbody.innerHTML = reservations.map(r => {
                const departureDate = new Date(r.travel_period.departure_date).toLocaleDateString('ko-KR', {year: 'numeric', month: '2-digit', day: '2-digit'}).replace(/\. /g, '-').replace('.', '');
                const returnDate = new Date(r.travel_period.return_date).toLocaleDateString('ko-KR', {year: 'numeric', month: '2-digit', day: '2-digit'}).replace(/\. /g, '-').replace('.', '');
                const createdDate = new Date(r.createdAt).toLocaleDateString('ko-KR', {year: 'numeric', month: '2-digit', day: '2-digit'}).replace(/\. /g, '-').replace('.', '');
                
                const period = `${r.travel_period.nights}ë°•${r.travel_period.days}ì¼`;
                const people = `ì„±ì¸${r.people.adult}${r.people.child > 0 ? `/ì†Œì•„${r.people.child}` : ''}${r.people.infant > 0 ? `/ìœ ì•„${r.people.infant}` : ''}`;

                const componentIcons = r.cost_components.map(c => {
                    const icons = {
                        flight: 'âœˆï¸',
                        ground: 'ğŸš—',
                        hotel: 'ğŸ¨',
                        tour: 'ğŸ¯',
                        other: 'ğŸ“¦'
                    };
                    return icons[c.component_type] || 'ğŸ“¦';
                }).join(' ');

                const reservationStatus = r.reservation_status || 'pending';
                const statusClass = `status-${reservationStatus}`;
                const statusText = {
                    pending: 'ëŒ€ê¸°',
                    confirmed: 'í™•ì •',
                    cancelled: 'ì·¨ì†Œ'
                }[reservationStatus] || reservationStatus;

                return `
                    <tr>
                        <td><small>${departureDate}</small></td>
                        <td><small>${createdDate}</small></td>
                        <td><small>${r.platform_name}</small></td>
                        <td>${r.package_name}</td>
                        <td>${r.customer.korean_name}</td>
                        <td><small>${period}</small></td>
                        <td><small>${people}</small></td>
                        <td class="component-icons">${componentIcons}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td class="action-icons">
                            <button class="btn btn-sm btn-outline-primary" onclick="openEditModal('${r._id}')" title="ì˜ˆì•½ìˆ˜ì •">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="openAssignmentModal('${r._id}')" title="ìˆ˜ë°°ì„œ">
                                <i class="fas fa-file-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="openInvoiceModal('${r._id}')" title="í™•ì •ì„œ">
                                <i class="fas fa-file-invoice"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="openSettlementModal('${r._id}')" title="ì •ì‚°ê´€ë¦¬">
                                <i class="fas fa-calculator"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats(reservations) {
            const total = reservations.length;
            const totalRevenue = reservations.reduce((sum, r) => sum + r.settlement.total_revenue_krw, 0);
            const totalCost = reservations.reduce((sum, r) => sum + r.settlement.total_cost_krw, 0);
            const totalMargin = reservations.reduce((sum, r) => sum + r.settlement.total_margin_krw, 0);

            document.getElementById('stat-total').textContent = `${total}ê±´`;
            document.getElementById('stat-revenue').textContent = `â‚©${totalRevenue.toLocaleString()}`;
            document.getElementById('stat-cost').textContent = `â‚©${totalCost.toLocaleString()}`;
            document.getElementById('stat-margin').textContent = `â‚©${totalMargin.toLocaleString()}`;
            document.getElementById('stat-margin').className = totalMargin >= 0 ? 'margin-positive' : 'margin-negative';
        }

        // ìƒì„¸ ë³´ê¸°
        async function showDetail(id) {
            try {
                const response = await fetch(`/api/package-reservations/${id}`);
                const result = await response.json();

                if (result.success) {
                    const r = result.data;
                    const departureDate = new Date(r.travel_period.departure_date).toLocaleDateString('ko-KR');
                    const returnDate = new Date(r.travel_period.return_date).toLocaleDateString('ko-KR');

                    const componentsHTML = r.cost_components.map(c => {
                        const typeNames = {
                            flight: 'âœˆï¸ í•­ê³µê¶Œ',
                            hotel: 'ğŸ¨ í˜¸í…”',
                            tour: 'ğŸ¯ íˆ¬ì–´',
                            other: 'ğŸ“¦ ê¸°íƒ€'
                        };
                        return `
                            <tr>
                                <td>${typeNames[c.component_type]}</td>
                                <td>${c.vendor_name}</td>
                                <td>${c.cost_currency === 'KRW' ? 'â‚©' : '$'}${c.cost_amount.toLocaleString()}</td>
                                <td>â‚©${c.cost_krw.toLocaleString()}</td>
                                <td>${c.notes || '-'}</td>
                            </tr>
                        `;
                    }).join('');

                    document.getElementById('modal-body-content').innerHTML = `
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>ì˜ˆì•½ë²ˆí˜¸</h6>
                                <p><strong>${r.reservation_number}</strong></p>
                            </div>
                            <div class="col-md-6">
                                <h6>ì˜ˆì•½ ì±„ë„</h6>
                                <p>${r.platform_name}</p>
                            </div>
                        </div>
                        <div class="mb-3">
                            <h6>íŒ¨í‚¤ì§€ëª…</h6>
                            <p>${r.package_name}</p>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>ê³ ê° ì •ë³´</h6>
                                <p>
                                    ${r.customer.korean_name} (${r.customer.english_name || '-'})<br>
                                    ${r.customer.phone || '-'}<br>
                                    ${r.customer.email || '-'}
                                </p>
                            </div>
                            <div class="col-md-6">
                                <h6>ì—¬í–‰ ê¸°ê°„</h6>
                                <p>
                                    ${departureDate} ~ ${returnDate}<br>
                                    ${r.travel_period.nights}ë°•${r.travel_period.days}ì¼
                                </p>
                            </div>
                        </div>
                        <div class="mb-3">
                            <h6>ì¸ì›</h6>
                            <p>ì„±ì¸ ${r.people.adult}ëª…, ì†Œì•„ ${r.people.child}ëª…, ìœ ì•„ ${r.people.infant}ëª…</p>
                        </div>
                        <div class="mb-3">
                            <h6>êµ¬ì„±ìš”ì†Œ</h6>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>íƒ€ì…</th>
                                        <th>ê³µê¸‰ì—…ì²´</th>
                                        <th>ë§¤ì…ê°€</th>
                                        <th>ì›í™”í™˜ì‚°</th>
                                        <th>ë¹„ê³ </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${componentsHTML}
                                </tbody>
                            </table>
                        </div>
                        <div class="mb-3">
                            <h6>ì •ì‚° ì •ë³´</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td>ì´ ê±°ë˜ì•¡</td>
                                    <td class="text-end"><strong>â‚©${r.settlement.total_revenue_krw.toLocaleString()}</strong></td>
                                </tr>
                                <tr>
                                    <td>ì´ ë§¤ì…ì•¡</td>
                                    <td class="text-end">â‚©${r.settlement.total_cost_krw.toLocaleString()}</td>
                                </tr>
                                <tr class="table-primary">
                                    <td><strong>ë§ˆì§„</strong></td>
                                    <td class="text-end ${r.settlement.total_margin_krw >= 0 ? 'margin-positive' : 'margin-negative'}">
                                        <strong>â‚©${r.settlement.total_margin_krw.toLocaleString()} (${r.settlement.margin_rate}%)</strong>
                                    </td>
                                </tr>
                                <tr>
                                    <td>ë¶€ê°€ì„¸</td>
                                    <td class="text-end">â‚©${r.settlement.vat_amount.toLocaleString()}</td>
                                </tr>
                            </table>
                        </div>
                        ${r.special_requests ? `
                            <div class="mb-3">
                                <h6>íŠ¹ë³„ ìš”ì²­ì‚¬í•­</h6>
                                <p>${r.special_requests}</p>
                            </div>
                        ` : ''}
                    `;

                    document.getElementById('edit-link').href = `/admin/package-inbox?id=${id}`;

                    new bootstrap.Modal(document.getElementById('detailModal')).show();
                } else {
                    alert('ìƒì„¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                console.error('ìƒì„¸ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ìƒì„¸ ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê²€ìƒ‰
        function handleSearch(event) {
            if (event.key === 'Enter') {
                loadReservations();
            }
        }

        // í•„í„° ì´ˆê¸°í™”
        function resetFilters() {
            document.getElementById('dateTypeFilter').value = 'departure';
            document.getElementById('startDateFilter').value = '';
            document.getElementById('endDateFilter').value = '';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('platformFilter').value = '';
            document.getElementById('searchInput').value = '';
            loadReservations();
        }

        // ëª¨ë‹¬ í•¨ìˆ˜ë“¤ (ì¶”í›„ êµ¬í˜„)
        function openEditModal(id) {
            alert('ì˜ˆì•½ìˆ˜ì • ëª¨ë‹¬ - ì¶”í›„ êµ¬í˜„ ì˜ˆì • (ID: ' + id + ')');
        }

        function openAssignmentModal(id) {
            alert('ìˆ˜ë°°ì„œ ëª¨ë‹¬ - ì¶”í›„ êµ¬í˜„ ì˜ˆì • (ID: ' + id + ')');
        }

        function openInvoiceModal(id) {
            alert('í™•ì •ì„œ ëª¨ë‹¬ - ì¶”í›„ êµ¬í•¨ ì˜ˆì • (ID: ' + id + ')');
        }

        function openSettlementModal(id) {
            alert('ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬ - ì¶”í›„ êµ¬í˜„ ì˜ˆì • (ID: ' + id + ')');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('load', () => {
            loadReservations();
        });
    </script>
</body>
</html>
