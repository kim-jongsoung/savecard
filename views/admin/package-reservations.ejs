<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ìå®ÌÇ§ÏßÄ ÏòàÏïΩ Í¥ÄÎ¶¨ - Í¥åÏÑ∏Ïù¥Î∏åÏπ¥Îìú Í¥ÄÎ¶¨Ïûê</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-confirmed { background-color: #d4edda; color: #155724; }
        .status-cancelled { background-color: #f8d7da; color: #721c24; }
        .action-icons .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .component-icons {
            font-size: 1.2rem;
        }
        .margin-positive { color: #198754; font-weight: bold; }
        .margin-negative { color: #dc3545; font-weight: bold; }
        .last-edited-row {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107 !important;
            transition: background-color 0.3s ease;
        }
        .last-edited-row:hover {
            background-color: #ffe69c !important;
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar', { currentPage: 'package-reservations', adminUsername: adminUsername || 'Í¥ÄÎ¶¨Ïûê' }) %>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-box-open me-2"></i>Ìå®ÌÇ§ÏßÄ ÏòàÏïΩ Í¥ÄÎ¶¨</h2>
                    <a href="/admin/package-inbox" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>ÏÉà Ìå®ÌÇ§ÏßÄ ÏòàÏïΩ Îì±Î°ù
                    </a>
                </div>

                <!-- ÌïÑÌÑ∞ -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-md-2">
                                <label class="form-label">ÎÇ†Ïßú Í∏∞Ï§Ä</label>
                                <select class="form-select" id="dateTypeFilter">
                                    <option value="departure">Ï∂úÎ∞úÏùº</option>
                                    <option value="created">ÏòàÏïΩÏùº</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">ÏãúÏûëÏùº</label>
                                <input type="date" class="form-control" id="startDateFilter">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Ï¢ÖÎ£åÏùº</label>
                                <input type="date" class="form-control" id="endDateFilter">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">ÏòàÏïΩ Ï±ÑÎÑê</label>
                                <select class="form-select" id="platformFilter">
                                    <option value="">Ï†ÑÏ≤¥</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">ÏÉÅÌÉú</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="all">Ï†ÑÏ≤¥</option>
                                    <option value="pending">ÎåÄÍ∏∞</option>
                                    <option value="confirmed">ÌôïÏ†ï</option>
                                    <option value="cancelled">Ï∑®ÏÜå</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Í≤ÄÏÉâ</label>
                                <input type="text" class="form-control" id="searchInput" 
                                       placeholder="ÏòàÏïΩÎ≤àÌò∏, Í≥†Í∞ùÎ™Ö">
                            </div>
                        </div>
                        <div class="row g-2">
                            <div class="col-md-12 text-end">
                                <button class="btn btn-primary" onclick="loadReservations()">
                                    <i class="fas fa-search me-1"></i>Í≤ÄÏÉâÌïòÍ∏∞
                                </button>
                                <button class="btn btn-outline-secondary" onclick="resetFilters()">
                                    <i class="fas fa-redo me-1"></i>Ï¥àÍ∏∞Ìôî
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÌÜµÍ≥Ñ -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="text-muted">Ï¥ù ÏòàÏïΩ</h6>
                                <h3 id="stat-total">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="text-muted">Ï¥ù Í±∞ÎûòÏï°</h6>
                                <h3 id="stat-revenue">‚Ç©0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="text-muted">Ï¥ù Îß§ÏûÖÏï°</h6>
                                <h3 id="stat-cost">‚Ç©0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="text-muted">Ï¥ù ÎßàÏßÑ</h6>
                                <h3 id="stat-margin" class="margin-positive">‚Ç©0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÏòàÏïΩ Î™©Î°ù -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Ï∂úÎ∞úÏùº</th>
                                        <th>ÏòàÏïΩÏùº</th>
                                        <th>ÏòàÏïΩÏ±ÑÎÑê</th>
                                        <th>ÏòàÏïΩÎ≤àÌò∏</th>
                                        <th>ÏÉÅÌíàÎ™Ö</th>
                                        <th>Í≥†Í∞ùÎ™Ö</th>
                                        <th>Ïó¨ÌñâÍ∏∞Í∞Ñ</th>
                                        <th>Ïù∏Ïõê</th>
                                        <th>Íµ¨ÏÑ±ÏöîÏÜå</th>
                                        <th>ÏÉÅÌÉú</th>
                                        <th>Í¥ÄÎ¶¨</th>
                                    </tr>
                                </thead>
                                <tbody id="reservations-tbody">
                                    <tr>
                                        <td colspan="11" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Î°úÎî© Ï§ë...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÏÉÅÏÑ∏ Î™®Îã¨ -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ìå®ÌÇ§ÏßÄ ÏòàÏïΩ ÏÉÅÏÑ∏</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modal-body-content">
                    <!-- ÎèôÏ†ÅÏúºÎ°ú Ï±ÑÏõåÏßê -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
                    <a href="#" id="edit-link" class="btn btn-primary">ÏàòÏ†ï</a>
                </div>
            </div>
        </div>
    </div>

    <!-- ÏòàÏïΩÏàòÏ†ï Î™®Îã¨ -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Ìå®ÌÇ§ÏßÄ ÏòàÏïΩ ÏàòÏ†ï</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <form id="editForm">
                        <input type="hidden" id="edit_reservation_id">
                        
                        <!-- Í∏∞Î≥∏ ÏòàÏïΩ Ï†ïÎ≥¥ -->
                        <div>
                            <h6 style="font-size: 1rem; margin-bottom: 0.75rem;">üìã Í∏∞Î≥∏ ÏòàÏïΩ Ï†ïÎ≥¥</h6>
                            
                            <!-- ÏòàÏïΩÎ≤àÌò∏ ÌëúÏãú -->
                            <div class="row mb-2">
                                <div class="col-md-12">
                                    <div class="alert alert-info py-2 mb-2">
                                        <strong>ÏòàÏïΩÎ≤àÌò∏:</strong> <span id="edit_reservation_number_display"></span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ÌïúÏ§Ñ ÏöîÏïΩ Ï†ïÎ≥¥ -->
                            <div class="row mb-2">
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.875rem;">ÏòàÏïΩ ÏÉÅÌÉú *</label>
                                    <select class="form-select" id="edit_reservation_status" required>
                                        <option value="pending">‚è≥ ÎåÄÍ∏∞</option>
                                        <option value="confirmed">‚úÖ ÌôïÏ†ï</option>
                                        <option value="cancelled">‚ùå Ï∑®ÏÜå</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.875rem;">ÏòàÏïΩÏ±ÑÎÑê *</label>
                                    <input type="text" class="form-control" id="edit_platform_name" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.875rem;">ÏòàÏïΩÎ≤àÌò∏</label>
                                    <input type="text" class="form-control" id="edit_reservation_number_field" readonly style="background-color: #e9ecef;">
                                    <small class="text-muted">ÏàòÏ†ï Î∂àÍ∞Ä</small>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.875rem;">Ìå®ÌÇ§ÏßÄÎ™Ö *</label>
                                    <input type="text" class="form-control" id="edit_package_name" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.875rem;">Ï∂úÎ∞úÏùº *</label>
                                    <input type="date" class="form-control" id="edit_departure_date" onchange="calculateEditNights()" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.875rem;">Í∑ÄÍµ≠Ïùº *</label>
                                    <input type="date" class="form-control" id="edit_return_date" onchange="calculateEditNights()" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.875rem;">Í∏∞Í∞Ñ</label>
                                    <input type="text" class="form-control" id="edit_period_display" readonly placeholder="ÏûêÎèô">
                                </div>
                            </div>

                            <div class="row mb-2">
                                <div class="col-md-1">
                                    <label class="form-label" style="font-size: 0.875rem;">Ï∂úÍµ≠Ìé∏Î™Ö</label>
                                    <input type="text" class="form-control" id="edit_outbound_flight" placeholder="OZ601">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label" style="font-size: 0.875rem;">Ï∂úÎ∞úÏãúÍ∞Ñ</label>
                                    <input type="time" class="form-control" id="edit_outbound_departure_time">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label" style="font-size: 0.875rem;">ÎèÑÏ∞©ÏãúÍ∞Ñ</label>
                                    <input type="time" class="form-control" id="edit_outbound_arrival_time">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label" style="font-size: 0.875rem;">ÏûÖÍµ≠Ìé∏Î™Ö</label>
                                    <input type="text" class="form-control" id="edit_inbound_flight" placeholder="OZ602">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label" style="font-size: 0.875rem;">Ï∂úÎ∞úÏãúÍ∞Ñ</label>
                                    <input type="time" class="form-control" id="edit_inbound_departure_time">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label" style="font-size: 0.875rem;">ÎèÑÏ∞©ÏãúÍ∞Ñ</label>
                                    <input type="time" class="form-control" id="edit_inbound_arrival_time">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label" style="font-size: 0.875rem;">Ïù¥Ïö©Ìò∏ÌÖî</label>
                                    <input type="text" class="form-control" id="edit_hotel_name" placeholder="Ìò∏ÌÖîÎ™Ö">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label" style="font-size: 0.875rem;">Î£∏ÌÉÄÏûÖÎ™Ö</label>
                                    <input type="text" class="form-control" id="edit_room_type" placeholder="ÎîîÎü≠Ïä§ Ïò§ÏÖòÎ∑∞">
                                </div>
                            </div>

                            <!-- Ïù∏Ïõê ÏûÖÎ†• -->
                            <h6 style="font-size: 0.95rem; margin-top: 1rem; margin-bottom: 0.75rem;">üë• Ïù∏Ïõê Íµ¨ÏÑ±</h6>
                            <div class="row mb-2">
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.875rem;">ÏÑ±Ïù∏</label>
                                    <input type="number" class="form-control" id="edit_people_adult" value="0" min="0" onchange="generateEditGuestFields(); calculateEditTotalPrice();">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.875rem;">ÏÜåÏïÑ</label>
                                    <input type="number" class="form-control" id="edit_people_child" value="0" min="0" onchange="generateEditGuestFields(); calculateEditTotalPrice();">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.875rem;">Ïú†ÏïÑ</label>
                                    <input type="number" class="form-control" id="edit_people_infant" value="0" min="0" onchange="generateEditGuestFields(); calculateEditTotalPrice();">
                                </div>
                            </div>

                            <!-- ÎèôÏ†Å Í≥†Í∞ù Ï†ïÎ≥¥ ÌïÑÎìú -->
                            <div id="edit_guests_container" class="mt-3"></div>

                            <!-- ÏùºÏ†ï Î∞è Ìè¨Ìï®/Î∂àÌè¨Ìï® ÏÇ¨Ìï≠ -->
                            <h6 style="font-size: 0.95rem; margin-top: 1rem; margin-bottom: 0.75rem;">üìÖ ÏùºÏ†ï Î∞è Ìè¨Ìï®/Î∂àÌè¨Ìï® ÏÇ¨Ìï≠</h6>
                            <div class="row mb-2">
                                <div class="col-md-6">
                                    <label class="form-label" style="font-size: 0.875rem;">ÏùºÏ†ï</label>
                                    <textarea class="form-control" id="edit_itinerary" rows="4" placeholder="1ÏùºÏ∞®: Ïù∏Ï≤úÍ≥µÌï≠ Ï∂úÎ∞ú ‚Üí Í¥å ÎèÑÏ∞©&#10;2ÏùºÏ∞®: ÏûêÏú†ÏùºÏ†ï&#10;3ÏùºÏ∞®: ÏãúÎÇ¥Í¥ÄÍ¥ë&#10;4ÏùºÏ∞®: Í∑ÄÍµ≠"></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" style="font-size: 0.875rem;">Ìè¨Ìï®ÏÇ¨Ìï≠</label>
                                    <textarea class="form-control" id="edit_inclusions" rows="2" placeholder="ÏôïÎ≥µÌï≠Í≥µÍ∂å, Ìò∏ÌÖîÏàôÎ∞ï, Í≥µÌï≠ÌîΩÏóÖ, Ï°∞Ïãù Îì±"></textarea>
                                    <label class="form-label mt-2" style="font-size: 0.875rem;">Î∂àÌè¨Ìï®ÏÇ¨Ìï≠</label>
                                    <textarea class="form-control" id="edit_exclusions" rows="2" placeholder="Í∞úÏù∏Í≤ΩÎπÑ, ÏÑ†ÌÉùÍ¥ÄÍ¥ë, Ïó¨ÌñâÏûêÎ≥¥Ìóò Îì±"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Í∏àÏï° Ï†ïÎ≥¥ -->
                        <div class="section-divider" style="border-top: 1px solid #dee2e6; margin: 20px 0; padding-top: 20px;">
                            <h6 style="font-size: 1rem; margin-bottom: 0.75rem;">üí∞ Í∏àÏï° Ï†ïÎ≥¥</h6>
                            
                            <!-- Ïù∏ÏõêÎ≥Ñ ÌåêÎß§Í∞Ä -->
                            <h6 style="font-size: 0.95rem; margin-bottom: 0.75rem;">üë• Ïù∏ÏõêÎ≥Ñ ÌåêÎß§Í∞Ä</h6>
                            <div class="row mb-2">
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.875rem;">ÌÜµÌôî *</label>
                                    <select class="form-select" id="edit_currency">
                                        <option value="KRW">KRW</option>
                                        <option value="USD">USD</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.875rem;">ÌôòÏú®</label>
                                    <input type="text" class="form-control" id="edit_exchange_rate" value="1,300" oninput="formatCurrency(this); calculateEditSummary();">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.875rem;">ÏÑ±Ïù∏ 1Ïù∏ ÏöîÍ∏à *</label>
                                    <input type="text" class="form-control" id="edit_price_adult" placeholder="500,000" oninput="formatCurrency(this); calculateEditTotalPrice();">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.875rem;">ÏÜåÏïÑ 1Ïù∏ ÏöîÍ∏à</label>
                                    <input type="text" class="form-control" id="edit_price_child" placeholder="400,000" oninput="formatCurrency(this); calculateEditTotalPrice();">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.875rem;">Ïú†ÏïÑ 1Ïù∏ ÏöîÍ∏à</label>
                                    <input type="text" class="form-control" id="edit_price_infant" placeholder="100,000" oninput="formatCurrency(this); calculateEditTotalPrice();">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.875rem;">Ï¥ù ÌåêÎß§Í∞Ä</label>
                                    <input type="text" class="form-control" id="edit_total_selling_price" readonly style="background-color: #e9ecef; font-weight: bold;">
                                </div>
                            </div>

                            <!-- Í∏àÏï° Î≥ÄÎèô Ï∂îÍ∞Ä Ìï≠Î™© -->
                            <div class="row mt-2">
                                <div class="col-md-12">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addEditPriceAdjustment()">
                                        <i class="fas fa-plus"></i> Í∏àÏï° Î≥ÄÎèô Ï∂îÍ∞Ä
                                    </button>
                                </div>
                            </div>
                            <div id="edit_price_adjustments_container" class="mt-2"></div>

                            <!-- Í≤∞Ï†ú ÎπåÎßÅ -->
                            <h6 style="font-size: 0.95rem; margin-top: 1rem; margin-bottom: 0.75rem;">üí≥ Í≤∞Ï†ú ÎπåÎßÅ</h6>
                            <div id="edit_billings_container"></div>
                            <button type="button" class="btn btn-sm btn-outline-success mb-3" onclick="addEditBilling()">
                                <i class="fas fa-plus me-1"></i>Í≤∞Ï†ú Ï∂îÍ∞Ä
                            </button>

                            <!-- Îß§ÏûÖ Íµ¨ÏÑ±ÏöîÏÜå -->
                            <h6 style="font-size: 0.95rem; margin-top: 1rem; margin-bottom: 0.75rem;">üì¶ Îß§ÏûÖ Íµ¨ÏÑ±ÏöîÏÜå</h6>
                            <div id="edit_components_container"></div>
                            <button type="button" class="btn btn-sm btn-outline-primary mb-3" onclick="addEditComponent()">
                                <i class="fas fa-plus me-1"></i>Íµ¨ÏÑ±ÏöîÏÜå Ï∂îÍ∞Ä
                            </button>
                            
                            <!-- Í∏àÏï° ÏöîÏïΩ -->
                            <div class="summary-box mt-3">
                                <h6 style="font-size: 1rem; margin-bottom: 0.75rem;">üíµ Í∏àÏï° ÏöîÏïΩ</h6>
                                <div class="summary-row">
                                    <span><strong>Ï¥ù ÌåêÎß§Í∞Ä:</strong></span>
                                    <span id="edit_summary_revenue" style="font-weight: bold;">‚Ç©0</span>
                                </div>
                                <div id="edit_summary_revenue_detail" style="font-size: 0.8rem; color: #6c757d; margin-left: 10px; margin-bottom: 8px;"></div>
                                
                                <div class="summary-row">
                                    <span><strong>Ï¥ù Îß§ÏûÖÍ∞Ä:</strong></span>
                                    <span id="edit_summary_cost" style="font-weight: bold;">‚Ç©0</span>
                                </div>
                                <div id="edit_summary_cost_detail" style="font-size: 0.8rem; color: #6c757d; margin-left: 10px; margin-bottom: 8px;"></div>
                                
                                <div class="summary-row summary-total">
                                    <span>ÏòàÏÉÅ ÎßàÏßÑ:</span>
                                    <span id="edit_summary_margin">‚Ç©0 (0%)</span>
                                </div>
                                <div class="summary-row">
                                    <span>Î∂ÄÍ∞ÄÏÑ∏ (ÎßàÏßÑÏùò 10%):</span>
                                    <span id="edit_summary_vat">‚Ç©0</span>
                                </div>
                            </div>

                            <!-- ÌäπÎ≥Ñ ÏöîÏ≤≠ÏÇ¨Ìï≠ -->
                            <div class="mb-2 mt-3">
                                <label class="form-label" style="font-size: 0.875rem;">ÌäπÎ≥Ñ ÏöîÏ≤≠ÏÇ¨Ìï≠</label>
                                <textarea class="form-control" id="edit_special_requests" rows="2" placeholder="ÌäπÎ≥Ñ ÏöîÏ≤≠ÏÇ¨Ìï≠Ïù¥ ÏûàÏúºÎ©¥ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                            </div>
                        </div>

                        <!-- ÏàòÏ†ï Ïù¥Î†• -->
                        <div class="section-divider" style="border-top: 1px solid #dee2e6; margin: 20px 0; padding-top: 20px;">
                            <h6 style="font-size: 1rem; margin-bottom: 0.75rem;">üìú ÏàòÏ†ï Ïù¥Î†•</h6>
                            <div id="modification_history_container" style="max-height: 200px; overflow-y: auto;">
                                <p class="text-muted mb-0" style="font-size: 0.875rem;">ÏàòÏ†ï Ïù¥Î†•Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Ï∑®ÏÜå
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveReservationEdit()">
                        <i class="fas fa-save me-1"></i>Ï†ÄÏû•
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÏàòÎ∞∞ÏÑú Î™®Îã¨ -->
    <div class="modal fade" id="assignmentModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-file-alt me-2"></i>ÏàòÎ∞∞ÏÑú Í¥ÄÎ¶¨</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Í∏∞Î≥∏ ÏòàÏïΩ Ï†ïÎ≥¥ -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Í∏∞Î≥∏ ÏòàÏïΩ Ï†ïÎ≥¥</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>ÏòàÏïΩÎ≤àÌò∏:</strong> <span id="assign_reservation_number"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Í≥†Í∞ùÎ™Ö:</strong> <span id="assign_customer_name"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Ï∂úÎ∞úÏùº:</strong> <span id="assign_departure_date"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Í∑ÄÍµ≠Ïùº:</strong> <span id="assign_return_date"></span>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-3">
                                    <strong>Í∏∞Í∞Ñ:</strong> <span id="assign_period"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Ïù∏Ïõê:</strong> <span id="assign_people"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Ìå®ÌÇ§ÏßÄÎ™Ö:</strong> <span id="assign_package_name"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>ÏòàÏïΩÏ±ÑÎÑê:</strong> <span id="assign_platform_name"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Îß§ÏûÖ Íµ¨ÏÑ±ÏöîÏÜåÎ≥Ñ ÏàòÎ∞∞ÏÑú Î™©Î°ù -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-list me-2"></i>Îß§ÏûÖ Íµ¨ÏÑ±ÏöîÏÜåÎ≥Ñ ÏàòÎ∞∞ÏÑú</h6>
                        </div>
                        <div class="card-body">
                            <div id="assignment_list"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAssignmentModal()">
                        <i class="fas fa-times me-1"></i>Îã´Í∏∞
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ïù¥Î†•Î≥Ñ ÏàòÎ∞∞ÏÑú Î≥¥Í∏∞ Î™®Îã¨ -->
    <div class="modal fade" id="historyAssignmentModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-history me-2"></i>ÏàòÎ∞∞ÏÑú Ïù¥Î†• Î≥¥Í∏∞</h5>
                    <button type="button" class="btn-close btn-close-white" onclick="closeHistoryModal()"></button>
                </div>
                <div class="modal-body" id="history_assignment_content" style="max-height: 70vh; overflow-y: auto;">
                    <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ± -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeHistoryModal()">
                        <i class="fas fa-times me-1"></i>Îã´Í∏∞
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÏûÖÍ∏àÍ¥ÄÎ¶¨ Î™®Îã¨ -->
    <div class="modal fade" id="settlementModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-money-bill-wave me-2"></i>ÏûÖÍ∏àÍ¥ÄÎ¶¨</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <input type="hidden" id="settlement_reservation_id">
                    
                    <!-- Í∏∞Î≥∏ ÏòàÏïΩ Ï†ïÎ≥¥ -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Í∏∞Î≥∏ ÏòàÏïΩ Ï†ïÎ≥¥</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Ï∂úÎ∞úÏùº:</strong> <span id="settle_departure_date"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>ÏòàÏïΩÏ±ÑÎÑê:</strong> <span id="settle_platform_name"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>ÏòàÏïΩÎ≤àÌò∏:</strong> <span id="settle_reservation_number"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Í≥†Í∞ùÎ™Ö:</strong> <span id="settle_customer_name"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÏûÖÍ∏à Í¥ÄÎ¶¨ ÏÑπÏÖò -->
                    <div class="card mb-3">
                        <div class="card-header" style="background-color: #d1ecf1;">
                            <h6 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>ÏûÖÍ∏à Í¥ÄÎ¶¨ (Î∞õÏïÑÏïº Ìï† Í∏àÏï°)</h6>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-3">
                                <strong>Ï¥ù Î∞õÏïÑÏïº Ìï† Í∏àÏï°:</strong> <span id="settle_total_amount" style="font-size: 1.2rem; font-weight: bold;"></span>
                            </div>
                            
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Í≤∞Ï†úÎ∞©Î≤ï</th>
                                        <th>Í∏àÏï°</th>
                                        <th>ÏûÖÍ∏àÎÇ†Ïßú</th>
                                        <th>ÏÉÅÌÉú</th>
                                        <th>ÎπÑÍ≥†</th>
                                        <th>Í¥ÄÎ¶¨</th>
                                    </tr>
                                </thead>
                                <tbody id="settle_billings_list">
                                    <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ± -->
                                </tbody>
                            </table>
                            
                            <div class="mt-2">
                                <strong>ÏûÖÍ∏à ÏôÑÎ£å Í∏àÏï°:</strong> <span id="settle_received_amount" class="text-success"></span> / 
                                <strong>ÎØ∏ÏûÖÍ∏à Í∏àÏï°:</strong> <span id="settle_pending_amount" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Îã´Í∏∞
                    </button>
                    <button type="button" class="btn btn-success" onclick="sendToSettlementPage()" id="send_to_settlement_btn" style="display: none;">
                        <i class="fas fa-arrow-right me-1"></i>Ï†ïÏÇ∞Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄÎ°ú Ï†ÑÏÜ°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÌôïÏ†ïÏÑú Î™®Îã¨ -->
    <div class="modal fade" id="invoiceModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-file-invoice me-2"></i>ÌôïÏ†ïÏÑú Î∞úÏÜ°</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <!-- ÌôïÏ†ïÏÑú ÏÉùÏÑ± ÏÉÅÌÉú Î∞è Ïù¥Î†• -->
                    <div class="card mb-3" style="border-left: 4px solid #ffc107;">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <div id="confirmation_status">
                                        <span class="badge bg-secondary">ÎØ∏ÏÉùÏÑ±</span>
                                    </div>
                                </div>
                                <div class="col-md-6 text-end">
                                    <button class="btn btn-sm btn-link p-0" id="confirmation_history_toggle" onclick="toggleConfirmationHistory()" style="display: none;">
                                        <i class="fas fa-history me-1"></i>ÏÉùÏÑ±Ïù¥Î†• (<span id="confirmation_history_count">0</span>)
                                    </button>
                                </div>
                            </div>
                            <div id="confirmation_history_list" class="mt-2" style="display: none;">
                                <div class="border-top pt-2">
                                    <strong class="text-muted" style="font-size: 0.85rem;">ÏÉùÏÑ± Ïù¥Î†•</strong>
                                    <div class="mt-1" id="confirmation_history_items"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Í∏∞Î≥∏ ÏòàÏïΩ Ï†ïÎ≥¥ -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Í∏∞Î≥∏ ÏòàÏïΩ Ï†ïÎ≥¥</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>ÏòàÏïΩÎ≤àÌò∏:</strong> <span id="invoice_reservation_number"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Í≥†Í∞ùÎ™Ö:</strong> <span id="invoice_customer_name"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Ï∂úÎ∞úÏùº:</strong> <span id="invoice_departure_date"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Í∑ÄÍµ≠Ïùº:</strong> <span id="invoice_return_date"></span>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-3">
                                    <strong>Í∏∞Í∞Ñ:</strong> <span id="invoice_period"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Ïù∏Ïõê:</strong> <span id="invoice_people"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Ìå®ÌÇ§ÏßÄÎ™Ö:</strong> <span id="invoice_package_name"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>ÏòàÏïΩÏ±ÑÎÑê:</strong> <span id="invoice_platform_name"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ï≤≠Íµ¨ Í∏àÏï° Ï†ïÎ≥¥ -->
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>Ï≤≠Íµ¨ Í∏àÏï°</h6>
                        </div>
                        <div class="card-body">
                            <!-- Ïù∏ÏõêÎ≥Ñ ÌåêÎß§Í∞Ä -->
                            <div class="mb-3">
                                <h6 class="text-primary"><i class="fas fa-users me-2"></i>Ïù∏ÏõêÎ≥Ñ ÌåêÎß§Í∞Ä</h6>
                                <div id="invoice_per_person_prices"></div>
                            </div>

                            <!-- Í∏àÏï° Î≥ÄÎèô ÎÇ¥Ïó≠ -->
                            <div class="mb-3" id="invoice_price_adjustments_section" style="display: none;">
                                <h6 class="text-info"><i class="fas fa-exchange-alt me-2"></i>Í∏àÏï° Î≥ÄÎèô ÎÇ¥Ïó≠</h6>
                                <div id="invoice_price_adjustments"></div>
                            </div>

                            <!-- Ï¥ù Ï≤≠Íµ¨ Í∏àÏï° -->
                            <div class="alert alert-success mb-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Ï¥ù Ï≤≠Íµ¨ Í∏àÏï°</h5>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <h4 class="mb-0 text-success" id="invoice_total_amount"></h4>
                                    </div>
                                </div>
                            </div>

                            <!-- ÏûÖÍ∏à Í≥ÑÏ¢å Ï†ïÎ≥¥ -->
                            <div class="alert alert-info mb-0">
                                <h6 class="mb-2"><i class="fas fa-university me-2"></i>ÏûÖÍ∏à Í≥ÑÏ¢å Ï†ïÎ≥¥</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>ÏùÄÌñâ:</strong> Ïã†ÌïúÏùÄÌñâ
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Í≥ÑÏ¢åÎ≤àÌò∏:</strong> 140-014-014440
                                    </div>
                                    <div class="col-md-4">
                                        <strong>ÏòàÍ∏àÏ£º:</strong> (Ï£º)Îü≠Ïä§ÌååÏù∏Îìú
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ïó¨Ìñâ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ -->
                    <div class="card mb-3" id="invoice_travel_details_section">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-plane-departure me-2"></i>Ïó¨Ìñâ ÏÉÅÏÑ∏ Ï†ïÎ≥¥</h6>
                        </div>
                        <div class="card-body">
                            <!-- Ìï≠Í≥µÌé∏ Ï†ïÎ≥¥ -->
                            <div class="mb-3" id="invoice_flight_info_section" style="display: none;">
                                <h6><i class="fas fa-plane me-2"></i>Ìï≠Í≥µÌé∏ Ï†ïÎ≥¥</h6>
                                <div id="invoice_flight_info"></div>
                            </div>

                            <!-- Ìò∏ÌÖî Ï†ïÎ≥¥ -->
                            <div class="mb-3" id="invoice_hotel_info_section" style="display: none;">
                                <h6><i class="fas fa-hotel me-2"></i>Ìò∏ÌÖî Ï†ïÎ≥¥</h6>
                                <div id="invoice_hotel_info"></div>
                            </div>

                            <!-- ÏùºÏ†ï Ï†ïÎ≥¥ -->
                            <div class="mb-3" id="invoice_itinerary_section" style="display: none;">
                                <h6><i class="fas fa-calendar-alt me-2"></i>ÏùºÏ†ï</h6>
                                <div id="invoice_itinerary" style="white-space: pre-line;"></div>
                            </div>

                            <!-- Ìè¨Ìï®ÏÇ¨Ìï≠ -->
                            <div class="mb-3" id="invoice_inclusions_section" style="display: none;">
                                <h6><i class="fas fa-check-circle me-2 text-success"></i>Ìè¨Ìï®ÏÇ¨Ìï≠</h6>
                                <div id="invoice_inclusions" style="white-space: pre-line;"></div>
                            </div>

                            <!-- Î∂àÌè¨Ìï®ÏÇ¨Ìï≠ -->
                            <div class="mb-0" id="invoice_exclusions_section" style="display: none;">
                                <h6><i class="fas fa-times-circle me-2 text-danger"></i>Î∂àÌè¨Ìï®ÏÇ¨Ìï≠</h6>
                                <div id="invoice_exclusions" style="white-space: pre-line;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- ÌäπÎ≥Ñ ÏöîÏ≤≠ÏÇ¨Ìï≠ -->
                    <div class="card mb-3" id="invoice_special_requests_section" style="display: none;">
                        <div class="card-header bg-warning">
                            <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>ÌäπÎ≥Ñ ÏöîÏ≤≠ÏÇ¨Ìï≠</h6>
                        </div>
                        <div class="card-body">
                            <div id="invoice_special_requests" style="white-space: pre-line;"></div>
                        </div>
                    </div>

                    <!-- Ïù¥Î©îÏùº Î∞úÏÜ° -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-envelope me-2"></i>Ïù¥Î©îÏùº Î∞úÏÜ°</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">ÏàòÏã† Ïù¥Î©îÏùº *</label>
                                <input type="email" class="form-control" id="invoice_email" placeholder="customer@example.com">
                            </div>
                            <div class="mb-0">
                                <label class="form-label">Î©îÎ™® (ÏÑ†ÌÉù)</label>
                                <textarea class="form-control" id="invoice_memo" rows="2" placeholder="Ï∂îÍ∞Ä Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Îã´Í∏∞
                    </button>
                    <button type="button" class="btn btn-warning" onclick="generateConfirmation()">
                        <i class="fas fa-file-invoice me-1"></i>ÌôïÏ†ïÏÑú ÏÉùÏÑ±
                    </button>
                    <button type="button" class="btn btn-info" onclick="previewConfirmation()">
                        <i class="fas fa-eye me-1"></i>ÎØ∏Î¶¨Î≥¥Í∏∞
                    </button>
                    <button type="button" class="btn btn-success" onclick="copyConfirmationLink()">
                        <i class="fas fa-link me-1"></i>ÎßÅÌÅ¨ Î≥µÏÇ¨
                    </button>
                    <button type="button" class="btn btn-primary" onclick="sendInvoice()">
                        <i class="fas fa-paper-plane me-1"></i>ÌôïÏ†ïÏÑú Î∞úÏÜ°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allReservations = [];
        let lastEditedReservationId = null;
        let suppliers = [];
        let bookingChannels = [];

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Í≥µÍ∏âÏóÖÏ≤¥ Î∞è ÏòàÏïΩÏ±ÑÎÑê Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Í≥µÍ∏âÏóÖÏ≤¥ Î°úÎìú
                const suppliersResponse = await fetch('/api/package-vendors/suppliers');
                const suppliersResult = await suppliersResponse.json();
                if (suppliersResult.success) {
                    suppliers = suppliersResult.data;
                }
                
                // ÏòàÏïΩÏ±ÑÎÑê Î°úÎìú
                await loadBookingChannels();
            } catch (error) {
                console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
            }
        });

        // ÏòàÏïΩÏ±ÑÎÑê Î°úÎìú
        async function loadBookingChannels() {
            try {
                const response = await fetch('/api/package-vendors/channels?active_only=true');
                const data = await response.json();
                
                if (data.success) {
                    bookingChannels = data.data;
                    updatePlatformFilterDropdown();
                }
            } catch (error) {
                console.error('ÏòàÏïΩÏ±ÑÎÑê Î°úÎìú Ïã§Ìå®:', error);
            }
        }

        // ÏòàÏïΩÏ±ÑÎÑê ÌïÑÌÑ∞ ÎìúÎ°≠Îã§Ïö¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updatePlatformFilterDropdown() {
            const select = document.getElementById('platformFilter');
            select.innerHTML = '<option value="">Ï†ÑÏ≤¥</option>';
            
            bookingChannels.forEach(channel => {
                const option = document.createElement('option');
                option.value = channel.channel_name;
                option.textContent = channel.channel_name;
                select.appendChild(option);
            });
        }

        // Í≥µÍ∏âÏóÖÏ≤¥ ÎìúÎ°≠Îã§Ïö¥ ÏóÖÎç∞Ïù¥Ìä∏ (Ïú†ÌòïÎ≥Ñ ÌïÑÌÑ∞ÎßÅ)
        function updateSupplierDropdown(selectElement, supplierType) {
            selectElement.innerHTML = '<option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
            
            const filteredSuppliers = suppliers.filter(s => s.supplier_type === supplierType);
            
            filteredSuppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.supplier_name;
                option.textContent = supplier.supplier_name;
                selectElement.appendChild(option);
            });
        }

        // ÏòàÏïΩ Î™©Î°ù Î°úÎìú
        async function loadReservations() {
            try {
                const dateType = document.getElementById('dateTypeFilter').value;
                const startDate = document.getElementById('startDateFilter').value;
                const endDate = document.getElementById('endDateFilter').value;
                const status = document.getElementById('statusFilter').value;
                const platform = document.getElementById('platformFilter').value;
                const search = document.getElementById('searchInput').value;

                const params = new URLSearchParams();
                if (dateType && startDate && endDate) {
                    params.append('dateType', dateType);
                    params.append('startDate', startDate);
                    params.append('endDate', endDate);
                }
                if (status !== 'all') params.append('status', status);
                if (platform) params.append('platform', platform);
                if (search) params.append('search', search);

                const response = await fetch(`/api/package-reservations?${params}`);
                const result = await response.json();

                if (result.success) {
                    allReservations = result.data;
                    renderReservations(result.data);
                    updateStats(result.data);
                } else {
                    alert('ÏòàÏïΩ Î™©Î°ù Î°úÎìú Ïã§Ìå®: ' + result.message);
                }
            } catch (error) {
                console.error('ÏòàÏïΩ Î™©Î°ù Î°úÎìú Ïò§Î•ò:', error);
                document.getElementById('reservations-tbody').innerHTML = `
                    <tr><td colspan="10" class="text-center text-danger">
                        Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}
                    </td></tr>
                `;
            }
        }

        // ÏòàÏïΩ Î™©Î°ù Î†åÎçîÎßÅ
        function renderReservations(reservations) {
            const tbody = document.getElementById('reservations-tbody');

            if (reservations.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="10" class="text-center text-muted">
                        Îì±Î°ùÎêú Ìå®ÌÇ§ÏßÄ ÏòàÏïΩÏù¥ ÏóÜÏäµÎãàÎã§.
                    </td></tr>
                `;
                return;
            }

            tbody.innerHTML = reservations.map(r => {
                const departureDate = new Date(r.travel_period.departure_date).toLocaleDateString('ko-KR', {year: 'numeric', month: '2-digit', day: '2-digit'}).replace(/\. /g, '-').replace('.', '');
                const returnDate = new Date(r.travel_period.return_date).toLocaleDateString('ko-KR', {year: 'numeric', month: '2-digit', day: '2-digit'}).replace(/\. /g, '-').replace('.', '');
                const createdDate = new Date(r.createdAt).toLocaleDateString('ko-KR', {year: 'numeric', month: '2-digit', day: '2-digit'}).replace(/\. /g, '-').replace('.', '');
                
                const period = `${r.travel_period.nights}Î∞ï${r.travel_period.days}Ïùº`;
                const people = `ÏÑ±Ïù∏${r.people.adult}${r.people.child > 0 ? `/ÏÜåÏïÑ${r.people.child}` : ''}${r.people.infant > 0 ? `/Ïú†ÏïÑ${r.people.infant}` : ''}`;

                const componentIcons = r.cost_components.map(c => {
                    const icons = {
                        flight: '‚úàÔ∏è',
                        ground: 'üöó',
                        hotel: 'üè®',
                        tour: 'üéØ',
                        other: 'üì¶'
                    };
                    return icons[c.component_type] || 'üì¶';
                }).join(' ');

                const reservationStatus = r.reservation_status || 'pending';
                const statusClass = `status-${reservationStatus}`;
                const statusText = {
                    pending: 'ÎåÄÍ∏∞',
                    confirmed: 'ÌôïÏ†ï',
                    cancelled: 'Ï∑®ÏÜå'
                }[reservationStatus] || reservationStatus;

                const isLastEdited = lastEditedReservationId === r._id;
                const rowClass = isLastEdited ? 'last-edited-row' : '';
                
                return `
                    <tr class="${rowClass}" data-reservation-id="${r._id}">
                        <td><small>${departureDate}</small></td>
                        <td><small>${createdDate}</small></td>
                        <td><small>${r.platform_name}</small></td>
                        <td><code style="font-size: 0.85rem;">${r.reservation_number}</code></td>
                        <td>${r.package_name}</td>
                        <td>${r.customer.korean_name}</td>
                        <td><small>${period}</small></td>
                        <td><small>${people}</small></td>
                        <td class="component-icons">${componentIcons}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td class="action-icons">
                            <button class="btn btn-sm btn-outline-primary" onclick="openEditModal('${r._id}')" title="ÏòàÏïΩÏàòÏ†ï">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="openAssignmentModal('${r._id}')" title="ÏàòÎ∞∞ÏÑú">
                                <i class="fas fa-file-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="openInvoiceModal('${r._id}')" title="ÌôïÏ†ïÏÑú">
                                <i class="fas fa-file-invoice"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="openSettlementModal('${r._id}')" title="Ï†ïÏÇ∞Í¥ÄÎ¶¨">
                                <i class="fas fa-calculator"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateStats(reservations) {
            const total = reservations.length;
            const totalRevenue = reservations.reduce((sum, r) => sum + r.settlement.total_revenue_krw, 0);
            const totalCost = reservations.reduce((sum, r) => sum + r.settlement.total_cost_krw, 0);
            const totalMargin = reservations.reduce((sum, r) => sum + r.settlement.total_margin_krw, 0);

            document.getElementById('stat-total').textContent = `${total}Í±¥`;
            document.getElementById('stat-revenue').textContent = `‚Ç©${totalRevenue.toLocaleString()}`;
            document.getElementById('stat-cost').textContent = `‚Ç©${totalCost.toLocaleString()}`;
            document.getElementById('stat-margin').textContent = `‚Ç©${totalMargin.toLocaleString()}`;
            document.getElementById('stat-margin').className = totalMargin >= 0 ? 'margin-positive' : 'margin-negative';
        }

        // ÏÉÅÏÑ∏ Î≥¥Í∏∞
        async function showDetail(id) {
            try {
                const response = await fetch(`/api/package-reservations/${id}`);
                const result = await response.json();

                if (result.success) {
                    const r = result.data;
                    const departureDate = new Date(r.travel_period.departure_date).toLocaleDateString('ko-KR');
                    const returnDate = new Date(r.travel_period.return_date).toLocaleDateString('ko-KR');

                    const componentsHTML = r.cost_components.map(c => {
                        const typeNames = {
                            flight: '‚úàÔ∏è Ìï≠Í≥µÍ∂å',
                            hotel: 'üè® Ìò∏ÌÖî',
                            tour: 'üéØ Ìà¨Ïñ¥',
                            other: 'üì¶ Í∏∞ÌÉÄ'
                        };
                        return `
                            <tr>
                                <td>${typeNames[c.component_type]}</td>
                                <td>${c.vendor_name}</td>
                                <td>${c.cost_currency === 'KRW' ? '‚Ç©' : '$'}${c.cost_amount.toLocaleString()}</td>
                                <td>‚Ç©${c.cost_krw.toLocaleString()}</td>
                                <td>${c.notes || '-'}</td>
                            </tr>
                        `;
                    }).join('');

                    document.getElementById('modal-body-content').innerHTML = `
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>ÏòàÏïΩÎ≤àÌò∏</h6>
                                <p><strong>${r.reservation_number}</strong></p>
                            </div>
                            <div class="col-md-6">
                                <h6>ÏòàÏïΩ Ï±ÑÎÑê</h6>
                                <p>${r.platform_name}</p>
                            </div>
                        </div>
                        <div class="mb-3">
                            <h6>Ìå®ÌÇ§ÏßÄÎ™Ö</h6>
                            <p>${r.package_name}</p>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>Í≥†Í∞ù Ï†ïÎ≥¥</h6>
                                <p>
                                    ${r.customer.korean_name} (${r.customer.english_name || '-'})<br>
                                    ${r.customer.phone || '-'}<br>
                                    ${r.customer.email || '-'}
                                </p>
                            </div>
                            <div class="col-md-6">
                                <h6>Ïó¨Ìñâ Í∏∞Í∞Ñ</h6>
                                <p>
                                    ${departureDate} ~ ${returnDate}<br>
                                    ${r.travel_period.nights}Î∞ï${r.travel_period.days}Ïùº
                                </p>
                            </div>
                        </div>
                        <div class="mb-3">
                            <h6>Ïù∏Ïõê</h6>
                            <p>ÏÑ±Ïù∏ ${r.people.adult}Î™Ö, ÏÜåÏïÑ ${r.people.child}Î™Ö, Ïú†ÏïÑ ${r.people.infant}Î™Ö</p>
                        </div>
                        <div class="mb-3">
                            <h6>Íµ¨ÏÑ±ÏöîÏÜå</h6>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>ÌÉÄÏûÖ</th>
                                        <th>Í≥µÍ∏âÏóÖÏ≤¥</th>
                                        <th>Îß§ÏûÖÍ∞Ä</th>
                                        <th>ÏõêÌôîÌôòÏÇ∞</th>
                                        <th>ÎπÑÍ≥†</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${componentsHTML}
                                </tbody>
                            </table>
                        </div>
                        <div class="mb-3">
                            <h6>Ï†ïÏÇ∞ Ï†ïÎ≥¥</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td>Ï¥ù Í±∞ÎûòÏï°</td>
                                    <td class="text-end"><strong>‚Ç©${r.settlement.total_revenue_krw.toLocaleString()}</strong></td>
                                </tr>
                                <tr>
                                    <td>Ï¥ù Îß§ÏûÖÏï°</td>
                                    <td class="text-end">‚Ç©${r.settlement.total_cost_krw.toLocaleString()}</td>
                                </tr>
                                <tr class="table-primary">
                                    <td><strong>ÎßàÏßÑ</strong></td>
                                    <td class="text-end ${r.settlement.total_margin_krw >= 0 ? 'margin-positive' : 'margin-negative'}">
                                        <strong>‚Ç©${r.settlement.total_margin_krw.toLocaleString()} (${r.settlement.margin_rate}%)</strong>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Î∂ÄÍ∞ÄÏÑ∏</td>
                                    <td class="text-end">‚Ç©${r.settlement.vat_amount.toLocaleString()}</td>
                                </tr>
                            </table>
                        </div>
                        ${r.special_requests ? `
                            <div class="mb-3">
                                <h6>ÌäπÎ≥Ñ ÏöîÏ≤≠ÏÇ¨Ìï≠</h6>
                                <p>${r.special_requests}</p>
                            </div>
                        ` : ''}
                    `;

                    document.getElementById('edit-link').href = `/admin/package-inbox?id=${id}`;

                    new bootstrap.Modal(document.getElementById('detailModal')).show();
                } else {
                    alert('ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®: ' + result.message);
                }
            } catch (error) {
                console.error('ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î°úÎìú Ïò§Î•ò:', error);
                alert('ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // Í≤ÄÏÉâ
        function handleSearch(event) {
            if (event.key === 'Enter') {
                loadReservations();
            }
        }

        // ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî
        function resetFilters() {
            document.getElementById('dateTypeFilter').value = 'departure';
            document.getElementById('startDateFilter').value = '';
            document.getElementById('endDateFilter').value = '';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('platformFilter').value = '';
            document.getElementById('searchInput').value = '';
            loadReservations();
        }

        // ÏòàÏïΩÏàòÏ†ï Î™®Îã¨ Ïó¥Í∏∞
        let editComponentCount = 0;
        let editBillingCount = 0;
        let editPriceAdjustmentCount = 0;
        
        async function openEditModal(id) {
            // ÎßàÏßÄÎßâ ÏûëÏóÖÌïú ÏòàÏïΩ ID Ï†ÄÏû•
            lastEditedReservationId = id;
            
            try {
                const response = await fetch(`/api/package-reservations/${id}`);
                const result = await response.json();

                if (result.success) {
                    const r = result.data;
                    
                    // Í∏∞Î≥∏ Ï†ïÎ≥¥
                    document.getElementById('edit_reservation_id').value = r._id;
                    document.getElementById('edit_reservation_number_display').textContent = r.reservation_number;
                    document.getElementById('edit_reservation_number_field').value = r.reservation_number;
                    document.getElementById('edit_reservation_status').value = r.reservation_status || 'pending';
                    document.getElementById('edit_platform_name').value = r.platform_name;
                    document.getElementById('edit_package_name').value = r.package_name;
                    
                    // Ïó¨Ìñâ Í∏∞Í∞Ñ
                    document.getElementById('edit_departure_date').value = r.travel_period.departure_date.split('T')[0];
                    document.getElementById('edit_return_date').value = r.travel_period.return_date.split('T')[0];
                    document.getElementById('edit_period_display').value = `${r.travel_period.nights}Î∞ï${r.travel_period.days}Ïùº`;
                    
                    // Ïù∏Ïõê Ï†ïÎ≥¥
                    document.getElementById('edit_people_adult').value = r.people.adult;
                    document.getElementById('edit_people_child').value = r.people.child;
                    document.getElementById('edit_people_infant').value = r.people.infant;
                    
                    // Ìï≠Í≥µÌé∏ Ï†ïÎ≥¥
                    if (r.flight_info) {
                        document.getElementById('edit_outbound_flight').value = r.flight_info.outbound_flight || '';
                        document.getElementById('edit_outbound_departure_time').value = r.flight_info.outbound_departure_time || '';
                        document.getElementById('edit_outbound_arrival_time').value = r.flight_info.outbound_arrival_time || '';
                        document.getElementById('edit_inbound_flight').value = r.flight_info.inbound_flight || '';
                        document.getElementById('edit_inbound_departure_time').value = r.flight_info.inbound_departure_time || '';
                        document.getElementById('edit_inbound_arrival_time').value = r.flight_info.inbound_arrival_time || '';
                    }
                    
                    // Ìò∏ÌÖî Ï†ïÎ≥¥
                    document.getElementById('edit_hotel_name').value = r.hotel_name || '';
                    document.getElementById('edit_room_type').value = r.room_type || '';
                    
                    // ÏùºÏ†ï Î∞è Ìè¨Ìï®/Î∂àÌè¨Ìï®
                    document.getElementById('edit_itinerary').value = r.itinerary || '';
                    document.getElementById('edit_inclusions').value = r.inclusions || '';
                    document.getElementById('edit_exclusions').value = r.exclusions || '';
                    
                    // Ìà¨ÏàôÍ∞ù Ï†ïÎ≥¥
                    renderEditGuests(r.guests || []);
                    
                    // Í∏àÏï° Ï†ïÎ≥¥
                    if (r.pricing) {
                        document.getElementById('edit_currency').value = r.pricing.currency || 'KRW';
                        document.getElementById('edit_exchange_rate').value = (r.pricing.exchange_rate || 1300).toLocaleString();
                        document.getElementById('edit_price_adult').value = (r.pricing.price_adult || 0).toLocaleString();
                        document.getElementById('edit_price_child').value = (r.pricing.price_child || 0).toLocaleString();
                        document.getElementById('edit_price_infant').value = (r.pricing.price_infant || 0).toLocaleString();
                        document.getElementById('edit_total_selling_price').value = (r.pricing.total_selling_price || 0).toLocaleString();
                        
                        // Í∏àÏï° Î≥ÄÎèô ÎÇ¥Ïó≠ Î∂àÎü¨Ïò§Í∏∞
                        renderEditPriceAdjustments(r.pricing.adjustments || []);
                    }
                    
                    // Í≤∞Ï†ú ÎπåÎßÅ
                    renderEditBillings(r.billings || []);
                    
                    // Îß§ÏûÖ Íµ¨ÏÑ±ÏöîÏÜå
                    renderEditComponents(r.cost_components || []);
                    
                    // ÌäπÎ≥Ñ ÏöîÏ≤≠ÏÇ¨Ìï≠
                    document.getElementById('edit_special_requests').value = r.special_requests || '';
                    
                    // ÏàòÏ†ï Ïù¥Î†•
                    renderModificationHistory(r.modification_history || []);
                    
                    // Í∏àÏï° ÏöîÏïΩ Ï¥àÍ∏∞ Í≥ÑÏÇ∞
                    calculateEditSummary();
                    
                    // Î™®Îã¨ Ïó¥Í∏∞
                    new bootstrap.Modal(document.getElementById('editModal')).show();
                } else {
                    alert('ÏòàÏïΩ Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®: ' + result.message);
                }
            } catch (error) {
                console.error('ÏòàÏïΩ Ï†ïÎ≥¥ Î°úÎìú Ïò§Î•ò:', error);
                alert('ÏòàÏïΩ Ï†ïÎ≥¥ Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        // Ìà¨ÏàôÍ∞ù Ï†ïÎ≥¥ Î†åÎçîÎßÅ (Ïã†Í∑ú ÏòàÏïΩ ÌéòÏù¥ÏßÄÏôÄ ÎèôÏùºÌïú Íµ¨Ï°∞)
        function renderEditGuests(guests) {
            const container = document.getElementById('edit_guests_container');
            if (!guests || guests.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<h6 style="font-size: 0.95rem; margin-bottom: 0.5rem;">üë§ Í≥†Í∞ù Ï†ïÎ≥¥</h6>';
            guests.forEach((guest, index) => {
                const guestNum = index + 1;
                html += `
                    <div class="guest-card" style="border: 1px solid #dee2e6; border-radius: 6px; padding: 10px; margin-bottom: 10px; background-color: #f8f9fa;">
                        <div class="guest-header" style="font-weight: 600; color: #495057; margin-bottom: 8px; font-size: 0.9rem;">${guest.type || ''} ${guestNum}</div>
                        <div class="row">
                            <div class="col-md-1">
                                <label class="form-label" style="font-size: 0.875rem; margin-bottom: 0.25rem; font-weight: 500;">ÌïúÍ∏ÄÏù¥Î¶Ñ *</label>
                                <input type="text" class="form-control form-control-sm" value="${guest.korean_name || ''}" 
                                       id="edit_guest_${guestNum}_korean_name"
                                       data-guest-index="${index}"
                                       data-guest-type="${guest.type || ''}"
                                       data-field="korean_name"
                                       placeholder="ÌôçÍ∏∏Îèô" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label" style="font-size: 0.875rem; margin-bottom: 0.25rem; font-weight: 500;">ÏòÅÎ¨∏Ïù¥Î¶Ñ</label>
                                <input type="text" class="form-control form-control-sm" value="${guest.english_name || ''}"
                                       id="edit_guest_${guestNum}_english_name"
                                       data-guest-index="${index}"
                                       data-field="english_name"
                                       placeholder="HONG GILDONG">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label" style="font-size: 0.875rem; margin-bottom: 0.25rem; font-weight: 500;">ÏÉùÎÖÑÏõîÏùº</label>
                                <input type="date" class="form-control form-control-sm" value="${guest.birth_date ? new Date(guest.birth_date).toISOString().split('T')[0] : ''}"
                                       id="edit_guest_${guestNum}_birth_date"
                                       data-guest-index="${index}"
                                       data-field="birth_date">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label" style="font-size: 0.875rem; margin-bottom: 0.25rem; font-weight: 500;">Ïó∞ÎùΩÏ≤ò</label>
                                <input type="text" class="form-control form-control-sm" value="${guest.phone || ''}"
                                       id="edit_guest_${guestNum}_phone"
                                       data-guest-index="${index}"
                                       data-field="phone"
                                       placeholder="010-1234-5678">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label" style="font-size: 0.875rem; margin-bottom: 0.25rem; font-weight: 500;">Ïù¥Î©îÏùº</label>
                                <input type="email" class="form-control form-control-sm" value="${guest.email || ''}"
                                       id="edit_guest_${guestNum}_email"
                                       data-guest-index="${index}"
                                       data-field="email"
                                       placeholder="hong@email.com">
                            </div>
                            <div class="col-md-1">
                                <label class="form-label" style="font-size: 0.875rem; margin-bottom: 0.25rem; font-weight: 500;">Íµ¨Î∂Ñ</label>
                                <input type="text" class="form-control form-control-sm" value="${guest.type || ''}" readonly>
                            </div>
                            <div class="col-md-1">
                                <label class="form-label" style="font-size: 0.875rem; margin-bottom: 0.25rem; font-weight: 500;">ÏÑ±Î≥Ñ</label>
                                <select class="form-select form-select-sm" id="edit_guest_${guestNum}_gender"
                                        data-guest-index="${index}"
                                        data-field="gender">
                                    <option value="">ÏÑ†ÌÉù</option>
                                    <option value="ÎÇ®Ïûê" ${guest.gender === 'ÎÇ®Ïûê' ? 'selected' : ''}>ÎÇ®Ïûê</option>
                                    <option value="Ïó¨Ïûê" ${guest.gender === 'Ïó¨Ïûê' ? 'selected' : ''}>Ïó¨Ïûê</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        // Ïù∏Ïõê Î≥ÄÍ≤Ω Ïãú Ìà¨ÏàôÍ∞ù ÌïÑÎìú ÎèôÏ†Å ÏÉùÏÑ± (Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Ïú†ÏßÄ)
        function generateEditGuestFields() {
            const adultCount = parseInt(document.getElementById('edit_people_adult').value) || 0;
            const childCount = parseInt(document.getElementById('edit_people_child').value) || 0;
            const infantCount = parseInt(document.getElementById('edit_people_infant').value) || 0;
            const totalCount = adultCount + childCount + infantCount;
            
            const container = document.getElementById('edit_guests_container');
            
            if (totalCount === 0) {
                container.innerHTML = '';
                return;
            }
            
            // Í∏∞Ï°¥ ÏûÖÎ†•Îêú Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
            const existingData = [];
            const existingInputs = container.querySelectorAll('input[data-guest-index], select[data-guest-index]');
            existingInputs.forEach(input => {
                const guestIndex = parseInt(input.getAttribute('data-guest-index'));
                const field = input.getAttribute('data-field');
                if (!existingData[guestIndex]) {
                    existingData[guestIndex] = {};
                }
                if (input.tagName === 'SELECT') {
                    existingData[guestIndex][field] = input.value;
                } else if (input.type === 'date') {
                    existingData[guestIndex][field] = input.value;
                } else {
                    existingData[guestIndex][field] = input.value;
                }
            });
            
            // Í∏∞Ï°¥ type Ï†ïÎ≥¥ÎèÑ ÏàòÏßë
            const existingTypes = container.querySelectorAll('input[data-guest-type]');
            existingTypes.forEach(input => {
                const guestIndex = parseInt(input.getAttribute('data-guest-index'));
                const guestType = input.getAttribute('data-guest-type');
                if (!existingData[guestIndex]) {
                    existingData[guestIndex] = {};
                }
                existingData[guestIndex].type = guestType;
            });
            
            let html = '<h6 style="font-size: 0.95rem; margin-bottom: 0.5rem;">üë§ Í≥†Í∞ù Ï†ïÎ≥¥</h6>';
            let guestIndex = 0;
            
            // ÏÑ±Ïù∏
            for (let i = 0; i < adultCount; i++) {
                const existingGuest = existingData[guestIndex] || {};
                html += createEditGuestCard(guestIndex + 1, 'ÏÑ±Ïù∏', i + 1, existingGuest);
                guestIndex++;
            }
            
            // ÏÜåÏïÑ
            for (let i = 0; i < childCount; i++) {
                const existingGuest = existingData[guestIndex] || {};
                html += createEditGuestCard(guestIndex + 1, 'ÏÜåÏïÑ', i + 1, existingGuest);
                guestIndex++;
            }
            
            // Ïú†ÏïÑ
            for (let i = 0; i < infantCount; i++) {
                const existingGuest = existingData[guestIndex] || {};
                html += createEditGuestCard(guestIndex + 1, 'Ïú†ÏïÑ', i + 1, existingGuest);
                guestIndex++;
            }
            
            container.innerHTML = html;
        }
        
        function createEditGuestCard(index, type, typeIndex, existingGuest = {}) {
            return `
                <div class="guest-card" style="border: 1px solid #dee2e6; border-radius: 6px; padding: 10px; margin-bottom: 10px; background-color: #f8f9fa;">
                    <div class="guest-header" style="font-weight: 600; color: #495057; margin-bottom: 8px; font-size: 0.9rem;">${type} ${typeIndex}</div>
                    <div class="row">
                        <div class="col-md-1">
                            <label class="form-label" style="font-size: 0.875rem; margin-bottom: 0.25rem; font-weight: 500;">ÌïúÍ∏ÄÏù¥Î¶Ñ *</label>
                            <input type="text" class="form-control form-control-sm" 
                                   id="edit_guest_${index}_korean_name" 
                                   data-guest-index="${index - 1}"
                                   data-guest-type="${type}"
                                   data-field="korean_name"
                                   value="${existingGuest.korean_name || ''}"
                                   placeholder="ÌôçÍ∏∏Îèô" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label" style="font-size: 0.875rem; margin-bottom: 0.25rem; font-weight: 500;">ÏòÅÎ¨∏Ïù¥Î¶Ñ</label>
                            <input type="text" class="form-control form-control-sm" 
                                   id="edit_guest_${index}_english_name"
                                   data-guest-index="${index - 1}"
                                   data-field="english_name"
                                   value="${existingGuest.english_name || ''}"
                                   placeholder="HONG GILDONG">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label" style="font-size: 0.875rem; margin-bottom: 0.25rem; font-weight: 500;">ÏÉùÎÖÑÏõîÏùº</label>
                            <input type="date" class="form-control form-control-sm" 
                                   id="edit_guest_${index}_birth_date"
                                   data-guest-index="${index - 1}"
                                   data-field="birth_date"
                                   value="${existingGuest.birth_date || ''}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label" style="font-size: 0.875rem; margin-bottom: 0.25rem; font-weight: 500;">Ïó∞ÎùΩÏ≤ò</label>
                            <input type="text" class="form-control form-control-sm" 
                                   id="edit_guest_${index}_phone"
                                   data-guest-index="${index - 1}"
                                   data-field="phone"
                                   value="${existingGuest.phone || ''}"
                                   placeholder="010-1234-5678">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-size: 0.875rem; margin-bottom: 0.25rem; font-weight: 500;">Ïù¥Î©îÏùº</label>
                            <input type="email" class="form-control form-control-sm" 
                                   id="edit_guest_${index}_email"
                                   data-guest-index="${index - 1}"
                                   data-field="email"
                                   value="${existingGuest.email || ''}"
                                   placeholder="hong@email.com">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label" style="font-size: 0.875rem; margin-bottom: 0.25rem; font-weight: 500;">Íµ¨Î∂Ñ</label>
                            <input type="text" class="form-control form-control-sm" 
                                   value="${type}" readonly>
                        </div>
                        <div class="col-md-1">
                            <label class="form-label" style="font-size: 0.875rem; margin-bottom: 0.25rem; font-weight: 500;">ÏÑ±Î≥Ñ</label>
                            <select class="form-select form-select-sm" 
                                    id="edit_guest_${index}_gender"
                                    data-guest-index="${index - 1}"
                                    data-field="gender">
                                <option value="">ÏÑ†ÌÉù</option>
                                <option value="ÎÇ®Ïûê" ${existingGuest.gender === 'ÎÇ®Ïûê' ? 'selected' : ''}>ÎÇ®Ïûê</option>
                                <option value="Ïó¨Ïûê" ${existingGuest.gender === 'Ïó¨Ïûê' ? 'selected' : ''}>Ïó¨Ïûê</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Í≤∞Ï†ú ÎπåÎßÅ Î†åÎçîÎßÅ
        function renderEditBillings(billings) {
            const container = document.getElementById('edit_billings_container');
            container.innerHTML = '';
            editBillingCount = 0;
            
            if (billings && billings.length > 0) {
                billings.forEach(billing => {
                    editBillingCount++;
                    const billingHTML = `
                        <div class="card mb-2" id="edit_billing_${editBillingCount}" style="background-color: #f8f9fa;">
                            <div class="card-body p-2">
                                <div class="row g-2">
                                    <div class="col-md-2">
                                        <select class="form-select form-select-sm">
                                            <option value="cash" ${billing.type === 'cash' ? 'selected' : ''}>üíµ ÌòÑÍ∏à</option>
                                            <option value="card" ${billing.type === 'card' ? 'selected' : ''}>üí≥ Ïπ¥Îìú</option>
                                            <option value="discount" ${billing.type === 'discount' ? 'selected' : ''}>üéÅ Ìï†Ïù∏</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control form-control-sm" value="${(billing.amount || 0).toLocaleString()}" placeholder="Í∏àÏï°">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="date" class="form-control form-control-sm" value="${billing.date ? new Date(billing.date).toISOString().split('T')[0] : ''}">
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select form-select-sm">
                                            <option value="pending" ${billing.status === 'pending' ? 'selected' : ''}>Í≤∞Ï†úÏ†Ñ</option>
                                            <option value="completed" ${billing.status === 'completed' ? 'selected' : ''}>Í≤∞Ï†úÏôÑÎ£å</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <input type="text" class="form-control form-control-sm" value="${billing.notes || ''}" placeholder="ÎπÑÍ≥†">
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" class="btn btn-sm btn-danger" onclick="document.getElementById('edit_billing_${editBillingCount}').remove()">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', billingHTML);
                });
            }
        }
        
        // Îß§ÏûÖ Íµ¨ÏÑ±ÏöîÏÜå Î†åÎçîÎßÅ
        function renderEditComponents(components) {
            const container = document.getElementById('edit_components_container');
            container.innerHTML = '';
            editComponentCount = 0;
            
            if (components && components.length > 0) {
                components.forEach(comp => {
                    editComponentCount++;
                    const currentCount = editComponentCount;
                    const componentHTML = `
                        <div class="card mb-2 component-item" id="edit-component-${currentCount}" style="background-color: #fff;">
                            <div class="card-body p-2">
                                <div class="row g-2">
                                    <div class="col-md-2">
                                        <select class="form-select form-select-sm" id="edit-type-${currentCount}" onchange="updateEditComponentVendor(${currentCount}); calculateEditSummary()">
                                            <option value="flight" ${comp.component_type === 'flight' ? 'selected' : ''}>‚úàÔ∏è Ìï≠Í≥µÍ∂å</option>
                                            <option value="hotel" ${comp.component_type === 'hotel' ? 'selected' : ''}>üè® Ìò∏ÌÖî</option>
                                            <option value="tour" ${comp.component_type === 'tour' ? 'selected' : ''}>üéØ Ìà¨Ïñ¥</option>
                                            <option value="ground" ${comp.component_type === 'ground' ? 'selected' : ''}>üöó ÏßÄÏÉÅ</option>
                                            <option value="other" ${comp.component_type === 'other' ? 'selected' : ''}>üì¶ Í∏∞ÌÉÄ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select form-select-sm" id="edit-vendor-${currentCount}" onchange="calculateEditSummary()">
                                            <option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control form-control-sm" id="edit-cost-${currentCount}" value="${(comp.cost_amount || 0).toLocaleString()}" placeholder="Îß§ÏûÖÍ∞Ä" oninput="formatCurrency(this); calculateEditSummary();">
                                    </div>
                                    <div class="col-md-1">
                                        <select class="form-select form-select-sm" id="edit-cost-currency-${editComponentCount}" onchange="calculateEditSummary()">
                                            <option value="KRW" ${comp.cost_currency === 'KRW' ? 'selected' : ''}>KRW</option>
                                            <option value="USD" ${comp.cost_currency === 'USD' ? 'selected' : ''}>USD</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control form-control-sm" id="edit-cost-krw-${editComponentCount}" value="‚Ç©${(comp.cost_krw || 0).toLocaleString()}" placeholder="ÏõêÌôîÌôòÏÇ∞" readonly style="background-color: #e9ecef;">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control form-control-sm" id="edit-notes-${editComponentCount}" value="${comp.notes || ''}" placeholder="ÎπÑÍ≥†">
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" class="btn btn-sm btn-danger" onclick="removeEditComponent(${editComponentCount})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', componentHTML);
                    
                    // ÎìúÎ°≠Îã§Ïö¥ Ï¥àÍ∏∞Ìôî Î∞è Í∏∞Ï°¥ Í∞í ÏÑ§Ï†ï
                    const vendorSelect = document.getElementById(`edit-vendor-${currentCount}`);
                    updateSupplierDropdown(vendorSelect, comp.component_type);
                    
                    // Í∏∞Ï°¥ Í±∞ÎûòÏ≤ò Í∞í ÏÑ§Ï†ï
                    if (comp.vendor_name) {
                        setTimeout(() => {
                            vendorSelect.value = comp.vendor_name;
                        }, 0);
                    }
                });
            }
        }
        
        // ÏàòÏ†ï Ïù¥Î†• Î†åÎçîÎßÅ
        function renderModificationHistory(history) {
            const container = document.getElementById('modification_history_container');
            
            if (!history || history.length === 0) {
                container.innerHTML = '<p class="text-muted mb-0">ÏàòÏ†ï Ïù¥Î†•Ïù¥ ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            let html = '';
            history.reverse().forEach((entry, index) => {
                const date = new Date(entry.modified_at).toLocaleString('ko-KR');
                html += `
                    <div class="card mb-2 ${index === 0 ? 'border-primary' : ''}">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong style="font-size: 0.9rem;">
                                    <i class="fas fa-user-edit me-1"></i>${entry.modified_by}
                                </strong>
                                <small class="text-muted">${date}</small>
                            </div>
                            <div style="font-size: 0.85rem;">
                                <span class="badge bg-info">${entry.summary}</span>
                            </div>
                            <div class="mt-2" style="font-size: 0.8rem;">
                `;
                
                entry.changes.forEach(change => {
                    html += `
                        <div class="mb-1">
                            <span class="badge bg-secondary">${change.field_label}</span>
                            <span class="text-danger" style="text-decoration: line-through;">${change.old_value}</span>
                            <i class="fas fa-arrow-right mx-1"></i>
                            <span class="text-success"><strong>${change.new_value}</strong></span>
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Í≤∞Ï†ú ÎπåÎßÅ Ï∂îÍ∞Ä
        function addEditBilling() {
            editBillingCount++;
            const container = document.getElementById('edit_billings_container');
            const billingHTML = `
                <div class="card mb-2" id="edit_billing_${editBillingCount}" style="background-color: #f8f9fa;">
                    <div class="card-body p-2">
                        <div class="row g-2">
                            <div class="col-md-2">
                                <select class="form-select form-select-sm">
                                    <option value="cash">üíµ ÌòÑÍ∏à</option>
                                    <option value="card">üí≥ Ïπ¥Îìú</option>
                                    <option value="discount">üéÅ Ìï†Ïù∏</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control form-control-sm" placeholder="Í∏àÏï°">
                            </div>
                            <div class="col-md-2">
                                <input type="date" class="form-control form-control-sm">
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm">
                                    <option value="pending">Í≤∞Ï†úÏ†Ñ</option>
                                    <option value="completed">Í≤∞Ï†úÏôÑÎ£å</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control form-control-sm" placeholder="ÎπÑÍ≥†">
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-sm btn-danger" onclick="document.getElementById('edit_billing_${editBillingCount}').remove()">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', billingHTML);
        }
        
        // Îß§ÏûÖ Íµ¨ÏÑ±ÏöîÏÜå Ï∂îÍ∞Ä
        function addEditComponent() {
            editComponentCount++;
            const container = document.getElementById('edit_components_container');
            const componentHTML = `
                <div class="card mb-2 component-item" id="edit-component-${editComponentCount}" style="background-color: #fff;">
                    <div class="card-body p-2">
                        <div class="row g-2">
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="edit-type-${editComponentCount}" onchange="updateEditComponentVendor(${editComponentCount}); calculateEditSummary()">
                                    <option value="flight">‚úàÔ∏è Ìï≠Í≥µÍ∂å</option>
                                    <option value="hotel">üè® Ìò∏ÌÖî</option>
                                    <option value="tour">üéØ Ìà¨Ïñ¥</option>
                                    <option value="ground">üöó ÏßÄÏÉÅ</option>
                                    <option value="other">üì¶ Í∏∞ÌÉÄ</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="edit-vendor-${editComponentCount}" onchange="calculateEditSummary()">
                                    <option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control form-control-sm" id="edit-cost-${editComponentCount}" placeholder="Îß§ÏûÖÍ∞Ä" oninput="formatCurrency(this); calculateEditSummary();">
                            </div>
                            <div class="col-md-1">
                                <select class="form-select form-select-sm" id="edit-cost-currency-${editComponentCount}" onchange="calculateEditSummary()">
                                    <option value="KRW">KRW</option>
                                    <option value="USD">USD</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control form-control-sm" id="edit-cost-krw-${editComponentCount}" placeholder="ÏõêÌôîÌôòÏÇ∞" readonly style="background-color: #e9ecef;">
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control form-control-sm" id="edit-notes-${editComponentCount}" placeholder="ÎπÑÍ≥†">
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeEditComponent(${editComponentCount})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', componentHTML);
            
            // Í≥µÍ∏âÏóÖÏ≤¥ ÎìúÎ°≠Îã§Ïö¥ Ï¥àÍ∏∞Ìôî (Í∏∞Î≥∏Í∞í: flight)
            const vendorSelect = document.getElementById(`edit-vendor-${editComponentCount}`);
            updateSupplierDropdown(vendorSelect, 'flight');
        }
        
        // Íµ¨ÏÑ±ÏöîÏÜå ÌÉÄÏûÖ Î≥ÄÍ≤Ω Ïãú Í≥µÍ∏âÏóÖÏ≤¥ ÎìúÎ°≠Îã§Ïö¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateEditComponentVendor(id) {
            const typeSelect = document.getElementById(`edit-type-${id}`);
            const vendorSelect = document.getElementById(`edit-vendor-${id}`);
            const selectedType = typeSelect.value;
            
            // Ïú†ÌòïÏóê ÎßûÎäî Í≥µÍ∏âÏóÖÏ≤¥ Î™©Î°ùÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
            updateSupplierDropdown(vendorSelect, selectedType);
        }
        
        // Îß§ÏûÖ Íµ¨ÏÑ±ÏöîÏÜå ÏÇ≠Ï†ú
        function removeEditComponent(id) {
            const element = document.getElementById(`edit-component-${id}`);
            if (element) {
                element.remove();
                calculateEditSummary();
            }
        }

        // Î∞ïÏàò/ÏùºÏàò Í≥ÑÏÇ∞ (ÏàòÏ†ï Î™®Îã¨)
        function calculateEditNights() {
            const departureDate = document.getElementById('edit_departure_date').value;
            const returnDate = document.getElementById('edit_return_date').value;
            
            if (departureDate && returnDate) {
                const departure = new Date(departureDate);
                const returnD = new Date(returnDate);
                const nights = Math.floor((returnD - departure) / (1000 * 60 * 60 * 24));
                const days = nights + 1;
                
                document.getElementById('edit_period_display').value = `${nights}Î∞ï${days}Ïùº`;
            }
        }
        
        // Í∏àÏï° Î≥ÄÎèô ÎÇ¥Ïó≠ Î†åÎçîÎßÅ (ÏàòÏ†ï Î™®Îã¨)
        function renderEditPriceAdjustments(adjustments) {
            const container = document.getElementById('edit_price_adjustments_container');
            container.innerHTML = '';
            editPriceAdjustmentCount = 0;
            
            if (adjustments && adjustments.length > 0) {
                adjustments.forEach(adj => {
                    editPriceAdjustmentCount++;
                    const type = (adj.amount || 0) < 0 ? 'subtract' : 'add';
                    const amount = Math.abs(adj.amount || 0);
                    
                    const adjustmentHTML = `
                        <div class="card mb-2" id="edit_adjustment_${editPriceAdjustmentCount}" style="background-color: #fff3cd;">
                            <div class="card-body p-2">
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <input type="text" class="form-control form-control-sm" 
                                               id="edit_adjustment_name_${editPriceAdjustmentCount}" 
                                               placeholder="Ìï≠Î™©Î™Ö (Ïòà: Ï°∞Ïãù Ï∂îÍ∞Ä)"
                                               value="${adj.description || ''}">
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select form-select-sm" 
                                                id="edit_adjustment_type_${editPriceAdjustmentCount}" 
                                                onchange="calculateEditTotalPrice()">
                                            <option value="add" ${type === 'add' ? 'selected' : ''}>‚ûï Ï∂îÍ∞Ä</option>
                                            <option value="subtract" ${type === 'subtract' ? 'selected' : ''}>‚ûñ Ï∞®Í∞ê</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <input type="text" class="form-control form-control-sm" 
                                               id="edit_adjustment_amount_${editPriceAdjustmentCount}" 
                                               placeholder="Í∏àÏï°"
                                               value="${amount.toLocaleString()}"
                                               oninput="formatEditNumber(this); calculateEditTotalPrice();">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-sm btn-danger w-100" 
                                                onclick="document.getElementById('edit_adjustment_${editPriceAdjustmentCount}').remove(); calculateEditTotalPrice();">
                                            <i class="fas fa-trash"></i> ÏÇ≠Ï†ú
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', adjustmentHTML);
                });
            }
        }
        
        // Í∏àÏï° Î≥ÄÎèô Ï∂îÍ∞Ä (ÏàòÏ†ï Î™®Îã¨)
        function addEditPriceAdjustment() {
            editPriceAdjustmentCount++;
            const container = document.getElementById('edit_price_adjustments_container');
            
            const adjustmentHTML = `
                <div class="card mb-2" id="edit_adjustment_${editPriceAdjustmentCount}" style="background-color: #fff3cd;">
                    <div class="card-body p-2">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <input type="text" class="form-control form-control-sm" 
                                       id="edit_adjustment_name_${editPriceAdjustmentCount}" 
                                       placeholder="Ìï≠Î™©Î™Ö (Ïòà: Ï°∞Ïãù Ï∂îÍ∞Ä)">
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" 
                                        id="edit_adjustment_type_${editPriceAdjustmentCount}" 
                                        onchange="calculateEditTotalPrice()">
                                    <option value="add">‚ûï Ï∂îÍ∞Ä</option>
                                    <option value="subtract">‚ûñ Ï∞®Í∞ê</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control form-control-sm" 
                                       id="edit_adjustment_amount_${editPriceAdjustmentCount}" 
                                       placeholder="Í∏àÏï°" 
                                       oninput="formatCurrency(this); calculateEditTotalPrice();">
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control form-control-sm" 
                                       id="edit_adjustment_notes_${editPriceAdjustmentCount}" 
                                       placeholder="ÎπÑÍ≥†">
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeEditPriceAdjustment(${editPriceAdjustmentCount})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', adjustmentHTML);
        }
        
        // Í∏àÏï° Î≥ÄÎèô ÏÇ≠Ï†ú (ÏàòÏ†ï Î™®Îã¨)
        function removeEditPriceAdjustment(id) {
            const element = document.getElementById(`edit_adjustment_${id}`);
            if (element) {
                element.remove();
                calculateEditTotalPrice();
            }
        }
        
        // Ï¥ù ÌåêÎß§Í∞Ä Í≥ÑÏÇ∞ (ÏàòÏ†ï Î™®Îã¨)
        function calculateEditTotalPrice() {
            const adultCount = parseInt(document.getElementById('edit_people_adult').value) || 0;
            const childCount = parseInt(document.getElementById('edit_people_child').value) || 0;
            const infantCount = parseInt(document.getElementById('edit_people_infant').value) || 0;
            
            const parseNumber = (id) => {
                const value = document.getElementById(id)?.value || '0';
                return parseFloat(value.replace(/,/g, '')) || 0;
            };
            
            const adultPrice = parseNumber('edit_price_adult');
            const childPrice = parseNumber('edit_price_child');
            const infantPrice = parseNumber('edit_price_infant');
            
            let totalPrice = (adultCount * adultPrice) + (childCount * childPrice) + (infantCount * infantPrice);
            
            // Í∏àÏï° Î≥ÄÎèô Ìï≠Î™© Ìï©ÏÇ∞
            const adjustmentCards = document.querySelectorAll('#edit_price_adjustments_container .card');
            adjustmentCards.forEach(card => {
                const typeSelect = card.querySelector('select[id^="edit_adjustment_type_"]');
                const amountInput = card.querySelector('input[id^="edit_adjustment_amount_"]');
                
                if (typeSelect && amountInput) {
                    const type = typeSelect.value;
                    const amount = parseFloat(amountInput.value.replace(/,/g, '')) || 0;
                    
                    if (type === 'add') {
                        totalPrice += amount;
                    } else if (type === 'subtract') {
                        totalPrice -= amount;
                    }
                }
            });
            
            document.getElementById('edit_total_selling_price').value = totalPrice.toLocaleString();
            
            // Í∏àÏï° ÏöîÏïΩ ÏóÖÎç∞Ïù¥Ìä∏
            calculateEditSummary();
        }
        
        // Í∏àÏï° ÏöîÏïΩ Í≥ÑÏÇ∞ (ÏàòÏ†ï Î™®Îã¨)
        function calculateEditSummary() {
            const parseNumber = (id) => {
                const value = document.getElementById(id)?.value || '0';
                return parseFloat(value.replace(/,/g, '')) || 0;
            };
            
            const sellingPrice = parseNumber('edit_total_selling_price');
            const currency = document.getElementById('edit_currency').value;
            const exchangeRate = parseNumber('edit_exchange_rate') || 1;
            
            // Ï¥ù ÌåêÎß§Í∞Ä (ÏõêÌôî ÌôòÏÇ∞)
            const revenueKRW = currency === 'KRW' ? sellingPrice : sellingPrice * exchangeRate;
            
            // ÌåêÎß§Í∞Ä ÏÉÅÏÑ∏ Ìï≠Î™© ÏÉùÏÑ±
            const adultCount = parseInt(document.getElementById('edit_people_adult').value) || 0;
            const childCount = parseInt(document.getElementById('edit_people_child').value) || 0;
            const infantCount = parseInt(document.getElementById('edit_people_infant').value) || 0;
            
            const adultPrice = parseNumber('edit_price_adult');
            const childPrice = parseNumber('edit_price_child');
            const infantPrice = parseNumber('edit_price_infant');
            
            let revenueDetails = [];
            if (adultCount > 0 && adultPrice > 0) {
                const adultTotal = adultCount * adultPrice;
                const adultKRW = currency === 'KRW' ? adultTotal : adultTotal * exchangeRate;
                revenueDetails.push(`ÏÑ±Ïù∏ ${adultCount}Î™Ö √ó ${currency === 'KRW' ? '‚Ç©' : '$'}${adultPrice.toLocaleString()} = ‚Ç©${Math.round(adultKRW).toLocaleString()}`);
            }
            if (childCount > 0 && childPrice > 0) {
                const childTotal = childCount * childPrice;
                const childKRW = currency === 'KRW' ? childTotal : childTotal * exchangeRate;
                revenueDetails.push(`ÏÜåÏïÑ ${childCount}Î™Ö √ó ${currency === 'KRW' ? '‚Ç©' : '$'}${childPrice.toLocaleString()} = ‚Ç©${Math.round(childKRW).toLocaleString()}`);
            }
            if (infantCount > 0 && infantPrice > 0) {
                const infantTotal = infantCount * infantPrice;
                const infantKRW = currency === 'KRW' ? infantTotal : infantTotal * exchangeRate;
                revenueDetails.push(`Ïú†ÏïÑ ${infantCount}Î™Ö √ó ${currency === 'KRW' ? '‚Ç©' : '$'}${infantPrice.toLocaleString()} = ‚Ç©${Math.round(infantKRW).toLocaleString()}`);
            }
            
            // Í∏àÏï° Î≥ÄÎèô Ìï≠Î™© Ï∂îÍ∞Ä
            const adjustmentCards = document.querySelectorAll('#edit_price_adjustments_container .card');
            adjustmentCards.forEach(card => {
                const nameInput = card.querySelector('input[id^="edit_adjustment_name_"]');
                const typeSelect = card.querySelector('select[id^="edit_adjustment_type_"]');
                const amountInput = card.querySelector('input[id^="edit_adjustment_amount_"]');
                
                if (nameInput && typeSelect && amountInput) {
                    const name = nameInput.value || 'Ìï≠Î™©';
                    const type = typeSelect.value;
                    const amount = parseFloat(amountInput.value.replace(/,/g, '')) || 0;
                    
                    if (amount > 0) {
                        const amountKRW = currency === 'KRW' ? amount : amount * exchangeRate;
                        const sign = type === 'add' ? '‚ûï' : '‚ûñ';
                        revenueDetails.push(`${sign} ${name} ${currency === 'KRW' ? '‚Ç©' : '$'}${amount.toLocaleString()} = ${type === 'add' ? '+' : '-'}‚Ç©${Math.round(amountKRW).toLocaleString()}`);
                    }
                }
            });
            
            // Ï¥ù Îß§ÏûÖÍ∞Ä Í≥ÑÏÇ∞ Î∞è ÏÉÅÏÑ∏ Ìï≠Î™© ÏÉùÏÑ±
            let totalCostKRW = 0;
            let costDetails = [];
            const components = document.querySelectorAll('#edit_components_container .component-item');
            
            components.forEach(component => {
                const id = component.id.replace('edit-component-', '');
                const costInput = document.getElementById(`edit-cost-${id}`);
                const costCurrencySelect = document.getElementById(`edit-cost-currency-${id}`);
                const vendorInput = document.getElementById(`edit-vendor-${id}`);
                const typeSelect = document.getElementById(`edit-type-${id}`);
                
                if (costInput && costCurrencySelect) {
                    const cost = parseFloat(costInput.value.replace(/,/g, '')) || 0;
                    const costCurrency = costCurrencySelect.value;
                    const vendorName = vendorInput?.value || 'ÏóÖÏ≤¥Î™Ö';
                    const typeText = typeSelect ? typeSelect.options[typeSelect.selectedIndex].text : '';
                    
                    const costKRW = costCurrency === 'KRW' ? cost : cost * exchangeRate;
                    totalCostKRW += costKRW;
                    
                    // Í∞úÎ≥Ñ Íµ¨ÏÑ±ÏöîÏÜå ÏõêÌôî ÌôòÏÇ∞ ÌëúÏãú
                    const costKrwEl = document.getElementById(`edit-cost-krw-${id}`);
                    if (costKrwEl) {
                        costKrwEl.value = `‚Ç©${Math.round(costKRW).toLocaleString()}`;
                    }
                    
                    // ÏÉÅÏÑ∏ Ìï≠Î™© Ï∂îÍ∞Ä
                    if (cost > 0) {
                        costDetails.push(`${typeText} (${vendorName}) ${costCurrency === 'KRW' ? '‚Ç©' : '$'}${cost.toLocaleString()} = ‚Ç©${Math.round(costKRW).toLocaleString()}`);
                    }
                }
            });
            
            // ÎßàÏßÑ Í≥ÑÏÇ∞
            const marginKRW = revenueKRW - totalCostKRW;
            const marginRate = revenueKRW > 0 ? (marginKRW / revenueKRW * 100).toFixed(1) : 0;
            
            // Î∂ÄÍ∞ÄÏÑ∏ (ÎßàÏßÑÏùò 10%)
            const vatAmount = Math.round(marginKRW * 0.1);
            
            // ÏöîÏïΩ ÌëúÏãú
            document.getElementById('edit_summary_revenue').textContent = 
                `‚Ç©${Math.round(revenueKRW).toLocaleString()}`;
            document.getElementById('edit_summary_revenue_detail').innerHTML = 
                revenueDetails.length > 0 ? revenueDetails.join('<br>') : '';
                
            document.getElementById('edit_summary_cost').textContent = 
                `‚Ç©${Math.round(totalCostKRW).toLocaleString()}`;
            document.getElementById('edit_summary_cost_detail').innerHTML = 
                costDetails.length > 0 ? costDetails.join('<br>') : '';
                
            document.getElementById('edit_summary_margin').textContent = 
                `‚Ç©${Math.round(marginKRW).toLocaleString()} (${marginRate}%)`;
            document.getElementById('edit_summary_margin').style.color = marginKRW >= 0 ? '#198754' : '#dc3545';
            document.getElementById('edit_summary_vat').textContent = 
                `‚Ç©${vatAmount.toLocaleString()}`;
        }

        // ÏòàÏïΩÏàòÏ†ï Ï†ÄÏû•
        async function saveReservationEdit() {
            const id = document.getElementById('edit_reservation_id').value;
            
            // Ïà´Ïûê ÌååÏã± Ìó¨Ìçº
            const parseNumber = (value) => {
                if (!value) return 0;
                return parseFloat(value.toString().replace(/,/g, '')) || 0;
            };
            
            // Ìà¨ÏàôÍ∞ù Ï†ïÎ≥¥ ÏàòÏßë (Ïã†Í∑ú ÏòàÏïΩ ÌéòÏù¥ÏßÄÏôÄ ÎèôÏùºÌïú Î∞©Ïãù)
            const adultCount = parseInt(document.getElementById('edit_people_adult').value) || 0;
            const childCount = parseInt(document.getElementById('edit_people_child').value) || 0;
            const infantCount = parseInt(document.getElementById('edit_people_infant').value) || 0;
            const totalCount = adultCount + childCount + infantCount;
            
            const guests = [];
            for (let i = 1; i <= totalCount; i++) {
                const koreanNameEl = document.getElementById(`edit_guest_${i}_korean_name`);
                if (koreanNameEl) {
                    const guest = {
                        korean_name: koreanNameEl.value || '',
                        english_name: document.getElementById(`edit_guest_${i}_english_name`)?.value || '',
                        birth_date: document.getElementById(`edit_guest_${i}_birth_date`)?.value || '',
                        phone: document.getElementById(`edit_guest_${i}_phone`)?.value || '',
                        email: document.getElementById(`edit_guest_${i}_email`)?.value || '',
                        type: koreanNameEl.dataset.guestType || '',
                        gender: document.getElementById(`edit_guest_${i}_gender`)?.value || ''
                    };
                    guests.push(guest);
                }
            }
            
            // Ï≤´ Î≤àÏß∏ Ìà¨ÏàôÍ∞ùÏùÑ Í≥†Í∞ù Ï†ïÎ≥¥Î°ú ÏÇ¨Ïö© (Ïã†Í∑ú ÏòàÏïΩ ÌéòÏù¥ÏßÄÏôÄ ÎèôÏùº)
            const customer = guests.length > 0 ? {
                korean_name: guests[0].korean_name,
                english_name: guests[0].english_name,
                phone: guests[0].phone,
                email: guests[0].email
            } : {
                korean_name: '',
                english_name: '',
                phone: '',
                email: ''
            };
            
            // Í≤∞Ï†ú ÎπåÎßÅ ÏàòÏßë
            const billings = [];
            document.querySelectorAll('#edit_billings_container .card').forEach(card => {
                const inputs = card.querySelectorAll('input, select');
                const billing = {
                    type: inputs[0].value,
                    amount: parseNumber(inputs[1].value),
                    date: inputs[2].value || null,
                    status: inputs[3].value,
                    notes: inputs[4].value
                };
                billings.push(billing);
            });
            
            // Îß§ÏûÖ Íµ¨ÏÑ±ÏöîÏÜå ÏàòÏßë
            const cost_components = [];
            document.querySelectorAll('#edit_components_container .card').forEach(card => {
                const inputs = card.querySelectorAll('input, select');
                const component = {
                    component_type: inputs[0].value,
                    vendor_name: inputs[1].value,
                    cost_amount: parseNumber(inputs[2].value),
                    cost_currency: inputs[3].value,
                    cost_krw: parseNumber(inputs[4].value),
                    notes: inputs[5].value
                };
                cost_components.push(component);
            });
            
            // Ìèº Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
            const data = {
                reservation_status: document.getElementById('edit_reservation_status').value,
                platform_name: document.getElementById('edit_platform_name').value,
                package_name: document.getElementById('edit_package_name').value,
                customer: customer,
                travel_period: {
                    departure_date: document.getElementById('edit_departure_date').value,
                    return_date: document.getElementById('edit_return_date').value,
                    nights: (() => {
                        const dep = new Date(document.getElementById('edit_departure_date').value);
                        const ret = new Date(document.getElementById('edit_return_date').value);
                        return Math.floor((ret - dep) / (1000 * 60 * 60 * 24));
                    })(),
                    days: (() => {
                        const dep = new Date(document.getElementById('edit_departure_date').value);
                        const ret = new Date(document.getElementById('edit_return_date').value);
                        return Math.floor((ret - dep) / (1000 * 60 * 60 * 24)) + 1;
                    })()
                },
                people: {
                    adult: parseInt(document.getElementById('edit_people_adult').value),
                    child: parseInt(document.getElementById('edit_people_child').value),
                    infant: parseInt(document.getElementById('edit_people_infant').value)
                },
                flight_info: {
                    outbound_flight: document.getElementById('edit_outbound_flight').value,
                    outbound_departure_time: document.getElementById('edit_outbound_departure_time').value,
                    outbound_arrival_time: document.getElementById('edit_outbound_arrival_time').value,
                    inbound_flight: document.getElementById('edit_inbound_flight').value,
                    inbound_departure_time: document.getElementById('edit_inbound_departure_time').value,
                    inbound_arrival_time: document.getElementById('edit_inbound_arrival_time').value
                },
                hotel_name: document.getElementById('edit_hotel_name').value,
                room_type: document.getElementById('edit_room_type').value,
                itinerary: document.getElementById('edit_itinerary').value,
                inclusions: document.getElementById('edit_inclusions').value,
                exclusions: document.getElementById('edit_exclusions').value,
                guests: guests.filter(g => g && Object.keys(g).length > 0),
                pricing: {
                    currency: document.getElementById('edit_currency').value,
                    exchange_rate: parseNumber(document.getElementById('edit_exchange_rate').value),
                    price_adult: parseNumber(document.getElementById('edit_price_adult').value),
                    price_child: parseNumber(document.getElementById('edit_price_child').value),
                    price_infant: parseNumber(document.getElementById('edit_price_infant').value),
                    total_selling_price: parseNumber(document.getElementById('edit_total_selling_price').value),
                    adjustments: (() => {
                        const adjustments = [];
                        const adjustmentCards = document.querySelectorAll('#edit_price_adjustments_container .card');
                        adjustmentCards.forEach(card => {
                            const id = card.id.replace('edit_adjustment_', '');
                            const name = document.getElementById(`edit_adjustment_name_${id}`)?.value || '';
                            const type = document.getElementById(`edit_adjustment_type_${id}`)?.value || 'add';
                            const amount = parseNumber(document.getElementById(`edit_adjustment_amount_${id}`)?.value);
                            
                            if (name && amount) {
                                adjustments.push({
                                    description: name,
                                    amount: type === 'subtract' ? -Math.abs(amount) : Math.abs(amount)
                                });
                            }
                        });
                        return adjustments;
                    })()
                },
                billings: billings,
                cost_components: cost_components,
                special_requests: document.getElementById('edit_special_requests').value
            };

            // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
            if (!data.platform_name || !data.package_name) {
                alert('ÌïÑÏàò Ìï≠Î™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            try {
                const response = await fetch(`/api/package-reservations/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert(`ÏòàÏïΩÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.\n${result.changes_count || 0}Í∞ú ÌïÑÎìúÍ∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`);
                    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                    
                    // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ® ÌõÑ ÌïòÏù¥ÎùºÏù¥Ìä∏Îêú ÌñâÏúºÎ°ú Ïä§ÌÅ¨Î°§
                    await loadReservations();
                    setTimeout(() => {
                        const highlightedRow = document.querySelector('.last-edited-row');
                        if (highlightedRow) {
                            highlightedRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                } else {
                    alert('ÏòàÏïΩ ÏàòÏ†ï Ïã§Ìå®: ' + result.message);
                }
            } catch (error) {
                console.error('ÏòàÏïΩ ÏàòÏ†ï Ïò§Î•ò:', error);
                alert('ÏòàÏïΩ ÏàòÏ†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        let assignmentModalInstance = null;
        let currentReservationId = null;

        // ÏàòÎ∞∞ÏÑú Î™®Îã¨ Ïó¥Í∏∞
        async function openAssignmentModal(id) {
            try {
                currentReservationId = id;
                const response = await fetch(`/api/package-reservations/${id}`);
                const result = await response.json();

                if (result.success) {
                    const r = result.data;
                    
                    // Í∏∞Î≥∏ ÏòàÏïΩ Ï†ïÎ≥¥ ÌëúÏãú
                    document.getElementById('assign_reservation_number').textContent = r.reservation_number;
                    document.getElementById('assign_customer_name').textContent = `${r.customer.korean_name}${r.customer.english_name ? ' / ' + r.customer.english_name : ''}`;
                    document.getElementById('assign_departure_date').textContent = new Date(r.travel_period.departure_date).toLocaleDateString('ko-KR');
                    document.getElementById('assign_return_date').textContent = new Date(r.travel_period.return_date).toLocaleDateString('ko-KR');
                    document.getElementById('assign_period').textContent = `${r.travel_period.nights}Î∞ï${r.travel_period.days}Ïùº`;
                    document.getElementById('assign_people').textContent = `ÏÑ±Ïù∏${r.people.adult}${r.people.child > 0 ? `/ÏÜåÏïÑ${r.people.child}` : ''}${r.people.infant > 0 ? `/Ïú†ÏïÑ${r.people.infant}` : ''}`;
                    document.getElementById('assign_package_name').textContent = r.package_name;
                    document.getElementById('assign_platform_name').textContent = r.platform_name;
                    
                    // Îß§ÏûÖ Íµ¨ÏÑ±ÏöîÏÜåÎ≥Ñ ÏàòÎ∞∞ÏÑú Î™©Î°ù ÏÉùÏÑ±
                    renderAssignmentList(r);
                    
                    // Î™®Îã¨ Ïó¥Í∏∞
                    if (!assignmentModalInstance) {
                        assignmentModalInstance = new bootstrap.Modal(document.getElementById('assignmentModal'));
                    }
                    assignmentModalInstance.show();
                } else {
                    alert('ÏòàÏïΩ Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®: ' + result.message);
                }
            } catch (error) {
                console.error('ÏòàÏïΩ Ï†ïÎ≥¥ Î°úÎìú Ïò§Î•ò:', error);
                alert('ÏòàÏïΩ Ï†ïÎ≥¥ Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // ÏàòÎ∞∞ÏÑú Î™®Îã¨ Îã´Í∏∞
        function closeAssignmentModal() {
            if (assignmentModalInstance) {
                assignmentModalInstance.hide();
            }
            // Î∞∞Í≤Ω Ï†úÍ±∞
            setTimeout(() => {
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }, 300);
        }

        // Îß§ÏûÖ Íµ¨ÏÑ±ÏöîÏÜåÎ≥Ñ ÏàòÎ∞∞ÏÑú Î™©Î°ù Î†åÎçîÎßÅ
        function renderAssignmentList(reservation) {
            const container = document.getElementById('assignment_list');
            
            if (!reservation.cost_components || reservation.cost_components.length === 0) {
                container.innerHTML = '<p class="text-muted">Îß§ÏûÖ Íµ¨ÏÑ±ÏöîÏÜåÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }

            const componentTypeNames = {
                flight: '‚úàÔ∏è Ìï≠Í≥µÍ∂å',
                hotel: 'üè® Ìò∏ÌÖî',
                tour: 'üéØ Ìà¨Ïñ¥',
                ground: 'üöó ÏßÄÏÉÅ',
                other: 'üì¶ Í∏∞ÌÉÄ'
            };

            let html = '';
            reservation.cost_components.forEach((component, index) => {
                const typeName = componentTypeNames[component.component_type] || component.component_type;
                const costKRW = component.cost_currency === 'USD' 
                    ? (component.cost_amount * (reservation.pricing?.exchange_rate || 1300)).toLocaleString()
                    : component.cost_amount.toLocaleString();
                
                const historyCount = component.assignment_history ? component.assignment_history.length : 0;
                const historyHtml = component.assignment_history && component.assignment_history.length > 0
                    ? component.assignment_history.map((history, hIndex) => `
                        <div class="d-flex align-items-center justify-content-between mb-2 p-2 border rounded" style="background: #f8f9fa;">
                            <div>
                                <span class="badge bg-primary me-2">#${hIndex + 1}</span>
                                <small class="text-muted">
                                    ${new Date(history.created_at).toLocaleString('ko-KR')}
                                    ${history.created_by ? `<span class="ms-2 text-primary">by ${history.created_by}</span>` : ''}
                                </small>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewHistoryAssignment('${reservation._id}', ${index}, ${hIndex})" title="Ïù¥ Î≤ÑÏ†Ñ Î≥¥Í∏∞">
                                <i class="fas fa-eye me-1"></i>Î≥¥Í∏∞
                            </button>
                        </div>
                    `).join('')
                    : '';

                html += `
                    <div class="card mb-3" style="border-left: 4px solid #28a745;">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <h6 class="mb-1">${typeName} - ${component.vendor_name}</h6>
                                    <small class="text-muted">Îß§ÏûÖÍ∞Ä: ${component.cost_amount.toLocaleString()} ${component.cost_currency} ${component.cost_currency === 'USD' ? `(‚Ç©${costKRW})` : ''}</small>
                                    ${component.notes ? `<br><small class="text-muted">ÎπÑÍ≥†: ${component.notes}</small>` : ''}
                                </div>
                                <div class="col-md-3">
                                    <div id="assignment_status_${index}">
                                        ${component.assignment_sent_at 
                                            ? `<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Î∞úÏÜ°ÏôÑÎ£å</span>
                                               <br><small class="text-muted">${new Date(component.assignment_sent_at).toLocaleString('ko-KR')}</small>`
                                            : '<span class="badge bg-secondary">ÎØ∏Î∞úÏÜ°</span>'
                                        }
                                        ${component.assignment_confirmed_at 
                                            ? `<br><span class="badge bg-info mt-1"><i class="fas fa-eye me-1"></i>ÏàòÏã†ÌôïÏù∏</span>
                                               <br><small class="text-muted">${new Date(component.assignment_confirmed_at).toLocaleString('ko-KR')}</small>`
                                            : ''
                                        }
                                        ${historyCount > 0 
                                            ? `<br><button class="btn btn-sm btn-link p-0 mt-1" onclick="toggleHistory(${index})">
                                                   <i class="fas fa-history me-1"></i>ÏÉùÏÑ±Ïù¥Î†• (${historyCount})
                                               </button>`
                                            : ''
                                        }
                                    </div>
                                    <div id="assignment_history_${index}" class="mt-2" style="display: none;">
                                        <div class="border-top pt-2">
                                            <strong class="text-muted" style="font-size: 0.85rem;">ÏÉùÏÑ± Ïù¥Î†•</strong>
                                            <div class="mt-1">
                                                ${historyHtml}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-5 text-end">
                                    <button class="btn btn-sm btn-success me-1" onclick="generateAssignment('${reservation._id}', ${index})" title="ÏàòÎ∞∞ÏÑú ÏÉùÏÑ±">
                                        <i class="fas fa-file-alt me-1"></i>ÏàòÎ∞∞ÏÑú ÏÉùÏÑ±
                                    </button>
                                    <button class="btn btn-sm btn-warning me-1" onclick="previewAssignment('${reservation._id}', ${index})" title="ÎØ∏Î¶¨Î≥¥Í∏∞">
                                        <i class="fas fa-eye me-1"></i>ÎØ∏Î¶¨Î≥¥Í∏∞
                                    </button>
                                    <button class="btn btn-sm btn-primary me-1" onclick="sendAssignmentEmail('${reservation._id}', ${index})" title="Ïù¥Î©îÏùº Î∞úÏÜ°">
                                        <i class="fas fa-envelope me-1"></i>Ïù¥Î©îÏùº Î∞úÏÜ°
                                    </button>
                                    <button class="btn btn-sm btn-info" onclick="copyAssignmentLink('${reservation._id}', ${index})" title="ÎßÅÌÅ¨ Î≥µÏÇ¨">
                                        <i class="fas fa-link me-1"></i>ÎßÅÌÅ¨ Î≥µÏÇ¨
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // ÏàòÎ∞∞ÏÑú ÏÉùÏÑ±
        async function generateAssignment(reservationId, componentIndex) {
            try {
                const response = await fetch(`/api/package-reservations/${reservationId}/assignment/${componentIndex}`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    alert('ÏàòÎ∞∞ÏÑúÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.');
                    // Î™®Îã¨ ÏÉàÎ°úÍ≥†Ïπ®
                    openAssignmentModal(reservationId);
                } else {
                    alert('ÏàòÎ∞∞ÏÑú ÏÉùÏÑ± Ïã§Ìå®: ' + result.message);
                }
            } catch (error) {
                console.error('ÏàòÎ∞∞ÏÑú ÏÉùÏÑ± Ïò§Î•ò:', error);
                alert('ÏàòÎ∞∞ÏÑú ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // ÏàòÎ∞∞ÏÑú Ïù¥Î©îÏùº Î∞úÏÜ°
        async function sendAssignmentEmail(reservationId, componentIndex) {
            const email = prompt('ÏàòÎ∞∞ÏÑúÎ•º Î∞õÏùÑ Ïù¥Î©îÏùº Ï£ºÏÜåÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
            if (!email) return;

            try {
                const response = await fetch(`/api/package-reservations/${reservationId}/assignment/${componentIndex}/email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const result = await response.json();

                if (result.success) {
                    alert(`ÏàòÎ∞∞ÏÑúÍ∞Ä ${email}Î°ú Î∞úÏÜ°ÎêòÏóàÏäµÎãàÎã§.`);
                    // Î™®Îã¨ ÏÉàÎ°úÍ≥†Ïπ®
                    openAssignmentModal(reservationId);
                } else {
                    alert('Ïù¥Î©îÏùº Î∞úÏÜ° Ïã§Ìå®: ' + result.message);
                }
            } catch (error) {
                console.error('Ïù¥Î©îÏùº Î∞úÏÜ° Ïò§Î•ò:', error);
                alert('Ïù¥Î©îÏùº Î∞úÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨ Î≥µÏÇ¨
        async function copyAssignmentLink(reservationId, componentIndex) {
            try {
                const response = await fetch(`/api/package-reservations/${reservationId}/assignment/${componentIndex}/link`);
                const result = await response.json();

                if (result.success) {
                    const link = result.link;
                    await navigator.clipboard.writeText(link);
                    alert('ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.\n\n' + link);
                } else {
                    alert('ÎßÅÌÅ¨ ÏÉùÏÑ± Ïã§Ìå®: ' + result.message);
                }
            } catch (error) {
                console.error('ÎßÅÌÅ¨ Î≥µÏÇ¨ Ïò§Î•ò:', error);
                alert('ÎßÅÌÅ¨ Î≥µÏÇ¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // ÏàòÎ∞∞ÏÑú ÎØ∏Î¶¨Î≥¥Í∏∞
        async function previewAssignment(reservationId, componentIndex) {
            try {
                const response = await fetch(`/api/package-reservations/${reservationId}/assignment/${componentIndex}/link`);
                const result = await response.json();

                if (result.success) {
                    window.open(result.link, '_blank');
                } else {
                    alert('ÎØ∏Î¶¨Î≥¥Í∏∞ Ïã§Ìå®: ' + result.message);
                }
            } catch (error) {
                console.error('ÎØ∏Î¶¨Î≥¥Í∏∞ Ïò§Î•ò:', error);
                alert('ÎØ∏Î¶¨Î≥¥Í∏∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // ÏàòÎ∞∞ÏÑú ÏÉùÏÑ± Ïù¥Î†• ÌÜ†Í∏Ä
        function toggleHistory(index) {
            const historyDiv = document.getElementById(`assignment_history_${index}`);
            if (historyDiv) {
                historyDiv.style.display = historyDiv.style.display === 'none' ? 'block' : 'none';
            }
        }

        let historyModalInstance = null;

        // Ïù¥Î†•Î≥Ñ ÏàòÎ∞∞ÏÑú Î≥¥Í∏∞
        async function viewHistoryAssignment(reservationId, componentIndex, historyIndex) {
            try {
                const response = await fetch(`/api/package-reservations/${reservationId}`);
                const result = await response.json();

                if (!result.success) {
                    alert('ÏòàÏïΩ Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®: ' + result.message);
                    return;
                }

                const reservation = result.data;
                const component = reservation.cost_components[componentIndex];
                const history = component.assignment_history[historyIndex];

                if (!history || !history.snapshot) {
                    alert('ÏàòÎ∞∞ÏÑú Ïù¥Î†• Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                    return;
                }

                const snapshot = history.snapshot;
                
                // ÏàòÎ∞∞ÏÑú ÎÇ¥Ïö© ÏÉùÏÑ±
                let content = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>ÏÉùÏÑ± ÏãúÍ∞Ñ:</strong> ${new Date(history.created_at).toLocaleString('ko-KR')}
                        ${history.created_by ? `<span class="ms-3"><strong>ÏÉùÏÑ±Ïûê:</strong> ${history.created_by}</span>` : ''}
                    </div>

                    <!-- Í∏∞Î≥∏ ÏòàÏïΩ Ï†ïÎ≥¥ -->
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Í∏∞Î≥∏ ÏòàÏïΩ Ï†ïÎ≥¥</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <strong>ÏòàÏïΩÎ≤àÌò∏:</strong> ${snapshot.reservation_number || '-'}
                                </div>
                                <div class="col-md-4">
                                    <strong>ÏòàÏïΩ ÏÉÅÌÉú:</strong> 
                                    ${snapshot.reservation_status === 'confirmed' ? '<span class="badge bg-success">‚úÖ ÌôïÏ†ï</span>' : 
                                      snapshot.reservation_status === 'pending' ? '<span class="badge bg-warning">‚è≥ ÎåÄÍ∏∞</span>' : 
                                      snapshot.reservation_status === 'cancelled' ? '<span class="badge bg-danger">‚ùå Ï∑®ÏÜå</span>' : 
                                      snapshot.reservation_status || '-'}
                                </div>
                                <div class="col-md-4">
                                    <strong>ÏòàÏïΩÏ±ÑÎÑê:</strong> ${snapshot.platform_name || '-'}
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-12">
                                    <strong>Ìå®ÌÇ§ÏßÄÎ™Ö:</strong> ${snapshot.package_name || '-'}
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-3">
                                    <strong>Ï∂úÎ∞úÏùº:</strong> ${snapshot.departure_date ? new Date(snapshot.departure_date).toLocaleDateString('ko-KR') : '-'}
                                </div>
                                <div class="col-md-3">
                                    <strong>Í∑ÄÍµ≠Ïùº:</strong> ${snapshot.return_date ? new Date(snapshot.return_date).toLocaleDateString('ko-KR') : '-'}
                                </div>
                                <div class="col-md-3">
                                    <strong>Í∏∞Í∞Ñ:</strong> ${snapshot.nights || 0}Î∞ï${snapshot.days || 0}Ïùº
                                </div>
                                <div class="col-md-3">
                                    <strong>Ïù∏Ïõê:</strong> ÏÑ±Ïù∏${snapshot.adult_count || 0}${snapshot.child_count > 0 ? `/ÏÜåÏïÑ${snapshot.child_count}` : ''}${snapshot.infant_count > 0 ? `/Ïú†ÏïÑ${snapshot.infant_count}` : ''}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ìï≠Í≥µÌé∏ Ï†ïÎ≥¥ -->
                    ${snapshot.flight_info && (snapshot.flight_info.outbound_flight || snapshot.flight_info.inbound_flight) ? `
                    <div class="card mb-3">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="fas fa-plane me-2"></i>Ìï≠Í≥µÌé∏ Ï†ïÎ≥¥</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                ${snapshot.flight_info.outbound_flight ? `
                                <div class="col-md-6">
                                    <h6 class="text-primary">Ï∂úÍµ≠Ìé∏</h6>
                                    <strong>Ìé∏Î™Ö:</strong> ${snapshot.flight_info.outbound_flight}<br>
                                    ${snapshot.flight_info.outbound_departure_time ? `<strong>Ï∂úÎ∞ú:</strong> ${snapshot.flight_info.outbound_departure_time}<br>` : ''}
                                    ${snapshot.flight_info.outbound_arrival_time ? `<strong>ÎèÑÏ∞©:</strong> ${snapshot.flight_info.outbound_arrival_time}` : ''}
                                </div>
                                ` : ''}
                                ${snapshot.flight_info.inbound_flight ? `
                                <div class="col-md-6">
                                    <h6 class="text-success">ÏûÖÍµ≠Ìé∏</h6>
                                    <strong>Ìé∏Î™Ö:</strong> ${snapshot.flight_info.inbound_flight}<br>
                                    ${snapshot.flight_info.inbound_departure_time ? `<strong>Ï∂úÎ∞ú:</strong> ${snapshot.flight_info.inbound_departure_time}<br>` : ''}
                                    ${snapshot.flight_info.inbound_arrival_time ? `<strong>ÎèÑÏ∞©:</strong> ${snapshot.flight_info.inbound_arrival_time}` : ''}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Ìò∏ÌÖî Ï†ïÎ≥¥ -->
                    ${snapshot.hotel_name || snapshot.room_type ? `
                    <div class="card mb-3">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="fas fa-hotel me-2"></i>Ìò∏ÌÖî Ï†ïÎ≥¥</h6>
                        </div>
                        <div class="card-body">
                            ${snapshot.hotel_name ? `<strong>Ìò∏ÌÖîÎ™Ö:</strong> ${snapshot.hotel_name}<br>` : ''}
                            ${snapshot.room_type ? `<strong>Î£∏ÌÉÄÏûÖ:</strong> ${snapshot.room_type}` : ''}
                        </div>
                    </div>
                    ` : ''}

                    <!-- Í≥†Í∞ù Ï†ïÎ≥¥ -->
                    <div class="card mb-3">
                        <div class="card-header bg-dark text-white">
                            <h6 class="mb-0"><i class="fas fa-user me-2"></i>Í≥†Í∞ù Ï†ïÎ≥¥</h6>
                        </div>
                        <div class="card-body">
                            <strong>Í≥†Í∞ùÎ™Ö:</strong> ${snapshot.customer_name || '-'}${snapshot.english_name ? ` / ${snapshot.english_name}` : ''}<br>
                            ${snapshot.phone_number ? `<strong>Ïó∞ÎùΩÏ≤ò:</strong> ${snapshot.phone_number}<br>` : ''}
                            ${snapshot.email ? `<strong>Ïù¥Î©îÏùº:</strong> ${snapshot.email}` : ''}
                        </div>
                    </div>

                    <!-- ÏùºÏ†ï Î∞è Ìè¨Ìï®/Î∂àÌè¨Ìï® ÏÇ¨Ìï≠ -->
                    ${snapshot.itinerary || snapshot.inclusions || snapshot.exclusions ? `
                    <div class="card mb-3">
                        <div class="card-header" style="background: linear-gradient(to right, #667eea, #764ba2); color: white;">
                            <h6 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>ÏùºÏ†ï Î∞è Ìè¨Ìï®/Î∂àÌè¨Ìï® ÏÇ¨Ìï≠</h6>
                        </div>
                        <div class="card-body">
                            ${snapshot.itinerary ? `<div class="mb-2"><strong>ÏùºÏ†ï:</strong><br><div class="alert alert-light mt-1" style="white-space: pre-line;">${snapshot.itinerary}</div></div>` : ''}
                            ${snapshot.inclusions ? `<div class="mb-2"><strong>Ìè¨Ìï®ÏÇ¨Ìï≠:</strong><br><div class="alert alert-success mt-1" style="white-space: pre-line;">${snapshot.inclusions}</div></div>` : ''}
                            ${snapshot.exclusions ? `<div class="mb-2"><strong>Î∂àÌè¨Ìï®ÏÇ¨Ìï≠:</strong><br><div class="alert alert-warning mt-1" style="white-space: pre-line;">${snapshot.exclusions}</div></div>` : ''}
                        </div>
                    </div>
                    ` : ''}

                    <!-- ÌäπÎ≥Ñ ÏöîÏ≤≠ÏÇ¨Ìï≠ -->
                    ${snapshot.special_requests ? `
                    <div class="card mb-3">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>ÌäπÎ≥Ñ ÏöîÏ≤≠ÏÇ¨Ìï≠</h6>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-danger mb-0" style="white-space: pre-line;">${snapshot.special_requests}</div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- ÏàòÎ∞∞ Ï†ïÎ≥¥ -->
                    <div class="card mb-3">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="fas fa-building me-2"></i>ÏàòÎ∞∞ Ï†ïÎ≥¥</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Ìï≠Î™©:</strong> ${snapshot.component_type || '-'} - ${snapshot.vendor_name || '-'}
                                </div>
                                <div class="col-md-6">
                                    <strong>Îß§ÏûÖÍ∞Ä:</strong> ${snapshot.cost_amount ? snapshot.cost_amount.toLocaleString() : '0'} ${snapshot.cost_currency || 'KRW'}
                                    ${snapshot.cost_currency === 'USD' && snapshot.cost_krw ? `<br><small class="text-muted">(‚Ç©${snapshot.cost_krw.toLocaleString()})</small>` : ''}
                                </div>
                                ${snapshot.notes ? `
                                <div class="col-md-12 mt-2">
                                    <strong>ÎπÑÍ≥†:</strong> ${snapshot.notes}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('history_assignment_content').innerHTML = content;

                if (!historyModalInstance) {
                    historyModalInstance = new bootstrap.Modal(document.getElementById('historyAssignmentModal'));
                }
                historyModalInstance.show();

            } catch (error) {
                console.error('Ïù¥Î†• ÏàòÎ∞∞ÏÑú Î≥¥Í∏∞ Ïò§Î•ò:', error);
                alert('Ïù¥Î†• ÏàòÎ∞∞ÏÑú Î≥¥Í∏∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // Ïù¥Î†• Î™®Îã¨ Îã´Í∏∞
        function closeHistoryModal() {
            if (historyModalInstance) {
                historyModalInstance.hide();
            }
            setTimeout(() => {
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }, 300);
        }

        async function openInvoiceModal(id) {
            try {
                currentConfirmationId = id;
                
                const response = await fetch(`/api/package-reservations/${id}`);
                if (!response.ok) throw new Error('ÏòàÏïΩ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
                
                const result = await response.json();
                const reservation = result.data || result;
                
                console.log('üì¶ ÌôïÏ†ïÏÑú Î™®Îã¨ Îç∞Ïù¥ÌÑ∞:', reservation);
                
                // Í∏∞Î≥∏ ÏòàÏïΩ Ï†ïÎ≥¥
                document.getElementById('invoice_reservation_number').textContent = reservation.reservation_number || '-';
                document.getElementById('invoice_customer_name').textContent = reservation.customer?.korean_name || '-';
                document.getElementById('invoice_departure_date').textContent = reservation.travel_period?.departure_date ? new Date(reservation.travel_period.departure_date).toLocaleDateString('ko-KR') : '-';
                document.getElementById('invoice_return_date').textContent = reservation.travel_period?.return_date ? new Date(reservation.travel_period.return_date).toLocaleDateString('ko-KR') : '-';
                document.getElementById('invoice_period').textContent = `${reservation.travel_period?.nights || 0}Î∞ï ${reservation.travel_period?.days || 0}Ïùº`;
                document.getElementById('invoice_people').textContent = `ÏÑ±Ïù∏ ${reservation.people?.adult || 0}Î™Ö${reservation.people?.child ? `, ÏÜåÏïÑ ${reservation.people.child}Î™Ö` : ''}${reservation.people?.infant ? `, Ïú†ÏïÑ ${reservation.people.infant}Î™Ö` : ''}`;
                document.getElementById('invoice_package_name').textContent = reservation.package_name || '-';
                document.getElementById('invoice_platform_name').textContent = reservation.platform_name || '-';
                
                // Ïù∏ÏõêÎ≥Ñ ÌåêÎß§Í∞Ä
                let perPersonHTML = '<table class="table table-sm table-bordered mb-0"><tbody>';
                const pricing = reservation.pricing || {};
                
                if (reservation.people?.adult > 0) {
                    perPersonHTML += `
                        <tr>
                            <td style="width: 30%;"><strong>ÏÑ±Ïù∏ (${reservation.people.adult}Î™Ö)</strong></td>
                            <td style="width: 30%;" class="text-end">1Ïù∏Îãπ ‚Ç©${(pricing.price_adult || 0).toLocaleString()}</td>
                            <td style="width: 40%;" class="text-end"><strong>‚Ç©${((pricing.price_adult || 0) * reservation.people.adult).toLocaleString()}</strong></td>
                        </tr>
                    `;
                }
                
                if (reservation.people?.child > 0) {
                    perPersonHTML += `
                        <tr>
                            <td><strong>ÏÜåÏïÑ (${reservation.people.child}Î™Ö)</strong></td>
                            <td class="text-end">1Ïù∏Îãπ ‚Ç©${(pricing.price_child || 0).toLocaleString()}</td>
                            <td class="text-end"><strong>‚Ç©${((pricing.price_child || 0) * reservation.people.child).toLocaleString()}</strong></td>
                        </tr>
                    `;
                }
                
                if (reservation.people?.infant > 0) {
                    perPersonHTML += `
                        <tr>
                            <td><strong>Ïú†ÏïÑ (${reservation.people.infant}Î™Ö)</strong></td>
                            <td class="text-end">1Ïù∏Îãπ ‚Ç©${(pricing.price_infant || 0).toLocaleString()}</td>
                            <td class="text-end"><strong>‚Ç©${((pricing.price_infant || 0) * reservation.people.infant).toLocaleString()}</strong></td>
                        </tr>
                    `;
                }
                
                const baseTotal = ((pricing.price_adult || 0) * (reservation.people?.adult || 0)) +
                                 ((pricing.price_child || 0) * (reservation.people?.child || 0)) +
                                 ((pricing.price_infant || 0) * (reservation.people?.infant || 0));
                
                perPersonHTML += `
                    <tr class="table-light">
                        <td colspan="2"><strong>Ïù∏ÏõêÎ≥Ñ ÌåêÎß§Í∞Ä ÏÜåÍ≥Ñ</strong></td>
                        <td class="text-end"><strong>‚Ç©${baseTotal.toLocaleString()}</strong></td>
                    </tr>
                `;
                perPersonHTML += '</tbody></table>';
                document.getElementById('invoice_per_person_prices').innerHTML = perPersonHTML;
                
                // Í∏àÏï° Î≥ÄÎèô ÎÇ¥Ïó≠
                if (pricing.adjustments && pricing.adjustments.length > 0) {
                    let adjustmentsHTML = '<table class="table table-sm table-bordered mb-0"><tbody>';
                    let adjustmentsTotal = 0;
                    
                    pricing.adjustments.forEach(adj => {
                        const amount = adj.amount || 0;
                        adjustmentsTotal += amount;
                        const sign = amount >= 0 ? '+' : '';
                        const colorClass = amount >= 0 ? 'text-success' : 'text-danger';
                        
                        adjustmentsHTML += `
                            <tr>
                                <td style="width: 70%;"><strong>${adj.description || 'Í∏àÏï° Î≥ÄÎèô'}</strong></td>
                                <td style="width: 30%;" class="text-end ${colorClass}"><strong>${sign}‚Ç©${amount.toLocaleString()}</strong></td>
                            </tr>
                        `;
                    });
                    
                    adjustmentsHTML += `
                        <tr class="table-light">
                            <td><strong>Í∏àÏï° Î≥ÄÎèô Ìï©Í≥Ñ</strong></td>
                            <td class="text-end ${adjustmentsTotal >= 0 ? 'text-success' : 'text-danger'}"><strong>${adjustmentsTotal >= 0 ? '+' : ''}‚Ç©${adjustmentsTotal.toLocaleString()}</strong></td>
                        </tr>
                    `;
                    adjustmentsHTML += '</tbody></table>';
                    
                    document.getElementById('invoice_price_adjustments').innerHTML = adjustmentsHTML;
                    document.getElementById('invoice_price_adjustments_section').style.display = 'block';
                } else {
                    document.getElementById('invoice_price_adjustments_section').style.display = 'none';
                }
                
                // Ï¥ù Ï≤≠Íµ¨ Í∏àÏï°
                const totalAmount = baseTotal + (pricing.adjustments?.reduce((sum, adj) => sum + (adj.amount || 0), 0) || 0);
                document.getElementById('invoice_total_amount').textContent = `‚Ç©${totalAmount.toLocaleString()}`;
                
                // Ìï≠Í≥µÌé∏ Ï†ïÎ≥¥
                if (reservation.flight_info && (reservation.flight_info.outbound_flight || reservation.flight_info.inbound_flight)) {
                    let flightHTML = '';
                    
                    if (reservation.flight_info.outbound_flight) {
                        flightHTML += `
                            <div class="mb-2">
                                <strong>Í∞ÄÎäîÌé∏:</strong> ${reservation.flight_info.outbound_flight}
                            </div>
                        `;
                    }
                    
                    if (reservation.flight_info.inbound_flight) {
                        flightHTML += `
                            <div>
                                <strong>Ïò§ÎäîÌé∏:</strong> ${reservation.flight_info.inbound_flight}
                            </div>
                        `;
                    }
                    
                    document.getElementById('invoice_flight_info').innerHTML = flightHTML;
                    document.getElementById('invoice_flight_info_section').style.display = 'block';
                } else {
                    document.getElementById('invoice_flight_info_section').style.display = 'none';
                }
                
                // Ìò∏ÌÖî Ï†ïÎ≥¥
                if (reservation.hotel_name) {
                    let hotelHTML = `
                        <div><strong>Ìò∏ÌÖîÎ™Ö:</strong> ${reservation.hotel_name}</div>
                    `;
                    if (reservation.room_type) {
                        hotelHTML += `<div><strong>Í∞ùÏã§ÌÉÄÏûÖ:</strong> ${reservation.room_type}</div>`;
                    }
                    
                    document.getElementById('invoice_hotel_info').innerHTML = hotelHTML;
                    document.getElementById('invoice_hotel_info_section').style.display = 'block';
                } else {
                    document.getElementById('invoice_hotel_info_section').style.display = 'none';
                }
                
                // ÏùºÏ†ï
                if (reservation.itinerary) {
                    document.getElementById('invoice_itinerary').textContent = reservation.itinerary;
                    document.getElementById('invoice_itinerary_section').style.display = 'block';
                } else {
                    document.getElementById('invoice_itinerary_section').style.display = 'none';
                }
                
                // Ìè¨Ìï®ÏÇ¨Ìï≠
                if (reservation.inclusions) {
                    document.getElementById('invoice_inclusions').textContent = reservation.inclusions;
                    document.getElementById('invoice_inclusions_section').style.display = 'block';
                } else {
                    document.getElementById('invoice_inclusions_section').style.display = 'none';
                }
                
                // Î∂àÌè¨Ìï®ÏÇ¨Ìï≠
                if (reservation.exclusions) {
                    document.getElementById('invoice_exclusions').textContent = reservation.exclusions;
                    document.getElementById('invoice_exclusions_section').style.display = 'block';
                } else {
                    document.getElementById('invoice_exclusions_section').style.display = 'none';
                }
                
                // ÌäπÎ≥Ñ ÏöîÏ≤≠ÏÇ¨Ìï≠
                if (reservation.special_requests) {
                    document.getElementById('invoice_special_requests').textContent = reservation.special_requests;
                    document.getElementById('invoice_special_requests_section').style.display = 'block';
                } else {
                    document.getElementById('invoice_special_requests_section').style.display = 'none';
                }
                
                // ÌôïÏ†ïÏÑú ÏÉùÏÑ± ÏÉÅÌÉú Î∞è Ïù¥Î†• ÌëúÏãú
                const historyCount = reservation.confirmation_history?.length || 0;
                
                if (reservation.confirmation_sent_at) {
                    document.getElementById('confirmation_status').innerHTML = `
                        <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>ÏÉùÏÑ±ÏôÑÎ£å</span>
                        <br><small class="text-muted">${new Date(reservation.confirmation_sent_at).toLocaleString('ko-KR')}</small>
                    `;
                } else {
                    document.getElementById('confirmation_status').innerHTML = '<span class="badge bg-secondary">ÎØ∏ÏÉùÏÑ±</span>';
                }
                
                if (historyCount > 0) {
                    document.getElementById('confirmation_history_count').textContent = historyCount;
                    document.getElementById('confirmation_history_toggle').style.display = 'inline-block';
                    
                    // Ïù¥Î†• Î™©Î°ù ÏÉùÏÑ±
                    let historyHTML = '';
                    reservation.confirmation_history.forEach((history, hIndex) => {
                        historyHTML += `
                            <div class="d-flex align-items-center justify-content-between mb-2 p-2 border rounded" style="background: #f8f9fa;">
                                <div>
                                    <span class="badge bg-primary me-2">#${hIndex + 1}</span>
                                    <small class="text-muted">
                                        ${new Date(history.created_at).toLocaleString('ko-KR')}
                                        ${history.created_by ? `<span class="ms-2 text-primary">by ${history.created_by}</span>` : ''}
                                    </small>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewConfirmationHistory(${hIndex})" title="Ïù¥ Î≤ÑÏ†Ñ Î≥¥Í∏∞">
                                    <i class="fas fa-eye me-1"></i>Î≥¥Í∏∞
                                </button>
                            </div>
                        `;
                    });
                    document.getElementById('confirmation_history_items').innerHTML = historyHTML;
                } else {
                    document.getElementById('confirmation_history_toggle').style.display = 'none';
                }
                
                // Ïù¥Î©îÏùº ÏûêÎèô ÏûÖÎ†•
                if (reservation.guests && reservation.guests.length > 0 && reservation.guests[0].email) {
                    document.getElementById('invoice_email').value = reservation.guests[0].email;
                } else {
                    document.getElementById('invoice_email').value = '';
                }
                
                document.getElementById('invoice_memo').value = '';
                
                // Î™®Îã¨ Ïó¥Í∏∞ (Í∏∞Ï°¥ Ïù∏Ïä§ÌÑ¥Ïä§Í∞Ä ÏûàÏúºÎ©¥ Ïû¨ÏÇ¨Ïö©)
                let modal = bootstrap.Modal.getInstance(document.getElementById('invoiceModal'));
                if (!modal) {
                    modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
                }
                modal.show();
                
            } catch (error) {
                console.error('ÌôïÏ†ïÏÑú Î™®Îã¨ Ïó¥Í∏∞ Ïò§Î•ò:', error);
                alert('ÌôïÏ†ïÏÑú Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }
        
        let currentConfirmationId = null;
        
        async function sendInvoice() {
            const email = document.getElementById('invoice_email').value.trim();
            
            if (!email) {
                alert('ÏàòÏã† Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                alert('Ïò¨Î∞îÎ•∏ Ïù¥Î©îÏùº Ï£ºÏÜåÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            if (!confirm(`${email}Î°ú ÌôïÏ†ïÏÑúÎ•º Î∞úÏÜ°ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                return;
            }
            
            try {
                // TODO: ÌôïÏ†ïÏÑú Î∞úÏÜ° API Íµ¨ÌòÑ
                alert('ÌôïÏ†ïÏÑú Î∞úÏÜ° Í∏∞Îä•ÏùÄ Ï∂îÌõÑ Íµ¨ÌòÑ ÏòàÏ†ïÏûÖÎãàÎã§.');
                
                // ÏÑ±Í≥µ Ïãú Î™®Îã¨ Îã´Í∏∞
                // bootstrap.Modal.getInstance(document.getElementById('invoiceModal')).hide();
                
            } catch (error) {
                console.error('ÌôïÏ†ïÏÑú Î∞úÏÜ° Ïò§Î•ò:', error);
                alert('ÌôïÏ†ïÏÑú Î∞úÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }
        
        function previewConfirmation() {
            if (!currentConfirmationId) {
                alert('ÏòàÏïΩ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const url = `/api/package-reservations/${currentConfirmationId}/confirmation/view`;
            window.open(url, '_blank');
        }
        
        async function generateConfirmation() {
            if (!currentConfirmationId) {
                alert('ÏòàÏïΩ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            if (!confirm('ÌôïÏ†ïÏÑúÎ•º ÏÉùÏÑ±ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏÉùÏÑ±Îêú ÌôïÏ†ïÏÑúÎäî ÎØ∏Î¶¨Î≥¥Í∏∞ Î∞è ÎßÅÌÅ¨ Î≥µÏÇ¨Î•º ÌÜµÌï¥ Í≥†Í∞ùÏóêÍ≤å Ï†ÑÎã¨Ìï† Ïàò ÏûàÏäµÎãàÎã§.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/package-reservations/${currentConfirmationId}/confirmation`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ ÌôïÏ†ïÏÑúÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!\n\n"ÎØ∏Î¶¨Î≥¥Í∏∞" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÌôïÏù∏ÌïòÍ±∞ÎÇò\n"ÎßÅÌÅ¨ Î≥µÏÇ¨" Î≤ÑÌäºÏúºÎ°ú Í≥†Í∞ùÏóêÍ≤å Ï†ÑÎã¨Ìï† Ïàò ÏûàÏäµÎãàÎã§.');
                    // Î™®Îã¨ ÏÉàÎ°úÍ≥†Ïπ®
                    openInvoiceModal(currentConfirmationId);
                } else {
                    alert('ÌôïÏ†ïÏÑú ÏÉùÏÑ± Ïã§Ìå®: ' + result.message);
                }
            } catch (error) {
                console.error('ÌôïÏ†ïÏÑú ÏÉùÏÑ± Ïò§Î•ò:', error);
                alert('ÌôïÏ†ïÏÑú ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        // ÌôïÏ†ïÏÑú Ïù¥Î†• ÌÜ†Í∏Ä
        function toggleConfirmationHistory() {
            const historyDiv = document.getElementById('confirmation_history_list');
            if (historyDiv) {
                historyDiv.style.display = historyDiv.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // ÌôïÏ†ïÏÑú Ïù¥Î†• Î≥¥Í∏∞
        function viewConfirmationHistory(historyIndex) {
            if (!currentConfirmationId) {
                alert('ÏòàÏïΩ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const url = `/api/package-reservations/${currentConfirmationId}/confirmation/view?historyIndex=${historyIndex}`;
            window.open(url, '_blank');
        }
        
        async function copyConfirmationLink() {
            if (!currentConfirmationId) {
                alert('ÏòàÏïΩ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const url = `${window.location.origin}/api/package-reservations/${currentConfirmationId}/confirmation/view`;
            
            try {
                await navigator.clipboard.writeText(url);
                alert('ÌôïÏ†ïÏÑú ÎßÅÌÅ¨Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!\n\n' + url);
            } catch (error) {
                console.error('ÎßÅÌÅ¨ Î≥µÏÇ¨ Ïò§Î•ò:', error);
                
                // Ìè¥Î∞±: ÌÖçÏä§Ìä∏ ÏòÅÏó≠ ÏÇ¨Ïö©
                const textarea = document.createElement('textarea');
                textarea.value = url;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                
                try {
                    document.execCommand('copy');
                    alert('ÌôïÏ†ïÏÑú ÎßÅÌÅ¨Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!\n\n' + url);
                } catch (err) {
                    alert('ÎßÅÌÅ¨ Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÏàòÎèôÏúºÎ°ú Î≥µÏÇ¨Ìï¥Ï£ºÏÑ∏Ïöî:\n\n' + url);
                }
                
                document.body.removeChild(textarea);
            }
        }

        // Ï†ïÏÇ∞Í¥ÄÎ¶¨ Î™®Îã¨ Ïó¥Í∏∞
        async function openSettlementModal(id) {
            try {
                const response = await fetch(`/api/package-reservations/${id}`);
                const result = await response.json();
                
                if (!result.success) {
                    alert('ÏòàÏïΩ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                    return;
                }
                
                const r = result.data;
                
                // Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏÑ§Ï†ï
                document.getElementById('settlement_reservation_id').value = r._id;
                document.getElementById('settle_departure_date').textContent = new Date(r.travel_period.departure_date).toLocaleDateString('ko-KR');
                document.getElementById('settle_platform_name').textContent = r.platform_name;
                document.getElementById('settle_reservation_number').textContent = r.reservation_number;
                document.getElementById('settle_customer_name').textContent = r.customer.korean_name;
                
                // Ï¥ù Î∞õÏïÑÏïº Ìï† Í∏àÏï° (ÏÉÅÌíàÏ¥ùÏï° + Î≥ÄÎèôÏï°)
                const totalSellingPrice = r.pricing.total_selling_price || 0;
                const adjustments = (r.pricing.adjustments || []).reduce((sum, adj) => sum + (adj.amount || 0), 0);
                const totalAmount = totalSellingPrice + adjustments;
                document.getElementById('settle_total_amount').textContent = `‚Ç©${totalAmount.toLocaleString()}`;
                
                // ÏûÖÍ∏à ÎÇ¥Ïó≠ Î†åÎçîÎßÅ
                renderSettlementBillings(r.billings || [], totalAmount);
                
                // Î™®Îã¨ ÌëúÏãú
                const modal = new bootstrap.Modal(document.getElementById('settlementModal'));
                modal.show();
                
            } catch (error) {
                console.error('Ï†ïÏÇ∞Í¥ÄÎ¶¨ Î™®Îã¨ Ïó¥Í∏∞ Ïã§Ìå®:', error);
                alert('Ï†ïÏÇ∞Í¥ÄÎ¶¨ Î™®Îã¨ÏùÑ Ïó¨Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        // ÏûÖÍ∏à ÎÇ¥Ïó≠ Î†åÎçîÎßÅ
        function renderSettlementBillings(billings, totalAmount) {
            const container = document.getElementById('settle_billings_list');
            container.innerHTML = '';
            
            let receivedAmount = 0;
            
            if (billings.length === 0) {
                container.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Îì±Î°ùÎêú Í≤∞Ï†ú ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</td></tr>';
            } else {
                billings.forEach((billing, index) => {
                    const typeIcon = billing.type === 'cash' ? 'üíµ' : billing.type === 'card' ? 'üí≥' : 'üéÅ';
                    const typeName = billing.type === 'cash' ? 'ÌòÑÍ∏à' : billing.type === 'card' ? 'Ïπ¥Îìú' : 'Ìï†Ïù∏';
                    const statusBadge = billing.status === 'completed' 
                        ? '<span class="badge bg-success">ÏûÖÍ∏àÏôÑÎ£å</span>' 
                        : '<span class="badge bg-warning">ÏûÖÍ∏àÏ†Ñ</span>';
                    const dateStr = billing.date ? new Date(billing.date).toLocaleDateString('ko-KR') : '-';
                    
                    if (billing.status === 'completed') {
                        receivedAmount += billing.amount || 0;
                    }
                    
                    const row = `
                        <tr>
                            <td>${typeIcon} ${typeName}</td>
                            <td class="text-end">‚Ç©${(billing.amount || 0).toLocaleString()}</td>
                            <td>
                                <input type="date" class="form-control form-control-sm" 
                                       value="${billing.date ? new Date(billing.date).toISOString().split('T')[0] : ''}" 
                                       onchange="updateBillingDate(${index}, this.value)">
                            </td>
                            <td>${statusBadge}</td>
                            <td><small>${billing.notes || '-'}</small></td>
                            <td>
                                ${billing.status === 'pending' 
                                    ? `<button class="btn btn-sm btn-success" onclick="completeBillingPayment(${index})">
                                        <i class="fas fa-check"></i> ÏôÑÎ£å
                                       </button>` 
                                    : `<button class="btn btn-sm btn-secondary" onclick="revertBillingPayment(${index})">
                                        <i class="fas fa-undo"></i> Ï∑®ÏÜå
                                       </button>`}
                            </td>
                        </tr>
                    `;
                    container.insertAdjacentHTML('beforeend', row);
                });
            }
            
            const pendingAmount = totalAmount - receivedAmount;
            document.getElementById('settle_received_amount').textContent = `‚Ç©${receivedAmount.toLocaleString()}`;
            document.getElementById('settle_pending_amount').textContent = `‚Ç©${pendingAmount.toLocaleString()}`;
            
            // ÏûÖÍ∏àÏù¥ Î™®Îëê ÏôÑÎ£åÎêòÏóàÎäîÏßÄ ÌôïÏù∏
            const sendBtn = document.getElementById('send_to_settlement_btn');
            if (pendingAmount === 0 && totalAmount > 0) {
                sendBtn.style.display = 'inline-block';
            } else {
                sendBtn.style.display = 'none';
            }
        }
        
        
        // ÏûÖÍ∏à ÎÇ†Ïßú ÏóÖÎç∞Ïù¥Ìä∏
        function updateBillingDate(index, date) {
            console.log(`ÏûÖÍ∏à ÎÇ†Ïßú ÏóÖÎç∞Ïù¥Ìä∏: ${index}, ${date}`);
        }
        
        // ÏûÖÍ∏à ÏôÑÎ£å Ï≤òÎ¶¨
        async function completeBillingPayment(index) {
            if (!confirm('ÏûÖÍ∏à ÏôÑÎ£å Ï≤òÎ¶¨ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            try {
                const reservationId = document.getElementById('settlement_reservation_id').value;
                const response = await fetch(`/api/package-reservations/${reservationId}`);
                const result = await response.json();
                
                if (!result.success) {
                    alert('ÏòàÏïΩ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                    return;
                }
                
                const reservation = result.data;
                reservation.billings[index].status = 'completed';
                
                const updateResponse = await fetch(`/api/package-reservations/${reservationId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ billings: reservation.billings })
                });
                
                const updateResult = await updateResponse.json();
                
                if (updateResult.success) {
                    alert('ÏûÖÍ∏à ÏôÑÎ£å Ï≤òÎ¶¨ÎêòÏóàÏäµÎãàÎã§.');
                    openSettlementModal(reservationId);
                } else {
                    alert('ÏûÖÍ∏à ÏôÑÎ£å Ï≤òÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('ÏûÖÍ∏à ÏôÑÎ£å Ï≤òÎ¶¨ Ïã§Ìå®:', error);
                alert('ÏûÖÍ∏à ÏôÑÎ£å Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        // ÏûÖÍ∏à ÏôÑÎ£å Ï∑®ÏÜå
        async function revertBillingPayment(index) {
            if (!confirm('ÏûÖÍ∏à ÏôÑÎ£åÎ•º Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            try {
                const reservationId = document.getElementById('settlement_reservation_id').value;
                const response = await fetch(`/api/package-reservations/${reservationId}`);
                const result = await response.json();
                
                if (!result.success) {
                    alert('ÏòàÏïΩ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                    return;
                }
                
                const reservation = result.data;
                reservation.billings[index].status = 'pending';
                
                const updateResponse = await fetch(`/api/package-reservations/${reservationId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ billings: reservation.billings })
                });
                
                const updateResult = await updateResponse.json();
                
                if (updateResult.success) {
                    alert('ÏûÖÍ∏à ÏôÑÎ£åÍ∞Ä Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.');
                    openSettlementModal(reservationId);
                } else {
                    alert('ÏûÖÍ∏à ÏôÑÎ£å Ï∑®ÏÜåÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('ÏûÖÍ∏à ÏôÑÎ£å Ï∑®ÏÜå Ïã§Ìå®:', error);
                alert('ÏûÖÍ∏à ÏôÑÎ£å Ï∑®ÏÜå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        // Ï†ïÏÇ∞Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄÎ°ú Ï†ÑÏÜ°
        async function sendToSettlementPage() {
            const reservationId = document.getElementById('settlement_reservation_id').value;
            
            if (!confirm('ÏûÖÍ∏àÏù¥ ÏôÑÎ£åÎêú Ïù¥ ÏòàÏïΩÏùÑ Ï†ïÏÇ∞Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄÎ°ú Ï†ÑÏÜ°ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            try {
                // TODO: Ï†ïÏÇ∞Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄ API Íµ¨ÌòÑ ÌõÑ Ïã§Ï†ú Ï†ÑÏÜ° Î°úÏßÅ Ï∂îÍ∞Ä
                alert('Ï†ïÏÇ∞Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄÍ∞Ä ÏïÑÏßÅ Íµ¨ÌòÑÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.\n\nÎã§Ïùå Îã®Í≥ÑÏóêÏÑú Ï†ïÏÇ∞Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄÎ•º ÎßåÎì§Í≥† Ïó∞ÎèôÌïòÍ≤†ÏäµÎãàÎã§.');
                
                // ÏûÑÏãú: Î™®Îã¨ Îã´Í∏∞
                const modal = bootstrap.Modal.getInstance(document.getElementById('settlementModal'));
                modal.hide();
                
            } catch (error) {
                console.error('Ï†ïÏÇ∞Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄ Ï†ÑÏÜ° Ïã§Ìå®:', error);
                alert('Ï†ïÏÇ∞Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄÎ°ú Ï†ÑÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïã§Ìñâ
        window.addEventListener('load', () => {
            loadReservations();
        });
    </script>
</body>
</html>
