<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒ¨í‚¤ì§€ ì˜ˆì•½ ê´€ë¦¬ - ê´Œì„¸ì´ë¸Œì¹´ë“œ ê´€ë¦¬ì</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-confirmed { background-color: #d4edda; color: #155724; }
        .status-cancelled { background-color: #f8d7da; color: #721c24; }
        .action-icons .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .component-icons {
            font-size: 1.2rem;
        }
        .margin-positive { color: #198754; font-weight: bold; }
        .margin-negative { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <%- include('../partials/navbar', { currentPage: 'package-reservations', adminUsername: adminUsername || 'ê´€ë¦¬ì' }) %>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-box-open me-2"></i>íŒ¨í‚¤ì§€ ì˜ˆì•½ ê´€ë¦¬</h2>
                    <a href="/admin/package-inbox" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>ìƒˆ íŒ¨í‚¤ì§€ ì˜ˆì•½ ë“±ë¡
                    </a>
                </div>

                <!-- í•„í„° -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-md-2">
                                <label class="form-label">ë‚ ì§œ ê¸°ì¤€</label>
                                <select class="form-select" id="dateTypeFilter">
                                    <option value="departure">ì¶œë°œì¼</option>
                                    <option value="created">ì˜ˆì•½ì¼</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">ì‹œì‘ì¼</label>
                                <input type="date" class="form-control" id="startDateFilter">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">ì¢…ë£Œì¼</label>
                                <input type="date" class="form-control" id="endDateFilter">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">ì˜ˆì•½ ì±„ë„</label>
                                <select class="form-select" id="platformFilter">
                                    <option value="">ì „ì²´</option>
                                    <option value="VASCO">VASCO</option>
                                    <option value="NOL">NOL</option>
                                    <option value="ë¡±í˜¼ìŠ¤í…Œì´í¬">ë¡±í˜¼ìŠ¤í…Œì´í¬</option>
                                    <option value="ì§ì ‘ì˜ˆì•½">ì§ì ‘ì˜ˆì•½</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">ìƒíƒœ</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="all">ì „ì²´</option>
                                    <option value="pending">ëŒ€ê¸°</option>
                                    <option value="confirmed">í™•ì •</option>
                                    <option value="cancelled">ì·¨ì†Œ</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">ê²€ìƒ‰</label>
                                <input type="text" class="form-control" id="searchInput" 
                                       placeholder="ì˜ˆì•½ë²ˆí˜¸, ê³ ê°ëª…">
                            </div>
                        </div>
                        <div class="row g-2">
                            <div class="col-md-12 text-end">
                                <button class="btn btn-primary" onclick="loadReservations()">
                                    <i class="fas fa-search me-1"></i>ê²€ìƒ‰í•˜ê¸°
                                </button>
                                <button class="btn btn-outline-secondary" onclick="resetFilters()">
                                    <i class="fas fa-redo me-1"></i>ì´ˆê¸°í™”
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- í†µê³„ -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="text-muted">ì´ ì˜ˆì•½</h6>
                                <h3 id="stat-total">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="text-muted">ì´ ê±°ë˜ì•¡</h6>
                                <h3 id="stat-revenue">â‚©0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="text-muted">ì´ ë§¤ì…ì•¡</h6>
                                <h3 id="stat-cost">â‚©0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="text-muted">ì´ ë§ˆì§„</h6>
                                <h3 id="stat-margin" class="margin-positive">â‚©0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì˜ˆì•½ ëª©ë¡ -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ì¶œë°œì¼</th>
                                        <th>ì˜ˆì•½ì¼</th>
                                        <th>ì˜ˆì•½ì±„ë„</th>
                                        <th>ìƒí’ˆëª…</th>
                                        <th>ê³ ê°ëª…</th>
                                        <th>ì—¬í–‰ê¸°ê°„</th>
                                        <th>ì¸ì›</th>
                                        <th>êµ¬ì„±ìš”ì†Œ</th>
                                        <th>ìƒíƒœ</th>
                                        <th>ê´€ë¦¬</th>
                                    </tr>
                                </thead>
                                <tbody id="reservations-tbody">
                                    <tr>
                                        <td colspan="10" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ìƒì„¸ ëª¨ë‹¬ -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">íŒ¨í‚¤ì§€ ì˜ˆì•½ ìƒì„¸</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modal-body-content">
                    <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    <a href="#" id="edit-link" class="btn btn-primary">ìˆ˜ì •</a>
                </div>
            </div>
        </div>
    </div>

    <!-- ì˜ˆì•½ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>íŒ¨í‚¤ì§€ ì˜ˆì•½ ìˆ˜ì •</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <form id="editForm">
                        <input type="hidden" id="edit_reservation_id">
                        
                        <!-- ê¸°ë³¸ ì •ë³´ -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>ê¸°ë³¸ ì •ë³´</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">ì˜ˆì•½ë²ˆí˜¸</label>
                                        <input type="text" class="form-control" id="edit_reservation_number" readonly>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">ì˜ˆì•½ ìƒíƒœ <span class="text-danger">*</span></label>
                                        <select class="form-select" id="edit_reservation_status" required>
                                            <option value="pending">ëŒ€ê¸°</option>
                                            <option value="confirmed">í™•ì •</option>
                                            <option value="cancelled">ì·¨ì†Œ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">ì˜ˆì•½ ì±„ë„ <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="edit_platform_name" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">íŒ¨í‚¤ì§€ëª… <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="edit_package_name" required>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ê³ ê° ì •ë³´ -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-user me-2"></i>ê³ ê° ì •ë³´</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">í•œê¸€ ì´ë¦„ <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="edit_customer_korean_name" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">ì˜ë¬¸ ì´ë¦„</label>
                                        <input type="text" class="form-control" id="edit_customer_english_name">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">ì „í™”ë²ˆí˜¸</label>
                                        <input type="tel" class="form-control" id="edit_customer_phone">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">ì´ë©”ì¼</label>
                                        <input type="email" class="form-control" id="edit_customer_email">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ì—¬í–‰ ê¸°ê°„ -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-calendar me-2"></i>ì—¬í–‰ ê¸°ê°„</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">ì¶œë°œì¼ <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" id="edit_departure_date" required onchange="calculateEditNights()">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">ê·€êµ­ì¼ <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" id="edit_return_date" required onchange="calculateEditNights()">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">ë°•ìˆ˜</label>
                                        <input type="number" class="form-control" id="edit_nights" readonly>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">ì¼ìˆ˜</label>
                                        <input type="number" class="form-control" id="edit_days" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ì¸ì› ì •ë³´ -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-users me-2"></i>ì¸ì› ì •ë³´</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">ì„±ì¸ <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control" id="edit_people_adult" min="0" value="0" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">ì†Œì•„</label>
                                        <input type="number" class="form-control" id="edit_people_child" min="0" value="0">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">ìœ ì•„</label>
                                        <input type="number" class="form-control" id="edit_people_infant" min="0" value="0">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- í•­ê³µí¸ ì •ë³´ -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-plane me-2"></i>í•­ê³µí¸ ì •ë³´</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-2 mb-2">
                                    <div class="col-md-2">
                                        <label class="form-label">ì¶œêµ­í¸ëª…</label>
                                        <input type="text" class="form-control form-control-sm" id="edit_outbound_flight" placeholder="OZ601">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">ì¶œë°œì‹œê°„</label>
                                        <input type="time" class="form-control form-control-sm" id="edit_outbound_departure_time">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">ë„ì°©ì‹œê°„</label>
                                        <input type="time" class="form-control form-control-sm" id="edit_outbound_arrival_time">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">ì…êµ­í¸ëª…</label>
                                        <input type="text" class="form-control form-control-sm" id="edit_inbound_flight" placeholder="OZ602">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">ì¶œë°œì‹œê°„</label>
                                        <input type="time" class="form-control form-control-sm" id="edit_inbound_departure_time">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">ë„ì°©ì‹œê°„</label>
                                        <input type="time" class="form-control form-control-sm" id="edit_inbound_arrival_time">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- í˜¸í…” ì •ë³´ -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-hotel me-2"></i>í˜¸í…” ì •ë³´</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <label class="form-label">í˜¸í…”ëª…</label>
                                        <input type="text" class="form-control form-control-sm" id="edit_hotel_name" placeholder="í˜¸í…”ëª…">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">ë£¸íƒ€ì…</label>
                                        <input type="text" class="form-control form-control-sm" id="edit_room_type" placeholder="ë””ëŸ­ìŠ¤ ì˜¤ì…˜ë·°">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ì¼ì • ë° í¬í•¨/ë¶ˆí¬í•¨ -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-list me-2"></i>ì¼ì • ë° í¬í•¨/ë¶ˆí¬í•¨ ì‚¬í•­</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <label class="form-label">ì¼ì •</label>
                                        <textarea class="form-control form-control-sm" id="edit_itinerary" rows="3"></textarea>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">í¬í•¨ì‚¬í•­</label>
                                        <textarea class="form-control form-control-sm" id="edit_inclusions" rows="1"></textarea>
                                        <label class="form-label mt-2">ë¶ˆí¬í•¨ì‚¬í•­</label>
                                        <textarea class="form-control form-control-sm" id="edit_exclusions" rows="1"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- íˆ¬ìˆ™ê° ì •ë³´ -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-users me-2"></i>íˆ¬ìˆ™ê° ì •ë³´</h6>
                            </div>
                            <div class="card-body">
                                <div id="edit_guests_container"></div>
                            </div>
                        </div>

                        <!-- ê¸ˆì•¡ ì •ë³´ -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>ê¸ˆì•¡ ì •ë³´</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-2 mb-3">
                                    <div class="col-md-2">
                                        <label class="form-label">í†µí™”</label>
                                        <select class="form-select form-select-sm" id="edit_currency">
                                            <option value="KRW">KRW</option>
                                            <option value="USD">USD</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">í™˜ìœ¨</label>
                                        <input type="text" class="form-control form-control-sm" id="edit_exchange_rate" value="1,300">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">ì„±ì¸ 1ì¸</label>
                                        <input type="text" class="form-control form-control-sm" id="edit_price_adult" placeholder="500,000">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">ì†Œì•„ 1ì¸</label>
                                        <input type="text" class="form-control form-control-sm" id="edit_price_child" placeholder="400,000">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">ìœ ì•„ 1ì¸</label>
                                        <input type="text" class="form-control form-control-sm" id="edit_price_infant" placeholder="100,000">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">ì´ íŒë§¤ê°€</label>
                                        <input type="text" class="form-control form-control-sm" id="edit_total_selling_price" readonly style="background-color: #e9ecef; font-weight: bold;">
                                    </div>
                                </div>

                                <h6 class="mb-2">ê²°ì œ ë¹Œë§</h6>
                                <div id="edit_billings_container"></div>
                                <button type="button" class="btn btn-sm btn-outline-success mb-3" onclick="addEditBilling()">
                                    <i class="fas fa-plus me-1"></i>ê²°ì œ ì¶”ê°€
                                </button>

                                <h6 class="mb-2">ë§¤ì… êµ¬ì„±ìš”ì†Œ</h6>
                                <div id="edit_components_container"></div>
                                <button type="button" class="btn btn-sm btn-outline-primary mb-3" onclick="addEditComponent()">
                                    <i class="fas fa-plus me-1"></i>êµ¬ì„±ìš”ì†Œ ì¶”ê°€
                                </button>
                            </div>
                        </div>

                        <!-- íŠ¹ë³„ ìš”ì²­ì‚¬í•­ -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-comment me-2"></i>íŠ¹ë³„ ìš”ì²­ì‚¬í•­</h6>
                            </div>
                            <div class="card-body">
                                <textarea class="form-control" id="edit_special_requests" rows="2"></textarea>
                            </div>
                        </div>

                        <!-- ìˆ˜ì • ì´ë ¥ -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-history me-2"></i>ìˆ˜ì • ì´ë ¥</h6>
                            </div>
                            <div class="card-body">
                                <div id="modification_history_container" style="max-height: 200px; overflow-y: auto;">
                                    <p class="text-muted mb-0">ìˆ˜ì • ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>ì·¨ì†Œ
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveReservationEdit()">
                        <i class="fas fa-save me-1"></i>ì €ì¥
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allReservations = [];

        // ì˜ˆì•½ ëª©ë¡ ë¡œë“œ
        async function loadReservations() {
            try {
                const dateType = document.getElementById('dateTypeFilter').value;
                const startDate = document.getElementById('startDateFilter').value;
                const endDate = document.getElementById('endDateFilter').value;
                const status = document.getElementById('statusFilter').value;
                const platform = document.getElementById('platformFilter').value;
                const search = document.getElementById('searchInput').value;

                const params = new URLSearchParams();
                if (dateType && startDate && endDate) {
                    params.append('dateType', dateType);
                    params.append('startDate', startDate);
                    params.append('endDate', endDate);
                }
                if (status !== 'all') params.append('status', status);
                if (platform) params.append('platform', platform);
                if (search) params.append('search', search);

                const response = await fetch(`/api/package-reservations?${params}`);
                const result = await response.json();

                if (result.success) {
                    allReservations = result.data;
                    renderReservations(result.data);
                    updateStats(result.data);
                } else {
                    alert('ì˜ˆì•½ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                console.error('ì˜ˆì•½ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('reservations-tbody').innerHTML = `
                    <tr><td colspan="10" class="text-center text-danger">
                        ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}
                    </td></tr>
                `;
            }
        }

        // ì˜ˆì•½ ëª©ë¡ ë Œë”ë§
        function renderReservations(reservations) {
            const tbody = document.getElementById('reservations-tbody');

            if (reservations.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="10" class="text-center text-muted">
                        ë“±ë¡ëœ íŒ¨í‚¤ì§€ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.
                    </td></tr>
                `;
                return;
            }

            tbody.innerHTML = reservations.map(r => {
                const departureDate = new Date(r.travel_period.departure_date).toLocaleDateString('ko-KR', {year: 'numeric', month: '2-digit', day: '2-digit'}).replace(/\. /g, '-').replace('.', '');
                const returnDate = new Date(r.travel_period.return_date).toLocaleDateString('ko-KR', {year: 'numeric', month: '2-digit', day: '2-digit'}).replace(/\. /g, '-').replace('.', '');
                const createdDate = new Date(r.createdAt).toLocaleDateString('ko-KR', {year: 'numeric', month: '2-digit', day: '2-digit'}).replace(/\. /g, '-').replace('.', '');
                
                const period = `${r.travel_period.nights}ë°•${r.travel_period.days}ì¼`;
                const people = `ì„±ì¸${r.people.adult}${r.people.child > 0 ? `/ì†Œì•„${r.people.child}` : ''}${r.people.infant > 0 ? `/ìœ ì•„${r.people.infant}` : ''}`;

                const componentIcons = r.cost_components.map(c => {
                    const icons = {
                        flight: 'âœˆï¸',
                        ground: 'ğŸš—',
                        hotel: 'ğŸ¨',
                        tour: 'ğŸ¯',
                        other: 'ğŸ“¦'
                    };
                    return icons[c.component_type] || 'ğŸ“¦';
                }).join(' ');

                const reservationStatus = r.reservation_status || 'pending';
                const statusClass = `status-${reservationStatus}`;
                const statusText = {
                    pending: 'ëŒ€ê¸°',
                    confirmed: 'í™•ì •',
                    cancelled: 'ì·¨ì†Œ'
                }[reservationStatus] || reservationStatus;

                return `
                    <tr>
                        <td><small>${departureDate}</small></td>
                        <td><small>${createdDate}</small></td>
                        <td><small>${r.platform_name}</small></td>
                        <td>${r.package_name}</td>
                        <td>${r.customer.korean_name}</td>
                        <td><small>${period}</small></td>
                        <td><small>${people}</small></td>
                        <td class="component-icons">${componentIcons}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td class="action-icons">
                            <button class="btn btn-sm btn-outline-primary" onclick="openEditModal('${r._id}')" title="ì˜ˆì•½ìˆ˜ì •">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="openAssignmentModal('${r._id}')" title="ìˆ˜ë°°ì„œ">
                                <i class="fas fa-file-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="openInvoiceModal('${r._id}')" title="í™•ì •ì„œ">
                                <i class="fas fa-file-invoice"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="openSettlementModal('${r._id}')" title="ì •ì‚°ê´€ë¦¬">
                                <i class="fas fa-calculator"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats(reservations) {
            const total = reservations.length;
            const totalRevenue = reservations.reduce((sum, r) => sum + r.settlement.total_revenue_krw, 0);
            const totalCost = reservations.reduce((sum, r) => sum + r.settlement.total_cost_krw, 0);
            const totalMargin = reservations.reduce((sum, r) => sum + r.settlement.total_margin_krw, 0);

            document.getElementById('stat-total').textContent = `${total}ê±´`;
            document.getElementById('stat-revenue').textContent = `â‚©${totalRevenue.toLocaleString()}`;
            document.getElementById('stat-cost').textContent = `â‚©${totalCost.toLocaleString()}`;
            document.getElementById('stat-margin').textContent = `â‚©${totalMargin.toLocaleString()}`;
            document.getElementById('stat-margin').className = totalMargin >= 0 ? 'margin-positive' : 'margin-negative';
        }

        // ìƒì„¸ ë³´ê¸°
        async function showDetail(id) {
            try {
                const response = await fetch(`/api/package-reservations/${id}`);
                const result = await response.json();

                if (result.success) {
                    const r = result.data;
                    const departureDate = new Date(r.travel_period.departure_date).toLocaleDateString('ko-KR');
                    const returnDate = new Date(r.travel_period.return_date).toLocaleDateString('ko-KR');

                    const componentsHTML = r.cost_components.map(c => {
                        const typeNames = {
                            flight: 'âœˆï¸ í•­ê³µê¶Œ',
                            hotel: 'ğŸ¨ í˜¸í…”',
                            tour: 'ğŸ¯ íˆ¬ì–´',
                            other: 'ğŸ“¦ ê¸°íƒ€'
                        };
                        return `
                            <tr>
                                <td>${typeNames[c.component_type]}</td>
                                <td>${c.vendor_name}</td>
                                <td>${c.cost_currency === 'KRW' ? 'â‚©' : '$'}${c.cost_amount.toLocaleString()}</td>
                                <td>â‚©${c.cost_krw.toLocaleString()}</td>
                                <td>${c.notes || '-'}</td>
                            </tr>
                        `;
                    }).join('');

                    document.getElementById('modal-body-content').innerHTML = `
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>ì˜ˆì•½ë²ˆí˜¸</h6>
                                <p><strong>${r.reservation_number}</strong></p>
                            </div>
                            <div class="col-md-6">
                                <h6>ì˜ˆì•½ ì±„ë„</h6>
                                <p>${r.platform_name}</p>
                            </div>
                        </div>
                        <div class="mb-3">
                            <h6>íŒ¨í‚¤ì§€ëª…</h6>
                            <p>${r.package_name}</p>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>ê³ ê° ì •ë³´</h6>
                                <p>
                                    ${r.customer.korean_name} (${r.customer.english_name || '-'})<br>
                                    ${r.customer.phone || '-'}<br>
                                    ${r.customer.email || '-'}
                                </p>
                            </div>
                            <div class="col-md-6">
                                <h6>ì—¬í–‰ ê¸°ê°„</h6>
                                <p>
                                    ${departureDate} ~ ${returnDate}<br>
                                    ${r.travel_period.nights}ë°•${r.travel_period.days}ì¼
                                </p>
                            </div>
                        </div>
                        <div class="mb-3">
                            <h6>ì¸ì›</h6>
                            <p>ì„±ì¸ ${r.people.adult}ëª…, ì†Œì•„ ${r.people.child}ëª…, ìœ ì•„ ${r.people.infant}ëª…</p>
                        </div>
                        <div class="mb-3">
                            <h6>êµ¬ì„±ìš”ì†Œ</h6>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>íƒ€ì…</th>
                                        <th>ê³µê¸‰ì—…ì²´</th>
                                        <th>ë§¤ì…ê°€</th>
                                        <th>ì›í™”í™˜ì‚°</th>
                                        <th>ë¹„ê³ </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${componentsHTML}
                                </tbody>
                            </table>
                        </div>
                        <div class="mb-3">
                            <h6>ì •ì‚° ì •ë³´</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td>ì´ ê±°ë˜ì•¡</td>
                                    <td class="text-end"><strong>â‚©${r.settlement.total_revenue_krw.toLocaleString()}</strong></td>
                                </tr>
                                <tr>
                                    <td>ì´ ë§¤ì…ì•¡</td>
                                    <td class="text-end">â‚©${r.settlement.total_cost_krw.toLocaleString()}</td>
                                </tr>
                                <tr class="table-primary">
                                    <td><strong>ë§ˆì§„</strong></td>
                                    <td class="text-end ${r.settlement.total_margin_krw >= 0 ? 'margin-positive' : 'margin-negative'}">
                                        <strong>â‚©${r.settlement.total_margin_krw.toLocaleString()} (${r.settlement.margin_rate}%)</strong>
                                    </td>
                                </tr>
                                <tr>
                                    <td>ë¶€ê°€ì„¸</td>
                                    <td class="text-end">â‚©${r.settlement.vat_amount.toLocaleString()}</td>
                                </tr>
                            </table>
                        </div>
                        ${r.special_requests ? `
                            <div class="mb-3">
                                <h6>íŠ¹ë³„ ìš”ì²­ì‚¬í•­</h6>
                                <p>${r.special_requests}</p>
                            </div>
                        ` : ''}
                    `;

                    document.getElementById('edit-link').href = `/admin/package-inbox?id=${id}`;

                    new bootstrap.Modal(document.getElementById('detailModal')).show();
                } else {
                    alert('ìƒì„¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                console.error('ìƒì„¸ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ìƒì„¸ ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê²€ìƒ‰
        function handleSearch(event) {
            if (event.key === 'Enter') {
                loadReservations();
            }
        }

        // í•„í„° ì´ˆê¸°í™”
        function resetFilters() {
            document.getElementById('dateTypeFilter').value = 'departure';
            document.getElementById('startDateFilter').value = '';
            document.getElementById('endDateFilter').value = '';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('platformFilter').value = '';
            document.getElementById('searchInput').value = '';
            loadReservations();
        }

        // ì˜ˆì•½ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
        let editComponentCount = 0;
        let editBillingCount = 0;
        
        async function openEditModal(id) {
            try {
                const response = await fetch(`/api/package-reservations/${id}`);
                const result = await response.json();

                if (result.success) {
                    const r = result.data;
                    
                    // ê¸°ë³¸ ì •ë³´
                    document.getElementById('edit_reservation_id').value = r._id;
                    document.getElementById('edit_reservation_number').value = r.reservation_number;
                    document.getElementById('edit_reservation_status').value = r.reservation_status || 'pending';
                    document.getElementById('edit_platform_name').value = r.platform_name;
                    document.getElementById('edit_package_name').value = r.package_name;
                    
                    // ê³ ê° ì •ë³´
                    document.getElementById('edit_customer_korean_name').value = r.customer.korean_name;
                    document.getElementById('edit_customer_english_name').value = r.customer.english_name || '';
                    document.getElementById('edit_customer_phone').value = r.customer.phone || '';
                    document.getElementById('edit_customer_email').value = r.customer.email || '';
                    
                    // ì—¬í–‰ ê¸°ê°„
                    document.getElementById('edit_departure_date').value = r.travel_period.departure_date.split('T')[0];
                    document.getElementById('edit_return_date').value = r.travel_period.return_date.split('T')[0];
                    document.getElementById('edit_nights').value = r.travel_period.nights;
                    document.getElementById('edit_days').value = r.travel_period.days;
                    
                    // ì¸ì› ì •ë³´
                    document.getElementById('edit_people_adult').value = r.people.adult;
                    document.getElementById('edit_people_child').value = r.people.child;
                    document.getElementById('edit_people_infant').value = r.people.infant;
                    
                    // í•­ê³µí¸ ì •ë³´
                    if (r.flight_info) {
                        document.getElementById('edit_outbound_flight').value = r.flight_info.outbound_flight || '';
                        document.getElementById('edit_outbound_departure_time').value = r.flight_info.outbound_departure_time || '';
                        document.getElementById('edit_outbound_arrival_time').value = r.flight_info.outbound_arrival_time || '';
                        document.getElementById('edit_inbound_flight').value = r.flight_info.inbound_flight || '';
                        document.getElementById('edit_inbound_departure_time').value = r.flight_info.inbound_departure_time || '';
                        document.getElementById('edit_inbound_arrival_time').value = r.flight_info.inbound_arrival_time || '';
                    }
                    
                    // í˜¸í…” ì •ë³´
                    document.getElementById('edit_hotel_name').value = r.hotel_name || '';
                    document.getElementById('edit_room_type').value = r.room_type || '';
                    
                    // ì¼ì • ë° í¬í•¨/ë¶ˆí¬í•¨
                    document.getElementById('edit_itinerary').value = r.itinerary || '';
                    document.getElementById('edit_inclusions').value = r.inclusions || '';
                    document.getElementById('edit_exclusions').value = r.exclusions || '';
                    
                    // íˆ¬ìˆ™ê° ì •ë³´
                    renderEditGuests(r.guests || []);
                    
                    // ê¸ˆì•¡ ì •ë³´
                    if (r.pricing) {
                        document.getElementById('edit_currency').value = r.pricing.currency || 'KRW';
                        document.getElementById('edit_exchange_rate').value = (r.pricing.exchange_rate || 1300).toLocaleString();
                        document.getElementById('edit_price_adult').value = (r.pricing.price_adult || 0).toLocaleString();
                        document.getElementById('edit_price_child').value = (r.pricing.price_child || 0).toLocaleString();
                        document.getElementById('edit_price_infant').value = (r.pricing.price_infant || 0).toLocaleString();
                        document.getElementById('edit_total_selling_price').value = (r.pricing.total_selling_price || 0).toLocaleString();
                    }
                    
                    // ê²°ì œ ë¹Œë§
                    renderEditBillings(r.billings || []);
                    
                    // ë§¤ì… êµ¬ì„±ìš”ì†Œ
                    renderEditComponents(r.cost_components || []);
                    
                    // íŠ¹ë³„ ìš”ì²­ì‚¬í•­
                    document.getElementById('edit_special_requests').value = r.special_requests || '';
                    
                    // ìˆ˜ì • ì´ë ¥
                    renderModificationHistory(r.modification_history || []);
                    
                    // ëª¨ë‹¬ ì—´ê¸°
                    new bootstrap.Modal(document.getElementById('editModal')).show();
                } else {
                    alert('ì˜ˆì•½ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                console.error('ì˜ˆì•½ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì˜ˆì•½ ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // íˆ¬ìˆ™ê° ì •ë³´ ë Œë”ë§
        function renderEditGuests(guests) {
            const container = document.getElementById('edit_guests_container');
            if (!guests || guests.length === 0) {
                container.innerHTML = '<p class="text-muted mb-0">íˆ¬ìˆ™ê° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            let html = '';
            guests.forEach((guest, index) => {
                html += `
                    <div class="card mb-2" style="background-color: #f8f9fa;">
                        <div class="card-body p-2">
                            <div class="row g-2">
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.75rem;">í•œê¸€ì´ë¦„</label>
                                    <input type="text" class="form-control form-control-sm" value="${guest.korean_name || ''}" 
                                           data-guest-index="${index}" data-field="korean_name">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.75rem;">ì˜ë¬¸ì´ë¦„</label>
                                    <input type="text" class="form-control form-control-sm" value="${guest.english_name || ''}"
                                           data-guest-index="${index}" data-field="english_name">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.75rem;">ìƒë…„ì›”ì¼</label>
                                    <input type="date" class="form-control form-control-sm" value="${guest.birth_date ? new Date(guest.birth_date).toISOString().split('T')[0] : ''}"
                                           data-guest-index="${index}" data-field="birth_date">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.75rem;">ì—°ë½ì²˜</label>
                                    <input type="text" class="form-control form-control-sm" value="${guest.phone || ''}"
                                           data-guest-index="${index}" data-field="phone">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.75rem;">ì´ë©”ì¼</label>
                                    <input type="email" class="form-control form-control-sm" value="${guest.email || ''}"
                                           data-guest-index="${index}" data-field="email">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label" style="font-size: 0.75rem;">êµ¬ë¶„</label>
                                    <input type="text" class="form-control form-control-sm" value="${guest.type || ''}" readonly>
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label" style="font-size: 0.75rem;">ì„±ë³„</label>
                                    <select class="form-select form-select-sm" data-guest-index="${index}" data-field="gender">
                                        <option value="">ì„ íƒ</option>
                                        <option value="ë‚¨ì" ${guest.gender === 'ë‚¨ì' ? 'selected' : ''}>ë‚¨ì</option>
                                        <option value="ì—¬ì" ${guest.gender === 'ì—¬ì' ? 'selected' : ''}>ì—¬ì</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        // ê²°ì œ ë¹Œë§ ë Œë”ë§
        function renderEditBillings(billings) {
            const container = document.getElementById('edit_billings_container');
            container.innerHTML = '';
            editBillingCount = 0;
            
            if (billings && billings.length > 0) {
                billings.forEach(billing => {
                    editBillingCount++;
                    const billingHTML = `
                        <div class="card mb-2" id="edit_billing_${editBillingCount}" style="background-color: #f8f9fa;">
                            <div class="card-body p-2">
                                <div class="row g-2">
                                    <div class="col-md-2">
                                        <select class="form-select form-select-sm">
                                            <option value="cash" ${billing.type === 'cash' ? 'selected' : ''}>ğŸ’µ í˜„ê¸ˆ</option>
                                            <option value="card" ${billing.type === 'card' ? 'selected' : ''}>ğŸ’³ ì¹´ë“œ</option>
                                            <option value="discount" ${billing.type === 'discount' ? 'selected' : ''}>ğŸ í• ì¸</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control form-control-sm" value="${(billing.amount || 0).toLocaleString()}" placeholder="ê¸ˆì•¡">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="date" class="form-control form-control-sm" value="${billing.date ? new Date(billing.date).toISOString().split('T')[0] : ''}">
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select form-select-sm">
                                            <option value="pending" ${billing.status === 'pending' ? 'selected' : ''}>ê²°ì œì „</option>
                                            <option value="completed" ${billing.status === 'completed' ? 'selected' : ''}>ê²°ì œì™„ë£Œ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <input type="text" class="form-control form-control-sm" value="${billing.notes || ''}" placeholder="ë¹„ê³ ">
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" class="btn btn-sm btn-danger" onclick="document.getElementById('edit_billing_${editBillingCount}').remove()">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', billingHTML);
                });
            }
        }
        
        // ë§¤ì… êµ¬ì„±ìš”ì†Œ ë Œë”ë§
        function renderEditComponents(components) {
            const container = document.getElementById('edit_components_container');
            container.innerHTML = '';
            editComponentCount = 0;
            
            if (components && components.length > 0) {
                components.forEach(comp => {
                    editComponentCount++;
                    const typeIcons = {
                        flight: 'âœˆï¸ í•­ê³µê¶Œ',
                        hotel: 'ğŸ¨ í˜¸í…”',
                        tour: 'ğŸ¯ íˆ¬ì–´',
                        ground: 'ğŸš— ì§€ìƒë¹„',
                        other: 'ğŸ“¦ ê¸°íƒ€'
                    };
                    const componentHTML = `
                        <div class="card mb-2" id="edit_component_${editComponentCount}" style="background-color: #fff;">
                            <div class="card-body p-2">
                                <div class="row g-2">
                                    <div class="col-md-2">
                                        <select class="form-select form-select-sm">
                                            <option value="flight" ${comp.component_type === 'flight' ? 'selected' : ''}>âœˆï¸ í•­ê³µê¶Œ</option>
                                            <option value="hotel" ${comp.component_type === 'hotel' ? 'selected' : ''}>ğŸ¨ í˜¸í…”</option>
                                            <option value="tour" ${comp.component_type === 'tour' ? 'selected' : ''}>ğŸ¯ íˆ¬ì–´</option>
                                            <option value="ground" ${comp.component_type === 'ground' ? 'selected' : ''}>ğŸš— ì§€ìƒë¹„</option>
                                            <option value="other" ${comp.component_type === 'other' ? 'selected' : ''}>ğŸ“¦ ê¸°íƒ€</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control form-control-sm" value="${comp.vendor_name || ''}" placeholder="ê³µê¸‰ì—…ì²´">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control form-control-sm" value="${(comp.cost_amount || 0).toLocaleString()}" placeholder="ë§¤ì…ê°€">
                                    </div>
                                    <div class="col-md-1">
                                        <select class="form-select form-select-sm">
                                            <option value="KRW" ${comp.cost_currency === 'KRW' ? 'selected' : ''}>KRW</option>
                                            <option value="USD" ${comp.cost_currency === 'USD' ? 'selected' : ''}>USD</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control form-control-sm" value="${(comp.cost_krw || 0).toLocaleString()}" placeholder="ì›í™”í™˜ì‚°" readonly>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control form-control-sm" value="${comp.notes || ''}" placeholder="ë¹„ê³ ">
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" class="btn btn-sm btn-danger" onclick="document.getElementById('edit_component_${editComponentCount}').remove()">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', componentHTML);
                });
            }
        }
        
        // ìˆ˜ì • ì´ë ¥ ë Œë”ë§
        function renderModificationHistory(history) {
            const container = document.getElementById('modification_history_container');
            
            if (!history || history.length === 0) {
                container.innerHTML = '<p class="text-muted mb-0">ìˆ˜ì • ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            let html = '';
            history.reverse().forEach((entry, index) => {
                const date = new Date(entry.modified_at).toLocaleString('ko-KR');
                html += `
                    <div class="card mb-2 ${index === 0 ? 'border-primary' : ''}">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong style="font-size: 0.9rem;">
                                    <i class="fas fa-user-edit me-1"></i>${entry.modified_by}
                                </strong>
                                <small class="text-muted">${date}</small>
                            </div>
                            <div style="font-size: 0.85rem;">
                                <span class="badge bg-info">${entry.summary}</span>
                            </div>
                            <div class="mt-2" style="font-size: 0.8rem;">
                `;
                
                entry.changes.forEach(change => {
                    html += `
                        <div class="mb-1">
                            <span class="badge bg-secondary">${change.field_label}</span>
                            <span class="text-danger" style="text-decoration: line-through;">${change.old_value}</span>
                            <i class="fas fa-arrow-right mx-1"></i>
                            <span class="text-success"><strong>${change.new_value}</strong></span>
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ê²°ì œ ë¹Œë§ ì¶”ê°€
        function addEditBilling() {
            editBillingCount++;
            const container = document.getElementById('edit_billings_container');
            const billingHTML = `
                <div class="card mb-2" id="edit_billing_${editBillingCount}" style="background-color: #f8f9fa;">
                    <div class="card-body p-2">
                        <div class="row g-2">
                            <div class="col-md-2">
                                <select class="form-select form-select-sm">
                                    <option value="cash">ğŸ’µ í˜„ê¸ˆ</option>
                                    <option value="card">ğŸ’³ ì¹´ë“œ</option>
                                    <option value="discount">ğŸ í• ì¸</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control form-control-sm" placeholder="ê¸ˆì•¡">
                            </div>
                            <div class="col-md-2">
                                <input type="date" class="form-control form-control-sm">
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm">
                                    <option value="pending">ê²°ì œì „</option>
                                    <option value="completed">ê²°ì œì™„ë£Œ</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control form-control-sm" placeholder="ë¹„ê³ ">
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-sm btn-danger" onclick="document.getElementById('edit_billing_${editBillingCount}').remove()">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', billingHTML);
        }
        
        // ë§¤ì… êµ¬ì„±ìš”ì†Œ ì¶”ê°€
        function addEditComponent() {
            editComponentCount++;
            const container = document.getElementById('edit_components_container');
            const componentHTML = `
                <div class="card mb-2" id="edit_component_${editComponentCount}" style="background-color: #fff;">
                    <div class="card-body p-2">
                        <div class="row g-2">
                            <div class="col-md-2">
                                <select class="form-select form-select-sm">
                                    <option value="flight">âœˆï¸ í•­ê³µê¶Œ</option>
                                    <option value="hotel">ğŸ¨ í˜¸í…”</option>
                                    <option value="tour">ğŸ¯ íˆ¬ì–´</option>
                                    <option value="ground">ğŸš— ì§€ìƒë¹„</option>
                                    <option value="other">ğŸ“¦ ê¸°íƒ€</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control form-control-sm" placeholder="ê³µê¸‰ì—…ì²´">
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control form-control-sm" placeholder="ë§¤ì…ê°€">
                            </div>
                            <div class="col-md-1">
                                <select class="form-select form-select-sm">
                                    <option value="KRW">KRW</option>
                                    <option value="USD">USD</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control form-control-sm" placeholder="ì›í™”í™˜ì‚°" readonly>
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control form-control-sm" placeholder="ë¹„ê³ ">
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-sm btn-danger" onclick="document.getElementById('edit_component_${editComponentCount}').remove()">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', componentHTML);
        }

        // ë°•ìˆ˜/ì¼ìˆ˜ ê³„ì‚° (ìˆ˜ì • ëª¨ë‹¬)
        function calculateEditNights() {
            const departureDate = document.getElementById('edit_departure_date').value;
            const returnDate = document.getElementById('edit_return_date').value;
            
            if (departureDate && returnDate) {
                const departure = new Date(departureDate);
                const returnD = new Date(returnDate);
                const nights = Math.floor((returnD - departure) / (1000 * 60 * 60 * 24));
                const days = nights + 1;
                
                document.getElementById('edit_nights').value = nights;
                document.getElementById('edit_days').value = days;
            }
        }

        // ì˜ˆì•½ìˆ˜ì • ì €ì¥
        async function saveReservationEdit() {
            const id = document.getElementById('edit_reservation_id').value;
            
            // ìˆ«ì íŒŒì‹± í—¬í¼
            const parseNumber = (value) => {
                if (!value) return 0;
                return parseFloat(value.toString().replace(/,/g, '')) || 0;
            };
            
            // íˆ¬ìˆ™ê° ì •ë³´ ìˆ˜ì§‘
            const guests = [];
            document.querySelectorAll('#edit_guests_container [data-guest-index]').forEach(input => {
                const index = parseInt(input.dataset.guestIndex);
                const field = input.dataset.field;
                
                if (!guests[index]) {
                    guests[index] = {};
                }
                
                guests[index][field] = input.value;
            });
            
            // ê²°ì œ ë¹Œë§ ìˆ˜ì§‘
            const billings = [];
            document.querySelectorAll('#edit_billings_container .card').forEach(card => {
                const inputs = card.querySelectorAll('input, select');
                const billing = {
                    type: inputs[0].value,
                    amount: parseNumber(inputs[1].value),
                    date: inputs[2].value || null,
                    status: inputs[3].value,
                    notes: inputs[4].value
                };
                billings.push(billing);
            });
            
            // ë§¤ì… êµ¬ì„±ìš”ì†Œ ìˆ˜ì§‘
            const cost_components = [];
            document.querySelectorAll('#edit_components_container .card').forEach(card => {
                const inputs = card.querySelectorAll('input, select');
                const component = {
                    component_type: inputs[0].value,
                    vendor_name: inputs[1].value,
                    cost_amount: parseNumber(inputs[2].value),
                    cost_currency: inputs[3].value,
                    cost_krw: parseNumber(inputs[4].value),
                    notes: inputs[5].value
                };
                cost_components.push(component);
            });
            
            // í¼ ë°ì´í„° ìˆ˜ì§‘
            const data = {
                reservation_status: document.getElementById('edit_reservation_status').value,
                platform_name: document.getElementById('edit_platform_name').value,
                package_name: document.getElementById('edit_package_name').value,
                customer: {
                    korean_name: document.getElementById('edit_customer_korean_name').value,
                    english_name: document.getElementById('edit_customer_english_name').value,
                    phone: document.getElementById('edit_customer_phone').value,
                    email: document.getElementById('edit_customer_email').value
                },
                travel_period: {
                    departure_date: document.getElementById('edit_departure_date').value,
                    return_date: document.getElementById('edit_return_date').value,
                    nights: parseInt(document.getElementById('edit_nights').value),
                    days: parseInt(document.getElementById('edit_days').value)
                },
                people: {
                    adult: parseInt(document.getElementById('edit_people_adult').value),
                    child: parseInt(document.getElementById('edit_people_child').value),
                    infant: parseInt(document.getElementById('edit_people_infant').value)
                },
                flight_info: {
                    outbound_flight: document.getElementById('edit_outbound_flight').value,
                    outbound_departure_time: document.getElementById('edit_outbound_departure_time').value,
                    outbound_arrival_time: document.getElementById('edit_outbound_arrival_time').value,
                    inbound_flight: document.getElementById('edit_inbound_flight').value,
                    inbound_departure_time: document.getElementById('edit_inbound_departure_time').value,
                    inbound_arrival_time: document.getElementById('edit_inbound_arrival_time').value
                },
                hotel_name: document.getElementById('edit_hotel_name').value,
                room_type: document.getElementById('edit_room_type').value,
                itinerary: document.getElementById('edit_itinerary').value,
                inclusions: document.getElementById('edit_inclusions').value,
                exclusions: document.getElementById('edit_exclusions').value,
                guests: guests.filter(g => g && Object.keys(g).length > 0),
                pricing: {
                    currency: document.getElementById('edit_currency').value,
                    exchange_rate: parseNumber(document.getElementById('edit_exchange_rate').value),
                    price_adult: parseNumber(document.getElementById('edit_price_adult').value),
                    price_child: parseNumber(document.getElementById('edit_price_child').value),
                    price_infant: parseNumber(document.getElementById('edit_price_infant').value),
                    total_selling_price: parseNumber(document.getElementById('edit_total_selling_price').value)
                },
                billings: billings,
                cost_components: cost_components,
                special_requests: document.getElementById('edit_special_requests').value
            };

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!data.platform_name || !data.package_name || !data.customer.korean_name) {
                alert('í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch(`/api/package-reservations/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert(`ì˜ˆì•½ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\n${result.changes_count || 0}ê°œ í•„ë“œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                    loadReservations(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    alert('ì˜ˆì•½ ìˆ˜ì • ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                console.error('ì˜ˆì•½ ìˆ˜ì • ì˜¤ë¥˜:', error);
                alert('ì˜ˆì•½ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëª¨ë‹¬ í•¨ìˆ˜ë“¤ (ì¶”í›„ êµ¬í˜„)
        function openAssignmentModal(id) {
            alert('ìˆ˜ë°°ì„œ ëª¨ë‹¬ - ì¶”í›„ êµ¬í˜„ ì˜ˆì • (ID: ' + id + ')');
        }

        function openInvoiceModal(id) {
            alert('í™•ì •ì„œ ëª¨ë‹¬ - ì¶”í›„ êµ¬í˜„ ì˜ˆì • (ID: ' + id + ')');
        }

        function openSettlementModal(id) {
            alert('ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬ - ì¶”í›„ êµ¬í˜„ ì˜ˆì • (ID: ' + id + ')');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('load', () => {
            loadReservations();
        });
    </script>
</body>
</html>
