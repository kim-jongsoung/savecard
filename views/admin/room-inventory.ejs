<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Room Availability - ê´Œ ì„¸ì´ë¸Œì¹´ë“œ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; font-size: 11px; }
    .inventory-header { background: #2c3e50; color: white; padding: 0.5rem; text-align: center; font-weight: 700; margin: 1rem 0; }
    .month-section { margin-bottom: 2rem; page-break-inside: avoid; }
    .month-title { background: #34495e; color: white; padding: 0.4rem; font-weight: 700; text-align: center; margin-bottom: 0.5rem; cursor: pointer; }
    .month-title input[type="checkbox"] { cursor: pointer; }
    .avail-table { width: 100%; border-collapse: collapse; font-size: 10px; }
    .avail-table th { background: #95a5a6; color: white; padding: 0.3rem; text-align: center; font-weight: 600; border: 1px solid #7f8c8d; min-width: 22px; }
    .avail-table th.rt { min-width: 120px; text-align: left; }
    .avail-table td { padding: 0; text-align: center; border: 1px solid #ddd; cursor: pointer; font-weight: 600; min-width: 22px; height: 22px; position: relative; }
    .avail-table td.rt-cell { background: #ecf0f1; font-weight: 700; text-align: left; padding-left: 0.4rem; cursor: pointer; }
    .avail-table td.rt-cell input[type="checkbox"] { cursor: pointer; }
    .cell-O { color: #27ae60; background: #d5f4e6; }
    .cell-X { color: #e74c3c; background: #fadbd8; }
    .cell-V { color: #3498db; background: #d6eaf8; }
    .cell-updated { background: #fff59d !important; }
    .cell-selected { background: #bbdefb !important; outline: 2px solid #2196f3; }
    .cell-chk { position: absolute; top: 1px; left: 1px; transform: scale(0.7); }
    .btn-sm { font-size: 10px; padding: 0.2rem 0.4rem; }
  </style>
</head>
<body>
  <%- include('../partials/navbar') %>
  <div class="container-fluid mt-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Room Availability</h4>
      <div>
        Prepared by <%= adminUsername %> | <span id="todayDate"></span>
        <button class="btn btn-warning btn-sm ms-2" onclick="saveChanges()">Update</button>
      </div>
    </div>
    
    <div class="mb-2">
      <label>Hotel:</label>
      <select class="form-select form-select-sm d-inline-block w-auto" id="hotelSelect" onchange="loadData()">
        <option value="">Select Hotel</option>
      </select>
      <label class="ms-3">Start:</label>
      <input type="month" class="form-control form-control-sm d-inline-block w-auto" id="startMonth" value="2025-11" onchange="loadData()">
      <button class="btn btn-primary btn-sm ms-2" onclick="selectAllCells()">ğŸ“‹ ì „ì²´ì„ íƒ</button>
      <button class="btn btn-secondary btn-sm" onclick="clearSelection()">âŒ ì„ íƒí•´ì œ</button>
      <span class="text-muted small ms-2">| ğŸ’¡ ì›” íƒ€ì´í‹€Â·ë£¸íƒ€ì…ëª… ì²´í¬ë°•ìŠ¤ë¡œ ì¼ê´„ì„ íƒ ê°€ëŠ¥</span>
      <br class="mt-1">
      <button class="btn btn-success btn-sm ms-2 mt-2" onclick="bulkUpdate('O')">Open</button>
      <button class="btn btn-danger btn-sm" onclick="bulkUpdate('X')">Close</button>
      <button class="btn btn-info btn-sm" onclick="bulkUpdate('V')">Check</button>
      <span class="ms-2 small text-muted" id="inventoryTypeHint"></span>
    </div>
    
    <div id="inventoryContainer"></div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.getElementById('todayDate').textContent = new Date().toLocaleDateString('ko-KR');
    
    let hotels = [], roomTypes = [], inventory = {}, selected = new Set(), changes = {};
    let currentHotel = null; // í˜„ì¬ ì„ íƒëœ í˜¸í…” ì •ë³´
    
    async function loadHotels() {
      const res = await fetch('/api/hotels?is_active=true');
      hotels = await res.json();
      const sel = document.getElementById('hotelSelect');
      hotels.forEach(h => sel.innerHTML += `<option value="${h.id}">${h.hotel_name}</option>`);
    }
    
    async function loadData() {
      const hid = document.getElementById('hotelSelect').value;
      if (!hid) return;
      
      // í˜¸í…” ì •ë³´ ê°€ì ¸ì˜¤ê¸° (inventory_type í™•ì¸)
      const hotelRes = await fetch(`/api/hotels/${hid}`);
      currentHotel = await hotelRes.json();
      
      const rtRes = await fetch(`/api/hotels/${hid}/room-types`);
      roomTypes = await rtRes.json();
      
      const start = document.getElementById('startMonth').value.split('-');
      const year = parseInt(start[0]), month = parseInt(start[1]);
      inventory = {};
      
      for (let m = 0; m < 6; m++) {
        const y = month + m > 12 ? year + 1 : year;
        const mo = month + m > 12 ? month + m - 12 : month + m;
        const res = await fetch(`/api/inventory?hotel_id=${hid}&year=${y}&month=${mo}`);
        const data = await res.json();
        data.forEach(inv => {
          const key = `${inv.room_type_id}-${inv.inventory_date}`;
          // count ë°©ì‹: ìˆ«ì ê·¸ëŒ€ë¡œ, status ë°©ì‹: O/Xë¡œ ë³€í™˜
          if (currentHotel.inventory_type === 'count') {
            inventory[key] = inv.available_rooms;
          } else {
            inventory[key] = inv.available_rooms === 0 ? 'X' : (inv.available_rooms > 0 ? 'O' : '');
          }
        });
      }
      
      // ì¬ê³  ê´€ë¦¬ ë°©ì‹ íŒíŠ¸ í‘œì‹œ
      const hint = document.getElementById('inventoryTypeHint');
      if (currentHotel.inventory_type === 'count') {
        hint.textContent = 'ğŸ’¡ ìˆ«ì ì¹´ìš´íŒ… ë°©ì‹: Open í´ë¦­ ì‹œ ê°ì‹¤ ìˆ˜ ì…ë ¥';
      } else {
        hint.textContent = 'ğŸ’¡ ìƒíƒœ í‘œì‹œ ë°©ì‹: O(ì˜¤í”ˆ)/X(ë§ˆê°)/V(í™•ì¸í•„ìš”)';
      }
      
      renderInventory(year, month);
    }
    
    function renderInventory(year, month) {
      const container = document.getElementById('inventoryContainer');
      let html = '';
      
      for (let m = 0; m < 6; m++) {
        const y = month + m > 12 ? year + 1 : year;
        const mo = month + m > 12 ? month + m - 12 : month + m;
        const monthName = new Date(y, mo - 1).toLocaleString('en', { month: 'short', year: '2-digit' });
        const days = new Date(y, mo, 0).getDate();
        
        html += `<div class="month-section">
          <div class="month-title">
            <input type="checkbox" class="me-2" onchange="selectMonth(${y}, ${mo})" style="transform: scale(1.2);">
            ${monthName}
          </div>
          <table class="avail-table"><thead><tr><th class="rt">Room Type</th>`;
        for (let d = 1; d <= days; d++) html += `<th>${d}</th>`;
        html += `</tr></thead><tbody>`;
        
        roomTypes.forEach(rt => {
          html += `<tr><td class="rt-cell">
            <input type="checkbox" class="me-1" onchange="selectRoomType(${rt.id}, ${y}, ${mo})" style="transform: scale(0.9);">
            ${rt.room_type_code}
          </td>`;
          for (let d = 1; d <= days; d++) {
            const date = `${y}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const key = `${rt.id}-${date}`;
            const status = changes[key] !== undefined ? changes[key] : inventory[key];
            
            // count ë°©ì‹: ìˆ«ì í‘œì‹œ ë° í´ë˜ìŠ¤ ì„¤ì •
            let cls = '', displayValue = '';
            if (currentHotel && currentHotel.inventory_type === 'count') {
              displayValue = status !== undefined && status !== '' ? status : '';
              if (status === 0) cls = 'cell-X';
              else if (status > 0) cls = 'cell-O';
            } else {
              // status ë°©ì‹: O/X/V
              displayValue = status || '';
              cls = status ? `cell-${status}` : '';
            }
            
            const sel = selected.has(key) ? ' cell-selected' : '';
            html += `<td class="${cls}${sel}" onclick="toggleCell('${key}')" data-key="${key}">
              <input type="checkbox" class="cell-chk" ${selected.has(key)?'checked':''} onclick="event.stopPropagation();toggleCell('${key}')">
              ${displayValue}
            </td>`;
          }
          html += `</tr>`;
        });
        
        html += `</tbody></table></div>`;
      }
      
      container.innerHTML = html;
    }
    
    function toggleCell(key) {
      if (selected.has(key)) selected.delete(key);
      else selected.add(key);
      loadData();
    }
    
    function selectMonth(year, month) {
      const days = new Date(year, month, 0).getDate();
      roomTypes.forEach(rt => {
        for (let d = 1; d <= days; d++) {
          const date = `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          const key = `${rt.id}-${date}`;
          if (event.target.checked) {
            selected.add(key);
          } else {
            selected.delete(key);
          }
        }
      });
      loadData();
    }
    
    function selectRoomType(roomTypeId, year, month) {
      const days = new Date(year, month, 0).getDate();
      for (let d = 1; d <= days; d++) {
        const date = `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const key = `${roomTypeId}-${date}`;
        if (event.target.checked) {
          selected.add(key);
        } else {
          selected.delete(key);
        }
      }
      loadData();
    }
    
    function selectAllRoomType(roomTypeId) {
      const [year, month] = document.getElementById('startMonth').value.split('-').map(Number);
      for (let m = 0; m < 6; m++) {
        const y = month + m > 12 ? year + 1 : year;
        const mo = month + m > 12 ? month + m - 12 : month + m;
        const days = new Date(y, mo, 0).getDate();
        for (let d = 1; d <= days; d++) {
          const date = `${y}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          const key = `${roomTypeId}-${date}`;
          if (event.target.checked) {
            selected.add(key);
          } else {
            selected.delete(key);
          }
        }
      }
      loadData();
    }
    
    function selectAllCells() {
      selected.clear();
      roomTypes.forEach(rt => {
        const [year, month] = document.getElementById('startMonth').value.split('-').map(Number);
        for (let m = 0; m < 6; m++) {
          const y = month + m > 12 ? year + 1 : year;
          const mo = month + m > 12 ? month + m - 12 : month + m;
          const days = new Date(y, mo, 0).getDate();
          for (let d = 1; d <= days; d++) {
            const date = `${y}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            selected.add(`${rt.id}-${date}`);
          }
        }
      });
      loadData();
    }
    
    function clearSelection() {
      selected.clear();
      loadData();
    }
    
    function bulkUpdate(status) {
      if (selected.size === 0) return alert('No cells selected');
      
      // ìˆ«ì ì¹´ìš´íŒ… ë°©ì‹ì¼ ë•ŒëŠ” ìˆ«ì ì…ë ¥
      if (currentHotel && currentHotel.inventory_type === 'count') {
        let rooms;
        if (status === 'O') {
          rooms = prompt('ê°ì‹¤ ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', '10');
          if (rooms === null) return; // ì·¨ì†Œ
          rooms = parseInt(rooms);
          if (isNaN(rooms) || rooms < 0) return alert('ìœ íš¨í•œ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        } else if (status === 'X') {
          rooms = 0;
        } else if (status === 'V') {
          rooms = prompt('í™•ì¸ í•„ìš” - ê°ì‹¤ ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', '5');
          if (rooms === null) return;
          rooms = parseInt(rooms);
          if (isNaN(rooms) || rooms < 0) return alert('ìœ íš¨í•œ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        }
        selected.forEach(key => changes[key] = rooms);
      } else {
        // ìƒíƒœ ë°©ì‹: O/X/V ê·¸ëŒ€ë¡œ
        selected.forEach(key => changes[key] = status);
      }
      
      selected.clear();
      loadData();
    }
    
    async function saveChanges() {
      if (Object.keys(changes).length === 0) return alert('No changes to save');
      const hid = document.getElementById('hotelSelect').value;
      let saved = 0;
      
      for (const [key, value] of Object.entries(changes)) {
        const [rtid, date] = key.split('-', 2);
        
        // count ë°©ì‹: ìˆ«ì ê·¸ëŒ€ë¡œ, status ë°©ì‹: O/X/Vë¥¼ ìˆ«ìë¡œ ë³€í™˜
        let rooms;
        if (currentHotel && currentHotel.inventory_type === 'count') {
          rooms = value; // ì´ë¯¸ ìˆ«ì
        } else {
          rooms = value === 'O' ? 10 : (value === 'X' ? 0 : 5);
        }
        
        await fetch('/api/inventory/bulk', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({hotel_id: hid, room_type_id: rtid, start_date: date, end_date: date, days_of_week: [], available_rooms: rooms})
        });
        saved++;
      }
      
      alert(`${saved} cells updated`);
      changes = {};
      loadData();
    }
    
    loadHotels();
  </script>
</body>
</html>
