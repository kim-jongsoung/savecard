<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ÏàòÎ∞∞Í¥ÄÎ¶¨ - Í¥åÏÑ∏Ïù¥Î∏åÏπ¥Îìú Í¥ÄÎ¶¨Ïûê</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { 
            background:#f7f7f9; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        main { 
            flex: 1;
        }
        
        /* PC ÌôîÎ©¥ÏóêÏÑú Í∞ÄÎ°úÌè≠ 1200px Í≥†Ï†ï */
        .container-fluid {
            max-width: 1200px;
            margin: 0 auto;
        }
        .page-header { position: sticky; top: 0; z-index: 10; background:#fff; border-bottom:1px solid #eee; }
        .status-badge { font-weight:600; }
        .row-card { 
            background:#fff; 
            border:2px solid #d1d5db; 
            border-radius:10px; 
            padding:18px 20px; 
            margin-bottom:16px; 
            display:flex; 
            align-items:center; 
            gap:16px; 
            cursor:pointer; 
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
        }
        .row-card:hover { 
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            border-color: #9ca3af;
            transform: translateY(-1px);
        }
        .row-card-selected {
            border: 3px solid #0d6efd !important;
            background: #f0f7ff !important;
            box-shadow: 0 4px 16px rgba(13, 110, 253, 0.25) !important;
        }
        .row-main { display:flex; flex-wrap:wrap; gap:10px; align-items:center; flex:1; }
        .row-main > .chip { background:#e8f4f8; border-radius:6px; padding:5px 12px; font-size:0.95rem; font-weight:500; color:#1a73e8; }
        .row-main .dim { color:#6c757d; font-size:0.9rem; }
        .money { font-weight:700; color:#212529; }
        .btn-manage { margin-left:auto; }
        .row-card .btn-group { flex-shrink: 0; }
        .toolbar { display:flex; gap:8px; }
        .table-like { font-size:1rem; line-height:1.6; }
        .form-note { font-size:.85rem; color:#6c757d; }
        .divider { height:1px; background:#eee; margin:12px 0; }
        .tab-pane { padding-top:12px; }
        .copy-btn { white-space:nowrap; }
        
        /* Ïã†Í∑ú Î±ÉÏßÄ Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate__pulse {
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* ÏÉÅÌÉúÎ≥Ñ Î∞∞ÏßÄ ÏÉâÏÉÅ */
        .status-in-revision { background-color: #ff6b6b !important; color: #fff !important; }
        .status-pending { background-color: #6c757d !important; }
        .status-in-progress { background-color: #ffc107 !important; color: #000 !important; }
        .status-confirmed { background-color: #28a745 !important; }
        .status-voucher-sent { background-color: #17a2b8 !important; }
        .status-cancelled { background-color: #dc3545 !important; }
        .status-refunded { background-color: #6f42c1 !important; }
        
        /* Ïù¥Ïö©Ïùº ÏôÑÎ£åÎêú Í±¥ Î∞∞Í≤ΩÏÉâ */
        .bg-light-gray {
            background-color: #f8f9fa !important;
        }
        
        /* ÏàòÎ∞∞ÏÑú Î™®Îã¨ Í∞úÏÑ† */
        .assignment-modal .modal-body {
            padding: 1rem;
            font-size: 0.85rem;
        }
        
        .assignment-modal .card {
            margin-bottom: 0.75rem;
            border: 1px solid #e9ecef;
        }
        
        .assignment-modal .card-header {
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
            font-weight: 600;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .assignment-modal .card-body {
            padding: 0.75rem;
        }
        
        .assignment-modal .form-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }
        
        .assignment-modal .fw-bold,
        .assignment-modal div:not(.form-label) {
            font-size: 0.8rem;
            line-height: 1.3;
        }
        
        .assignment-modal .badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
        }
        
        .assignment-modal .btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.8rem;
        }
        
        .assignment-modal .btn i {
            font-size: 0.75rem;
        }
        
        .assignment-modal .input-group-text {
            font-size: 0.8rem;
            padding: 0.375rem 0.5rem;
        }
        
        .assignment-modal .form-control {
            font-size: 0.8rem;
            padding: 0.375rem 0.5rem;
        }
        
        /* Ïπ∏ ÌòïÌÉú Íµ¨Î∂Ñ */
        .assignment-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .assignment-info-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 0.5rem;
        }
        
        .assignment-info-item .label {
            font-size: 0.7rem;
            color: #6c757d;
            font-weight: 600;
            margin-bottom: 0.25rem;
            display: block;
        }
        
        .assignment-info-item .value {
            font-size: 0.8rem;
            color: #212529;
            font-weight: 500;
        }
        
        /* Î≤ÑÌäº Î∞è ÏïÑÏù¥ÏΩò ÌÅ¨Í∏∞ Ï§ÑÏù¥Í∏∞ */
        .btn-group-sm > .btn {
            padding: 4px 8px !important;
            font-size: 0.75rem !important;
            border-radius: 4px;
        }
        
        .btn-group-sm > .btn i {
            font-size: 0.7rem !important;
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar', { currentPage: 'assignments' }) %>
    
    <header class="page-header py-3">
        <div class="container d-flex align-items-center justify-content-between">
            <h1 class="h4 m-0">ÏàòÎ∞∞Í¥ÄÎ¶¨</h1>
            <div class="toolbar">
                <button class="btn btn-outline-secondary btn-sm" onclick="toggleFilters()">
                    <i class="bi bi-funnel me-1"></i>ÌïÑÌÑ∞
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="loadAssignments()">
                    <i class="bi bi-arrow-repeat me-1"></i>ÏÉàÎ°úÍ≥†Ïπ®
                </button>
            </div>
        </div>
    </header>

    <main class="container my-3">
        <!-- ÌïÑÌÑ∞ Ìå®ÎÑê (Í∏∞Î≥∏ Ïó¥Î¶º) -->
        <div id="filterPanel" class="card mb-3">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label">ÏóÖÏ≤¥Î™Ö</label>
                        <input type="text" class="form-control" id="searchCompany" placeholder="ÏóÖÏ≤¥Î™Ö Í≤ÄÏÉâ">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ÏÉÅÌíàÎ™Ö</label>
                        <input type="text" class="form-control" id="searchProduct" placeholder="ÏÉÅÌíàÎ™Ö Í≤ÄÏÉâ">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ÏòàÏïΩÏûêÎ™Ö</label>
                        <input type="text" class="form-control" id="searchCustomer" placeholder="ÏòàÏïΩÏûêÎ™Ö Í≤ÄÏÉâ">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Ï∂úÎ∞úÏùº</label>
                        <input type="date" class="form-control" id="searchDepartureDate">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ÏòàÏïΩÏÉÅÌÉú</label>
                        <select class="form-select" id="searchStatus">
                            <option value="">Ï†ÑÏ≤¥</option>
                            <option value="in_revision">ÏàòÏ†ïÏ§ë(ÏòàÏïΩÎ≥ÄÍ≤Ω)</option>
                            <option value="pending">ÎåÄÍ∏∞Ï§ë(Ïã†Í∑ú)</option>
                            <option value="in_progress">ÏàòÎ∞∞Ï§ë</option>
                            <option value="confirmed">ÌôïÏ†ïÏôÑÎ£å</option>
                            <option value="voucher_sent">Î∞îÏö∞Ï≤òÏ†ÑÏÜ°</option>
                            <option value="cancelled">ÏòàÏïΩÏ∑®ÏÜå</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ÏàòÎ∞∞ÏóÖÏ≤¥</label>
                        <input type="text" class="form-control" id="searchVendor" placeholder="ÏàòÎ∞∞ÏóÖÏ≤¥ Í≤ÄÏÉâ">
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary me-2" onclick="searchAssignments()">
                        <i class="bi bi-search me-1"></i>Í≤ÄÏÉâ
                    </button>
                    <button class="btn btn-outline-secondary" onclick="clearSearch()">
                        <i class="bi bi-x me-1"></i>Ï¥àÍ∏∞Ìôî
                    </button>
                </div>
            </div>
        </div>

        <!-- ÏïïÏ∂ï Í∞ÄÎ°ú Î¶¨Ïä§Ìä∏ -->
        <div id="assignmentsList">
            <!-- Îç∞Ïù¥ÌÑ∞Í∞Ä Ïó¨Í∏∞Ïóê Î°úÎìúÎê©ÎãàÎã§ -->
        </div>

        <!-- Î°úÎî© ÏÉÅÌÉú -->
        <div id="loadingState" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Î°úÎî© Ï§ë...</span>
            </div>
            <div class="mt-2">ÏàòÎ∞∞ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
        </div>

        <!-- Îπà ÏÉÅÌÉú -->
        <div id="emptyState" class="text-center py-5" style="display: none;">
            <i class="bi bi-inbox display-1 text-muted"></i>
            <h5 class="text-muted mt-3">ÏàòÎ∞∞ Ï§ëÏù∏ ÏòàÏïΩÏù¥ ÏóÜÏäµÎãàÎã§</h5>
            <p class="text-muted">ÏòàÏïΩÍ¥ÄÎ¶¨ÏóêÏÑú ÏàòÎ∞∞ÏÑúÎ•º ÏÉùÏÑ±ÌïòÎ©¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§.</p>
        </div>
    </main>
    
    <!-- ÌíãÌÑ∞ -->
    <footer class="bg-white border-top py-3 mt-4">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6 text-muted small">
                    <span id="totalCount">Ï¥ù 0Í∞ú</span> | 
                    <span id="statusSummary">Ïã†Í∑ú 0 ¬∑ ÏàòÎ∞∞Ï§ë 0 ¬∑ ÌôïÏ†ï 0</span>
                </div>
                <div class="col-md-6 text-end text-muted small">
                    ¬© 2025 Í¥åÏÑ∏Ïù¥Î∏åÏπ¥Îìú Í¥ÄÎ¶¨ÏãúÏä§ÌÖú
                </div>
            </div>
        </div>
    </footer>

    <!-- 1. ÏòàÏïΩÎ≥ÄÍ≤Ω Î™®Îã¨ -->
    <div class="modal fade" id="reservationEditModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>ÏòàÏïΩÎ≥ÄÍ≤Ω</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Í∏∞Î≥∏ Ï†ïÎ≥¥ (Í∞ÄÎ°úÌòï Î†àÏù¥ÏïÑÏõÉ) -->
                    <div class="row mb-2">
                        <div class="col-md-2">
                            <label class="form-label small mb-1">ÏòàÏïΩÎ≤àÌò∏</label>
                            <input type="text" class="form-control form-control-sm" id="edit-reservation-number" readonly>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small mb-1">ÏóÖÏ≤¥Î™Ö</label>
                            <input type="text" class="form-control form-control-sm" id="edit-platform-name">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small mb-1">ÏòàÏïΩ ÏÉÅÌÉú</label>
                            <select class="form-select form-select-sm" id="edit-payment-status">
                                <option value="in_revision">ÏàòÏ†ïÏ§ë</option>
                                <option value="pending">ÎåÄÍ∏∞Ï§ë</option>
                                <option value="in_progress">ÏàòÎ∞∞Ï§ë</option>
                                <option value="confirmed">ÌôïÏ†ï</option>
                                <option value="voucher_sent">Î∞îÏö∞Ï≤òÏ†ÑÏÜ°ÏôÑÎ£å</option>
                                <option value="cancelled">ÏòàÏïΩÏ∑®ÏÜå</option>
                                <option value="refunded">ÌôòÎ∂àÏôÑÎ£å</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small mb-1">ÏÉÅÌíàÎ™Ö</label>
                            <input type="text" class="form-control form-control-sm" id="edit-product-name">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small mb-1">Ìå®ÌÇ§ÏßÄ ÌÉÄÏûÖ</label>
                            <input type="text" class="form-control form-control-sm" id="edit-package-type">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-2">
                            <label class="form-label small mb-1">Ïù¥Ïö©Ïùº</label>
                            <input type="date" class="form-control form-control-sm" id="edit-usage-date">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small mb-1">Ïù¥Ïö©ÏãúÍ∞Ñ</label>
                            <input type="time" class="form-control form-control-sm" id="edit-usage-time">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small mb-1">ÌïúÍ∏ÄÎ™Ö</label>
                            <input type="text" class="form-control form-control-sm" id="edit-korean-name">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small mb-1">ÏòÅÎ¨∏ ÏÑ±</label>
                            <input type="text" class="form-control form-control-sm" id="edit-english-lastname">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small mb-1">ÏòÅÎ¨∏ Ïù¥Î¶Ñ</label>
                            <input type="text" class="form-control form-control-sm" id="edit-english-firstname">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small mb-1">Ï†ÑÌôîÎ≤àÌò∏</label>
                            <input type="text" class="form-control form-control-sm" id="edit-phone">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label small mb-1">Ïù¥Î©îÏùº</label>
                            <input type="email" class="form-control form-control-sm" id="edit-email" placeholder="Ïù¥Î©îÏùº">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small mb-1">Ïπ¥Ïπ¥Ïò§ID</label>
                            <input type="text" class="form-control form-control-sm" id="edit-kakao-id" placeholder="Ïπ¥Ïπ¥Ïò§ID">
                        </div>
                    </div>

                    <div class="row g-3">

                        <!-- Ïù∏Ïõê Î∞è Í∏àÏï° Ï†ïÎ≥¥ -->
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-people me-2"></i>Ïù∏Ïõê Î∞è Í∏àÏï° Ï†ïÎ≥¥</h6>
                                </div>
                                <div class="card-body">
                                    <!-- ÏÑ±Ïù∏ -->
                                    <div class="row g-2 mb-2 align-items-end">
                                        <div class="col-md-1">
                                            <span class="badge bg-primary">ÏÑ±Ïù∏</span>
                                        </div>
                                        <div class="col-md-1">
                                            <label class="form-label small">Ïù∏Ïõê</label>
                                            <input type="number" class="form-control form-control-sm" id="edit-people-adult" min="0" value="0" onchange="calculateEditTotal()">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small">ÌåêÎß§Í∞Ä</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" id="edit-adult-price" min="0" step="0.01" onchange="calculateEditTotal()">
                                                <select class="form-select" id="edit-adult-currency" style="max-width: 70px;" onchange="calculateEditTotal()">
                                                    <option value="KRW">‚Ç©</option>
                                                    <option value="USD">$</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small">ÏõêÍ∞Ä</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" id="edit-adult-cost" min="0" step="0.01" onchange="calculateEditTotal()">
                                                <select class="form-select" id="edit-adult-cost-currency" style="max-width: 70px;" onchange="calculateEditTotal()">
                                                    <option value="KRW">‚Ç©</option>
                                                    <option value="USD">$</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small">ÎßàÏßÑ</label>
                                            <input type="text" class="form-control form-control-sm fw-bold" id="edit-adult-margin" readonly style="background-color: #e7f3ff;">
                                        </div>
                                    </div>
                                    
                                    <!-- ÏÜåÏïÑ -->
                                    <div class="row g-2 mb-2 align-items-end">
                                        <div class="col-md-1">
                                            <span class="badge bg-info">ÏÜåÏïÑ</span>
                                        </div>
                                        <div class="col-md-1">
                                            <label class="form-label small">Ïù∏Ïõê</label>
                                            <input type="number" class="form-control form-control-sm" id="edit-people-child" min="0" value="0" onchange="calculateEditTotal()">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small">ÌåêÎß§Í∞Ä</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" id="edit-child-price" min="0" step="0.01" onchange="calculateEditTotal()">
                                                <select class="form-select" id="edit-child-currency" style="max-width: 70px;" onchange="calculateEditTotal()">
                                                    <option value="KRW">‚Ç©</option>
                                                    <option value="USD">$</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small">ÏõêÍ∞Ä</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" id="edit-child-cost" min="0" step="0.01" onchange="calculateEditTotal()">
                                                <select class="form-select" id="edit-child-cost-currency" style="max-width: 70px;" onchange="calculateEditTotal()">
                                                    <option value="KRW">‚Ç©</option>
                                                    <option value="USD">$</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small">ÎßàÏßÑ</label>
                                            <input type="text" class="form-control form-control-sm fw-bold" id="edit-child-margin" readonly style="background-color: #d1ecf1;">
                                        </div>
                                    </div>
                                    
                                    <!-- Ïú†ÏïÑ -->
                                    <div class="row g-2 mb-3 align-items-end">
                                        <div class="col-md-1">
                                            <span class="badge bg-warning text-dark">Ïú†ÏïÑ</span>
                                        </div>
                                        <div class="col-md-1">
                                            <label class="form-label small">Ïù∏Ïõê</label>
                                            <input type="number" class="form-control form-control-sm" id="edit-people-infant" min="0" value="0" onchange="calculateEditTotal()">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small">ÌåêÎß§Í∞Ä</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" id="edit-infant-price" min="0" step="0.01" onchange="calculateEditTotal()">
                                                <select class="form-select" id="edit-infant-currency" style="max-width: 70px;" onchange="calculateEditTotal()">
                                                    <option value="KRW">‚Ç©</option>
                                                    <option value="USD">$</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small">ÏõêÍ∞Ä</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" id="edit-infant-cost" min="0" step="0.01" onchange="calculateEditTotal()">
                                                <select class="form-select" id="edit-infant-cost-currency" style="max-width: 70px;" onchange="calculateEditTotal()">
                                                    <option value="KRW">‚Ç©</option>
                                                    <option value="USD">$</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small">ÎßàÏßÑ</label>
                                            <input type="text" class="form-control form-control-sm fw-bold" id="edit-infant-margin" readonly style="background-color: #fff3cd;">
                                        </div>
                                    </div>
                                    
                                    <!-- Ìï©Í≥Ñ -->
                                    <div class="row g-2 border-top pt-3">
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">Ï¥ù Ïù∏Ïõê</label>
                                            <input type="text" class="form-control fw-bold" id="edit-total-guests" readonly style="background-color: #f8f9fa; font-size: 1.1em;">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">Ï¥ù Í∏àÏï°</label>
                                            <input type="text" class="form-control fw-bold text-primary" id="edit-total-amount" readonly style="background-color: #f8f9fa; font-size: 1.1em;">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">Í≥ÑÏÇ∞Ïãù</label>
                                            <input type="text" class="form-control" id="edit-calculation-formula" readonly style="background-color: #f8f9fa; font-size: 0.85em;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÌäπÎ≥Ñ ÏöîÏ≤≠ÏÇ¨Ìï≠ -->
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-chat-text me-2"></i>ÌäπÎ≥Ñ ÏöîÏ≤≠ÏÇ¨Ìï≠</h6>
                                </div>
                                <div class="card-body">
                                    <textarea class="form-control" id="edit-memo" rows="3" placeholder="ÌäπÎ≥Ñ ÏöîÏ≤≠ÏÇ¨Ìï≠ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Ï∑®ÏÜå</button>
                    <button class="btn btn-primary" onclick="saveReservationChanges()">
                        <i class="bi bi-save me-1"></i>Ï†ÄÏû•
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. ÏàòÎ∞∞ÏÑúÍ¥ÄÎ¶¨ Î™®Îã¨ -->
    <div class="modal fade" id="assignmentManageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-file-text me-2"></i>ÏàòÎ∞∞ÏÑúÍ¥ÄÎ¶¨</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- ÏàòÎ∞∞ÏÑú Í¥ÄÎ¶¨ (ÏúÑÎ°ú Ïù¥Îèô) -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-gear me-2"></i>ÏàòÎ∞∞ÏÑú Í¥ÄÎ¶¨</h6>
                            <button class="btn btn-sm btn-outline-secondary" onclick="refreshAssignmentInfo()">
                                <i class="bi bi-arrow-clockwise"></i> ÏÉàÎ°úÍ≥†Ïπ®
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="btn-group w-100 mb-2" role="group">
                                <button class="btn btn-sm btn-outline-primary" onclick="previewAssignment()">
                                    <i class="bi bi-eye me-1"></i>ÎØ∏Î¶¨Î≥¥Í∏∞
                                </button>
                                <button class="btn btn-sm btn-success" onclick="sendAssignmentWithEmail()">
                                    <i class="bi bi-envelope me-1"></i>Ïù¥Î©îÏùº Ï†ÑÏÜ°
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="copyAssignmentLink()">
                                    <i class="bi bi-link-45deg me-1"></i>ÎßÅÌÅ¨ Î≥µÏÇ¨
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÏàòÎ∞∞ÏÑú Ï†ïÎ≥¥ -->
                    <div class="card mt-2">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>ÏàòÎ∞∞ÏÑú Ï†ïÎ≥¥</h6>
                        </div>
                        <div class="card-body p-2">
                            <table class="table table-sm table-borderless mb-0">
                                <tbody>
                                    <tr>
                                        <td width="30%" class="text-muted">ÏàòÎ∞∞ÏÑú Î≤àÌò∏</td>
                                        <td class="fw-bold" id="assignment-number">-</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">ÏòàÏïΩÏóÖÏ≤¥</td>
                                        <td class="text-primary fw-bold" id="assignment-platform">-</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">ÏàòÎ∞∞ÏóÖÏ≤¥</td>
                                        <td id="assignment-vendor">-</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">ÏÉùÏÑ±ÏùºÏãú</td>
                                        <td id="assignment-created">-</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Ïù¥Î©îÏùº Ï†ÑÏÜ°</td>
                                        <td id="assignment-email-status">
                                            <span class="badge bg-secondary">ÎØ∏Ï†ÑÏÜ°</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Ïó¥Îûå ÌòÑÌô©</td>
                                        <td id="assignment-views">
                                            <span class="badge bg-secondary">ÎØ∏Ïó¥Îûå</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Ïó¥Îûå ÌÜµÍ≥Ñ (ÏïÑÎûòÎ°ú Ïù¥Îèô) -->
                    <div class="card mt-2">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Ïó¥Îûå ÌÜµÍ≥Ñ</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadViewStats()">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        <div class="card-body p-2">
                            <div id="view-stats-content">
                                <div class="text-center text-muted py-2">
                                    <small><i class="bi bi-hourglass-split"></i> Ï°∞Ìöå Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. ÏÉÅÌÉúÍ¥ÄÎ¶¨ Î™®Îã¨ (ÌôïÏ†ï Î∞©Ïãù ÏÑ†ÌÉù) -->
    <div class="modal fade" id="statusManageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-check-circle-fill me-2"></i>ÏòàÏïΩ ÌôïÏ†ïÌïòÍ∏∞</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- ÌòÑÏû¨ ÏÉÅÌÉú ÌëúÏãú -->
                    <div class="alert alert-info d-flex align-items-center mb-4">
                        <i class="bi bi-info-circle me-2" style="font-size: 1.5rem;"></i>
                        <div>
                            <strong>ÌòÑÏû¨ ÏÉÅÌÉú:</strong> <span id="current-status-display" class="ms-2">Î°úÎî©Ï§ë...</span>
                        </div>
                    </div>

                    <!-- ÌôïÏ†ï Î∞©Ïãù ÏÑ†ÌÉù -->
                    <h6 class="mb-3"><i class="bi bi-list-check me-2"></i>ÌôïÏ†ï Î∞©Ïãù ÏÑ†ÌÉù</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="card h-100 border-primary cursor-pointer confirmation-method-card" onclick="selectConfirmationMethod(1)" data-method="1">
                                <div class="card-body text-center">
                                    <i class="bi bi-key-fill text-primary" style="font-size: 2rem;"></i>
                                    <h6 class="mt-2 mb-0">Ïª®ÌéåÎ≤àÌò∏ Îì±Î°ù</h6>
                                    <small class="text-muted">ÏàòÎ∞∞ÏóÖÏ≤¥ ÌöåÏã† Î≤àÌò∏</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 border-success cursor-pointer confirmation-method-card" onclick="selectConfirmationMethod(2)" data-method="2">
                                <div class="card-body text-center">
                                    <i class="bi bi-qr-code text-success" style="font-size: 2rem;"></i>
                                    <h6 class="mt-2 mb-0">QRÏΩîÎìú Îì±Î°ù</h6>
                                    <small class="text-muted">ÏàòÎ∞∞ÏóÖÏ≤¥ Ï†úÍ≥µ QR</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 border-warning cursor-pointer confirmation-method-card" onclick="selectConfirmationMethod(3)" data-method="3">
                                <div class="card-body text-center">
                                    <i class="bi bi-ticket-perforated-fill text-warning" style="font-size: 2rem;"></i>
                                    <h6 class="mt-2 mb-0">Î∞îÏö∞Ï≤ò Îì±Î°ù</h6>
                                    <small class="text-muted">ÏàòÎ∞∞ÏóÖÏ≤¥ Ï†úÍ≥µ Î∞îÏö∞Ï≤ò</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 border-danger cursor-pointer confirmation-method-card" onclick="selectConfirmationMethod(4)" data-method="4">
                                <div class="card-body text-center">
                                    <i class="bi bi-check-circle-fill text-danger" style="font-size: 2rem;"></i>
                                    <h6 class="mt-2 mb-0">Ï¶âÏãú ÌôïÏ†ï</h6>
                                    <small class="text-muted">ÌöåÏã† Î∂àÌïÑÏöî</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÏûÖÎ†• Ìèº (Î∞©ÏãùÎ≥ÑÎ°ú ÎèôÏ†Å ÌëúÏãú) -->
                    <div id="confirmation-input-area" style="display: none;">
                        <hr class="my-4">
                        
                        <!-- Î∞©Ïãù 1: Ïª®ÌéåÎ≤àÌò∏ -->
                        <div id="method-1-form" class="confirmation-form" style="display: none;">
                            <h6 class="mb-3"><i class="bi bi-key me-2"></i>Ïª®ÌéåÎ≤àÌò∏ ÏûÖÎ†•</h6>
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <label class="form-label">Ïª®ÌéåÎ≤àÌò∏ <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control form-control-lg" id="confirmation-number" placeholder="Ïòà: CONF123456">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">&nbsp;</label>
                                    <button class="btn btn-outline-secondary w-100" onclick="generateConfirmationNumber()">
                                        <i class="bi bi-arrow-clockwise me-1"></i>ÏûêÎèôÏÉùÏÑ±
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Î∞©Ïãù 2: QRÏΩîÎìú -->
                        <div id="method-2-form" class="confirmation-form" style="display: none;">
                            <h6 class="mb-3"><i class="bi bi-qr-code me-2"></i>QRÏΩîÎìú Ï†ïÎ≥¥ ÏûÖÎ†•</h6>
                            <div class="mb-3">
                                <label class="form-label">QRÏΩîÎìú URL ÎòêÎäî ÌÖçÏä§Ìä∏ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control form-control-lg" id="qr-code-data" placeholder="QRÏΩîÎìú URL ÎòêÎäî Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†•">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">QRÏΩîÎìú Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú (ÏÑ†ÌÉù)</label>
                                <input type="file" class="form-control" id="qr-code-image" accept="image/*">
                            </div>
                        </div>

                        <!-- Î∞©Ïãù 3: Î∞îÏö∞Ï≤ò -->
                        <div id="method-3-form" class="confirmation-form" style="display: none;">
                            <h6 class="mb-3"><i class="bi bi-ticket-perforated me-2"></i>ÏàòÎ∞∞ÏóÖÏ≤¥ Î∞îÏö∞Ï≤ò ÏóÖÎ°úÎìú</h6>
                            <div class="mb-3">
                                <label class="form-label">Î∞îÏö∞Ï≤ò ÌååÏùº <span class="text-danger">*</span></label>
                                <input type="file" class="form-control form-control-lg" id="vendor-voucher-file" accept=".pdf,.jpg,.jpeg,.png">
                                <div class="form-text">PDF, JPG, PNG ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•</div>
                            </div>
                        </div>

                        <!-- Î∞©Ïãù 4: Ï¶âÏãú ÌôïÏ†ï -->
                        <div id="method-4-form" class="confirmation-form" style="display: none;">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Ï¶âÏãú ÌôïÏ†ï</strong>: ÏàòÎ∞∞ÏóÖÏ≤¥ ÌöåÏã† ÏóÜÏù¥ Î∞îÎ°ú ÌôïÏ†ïÎê©ÎãàÎã§. Î∞îÏö∞Ï≤òÍ∞Ä ÏûêÎèô ÏÉùÏÑ±Îê©ÎãàÎã§.
                            </div>
                        </div>

                        <!-- Í≥µÌÜµ: Î©îÎ™® -->
                        <div class="mt-3">
                            <label class="form-label">ÌôïÏ†ï Î©îÎ™® (ÏÑ†ÌÉù)</label>
                            <textarea class="form-control" id="confirmation-memo" rows="2" placeholder="ÌôïÏ†ï Í¥ÄÎ†® Î©îÎ™®ÏÇ¨Ìï≠"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Ï∑®ÏÜå</button>
                    <button class="btn btn-primary btn-lg" id="confirm-button" onclick="processConfirmation()" style="display: none;">
                        <i class="bi bi-check-circle-fill me-2"></i>ÌôïÏ†ï ÏôÑÎ£å Î∞è Î∞îÏö∞Ï≤ò ÏÉùÏÑ±
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        .confirmation-method-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .confirmation-method-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .confirmation-method-card.selected {
            background-color: #f0f7ff;
            border-width: 3px !important;
            box-shadow: 0 4px 16px rgba(13, 110, 253, 0.3);
        }
        .cursor-pointer {
            cursor: pointer;
        }
    </style>

    <!-- 4. Î∞îÏö∞Ï≤òÍ¥ÄÎ¶¨ Î™®Îã¨ -->
    <div class="modal fade" id="voucherManageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-ticket-perforated-fill me-2"></i>Î∞îÏö∞Ï≤ò ÏÉùÏÑ± ÏôÑÎ£å</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Î∞îÏö∞Ï≤ò Ï†ïÎ≥¥ ÏöîÏïΩ -->
                    <div class="alert alert-success d-flex align-items-center mb-4">
                        <i class="bi bi-check-circle-fill me-3" style="font-size: 2rem;"></i>
                        <div>
                            <h6 class="mb-1">Î∞îÏö∞Ï≤òÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!</h6>
                            <p class="mb-0 small" id="voucher-summary">Í≥†Í∞ùÎãòÍªò Î∞îÏö∞Ï≤òÎ•º Ï†ÑÏÜ°Ìï¥Ï£ºÏÑ∏Ïöî.</p>
                        </div>
                    </div>

                    <div class="row">
                        <!-- ÏôºÏ™Ω: Î∞îÏö∞Ï≤ò ÎØ∏Î¶¨Î≥¥Í∏∞ -->
                        <div class="col-md-5">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-eye me-2"></i>Î∞îÏö∞Ï≤ò ÎØ∏Î¶¨Î≥¥Í∏∞</h6>
                                </div>
                                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                    <div id="voucher-preview-content" class="border rounded p-3 bg-white">
                                        <div class="text-center text-muted">
                                            <i class="bi bi-hourglass-split mb-2" style="font-size: 2rem;"></i>
                                            <p>Î∞îÏö∞Ï≤ò Î°úÎî©Ï§ë...</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-light">
                                    <button class="btn btn-outline-primary btn-sm w-100" onclick="openVoucherPreview()">
                                        <i class="bi bi-box-arrow-up-right me-1"></i>ÏÉà Ï∞ΩÏóêÏÑú Ïó¥Í∏∞
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Ïò§Î•∏Ï™Ω: Ï†ÑÏÜ° ÏòµÏÖò -->
                        <div class="col-md-7">
                            <!-- Î∞îÏö∞Ï≤ò ÎßÅÌÅ¨ -->
                            <div class="card mb-3">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="bi bi-link-45deg me-2"></i>Î∞îÏö∞Ï≤ò ÎßÅÌÅ¨</h6>
                                </div>
                                <div class="card-body">
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="voucher-link-url" readonly>
                                        <button class="btn btn-outline-secondary" onclick="copyVoucherLink()">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted">Í≥†Í∞ùÏù¥ Ïù¥ ÎßÅÌÅ¨Î•º ÌÅ¥Î¶≠ÌïòÎ©¥ Î∞îÏö∞Ï≤òÎ•º ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.</small>
                                </div>
                            </div>

                            <!-- Ï†ÑÏÜ° Î∞©Î≤ï ÏÑ†ÌÉù -->
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="bi bi-send me-2"></i>Î∞îÏö∞Ï≤ò Ï†ÑÏÜ°ÌïòÍ∏∞</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <!-- 1. Ïù¥Î©îÏùº Ï†ÑÏÜ° -->
                                        <div class="col-md-6">
                                            <div class="card border-primary h-100 voucher-send-card" onclick="sendVoucherEmailWithAI()">
                                                <div class="card-body text-center">
                                                    <i class="bi bi-envelope-fill text-primary" style="font-size: 2.5rem;"></i>
                                                    <h6 class="mt-2 mb-1">Ïù¥Î©îÏùº Ï†ÑÏÜ°</h6>
                                                    <p class="small text-muted mb-0">ü§ñ AI ÏûêÎèô ÏûëÏÑ± + Î∞úÏÜ°</p>
                                                    <p class="small text-success mb-0" id="email-last-sent" style="display: none;">
                                                        <i class="bi bi-check-circle"></i> <span></span>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 2. ÎßÅÌÅ¨ Î≥µÏÇ¨ -->
                                        <div class="col-md-6">
                                            <div class="card border-success h-100 voucher-send-card" onclick="copyVoucherLinkForKakao()">
                                                <div class="card-body text-center">
                                                    <i class="bi bi-link-45deg text-success" style="font-size: 2.5rem;"></i>
                                                    <h6 class="mt-2 mb-1">ÎßÅÌÅ¨ Î≥µÏÇ¨</h6>
                                                    <p class="small text-muted mb-0">Ïπ¥Ïπ¥Ïò§ÌÜ°ÏúºÎ°ú ÏßÅÏ†ë Ï†ÑÏÜ°</p>
                                                    <p class="small text-success mb-0" id="kakao-last-sent" style="display: none;">
                                                        <i class="bi bi-check-circle"></i> <span></span>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 3. Ïπ¥Ïπ¥Ïò§ ÏïåÎ¶ºÌÜ° -->
                                        <div class="col-md-6">
                                            <div class="card border-warning h-100 voucher-send-card" onclick="sendKakaoAlimtalk()">
                                                <div class="card-body text-center">
                                                    <i class="bi bi-chat-dots-fill text-warning" style="font-size: 2.5rem;"></i>
                                                    <h6 class="mt-2 mb-1">Ïπ¥Ïπ¥Ïò§ ÏïåÎ¶ºÌÜ°</h6>
                                                    <p class="small text-muted mb-0">ÏûêÎèô Î∞úÏÜ° (API Ïó∞Îèô)</p>
                                                    <p class="small text-success mb-0" id="alimtalk-last-sent" style="display: none;">
                                                        <i class="bi bi-check-circle"></i> <span></span>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 4. Î¨∏Ïûê Î©îÏãúÏßÄ -->
                                        <div class="col-md-6">
                                            <div class="card border-danger h-100 voucher-send-card" onclick="sendSMS()">
                                                <div class="card-body text-center">
                                                    <i class="bi bi-phone-fill text-danger" style="font-size: 2.5rem;"></i>
                                                    <h6 class="mt-2 mb-1">Î¨∏Ïûê Î©îÏãúÏßÄ</h6>
                                                    <p class="small text-muted mb-0">SMS Î∞úÏÜ°</p>
                                                    <p class="small text-success mb-0" id="sms-last-sent" style="display: none;">
                                                        <i class="bi bi-check-circle"></i> <span></span>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Ïù¥Î©îÏùº Ï†ÑÏÜ° Ìèº (Ïà®ÍπÄ) -->
                                    <div id="email-send-form" class="mt-3" style="display: none;">
                                        <hr>
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="mb-0"><i class="bi bi-envelope me-2"></i>Ïù¥Î©îÏùº Ï†ÑÏÜ°</h6>
                                            <button class="btn btn-sm btn-outline-primary" onclick="generateEmailWithAI()" id="ai-generate-btn">
                                                <i class="bi bi-stars me-1"></i>AIÎ°ú ÏûëÏÑ±
                                            </button>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Î∞õÎäî ÏÇ¨Îûå <span class="text-danger">*</span></label>
                                            <input type="email" class="form-control" id="email-recipient" placeholder="customer@example.com">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Ï†úÎ™©</label>
                                            <input type="text" class="form-control" id="email-subject" value="[Í¥åÏÑ∏Ïù¥Î∏å] ÏòàÏïΩ Î∞îÏö∞Ï≤ò">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Î©îÏãúÏßÄ</label>
                                            <textarea class="form-control" id="email-message" rows="5" placeholder="Í≥†Í∞ùÎãòÍªò Ï†ÑÎã¨Ìï† Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî."></textarea>
                                            <div class="form-text">üí° AIÎ°ú ÏûëÏÑ± Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÎ©¥ ÏûêÎèôÏúºÎ°ú Ï†ÑÎ¨∏Ï†ÅÏù∏ Î©îÏãúÏßÄÍ∞Ä ÏÉùÏÑ±Îê©ÎãàÎã§.</div>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-primary flex-fill" onclick="sendVoucherEmail()">
                                                <i class="bi bi-send-fill me-1"></i>Ï†ÑÏÜ°ÌïòÍ∏∞
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="closeEmailSendForm()">Ï∑®ÏÜå</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Î∞îÏö∞Ï≤ò Ïó¥Îûå ÌÜµÍ≥Ñ -->
                            <div class="card mt-3">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Î∞îÏö∞Ï≤ò Ïó¥Îûå ÌÜµÍ≥Ñ</h6>
                                    <button class="btn btn-sm btn-outline-primary" onclick="loadVoucherViewStats()">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="voucher-view-stats" class="small">
                                        <p class="text-muted mb-0">ÌÜµÍ≥ÑÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .voucher-send-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .voucher-send-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
    </style>

    <!-- 5. Ï†ïÏÇ∞Ïù¥Í¥Ä Î™®Îã¨ -->
    <div class="modal fade" id="settlementModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-calculator me-2"></i>Ï†ïÏÇ∞Ïù¥Í¥Ä</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="settlement-reservation-id">
                    
                    <!-- ÏÉÅÌíàÏ†ïÎ≥¥ ÏöîÏïΩ -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>ÏÉÅÌíàÏ†ïÎ≥¥ ÏöîÏïΩ</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <strong>ÏòàÏïΩÏóÖÏ≤¥:</strong> <span id="settlement-platform-name">-</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>ÏÉÅÌíàÎ™Ö:</strong> <span id="settlement-product-name">-</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Ìå®ÌÇ§ÏßÄ:</strong> <span id="settlement-package-type">-</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Ïù¥Ïö©Ïùº:</strong> <span id="settlement-usage-date">-</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>ÏàòÎ∞∞ÏóÖÏ≤¥:</strong> <span id="settlement-vendor-name">-</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Ïù∏Ïõê:</strong> ÏÑ±Ïù∏ <span id="settlement-adult-count">0</span> / ÏÜåÏïÑ <span id="settlement-child-count">0</span> / Ïú†ÏïÑ <span id="settlement-infant-count">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Í±∞ÎûòÏï° (Î∞õÏùÑ Îèà) -->
                    <div class="card mb-3">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="bi bi-arrow-down me-2"></i>Í±∞ÎûòÏï° (Î∞õÏùÑ Îèà)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-2">
                                    <label class="form-label">ÌôîÌèê</label>
                                    <select class="form-select" id="settlement-sale-currency">
                                        <option value="KRW">ÏõêÌôî(‚Ç©)</option>
                                        <option value="USD">Îã¨Îü¨($)</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">ÏÑ±Ïù∏ ÌåêÎß§Í∞Ä</label>
                                    <input type="number" class="form-control" id="settlement-sale-adult" step="0.01" placeholder="0" onchange="calculateSettlement()">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">ÏÜåÏïÑ ÌåêÎß§Í∞Ä</label>
                                    <input type="number" class="form-control" id="settlement-sale-child" step="0.01" placeholder="0" onchange="calculateSettlement()">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Ïú†ÏïÑ ÌåêÎß§Í∞Ä</label>
                                    <input type="number" class="form-control" id="settlement-sale-infant" step="0.01" placeholder="0" onchange="calculateSettlement()">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Ï¥ù ÌåêÎß§Í∞Ä</label>
                                    <input type="number" class="form-control bg-light" id="settlement-total-sale" readonly>
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-3">
                                    <label class="form-label">ÏàòÏàòÎ£åÏú® (%)</label>
                                    <input type="number" class="form-control" id="settlement-commission-rate" step="0.01" placeholder="10" onchange="calculateSettlement()">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ÏàòÏàòÎ£åÍ∏àÏï°</label>
                                    <input type="number" class="form-control bg-light" id="settlement-commission-amount" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label"><strong>ÏûÖÍ∏àÎ∞õÏùÑÍ∏àÏï°</strong></label>
                                    <input type="number" class="form-control bg-warning fw-bold" id="settlement-net-revenue" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Îß§ÏûÖ (Ï§Ñ Îèà) -->
                    <div class="card mb-3">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0"><i class="bi bi-arrow-up me-2"></i>Îß§ÏûÖ (Ï§Ñ Îèà)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-2">
                                    <label class="form-label">ÌôîÌèê</label>
                                    <select class="form-select" id="settlement-cost-currency">
                                        <option value="USD">Îã¨Îü¨($)</option>
                                        <option value="KRW">ÏõêÌôî(‚Ç©)</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">ÏÑ±Ïù∏ ÏõêÍ∞Ä</label>
                                    <input type="number" class="form-control" id="settlement-cost-adult" step="0.01" placeholder="0" onchange="calculateSettlement()">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">ÏÜåÏïÑ ÏõêÍ∞Ä</label>
                                    <input type="number" class="form-control" id="settlement-cost-child" step="0.01" placeholder="0" onchange="calculateSettlement()">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Ïú†ÏïÑ ÏõêÍ∞Ä</label>
                                    <input type="number" class="form-control" id="settlement-cost-infant" step="0.01" placeholder="0" onchange="calculateSettlement()">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label"><strong>Ï¥ù ÏõêÍ∞Ä</strong></label>
                                    <input type="number" class="form-control bg-light fw-bold" id="settlement-total-cost" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÌôòÏú® Î∞è ÎßàÏßÑ Ï†ïÎ≥¥ -->
                    <div class="card mb-3">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>ÌôòÏú® Î∞è ÎßàÏßÑ</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">ÌôòÏú® (1 USD = ? KRW)</label>
                                    <input type="number" class="form-control" id="settlement-exchange-rate" step="0.01" placeholder="1330" onchange="calculateSettlement()">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Îß§ÏûÖ ÏõêÌôîÌôòÏÇ∞</label>
                                    <input type="number" class="form-control bg-light" id="settlement-cost-krw" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label"><strong>ÏòàÏÉÅ ÎßàÏßÑ (ÏõêÌôîÍ∏∞Ï§Ä)</strong></label>
                                    <input type="number" class="form-control bg-primary text-white fw-bold" id="settlement-margin-krw" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label"><strong>ÎßàÏßÑÏú® (%)</strong></label>
                                    <input type="number" class="form-control bg-primary text-white fw-bold" id="settlement-margin-rate" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Î©îÎ™® -->
                    <div class="card">
                        <div class="card-body">
                            <label class="form-label">Ï†ïÏÇ∞ Î©îÎ™®</label>
                            <textarea class="form-control" id="settlement-memo" rows="2" placeholder="Ï†ïÏÇ∞ Í¥ÄÎ†® Î©îÎ™®"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-outline-info" onclick="aiParsePriceRag()">
                        <i class="bi bi-robot me-1"></i>AI ÏöîÍ∏àÍ∞í ÌååÏã±
                    </button>
                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Ï∑®ÏÜå</button>
                    <button class="btn btn-primary" onclick="saveSettlementTransfer()">
                        <i class="bi bi-arrow-right me-1"></i>Ï†ïÏÇ∞Ïù¥Í¥Ä ÏôÑÎ£å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÌûàÏä§ÌÜ†Î¶¨ Î°úÍ∑∏ Î™®Îã¨ -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <div>
                        <h5 class="modal-title mb-1">
                            <i class="bi bi-clock-history me-2 text-primary"></i>ÏóÖÎ¨¥ ÌûàÏä§ÌÜ†Î¶¨ ÌÉÄÏûÑÎùºÏù∏
                        </h5>
                        <p class="text-muted small mb-0">Î™®Îì† ÏûëÏóÖ Ïù¥Î†•ÏùÑ ÏãúÍ∞ÑÏàúÏúºÎ°ú ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ Î≤îÎ°Ä -->
                    <div class="mb-4 p-3 bg-light rounded">
                        <div class="small fw-bold mb-2">üìå Ïπ¥ÌÖåÍ≥†Î¶¨ ÏïàÎÇ¥</div>
                        <div class="d-flex flex-wrap gap-3">
                            <span class="badge" style="background-color: #6366f1">
                                <i class="bi bi-calendar-check me-1"></i>ÏòàÏïΩ
                            </span>
                            <span class="badge" style="background-color: #0891b2">
                                <i class="bi bi-truck me-1"></i>ÏàòÎ∞∞
                            </span>
                            <span class="badge" style="background-color: #059669">
                                <i class="bi bi-ticket-perforated me-1"></i>Î∞îÏö∞Ï≤ò
                            </span>
                            <span class="badge" style="background-color: #dc2626">
                                <i class="bi bi-cash-coin me-1"></i>Ï†ïÏÇ∞
                            </span>
                            <span class="badge" style="background-color: #64748b">
                                <i class="bi bi-gear me-1"></i>ÏãúÏä§ÌÖú
                            </span>
                        </div>
                    </div>
                    
                    <!-- ÌûàÏä§ÌÜ†Î¶¨ Î¶¨Ïä§Ìä∏ -->
                    <div id="historyList">
                        <!-- ÌûàÏä§ÌÜ†Î¶¨ Ìï≠Î™©Îì§Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Îã´Í∏∞
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 1;
        let currentStatus = '';
        let currentSearch = '';

        // ÏµúÏã† USD ÌôòÏú® Í∞ÄÏ†∏Ïò§Í∏∞ (Ïù∏Î∞ïÏä§ÏôÄ ÎèôÏùº)
        async function fetchLatestExchangeRate() {
            try {
                const response = await fetch('/api/exchange-rates?currency=USD');
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    window.latestExchangeRate = result.data[0].rate;
                    console.log('üí± ÏµúÏã† USD ÌôòÏú®:', window.latestExchangeRate);
                } else {
                    window.latestExchangeRate = 1300; // Í∏∞Î≥∏Í∞í
                    console.warn('‚ö†Ô∏è ÌôòÏú® Ï°∞Ìöå Ïã§Ìå®, Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©:', window.latestExchangeRate);
                }
            } catch (error) {
                console.error('ÌôòÏú® Ï°∞Ìöå Ïò§Î•ò:', error);
                window.latestExchangeRate = 1300; // Í∏∞Î≥∏Í∞í
            }
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            // ÏµúÏã† ÌôòÏú® Í∞ÄÏ†∏Ïò§Í∏∞
            fetchLatestExchangeRate();
            
            loadAssignments();
            
            // ‚úÖ Î™®Îì† Î™®Îã¨Ïóê Îã´Ìûò Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä (ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ®)
            setupModalRefreshListeners();
            
            // ‚úÖ ÏòàÏïΩÌôïÏ†ï Î™®Îã¨ Ï¥àÍ∏∞Ìôî Ïù¥Î≤§Ìä∏
            const statusManageModal = document.getElementById('statusManageModal');
            if (statusManageModal) {
                statusManageModal.addEventListener('show.bs.modal', function() {
                    console.log('üîÑ ÏòàÏïΩÌôïÏ†ï Î™®Îã¨ Ïó¥Î¶º - Ìèº Ï¥àÍ∏∞Ìôî');
                    
                    // ÌôïÏ†ï Î∞©Ïãù ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
                    selectedConfirmationMethod = null;
                    document.querySelectorAll('.confirmation-method-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    
                    // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
                    document.getElementById('confirmation-number').value = '';
                    document.getElementById('qr-code-data').value = '';
                    document.getElementById('qr-code-image').value = '';
                    document.getElementById('vendor-voucher-file').value = '';
                    document.getElementById('confirmation-memo').value = '';
                    
                    // Ìèº Ïà®Í∏∞Í∏∞
                    document.querySelectorAll('.confirmation-form').forEach(form => {
                        form.style.display = 'none';
                    });
                    document.getElementById('confirmation-input-area').style.display = 'none';
                    document.getElementById('confirm-button').style.display = 'none';
                });
            }
        });

        // ÏàòÎ∞∞ Î™©Î°ù Î°úÎìú
        async function loadAssignments(page = 1) {
            try {
                console.log('üîç loadAssignments Ìò∏Ï∂ú - ÌéòÏù¥ÏßÄ:', page);
                currentPage = page;
                const params = new URLSearchParams({
                    page: page,
                    status: currentStatus,
                    search: currentSearch
                });

                const response = await fetch(`/api/assignments?${params}`);
                const data = await response.json();

                console.log('üìä ÏàòÎ∞∞Í¥ÄÎ¶¨ API ÏùëÎãµ - assignments Ïàò:', data.data?.assignments?.length);
                
                if (data.success) {
                    // Ï†ÑÏó≠ Î≥ÄÏàòÏóê Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                    window.reservations = data.data.assignments;
                    
                    renderAssignments(data.data.assignments);
                    
                    // ‚úÖ ÎßàÏßÄÎßâ ÏûëÏóÖÌïú ÏòàÏïΩ Í∞ïÏ°∞ (ÏÉàÎ°úÍ≥†Ïπ® ÌõÑÏóêÎèÑ Ïú†ÏßÄ)
                    setTimeout(() => {
                        const lastWorkingId = localStorage.getItem('lastWorkingReservation');
                        if (lastWorkingId) {
                            highlightSelectedReservation(lastWorkingId);
                            console.log('‚úÖ ÎßàÏßÄÎßâ ÏûëÏóÖ ÏòàÏïΩ Í∞ïÏ°∞:', lastWorkingId);
                        }
                    }, 100);
                } else {
                    console.error('API Ïò§Î•ò:', data.message);
                    showAlert('Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + data.message, 'danger');
                }
            } catch (error) {
                console.error('ÏàòÎ∞∞ Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                showAlert('ÏàòÎ∞∞ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'danger');
            }
        }

        // Ï†ÑÏó≠ ÏòàÏïΩ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•ÏÜå
        window.reservationsData = window.reservationsData || {};

        // ÏàòÎ∞∞Í¥ÄÎ¶¨ Î™©Î°ù Î†åÎçîÎßÅ (Ïπ¥Îìú ÌòïÌÉú)
        function renderAssignments(assignments) {
            const assignmentsList = document.getElementById('assignmentsList');
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            
            // Î°úÎî© ÏÉÅÌÉú Ïà®Í∏∞Í∏∞
            loadingState.style.display = 'none';
            
            if (assignments.length === 0) {
                assignmentsList.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            assignmentsList.style.display = 'block';

            console.log('üîÑ Î†åÎçîÎßÅ ÏãúÏûë - Ï¥ù ÏòàÏïΩ Ïàò:', assignments.length);
            
            const html = assignments.map(reservation => {
                // Ï†ÑÏó≠ Ï†ÄÏû•ÏÜåÏóê ÏòàÏïΩ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                window.reservationsData[reservation.id] = reservation;
                
                const statusClass = getStatusClass(reservation.payment_status);
                const statusText = getReservationStatusText(reservation.payment_status);
                const bootstrapClass = getBootstrapStatusClass(reservation.payment_status);
                const amount = reservation.total_amount ? parseInt(reservation.total_amount).toLocaleString('ko-KR') + 'Ïõê' : '-';
                const pax = `ÏÑ±Ïù∏ ${reservation.people_adult || 0} ÏïÑÎèô ${reservation.people_child || 0} Ïú†ÏïÑ ${reservation.people_infant || 0}`;
                
                // ÌäπÏàò ÏÉÅÌÉú Î±ÉÏßÄ Ï∂îÍ∞Ä
                const isInRevision = reservation.payment_status === 'in_revision';
                const isNewReservation = reservation.payment_status === 'pending';
                const isInProgress = reservation.payment_status === 'in_progress';
                
                // ÏÉÅÌÉúÎ≥Ñ Î±ÉÏßÄ Î∞è ÏïÑÏù¥ÏΩò ÎßàÌÅ¨
                let statusBadges = '';
                
                // Î≥ÄÍ≤ΩÏ§ë
                if (isInRevision) {
                    statusBadges += '<span class="badge bg-warning text-dark ms-2" style="font-size: 0.75rem;"><i class="bi bi-exclamation-triangle-fill me-1"></i>Î≥ÄÍ≤ΩÏ§ë</span>';
                }
                
                // Ïã†Í∑ú
                if (isNewReservation) {
                    statusBadges += '<span class="badge bg-danger ms-2" style="font-size: 0.75rem;"><i class="bi bi-star-fill me-1"></i>Ïã†Í∑ú</span>';
                }
                
                // ÏàòÎ∞∞ÏÑú Ïó¥Îûå ÏÉÅÌô© (ÏàòÎ∞∞ Î∞©Ïãù Íµ¨Î∂Ñ)
                if (reservation.assignment_token) {
                    if (reservation.viewed_at) {
                        // ‚úÖ Ïó¥ÎûåÎê®
                        statusBadges += '<span class="badge bg-success ms-2" style="font-size: 0.75rem;"><i class="bi bi-check-circle-fill me-1"></i>Ïó¥Îûå</span>';
                    } else if (reservation.sent_at) {
                        // üìß Ïù¥Î©îÏùº Ï†ÑÏÜ° (ÎØ∏Ïó¥Îûå)
                        statusBadges += '<span class="badge bg-warning text-dark ms-2" style="font-size: 0.75rem;"><i class="bi bi-envelope me-1"></i>Ïù¥Î©îÏùºÏ†ÑÏÜ°</span>';
                    } else {
                        // üîó ÎßÅÌÅ¨Îßå ÏÉùÏÑ± (Ïπ¥ÌÜ° Ï†ÑÎã¨Ïö©, ÎØ∏Ïó¥Îûå)
                        statusBadges += '<span class="badge bg-secondary ms-2" style="font-size: 0.75rem;"><i class="bi bi-link-45deg me-1"></i>ÎßÅÌÅ¨ÏÉùÏÑ±</span>';
                    }
                }
                
                // Î∞îÏö∞Ï≤ò Ïó¥Îûå ÏÉÅÌô©
                if (reservation.voucher_token) {
                    if (reservation.voucher_viewed_at) {
                        statusBadges += '<span class="badge bg-success ms-2" style="font-size: 0.75rem;"><i class="bi bi-eye-fill me-1"></i>Î∞îÏö∞Ï≤òÏó¥Îûå</span>';
                    } else if (reservation.voucher_sent_at) {
                        statusBadges += '<span class="badge bg-secondary ms-2" style="font-size: 0.75rem;"><i class="bi bi-eye-slash me-1"></i>Î∞îÏö∞Ï≤òÎØ∏Ïó¥Îûå</span>';
                    }
                }
                
                // Ïù¥Ïö©Ïùº ÏôÑÎ£å Ïó¨Î∂Ä ÌôïÏù∏
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const usageDate = reservation.usage_date ? new Date(reservation.usage_date) : null;
                const isUsageDatePassed = usageDate && usageDate < today;
                const passedClass = isUsageDatePassed ? 'bg-light-gray' : '';
                
                // ÏàòÏ†ïÏ§ë ÏÉÅÌÉúÎäî ÎÖ∏ÎûÄ ÌÖåÎëêÎ¶¨ + Ïó∞Ìïú ÎÖ∏Îûë Î∞∞Í≤Ω
                const revisionClass = isInRevision ? 'border-warning border-3' : (isNewReservation ? 'border-danger border-2' : '');
                const revisionBg = isInRevision ? 'style="background-color: #fffbf0;"' : '';
                
                // ÏòàÏïΩÏùºÏãú
                const createdAt = reservation.created_at ? formatDate(reservation.created_at) : '-';
                
                // ÌÖçÏä§Ìä∏ ÏûêÎ•¥Í∏∞ Ìï®Ïàò
                const truncate = (text, maxLength) => {
                    if (!text || text === '-') return text;
                    return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
                };
                
                // Îã¥ÎãπÏûê ÌëúÏãú (Îã¥Îãπ:000 ÌòïÏãù)
                const managerDisplay = reservation.assigned_to ? `Îã¥Îãπ:${truncate(reservation.assigned_to, 3)}` : 'Îã¥Îãπ:ÎØ∏ÏßÄÏ†ï';
                const customerDisplay = `Í≥†Í∞ù:${truncate(reservation.korean_name || '-', 3)}`;
                
                return `
                    <article class="row-card table-like ${revisionClass} ${passedClass}" data-reservation-id="${reservation.id}" ${revisionBg}>
                        <div class="d-flex align-items-center mb-3">
                            <span class="badge bg-${getBootstrapStatusClass(reservation.payment_status)} status-badge" style="font-size: 0.85rem; padding: 6px 12px;">${statusText}</span>
                            ${statusBadges}
                            ${isUsageDatePassed && reservation.payment_status === 'confirmed' ? '<span class="badge bg-info ms-2" style="font-size: 0.8rem; padding: 5px 10px;">üìã Ï†ïÏÇ∞ÎåÄÍ∏∞</span>' : ''}
                        </div>
                        <div class="row-main" style="flex-direction: column; gap: 10px;">
                            <!-- ÏúóÏ§Ñ: ÏãúÏä§ÌÖúÎ≤àÌò∏(ÏóÖÏ≤¥Î≤àÌò∏) / ÏòàÏïΩÏùº / Ï∂úÎ∞úÏùº / Í≥†Í∞ùÎ™Ö(Îã¥ÎãπÏûê) -->
                            <div style="display: flex; gap: 20px; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <i class="bi bi-hash" style="color: #1a73e8;"></i>
                                    <span style="font-size: 1rem; color: #212529; font-weight: 700;">${reservation.id}</span>
                                    <span style="font-size: 0.8rem; color: #6c757d;">(${truncate(reservation.reservation_number || '-', 12)})</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <i class="bi bi-calendar-check" style="color: #6c757d;"></i>
                                    <span style="font-size: 0.9rem; color: #6c757d;">${createdAt}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <i class="bi bi-calendar-event" style="color: #1a73e8;"></i>
                                    <span style="font-size: 0.95rem; color: #212529; font-weight: 600;">${formatDate(reservation.usage_date) || '-'}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px; margin-left: auto;">
                                    <span style="font-size: 1rem; color: #212529; font-weight: 600;">${reservation.korean_name || '-'}</span>
                                    <span style="font-size: 0.85rem; color: #6c757d;">(${reservation.assigned_to || 'ÎØ∏ÏßÄÏ†ï'})</span>
                                </div>
                            </div>
                            <!-- ÏïÑÎû´Ï§Ñ: ÏóÖÏ≤¥Î™Ö / ÏÉÅÌíàÎ™Ö(10Ïûê) / Ìå®ÌÇ§ÏßÄÌÉÄÏûÖ(6Ïûê) / ÏàòÎ∞∞ÏóÖÏ≤¥ / PAX -->
                            <div style="display: flex; gap: 12px; align-items: center; font-size: 0.9rem;">
                                <div style="color: #495057; font-weight: 500; min-width: 70px;">${truncate(reservation.platform_name || '-', 8)}</div>
                                <div style="color: #d1d5db;">|</div>
                                <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #6c757d; max-width: 180px;" title="${reservation.product_name || '-'}">${truncate(reservation.product_name || '-', 10)}</div>
                                <div style="color: #d1d5db;">|</div>
                                <div style="color: #6c757d; min-width: 70px;" title="${reservation.package_type || '-'}">${truncate(reservation.package_type || '-', 6)}</div>
                                <div style="color: #d1d5db;">|</div>
                                <div style="color: #6c757d;">${truncate(reservation.vendor_name || 'ÎØ∏ÏßÄÏ†ï', 10)}</div>
                                <div style="margin-left: auto; color: #495057; font-weight: 500;">${pax}</div>
                            </div>
                        </div>
                        <div class="btn-group btn-group-sm ms-auto" role="group">
                            <button class="btn btn-outline-primary btn-sm" 
                                    onclick="openReservationEditModal(${reservation.id})" 
                                    data-reservation-id="${reservation.id}"
                                    title="ÏòàÏïΩÎ≥ÄÍ≤Ω">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" 
                                    onclick="openAssignmentManageModal(${reservation.id})" 
                                    data-reservation-id="${reservation.id}"
                                    title="ÏàòÎ∞∞ÏÑúÍ¥ÄÎ¶¨">
                                <i class="bi bi-file-text"></i>
                            </button>
                            <button class="btn btn-outline-success btn-sm" 
                                    onclick="openStatusManageModal(${reservation.id})" 
                                    data-reservation-id="${reservation.id}"
                                    title="ÏÉÅÌÉúÍ¥ÄÎ¶¨">
                                <i class="bi bi-check-circle"></i>
                            </button>
                            <button class="btn btn-outline-info btn-sm" 
                                    onclick="openVoucherManageModal(${reservation.id})" 
                                    data-reservation-id="${reservation.id}"
                                    title="Î∞îÏö∞Ï≤òÍ¥ÄÎ¶¨">
                                <i class="bi bi-ticket-perforated"></i>
                            </button>
                            <button class="btn btn-outline-warning btn-sm" 
                                    onclick="openSettlementModal(${reservation.id})" 
                                    data-reservation-id="${reservation.id}"
                                    title="Ï†ïÏÇ∞Ïù¥Í¥Ä">
                                <i class="bi bi-calculator"></i>
                            </button>
                            <button class="btn btn-outline-dark btn-sm" 
                                    onclick="openHistoryModal(${reservation.id})" 
                                    data-reservation-id="${reservation.id}"
                                    title="ÏóÖÎ¨¥ÌûàÏä§ÌÜ†Î¶¨">
                                <i class="bi bi-clock-history"></i>
                            </button>
                        </div>
                    </article>
                `;
            }).join('');
            
            console.log('‚úÖ HTML ÏÉùÏÑ± ÏôÑÎ£å - Í∏∏Ïù¥:', html.length);
            assignmentsList.innerHTML = html;
            console.log('‚úÖ Î†åÎçîÎßÅ ÏôÑÎ£å');
            
            // ÌíãÌÑ∞ ÏÉÅÌÉú ÏöîÏïΩ ÏóÖÎç∞Ïù¥Ìä∏
            updateFooterSummary(assignments);
        }
        
        // ÌíãÌÑ∞ ÏÉÅÌÉú ÏöîÏïΩ ÏóÖÎç∞Ïù¥Ìä∏
        function updateFooterSummary(assignments) {
            const statusCount = {
                in_revision: 0,
                pending: 0,
                in_progress: 0,
                confirmed: 0,
                voucher_sent: 0
            };
            
            assignments.forEach(r => {
                if (statusCount.hasOwnProperty(r.payment_status)) {
                    statusCount[r.payment_status]++;
                }
            });
            
            document.getElementById('totalCount').textContent = `Ï¥ù ${assignments.length}Í∞ú`;
            
            let summaryText = '';
            if (statusCount.in_revision > 0) summaryText += `Î≥ÄÍ≤Ω ${statusCount.in_revision} ¬∑ `;
            summaryText += `Ïã†Í∑ú ${statusCount.pending} ¬∑ ÏàòÎ∞∞Ï§ë ${statusCount.in_progress} ¬∑ ÌôïÏ†ï ${statusCount.confirmed}`;
            if (statusCount.voucher_sent > 0) summaryText += ` ¬∑ Î∞îÏö∞Ï≤ò ${statusCount.voucher_sent}`;
            
            document.getElementById('statusSummary').textContent = summaryText;
        }

        // Í≤ÄÏÉâ Ìï®Ïàò
        function searchAssignments() {
            const company = document.getElementById('searchCompany').value;
            const product = document.getElementById('searchProduct').value;
            const customer = document.getElementById('searchCustomer').value;
            const status = document.getElementById('searchStatus').value;
            
            currentStatus = status;
            currentSearch = [company, product, customer].filter(s => s.trim()).join(' ');
            
            loadAssignments(1);
        }

        // Í≤ÄÏÉâ Ï¥àÍ∏∞Ìôî
        function clearSearch() {
            document.getElementById('searchCompany').value = '';
            document.getElementById('searchProduct').value = '';
            document.getElementById('searchCustomer').value = '';
            document.getElementById('searchDepartureDate').value = '';
            document.getElementById('searchStatus').value = '';
            document.getElementById('searchVendor').value = '';
            
            currentStatus = '';
            currentSearch = '';
            
            loadAssignments(1);
        }

        // ÌïÑÌÑ∞ ÌÜ†Í∏Ä Ìï®Ïàò
        function toggleFilters() {
            const filterPanel = document.getElementById('filterPanel');
            if (filterPanel.style.display === 'none') {
                filterPanel.style.display = 'block';
            } else {
                filterPanel.style.display = 'none';
            }
        }

        // ÏÉàÎ°úÏö¥ ÎîîÏûêÏù∏Ïö© Î™®Îã¨ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
        document.addEventListener('DOMContentLoaded', function() {
            // Î™®Îã¨ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
            const manageModal = document.getElementById('manageModal');
            if (manageModal) {
                manageModal.addEventListener('show.bs.modal', function(e) {
                    const btn = e.relatedTarget;
                    const payload = btn?.getAttribute('data-resv');
                    if (!payload) return;
                    
                    try {
                        const r = JSON.parse(payload);
                        document.getElementById('m-status').textContent = r.status || '-';
                        document.getElementById('m-id').textContent = r.id || '-';
                        document.getElementById('m-vendor').textContent = r.vendor || '-';
                        document.getElementById('m-guest').textContent = r.guest || '-';
                        document.getElementById('m-product').textContent = r.product || '-';
                        document.getElementById('m-dates').textContent = (r.dep || '-') + ' / ' + (r.use || '-');
                        const paxText = `ÏÑ±Ïù∏ ${r.pax?.adult ?? '-'}Î™Ö, ÏïÑÎèô ${r.pax?.child ?? '-'}Î™Ö`;
                        document.getElementById('m-pax').textContent = paxText;
                        document.getElementById('m-handler').textContent = r.handler || '-';
                        const amount = (typeof r.amount === 'number') ? r.amount.toLocaleString('ko-KR') + 'Ïõê' : '-';
                        document.getElementById('m-amount').textContent = amount;
                        document.getElementById('m-brief').textContent = `${r.vendor ?? ''} / ${r.guest ?? ''} / ${r.product ?? ''}`.trim();

                        // ÏòàÏïΩÎ≥ÄÍ≤Ω ÌÉ≠ Ï¥àÍ∏∞Í∞í
                        document.getElementById('f-guest').value = r.guest || '';
                        document.getElementById('f-adult').value = r.pax?.adult ?? 0;
                        document.getElementById('f-child').value = r.pax?.child ?? 0;
                        document.getElementById('f-dep').value = r.dep || '';
                        document.getElementById('f-product').value = r.product || '';
                        document.getElementById('f-handler').value = r.handler || '';

                        // ÏÉÅÌÉú/Ïª®Ìéå ÌÉ≠ Ï¥àÍ∏∞Í∞í
                        const statusSelect = document.getElementById('f-status');
                        if (statusSelect) statusSelect.value = r.status || 'ÏàòÎ∞∞Ï§ë(ÌòÑÏßÄÏàòÎ∞∞)';
                        
                        const confirmInput = document.getElementById('f-confirm');
                        if (confirmInput) confirmInput.value = r.confirmNo || '';

                    } catch (err) {
                        console.warn('ÏòàÏïΩ Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ïò§Î•ò', err);
                    }
                });
            }
        });


        // ÏàòÎ∞∞ÏÑú ÏàòÏ†ï
        function editAssignment() {
            showAlert('ÏàòÎ∞∞ÏÑú ÏàòÏ†ï Í∏∞Îä•ÏùÄ Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§.', 'info');
        }

        // ÏàòÎ∞∞ÏÑú Ï†ÑÏÜ° (Ïù¥Î©îÏùº Ìè¨Ìï®)
        async function sendAssignmentWithEmail() {
            const reservation = window.currentReservation;
            if (!reservation) {
                alert('ÏòàÏïΩ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            console.log('üìß ÏàòÎ∞∞ÏÑú Ïù¥Î©îÏùº Ï†ÑÏÜ° ÏãúÏûë');
            console.log('üìã ÏòàÏïΩ Ï†ïÎ≥¥:', reservation);
            console.log('üìß vendor_email:', reservation.vendor_email);
            console.log('üè¢ vendor_name:', reservation.vendor_name);
            console.log('üÜî vendor_id:', reservation.vendor_id);
            
            // ÏàòÎ∞∞ÏÑú ÏÉùÏÑ± Ïó¨Î∂Ä ÌôïÏù∏
            if (!reservation.assignment_token) {
                alert('ÏàòÎ∞∞ÏÑúÎ•º Î®ºÏ†Ä ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            // ÏàòÎ∞∞ÏóÖÏ≤¥ Ïù¥Î©îÏùº ÌôïÏù∏
            const vendorEmail = reservation.vendor_email || '';
            
            if (!vendorEmail || vendorEmail.trim() === '') {
                alert(`‚ùå ÏàòÎ∞∞ÏóÖÏ≤¥ Ïù¥Î©îÏùºÏù¥ Îì±Î°ùÎêòÏñ¥ ÏûàÏßÄ ÏïäÏäµÎãàÎã§.\n\nÏàòÎ∞∞ÏóÖÏ≤¥: ${reservation.vendor_name || 'ÎØ∏ÏßÄÏ†ï'}\n\n[ÏÑ§Ï†ï > ÏàòÎ∞∞ÏóÖÏ≤¥ Í¥ÄÎ¶¨]ÏóêÏÑú Ïù¥Î©îÏùºÏùÑ Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî.`);
                return;
            }
            
            // ÌôïÏù∏ Î©îÏãúÏßÄ
            const confirmMessage = `ÏàòÎ∞∞ÏóÖÏ≤¥ Ïù¥Î©îÏùºÎ°ú ÏàòÎ∞∞ÏÑúÎ•º Ï†ÑÏÜ°ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏàòÏã†Ïûê: ${vendorEmail}\nÏóÖÏ≤¥Î™Ö: ${reservation.vendor_name || 'ÎØ∏ÏßÄÏ†ï'}\n\n‚Ä¢ AIÍ∞Ä Ï†ïÏ§ëÌïú Ïù¥Î©îÏùº Î¨∏Íµ¨Î•º ÏûêÎèô ÏÉùÏÑ±Ìï©ÎãàÎã§\n‚Ä¢ ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨Í∞Ä Ìè¨Ìï®Îê©ÎãàÎã§\n‚Ä¢ Ïù¥Î©îÏùº Î∞úÏÜ° ÌõÑ Ï†ÑÏÜ° ÏÉÅÌÉúÍ∞Ä ÏóÖÎç∞Ïù¥Ìä∏Îê©ÎãàÎã§`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/assignments/${reservation.id}/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sendEmail: true
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.emailSent) {
                        alert(`‚úÖ ÏàòÎ∞∞ÏÑúÍ∞Ä Ïù¥Î©îÏùºÎ°ú Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§!\n\nÏàòÏã†Ïûê: ${result.recipientEmail}\n\nÏàòÎ∞∞ÏóÖÏ≤¥Í∞Ä Ïù¥Î©îÏùºÏùÑ ÌôïÏù∏ÌïòÎ©¥ Ïó¥Îûå ÌÜµÍ≥ÑÏóêÏÑú ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.`);
                        // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                        loadAssignments(currentPage);
                        // Î™®Îã¨ Ï†ïÎ≥¥ ÏÉàÎ°úÍ≥†Ïπ®
                        if (window.currentReservationId) {
                            setTimeout(() => {
                                loadAssignmentDetails(window.currentReservationId);
                            }, 500);
                        }
                    } else {
                        alert(`‚ö†Ô∏è ${result.message}\n\nÏù¥Î©îÏùºÏù¥ Î∞úÏÜ°ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. ÏàòÎ∞∞ÏóÖÏ≤¥ Ïù¥Î©îÏùºÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.`);
                    }
                } else {
                    alert('ÏàòÎ∞∞ÏÑú Ï†ÑÏÜ° Ïã§Ìå®: ' + result.message);
                }
                
            } catch (error) {
                console.error('ÏàòÎ∞∞ÏÑú Ï†ÑÏÜ° Ïò§Î•ò:', error);
                alert('ÏàòÎ∞∞ÏÑú Ï†ÑÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        // ÏàòÎ∞∞ÏÑú Îã§Ïö¥Î°úÎìú
        function downloadAssignment() {
            showAlert('ÏàòÎ∞∞ÏÑú Îã§Ïö¥Î°úÎìú Í∏∞Îä•ÏùÄ Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§.', 'info');
        }

        // ÏàòÎ∞∞ÏÑú ÏïÑÏù¥ÏΩò ÌÅ¥ÎûòÏä§ Í≤∞Ï†ï
        function getAssignmentIconClass(reservation) {
            // ÏàòÎ∞∞ÏÑú ÏÉÅÌÉúÏóê Îî∞Î•∏ ÏïÑÏù¥ÏΩò ÏÉâÏÉÅ
            if (reservation.assignment_status === 'confirmed' || reservation.confirmation_number) {
                return 'btn-primary'; // ÌååÎûÄÏÉâ - ÌôïÏ†ï ÏôÑÎ£å
            } else if (reservation.assignment_status === 'sent' || reservation.assignment_token) {
                return 'btn-warning'; // ÎÖ∏ÎûÄÏÉâ - Ï†ÑÏÜ° ÏôÑÎ£å
            } else {
                return 'btn-outline-secondary'; // Ìà¨Î™Ö - ÎØ∏ÏÉùÏÑ±/ÎØ∏Ï†ÑÏÜ°
            }
        }

        // ÏàòÎ∞∞ÏÑú Ìà¥ÌåÅ ÌÖçÏä§Ìä∏ Í≤∞Ï†ï
        function getAssignmentTooltip(reservation) {
            if (reservation.assignment_status === 'confirmed' || reservation.confirmation_number) {
                return 'ÏàòÎ∞∞ÏÑú ÌôïÏ†ï ÏôÑÎ£å - ÌÅ¥Î¶≠ÌïòÏó¨ ÌôïÏ†ï Ï†ïÎ≥¥ Î≥¥Í∏∞';
            } else if (reservation.assignment_status === 'sent' || reservation.assignment_token) {
                return 'ÏàòÎ∞∞ÏÑú Ï†ÑÏÜ° ÏôÑÎ£å - ÌÅ¥Î¶≠ÌïòÏó¨ Ï†ÑÏÜ° Î°úÍ∑∏ Î≥¥Í∏∞';
            } else {
                return 'ÏàòÎ∞∞ÏÑú ÏÉùÏÑ±/Ï†ÑÏÜ° - ÌÅ¥Î¶≠ÌïòÏó¨ ÏàòÎ∞∞ÏÑú Í¥ÄÎ¶¨';
            }
        }

        // ÏàòÎ∞∞ÏÑú Î≥¥Í∏∞ (Î™®Îã¨)
        function viewAssignment(reservationId) {
            console.log('üîç ÏàòÎ∞∞ÏÑú Î≥¥Í∏∞ ÏöîÏ≤≠:', reservationId);
            
            // Ï†ÑÏó≠ reservations Î∞∞Ïó¥ÏóêÏÑú ÏòàÏïΩ Ï†ïÎ≥¥ Ï°∞Ìöå
            let reservation = null;
            if (window.reservations && Array.isArray(window.reservations)) {
                reservation = window.reservations.find(r => r.id === reservationId);
            }
            
            // Ï†ÑÏó≠ Î∞∞Ïó¥ÏóêÏÑú Ï∞æÏßÄ Î™ªÌñàÎã§Î©¥ ÌòÑÏû¨ ÌéòÏù¥ÏßÄÏùò Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Ï∞æÍ∏∞
            if (!reservation && typeof reservations !== 'undefined') {
                reservation = reservations.find(r => r.id === reservationId);
            }
            
            // Í∑∏ÎûòÎèÑ ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
            if (!reservation) {
                console.warn('ÏòàÏïΩ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏñ¥ Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©:', reservationId);
                reservation = {
                    id: reservationId,
                    korean_name: 'Ï†ïÎ≥¥ÏóÜÏùå',
                    platform_name: 'Ï†ïÎ≥¥ÏóÜÏùå',
                    product_name: 'Ï†ïÎ≥¥ÏóÜÏùå',
                    package_type: 'Ï†ïÎ≥¥ÏóÜÏùå',
                    vendor_name: 'ÎØ∏ÏßÄÏ†ï',
                    payment_status: 'pending',
                    confirmation_number: null,
                    assignment_status: null,
                    assignment_token: null
                };
            }
            
            // ÏÉÅÌÉúÎ≥Ñ Î™®Îã¨ Î≤ÑÌäº Íµ¨ÏÑ±
            let modalButtons = '';
            if (reservation.assignment_status === 'confirmed' || reservation.confirmation_number) {
                // ÌååÎûÄÏÉâ - ÌôïÏ†ï ÏôÑÎ£å ÏÉÅÌÉú
                modalButtons = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
                    <button type="button" class="btn btn-primary" onclick="printAssignment()">
                        <i class="bi bi-printer me-1"></i>Ïù∏ÏáÑ
                    </button>
                    <button type="button" class="btn btn-success" onclick="createVoucher(${reservationId})">
                        <i class="bi bi-ticket-perforated me-1"></i>Î∞îÏö∞Ï≤ò ÏÉùÏÑ±
                    </button>
                `;
            } else if (reservation.assignment_status === 'sent' || reservation.assignment_token) {
                // ÎÖ∏ÎûÄÏÉâ - Ï†ÑÏÜ° ÏôÑÎ£å ÏÉÅÌÉú
                modalButtons = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
                    <button type="button" class="btn btn-outline-primary" onclick="saveAssignmentFile(${reservationId})">
                        <i class="bi bi-download me-1"></i>ÌååÏùºÏ†ÄÏû•
                    </button>
                    <button type="button" class="btn btn-primary" onclick="printAssignment()">
                        <i class="bi bi-printer me-1"></i>Ïù∏ÏáÑ
                    </button>
                    <button type="button" class="btn btn-warning" onclick="resendAssignment(${reservationId})">
                        <i class="bi bi-send me-1"></i>Ïû¨Ï†ÑÏÜ°
                    </button>
                    <button type="button" class="btn btn-info" onclick="sendAssignmentLink(${reservationId})">
                        <i class="bi bi-link-45deg me-1"></i>ÎßÅÌÅ¨Ï†ÑÏÜ°
                    </button>
                `;
            } else {
                // Ìà¨Î™Ö - ÎØ∏ÏÉùÏÑ±/ÎØ∏Ï†ÑÏÜ° ÏÉÅÌÉú
                modalButtons = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
                    <button type="button" class="btn btn-success" onclick="saveAndSendAssignment(${reservationId})">
                        <i class="bi bi-save me-1"></i>Ï†ÄÏû•ÌïòÍ∏∞
                    </button>
                    <button type="button" class="btn btn-primary" onclick="sendAssignmentNow(${reservationId})">
                        <i class="bi bi-send me-1"></i>Ï†ÑÏÜ°ÌïòÍ∏∞
                    </button>
                `;
            }
            
            // ÏàòÎ∞∞ÏÑú Î™®Îã¨ HTML ÏÉùÏÑ±
            const modalHtml = `
                <div class="modal fade" id="assignmentViewModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="bi bi-file-text me-2"></i>ÏàòÎ∞∞ÏÑú Í¥ÄÎ¶¨ - ${reservation.korean_name || reservation.platform_name}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <!-- ÏàòÎ∞∞ÏÑú ÎÇ¥Ïö© ÏßÅÏ†ë ÌëúÏãú -->
                                        <div class="card">
                                            <div class="card-header bg-primary text-white">
                                                <h5 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>ÏàòÎ∞∞ÏÑú</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <h6 class="text-primary"><i class="bi bi-person me-1"></i>Í≥†Í∞ù Ï†ïÎ≥¥</h6>
                                                        <table class="table table-sm table-borderless">
                                                            <tr><td class="fw-bold">ÏÑ±Î™Ö:</td><td>${reservation.korean_name || reservation.platform_name || '-'}</td></tr>
                                                            <tr><td class="fw-bold">Ïó∞ÎùΩÏ≤ò:</td><td>${reservation.phone || '-'}</td></tr>
                                                            <tr><td class="fw-bold">Ïù¥Î©îÏùº:</td><td>${reservation.email || '-'}</td></tr>
                                                            <tr><td class="fw-bold">Ïù∏Ïõê:</td><td>${reservation.people_adult || 0}Î™Ö (ÏÑ±Ïù∏) ${reservation.people_child ? `+ ${reservation.people_child}Î™Ö (ÏïÑÎèô)` : ''}</td></tr>
                                                        </table>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h6 class="text-success"><i class="bi bi-calendar-event me-1"></i>ÏòàÏïΩ Ï†ïÎ≥¥</h6>
                                                        <table class="table table-sm table-borderless">
                                                            <tr><td class="fw-bold">ÏòàÏïΩÎ≤àÌò∏:</td><td class="text-primary">${reservation.id}</td></tr>
                                                            <tr><td class="fw-bold">Ïù¥Ïö©Ïùº:</td><td>${reservation.usage_date ? new Date(reservation.usage_date).toLocaleDateString('ko-KR') : '-'}</td></tr>
                                                            <tr><td class="fw-bold">Í≤∞Ï†úÍ∏àÏï°:</td><td class="text-danger fw-bold">${reservation.total_amount ? reservation.total_amount.toLocaleString() : '0'}Ïõê</td></tr>
                                                            <tr><td class="fw-bold">ÏÉÅÌÉú:</td><td><span class="badge bg-${getBootstrapStatusClass(reservation.payment_status)}">${getStatusText(reservation.payment_status)}</span></td></tr>
                                                        </table>
                                                    </div>
                                                </div>
                                                
                                                <div class="row mb-3">
                                                    <div class="col-12">
                                                        <h6 class="text-info"><i class="bi bi-box me-1"></i>ÏÉÅÌíà Ï†ïÎ≥¥</h6>
                                                        <div class="alert alert-light">
                                                            <div class="row">
                                                                <div class="col-md-8">
                                                                    <h5 class="text-success mb-2">${reservation.product_name || 'ÏÉÅÌíàÎ™Ö ÏóÜÏùå'}</h5>
                                                                    ${reservation.package_type ? `<p class="mb-1"><strong>Ìå®ÌÇ§ÏßÄ ÌÉÄÏûÖ:</strong> <span class="badge bg-info">${reservation.package_type}</span></p>` : ''}
                                                                    ${reservation.product_description ? `<p class="mb-0 text-muted">${reservation.product_description}</p>` : ''}
                                                                </div>
                                                                <div class="col-md-4 text-end">
                                                                    <p class="mb-1"><strong>ÏàòÎ∞∞ÏóÖÏ≤¥:</strong></p>
                                                                    <span class="badge bg-warning text-dark">${reservation.vendor_name || 'ÎØ∏ÏßÄÏ†ï'}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                ${reservation.confirmation_number ? `
                                                <div class="row mb-3">
                                                    <div class="col-12">
                                                        <div class="alert alert-success">
                                                            <h6><i class="bi bi-check-circle me-1"></i>ÌôïÏ†ï Ï†ïÎ≥¥</h6>
                                                            <p class="mb-0"><strong>Ïª®ÌéåÎ≤àÌò∏:</strong> <span class="fw-bold">${reservation.confirmation_number}</span></p>
                                                        </div>
                                                    </div>
                                                </div>
                                                ` : ''}

                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0"><i class="bi bi-info-circle me-1"></i>ÏàòÎ∞∞ Ï†ïÎ≥¥</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="assignmentInfo">
                                                    <p><strong>ÏÉÅÌíàÎ™Ö:</strong> ${reservation.product_name || '-'}</p>
                                                    <p><strong>Ìå®ÌÇ§ÏßÄÌÉÄÏûÖ:</strong> <span class="text-primary">${reservation.package_type || 'Ï†ïÎ≥¥ÏóÜÏùå'}</span></p>
                                                    <p><strong>ÏàòÎ∞∞ÏóÖÏ≤¥:</strong> ${reservation.vendor_name || 'ÎØ∏ÏßÄÏ†ï'}</p>
                                                    <p><strong>ÏÉÅÌÉú:</strong> <span class="badge bg-${getBootstrapStatusClass(reservation.payment_status)}">${getStatusText(reservation.payment_status)}</span></p>
                                                    ${reservation.confirmation_number ? `<p><strong>Ïª®ÌéåÎ≤àÌò∏:</strong> <span class="text-success">${reservation.confirmation_number}</span></p>` : ''}
                                                </div>
                                                <hr>
                                                <div id="assignmentLogs">
                                                    <h6><i class="bi bi-clock-history me-1"></i>Ï≤òÎ¶¨ Î°úÍ∑∏</h6>
                                                    <div id="logContainer" style="max-height: 200px; overflow-y: auto;">
                                                        <small class="text-muted">Î°úÍ∑∏Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                ${modalButtons}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Í∏∞Ï°¥ Î™®Îã¨ Ï†úÍ±∞
            const existingModal = document.getElementById('assignmentViewModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // ÏÉà Î™®Îã¨ Ï∂îÍ∞Ä
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Î™®Îã¨ ÌëúÏãú
            const modal = new bootstrap.Modal(document.getElementById('assignmentViewModal'));
            modal.show();
            
            // Î°úÍ∑∏Îßå Î°úÎìú (ÏàòÎ∞∞ÏÑúÎäî Ïù¥ÎØ∏ ÌëúÏãúÎê®)
            loadAssignmentLogs(reservationId);
        }

        // ÏàòÎ∞∞ Î°úÍ∑∏ Î°úÎìú
        async function loadAssignmentLogs(reservationId) {
            try {
                const response = await fetch(`/api/assignments/logs/${reservationId}`);
                const data = await response.json();
                
                const logContainer = document.getElementById('logContainer');
                if (data.success && data.logs.length > 0) {
                    logContainer.innerHTML = data.logs.map(log => `
                        <div class="mb-2 p-2 border-start border-3 border-${log.type === 'success' ? 'success' : log.type === 'error' ? 'danger' : 'info'}">
                            <small class="text-muted">${formatDateTime(log.created_at)}</small>
                            <div class="fw-bold">${log.action}</div>
                            ${log.details ? `<small class="text-muted">${log.details}</small>` : ''}
                        </div>
                    `).join('');
                } else {
                    logContainer.innerHTML = '<small class="text-muted">Ï≤òÎ¶¨ Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§.</small>';
                }
            } catch (error) {
                console.error('Î°úÍ∑∏ Î°úÎìú Ïã§Ìå®:', error);
                document.getElementById('logContainer').innerHTML = '<small class="text-danger">Î°úÍ∑∏ Î°úÎìú Ïã§Ìå®</small>';
            }
        }

        // ÏàòÎ∞∞ÏÑú Ï†ÄÏû•ÌïòÍ∏∞
        async function saveAndSendAssignment(reservationId) {
            try {
                const response = await fetch(`/api/assignments/${reservationId}/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                
                if (result.success) {
                    showAlert('ÏàòÎ∞∞ÏÑúÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.', 'success');
                    loadAssignments(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                    bootstrap.Modal.getInstance(document.getElementById('assignmentViewModal')).hide();
                } else {
                    showAlert(result.message || 'ÏàòÎ∞∞ÏÑú Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                }
            } catch (error) {
                console.error('ÏàòÎ∞∞ÏÑú Ï†ÄÏû• Ïã§Ìå®:', error);
                showAlert('ÏàòÎ∞∞ÏÑú Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        // ÏàòÎ∞∞ÏÑú Ï†ÑÏÜ°ÌïòÍ∏∞
        async function sendAssignmentNow(reservationId) {
            try {
                const response = await fetch(`/api/assignments/${reservationId}/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                
                if (result.success) {
                    showAlert('‚úÖ ÏàòÎ∞∞ÏÑúÍ∞Ä Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§!', 'success');
                    loadAssignments(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                    loadAssignmentLogs(reservationId); // ÏàòÎ∞∞ÏÑú Î°úÍ∑∏ ÏÉàÎ°úÍ≥†Ïπ®
                } else {
                    showAlert(result.message || 'ÏàòÎ∞∞ÏÑú Ï†ÑÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                }
            } catch (error) {
                console.error('ÏàòÎ∞∞ÏÑú Ï†ÑÏÜ° Ïã§Ìå®:', error);
                showAlert('ÏàòÎ∞∞ÏÑú Ï†ÑÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        // ÏàòÎ∞∞ÏÑú Ïû¨Ï†ÑÏÜ°
        async function resendAssignment(reservationId) {
            if (!confirm('ÏàòÎ∞∞ÏÑúÎ•º Ïû¨Ï†ÑÏÜ°ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            try {
                const response = await fetch(`/api/assignments/${reservationId}/resend`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                
                if (result.success) {
                    showAlert('ÏàòÎ∞∞ÏÑúÍ∞Ä Ïû¨Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§.', 'success');
                    loadAssignmentLogs(reservationId); // Î°úÍ∑∏ ÏÉàÎ°úÍ≥†Ïπ®
                } else {
                    showAlert(result.message || 'ÏàòÎ∞∞ÏÑú Ïû¨Ï†ÑÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                }
            } catch (error) {
                console.error('ÏàòÎ∞∞ÏÑú Ïû¨Ï†ÑÏÜ° Ïã§Ìå®:', error);
                showAlert('ÏàòÎ∞∞ÏÑú Ïû¨Ï†ÑÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        // ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨ ÏÉùÏÑ± Î∞è ÌëúÏãú
        async function sendAssignmentLink(reservationId) {
            try {
                // ÌÜ†ÌÅ∞ ÏÉùÏÑ± Î∞è ÎßÅÌÅ¨ ÏÉùÏÑ±
                const response = await fetch(`/api/assignments/${reservationId}/generate-link`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                
                if (result.success && result.link) {
                    // ÎßÅÌÅ¨Î•º Î™®Îã¨Ïóê ÌëúÏãú
                    const linkSection = document.getElementById('assignmentLinkSection');
                    const linkInput = document.getElementById('assignmentLinkInput');
                    
                    if (linkSection && linkInput) {
                        linkInput.value = result.link;
                        linkSection.style.display = 'block';
                    }
                    
                    showAlert('ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§. ÎßÅÌÅ¨Î•º Î≥µÏÇ¨ÌïòÏó¨ Ï†ÑÏÜ°ÌïòÏÑ∏Ïöî.', 'success');
                    loadAssignmentLogs(reservationId); // Î°úÍ∑∏ ÏÉàÎ°úÍ≥†Ïπ®
                } else {
                    showAlert(result.message || 'ÎßÅÌÅ¨ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                }
            } catch (error) {
                console.error('ÎßÅÌÅ¨ ÏÉùÏÑ± Ïã§Ìå®:', error);
                showAlert('ÎßÅÌÅ¨ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        // ÏàòÎ∞∞ÏÑú ÌååÏùº Ï†ÄÏû•
        async function saveAssignmentFile(reservationId) {
            try {
                const response = await fetch(`/api/assignments/${reservationId}/download`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ÏàòÎ∞∞ÏÑú_${reservationId}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showAlert('ÏàòÎ∞∞ÏÑú ÌååÏùºÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.', 'success');
                } else {
                    showAlert('ÌååÏùº Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                }
            } catch (error) {
                console.error('ÌååÏùº Ï†ÄÏû• Ïã§Ìå®:', error);
                showAlert('ÌååÏùº Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        // Î∞îÏö∞Ï≤ò ÏÉùÏÑ±
        async function createVoucher(reservationId) {
            try {
                const response = await fetch(`/api/reservations/${reservationId}/voucher`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Î∞îÏö∞Ï≤òÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.', 'success');
                    loadAssignments(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                } else {
                    showAlert(result.message || 'Î∞îÏö∞Ï≤ò ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                }
            } catch (error) {
                console.error('Î∞îÏö∞Ï≤ò ÏÉùÏÑ± Ïã§Ìå®:', error);
                showAlert('Î∞îÏö∞Ï≤ò ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        // ÎÇ†ÏßúÏãúÍ∞Ñ Ìè¨Îß∑ÌåÖ
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR');
        }

        // ÏÉÅÌÉú ÌÖçÏä§Ìä∏ Î≥ÄÌôò
        function getStatusText(status) {
            const statusMap = {
                'pending': 'ÎåÄÍ∏∞Ï§ë',
                'in_progress': 'ÏàòÎ∞∞Ï§ë', 
                'confirmed': 'ÌôïÏ†ï',
                'voucher_sent': 'Î∞îÏö∞Ï≤òÏ†ÑÏÜ°ÏôÑÎ£å',
                'cancelled': 'Ï∑®ÏÜå',
                'refunded': 'ÌôòÎ∂à'
            };
            return statusMap[status] || status;
        }

        // Bootstrap ÏÉÅÌÉú ÌÅ¥ÎûòÏä§ Î≥ÄÌôò
        function getBootstrapStatusClass(status) {
            const classMap = {
                'pending': 'warning',
                'in_progress': 'info',
                'confirmed': 'success', 
                'voucher_sent': 'primary',
                'cancelled': 'danger',
                'refunded': 'secondary'
            };
            return classMap[status] || 'secondary';
        }

        // ÏàòÎ∞∞ÏÑú Ïù∏ÏáÑ
        function printAssignment() {
            // Î™®Îã¨ ÎÇ¥Ïö©ÏùÑ Ïù∏ÏáÑ
            const modalBody = document.querySelector('#assignmentViewModal .modal-body');
            if (modalBody) {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>ÏàòÎ∞∞ÏÑú</title>
                            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                            <style>
                                @media print {
                                    .no-print { display: none !important; }
                                    body { font-size: 12px; }
                                }
                            </style>
                        </head>
                        <body>
                            ${modalBody.innerHTML}
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            } else {
                showAlert('ÏàòÎ∞∞ÏÑúÎ•º Î®ºÏ†Ä Î°úÎìúÌï¥Ï£ºÏÑ∏Ïöî.', 'warning');
            }
        }

        // ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨ Î≥µÏÇ¨
        async function copyAssignmentLink() {
            try {
                // Î®ºÏ†Ä ÏàòÎ∞∞ÏÑú ÌÜ†ÌÅ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                if (!window.currentReservationId) {
                    showAlert('ÏòàÏïΩ Ï†ïÎ≥¥Í∞Ä ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.', 'warning');
                    return;
                }
                
                console.log('üîó ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨ Î≥µÏÇ¨ ÏãúÏûë - reservationId:', window.currentReservationId);
                
                const response = await fetch(`/api/assignments/by-reservation/${window.currentReservationId}`);
                const result = await response.json();
                
                console.log('üìä API ÏùëÎãµ:', result);
                
                let linkUrl = '';
                let assignmentToken = '';
                
                // assignment Í∞ùÏ≤¥ÏóêÏÑú ÌÜ†ÌÅ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                if (result.success && result.assignment && result.assignment.assignment_token) {
                    assignmentToken = result.assignment.assignment_token;
                    linkUrl = `${window.location.origin}/assignment/${assignmentToken}`;
                    console.log('‚úÖ ÌÜ†ÌÅ∞ Ï∞æÏùå:', assignmentToken);
                } else if (result.success && result.assignment && !result.assignment.assignment_token) {
                    // ÌÜ†ÌÅ∞Ïù¥ ÏóÜÏúºÎ©¥ ÏÉùÏÑ± API Ìò∏Ï∂ú
                    console.log('‚ö†Ô∏è ÌÜ†ÌÅ∞ ÏóÜÏùå - ÏÉùÏÑ± ÏãúÎèÑ');
                    const generateResponse = await fetch(`/api/assignments/${window.currentReservationId}/generate-link`, {
                        method: 'POST'
                    });
                    const generateResult = await generateResponse.json();
                    
                    console.log('üìä ÌÜ†ÌÅ∞ ÏÉùÏÑ± Í≤∞Í≥º:', generateResult);
                    
                    if (generateResult.success && generateResult.assignment_token) {
                        assignmentToken = generateResult.assignment_token;
                        linkUrl = `${window.location.origin}/assignment/${assignmentToken}`;
                        console.log('‚úÖ ÏÉà ÌÜ†ÌÅ∞ ÏÉùÏÑ±:', assignmentToken);
                    } else {
                        showAlert('ÌÜ†ÌÅ∞ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'danger');
                        return;
                    }
                } else {
                    showAlert('ÏàòÎ∞∞ÏÑúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä ÏàòÎ∞∞ÏÑúÎ•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                    console.error('‚ùå ÏàòÎ∞∞ÏÑú ÏóÜÏùå:', result);
                    return;
                }
                
                // ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨
                if (navigator.clipboard) {
                    await navigator.clipboard.writeText(linkUrl);
                    showAlert('‚úÖ ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!', 'success');
                    
                    // ÎßÅÌÅ¨Î•º inputÏóêÎèÑ ÌëúÏãú
                    const linkInput = document.getElementById('assignmentLinkInput');
                    if (linkInput) {
                        linkInput.value = linkUrl;
                    }
                } else {
                    // fallback
                    const linkInput = document.getElementById('assignmentLinkInput');
                    if (linkInput) {
                        linkInput.value = linkUrl;
                        linkInput.select();
                        document.execCommand('copy');
                        showAlert('‚úÖ ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!', 'success');
                    }
                }
            } catch (error) {
                console.error('ÎßÅÌÅ¨ Î≥µÏÇ¨ Ïã§Ìå®:', error);
                showAlert('ÎßÅÌÅ¨ Î≥µÏÇ¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        // ÏòàÏïΩ IDÎ°ú ÏàòÎ∞∞ÏÑú ÌÜ†ÌÅ∞ÏùÑ Ï∞æÏïÑÏÑú Î°úÎìú
        async function loadAssignmentByReservationId(reservationId) {
            try {
                console.log('üîç ÏàòÎ∞∞ÏÑú ÌÜ†ÌÅ∞ Ï°∞Ìöå:', reservationId);
                
                // ÏàòÎ∞∞ÏÑú ÌÜ†ÌÅ∞ Ï°∞Ìöå
                const response = await fetch(`/api/assignments/by-reservation/${reservationId}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ ÏàòÎ∞∞ÏÑú ÌÜ†ÌÅ∞ Ï°∞Ìöå ÏÑ±Í≥µ:', data);
                
                if (data.assignment_token) {
                    loadAssignmentFrame(data.assignment_token);
                } else {
                    throw new Error('ÏàòÎ∞∞ÏÑú ÌÜ†ÌÅ∞ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                }
                
            } catch (error) {
                console.error('‚ùå ÏàòÎ∞∞ÏÑú ÌÜ†ÌÅ∞ Ï°∞Ìöå Ïò§Î•ò:', error);
                showAssignmentError(error.message);
            }
        }

        // ÏàòÎ∞∞ÏÑú iframe Î°úÎìú
        function loadAssignmentFrame(token) {
            const iframe = document.getElementById('assignmentFrame');
            const spinner = document.getElementById('loadingSpinner');
            const errorDiv = document.getElementById('errorMessage');
            
            console.log('üîç ÏàòÎ∞∞ÏÑú iframe Î°úÎìú:', token);
            
            iframe.src = `/assignment/${token}`;
            
            iframe.onload = () => {
                console.log('‚úÖ ÏàòÎ∞∞ÏÑú iframe Î°úÎìú ÏôÑÎ£å');
                spinner.style.display = 'none';
                iframe.style.display = 'block';
                errorDiv.style.display = 'none';
            };
            
            iframe.onerror = () => {
                console.error('‚ùå ÏàòÎ∞∞ÏÑú iframe Î°úÎìú Ïã§Ìå®');
                showAssignmentError('ÏàòÎ∞∞ÏÑú ÌéòÏù¥ÏßÄÎ•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§');
            };
            
            // 5Ï¥à ÌõÑÏóêÎèÑ Î°úÎìúÎêòÏßÄ ÏïäÏúºÎ©¥ Ïò§Î•ò ÌëúÏãú
            setTimeout(() => {
                if (iframe.style.display === 'none') {
                    console.error('‚ùå ÏàòÎ∞∞ÏÑú Î°úÎìú ÌÉÄÏûÑÏïÑÏõÉ');
                    showAssignmentError('ÏàòÎ∞∞ÏÑú Î°úÎìú ÏãúÍ∞ÑÏù¥ Ï¥àÍ≥ºÎêòÏóàÏäµÎãàÎã§');
                }
            }, 5000);
        }

        // ÏàòÎ∞∞ÏÑú Ïò§Î•ò ÌëúÏãú
        function showAssignmentError(message) {
            const spinner = document.getElementById('loadingSpinner');
            const errorDiv = document.getElementById('errorMessage');
            const iframe = document.getElementById('assignmentFrame');
            
            spinner.style.display = 'none';
            iframe.style.display = 'none';
            errorDiv.style.display = 'block';
            errorDiv.querySelector('p').textContent = message;
        }

        // ÏàòÎ∞∞ÏÑú Ïû¨ÏãúÎèÑ
        function retryLoadAssignment(reservationId) {
            const spinner = document.getElementById('loadingSpinner');
            const errorDiv = document.getElementById('errorMessage');
            
            spinner.style.display = 'block';
            errorDiv.style.display = 'none';
            
            loadAssignmentByReservationId(reservationId);
        }

        // Î∞îÏö∞Ï≤ò Î≥¥Í∏∞ (Î™®Îã¨)
        function viewVoucher(reservationId) {
            // Î∞îÏö∞Ï≤ò Î™®Îã¨ HTML ÏÉùÏÑ±
            const modalHtml = `
                <div class="modal fade" id="voucherViewModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="bi bi-ticket-perforated me-2"></i>Î∞îÏö∞Ï≤ò Î≥¥Í∏∞</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Î°úÎî© Ï§ë...</span>
                                    </div>
                                    <p class="mt-2">Î∞îÏö∞Ï≤òÎ•º Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§...</p>
                                </div>
                                <iframe id="voucherFrame" style="width:100%; height:500px; border:none; display:none;"></iframe>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
                                <button type="button" class="btn btn-primary" onclick="printVoucher()">
                                    <i class="bi bi-printer me-1"></i>Ïù∏ÏáÑ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Í∏∞Ï°¥ Î™®Îã¨ Ï†úÍ±∞
            const existingModal = document.getElementById('voucherViewModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // ÏÉà Î™®Îã¨ Ï∂îÍ∞Ä
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Î™®Îã¨ ÌëúÏãú
            const modal = new bootstrap.Modal(document.getElementById('voucherViewModal'));
            modal.show();
            
            // Î∞îÏö∞Ï≤ò Î°úÎìú
            setTimeout(() => {
                const iframe = document.getElementById('voucherFrame');
                const spinner = document.querySelector('#voucherViewModal .spinner-border').parentElement;
                
                // Î®ºÏ†Ä Î∞îÏö∞Ï≤ò ÌÜ†ÌÅ∞ÏùÑ Í∞ÄÏ†∏ÏôÄÏïº Ìï®
                fetch(`/api/reservations/${reservationId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.reservation.voucher_token) {
                            iframe.src = `/voucher/${data.reservation.voucher_token}`;
                            iframe.onload = () => {
                                spinner.style.display = 'none';
                                iframe.style.display = 'block';
                            };
                        } else {
                            spinner.innerHTML = '<p class="text-muted">Î∞îÏö∞Ï≤òÍ∞Ä ÏïÑÏßÅ ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Î∞îÏö∞Ï≤ò Î°úÎìú Ïò§Î•ò:', error);
                        spinner.innerHTML = '<p class="text-danger">Î∞îÏö∞Ï≤òÎ•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.</p>';
                    });
            }, 500);
        }

        // ÏàòÎ∞∞ÏÑú Ïù∏ÏáÑ
        function printAssignment() {
            const iframe = document.getElementById('assignmentFrame');
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.print();
            }
        }

        // Î∞îÏö∞Ï≤ò Ïù∏ÏáÑ
        function printVoucher() {
            const iframe = document.getElementById('voucherFrame');
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.print();
            }
        }

        // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
        function getStatusClass(status) {
            const statusMap = {
                'pending': 'pending',
                'in_progress': 'in-progress', 
                'confirmed': 'confirmed',
                'voucher_sent': 'voucher-sent',
                'cancelled': 'cancelled',
                'refunded': 'refunded'
            };
            return statusMap[status] || 'pending';
        }

        function getBootstrapStatusClass(status) {
            const statusMap = {
                'in_revision': 'danger',          // ÏàòÏ†ïÏ§ë - Îπ®Í∞ÑÏÉâ
                'pending': 'secondary',           // ÎåÄÍ∏∞Ï§ë - ÌöåÏÉâ
                'in_progress': 'warning',         // ÏàòÎ∞∞Ï§ë - ÎÖ∏ÎûÄÏÉâ
                'confirmed': 'success',           // ÌôïÏ†ï - Ï¥àÎ°ùÏÉâ
                'voucher_sent': 'primary',        // Î∞îÏö∞Ï≤òÏ†ÑÏÜ°ÏôÑÎ£å - ÌååÎûÄÏÉâ
                'cancelled': 'danger',            // ÏòàÏïΩÏ∑®ÏÜå - Îπ®Í∞ÑÏÉâ
                'refunded': 'dark'                // ÌôòÎ∂àÏôÑÎ£å - Í≤ÄÏùÄÏÉâ
            };
            return statusMap[status] || 'secondary';
        }

        function getReservationStatusText(status) {
            const statusMap = {
                'in_revision': 'ÏàòÏ†ïÏ§ë (ÏòàÏïΩÎ≥ÄÍ≤Ω)',
                'pending': 'ÎåÄÍ∏∞Ï§ë (Ïã†Í∑úÏòàÏïΩ)',
                'in_progress': 'ÏàòÎ∞∞Ï§ë (ÌòÑÏßÄÏàòÎ∞∞)',
                'confirmed': 'ÌôïÏ†ï (ÏàòÎ∞∞ÏôÑÎ£å)',
                'voucher_sent': 'Î∞îÏö∞Ï≤òÏ†ÑÏÜ°ÏôÑÎ£å',
                'cancelled': 'ÏòàÏïΩÏ∑®ÏÜå',
                'refunded': 'ÌôòÎ∂àÏôÑÎ£å'
            };
            return statusMap[status] || 'ÎåÄÍ∏∞Ï§ë (Ïã†Í∑úÏòàÏïΩ)';
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '-';
            return date.toLocaleDateString('ko-KR');
        }

        function formatCurrency(amount) {
            if (!amount) return '-';
            return new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        // ÏÑ†ÌÉùÎêú ÏòàÏïΩ Í∞ïÏ°∞ ÌëúÏãú Ìï®Ïàò
        function highlightSelectedReservation(reservationId) {
            // Î™®Îì† ÏòàÏïΩ Ïπ¥ÎìúÏùò ÏÑ†ÌÉù ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
            document.querySelectorAll('.row-card').forEach(card => {
                card.classList.remove('row-card-selected');
            });
            
            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏòàÏïΩ Ïπ¥ÎìúÏóê ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
            const selectedCard = document.querySelector(`.row-card[data-reservation-id="${reservationId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('row-card-selected');
                console.log('‚úÖ ÏòàÏïΩ Í∞ïÏ°∞ ÌëúÏãú:', reservationId);
                
                // ‚úÖ localStorageÏóê Ï†ÄÏû• (ÏÉàÎ°úÍ≥†Ïπ® ÌõÑÏóêÎèÑ Ïú†ÏßÄ)
                localStorage.setItem('lastWorkingReservation', reservationId);
            }
        }
        
        // ‚úÖ Î™®Îã¨ Îã´Ìûò Ïãú ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® ÏÑ§Ï†ï
        function setupModalRefreshListeners() {
            const modalIds = [
                'assignmentManageModal',
                'statusManageModal', 
                'voucherManageModal',
                'settlementModal',
                'reservationEditModal',
                'historyModal',
                'assignmentViewModal',
                'voucherViewModal'
            ];
            
            modalIds.forEach(modalId => {
                const modalElement = document.getElementById(modalId);
                if (modalElement) {
                    modalElement.addEventListener('hidden.bs.modal', function() {
                        console.log('üîÑ Î™®Îã¨ Îã´Ìûò - ÏÉàÎ°úÍ≥†Ïπ®:', modalId);
                        loadAssignments(currentPage);
                    });
                }
            });
            
            console.log('‚úÖ Î™®Îã¨ ÏÉàÎ°úÍ≥†Ïπ® Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï ÏôÑÎ£å');
        }
        
        // 1. ÏòàÏïΩÎ≥ÄÍ≤Ω Î™®Îã¨ Ïó¥Í∏∞
        function openReservationEditModal(reservationId) {
            highlightSelectedReservation(reservationId);
            
            const reservation = getReservationData(reservationId);
            if (!reservation) return;
            
            window.currentReservationId = reservationId;
            
            // ÏòàÏïΩ Ï†ïÎ≥¥
            document.getElementById('edit-reservation-number').value = reservation.reservation_number || '';
            document.getElementById('edit-platform-name').value = reservation.platform_name || '';
            document.getElementById('edit-payment-status').value = reservation.payment_status || 'pending';
            
            // ÏÉÅÌíà Ï†ïÎ≥¥
            document.getElementById('edit-product-name').value = reservation.product_name || '';
            document.getElementById('edit-package-type').value = reservation.package_type || '';
            
            // ÏùºÏ†ï Ï†ïÎ≥¥
            document.getElementById('edit-usage-date').value = reservation.usage_date ? reservation.usage_date.split('T')[0] : '';
            document.getElementById('edit-usage-time').value = reservation.usage_time || '';
            
            // ÏòàÏïΩÏûê Ï†ïÎ≥¥
            document.getElementById('edit-korean-name').value = reservation.korean_name || '';
            
            // ÏòÅÎ¨∏Î™Ö Î∂ÑÎ¶¨ (english_nameÏóêÏÑú ÏÑ±Í≥º Ïù¥Î¶Ñ Î∂ÑÎ¶¨)
            if (reservation.english_name) {
                const nameParts = reservation.english_name.split(' ');
                document.getElementById('edit-english-lastname').value = nameParts[0] || '';
                document.getElementById('edit-english-firstname').value = nameParts.slice(1).join(' ') || '';
            } else {
                document.getElementById('edit-english-lastname').value = '';
                document.getElementById('edit-english-firstname').value = '';
            }
            
            document.getElementById('edit-phone').value = reservation.phone || '';
            document.getElementById('edit-email').value = reservation.email || '';
            document.getElementById('edit-kakao-id').value = reservation.kakao_id || '';
            
            // Ïù∏Ïõê Î∞è Í∏àÏï° Ï†ïÎ≥¥
            document.getElementById('edit-people-adult').value = reservation.people_adult || 0;
            document.getElementById('edit-people-child').value = reservation.people_child || 0;
            document.getElementById('edit-people-infant').value = reservation.people_infant || 0;
            
            // ÌåêÎß§Í∞Ä
            document.getElementById('edit-adult-price').value = reservation.adult_price || '';
            document.getElementById('edit-child-price').value = reservation.child_price || '';
            document.getElementById('edit-infant-price').value = reservation.infant_price || '';
            
            // ÏõêÍ∞Ä
            document.getElementById('edit-adult-cost').value = reservation.adult_cost || '';
            document.getElementById('edit-child-cost').value = reservation.child_cost || '';
            document.getElementById('edit-infant-cost').value = reservation.infant_cost || '';
            
            // ÌÜµÌôî Ï†ïÎ≥¥ ÏÑ§Ï†ï
            document.getElementById('edit-adult-currency').value = reservation.adult_currency || 'USD';
            document.getElementById('edit-child-currency').value = reservation.child_currency || 'USD';
            document.getElementById('edit-infant-currency').value = reservation.infant_currency || 'USD';
            
            document.getElementById('edit-adult-cost-currency').value = reservation.adult_cost_currency || reservation.adult_currency || 'USD';
            document.getElementById('edit-child-cost-currency').value = reservation.child_cost_currency || reservation.child_currency || 'USD';
            document.getElementById('edit-infant-cost-currency').value = reservation.infant_cost_currency || reservation.infant_currency || 'USD';
            
            // ÎßàÏßÑ Í≥ÑÏÇ∞
            calculateEditTotal();
            
            // ÌäπÎ≥Ñ ÏöîÏ≤≠ÏÇ¨Ìï≠
            document.getElementById('edit-memo').value = reservation.memo || '';
            
            const modal = new bootstrap.Modal(document.getElementById('reservationEditModal'));
            modal.show();
        }
        
        // ÏòàÏïΩ Î≥ÄÍ≤Ω Î™®Îã¨Ïùò ÎßàÏßÑ Í≥ÑÏÇ∞ (Ïù∏Î∞ïÏä§ÏôÄ ÎèôÏùºÌïú Î°úÏßÅ)
        function calculateEditTotal() {
            const adultCount = parseInt(document.getElementById('edit-people-adult').value) || 0;
            const childCount = parseInt(document.getElementById('edit-people-child').value) || 0;
            const infantCount = parseInt(document.getElementById('edit-people-infant').value) || 0;
            
            // ÌåêÎß§Í∞Ä
            const adultPrice = parseFloat(document.getElementById('edit-adult-price').value) || 0;
            const childPrice = parseFloat(document.getElementById('edit-child-price').value) || 0;
            const infantPrice = parseFloat(document.getElementById('edit-infant-price').value) || 0;
            
            // ÏõêÍ∞Ä
            const adultCost = parseFloat(document.getElementById('edit-adult-cost').value) || 0;
            const childCost = parseFloat(document.getElementById('edit-child-cost').value) || 0;
            const infantCost = parseFloat(document.getElementById('edit-infant-cost').value) || 0;
            
            // ÌÜµÌôî
            const adultCurrency = document.getElementById('edit-adult-currency').value || 'USD';
            const childCurrency = document.getElementById('edit-child-currency').value || 'USD';
            const infantCurrency = document.getElementById('edit-infant-currency').value || 'USD';
            
            const adultCostCurrency = document.getElementById('edit-adult-cost-currency').value || 'USD';
            const childCostCurrency = document.getElementById('edit-child-cost-currency').value || 'USD';
            const infantCostCurrency = document.getElementById('edit-infant-cost-currency').value || 'USD';
            
            // ÏàòÏàòÎ£åÏú® Í∞ÄÏ†∏Ïò§Í∏∞ (RAGÏóêÏÑú ÏÑ§Ï†ïÎêú Í∞í)
            const commissionRate = window.ragCommissionRate || 0;
            
            // ÌôòÏú® (ÌôòÏú®Í¥ÄÎ¶¨ÏóêÏÑú Í∞ÄÏ†∏Ïò® ÏµúÏã† ÌôòÏú®)
            const exchangeRate = window.latestExchangeRate || 1300;
            
            // ÌÜµÌôî Î≥ÄÌôò Ìï®Ïàò (Î™®Îì† Í∏àÏï°ÏùÑ ÏõêÌôîÎ°ú ÌÜµÏùº)
            function convertToKRW(amount, currency) {
                if (currency === 'USD') {
                    return amount * exchangeRate;
                }
                return amount; // Ïù¥ÎØ∏ KRW
            }
            
            // ÌåêÎß§Í∞ÄÎ•º ÏõêÌôîÎ°ú Î≥ÄÌôò
            const adultPriceKRW = convertToKRW(adultPrice, adultCurrency);
            const childPriceKRW = convertToKRW(childPrice, childCurrency);
            const infantPriceKRW = convertToKRW(infantPrice, infantCurrency);
            
            // ÏõêÍ∞ÄÎ•º ÏõêÌôîÎ°ú Î≥ÄÌôò
            const adultCostKRW = convertToKRW(adultCost, adultCostCurrency);
            const childCostKRW = convertToKRW(childCost, childCostCurrency);
            const infantCostKRW = convertToKRW(infantCost, infantCostCurrency);
            
            // ÎßàÏßÑ Í≥ÑÏÇ∞ (ÏõêÌôî Í∏∞Ï§Ä: ÌåêÎß§Í∞Ä - ÏõêÍ∞Ä - ÏàòÏàòÎ£å)
            const adultCommissionKRW = adultPriceKRW * (commissionRate / 100);
            const childCommissionKRW = childPriceKRW * (commissionRate / 100);
            const infantCommissionKRW = infantPriceKRW * (commissionRate / 100);
            
            const adultMarginKRW = adultPriceKRW - adultCostKRW - adultCommissionKRW;
            const childMarginKRW = childPriceKRW - childCostKRW - childCommissionKRW;
            const infantMarginKRW = infantPriceKRW - infantCostKRW - infantCommissionKRW;
            
            // ÏÑ±Ïù∏ ÎßàÏßÑ ÌëúÏãú (ÏõêÌôî Í∏∞Ï§Ä)
            if (adultPrice > 0 || adultCost > 0) {
                const display = `‚Ç©${Math.round(adultMarginKRW).toLocaleString('ko-KR')}`;
                document.getElementById('edit-adult-margin').value = display;
            } else {
                document.getElementById('edit-adult-margin').value = '';
            }
            
            // ÏÜåÏïÑ ÎßàÏßÑ ÌëúÏãú (ÏõêÌôî Í∏∞Ï§Ä)
            if (childPrice > 0 || childCost > 0) {
                const display = `‚Ç©${Math.round(childMarginKRW).toLocaleString('ko-KR')}`;
                document.getElementById('edit-child-margin').value = display;
            } else {
                document.getElementById('edit-child-margin').value = '';
            }
            
            // Ïú†ÏïÑ ÎßàÏßÑ ÌëúÏãú (ÏõêÌôî Í∏∞Ï§Ä)
            if (infantPrice > 0 || infantCost > 0) {
                const display = `‚Ç©${Math.round(infantMarginKRW).toLocaleString('ko-KR')}`;
                document.getElementById('edit-infant-margin').value = display;
            } else {
                document.getElementById('edit-infant-margin').value = '';
            }
            
            // Ï¥ù Ïù∏Ïõê
            const totalGuests = adultCount + childCount + infantCount;
            document.getElementById('edit-total-guests').value = totalGuests + 'Î™Ö';
            
            // Ï¥ù Í∏àÏï° (ÌåêÎß§Í∞Ä Í∏∞Ï§Ä)
            const adultTotal = adultCount * adultPrice;
            const childTotal = childCount * childPrice;
            const infantTotal = infantCount * infantPrice;
            const totalAmount = adultTotal + childTotal + infantTotal;
            
            const mainCurrency = adultCurrency || childCurrency || infantCurrency || 'USD';
            const totalDisplay = mainCurrency === 'USD' ? 
                `$${totalAmount.toFixed(2)}` : `‚Ç©${Math.round(totalAmount).toLocaleString('ko-KR')}`;
            document.getElementById('edit-total-amount').value = totalDisplay;
            
            // Í≥ÑÏÇ∞Ïãù
            let formula = [];
            if (adultCount > 0) {
                const adultDisplay = adultCurrency === 'USD' ? 
                    `$${adultPrice.toFixed(2)}` : `‚Ç©${Math.round(adultPrice).toLocaleString('ko-KR')}`;
                formula.push(`ÏÑ±Ïù∏${adultCount}√ó${adultDisplay}`);
            }
            if (childCount > 0) {
                const childDisplay = childCurrency === 'USD' ? 
                    `$${childPrice.toFixed(2)}` : `‚Ç©${Math.round(childPrice).toLocaleString('ko-KR')}`;
                formula.push(`ÏÜåÏïÑ${childCount}√ó${childDisplay}`);
            }
            if (infantCount > 0) {
                const infantDisplay = infantCurrency === 'USD' ? 
                    `$${infantPrice.toFixed(2)}` : `‚Ç©${Math.round(infantPrice).toLocaleString('ko-KR')}`;
                formula.push(`Ïú†ÏïÑ${infantCount}√ó${infantDisplay}`);
            }
            
            const formulaText = formula.length > 0 ? formula.join(' + ') + ` = ${totalDisplay}` : '';
            document.getElementById('edit-calculation-formula').value = formulaText;
        }

        // 2. ÏàòÎ∞∞ÏÑúÍ¥ÄÎ¶¨ Î™®Îã¨ Ïó¥Í∏∞
        function openAssignmentManageModal(reservationId) {
            const reservation = getReservationData(reservationId);
            if (!reservation) return;
            
            window.currentReservationId = reservationId;
            window.currentReservation = reservation;
            
            console.log('üîì ÏàòÎ∞∞ÏÑú Î™®Îã¨ Ïó¥Í∏∞ - ÏòàÏïΩ ID:', reservationId);
            
            // ÏÑ†ÌÉùÎêú ÏòàÏïΩ Í∞ïÏ°∞ ÌëúÏãú
            highlightSelectedReservation(reservationId);
            
            // Î™®Îã¨ ÌëúÏãú
            const modal = new bootstrap.Modal(document.getElementById('assignmentManageModal'));
            modal.show();
            
            // ÏàòÎ∞∞ÏÑú Ï†ïÎ≥¥ Î°úÎìú
            loadAssignmentDetails(reservationId);
            
            // Ïó¥Îûå ÌÜµÍ≥Ñ ÏûêÎèô Î°úÎìú
            loadViewStats();
        }
        
        // ÏàòÎ∞∞ÏÑú Ï†ïÎ≥¥ ÏÉàÎ°úÍ≥†Ïπ® Ìï®Ïàò
        function refreshAssignmentInfo() {
            const reservationId = window.currentReservationId;
            if (!reservationId) {
                showAlert('ÏòàÏïΩ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.', 'warning');
                return;
            }
            
            console.log('üîÑ ÏàòÎ∞∞ÏÑú Ï†ïÎ≥¥ ÏÉàÎ°úÍ≥†Ïπ®:', reservationId);
            loadAssignmentDetails(reservationId);
            showAlert('Ï†ïÎ≥¥Í∞Ä ÏÉàÎ°úÍ≥†Ïπ®ÎêòÏóàÏäµÎãàÎã§.', 'success');
        }

        // Ïó¥Îûå ÌÜµÍ≥Ñ Î°úÎìú Ìï®Ïàò
        // ÏàòÎ∞∞ÏÑú Ïó¥Îûå ÌÜµÍ≥Ñ Î°úÎìú (Î∞îÏö∞Ï≤òÏôÄ ÎèôÏùºÌïú ÌòïÏãù)
        async function loadViewStats() {
            const statsEl = document.getElementById('view-stats-content');
            
            if (!window.currentReservationId) {
                statsEl.innerHTML = '<p class="text-muted mb-0">ÏòàÏïΩ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            try {
                statsEl.innerHTML = '<p class="text-muted mb-0">ÌÜµÍ≥ÑÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>';
                
                // ÏàòÎ∞∞ÏÑú Ïó¥Îûå Í∏∞Î°ù Ï°∞Ìöå
                const response = await fetch(`/api/assignments/view-stats/${window.currentReservationId}`);
                const data = await response.json();
                
                if (data.success) {
                    const { views, total_views, first_viewed, last_viewed } = data;
                    
                    let html = '';
                    
                    if (total_views > 0) {
                        html += `
                            <div class="mb-3">
                                <div class="row text-center mb-2">
                                    <div class="col-4">
                                        <div class="badge bg-primary w-100">Ï¥ù Ïó¥ÎûåÏàò</div>
                                        <h4 class="mt-2 mb-0">${total_views}</h4>
                                    </div>
                                    <div class="col-4">
                                        <div class="badge bg-success w-100">Ï≤´ Ïó¥Îûå</div>
                                        <div class="small mt-2">${new Date(first_viewed).toLocaleString('ko-KR', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'})}</div>
                                    </div>
                                    <div class="col-4">
                                        <div class="badge bg-info w-100">ÏµúÍ∑º Ïó¥Îûå</div>
                                        <div class="small mt-2">${new Date(last_viewed).toLocaleString('ko-KR', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'})}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="border-top pt-2">
                                <strong class="small">üìä Ïó¥Îûå ÎÇ¥Ïó≠ (ÏµúÍ∑º 10Í∞ú)</strong>
                                <div class="mt-2">
                                    ${views.slice(0, 10).map(v => `
                                        <div class="small mb-2 pb-2 border-bottom">
                                            <div><i class="bi bi-calendar"></i> ${new Date(v.viewed_at).toLocaleString('ko-KR')}</div>
                                            <div class="text-muted">
                                                ${(v.device_type || '').toLowerCase().includes('mobile') ? 'üì±' : 'üíª'} ${v.device_type || 'unknown'} 
                                                | ${v.browser || 'unknown browser'}
                                            </div>
                                            ${v.ip_address ? `<div class="text-muted small">IP: ${v.ip_address}</div>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    } else {
                        html = `
                            <div class="text-center text-muted py-3">
                                <i class="bi bi-eye-slash" style="font-size: 2rem;"></i>
                                <p class="mt-2 mb-0">ÏïÑÏßÅ Ïó¥Îûå Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§</p>
                                <p class="small mb-0">ÏàòÎ∞∞ÏóÖÏ≤¥Í∞Ä ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨Î•º Ïó¥Î©¥ ÏûêÎèôÏúºÎ°ú Í∏∞Î°ùÎê©ÎãàÎã§</p>
                            </div>
                        `;
                    }
                    
                    statsEl.innerHTML = html;
                } else {
                    statsEl.innerHTML = '<p class="text-warning mb-0">ÌÜµÍ≥ÑÎ•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</p>';
                }
            } catch (error) {
                console.error('‚ùå ÏàòÎ∞∞ÏÑú Ïó¥Îûå ÌÜµÍ≥Ñ Î°úÎìú Ïò§Î•ò:', error);
                statsEl.innerHTML = '<p class="text-danger mb-0">ÌÜµÍ≥Ñ Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</p>';
            }
        }

        // ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨ Î≥µÏÇ¨ (Ïπ¥ÌÜ° Ï†ÑÏÜ°Ïö©)
        async function copyAssignmentLink() {
            const reservation = window.currentReservation;
            if (!reservation || !reservation.assignment_token) {
                alert('ÏàòÎ∞∞ÏÑúÍ∞Ä ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                return;
            }
            
            const link = `${window.location.origin}/assignment/${reservation.assignment_token}`;
            
            try {
                await navigator.clipboard.writeText(link);
                alert('‚úÖ ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!\nÏπ¥Ïπ¥Ïò§ÌÜ°ÏúºÎ°ú Ï†ÑÏÜ°ÌïòÏÑ∏Ïöî:\n' + link);
            } catch (error) {
                // Î≥µÏÇ¨ Ïã§Ìå® Ïãú ÏàòÎèô Î≥µÏÇ¨Ïö© ÏïåÎ¶º
                prompt('ÎßÅÌÅ¨Î•º Î≥µÏÇ¨ÌïòÏÑ∏Ïöî:', link);
            }
        }

        // 3. ÏÉÅÌÉúÍ¥ÄÎ¶¨ Î™®Îã¨ Ïó¥Í∏∞
        // ÌôïÏ†ï Î∞©Ïãù ÏÑ†ÌÉù Ï†ÑÏó≠ Î≥ÄÏàò
        let selectedConfirmationMethod = null;
        
        function openStatusManageModal(reservationId) {
            highlightSelectedReservation(reservationId);
            
            const reservation = getReservationData(reservationId);
            if (!reservation) return;
            
            window.currentReservationId = reservationId;
            
            // Ï¥àÍ∏∞Ìôî
            selectedConfirmationMethod = null;
            document.getElementById('confirmation-input-area').style.display = 'none';
            document.getElementById('confirm-button').style.display = 'none';
            document.querySelectorAll('.confirmation-method-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelectorAll('.confirmation-form').forEach(form => {
                form.style.display = 'none';
            });
            
            // ÌòÑÏû¨ ÏÉÅÌÉú ÌëúÏãú
            const statusText = getReservationStatusText(reservation.payment_status);
            const statusClass = getBootstrapStatusClass(reservation.payment_status);
            document.getElementById('current-status-display').innerHTML = 
                `<span class="badge bg-${statusClass}">${statusText}</span>`;
            
            const modal = new bootstrap.Modal(document.getElementById('statusManageModal'));
            modal.show();
        }
        
        // ÌôïÏ†ï Î∞©Ïãù ÏÑ†ÌÉù
        function selectConfirmationMethod(method) {
            selectedConfirmationMethod = method;
            
            // Î™®Îì† Ïπ¥Îìú ÏÑ†ÌÉù Ìï¥Ï†ú
            document.querySelectorAll('.confirmation-method-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // ÏÑ†ÌÉùÎêú Ïπ¥Îìú Í∞ïÏ°∞
            document.querySelector(`.confirmation-method-card[data-method="${method}"]`).classList.add('selected');
            
            // Î™®Îì† Ìèº Ïà®Í∏∞Í∏∞
            document.querySelectorAll('.confirmation-form').forEach(form => {
                form.style.display = 'none';
            });
            
            // ÏûÖÎ†• ÏòÅÏó≠ ÌëúÏãú
            document.getElementById('confirmation-input-area').style.display = 'block';
            
            // ÏÑ†ÌÉùÎêú Î∞©ÏãùÏùò Ìèº ÌëúÏãú
            document.getElementById(`method-${method}-form`).style.display = 'block';
            
            // ÌôïÏ†ï Î≤ÑÌäº ÌëúÏãú
            document.getElementById('confirm-button').style.display = 'inline-block';
            
            console.log('‚úÖ ÌôïÏ†ï Î∞©Ïãù ÏÑ†ÌÉù:', method);
        }
        
        // Ïª®ÌéåÎ≤àÌò∏ ÏûêÎèôÏÉùÏÑ±
        function generateConfirmationNumber() {
            const prefix = 'CONF';
            const timestamp = Date.now().toString().slice(-8);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            const confirmNumber = `${prefix}${timestamp}${random}`;
            
            document.getElementById('confirmation-number').value = confirmNumber;
            showAlert('Ïª®ÌéåÎ≤àÌò∏Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§: ' + confirmNumber, 'success');
        }
        
        // ÌôïÏ†ï Ï≤òÎ¶¨ (Î©îÏù∏ Ìï®Ïàò)
        async function processConfirmation() {
            if (!selectedConfirmationMethod) {
                showAlert('ÌôïÏ†ï Î∞©ÏãùÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                return;
            }
            
            const reservationId = window.currentReservationId;
            const memo = document.getElementById('confirmation-memo').value;
            
            let confirmationData = {
                method: selectedConfirmationMethod,
                memo: memo
            };
            
            // Î∞©ÏãùÎ≥Ñ Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Î∞è Í≤ÄÏ¶ù
            switch(selectedConfirmationMethod) {
                case 1: // Ïª®ÌéåÎ≤àÌò∏
                    const confirmNumber = document.getElementById('confirmation-number').value.trim();
                    if (!confirmNumber) {
                        showAlert('Ïª®ÌéåÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                        return;
                    }
                    confirmationData.confirmation_number = confirmNumber;
                    break;
                    
                case 2: // QRÏΩîÎìú
                    const qrData = document.getElementById('qr-code-data').value.trim();
                    if (!qrData) {
                        showAlert('QRÏΩîÎìú Ï†ïÎ≥¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                        return;
                    }
                    confirmationData.qr_code_data = qrData;
                    
                    // QR Ïù¥ÎØ∏ÏßÄ ÌååÏùº (ÏÑ†ÌÉù)
                    const qrImageFile = document.getElementById('qr-code-image').files[0];
                    if (qrImageFile) {
                        confirmationData.qr_image = qrImageFile;
                    }
                    break;
                    
                case 3: // Î∞îÏö∞Ï≤ò ÏóÖÎ°úÎìú
                    const voucherFile = document.getElementById('vendor-voucher-file').files[0];
                    if (!voucherFile) {
                        showAlert('Î∞îÏö∞Ï≤ò ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                        return;
                    }
                    confirmationData.vendor_voucher = voucherFile;
                    break;
                    
                case 4: // Ï¶âÏãú ÌôïÏ†ï
                    // Ï∂îÍ∞Ä Îç∞Ïù¥ÌÑ∞ Î∂àÌïÑÏöî
                    break;
            }
            
            try {
                console.log('üì§ ÌôïÏ†ï Ï≤òÎ¶¨ ÏãúÏûë:', confirmationData);
                
                // FormData ÏÉùÏÑ± (ÌååÏùº ÏóÖÎ°úÎìú ÏßÄÏõê)
                const formData = new FormData();
                formData.append('method', selectedConfirmationMethod);
                formData.append('memo', memo);
                
                if (confirmationData.confirmation_number) {
                    formData.append('confirmation_number', confirmationData.confirmation_number);
                }
                if (confirmationData.qr_code_data) {
                    formData.append('qr_code_data', confirmationData.qr_code_data);
                }
                if (confirmationData.qr_image) {
                    formData.append('qr_image', confirmationData.qr_image);
                }
                if (confirmationData.vendor_voucher) {
                    formData.append('vendor_voucher', confirmationData.vendor_voucher);
                }
                
                // ÏÑúÎ≤ÑÎ°ú ÌôïÏ†ï ÏöîÏ≤≠
                const response = await fetch(`/api/reservations/${reservationId}/confirm`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('‚úÖ ÏòàÏïΩÏù¥ ÌôïÏ†ïÎêòÏóàÏäµÎãàÎã§! Î∞îÏö∞Ï≤òÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.', 'success');
                    
                    console.log('üé´ Î∞îÏö∞Ï≤ò Ï†ïÎ≥¥:', {
                        token: result.voucher_token,
                        url: result.voucher_url
                    });
                    
                    // Î™®Îã¨ Îã´Í∏∞
                    const modal = bootstrap.Modal.getInstance(document.getElementById('statusManageModal'));
                    if (modal) modal.hide();
                    
                    // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ® ÌõÑ Î∞îÏö∞Ï≤ò Î™®Îã¨ Ïó¥Í∏∞
                    await loadAssignments(currentPage);
                    
                    // ÏÉàÎ°úÍ≥†Ïπ®Îêú Îç∞Ïù¥ÌÑ∞Î°ú Î∞îÏö∞Ï≤ò Î™®Îã¨ ÏûêÎèô Ïó¥Í∏∞
                    setTimeout(() => {
                        // Î∞îÏö∞Ï≤ò ÌÜ†ÌÅ∞ÏùÑ ÏßÅÏ†ë Ï†ÑÎã¨
                        openVoucherManageModalWithToken(reservationId, result.voucher_token);
                    }, 800);
                    
                } else {
                    showAlert('ÌôïÏ†ï Ï≤òÎ¶¨ Ïã§Ìå®: ' + result.message, 'danger');
                }
                
            } catch (error) {
                console.error('‚ùå ÌôïÏ†ï Ï≤òÎ¶¨ Ïò§Î•ò:', error);
                showAlert('ÌôïÏ†ï Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'danger');
            }
        }
        
        // Î∞îÏö∞Ï≤ò ÏûêÎèô ÏÉùÏÑ± Î∞è Î™®Îã¨ Ïó¥Í∏∞
        async function autoGenerateVoucher(reservationId) {
            try {
                console.log('üé´ Î∞îÏö∞Ï≤ò ÏûêÎèô ÏÉùÏÑ± ÏãúÏûë:', reservationId);
                
                const response = await fetch(`/api/vouchers/auto-generate/${reservationId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('‚úÖ Î∞îÏö∞Ï≤òÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!', 'success');
                    
                    // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                    await loadAssignments(currentPage);
                    
                    // Î∞îÏö∞Ï≤ò Î™®Îã¨ ÏûêÎèô Ïó¥Í∏∞
                    setTimeout(() => {
                        openVoucherManageModal(reservationId);
                    }, 500);
                    
                } else {
                    showAlert('Î∞îÏö∞Ï≤ò ÏÉùÏÑ± Ïã§Ìå®: ' + result.message, 'warning');
                }
                
            } catch (error) {
                console.error('‚ùå Î∞îÏö∞Ï≤ò ÏûêÎèô ÏÉùÏÑ± Ïò§Î•ò:', error);
                showAlert('Î∞îÏö∞Ï≤ò ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'danger');
            }
        }

        // 4. Î∞îÏö∞Ï≤òÍ¥ÄÎ¶¨ Î™®Îã¨ Ïó¥Í∏∞
        async function openVoucherManageModal(reservationId) {
            highlightSelectedReservation(reservationId);
            
            const reservation = getReservationData(reservationId);
            if (!reservation) return;
            
            window.currentReservationId = reservationId;
            window.currentVoucherToken = reservation.voucher_token;
            
            // Î∞îÏö∞Ï≤ò Ï†ïÎ≥¥ Î°úÎìú
            await loadVoucherData(reservationId);
            
            const modal = new bootstrap.Modal(document.getElementById('voucherManageModal'));
            modal.show();
        }
        
        // Î∞îÏö∞Ï≤ò ÌÜ†ÌÅ∞Í≥º Ìï®Íªò Î™®Îã¨ Ïó¥Í∏∞ (ÌôïÏ†ï ÌõÑ ÏÇ¨Ïö©)
        async function openVoucherManageModalWithToken(reservationId, voucherToken) {
            highlightSelectedReservation(reservationId);
            
            const reservation = getReservationData(reservationId);
            if (!reservation) {
                console.warn('ÏòàÏïΩ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. ÌÜ†ÌÅ∞ÏúºÎ°ú ÏßÑÌñâÌï©ÎãàÎã§.');
            }
            
            window.currentReservationId = reservationId;
            window.currentVoucherToken = voucherToken;
            
            // Î∞îÏö∞Ï≤ò Ï†ïÎ≥¥ Î°úÎìú (ÌÜ†ÌÅ∞ ÏßÅÏ†ë Ï†ÑÎã¨)
            await loadVoucherDataWithToken(reservationId, voucherToken);
            
            const modal = new bootstrap.Modal(document.getElementById('voucherManageModal'));
            modal.show();
        }
        
        // Î∞îÏö∞Ï≤ò Îç∞Ïù¥ÌÑ∞ Î°úÎìú (ÌÜ†ÌÅ∞ ÏßÅÏ†ë Ï†ÑÎã¨)
        async function loadVoucherDataWithToken(reservationId, voucherToken) {
            try {
                const reservation = getReservationData(reservationId);
                
                // Î∞îÏö∞Ï≤ò ÏöîÏïΩ Ï†ïÎ≥¥
                if (reservation) {
                    const summary = `${reservation.korean_name}Îãò - ${reservation.product_name}`;
                    document.getElementById('voucher-summary').textContent = summary;
                    
                    // Ïù¥Î©îÏùº ÏàòÏã†Ïûê ÏûêÎèô ÏûÖÎ†•
                    if (reservation.email) {
                        document.getElementById('email-recipient').value = reservation.email;
                    }
                }
                
                // Î∞îÏö∞Ï≤ò ÎßÅÌÅ¨ (ÌÜ†ÌÅ∞ ÏÇ¨Ïö©)
                if (voucherToken) {
                    const voucherUrl = `${window.location.origin}/voucher/${voucherToken}`;
                    document.getElementById('voucher-link-url').value = voucherUrl;
                    
                    console.log('‚úÖ Î∞îÏö∞Ï≤ò URL ÏÑ§Ï†ï:', voucherUrl);
                    console.log('üìã ÏûÖÎ†• ÌïÑÎìú Í∞í:', document.getElementById('voucher-link-url').value);
                    
                    // ÎØ∏Î¶¨Î≥¥Í∏∞ Î°úÎìú
                    console.log('üé´ Î∞îÏö∞Ï≤ò ÎØ∏Î¶¨Î≥¥Í∏∞ Î°úÎìú:', voucherToken);
                    await loadVoucherPreview(voucherToken);
                    
                    // Î∞îÏö∞Ï≤ò Ïó¥Îûå ÌÜµÍ≥Ñ Î°úÎìú
                    loadVoucherViewStats();
                } else {
                    console.error('‚ùå Î∞îÏö∞Ï≤ò ÌÜ†ÌÅ∞Ïù¥ ÏóÜÏäµÎãàÎã§. reservation Í∞ùÏ≤¥:', reservation);
                    document.getElementById('voucher-link-url').value = 'Î∞îÏö∞Ï≤òÍ∞Ä ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.';
                    document.getElementById('voucher-preview-content').innerHTML = `
                        <div class="text-center text-warning">
                            <i class="bi bi-exclamation-triangle mb-2" style="font-size: 2rem;"></i>
                            <p>Î∞îÏö∞Ï≤ò ÌÜ†ÌÅ∞Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
                            <p class="small text-muted">ÏòàÏïΩÏùÑ ÌôïÏ†ïÌïòÎ©¥ Î∞îÏö∞Ï≤òÍ∞Ä ÏûêÎèô ÏÉùÏÑ±Îê©ÎãàÎã§.</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('‚ùå Î∞îÏö∞Ï≤ò Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
            }
        }
        
        // Î∞îÏö∞Ï≤ò Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadVoucherData(reservationId) {
            try {
                const reservation = getReservationData(reservationId);
                console.log('üìã loadVoucherData - reservation:', reservation);
                console.log('üé´ voucher_token:', reservation?.voucher_token);
                
                // Î∞îÏö∞Ï≤ò ÏöîÏïΩ Ï†ïÎ≥¥
                const summary = `${reservation.korean_name}Îãò - ${reservation.product_name}`;
                document.getElementById('voucher-summary').textContent = summary;
                
                // Î∞îÏö∞Ï≤ò ÎßÅÌÅ¨
                if (reservation.voucher_token) {
                    const voucherUrl = `${window.location.origin}/voucher/${reservation.voucher_token}`;
                    document.getElementById('voucher-link-url').value = voucherUrl;
                    
                    console.log('‚úÖ Î∞îÏö∞Ï≤ò URL ÏÑ§Ï†ï (loadVoucherData):', voucherUrl);
                    
                    // ÎØ∏Î¶¨Î≥¥Í∏∞ Î°úÎìú
                    loadVoucherPreview(reservation.voucher_token);
                    
                    // Î∞îÏö∞Ï≤ò Ïó¥Îûå ÌÜµÍ≥Ñ Î°úÎìú
                    loadVoucherViewStats();
                    
                    // Î∞îÏö∞Ï≤ò Ï†ÑÏÜ° Í∏∞Î°ù Î°úÎìú
                    loadVoucherSendTimes(reservationId);
                } else {
                    console.warn('‚ö†Ô∏è voucher_tokenÏù¥ ÏóÜÏäµÎãàÎã§.');
                    document.getElementById('voucher-link-url').value = 'Î∞îÏö∞Ï≤òÍ∞Ä ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.';
                }
                
                // Ïù¥Î©îÏùº ÏàòÏã†Ïûê ÏûêÎèô ÏûÖÎ†•
                if (reservation.email) {
                    document.getElementById('email-recipient').value = reservation.email;
                }
                
            } catch (error) {
                console.error('‚ùå Î∞îÏö∞Ï≤ò Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
            }
        }
        
        // Î∞îÏö∞Ï≤ò ÎØ∏Î¶¨Î≥¥Í∏∞ Î°úÎìú
        async function loadVoucherPreview(voucherToken) {
            const previewEl = document.getElementById('voucher-preview-content');
            
            try {
                console.log('üì• ÎØ∏Î¶¨Î≥¥Í∏∞ ÏöîÏ≤≠:', `/api/vouchers/${voucherToken}/preview`);
                
                const response = await fetch(`/api/vouchers/${voucherToken}/preview`);
                const data = await response.json();
                
                console.log('üì¶ ÎØ∏Î¶¨Î≥¥Í∏∞ ÏùëÎãµ:', data);
                
                if (data.success) {
                    previewEl.innerHTML = data.html;
                    console.log('‚úÖ Î∞îÏö∞Ï≤ò ÎØ∏Î¶¨Î≥¥Í∏∞ Î°úÎìú ÏôÑÎ£å');
                } else {
                    previewEl.innerHTML = `
                        <div class="text-center text-danger">
                            <i class="bi bi-exclamation-triangle mb-2" style="font-size: 2rem;"></i>
                            <p>ÎØ∏Î¶¨Î≥¥Í∏∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</p>
                            <p class="small text-muted">${data.message || ''}</p>
                        </div>
                    `;
                    console.error('‚ùå ÎØ∏Î¶¨Î≥¥Í∏∞ Ïã§Ìå®:', data.message);
                }
            } catch (error) {
                console.error('‚ùå ÎØ∏Î¶¨Î≥¥Í∏∞ Î°úÎìú Ïò§Î•ò:', error);
                previewEl.innerHTML = `
                    <div class="text-center text-danger">
                        <i class="bi bi-exclamation-triangle mb-2" style="font-size: 2rem;"></i>
                        <p>ÎØ∏Î¶¨Î≥¥Í∏∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</p>
                        <p class="small text-muted">${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Î∞îÏö∞Ï≤ò Ïó¥Îûå ÌÜµÍ≥Ñ Î°úÎìú
        async function loadVoucherViewStats() {
            const statsEl = document.getElementById('voucher-view-stats');
            
            if (!window.currentReservationId || !window.currentVoucherToken) {
                statsEl.innerHTML = '<p class="text-muted mb-0">Î∞îÏö∞Ï≤ò Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            try {
                statsEl.innerHTML = '<p class="text-muted mb-0">ÌÜµÍ≥ÑÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>';
                
                // Î∞îÏö∞Ï≤ò Ïó¥Îûå Í∏∞Î°ù Ï°∞Ìöå
                const response = await fetch(`/api/vouchers/view-stats/${window.currentReservationId}`);
                const data = await response.json();
                
                if (data.success) {
                    const { views, total_views, first_viewed, last_viewed } = data;
                    
                    let html = '';
                    
                    if (total_views > 0) {
                        html += `
                            <div class="mb-3">
                                <div class="row text-center mb-2">
                                    <div class="col-4">
                                        <div class="badge bg-primary w-100">Ï¥ù Ïó¥ÎûåÏàò</div>
                                        <h4 class="mt-2 mb-0">${total_views}</h4>
                                    </div>
                                    <div class="col-4">
                                        <div class="badge bg-success w-100">Ï≤´ Ïó¥Îûå</div>
                                        <div class="small mt-2">${new Date(first_viewed).toLocaleString('ko-KR', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'})}</div>
                                    </div>
                                    <div class="col-4">
                                        <div class="badge bg-info w-100">ÏµúÍ∑º Ïó¥Îûå</div>
                                        <div class="small mt-2">${new Date(last_viewed).toLocaleString('ko-KR', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'})}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="border-top pt-2">
                                <strong class="small">üìä Ïó¥Îûå ÎÇ¥Ïó≠ (ÏµúÍ∑º 10Í∞ú)</strong>
                                <div class="mt-2">
                                    ${views.slice(0, 10).map(v => `
                                        <div class="small mb-2 pb-2 border-bottom">
                                            <div><i class="bi bi-calendar"></i> ${new Date(v.viewed_at).toLocaleString('ko-KR')}</div>
                                            <div class="text-muted">
                                                ${(v.device_type || '').toLowerCase().includes('mobile') ? 'üì±' : 'üíª'} ${v.device_type || 'unknown'} 
                                                | ${v.browser || 'unknown browser'}
                                            </div>
                                            ${v.ip_address ? `<div class="text-muted small">IP: ${v.ip_address}</div>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    } else {
                        html = `
                            <div class="text-center text-muted py-3">
                                <i class="bi bi-eye-slash" style="font-size: 2rem;"></i>
                                <p class="mt-2 mb-0">ÏïÑÏßÅ Ïó¥Îûå Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§</p>
                                <p class="small mb-0">Í≥†Í∞ùÏù¥ Î∞îÏö∞Ï≤ò ÎßÅÌÅ¨Î•º Ïó¥Î©¥ ÏûêÎèôÏúºÎ°ú Í∏∞Î°ùÎê©ÎãàÎã§</p>
                            </div>
                        `;
                    }
                    
                    statsEl.innerHTML = html;
                } else {
                    statsEl.innerHTML = '<p class="text-warning mb-0">ÌÜµÍ≥ÑÎ•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</p>';
                }
            } catch (error) {
                console.error('‚ùå Î∞îÏö∞Ï≤ò Ïó¥Îûå ÌÜµÍ≥Ñ Î°úÎìú Ïò§Î•ò:', error);
                statsEl.innerHTML = '<p class="text-danger mb-0">ÌÜµÍ≥Ñ Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</p>';
            }
        }
        
        // Î∞îÏö∞Ï≤ò Ï†ÑÏÜ° Í∏∞Î°ù Î°úÎìú (Í∞Å Î∞©ÏãùÎ≥Ñ ÏµúÍ∑º Ï†ÑÏÜ° ÏãúÍ∞Ñ ÌëúÏãú)
        async function loadVoucherSendTimes(reservationId) {
            try {
                const response = await fetch(`/api/vouchers/send-history/${reservationId}`);
                const data = await response.json();
                
                if (data.success && data.history) {
                    // Í∞Å Ï†ÑÏÜ° Î∞©ÏãùÎ≥ÑÎ°ú ÏµúÍ∑º Í∏∞Î°ù Ï∞æÍ∏∞
                    const methods = {
                        email: data.history.find(h => h.method === 'email'),
                        kakao: data.history.find(h => h.method === 'kakao'),
                        alimtalk: data.history.find(h => h.method === 'alimtalk'),
                        sms: data.history.find(h => h.method === 'sms')
                    };
                    
                    // Í∞Å Î∞©ÏãùÎ≥ÑÎ°ú Ï†ÑÏÜ° ÏãúÍ∞Ñ ÌëúÏãú
                    updateSendTime('email', methods.email);
                    updateSendTime('kakao', methods.kakao);
                    updateSendTime('alimtalk', methods.alimtalk);
                    updateSendTime('sms', methods.sms);
                }
            } catch (error) {
                console.error('‚ùå Ï†ÑÏÜ° Í∏∞Î°ù Î°úÎìú Ïò§Î•ò:', error);
            }
        }
        
        // Ï†ÑÏÜ° ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateSendTime(method, record) {
            const elementId = method === 'kakao' ? 'kakao-last-sent' : `${method}-last-sent`;
            const element = document.getElementById(elementId);
            
            if (!element) return;
            
            if (record && record.sent_at) {
                const sentDate = new Date(record.sent_at);
                const formatted = sentDate.toLocaleString('ko-KR', {
                    month: 'numeric',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                element.querySelector('span').textContent = `ÏµúÍ∑º Ï†ÑÏÜ°: ${formatted}`;
                element.style.display = 'block';
            } else {
                element.style.display = 'none';
            }
        }
        
        function getMethodIcon(method) {
            const icons = {
                'email': 'envelope-fill',
                'kakao': 'chat-dots-fill',
                'sms': 'phone-fill',
                'link': 'link-45deg'
            };
            return icons[method] || 'info-circle';
        }
        
        // Î∞îÏö∞Ï≤ò ÎßÅÌÅ¨ Î≥µÏÇ¨
        function copyVoucherLink() {
            const linkInput = document.getElementById('voucher-link-url');
            linkInput.select();
            document.execCommand('copy');
            showAlert('‚úÖ ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!', 'success');
        }
        
        // Ïπ¥Ïπ¥Ïò§ÌÜ°Ïö© ÎßÅÌÅ¨ Î≥µÏÇ¨
        function copyVoucherLinkForKakao() {
            const reservation = getReservationData(window.currentReservationId);
            const link = document.getElementById('voucher-link-url').value;
            
            // ÎÇ†Ïßú Ìè¨Îß∑ÌåÖ (YYYY-MM-DD)
            const usageDate = reservation.usage_date ? new Date(reservation.usage_date).toISOString().split('T')[0] : '';
            
            // ÏòàÏïΩ ÏóÖÏ≤¥Î™Ö (platform_name)
            const platform = reservation.platform_name || 'Ïò®ÎùºÏù∏';
            
            // Î©îÏãúÏßÄ Íµ¨ÏÑ±
            const title = `ÏòàÏïΩÎ∞îÏö∞Ï≤ò(${usageDate})`;
            const message = `[${platform}]ÏóêÏÑú ÏòàÏïΩÌïòÏã†\n${title}\n\n${reservation.korean_name}Îãò, ÏïàÎÖïÌïòÏÑ∏Ïöî!\nÏòàÏïΩÌïòÏã† ${reservation.product_name}Ïùò Î∞îÏö∞Ï≤òÎ•º Ï†ÑÏÜ°ÎìúÎ¶ΩÎãàÎã§.\n\nÎ∞îÏö∞Ï≤ò ÌôïÏù∏: ${link}\n\nÍ∞êÏÇ¨Ìï©ÎãàÎã§.`;
            
            navigator.clipboard.writeText(message).then(() => {
                showAlert('‚úÖ Î©îÏãúÏßÄÍ∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!\nÏπ¥Ïπ¥Ïò§ÌÜ°ÏúºÎ°ú Ï†ÑÏÜ°ÌïòÏÑ∏Ïöî.', 'success');
                // Ï†ÑÏÜ° ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
                updateSendTime('kakao', { sent_at: new Date().toISOString() });
            });
        }
        
        // AIÎ°ú Ïù¥Î©îÏùº ÏûêÎèô ÏûëÏÑ± + Ï¶âÏãú Ï†ÑÏÜ°
        async function sendVoucherEmailWithAI() {
            const reservation = getReservationData(window.currentReservationId);
            
            // Ïù¥Î©îÏùº Ï£ºÏÜå ÌôïÏù∏
            if (!reservation.email) {
                showAlert('Í≥†Í∞ù Ïù¥Î©îÏùº Ï£ºÏÜåÍ∞Ä ÏóÜÏäµÎãàÎã§. ÏòàÏïΩ Ï†ïÎ≥¥Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                return;
            }
            
            if (!confirm(`${reservation.email}Î°ú Î∞îÏö∞Ï≤òÎ•º Ï†ÑÏÜ°ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nAIÍ∞Ä ÏûêÎèôÏúºÎ°ú Ï†ÑÎ¨∏Ï†ÅÏù∏ Ïù¥Î©îÏùºÏùÑ ÏûëÏÑ±ÌïòÏó¨ Î∞úÏÜ°Ìï©ÎãàÎã§.`)) {
                return;
            }
            
            try {
                showAlert('ü§ñ AIÍ∞Ä Ïù¥Î©îÏùºÏùÑ ÏûëÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...', 'info');
                
                const voucherUrl = document.getElementById('voucher-link-url').value;
                
                // 1Îã®Í≥Ñ: AIÎ°ú Ïù¥Î©îÏùº ÎÇ¥Ïö© ÏÉùÏÑ±
                console.log('ü§ñ AI Ïù¥Î©îÏùº ÏÉùÏÑ± Ï§ë...');
                const aiResponse = await fetch('/api/vouchers/generate-email-ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reservation_id: window.currentReservationId,
                        customer_name: reservation.korean_name,
                        product_name: reservation.product_name,
                        usage_date: reservation.usage_date,
                        usage_time: reservation.usage_time,
                        platform_name: reservation.platform_name,
                        people_adult: reservation.people_adult,
                        people_child: reservation.people_child,
                        voucher_url: voucherUrl
                    })
                });
                
                const aiResult = await aiResponse.json();
                
                if (!aiResult.success) {
                    showAlert('AI ÏÉùÏÑ± Ïã§Ìå®: ' + aiResult.message, 'danger');
                    return;
                }
                
                console.log('‚úÖ AI Ïù¥Î©îÏùº ÏÉùÏÑ± ÏôÑÎ£å');
                showAlert('üìß Ïù¥Î©îÏùºÏùÑ Î∞úÏÜ°ÌïòÍ≥† ÏûàÏäµÎãàÎã§...', 'info');
                
                // 2Îã®Í≥Ñ: ÏÉùÏÑ±Îêú ÎÇ¥Ïö©ÏúºÎ°ú Ïù¥Î©îÏùº Ï†ÑÏÜ°
                const sendResponse = await fetch(`/api/vouchers/send-email/${window.currentReservationId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        recipient: reservation.email,
                        subject: aiResult.subject,
                        message: aiResult.message,
                        voucher_token: window.currentVoucherToken
                    })
                });
                
                const sendResult = await sendResponse.json();
                
                if (sendResult.success) {
                    showAlert(`‚úÖ ${reservation.email}Î°ú Î∞îÏö∞Ï≤òÍ∞Ä Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§!`, 'success');
                    
                    // Ï†ÑÏÜ° ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
                    updateSendTime('email', { sent_at: new Date().toISOString() });
                    
                    // ÌûàÏä§ÌÜ†Î¶¨ ÏÉàÎ°úÍ≥†Ïπ®
                    if (window.currentReservationId) {
                        await loadAllHistory(window.currentReservationId);
                    }
                } else {
                    showAlert('Ïù¥Î©îÏùº Ï†ÑÏÜ° Ïã§Ìå®: ' + sendResult.message, 'danger');
                }
                
            } catch (error) {
                console.error('‚ùå Ïù¥Î©îÏùº Ï†ÑÏÜ° Ïò§Î•ò:', error);
                showAlert('Ïù¥Î©îÏùº Ï†ÑÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'danger');
            }
        }
        
        // Ïù¥Î©îÏùº Ï†ÑÏÜ° Ìèº Ïó¥Í∏∞
        function openEmailSendForm() {
            document.getElementById('email-send-form').style.display = 'block';
        }
        
        // Ïù¥Î©îÏùº Ï†ÑÏÜ° Ìèº Îã´Í∏∞
        function closeEmailSendForm() {
            document.getElementById('email-send-form').style.display = 'none';
        }
        
        // AIÎ°ú Ïù¥Î©îÏùº ÎÇ¥Ïö© ÏÉùÏÑ±
        async function generateEmailWithAI() {
            const btn = document.getElementById('ai-generate-btn');
            const originalText = btn.innerHTML;
            
            try {
                // Î≤ÑÌäº Î°úÎî© ÏÉÅÌÉú
                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>AI ÏÉùÏÑ± Ï§ë...';
                
                const reservation = getReservationData(window.currentReservationId);
                const voucherUrl = document.getElementById('voucher-link-url').value;
                
                console.log('ü§ñ AI Ïù¥Î©îÏùº ÏÉùÏÑ± ÏöîÏ≤≠...');
                
                const response = await fetch('/api/vouchers/generate-email-ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reservation_id: window.currentReservationId,
                        customer_name: reservation.korean_name,
                        product_name: reservation.product_name,
                        usage_date: reservation.usage_date,
                        usage_time: reservation.usage_time,
                        platform_name: reservation.platform_name,
                        people_adult: reservation.people_adult,
                        people_child: reservation.people_child,
                        voucher_url: voucherUrl
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // ÏÉùÏÑ±Îêú ÎÇ¥Ïö©ÏúºÎ°ú Ìèº Ï±ÑÏö∞Í∏∞
                    document.getElementById('email-subject').value = result.subject;
                    document.getElementById('email-message').value = result.message;
                    
                    showAlert('‚ú® AIÍ∞Ä Ï†ÑÎ¨∏Ï†ÅÏù∏ Ïù¥Î©îÏùºÏùÑ ÏûëÏÑ±ÌñàÏäµÎãàÎã§!', 'success');
                    console.log('‚úÖ AI Ïù¥Î©îÏùº ÏÉùÏÑ± ÏôÑÎ£å');
                } else {
                    showAlert('AI ÏÉùÏÑ± Ïã§Ìå®: ' + result.message, 'danger');
                }
                
            } catch (error) {
                console.error('‚ùå AI ÏÉùÏÑ± Ïò§Î•ò:', error);
                showAlert('AI ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'danger');
            } finally {
                // Î≤ÑÌäº ÏõêÏÉÅÎ≥µÍµ¨
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        // Ïù¥Î©îÏùº Ï†ÑÏÜ°
        async function sendVoucherEmail() {
            const recipient = document.getElementById('email-recipient').value.trim();
            const subject = document.getElementById('email-subject').value.trim();
            const message = document.getElementById('email-message').value.trim();
            
            if (!recipient) {
                showAlert('Î∞õÎäî ÏÇ¨Îûå Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`/api/vouchers/send-email/${window.currentReservationId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        recipient,
                        subject,
                        message,
                        voucher_token: window.currentVoucherToken
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('‚úÖ Ïù¥Î©îÏùºÏù¥ Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§!', 'success');
                    closeEmailSendForm();
                    // ÌûàÏä§ÌÜ†Î¶¨Ïóê ÏûêÎèô Í∏∞Î°ùÎê®
                } else {
                    showAlert('Ïù¥Î©îÏùº Ï†ÑÏÜ° Ïã§Ìå®: ' + result.message, 'danger');
                }
            } catch (error) {
                console.error('‚ùå Ïù¥Î©îÏùº Ï†ÑÏÜ° Ïò§Î•ò:', error);
                showAlert('Ïù¥Î©îÏùº Ï†ÑÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'danger');
            }
        }
        
        // Ïπ¥Ïπ¥Ïò§ ÏïåÎ¶ºÌÜ° Ï†ÑÏÜ°
        async function sendKakaoAlimtalk() {
            if (!confirm('üí¨ Í≥†Í∞ùÎãòÍªò Î∞îÏö∞Ï≤ò ÏïåÎ¶ºÌÜ°ÏùÑ Ï†ÑÏÜ°ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏ†ÑÏÜ°Îê† ÎÇ¥Ïö©:\n- ÏÉÅÌíàÎ™Ö Î∞îÏö∞Ï≤ò\n- ÏòàÏïΩÏóÖÏ≤¥ Î∞è Ïù¥Ïö©Ïùº\n- Î∞îÏö∞Ï≤ò ÎßÅÌÅ¨ Î≤ÑÌäº')) return;
            
            try {
                // Î°úÎî© ÌëúÏãú
                const alimtalkCard = document.querySelector('.card.border-warning.voucher-send-card');
                if (alimtalkCard) {
                    const originalHtml = alimtalkCard.innerHTML;
                    alimtalkCard.innerHTML = `
                        <div class="card-body text-center">
                            <div class="spinner-border text-warning" role="status"></div>
                            <h6 class="mt-2 mb-1">Ï†ÑÏÜ° Ï§ë...</h6>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        alimtalkCard.innerHTML = originalHtml;
                    }, 3000);
                }
                
                const response = await fetch(`/api/vouchers/send-kakao/${window.currentReservationId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('üéâ Î∞îÏö∞Ï≤ò ÏïåÎ¶ºÌÜ°Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§!', 'success');
                    
                    // Ï†ÑÏÜ° ÏãúÍ∞Å ÌëúÏãú
                    const lastSentElement = document.getElementById('alimtalk-last-sent');
                    if (lastSentElement) {
                        const now = new Date().toLocaleString('ko-KR');
                        lastSentElement.querySelector('span').textContent = `Ï†ÑÏÜ°: ${now}`;
                        lastSentElement.style.display = 'block';
                    }
                    
                    // Î∞îÏö∞Ï≤ò Ïó¥Îûå ÌÜµÍ≥Ñ ÏÉàÎ°úÍ≥†Ïπ®
                    loadVoucherViewStats();
                } else {
                    if (result.devMode) {
                        showAlert('‚ö†Ô∏è Í∞úÎ∞ú Î™®Îìú: ' + result.message, 'info');
                    } else {
                        showAlert('‚ùå ÏïåÎ¶ºÌÜ° Ï†ÑÏÜ° Ïã§Ìå®: ' + result.message, 'danger');
                    }
                }
            } catch (error) {
                console.error('‚ùå ÏïåÎ¶ºÌÜ° Ï†ÑÏÜ° Ïò§Î•ò:', error);
                showAlert(`‚ùå ÏïåÎ¶ºÌÜ° Ï†ÑÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. (${error.message})`, 'danger');
            }
        }
        
        // SMS Ï†ÑÏÜ°
        async function sendSMS() {
            if (!confirm('Î¨∏Ïûê Î©îÏãúÏßÄÎ•º Ï†ÑÏÜ°ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            try {
                const response = await fetch(`/api/vouchers/send-sms/${window.currentReservationId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        voucher_token: window.currentVoucherToken
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('‚úÖ Î¨∏Ïûê Î©îÏãúÏßÄÍ∞Ä Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§!', 'success');
                    // ÌûàÏä§ÌÜ†Î¶¨Ïóê ÏûêÎèô Í∏∞Î°ùÎê®
                } else {
                    showAlert('SMS Ï†ÑÏÜ° Ïã§Ìå®: ' + result.message, 'warning');
                }
            } catch (error) {
                console.error('‚ùå SMS Ï†ÑÏÜ° Ïò§Î•ò:', error);
                showAlert('SMS API Ïó∞ÎèôÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.', 'info');
            }
        }
        
        // Î∞îÏö∞Ï≤ò ÏÉà Ï∞Ω Ïó¥Í∏∞ (Í≥†Í∞ùÏù¥ Î∞õÎäî ÎßÅÌÅ¨ÏôÄ ÎèôÏùº)
        function openVoucherPreview() {
            // Î∞îÏö∞Ï≤ò URL Í∞ÄÏ†∏Ïò§Í∏∞ (Í≥†Í∞ùÍ≥º ÎèôÏùºÌïú ÎßÅÌÅ¨)
            const voucherUrl = document.getElementById('voucher-link-url').value;
            
            if (!voucherUrl || voucherUrl === 'Î∞îÏö∞Ï≤òÍ∞Ä ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.' || !voucherUrl.startsWith('http')) {
                showAlert('‚ùå Ïú†Ìö®Ìïú Î∞îÏö∞Ï≤ò ÎßÅÌÅ¨Í∞Ä ÏóÜÏäµÎãàÎã§.', 'warning');
                return;
            }
            
            console.log('üîó Í≥†Í∞ù ÎßÅÌÅ¨ÏôÄ ÎèôÏùºÌïú Î∞îÏö∞Ï≤ò Ïó¥Í∏∞:', voucherUrl);
            
            // Í≥†Í∞ùÏù¥ Î∞õÎäî ÎßÅÌÅ¨ÏôÄ ÎèôÏùºÌïòÍ≤å Ïó¥Í∏∞
            const newWindow = window.open(voucherUrl, '_blank');
            
            if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                showAlert('‚ö†Ô∏è ÌåùÏóÖÏù¥ Ï∞®Îã®ÎêòÏóàÏäµÎãàÎã§. Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏóêÏÑú ÌåùÏóÖÏùÑ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
            }
        }
        
        // Î∞îÏö∞Ï≤ò Ïû¨ÏÉùÏÑ± Í∏∞Îä• Ï†úÍ±∞Îê® (ÏòàÏïΩ Ï∑®ÏÜå Ïãú ÏûêÎèô Î¨¥Ìö®Ìôî)

        // 5. Ï†ïÏÇ∞Ïù¥Í¥Ä Î™®Îã¨ Ïó¥Í∏∞
        async function openSettlementModal(reservationId) {
            highlightSelectedReservation(reservationId);
            
            const reservation = getReservationData(reservationId);
            if (!reservation) {
                alert('ÏòàÏïΩ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            window.currentReservationId = reservationId;
            
            // ÏÉÅÌíàÏ†ïÎ≥¥ ÏöîÏïΩ Ï±ÑÏö∞Í∏∞
            document.getElementById('settlement-reservation-id').value = reservationId;
            document.getElementById('settlement-platform-name').textContent = reservation.platform_name || '-';
            document.getElementById('settlement-product-name').textContent = reservation.product_name || '-';
            document.getElementById('settlement-package-type').textContent = reservation.package_type || '-';
            document.getElementById('settlement-usage-date').textContent = reservation.usage_date || '-';
            document.getElementById('settlement-vendor-name').textContent = reservation.vendor_name || '-';
            document.getElementById('settlement-adult-count').textContent = reservation.people_adult || 0;
            document.getElementById('settlement-child-count').textContent = reservation.people_child || 0;
            document.getElementById('settlement-infant-count').textContent = reservation.people_infant || 0;
            
            // ÏûÖÎ†•Í∞í Ï¥àÍ∏∞Ìôî
            document.getElementById('settlement-sale-currency').value = 'KRW';
            document.getElementById('settlement-sale-adult').value = '';
            document.getElementById('settlement-sale-child').value = '';
            document.getElementById('settlement-sale-infant').value = '';
            document.getElementById('settlement-commission-rate').value = '10';
            
            document.getElementById('settlement-cost-currency').value = 'USD';
            document.getElementById('settlement-cost-adult').value = '';
            document.getElementById('settlement-cost-child').value = '';
            document.getElementById('settlement-cost-infant').value = '';
            
            document.getElementById('settlement-exchange-rate').value = '1330';
            document.getElementById('settlement-memo').value = '';
            
            // ÌôòÏú® ÏûêÎèô Î°úÎìú (Ïù¥Ïö©Ïùº Í∏∞Ï§Ä)
            if (reservation.usage_date) {
                try {
                    const usageDate = new Date(reservation.usage_date);
                    const dayBefore = new Date(usageDate);
                    dayBefore.setDate(dayBefore.getDate() - 1);
                    const fxDate = dayBefore.toISOString().split('T')[0];
                    
                    const response = await fetch(`/api/exchange-rates?date=${fxDate}`);
                    const result = await response.json();
                    
                    if (result.success && result.data && result.data.length > 0) {
                        const usdRate = result.data.find(r => r.currency_code === 'USD');
                        if (usdRate) {
                            document.getElementById('settlement-exchange-rate').value = usdRate.rate;
                            console.log('‚úÖ ÌôòÏú® ÏûêÎèô Î°úÎìú:', usdRate.rate);
                        }
                    }
                } catch (error) {
                    console.error('‚ùå ÌôòÏú® Î°úÎìú Ïã§Ìå®:', error);
                }
            }
            
            // Í≥ÑÏÇ∞ Ï¥àÍ∏∞Ìôî
            calculateSettlement();
            
            const modal = new bootstrap.Modal(document.getElementById('settlementModal'));
            modal.show();
        }
        
        // Ï†ïÏÇ∞ Í≥ÑÏÇ∞ Ìï®Ïàò
        function calculateSettlement() {
            const adultCount = parseInt(document.getElementById('settlement-adult-count').textContent) || 0;
            const childCount = parseInt(document.getElementById('settlement-child-count').textContent) || 0;
            const infantCount = parseInt(document.getElementById('settlement-infant-count').textContent) || 0;
            
            // Í±∞ÎûòÏï° Í≥ÑÏÇ∞
            const saleCurrency = document.getElementById('settlement-sale-currency').value;
            const saleAdult = parseFloat(document.getElementById('settlement-sale-adult').value) || 0;
            const saleChild = parseFloat(document.getElementById('settlement-sale-child').value) || 0;
            const saleInfant = parseFloat(document.getElementById('settlement-sale-infant').value) || 0;
            
            const totalSale = (saleAdult * adultCount) + (saleChild * childCount) + (saleInfant * infantCount);
            document.getElementById('settlement-total-sale').value = totalSale.toFixed(2);
            
            // ÏàòÏàòÎ£å Í≥ÑÏÇ∞
            const commissionRate = parseFloat(document.getElementById('settlement-commission-rate').value) || 0;
            const commissionAmount = totalSale * (commissionRate / 100);
            document.getElementById('settlement-commission-amount').value = commissionAmount.toFixed(2);
            
            // ÏûÖÍ∏àÎ∞õÏùÑÍ∏àÏï° (ÌåêÎß§Í∞Ä - ÏàòÏàòÎ£å)
            const netRevenue = totalSale - commissionAmount;
            document.getElementById('settlement-net-revenue').value = netRevenue.toFixed(2);
            
            // Îß§ÏûÖ Í≥ÑÏÇ∞
            const costCurrency = document.getElementById('settlement-cost-currency').value;
            const costAdult = parseFloat(document.getElementById('settlement-cost-adult').value) || 0;
            const costChild = parseFloat(document.getElementById('settlement-cost-child').value) || 0;
            const costInfant = parseFloat(document.getElementById('settlement-cost-infant').value) || 0;
            
            const totalCost = (costAdult * adultCount) + (costChild * childCount) + (costInfant * infantCount);
            document.getElementById('settlement-total-cost').value = totalCost.toFixed(2);
            
            // ÌôòÏú® Ï†ÅÏö© Î∞è ÎßàÏßÑ Í≥ÑÏÇ∞
            const exchangeRate = parseFloat(document.getElementById('settlement-exchange-rate').value) || 1330;
            
            let netRevenueKRW = netRevenue;
            let totalCostKRW = totalCost;
            
            // Í±∞ÎûòÏï°Ïù¥ USDÎ©¥ KRWÎ°ú ÌôòÏÇ∞
            if (saleCurrency === 'USD') {
                netRevenueKRW = netRevenue * exchangeRate;
            }
            
            // Îß§ÏûÖÏù¥ USDÎ©¥ KRWÎ°ú ÌôòÏÇ∞
            if (costCurrency === 'USD') {
                totalCostKRW = totalCost * exchangeRate;
            }
            
            document.getElementById('settlement-cost-krw').value = totalCostKRW.toFixed(0);
            
            // ÎßàÏßÑ Í≥ÑÏÇ∞ (ÏõêÌôî Í∏∞Ï§Ä)
            const marginKRW = netRevenueKRW - totalCostKRW;
            const marginRate = netRevenueKRW > 0 ? (marginKRW / netRevenueKRW * 100) : 0;
            
            document.getElementById('settlement-margin-krw').value = marginKRW.toFixed(0);
            document.getElementById('settlement-margin-rate').value = marginRate.toFixed(2);
        }
        
        // AI ÏöîÍ∏àÍ∞í ÌååÏã± (RAG Ï∞∏Ï°∞)
        async function aiParsePriceRag() {
            const productName = document.getElementById('settlement-product-name').textContent;
            const packageType = document.getElementById('settlement-package-type').textContent;
            const vendorName = document.getElementById('settlement-vendor-name').textContent;
            
            if (!productName || productName === '-') {
                alert('ÏÉÅÌíàÎ™ÖÏù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            try {
                console.log('ü§ñ AI ÏöîÍ∏àÍ∞í ÌååÏã± ÏãúÏûë:', { productName, packageType, vendorName });
                
                // RAG Î¨∏ÏÑú Í≤ÄÏÉâ
                const response = await fetch(`/api/price-rag/documents?search=${encodeURIComponent(productName)}`);
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    // Í∞ÄÏû• ÏùºÏπòÌïòÎäî Î¨∏ÏÑú Ï∞æÍ∏∞
                    let matchedDoc = result.data[0];
                    
                    // Ìå®ÌÇ§ÏßÄÎ™ÖÏù¥ ÏûàÏúºÎ©¥ Ìå®ÌÇ§ÏßÄÍπåÏßÄ ÏùºÏπòÌïòÎäî Í≤É Ï∞æÍ∏∞
                    if (packageType && packageType !== '-') {
                        const packageMatch = result.data.find(doc => 
                            doc.package_name && doc.package_name.includes(packageType)
                        );
                        if (packageMatch) {
                            matchedDoc = packageMatch;
                        }
                    }
                    
                    // ÏàòÎ∞∞ÏóÖÏ≤¥Î™ÖÏúºÎ°ú ÌïúÎ≤à Îçî ÌïÑÌÑ∞ÎßÅ
                    if (vendorName && vendorName !== '-') {
                        const vendorMatch = result.data.find(doc => 
                            doc.supplier_name && doc.supplier_name.includes(vendorName)
                        );
                        if (vendorMatch) {
                            matchedDoc = vendorMatch;
                        }
                    }
                    
                    console.log('‚úÖ Îß§Ïπ≠Îêú RAG Î¨∏ÏÑú:', matchedDoc);
                    
                    // Í±∞ÎûòÏï° ÌïÑÎìú Ï±ÑÏö∞Í∏∞
                    document.getElementById('settlement-sale-currency').value = matchedDoc.sale_currency || 'KRW';
                    document.getElementById('settlement-sale-adult').value = matchedDoc.sale_adult_price || 0;
                    document.getElementById('settlement-sale-child').value = matchedDoc.sale_child_price || 0;
                    document.getElementById('settlement-sale-infant').value = matchedDoc.sale_infant_price || 0;
                    document.getElementById('settlement-commission-rate').value = matchedDoc.commission_rate || 10;
                    
                    // Îß§ÏûÖ ÌïÑÎìú Ï±ÑÏö∞Í∏∞
                    document.getElementById('settlement-cost-currency').value = matchedDoc.cost_currency || 'USD';
                    document.getElementById('settlement-cost-adult').value = matchedDoc.cost_adult_price || 0;
                    document.getElementById('settlement-cost-child').value = matchedDoc.cost_child_price || 0;
                    document.getElementById('settlement-cost-infant').value = matchedDoc.cost_infant_price || 0;
                    
                    // Ïû¨Í≥ÑÏÇ∞
                    calculateSettlement();
                    
                    alert('‚úÖ AI ÏöîÍ∏àÍ∞í ÌååÏã± ÏôÑÎ£å!\n\nÎß§Ïπ≠Îêú ÏÉÅÌíà: ' + matchedDoc.product_name + 
                          (matchedDoc.package_name ? ' (' + matchedDoc.package_name + ')' : ''));
                } else {
                    alert('‚ùå Îì±Î°ùÎêú ÏöîÍ∏à Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.\n\nÏ†ïÏÇ∞Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄ > ÏöîÍ∏à RAG Î¨∏ÏÑú ÌÉ≠ÏóêÏÑú\nÎ®ºÏ†Ä ÏöîÍ∏à Ï†ïÎ≥¥Î•º Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî.');
                }
            } catch (error) {
                console.error('‚ùå AI ÏöîÍ∏àÍ∞í ÌååÏã± Ïã§Ìå®:', error);
                alert('ÏöîÍ∏àÍ∞í ÌååÏã± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        // Ï†ïÏÇ∞Ïù¥Í¥Ä Ï†ÄÏû•
        async function saveSettlementTransfer() {
            const reservationId = document.getElementById('settlement-reservation-id').value;
            
            if (!reservationId) {
                alert('ÏòàÏïΩ IDÍ∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            // ÌïÑÏàòÍ∞í Ï≤¥ÌÅ¨
            const totalSale = parseFloat(document.getElementById('settlement-total-sale').value) || 0;
            const totalCost = parseFloat(document.getElementById('settlement-total-cost').value) || 0;
            
            if (totalSale === 0 && totalCost === 0) {
                alert('Í±∞ÎûòÏï° ÎòêÎäî Îß§ÏûÖ Í∏àÏï°ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const settlementData = {
                reservation_id: reservationId,
                
                // Í±∞ÎûòÏï° Ï†ïÎ≥¥
                sale_currency: document.getElementById('settlement-sale-currency').value,
                sale_adult_price: parseFloat(document.getElementById('settlement-sale-adult').value) || 0,
                sale_child_price: parseFloat(document.getElementById('settlement-sale-child').value) || 0,
                sale_infant_price: parseFloat(document.getElementById('settlement-sale-infant').value) || 0,
                total_sale: totalSale,
                commission_rate: parseFloat(document.getElementById('settlement-commission-rate').value) || 0,
                commission_amount: parseFloat(document.getElementById('settlement-commission-amount').value) || 0,
                net_revenue: parseFloat(document.getElementById('settlement-net-revenue').value) || 0,
                
                // Îß§ÏûÖ Ï†ïÎ≥¥
                cost_currency: document.getElementById('settlement-cost-currency').value,
                cost_adult_price: parseFloat(document.getElementById('settlement-cost-adult').value) || 0,
                cost_child_price: parseFloat(document.getElementById('settlement-cost-child').value) || 0,
                cost_infant_price: parseFloat(document.getElementById('settlement-cost-infant').value) || 0,
                total_cost: totalCost,
                
                // ÌôòÏú® Î∞è ÎßàÏßÑ
                exchange_rate: parseFloat(document.getElementById('settlement-exchange-rate').value) || 1330,
                cost_krw: parseFloat(document.getElementById('settlement-cost-krw').value) || 0,
                margin_krw: parseFloat(document.getElementById('settlement-margin-krw').value) || 0,
                margin_rate: parseFloat(document.getElementById('settlement-margin-rate').value) || 0,
                
                // Î©îÎ™®
                memo: document.getElementById('settlement-memo').value
            };
            
            try {
                console.log('üíæ Ï†ïÏÇ∞Ïù¥Í¥Ä Ï†ÄÏû• ÏãúÏûë:', settlementData);
                
                const response = await fetch(`/api/reservations/${reservationId}/settlement`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settlementData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Ï†ïÏÇ∞Ïù¥Í¥ÄÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!\n\nÏ†ïÏÇ∞Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄÏóêÏÑú ÌôïÏù∏ÌïòÏã§ Ïàò ÏûàÏäµÎãàÎã§.');
                    
                    // Î™®Îã¨ Îã´Í∏∞
                    const modal = bootstrap.Modal.getInstance(document.getElementById('settlementModal'));
                    modal.hide();
                    
                    // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                    loadAssignments();
                } else {
                    alert('‚ùå Ï†ïÏÇ∞Ïù¥Í¥Ä Ïã§Ìå®: ' + (result.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                }
            } catch (error) {
                console.error('‚ùå Ï†ïÏÇ∞Ïù¥Í¥Ä Ï†ÄÏû• Ïã§Ìå®:', error);
                alert('Ï†ïÏÇ∞Ïù¥Í¥Ä Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        // 6. ÏóÖÎ¨¥ÌûàÏä§ÌÜ†Î¶¨ Î™®Îã¨ Ïó¥Í∏∞
        async function openHistoryModal(reservationId) {
            highlightSelectedReservation(reservationId);
            
            const reservation = getReservationData(reservationId);
            if (!reservation) return;
            
            window.currentReservationId = reservationId;
            
            const modal = new bootstrap.Modal(document.getElementById('historyModal'));
            modal.show();
            
            // Î™®Îì† ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú
            await loadAllHistory(reservationId);
        }
        
        // Î™®Îì† ÏóÖÎ¨¥ ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú (ÏòàÏïΩÎ≥ÄÍ≤Ω, ÏàòÎ∞∞ÏÑú, ÏÉÅÌÉúÎ≥ÄÍ≤Ω, Î∞îÏö∞Ï≤ò, Ï†ïÏÇ∞ Îì± Î™®Îì† Ïï°ÏÖò)
        async function loadAllHistory(reservationId) {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '<p class="text-center text-muted">ÌûàÏä§ÌÜ†Î¶¨Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>';
            
            try {
                console.log('üîç ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú ÏãúÏûë:', reservationId);
                const response = await fetch(`/api/reservations/${reservationId}/history`);
                console.log('üì° ÏùëÎãµ ÏÉÅÌÉú:', response.status);
                const result = await response.json();
                console.log('üì¶ ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:', result);
                
                if (result.success && result.history) {
                    const history = result.history;
                    
                    if (history.length === 0) {
                        historyList.innerHTML = '<p class="text-center text-muted">ÏïÑÏßÅ ÌûàÏä§ÌÜ†Î¶¨Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                        return;
                    }
                    
                    // ÌûàÏä§ÌÜ†Î¶¨Î•º ÏµúÏã†ÏàúÏúºÎ°ú Ï†ïÎ†¨
                    history.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    
                    const historyHTML = history.map(item => {
                        const date = new Date(item.created_at);
                        const dateStr = date.toLocaleString('ko-KR', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÏïÑÏù¥ÏΩò Î∞è ÏÉâÏÉÅ (ÏÉàÎ°úÏö¥ Ïä§ÌÇ§Îßà)
                        const categoryConfig = {
                            'ÏòàÏïΩ': { icon: 'bi-calendar-check', color: '#6366f1', bgColor: '#eef2ff', borderColor: '#c7d2fe' },
                            'ÏàòÎ∞∞': { icon: 'bi-truck', color: '#0891b2', bgColor: '#cffafe', borderColor: '#67e8f9' },
                            'Î∞îÏö∞Ï≤ò': { icon: 'bi-ticket-perforated', color: '#059669', bgColor: '#d1fae5', borderColor: '#6ee7b7' },
                            'Ï†ïÏÇ∞': { icon: 'bi-cash-coin', color: '#dc2626', bgColor: '#fee2e2', borderColor: '#fca5a5' },
                            'ÏãúÏä§ÌÖú': { icon: 'bi-gear', color: '#64748b', bgColor: '#f1f5f9', borderColor: '#cbd5e1' }
                        };
                        
                        const category = item.category || 'ÏãúÏä§ÌÖú';
                        const config = categoryConfig[category] || categoryConfig['ÏãúÏä§ÌÖú'];
                        
                        // Ïï°ÏÖòÎ≥Ñ ÌÖçÏä§Ìä∏
                        const actionText = item.action || '-';
                        
                        // changes ÏïàÏ†ÑÌïòÍ≤å ÌååÏã±
                        let changesHTML = '';
                        if (item.changes) {
                            try {
                                const changesObj = typeof item.changes === 'string' ? JSON.parse(item.changes) : item.changes;
                                const entries = Object.entries(changesObj).map(([key, value]) => {
                                    if (value && value.from !== undefined && value.to !== undefined) {
                                        return `
                                            <div class="d-flex align-items-center gap-2 small mb-1">
                                                <span class="badge bg-light text-dark">${value.from}</span>
                                                <i class="bi bi-arrow-right" style="color: ${config.color}"></i>
                                                <span class="badge" style="background-color: ${config.color}">${value.to}</span>
                                            </div>
                                        `;
                                    }
                                    return '';
                                }).filter(html => html !== '').join('');
                                
                                if (entries) {
                                    changesHTML = `
                                        <div class="mt-2 p-2 rounded" style="background-color: ${config.bgColor}">
                                            <div class="small fw-bold mb-2" style="color: ${config.color}">üìã Î≥ÄÍ≤Ω ÎÇ¥Ïó≠</div>
                                            ${entries}
                                        </div>
                                    `;
                                }
                            } catch (e) {
                                console.error('Î≥ÄÍ≤ΩÏÇ¨Ìï≠ ÌååÏã± Ïò§Î•ò:', e, item.changes);
                            }
                        }
                        
                        // Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ ÌëúÏãú
                        let metadataHTML = '';
                        if (item.metadata) {
                            try {
                                const metadata = typeof item.metadata === 'string' ? JSON.parse(item.metadata) : item.metadata;
                                const metaEntries = Object.entries(metadata)
                                    .filter(([key, value]) => value && key !== 'reservation_number')
                                    .map(([key, value]) => `<span class="badge bg-light text-dark me-1">${key}: ${value}</span>`)
                                    .join('');
                                
                                if (metaEntries) {
                                    metadataHTML = `<div class="mt-2">${metaEntries}</div>`;
                                }
                            } catch (e) {
                                console.error('Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ ÌååÏã± Ïò§Î•ò:', e);
                            }
                        }
                        
                        return `
                            <div class="mb-3 p-3 rounded" style="background-color: ${config.bgColor}; border-left: 4px solid ${config.color}">
                                <div class="d-flex align-items-start justify-content-between mb-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="d-flex align-items-center justify-content-center" 
                                             style="width: 32px; height: 32px; background-color: white; border-radius: 50%; border: 2px solid ${config.borderColor}">
                                            <i class="bi ${config.icon}" style="color: ${config.color}; font-size: 14px;"></i>
                                        </div>
                                        <div>
                                            <div class="fw-bold" style="color: ${config.color}">${category} ¬∑ ${actionText}</div>
                                            <div class="small text-muted">
                                                <i class="bi bi-person-circle me-1"></i>${item.changed_by || 'ÏãúÏä§ÌÖú'}
                                                <i class="bi bi-clock ms-2 me-1"></i>${dateStr}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="ms-5">
                                    <div class="mb-1" style="line-height: 1.6;">${item.description || 'ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÏóÜÏùå'}</div>
                                    ${changesHTML}
                                    ${metadataHTML}
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    historyList.innerHTML = historyHTML;
                } else {
                    console.error('ÌûàÏä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå:', result);
                    historyList.innerHTML = '<p class="text-center text-danger">ÌûàÏä§ÌÜ†Î¶¨Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.</p>';
                }
            } catch (error) {
                console.error('‚ùå ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú Ïò§Î•ò:', error);
                historyList.innerHTML = '<p class="text-center text-danger">ÌûàÏä§ÌÜ†Î¶¨Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</p>';
            }
        }

        // ÏòàÏïΩ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ìó¨Ìçº Ìï®Ïàò
        function getReservationData(reservationId) {
            // Ï†ÑÏó≠ Ï†ÄÏû•ÏÜåÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
            const reservation = window.reservationsData?.[reservationId];
            
            if (!reservation) {
                console.error('ÏòàÏïΩ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. reservationId:', reservationId);
                console.log('ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÏòàÏïΩ IDs:', Object.keys(window.reservationsData || {}));
                showAlert('ÏòàÏïΩ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'danger');
                return null;
            }
            
            return reservation;
        }

        // Î∞îÏö∞Ï≤ò ÏÉÅÌÉú ÌôïÏù∏
        async function checkVoucherStatus(reservationId) {
            try {
                const response = await fetch(`/api/reservations/${reservationId}`);
                const result = await response.json();
                
                if (result.success && result.reservation.voucher_token) {
                    // Î∞îÏö∞Ï≤òÍ∞Ä Ïù¥ÎØ∏ ÏÉùÏÑ±Îêú Í≤ΩÏö∞
                    const voucherUrl = `${window.location.origin}/voucher/${result.reservation.voucher_token}`;
                    document.getElementById('voucherLinkUrl').value = voucherUrl;
                    document.getElementById('voucherLinkGroup').style.display = 'flex';
                    document.getElementById('voucherLinkPlaceholder').style.display = 'none';
                    
                    // ÏÑ∏Ïù¥Î∏åÏπ¥Îìú ÏΩîÎìú ÌëúÏãú
                    if (result.reservation.savecard_code) {
                        document.getElementById('savecard-code').value = result.reservation.savecard_code;
                    }
                    
                    // Î∞îÏö∞Ï≤ò ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                    updateVoucherStatus(result.voucher);
                } else {
                    // Î∞îÏö∞Ï≤òÍ∞Ä ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞
                    document.getElementById('voucherLinkGroup').style.display = 'none';
                    document.getElementById('voucherLinkPlaceholder').style.display = 'block';
                }
            } catch (error) {
                console.error('Î∞îÏö∞Ï≤ò ÏÉÅÌÉú ÌôïÏù∏ Ïò§Î•ò:', error);
            }
        }
        
        // ÏàòÎ∞∞ÏÑú Î™®Îã¨ Ï†ïÎ≥¥ Ï±ÑÏö∞Í∏∞
        async function populateAssignmentModalDetails(reservation) {
            if (!reservation) {
                console.error('‚ùå ÏòàÏïΩ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§');
                return;
            }
            
            // ÏïàÏ†ÑÌïú Í∞í Ï∂îÏ∂ú Ìï®Ïàò
            const safeGet = (obj, key, defaultValue = '-') => {
                return obj && obj[key] !== undefined && obj[key] !== null ? obj[key] : defaultValue;
            };
            
            // Ìó§Îçî Ï†ïÎ≥¥ (Í∞ÑÎã®Ìïú ÏöîÏïΩ)
            const briefElement = document.getElementById('m-brief');
            if (briefElement) {
                briefElement.textContent = `${safeGet(reservation, 'korean_name')} | ${safeGet(reservation, 'product_name')} | ${formatDate(reservation.usage_date) || '-'}`;
            }
            
            // ÏòàÏïΩ Ï†ïÎ≥¥ (Ï†ëÏùÑ Ïàò ÏûàÎäî ÏÑπÏÖò) - ÏïàÏ†ÑÌïòÍ≤å DOM ÏöîÏÜå ÌôïÏù∏ ÌõÑ ÏÑ§Ï†ï
            const elements = {
                'detail-reservation-number': safeGet(reservation, 'reservation_number'),
                'detail-customer-name': safeGet(reservation, 'korean_name'),
                'detail-phone': safeGet(reservation, 'phone'),
                'detail-platform': safeGet(reservation, 'platform_name'),
                'detail-product-name': safeGet(reservation, 'product_name'),
                'detail-package-type': safeGet(reservation, 'package_type'),
                'detail-usage-date': formatDate(reservation.usage_date) || '-',
                'detail-memo': safeGet(reservation, 'memo')
            };
            
            // DOM ÏöîÏÜåÏóê Í∞í ÏÑ§Ï†ï
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                } else {
                    console.warn(`DOM ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§: ${id}`);
                }
            });
            
            // Ïù∏Ïõê Ï†ïÎ≥¥
            const peopleElement = document.getElementById('detail-people');
            if (peopleElement) {
                const people = `ÏÑ±Ïù∏ ${safeGet(reservation, 'people_adult', 0)}Î™Ö, ÏïÑÎèô ${safeGet(reservation, 'people_child', 0)}Î™Ö`;
                peopleElement.textContent = people;
            }
            
            // ÌòÑÏû¨ ÏòàÏïΩ IDÏôÄ Ï†ïÎ≥¥ Ï†ÄÏû•
            window.currentReservationId = reservation.id;
            window.currentReservation = reservation; // Ï†ÑÏ≤¥ ÏòàÏïΩ Ï†ïÎ≥¥ Ï†ÄÏû•
            console.log('ÌòÑÏû¨ ÏòàÏïΩ ID Ï†ÄÏû•:', window.currentReservationId);
            console.log('ÌòÑÏû¨ ÏòàÏïΩ Ï†ïÎ≥¥ Ï†ÄÏû•:', reservation);
            
            // ÏàòÎ∞∞ÏÑú Ï†ïÎ≥¥ Î°úÎìú
            if (reservation.id) {
                await loadAssignmentDetails(reservation.id);
            } else {
                console.error('ÏòàÏïΩ IDÍ∞Ä ÏóÜÏäµÎãàÎã§:', reservation);
            }
        }
        
        // ÏàòÎ∞∞ÏÑú ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î°úÎìú
        async function loadAssignmentDetails(reservationId) {
            try {
                const response = await fetch(`/api/assignments/by-reservation/${reservationId}`);
                
                if (!response.ok) {
                    console.error('‚ùå API ÏùëÎãµ Ïò§Î•ò:', response.status);
                    return;
                }
                
                const result = await response.json();
                
                console.log('üîç API ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:', result);
                
                if (result.success && result.assignment) {
                    const assignment = result.assignment;
                    
                    console.log('üìä ÏàòÎ∞∞ÏÑú Îç∞Ïù¥ÌÑ∞:', {
                        id: assignment.id,
                        sent_at: assignment.sent_at,
                        viewed_at: assignment.viewed_at,
                        vendor_name: assignment.vendor_name,
                        assignment_token: assignment.assignment_token
                    });
                    
                    // ÏàòÎ∞∞ÏÑú ÏÉÅÌÉú Ï†ïÎ≥¥
                    document.getElementById('assignment-number').textContent = assignment.id || '-';
                    document.getElementById('assignment-vendor').textContent = assignment.vendor_name || 'ÎØ∏ÏßÄÏ†ï';
                    document.getElementById('assignment-created').textContent = formatDateTime(assignment.assigned_at) || '-';
                    
                    // ÌîåÎû´ÌèºÎ™Ö ÌëúÏãú (ÏòàÏïΩÏóÖÏ≤¥)
                    const platformElement = document.getElementById('assignment-platform');
                    if (platformElement) {
                        // ÌòÑÏû¨ ÏòàÏïΩ Ï†ïÎ≥¥ÏóêÏÑú ÌîåÎû´ÌèºÎ™Ö Í∞ÄÏ†∏Ïò§Í∏∞
                        console.log('üîç ÌîåÎû´ÌèºÎ™Ö Ï°∞Ìöå ÏãúÏûë');
                        console.log('  - reservationId:', reservationId);
                        console.log('  - window.currentReservation:', window.currentReservation);
                        console.log('  - window.reservationsData[reservationId]:', window.reservationsData?.[reservationId]);
                        
                        const platformName = window.currentReservation?.platform_name || 
                                           window.reservationsData?.[reservationId]?.platform_name || '-';
                        platformElement.textContent = platformName;
                        console.log('‚úÖ ÌîåÎû´ÌèºÎ™Ö ÌëúÏãú:', platformName);
                    } else {
                        console.error('‚ùå assignment-platform ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                    }
                    
                    // Ïù¥Î©îÏùº Ï†ÑÏÜ° ÏÉÅÌÉú ÌëúÏãú
                    const emailStatusElement = document.getElementById('assignment-email-status');
                    if (emailStatusElement) {
                        if (assignment.sent_at) {
                            const sentTime = formatDateTime(assignment.sent_at);
                            emailStatusElement.innerHTML = `<span class="badge bg-success"><i class="bi bi-envelope-check me-1"></i>Ï†ÑÏÜ°Îê®</span> <small class="text-muted">${sentTime}</small>`;
                            console.log('‚úÖ Ïù¥Î©îÏùº Ï†ÑÏÜ°Îê®:', sentTime);
                        } else {
                            emailStatusElement.innerHTML = '<span class="badge bg-secondary"><i class="bi bi-envelope-x me-1"></i>ÎØ∏Ï†ÑÏÜ°</span>';
                            console.log('‚ùå Ïù¥Î©îÏùº ÎØ∏Ï†ÑÏÜ°');
                        }
                    }
                    
                    // Ïó¥Îûå ÌòÑÌô© ÌëúÏãú (Ïù¥Î©îÏùº/Ïπ¥ÌÜ° ÎßÅÌÅ¨ Ïó¥Îûå Ïó¨Î∂Ä)
                    const viewsElement = document.getElementById('assignment-views');
                    if (viewsElement) {
                        if (assignment.viewed_at) {
                            const viewedTime = formatDateTime(assignment.viewed_at);
                            viewsElement.innerHTML = `<span class="badge bg-primary"><i class="bi bi-eye-fill me-1"></i>Ïó¥Îûå</span> <small class="text-muted">${viewedTime}</small>`;
                            console.log('‚úÖ Ïó¥ÎûåÎê®:', viewedTime);
                        } else {
                            viewsElement.innerHTML = '<span class="badge bg-secondary"><i class="bi bi-eye-slash me-1"></i>ÎØ∏Ïó¥Îûå</span>';
                            console.log('‚ùå ÎØ∏Ïó¥Îûå');
                        }
                    }
                    
                    // assignment_token Ï†ÄÏû• (Îã§Î•∏ Ìï®ÏàòÏóêÏÑú ÏÇ¨Ïö©)
                    if (window.currentReservation) {
                        window.currentReservation.assignment_token = assignment.assignment_token;
                        console.log('‚úÖ assignment_token Ï†ÄÏû•Îê®:', assignment.assignment_token);
                    } else {
                        console.error('‚ùå window.currentReservationÏù¥ ÏóÜÏùå');
                    }
                    
                    console.log('‚úÖ ÏàòÎ∞∞ÏÑú Ï†ïÎ≥¥ Î°úÎìú ÏôÑÎ£å');
                    
                } else {
                    console.log('‚ö†Ô∏è ÏàòÎ∞∞ÏÑú ÏóÜÏùå');
                    // ÏàòÎ∞∞ÏÑúÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞
                    document.getElementById('assignment-number').textContent = 'ÎØ∏ÏÉùÏÑ±';
                    document.getElementById('assignment-vendor').textContent = 'ÎØ∏ÏßÄÏ†ï';
                    document.getElementById('assignment-created').textContent = '-';
                    
                    // Ïù¥Î©îÏùº Ï†ÑÏÜ° ÏÉÅÌÉú
                    const emailStatusElement = document.getElementById('assignment-email-status');
                    if (emailStatusElement) {
                        emailStatusElement.innerHTML = '<span class="badge bg-secondary"><i class="bi bi-envelope-x me-1"></i>ÎØ∏Ï†ÑÏÜ°</span>';
                    }
                    
                    // Ïó¥Îûå ÌòÑÌô©
                    const viewsElement = document.getElementById('assignment-views');
                    if (viewsElement) {
                        viewsElement.innerHTML = '<span class="badge bg-secondary"><i class="bi bi-eye-slash me-1"></i>ÎØ∏Ïó¥Îûå</span>';
                    }
                }
                
            } catch (error) {
                console.error('‚ùå ÏàòÎ∞∞ÏÑú Ï†ïÎ≥¥ Î°úÎìú Ïò§Î•ò:', error);
                console.error('  - Ïò§Î•ò ÏÉÅÏÑ∏:', error.message);
                console.error('  - Ïò§Î•ò Ïä§ÌÉù:', error.stack);
                showAlert('ÏàòÎ∞∞ÏÑú Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'danger');
            }
        }
        
        // ÏàòÎ∞∞ ÏÉÅÌÉú Î∞∞ÏßÄ ÏÉùÏÑ±
        function getAssignmentStatusBadge(status) {
            const statusMap = {
                'pending': '<span class="badge bg-warning">ÎåÄÍ∏∞Ï§ë</span>',
                'sent': '<span class="badge bg-info">Ï†ÑÏÜ°Îê®</span>',
                'viewed': '<span class="badge bg-primary">ÌôïÏù∏Îê®</span>',
                'confirmed': '<span class="badge bg-success">ÌôïÏ†ïÎê®</span>',
                'rejected': '<span class="badge bg-danger">Í±∞Ï†àÎê®</span>',
                'cancelled': '<span class="badge bg-secondary">Ï∑®ÏÜåÎê®</span>'
            };
            
            return statusMap[status] || '<span class="badge bg-secondary">Ïïå Ïàò ÏóÜÏùå</span>';
        }
        
        // ÏàòÎ∞∞ÏÑú ÎØ∏Î¶¨Î≥¥Í∏∞
        async function previewAssignment() {
            console.log('üîç ÏàòÎ∞∞ÏÑú ÎØ∏Î¶¨Î≥¥Í∏∞ ÏãúÏûë, currentReservationId:', window.currentReservationId);
            
            if (!window.currentReservationId) {
                console.error('‚ùå ÏòàÏïΩ Ï†ïÎ≥¥Í∞Ä ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§');
                showAlert('ÏòàÏïΩ Ï†ïÎ≥¥Í∞Ä ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. ÏàòÎ∞∞ÏÑú Î™®Îã¨ÏùÑ Î®ºÏ†Ä Ïó¥Ïñ¥Ï£ºÏÑ∏Ïöî.', 'warning');
                return;
            }
            
            try {
                console.log('üîç ÏàòÎ∞∞ÏÑú ÌÜ†ÌÅ∞ Ï°∞Ìöå ÏãúÏûë:', window.currentReservationId);
                
                // Î®ºÏ†Ä ÏàòÎ∞∞ÏÑú ÌÜ†ÌÅ∞ÏùÑ Í∞ÄÏ†∏Ïò§Í±∞ÎÇò ÏÉùÏÑ±
                let assignmentToken = null;
                
                // Í∏∞Ï°¥ ÏàòÎ∞∞ÏÑú ÌÜ†ÌÅ∞ ÌôïÏù∏
                const tokenResponse = await fetch(`/api/assignments/by-reservation/${window.currentReservationId}`);
                
                console.log('üì° API ÏùëÎãµ ÏÉÅÌÉú:', tokenResponse.status);
                
                if (!tokenResponse.ok) {
                    const errorText = await tokenResponse.text();
                    console.error('‚ùå API Ìò∏Ï∂ú Ïã§Ìå®:', errorText);
                    throw new Error(`HTTP error! status: ${tokenResponse.status}, message: ${errorText}`);
                }
                
                const tokenResult = await tokenResponse.json();
                console.log('‚úÖ ÌÜ†ÌÅ∞ Ï°∞Ìöå Í≤∞Í≥º:', tokenResult);
                
                if (tokenResult.success && tokenResult.assignment_token) {
                    assignmentToken = tokenResult.assignment_token;
                    console.log('Í∏∞Ï°¥ ÌÜ†ÌÅ∞ ÏÇ¨Ïö©:', assignmentToken);
                } else {
                    console.log('ÏÉà ÏàòÎ∞∞ÏÑú ÏÉùÏÑ± ÏãúÏûë');
                    // ÏàòÎ∞∞ÏÑúÍ∞Ä ÏóÜÏúºÎ©¥ ÏÉùÏÑ±
                    const createResponse = await fetch(`/api/assignments`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            reservation_id: window.currentReservationId,
                            vendor_id: null,
                            notes: 'ÏàòÎ∞∞ÏÑú ÎØ∏Î¶¨Î≥¥Í∏∞Ïö© ÏÉùÏÑ±'
                        })
                    });
                    
                    if (!createResponse.ok) {
                        throw new Error(`HTTP error! status: ${createResponse.status}`);
                    }
                    
                    const createResult = await createResponse.json();
                    console.log('ÏàòÎ∞∞ÏÑú ÏÉùÏÑ± Í≤∞Í≥º:', createResult);
                    
                    if (createResult.success) {
                        assignmentToken = createResult.assignment_token;
                        console.log('ÏÉà ÌÜ†ÌÅ∞ ÏÉùÏÑ±:', assignmentToken);
                    } else {
                        showAlert('ÏàòÎ∞∞ÏÑú ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + (createResult.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'), 'danger');
                        return;
                    }
                }
                
                if (!assignmentToken) {
                    throw new Error('ÏàòÎ∞∞ÏÑú ÌÜ†ÌÅ∞ÏùÑ ÏñªÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                }
                
                // ÏÉà Ï∞ΩÏóêÏÑú ÏàòÎ∞∞ÏÑú Ïó¥Í∏∞ (ÎØ∏Î¶¨Î≥¥Í∏∞ Î™®Îìú)
                const assignmentUrl = `/assignment/${assignmentToken}?preview=true`;
                console.log('ÏàòÎ∞∞ÏÑú URL (ÎØ∏Î¶¨Î≥¥Í∏∞):', assignmentUrl);
                window.open(assignmentUrl, '_blank', 'width=800,height=600');
                
                // ÌûàÏä§ÌÜ†Î¶¨Ïóê Ï∂îÍ∞Ä (Ìï®ÏàòÍ∞Ä Ï°¥Ïû¨ÌïòÎäî Í≤ΩÏö∞ÏóêÎßå)
                if (typeof addToHistory === 'function') {
                    addToHistory('ÏàòÎ∞∞ÏÑú ÎØ∏Î¶¨Î≥¥Í∏∞', 'info');
                }
                
                showAlert('ÏàòÎ∞∞ÏÑú ÎØ∏Î¶¨Î≥¥Í∏∞Î•º ÏÉà Ï∞ΩÏóêÏÑú Ïó¥ÏóàÏäµÎãàÎã§.', 'success');
                
            } catch (error) {
                console.error('ÏàòÎ∞∞ÏÑú ÎØ∏Î¶¨Î≥¥Í∏∞ Ïò§Î•ò:', error);
                showAlert('ÏàòÎ∞∞ÏÑú ÎØ∏Î¶¨Î≥¥Í∏∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message, 'danger');
            }
        }

        // ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨ ÏÉùÏÑ±
        async function generateAssignmentLink() {
            if (!window.currentReservationId) {
                showAlert('ÏòàÏïΩ Ï†ïÎ≥¥Í∞Ä ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.', 'warning');
                return;
            }
            
            try {
                // Í∏∞Ï°¥ ÏàòÎ∞∞ÏÑú ÌÜ†ÌÅ∞ ÌôïÏù∏
                const tokenResponse = await fetch(`/api/assignments/by-reservation/${window.currentReservationId}`);
                const tokenResult = await tokenResponse.json();
                
                let assignmentToken = null;
                
                if (tokenResult.success && tokenResult.assignment_token) {
                    assignmentToken = tokenResult.assignment_token;
                } else {
                    // ÏàòÎ∞∞ÏÑúÍ∞Ä ÏóÜÏúºÎ©¥ ÏÉùÏÑ±
                    const response = await fetch(`/api/assignments`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            reservation_id: window.currentReservationId,
                            vendor_id: null,
                            notes: 'ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨ ÏÉùÏÑ±'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        assignmentToken = result.assignment_token;
                    } else {
                        showAlert('ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + result.message, 'danger');
                        return;
                    }
                }
                
                const assignmentUrl = `${window.location.origin}/assignment/${assignmentToken}`;
                document.getElementById('assignmentLinkUrl').value = assignmentUrl;
                document.getElementById('assignmentLinkGroup').style.display = 'flex';
                
                showAlert('ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!', 'success');
                
                // ÌûàÏä§ÌÜ†Î¶¨Ïóê Ï∂îÍ∞Ä
                addToHistory('ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨ ÏÉùÏÑ±', 'success');
                
            } catch (error) {
                console.error('ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨ ÏÉùÏÑ± Ïò§Î•ò:', error);
                showAlert('ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'danger');
            }
        }
        
        // ÏàòÎ∞∞ÏÑú ÎßÅÌÅ¨ Î≥µÏÇ¨
        // copyAssignmentLink Ìï®ÏàòÎäî 1826Ï§ÑÏóê Ï†ïÏùòÎêòÏñ¥ ÏûàÏùå (Ï§ëÎ≥µ Ï†úÍ±∞)
        
        
        
        
        // ÏàòÎ∞∞ ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú
        async function loadAssignmentHistory(reservationId) {
            try {
                const response = await fetch(`/api/assignments/logs/${reservationId}`);
                const result = await response.json();
                
                if (result.success) {
                    renderAssignmentHistory(result.logs);
                } else {
                    document.getElementById('assignmentHistory').innerHTML = '<p class="text-muted">ÌûàÏä§ÌÜ†Î¶¨Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</p>';
                }
            } catch (error) {
                console.error('ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú Ïò§Î•ò:', error);
                document.getElementById('assignmentHistory').innerHTML = '<p class="text-danger">ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</p>';
            }
        }
        
        // ÌûàÏä§ÌÜ†Î¶¨ Î†åÎçîÎßÅ
        function renderAssignmentHistory(logs) {
            const historyDiv = document.getElementById('assignmentHistory');
            
            if (!logs || logs.length === 0) {
                historyDiv.innerHTML = '<p class="text-muted">ÏïÑÏßÅ ÏàòÎ∞∞ ÌûàÏä§ÌÜ†Î¶¨Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            const html = logs.map(log => {
                const typeClass = log.type === 'success' ? 'text-success' : log.type === 'danger' ? 'text-danger' : 'text-info';
                const icon = log.type === 'success' ? 'bi-check-circle' : log.type === 'danger' ? 'bi-x-circle' : 'bi-info-circle';
                
                return `
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi ${icon} ${typeClass} me-2"></i>
                        <div class="flex-grow-1">
                            <div class="fw-medium">${log.details}</div>
                            <small class="text-muted">${formatDateTime(log.created_at)}</small>
                        </div>
                    </div>
                `;
            }).join('');
            
            historyDiv.innerHTML = html;
        }
        
        // ÌûàÏä§ÌÜ†Î¶¨Ïóê Ìï≠Î™© Ï∂îÍ∞Ä (Î≥ÄÍ≤Ω ÎÇ¥Ïó≠ Ï∂îÏ†Å Í∏∞Îä• Ìè¨Ìï®)
        function addToHistory(action, type = 'info', changes = null, details = null) {
            console.log(`üìù ÌûàÏä§ÌÜ†Î¶¨: ${action} (${type})`, changes);
            
            const typeClass = type === 'success' ? 'text-success' : type === 'danger' ? 'text-danger' : 'text-info';
            const icon = type === 'success' ? 'bi-check-circle' : type === 'danger' ? 'bi-x-circle' : 'bi-info-circle';
            
            // Î≥ÄÍ≤Ω ÎÇ¥Ïó≠ HTML ÏÉùÏÑ±
            let changesHtml = '';
            if (changes && Object.keys(changes).length > 0) {
                changesHtml = '<div class="mt-1">';
                Object.entries(changes).forEach(([field, change]) => {
                    const fieldName = getFieldDisplayName(field);
                    changesHtml += `
                        <div class="change-item">
                            <small class="text-muted">
                                <strong>${fieldName}:</strong> 
                                <span class="text-decoration-line-through text-danger">${change.from || '(ÏóÜÏùå)'}</span> 
                                ‚Üí 
                                <span class="text-success">${change.to || '(ÏóÜÏùå)'}</span>
                            </small>
                        </div>
                    `;
                });
                changesHtml += '</div>';
            }
            
            // Ï∂îÍ∞Ä ÏÑ∏Î∂ÄÏÇ¨Ìï≠ HTML
            let detailsHtml = '';
            if (details) {
                detailsHtml = `<div class="mt-1"><small class="text-muted">${details}</small></div>`;
            }
            
            const newItem = `
                <div class="d-flex align-items-start mb-2 p-2 border-start border-3 border-${type === 'success' ? 'success' : type === 'danger' ? 'danger' : 'info'} bg-light">
                    <i class="bi ${icon} ${typeClass} me-2 mt-1"></i>
                    <div class="flex-grow-1">
                        <div class="fw-medium">${action}</div>
                        <small class="text-muted">${new Date().toLocaleString('ko-KR')}</small>
                        ${changesHtml}
                        ${detailsHtml}
                    </div>
                </div>
            `;
            
            // Î™®Îì† ÌûàÏä§ÌÜ†Î¶¨ Ïª®ÌÖåÏù¥ÎÑàÏóê Ï∂îÍ∞Ä
            const historyContainers = [
                'assignmentHistory',
                'statusHistory', 
                'voucherHistory',
                'settlementHistory',
                'reservationHistory'
            ];
            
            historyContainers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    // Î°úÎî© Î©îÏãúÏßÄ Ï†úÍ±∞
                    if (container.innerHTML.includes('ÌûàÏä§ÌÜ†Î¶¨Î•º Î∂àÎü¨Ïò§Îäî Ï§ë')) {
                        container.innerHTML = '';
                    }
                    container.insertAdjacentHTML('afterbegin', newItem);
                }
            });
        }
        
        // ÌïÑÎìúÎ™ÖÏùÑ ÌïúÍµ≠Ïñ¥Î°ú Î≥ÄÌôòÌïòÎäî Ìï®Ïàò
        function getFieldDisplayName(fieldName) {
            const fieldNames = {
                // ÏòàÏïΩ Ï†ïÎ≥¥
                'reservation_number': 'ÏòàÏïΩÎ≤àÌò∏',
                'platform_name': 'ÏóÖÏ≤¥Î™Ö',
                'payment_status': 'ÏòàÏïΩÏÉÅÌÉú',
                'created_at': 'ÏòàÏïΩÏùºÏãú',
                
                // ÏÉÅÌíà Ï†ïÎ≥¥
                'product_name': 'ÏÉÅÌíàÎ™Ö',
                'package_type': 'Ìå®ÌÇ§ÏßÄ ÌÉÄÏûÖ',
                
                // ÏùºÏ†ï Ï†ïÎ≥¥
                'usage_date': 'Ïù¥Ïö©Ïùº',
                'usage_time': 'Ïù¥Ïö©ÏãúÍ∞Ñ',
                
                // ÏòàÏïΩÏûê Ï†ïÎ≥¥
                'korean_name': 'ÌïúÍ∏ÄÎ™Ö',
                'english_name': 'ÏòÅÎ¨∏Î™Ö',
                'phone': 'Ï†ÑÌôîÎ≤àÌò∏',
                'email': 'Ïù¥Î©îÏùº',
                'kakao_id': 'Ïπ¥Ïπ¥Ïò§ID',
                
                // Ïù∏Ïõê Î∞è Í∏àÏï° Ï†ïÎ≥¥
                'people_adult': 'ÏÑ±Ïù∏Ïàò',
                'people_child': 'ÏïÑÎèôÏàò',
                'people_infant': 'Ïú†ÏïÑÏàò',
                'adult_price': 'ÏÑ±Ïù∏ Îã®Í∞Ä($)',
                'child_price': 'ÏïÑÎèô Îã®Í∞Ä($)',
                'infant_price': 'Ïú†ÏïÑ Îã®Í∞Ä($)',
                
                // Í∏∞ÌÉÄ
                'memo': 'ÌäπÎ≥Ñ ÏöîÏ≤≠ÏÇ¨Ìï≠',
                'vendor_name': 'ÏàòÎ∞∞ÏóÖÏ≤¥',
                'confirmation_number': 'Ïª®ÌéåÎ≤àÌò∏',
                'voucher_token': 'Î∞îÏö∞Ï≤ò',
                'savecard_code': 'ÏÑ∏Ïù¥Î∏åÏπ¥Îìú ÏΩîÎìú',
                'total_price': 'Ï¥ù Í∏àÏï°',
                'cost_price': 'ÏõêÍ∞Ä'
            };
            return fieldNames[fieldName] || fieldName;
        }
        
        // Î™®Îã¨Î≥Ñ ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú
        async function loadModalHistory(reservationId) {
            try {
                // Ïã§Ï†ú ÌûàÏä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌïòÎäî API Ìò∏Ï∂ú
                const response = await fetch(`/api/reservations/${reservationId}/history`);
                const result = await response.json();
                
                let historyData = [];
                if (result.success && result.data) {
                    historyData = result.data;
                } else {
                    // API Ïã§Ìå® Ïãú ÏÉòÌîå ÌûàÏä§ÌÜ†Î¶¨ ÌëúÏãú
                    historyData = [
                    { 
                        action: 'ÏòàÏïΩ ÏÉùÏÑ±', 
                        type: 'info', 
                        time: new Date(Date.now() - 86400000),
                        details: 'ÏÉàÎ°úÏö¥ ÏòàÏïΩÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.'
                    },
                    { 
                        action: 'ÏòàÏïΩ Ï†ïÎ≥¥ ÏàòÏ†ï', 
                        type: 'success', 
                        time: new Date(Date.now() - 43200000),
                        changes: {
                            korean_name: { from: 'ÍπÄÏ¢ÖÏÑ±', to: 'Ïù¥Ï¢ÖÏÑ±' },
                            phone: { from: '010-1234-5678', to: '010-9876-5432' }
                        },
                        details: '2Í∞ú Ìï≠Î™©Ïù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.'
                    },
                    { 
                        action: 'Ïª®ÌéåÎ≤àÌò∏ Ï†ÄÏû•', 
                        type: 'success', 
                        time: new Date(Date.now() - 21600000),
                        changes: {
                            confirmation_number: { from: '(ÏóÜÏùå)', to: 'ABC123456' },
                            vendor_name: { from: '(ÏóÜÏùå)', to: 'Í¥å Ìà¨Ïñ¥ Ïª¥ÌçºÎãà' }
                        },
                        details: 'ÏòàÏïΩÏù¥ ÌôïÏ†ïÎêòÏóàÏäµÎãàÎã§.'
                    }
                    ];
                }
                
                const historyContainers = [
                    'assignmentHistory',
                    'statusHistory', 
                    'voucherHistory',
                    'settlementHistory',
                    'reservationHistory'
                ];
                
                historyContainers.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (container) {
                        const historyHtml = historyData.map(item => {
                            // Î≥ÄÍ≤Ω ÎÇ¥Ïó≠ HTML ÏÉùÏÑ±
                            let changesHtml = '';
                            if (item.changes && Object.keys(item.changes).length > 0) {
                                changesHtml = '<div class="mt-1">';
                                Object.entries(item.changes).forEach(([field, change]) => {
                                    const fieldName = getFieldDisplayName(field);
                                    changesHtml += `
                                        <div class="change-item">
                                            <small class="text-muted">
                                                <strong>${fieldName}:</strong> 
                                                <span class="text-decoration-line-through text-danger">${change.from}</span> 
                                                ‚Üí 
                                                <span class="text-success">${change.to}</span>
                                            </small>
                                        </div>
                                    `;
                                });
                                changesHtml += '</div>';
                            }
                            
                            // Ï∂îÍ∞Ä ÏÑ∏Î∂ÄÏÇ¨Ìï≠ HTML
                            let detailsHtml = '';
                            if (item.details) {
                                detailsHtml = `<div class="mt-1"><small class="text-muted">${item.details}</small></div>`;
                            }
                            
                            return `
                                <div class="d-flex align-items-start mb-2 p-2 border-start border-3 border-${item.type === 'success' ? 'success' : 'info'} bg-light">
                                    <i class="bi ${item.type === 'success' ? 'bi-check-circle text-success' : 'bi-info-circle text-info'} me-2 mt-1"></i>
                                    <div class="flex-grow-1">
                                        <div class="fw-medium">${item.action}</div>
                                        <small class="text-muted">${new Date(item.time).toLocaleString('ko-KR')}</small>
                                        ${changesHtml}
                                        ${detailsHtml}
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        container.innerHTML = historyHtml;
                    }
                });
                
            } catch (error) {
                console.error('ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú Ïò§Î•ò:', error);
                // Ïò§Î•ò Ïãú Í∏∞Î≥∏ Î©îÏãúÏßÄ ÌëúÏãú
                const historyContainers = ['assignmentHistory', 'statusHistory', 'voucherHistory', 'settlementHistory', 'reservationHistory'];
                historyContainers.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.innerHTML = '<p class="text-muted text-center">ÌûàÏä§ÌÜ†Î¶¨Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</p>';
                    }
                });
            }
        }
        
        // Î∞îÏö∞Ï≤ò Í¥ÄÎ†® Ìï®ÏàòÎì§
        
        // Î∞îÏö∞Ï≤ò ÏÉùÏÑ±
        async function generateVoucher() {
            if (!window.currentReservationId) {
                showAlert('ÏòàÏïΩ Ï†ïÎ≥¥Í∞Ä ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`/api/reservations/${window.currentReservationId}/voucher`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Î∞îÏö∞Ï≤ò ÎßÅÌÅ¨ ÌëúÏãú
                    const voucherUrl = `${window.location.origin}/voucher/${result.voucher_token}`;
                    document.getElementById('voucherLinkUrl').value = voucherUrl;
                    document.getElementById('voucherLinkGroup').style.display = 'flex';
                    
                    // Í¥åÏÑ∏Ïù¥Î∏åÏπ¥Îìú Î∞úÍ∏â ÏΩîÎìú ÏûêÎèô ÏÉùÏÑ±
                    if (result.savecard_code) {
                        document.getElementById('savecard-code').value = result.savecard_code;
                    }
                    
                    // Î∞îÏö∞Ï≤ò ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                    updateVoucherStatus(result.voucher);
                    
                    showAlert('Î∞îÏö∞Ï≤òÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!', 'success');
                    addToHistory('Î∞îÏö∞Ï≤ò ÏÉùÏÑ±', 'success');
                } else {
                    showAlert('Î∞îÏö∞Ï≤ò ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + result.message, 'danger');
                }
            } catch (error) {
                console.error('Î∞îÏö∞Ï≤ò ÏÉùÏÑ± Ïò§Î•ò:', error);
                showAlert('Î∞îÏö∞Ï≤ò ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'danger');
            }
        }
        
        // Î∞îÏö∞Ï≤ò ÎØ∏Î¶¨Î≥¥Í∏∞
        async function previewVoucher() {
            if (!window.currentReservationId) {
                showAlert('ÏòàÏïΩ Ï†ïÎ≥¥Í∞Ä ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.', 'warning');
                return;
            }
            
            try {
                // Î∞îÏö∞Ï≤ò ÌÜ†ÌÅ∞ ÌôïÏù∏
                const response = await fetch(`/api/reservations/${window.currentReservationId}`);
                const result = await response.json();
                
                if (result.success && result.reservation.voucher_token) {
                    const voucherUrl = `/voucher/${result.reservation.voucher_token}`;
                    window.open(voucherUrl, '_blank', 'width=800,height=600');
                    addToHistory('Î∞îÏö∞Ï≤ò ÎØ∏Î¶¨Î≥¥Í∏∞', 'info');
                } else {
                    showAlert('Î®ºÏ†Ä Î∞îÏö∞Ï≤òÎ•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                }
            } catch (error) {
                console.error('Î∞îÏö∞Ï≤ò ÎØ∏Î¶¨Î≥¥Í∏∞ Ïò§Î•ò:', error);
                showAlert('Î∞îÏö∞Ï≤ò ÎØ∏Î¶¨Î≥¥Í∏∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'danger');
            }
        }
        
        // Î∞îÏö∞Ï≤ò ÎßÅÌÅ¨ Î≥µÏÇ¨
        function copyVoucherLink() {
            const linkInput = document.getElementById('voucherLinkUrl');
            if (linkInput.value) {
                navigator.clipboard.writeText(linkInput.value).then(() => {
                    showAlert('Î∞îÏö∞Ï≤ò ÎßÅÌÅ¨Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!', 'success');
                    addToHistory('Î∞îÏö∞Ï≤ò ÎßÅÌÅ¨ Î≥µÏÇ¨', 'info');
                }).catch(err => {
                    console.error('Î≥µÏÇ¨ Ïã§Ìå®:', err);
                    showAlert('ÎßÅÌÅ¨ Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'danger');
                });
            } else {
                showAlert('Î≥µÏÇ¨Ìï† Î∞îÏö∞Ï≤ò ÎßÅÌÅ¨Í∞Ä ÏóÜÏäµÎãàÎã§.', 'warning');
            }
        }
        
        
        
        // Í¥åÏÑ∏Ïù¥Î∏åÏπ¥Îìú Î∞úÍ∏â ÏΩîÎìú ÏÉùÏÑ±
        function generateSavecardCode() {
            // 6ÏûêÎ¶¨ Î∞úÍ∏â ÏΩîÎìú ÏÉùÏÑ± (ÏÜåÎ¨∏Ïûê+Ïà´Ïûê+ÏÜåÎ¨∏Ïûê)
            const letters = 'abcdefghijklmnopqrstuvwxyz';
            const numbers = '0123456789';
            
            const code = 
                letters.charAt(Math.floor(Math.random() * letters.length)) +
                Array.from({length: 4}, () => numbers.charAt(Math.floor(Math.random() * numbers.length))).join('') +
                letters.charAt(Math.floor(Math.random() * letters.length));
            
            document.getElementById('savecard-code').value = code;
            showAlert('Î∞úÍ∏â ÏΩîÎìúÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§: ' + code, 'success');
        }
        
        // Î∞úÍ∏â Ï†ïÎ≥¥ Î≥µÏÇ¨
        function copySavecardInfo() {
            const code = document.getElementById('savecard-code').value;
            if (!code) {
                showAlert('Î®ºÏ†Ä Î∞úÍ∏â ÏΩîÎìúÎ•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                return;
            }
            
            const info = `üé´ Í¥åÏÑ∏Ïù¥Î∏åÏπ¥Îìú Î¨¥Î£å Î∞úÍ∏â\n\nÎ∞úÍ∏âÏΩîÎìú: ${code}\n\nüìç Î∞úÍ∏â Î∞©Î≤ï:\n1. https://www.guamsavecard.com/register Ï†ëÏÜç\n2. ÏúÑ Î∞úÍ∏âÏΩîÎìú ÏûÖÎ†•\n3. Í∞úÏù∏Ï†ïÎ≥¥ ÏûÖÎ†• ÌõÑ Î∞úÍ∏â ÏôÑÎ£å\n\nüí∞ 30ÎßåÏõê ÏÉÅÎãπÏùò Ìï†Ïù∏ ÌòúÌÉùÏùÑ Î∞õÏúºÏÑ∏Ïöî!`;
            
            navigator.clipboard.writeText(info).then(() => {
                showAlert('Î∞úÍ∏â Ï†ïÎ≥¥Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!', 'success');
                addToHistory('Î∞úÍ∏â Ï†ïÎ≥¥ Î≥µÏÇ¨', 'info');
            }).catch(err => {
                console.error('Î≥µÏÇ¨ Ïã§Ìå®:', err);
                showAlert('Ï†ïÎ≥¥ Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'danger');
            });
        }
        
        // Î∞îÏö∞Ï≤ò ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateVoucherStatus(voucher) {
            if (!voucher) return;
            
            document.getElementById('voucher-created-at').textContent = 
                voucher.created_at ? formatDateTime(voucher.created_at) : '-';
            document.getElementById('voucher-sent-at').textContent = 
                voucher.sent_at ? formatDateTime(voucher.sent_at) : '-';
            document.getElementById('voucher-viewed-at').textContent = 
                voucher.viewed_at ? formatDateTime(voucher.viewed_at) : '-';
            
            const statusBadge = document.getElementById('voucher-status-badge');
            if (voucher.status === 'sent') {
                statusBadge.innerHTML = '<span class="badge bg-success">Ï†ÑÏÜ°ÏôÑÎ£å</span>';
            } else if (voucher.status === 'viewed') {
                statusBadge.innerHTML = '<span class="badge bg-info">Í≥†Í∞ùÌôïÏù∏</span>';
            } else {
                statusBadge.innerHTML = '<span class="badge bg-warning">ÏÉùÏÑ±ÏôÑÎ£å</span>';
            }
        }
        
        
        // Î∞îÏö∞Ï≤ò Ï∑®ÏÜå
        async function cancelVoucher() {
            if (!window.currentReservationId) {
                showAlert('ÏòàÏïΩ Ï†ïÎ≥¥Í∞Ä ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.', 'warning');
                return;
            }
            
            if (!confirm('Î∞îÏö∞Ï≤òÎ•º Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.')) return;
            
            try {
                const response = await fetch(`/api/reservations/${window.currentReservationId}/voucher/cancel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Î∞îÏö∞Ï≤òÍ∞Ä Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.', 'success');
                    addToHistory('Î∞îÏö∞Ï≤ò Ï∑®ÏÜå', 'success');
                    
                    // UI Ï¥àÍ∏∞Ìôî
                    document.getElementById('voucherLinkGroup').style.display = 'none';
                    document.getElementById('voucherLinkUrl').value = '';
                    document.getElementById('savecard-code').value = '';
                    
                    const statusBadge = document.getElementById('voucher-status-badge');
                    statusBadge.innerHTML = '<span class="badge bg-secondary">Ï∑®ÏÜåÎê®</span>';
                } else {
                    showAlert('Î∞îÏö∞Ï≤ò Ï∑®ÏÜåÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + result.message, 'danger');
                }
            } catch (error) {
                console.error('Î∞îÏö∞Ï≤ò Ï∑®ÏÜå Ïò§Î•ò:', error);
                showAlert('Î∞îÏö∞Ï≤ò Ï∑®ÏÜå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'danger');
            }
        }
        
        // ÏòàÏïΩ Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ï†ÄÏû• (Î≥ÄÍ≤Ω ÎÇ¥Ïó≠ Ï∂îÏ†Å Ìè¨Ìï®)
        async function saveReservationChanges() {
            if (!window.currentReservationId) {
                showAlert('ÏòàÏïΩ Ï†ïÎ≥¥Í∞Ä ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.', 'warning');
                return;
            }
            
            // ÌòÑÏû¨ ÏòàÏïΩ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
            const currentReservation = getReservationData(window.currentReservationId);
            
            // ÏòÅÎ¨∏Î™Ö Ìï©ÏπòÍ∏∞
            const englishLastname = document.getElementById('edit-english-lastname').value;
            const englishFirstname = document.getElementById('edit-english-firstname').value;
            const englishName = [englishLastname, englishFirstname].filter(name => name.trim()).join(' ');
            
            const formData = {
                // ÏòàÏïΩ Ï†ïÎ≥¥
                platform_name: document.getElementById('edit-platform-name').value,
                payment_status: document.getElementById('edit-payment-status').value,
                
                // ÏÉÅÌíà Ï†ïÎ≥¥
                product_name: document.getElementById('edit-product-name').value,
                package_type: document.getElementById('edit-package-type').value,
                
                // ÏùºÏ†ï Ï†ïÎ≥¥
                usage_date: document.getElementById('edit-usage-date').value,
                usage_time: document.getElementById('edit-usage-time').value,
                
                // ÏòàÏïΩÏûê Ï†ïÎ≥¥
                korean_name: document.getElementById('edit-korean-name').value,
                english_name: englishName,
                phone: document.getElementById('edit-phone').value,
                email: document.getElementById('edit-email').value,
                kakao_id: document.getElementById('edit-kakao-id').value,
                
                // Ïù∏Ïõê Î∞è Í∏àÏï° Ï†ïÎ≥¥
                people_adult: parseInt(document.getElementById('edit-people-adult').value) || 0,
                people_child: parseInt(document.getElementById('edit-people-child').value) || 0,
                people_infant: parseInt(document.getElementById('edit-people-infant').value) || 0,
                
                // ÌåêÎß§Í∞Ä
                adult_price: parseFloat(document.getElementById('edit-adult-price').value) || 0,
                child_price: parseFloat(document.getElementById('edit-child-price').value) || 0,
                infant_price: parseFloat(document.getElementById('edit-infant-price').value) || 0,
                
                // ÏõêÍ∞Ä
                adult_cost: parseFloat(document.getElementById('edit-adult-cost').value) || 0,
                child_cost: parseFloat(document.getElementById('edit-child-cost').value) || 0,
                infant_cost: parseFloat(document.getElementById('edit-infant-cost').value) || 0,
                
                // ÌåêÎß§Í∞Ä ÌÜµÌôî
                adult_currency: document.getElementById('edit-adult-currency').value || 'USD',
                child_currency: document.getElementById('edit-child-currency').value || 'USD',
                infant_currency: document.getElementById('edit-infant-currency').value || 'USD',
                
                // ÏõêÍ∞Ä ÌÜµÌôî
                adult_cost_currency: document.getElementById('edit-adult-cost-currency').value || 'USD',
                child_cost_currency: document.getElementById('edit-child-cost-currency').value || 'USD',
                infant_cost_currency: document.getElementById('edit-infant-cost-currency').value || 'USD',
                
                // ÌäπÎ≥Ñ ÏöîÏ≤≠ÏÇ¨Ìï≠
                memo: document.getElementById('edit-memo').value
            };
            
            // Î≥ÄÍ≤Ω ÎÇ¥Ïó≠ Ï∂îÏ†Å
            const changes = {};
            const importantFields = ['product_name', 'package_type', 'people_adult', 'people_child', 'usage_date', 'usage_time', 'memo'];
            let hasImportantChanges = false;
            
            if (currentReservation) {
                Object.keys(formData).forEach(key => {
                    const oldValue = currentReservation[key];
                    const newValue = formData[key];
                    
                    // Í∞íÏù¥ Ïã§Ï†úÎ°ú Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞Îßå Ï∂îÏ†Å
                    if (oldValue != newValue) {
                        changes[key] = {
                            from: oldValue,
                            to: newValue
                        };
                        
                        // Ï§ëÏöîÌïú ÌïÑÎìúÍ∞Ä Î≥ÄÍ≤ΩÎêòÏóàÎäîÏßÄ ÌôïÏù∏
                        if (importantFields.includes(key)) {
                            hasImportantChanges = true;
                        }
                    }
                });
            }
            
            // Ï§ëÏöîÌïú Î≥ÄÍ≤ΩÏÇ¨Ìï≠Ïù¥ ÏûàÍ≥† ÌòÑÏû¨ ÏÉÅÌÉúÍ∞Ä ÏàòÎ∞∞Ï§ëÏù¥Î©¥ 'ÏàòÏ†ïÏ§ë(ÏòàÏïΩÎ≥ÄÍ≤Ω)' ÏÉÅÌÉúÎ°ú Î≥ÄÍ≤Ω
            // Îã®, ÏÇ¨Ïö©ÏûêÍ∞Ä Î™ÖÏãúÏ†ÅÏúºÎ°ú Ï∑®ÏÜå/ÌôòÎ∂à ÏÉÅÌÉúÎ•º ÏÑ†ÌÉùÌïú Í≤ΩÏö∞Îäî Ï†úÏô∏
            const userSelectedStatus = document.getElementById('edit-payment-status').value;
            const isExplicitStatusChange = userSelectedStatus === 'cancelled' || userSelectedStatus === 'refunded';
            
            if (hasImportantChanges && 
                (currentReservation.payment_status === 'in_progress' || currentReservation.payment_status === 'confirmed') &&
                !isExplicitStatusChange) {
                formData.payment_status = 'in_revision';
                console.log('‚ö†Ô∏è Ï§ëÏöî Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Í∞êÏßÄ - ÏÉÅÌÉúÎ•º "ÏàòÏ†ïÏ§ë(ÏòàÏïΩÎ≥ÄÍ≤Ω)"ÏúºÎ°ú Î≥ÄÍ≤Ω');
            }
            
            try {
                console.log('üìù ÏòàÏïΩ Ï†ïÎ≥¥ Ï†ÄÏû• ÏãúÏûë:', {
                    reservationId: window.currentReservationId,
                    formData: formData,
                    changes: changes
                });
                
                const response = await fetch(`/api/reservations/${window.currentReservationId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                console.log('üì° ÏÑúÎ≤Ñ ÏùëÎãµ ÏÉÅÌÉú:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå ÏÑúÎ≤Ñ Ïò§Î•ò ÏùëÎãµ:', errorText);
                    showAlert(`ÏÑúÎ≤Ñ Ïò§Î•ò (${response.status}): ${errorText}`, 'danger');
                    return;
                }
                
                const result = await response.json();
                console.log('üìä ÏÑúÎ≤Ñ ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:', result);
                
                if (result.success) {
                    showAlert('ÏòàÏïΩ Ï†ïÎ≥¥Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!', 'success');
                    
                    // Î≥ÄÍ≤Ω ÎÇ¥Ïó≠Í≥º Ìï®Íªò ÌûàÏä§ÌÜ†Î¶¨ Ï∂îÍ∞Ä
                    if (Object.keys(changes).length > 0) {
                        addToHistory('ÏòàÏïΩ Ï†ïÎ≥¥ ÏàòÏ†ï', 'success', changes, `${Object.keys(changes).length}Í∞ú Ìï≠Î™©Ïù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`);
                    } else {
                        addToHistory('ÏòàÏïΩ Ï†ïÎ≥¥ Ï†ÄÏû•', 'info', null, 'Î≥ÄÍ≤ΩÎêú ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.');
                    }
                    
                    // Î™®Îã¨ Îã´Í∏∞
                    const modal = bootstrap.Modal.getInstance(document.getElementById('reservationEditModal'));
                    if (modal) modal.hide();
                    
                    loadAssignments(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                } else {
                    showAlert('ÏòàÏïΩ Ï†ïÎ≥¥ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + (result.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'), 'danger');
                }
            } catch (error) {
                console.error('‚ùå ÏòàÏïΩ Ï†ïÎ≥¥ Ï†ÄÏû• Ïò§Î•ò:', error);
                showAlert(`ÏòàÏïΩ Ï†ïÎ≥¥ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}`, 'danger');
            }
        }
        
        // ÏòàÏïΩ Ìèº Ï¥àÍ∏∞Ìôî
        function resetReservationForm() {
            if (window.reservations && window.currentReservationId) {
                const reservation = window.reservations.find(r => r.id === window.currentReservationId);
                if (reservation) {
                    document.getElementById('edit-customer-name').value = reservation.korean_name || '';
                    document.getElementById('edit-adult-count').value = reservation.people_adult || 0;
                    document.getElementById('edit-child-count').value = reservation.people_child || 0;
                    document.getElementById('edit-phone').value = reservation.phone || '';
                    document.getElementById('edit-usage-date').value = reservation.usage_date ? reservation.usage_date.split('T')[0] : '';
                    document.getElementById('edit-usage-time').value = reservation.usage_time || '';
                    document.getElementById('edit-product-name').value = reservation.product_name || '';
                    document.getElementById('edit-memo').value = reservation.memo || '';
                }
            }
        }
        
        // ÏÉÅÌÉú Î≥ÄÍ≤Ω (Î∞îÏö∞Ï≤ò ÏûêÎèô ÏÉùÏÑ± Ìè¨Ìï®, Î≥ÄÍ≤Ω ÎÇ¥Ïó≠ Ï∂îÏ†Å)
        async function changeReservationStatus() {
            if (!window.currentReservationId) {
                showAlert('ÏòàÏïΩ Ï†ïÎ≥¥Í∞Ä ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.', 'warning');
                return;
            }
            
            const newStatus = document.getElementById('new-status-select').value;
            const reason = document.getElementById('status-change-reason').value;
            
            if (!newStatus) {
                showAlert('Î≥ÄÍ≤ΩÌï† ÏÉÅÌÉúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                return;
            }
            
            // ÌòÑÏû¨ ÏòàÏïΩ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
            const currentReservation = getReservationData(window.currentReservationId);
            const oldStatus = currentReservation ? currentReservation.payment_status : null;
            
            try {
                const response = await fetch(`/api/reservations/${window.currentReservationId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        status: newStatus,
                        reason: reason
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('ÏòàÏïΩ ÏÉÅÌÉúÍ∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§!', 'success');
                    
                    // ÏÉÅÌÉú Î≥ÄÍ≤Ω ÎÇ¥Ïó≠ Ï∂îÏ†Å
                    const changes = {
                        payment_status: {
                            from: getReservationStatusText(oldStatus),
                            to: getReservationStatusText(newStatus)
                        }
                    };
                    
                    const details = reason ? `Î≥ÄÍ≤Ω ÏÇ¨Ïú†: ${reason}` : null;
                    addToHistory('ÏòàÏïΩ ÏÉÅÌÉú Î≥ÄÍ≤Ω', 'success', changes, details);
                    
                    // ÌôïÏ†ï ÏÉÅÌÉúÎ°ú Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞ Î∞îÏö∞Ï≤ò ÏûêÎèô ÏÉùÏÑ±
                    if (newStatus === 'confirmed') {
                        await autoGenerateVoucher(window.currentReservationId);
                    }
                    
                    loadAssignments(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                    
                    // ÌòÑÏû¨ ÏÉÅÌÉú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
                    const currentStatusDisplay = document.getElementById('current-status-display');
                    if (currentStatusDisplay) {
                        currentStatusDisplay.innerHTML = `<span class="badge bg-${getBootstrapStatusClass(newStatus)}">${getReservationStatusText(newStatus)}</span>`;
                    }
                    
                    // Ìèº Ï¥àÍ∏∞Ìôî
                    document.getElementById('status-change-reason').value = '';
                } else {
                    showAlert('ÏÉÅÌÉú Î≥ÄÍ≤ΩÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + result.message, 'danger');
                }
            } catch (error) {
                console.error('ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïò§Î•ò:', error);
                showAlert('ÏÉÅÌÉú Î≥ÄÍ≤Ω Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'danger');
            }
        }

        // Î∞îÏö∞Ï≤ò ÏûêÎèô ÏÉùÏÑ± (ÏòàÏïΩ ÌôïÏ†ï Ïãú)
        async function autoGenerateVoucher(reservationId) {
            try {
                showAlert('ÏòàÏïΩÏù¥ ÌôïÏ†ïÎêòÏñ¥ Î∞îÏö∞Ï≤òÎ•º ÏûêÎèô ÏÉùÏÑ± Ï§ëÏûÖÎãàÎã§...', 'info');
                
                // ÏÑ∏Ïù¥Î∏åÏπ¥Îìú ÏΩîÎìú Î®ºÏ†Ä ÏÉùÏÑ±
                const savecardCode = generateRandomSavecardCode();
                
                const response = await fetch(`/api/reservations/${reservationId}/voucher`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        auto_generate: true,
                        savecard_code: savecardCode
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Î∞îÏö∞Ï≤òÍ∞Ä ÏûêÎèôÏúºÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§! Í¥åÏÑ∏Ïù¥Î∏åÏπ¥Îìú Î∞úÍ∏âÏΩîÎìúÎèÑ Ìï®Íªò ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.', 'success');
                    addToHistory('Î∞îÏö∞Ï≤ò ÏûêÎèô ÏÉùÏÑ± (ÏòàÏïΩ ÌôïÏ†ï)', 'success');
                    addToHistory(`ÏÑ∏Ïù¥Î∏åÏπ¥Îìú Î∞úÍ∏âÏΩîÎìú ÏÉùÏÑ±: ${savecardCode}`, 'info');
                } else {
                    console.error('Î∞îÏö∞Ï≤ò ÏûêÎèô ÏÉùÏÑ± Ïã§Ìå®:', result.message);
                    showAlert('Î∞îÏö∞Ï≤ò ÏûêÎèô ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÏàòÎèôÏúºÎ°ú ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                }
            } catch (error) {
                console.error('Î∞îÏö∞Ï≤ò ÏûêÎèô ÏÉùÏÑ± Ïò§Î•ò:', error);
                showAlert('Î∞îÏö∞Ï≤ò ÏûêÎèô ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. ÏàòÎèôÏúºÎ°ú ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
            }
        }

        // ÎûúÎç§ ÏÑ∏Ïù¥Î∏åÏπ¥Îìú ÏΩîÎìú ÏÉùÏÑ±
        function generateRandomSavecardCode() {
            const letters = 'abcdefghijklmnopqrstuvwxyz';
            const numbers = '0123456789';
            
            return letters.charAt(Math.floor(Math.random() * letters.length)) +
                   Array.from({length: 4}, () => numbers.charAt(Math.floor(Math.random() * numbers.length))).join('') +
                   letters.charAt(Math.floor(Math.random() * letters.length));
        }
        
        // Ïª®ÌéåÎ≤àÌò∏ Ï†ÄÏû•
        async function saveConfirmationNumber() {
            if (!window.currentReservationId) {
                showAlert('ÏòàÏïΩ Ï†ïÎ≥¥Í∞Ä ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.', 'warning');
                return;
            }
            
            const confirmationNumber = document.getElementById('confirmation-number').value;
            const vendorId = document.getElementById('vendor-select').value;
            
            if (!confirmationNumber) {
                showAlert('Ïª®ÌéåÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`/api/reservations/${window.currentReservationId}/confirm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        confirmation_number: confirmationNumber,
                        vendor_id: vendorId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('‚úÖ Ïª®ÌéåÎ≤àÌò∏Í∞Ä Ï†ÄÏû•ÎêòÍ≥† ÏòàÏïΩÏù¥ ÌôïÏ†ïÎêòÏóàÏäµÎãàÎã§!', 'success');
                    
                    // ÌòÑÏû¨ ÏòàÏïΩ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                    const currentReservation = getReservationData(window.currentReservationId);
                    const oldConfirmationNumber = currentReservation ? currentReservation.confirmation_number : null;
                    
                    // Ïª®ÌéåÎ≤àÌò∏ Î≥ÄÍ≤Ω ÎÇ¥Ïó≠ Ï∂îÏ†Å
                    const changes = {
                        confirmation_number: {
                            from: oldConfirmationNumber || '(ÏóÜÏùå)',
                            to: confirmationNumber
                        },
                        payment_status: {
                            from: 'ÏàòÎ∞∞Ï§ë',
                            to: 'ÌôïÏ†ïÏôÑÎ£å'
                        }
                    };
                    
                    // ÏàòÎ∞∞ÏóÖÏ≤¥ Ï†ïÎ≥¥ÎèÑ Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞ Ï∂îÍ∞Ä
                    if (vendorId && currentReservation && currentReservation.vendor_id !== vendorId) {
                        const vendorSelect = document.getElementById('vendor-select');
                        const vendorName = vendorSelect.options[vendorSelect.selectedIndex].text;
                        changes.vendor_name = {
                            from: currentReservation.vendor_name || '(ÏóÜÏùå)',
                            to: vendorName
                        };
                    }
                    
                    addToHistory('Ïª®ÌéåÎ≤àÌò∏ Ï†ÄÏû• Î∞è ÌôïÏ†ï', 'success', changes, 'ÏòàÏïΩÏù¥ ÌôïÏ†ïÎêòÏóàÏäµÎãàÎã§.');
                    
                    // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                    loadAssignments();
                } else {
                    showAlert('Ïª®ÌéåÎ≤àÌò∏ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + result.message, 'danger');
                }
            } catch (error) {
                console.error('Ïª®ÌéåÎ≤àÌò∏ Ï†ÄÏû• Ïò§Î•ò:', error);
                showAlert('Ïª®ÌéåÎ≤àÌò∏ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'danger');
            }
        }
        
        // Ïª®ÌéåÎ≤àÌò∏ ÏûêÎèô ÏÉùÏÑ±
        function generateConfirmationNumber() {
            const timestamp = Date.now().toString().slice(-6);
            const random = Math.random().toString(36).substr(2, 4).toUpperCase();
            const confirmationNumber = `GU${timestamp}${random}`;
            
            document.getElementById('confirmation-number').value = confirmationNumber;
            showAlert('Ïª®ÌéåÎ≤àÌò∏Í∞Ä ÏûêÎèô ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§: ' + confirmationNumber, 'success');
        }
        
        // Ï†ïÏÇ∞ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ Í¥ÄÎ¶¨
        document.addEventListener('DOMContentLoaded', function() {
            // Ï≤¥ÌÅ¨Î∞ïÏä§ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
            const checkboxes = [
                'check-voucher-sent',
                'check-service-completed', 
                'check-vendor-payment',
                'check-customer-feedback',
                'check-documents'
            ];
            
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', updateTransferButton);
                }
            });
        });
        
        // Ï†ïÏÇ∞ Ïù¥Í¥Ä Î≤ÑÌäº ÌôúÏÑ±Ìôî Ï≤¥ÌÅ¨
        function updateTransferButton() {
            const checkboxes = [
                'check-voucher-sent',
                'check-service-completed', 
                'check-vendor-payment',
                'check-customer-feedback',
                'check-documents'
            ];
            
            const allChecked = checkboxes.every(id => {
                const checkbox = document.getElementById(id);
                return checkbox && checkbox.checked;
            });
            
            const transferBtn = document.getElementById('transfer-btn');
            if (transferBtn) {
                transferBtn.disabled = !allChecked;
            }
        }
        
        // Ï†ïÏÇ∞Í¥ÄÎ¶¨Î°ú Ïù¥Í¥Ä
        async function transferToSettlement() {
            if (!window.currentReservationId) {
                showAlert('ÏòàÏïΩ Ï†ïÎ≥¥Í∞Ä ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.', 'warning');
                return;
            }
            
            if (!confirm('Ï†ïÏÇ∞Í¥ÄÎ¶¨Î°ú Ïù¥Í¥ÄÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖ ÌõÑÏóêÎäî ÏàòÎ∞∞Í¥ÄÎ¶¨ÏóêÏÑú Ï†úÏô∏Îê©ÎãàÎã§.')) return;
            
            const settlementData = {
                revenue: document.getElementById('settlement-revenue').value,
                cost: document.getElementById('settlement-cost').value,
                fee: document.getElementById('settlement-fee').value,
                profit: document.getElementById('settlement-profit').value,
                memo: document.getElementById('settlement-memo').value
            };
            
            try {
                const response = await fetch(`/api/reservations/${window.currentReservationId}/settlement`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settlementData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Ï†ïÏÇ∞Í¥ÄÎ¶¨Î°ú Ïù¥Í¥ÄÎêòÏóàÏäµÎãàÎã§!', 'success');
                    addToHistory('Ï†ïÏÇ∞Í¥ÄÎ¶¨ Ïù¥Í¥Ä', 'success');
                    
                    // Î™®Îã¨ Îã´Í∏∞
                    const modal = bootstrap.Modal.getInstance(document.getElementById('assignmentModal'));
                    if (modal) modal.hide();
                    
                    // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                    loadAssignments();
                } else {
                    showAlert('Ï†ïÏÇ∞ Ïù¥Í¥ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + result.message, 'danger');
                }
            } catch (error) {
                console.error('Ï†ïÏÇ∞ Ïù¥Í¥Ä Ïò§Î•ò:', error);
                showAlert('Ï†ïÏÇ∞ Ïù¥Í¥Ä Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'danger');
            }
        }
        
        // ÏàòÏùµ Í≥ÑÏÇ∞
        function calculateProfit() {
            const revenue = parseFloat(document.getElementById('settlement-revenue').value) || 0;
            const cost = parseFloat(document.getElementById('settlement-cost').value) || 0;
            const fee = parseFloat(document.getElementById('settlement-fee').value) || 0;
            
            const profit = revenue - cost - fee;
            document.getElementById('settlement-profit').value = profit.toFixed(2);
            
            showAlert('ÏàòÏùµÏù¥ Í≥ÑÏÇ∞ÎêòÏóàÏäµÎãàÎã§: ' + profit.toLocaleString('ko-KR') + 'Ïõê', 'info');
        }
        
        // ÎÇ†Ïßú/ÏãúÍ∞Ñ Ìè¨Îß∑ÌåÖ
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleString('ko-KR');
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
