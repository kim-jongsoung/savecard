<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>요금 관리</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { font-size: 0.7rem; }
    h2 { font-size: 1.4rem; }
    .btn { font-size: 0.7rem; padding: 0.3rem 0.7rem; }
    .form-label { font-size: 0.7rem; }
    .form-control, .form-select { font-size: 0.7rem; padding: 0.3rem 0.5rem; }
    .table { font-size: 0.65rem; }
    .table th { font-size: 0.7rem; padding: 0.5rem; }
    .table td { padding: 0.5rem; }
    .badge { font-size: 0.65rem; }
    .filter-card { background: #f8f9fa; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; }
    .table tbody tr:hover { background: #f8f9fa; }
  </style>
</head>
<body>
  <%- include('../partials/navbar') %>
  <div class="container-fluid mt-4">
    <h2><i class="bi bi-cash-stack"></i> 요금 관리 <button class="btn btn-primary btn-sm ms-3" onclick="openAddModal()"><i class="bi bi-plus-circle"></i> 요금 등록</button></h2>
    <div class="filter-card mt-3">
      <div class="row g-2">
        <div class="col-md-3">
          <label class="form-label">호텔</label>
          <select class="form-select" id="filterHotel" onchange="onHotelChange()">
            <option value="">호텔 선택</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">객실 타입</label>
          <select class="form-select" id="filterRoomType" onchange="loadRates()">
            <option value="">전체</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">시즌</label>
          <select class="form-select" id="filterSeason" onchange="loadRates()">
            <option value="">전체</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">상태</label>
          <select class="form-select" id="filterActive" onchange="loadRates()">
            <option value="">전체</option>
            <option value="true" selected>활성</option>
            <option value="false">비활성</option>
          </select>
        </div>
      </div>
    </div>
    <table class="table table-sm table-hover">
      <thead class="table-light">
        <tr>
          <th>객실타입</th><th>시즌</th><th>1박요금</th><th>최소박</th><th>통화</th><th>상태</th><th>작업</th>
        </tr>
      </thead>
      <tbody id="rateList">
        <tr><td colspan="7" class="text-center">호텔을 선택하세요</td></tr>
      </tbody>
    </table>
  </div>
  
  <div class="modal fade" id="rateModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">요금 등록</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="rateForm">
            <input type="hidden" id="rateId">
            <div class="mb-2">
              <label class="form-label">호텔 *</label>
              <select class="form-select" id="hotelId" onchange="loadModalData()" required>
                <option value="">선택</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">객실 타입 *</label>
              <select class="form-select" id="roomTypeId" required>
                <option value="">먼저 호텔 선택</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">시즌</label>
              <select class="form-select" id="seasonId">
                <option value="">기본 요금</option>
              </select>
            </div>
            <div class="row">
              <div class="col-md-6 mb-2">
                <label class="form-label">1박 요금 *</label>
                <input type="number" class="form-control" id="ratePerNight" step="0.01" required>
              </div>
              <div class="col-md-3 mb-2">
                <label class="form-label">최소박</label>
                <input type="number" class="form-control" id="minNights" value="1">
              </div>
              <div class="col-md-3 mb-2">
                <label class="form-label">통화</label>
                <select class="form-select" id="currency">
                  <option value="USD">USD</option>
                  <option value="KRW">KRW</option>
                </select>
              </div>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="isActive" checked>
              <label class="form-check-label" for="isActive">활성화</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="button" class="btn btn-primary" onclick="saveRate()">저장</button>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentRates = [];
    let hotels = [];
    
    document.addEventListener('DOMContentLoaded', () => { loadHotels(); });
    
    async function loadHotels() {
      const res = await fetch('/api/hotels?is_active=true');
      hotels = await res.json();
      document.getElementById('filterHotel').innerHTML = '<option value="">호텔 선택</option>' + hotels.map(h => <option value=""></option>).join('');
      document.getElementById('hotelId').innerHTML = '<option value="">선택</option>' + hotels.map(h => <option value=""></option>).join('');
    }
    
    async function onHotelChange() {
      const hotelId = document.getElementById('filterHotel').value;
      if (!hotelId) return;
      
      const rtRes = await fetch(/api/room-types?hotel_id=&is_active=true);
      const roomTypes = await rtRes.json();
      document.getElementById('filterRoomType').innerHTML = '<option value="">전체</option>' + roomTypes.map(rt => <option value=""></option>).join('');
      
      const sRes = await fetch(/api/seasons?hotel_id=&is_active=true);
      const seasons = await sRes.json();
      document.getElementById('filterSeason').innerHTML = '<option value="">전체</option><option value="null">기본요금</option>' + seasons.map(s => <option value=""></option>).join('');
      
      loadRates();
    }
    
    async function loadRates() {
      const hotelId = document.getElementById('filterHotel').value;
      if (!hotelId) return;
      
      let url = /api/hotel-rates?hotel_id=;
      const roomTypeId = document.getElementById('filterRoomType').value;
      const seasonId = document.getElementById('filterSeason').value;
      const isActive = document.getElementById('filterActive').value;
      
      if (roomTypeId) url += &room_type_id=;
      if (seasonId === 'null') url += &season_id=null;
      else if (seasonId) url += &season_id=;
      if (isActive) url += &is_active=;
      
      const res = await fetch(url);
      currentRates = await res.json();
      renderRates();
    }
    
    function renderRates() {
      const tbody = document.getElementById('rateList');
      if (currentRates.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">등록된 요금이 없습니다</td></tr>';
        return;
      }
      
      tbody.innerHTML = currentRates.map(r => 
        <tr>
          <td></td>
          <td></td>
          <td class="text-end"><strong></strong></td>
          <td></td>
          <td></td>
          <td></td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="editRate()"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteRate()"><i class="bi bi-trash"></i></button>
          </td>
        </tr>
      ).join('');
    }
    
    function openAddModal() {
      document.getElementById('modalTitle').textContent = '요금 등록';
      document.getElementById('rateForm').reset();
      document.getElementById('rateId').value = '';
      document.getElementById('isActive').checked = true;
      document.getElementById('minNights').value = 1;
      document.getElementById('currency').value = 'USD';
      document.getElementById('roomTypeId').innerHTML = '<option value="">먼저 호텔 선택</option>';
      document.getElementById('seasonId').innerHTML = '<option value="">기본 요금</option>';
      new bootstrap.Modal(document.getElementById('rateModal')).show();
    }
    
    async function loadModalData() {
      const hotelId = document.getElementById('hotelId').value;
      if (!hotelId) return;
      
      const rtRes = await fetch(/api/room-types?hotel_id=&is_active=true);
      const roomTypes = await rtRes.json();
      document.getElementById('roomTypeId').innerHTML = '<option value="">선택</option>' + roomTypes.map(rt => <option value=""></option>).join('');
      
      const sRes = await fetch(/api/seasons?hotel_id=&is_active=true);
      const seasons = await sRes.json();
      document.getElementById('seasonId').innerHTML = '<option value="">기본 요금</option>' + seasons.map(s => <option value=""></option>).join('');
    }
    
    async function editRate(id) {
      const res = await fetch(/api/hotel-rates/);
      const r = await res.json();
      
      document.getElementById('modalTitle').textContent = '요금 수정';
      document.getElementById('rateId').value = r.id;
      document.getElementById('hotelId').value = r.hotel_id;
      await loadModalData();
      
      document.getElementById('roomTypeId').value = r.room_type_id;
      document.getElementById('seasonId').value = r.season_id || '';
      document.getElementById('ratePerNight').value = r.rate_per_night;
      document.getElementById('minNights').value = r.min_nights || 1;
      document.getElementById('currency').value = r.currency || 'USD';
      document.getElementById('isActive').checked = r.is_active;
      
      new bootstrap.Modal(document.getElementById('rateModal')).show();
    }
    
    async function saveRate() {
      const id = document.getElementById('rateId').value;
      const data = {
        hotel_id: document.getElementById('hotelId').value,
        room_type_id: document.getElementById('roomTypeId').value,
        season_id: document.getElementById('seasonId').value || null,
        rate_type: document.getElementById('seasonId').value ? 'season' : 'base',
        rate_per_night: parseFloat(document.getElementById('ratePerNight').value),
        min_nights: parseInt(document.getElementById('minNights').value) || 1,
        currency: document.getElementById('currency').value,
        is_active: document.getElementById('isActive').checked
      };
      
      if (!data.hotel_id || !data.room_type_id || !data.rate_per_night) {
        alert('필수 항목을 입력하세요'); return;
      }
      
      const res = await fetch(id ? /api/hotel-rates/ : '/api/hotel-rates', {
        method: id ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      const result = await res.json();
      if (result.error) { alert('저장 실패: ' + result.error); return; }
      
      alert('저장되었습니다');
      bootstrap.Modal.getInstance(document.getElementById('rateModal')).hide();
      loadRates();
    }
    
    async function deleteRate(id) {
      if (!confirm('삭제하시겠습니까?')) return;
      
      const res = await fetch(/api/hotel-rates/, { method: 'DELETE' });
      const result = await res.json();
      if (result.error) { alert('삭제 실패: ' + result.error); return; }
      
      alert('삭제되었습니다');
      loadRates();
    }
  </script>
</body>
</html>
