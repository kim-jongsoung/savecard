<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>발급 코드 관리 - 괌세이브카드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(45deg, #667eea, #764ba2) !important;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            border-radius: 10px;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
            border: none;
            border-radius: 10px;
        }
        
        .table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
        }
        
        .badge {
            font-size: 0.8em;
        }
        
        .code-display {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1.1em;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar', { currentPage: 'issue-codes', adminUsername: adminUsername }) %>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-key me-2"></i>발급 코드 관리</h2>
                <p class="text-muted">카드 발급용 코드를 생성하고 관리하세요</p>
            </div>
            <div>
                <button class="btn btn-success me-2" onclick="generateSingleCode()">
                    <i class="fas fa-plus me-1"></i>코드 1개 생성
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bulkGenerateModal">
                    <i class="fas fa-layer-group me-1"></i>대량 생성
                </button>
            </div>
        </div>

        <!-- 통계 카드 -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-key fa-2x text-primary mb-2"></i>
                        <h4 class="text-primary"><%= stats.total_codes %></h4>
                        <small class="text-muted">총 생성된 코드</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                        <h4 class="text-warning"><%= stats.pending %></h4>
                        <small class="text-muted">미전달 코드</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <h4 class="text-success"><%= stats.delivered %></h4>
                        <small class="text-muted">전달 완료</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-percentage fa-2x text-info mb-2"></i>
                        <h4 class="text-info"><%= Math.round((stats.delivered / Math.max(stats.total_codes, 1)) * 100) %>%</h4>
                        <small class="text-muted">전달률</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 코드 목록 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>발급 코드 목록</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>코드</th>
                                <th>상태</th>
                                <th>전달상태</th>
                                <th>사용자</th>
                                <th>사용일</th>
                                <th>메모</th>
                                <th>생성일</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (codes && codes.length > 0) { %>
                                <% codes.forEach(code => { %>
                                    <tr>
                                        <td>
                                            <span class="code-display"><%= code.code %></span>
                                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyCode('<%= code.code %>')">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </td>
                                        <td>
                                            <% if (code.is_used) { %>
                                                <span class="badge bg-success">사용됨</span>
                                            <% } else { %>
                                                <span class="badge bg-warning">미사용</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <% if (code.is_delivered) { %>
                                                <span class="badge bg-info">전달완료</span>
                                            <% } else { %>
                                                <span class="badge bg-secondary">미전달</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <span class="text-muted">-</span>
                                        </td>
                                        <td>
                                            <% if (code.used_at) { %>
                                                <%= new Date(code.used_at).toLocaleDateString('ko-KR') %>
                                            <% } else { %>
                                                <span class="text-muted">-</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <% if (code.notes) { %>
                                                <%= code.notes %>
                                            <% } else { %>
                                                <span class="text-muted">-</span>
                                            <% } %>
                                        </td>
                                        <td><%= new Date(code.created_at).toLocaleDateString('ko-KR') %></td>
                                        <td>
                                            <% if (!code.is_delivered) { %>
                                                <button class="btn btn-sm btn-success me-1" onclick="markAsDelivered(<%= code.id %>)" title="전달 완료 표시">
                                                    <i class="fas fa-paper-plane"></i>
                                                </button>
                                            <% } else { %>
                                                <button class="btn btn-sm btn-outline-secondary me-1" onclick="markAsUndelivered(<%= code.id %>)" title="미전달로 변경">
                                                    <i class="fas fa-undo"></i>
                                                </button>
                                            <% } %>
                                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editCode(<%= code.id %>, '<%= code.notes || '' %>')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <% if (!code.is_used) { %>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteCode(<%= code.id %>)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            <% } %>
                                        </td>
                                    </tr>
                                <% }); %>
                            <% } else { %>
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x mb-3"></i>
                                        <p>생성된 발급 코드가 없습니다.</p>
                                    </td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 대량 생성 모달 -->
    <div class="modal fade" id="bulkGenerateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">대량 코드 생성</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bulkGenerateForm">
                        <div class="mb-3">
                            <label for="codeCount" class="form-label">생성할 코드 개수</label>
                            <input type="number" class="form-control" id="codeCount" name="count" min="1" max="100" value="1" required>
                            <div class="form-text">최대 100개까지 생성 가능합니다. (a1234b 형태로 생성됩니다)</div>
                        </div>
                        <div class="mb-3">
                            <label for="codeNotes" class="form-label">메모 (선택사항)</label>
                            <input type="text" class="form-control" id="codeNotes" placeholder="예: 2025년 1월 프로모션용">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="generateBulkCodes()">생성</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 코드 수정 모달 -->
    <div class="modal fade" id="editCodeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">코드 메모 수정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCodeForm">
                        <input type="hidden" id="editCodeId">
                        <div class="mb-3">
                            <label for="editCodeNotes" class="form-label">메모</label>
                            <input type="text" class="form-control" id="editCodeNotes" placeholder="코드에 대한 메모를 입력하세요">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="updateCode()">저장</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 단일 코드 생성
        function generateSingleCode() {
            fetch('/admin/issue-codes/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ count: 1 })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('코드가 생성되었습니다: ' + data.codes[0]);
                    location.reload();
                } else {
                    alert('코드 생성 실패: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('코드 생성 중 오류가 발생했습니다.');
            });
        }

        // 대량 코드 생성
        function generateBulkCodes() {
            const count = document.getElementById('codeCount').value;
            const notes = document.getElementById('codeNotes').value;

            fetch('/admin/issue-codes/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ count: parseInt(count), notes: notes })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`${count}개의 코드가 생성되었습니다.`);
                    bootstrap.Modal.getInstance(document.getElementById('bulkGenerateModal')).hide();
                    location.reload();
                } else {
                    alert('코드 생성 실패: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('코드 생성 중 오류가 발생했습니다.');
            });
        }

        // 코드 복사
        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                alert('코드가 클립보드에 복사되었습니다: ' + code);
            });
        }

        // 코드 수정
        function editCode(id, notes) {
            document.getElementById('editCodeId').value = id;
            document.getElementById('editCodeNotes').value = notes;
            new bootstrap.Modal(document.getElementById('editCodeModal')).show();
        }

        // 코드 업데이트
        function updateCode() {
            const id = document.getElementById('editCodeId').value;
            const notes = document.getElementById('editCodeNotes').value;

            fetch(`/admin/issue-codes/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ notes: notes })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('코드가 수정되었습니다.');
                    bootstrap.Modal.getInstance(document.getElementById('editCodeModal')).hide();
                    location.reload();
                } else {
                    alert('코드 수정 실패: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('코드 수정 중 오류가 발생했습니다.');
            });
        }

        // 코드 삭제
        function deleteCode(id) {
            if (confirm('정말로 이 코드를 삭제하시겠습니까?')) {
                fetch(`/admin/issue-codes/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('코드가 삭제되었습니다.');
                        location.reload();
                    } else {
                        alert('코드 삭제 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('코드 삭제 중 오류가 발생했습니다.');
                });
            }
        }

        // 전달 완료 표시
        function markAsDelivered(id) {
            fetch(`/admin/issue-codes/${id}/delivery`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ is_delivered: true })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('코드가 전달 완료되었습니다.');
                    location.reload();
                } else {
                    alert('코드 전달 실패: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('코드 전달 중 오류가 발생했습니다.');
            });
        }

        // 미전달로 변경
        function markAsUndelivered(id) {
            if (confirm('정말로 미전달 상태로 변경하시겠습니까?')) {
                fetch(`/admin/issue-codes/${id}/delivery`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_delivered: false })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('코드가 미전달 상태로 변경되었습니다.');
                        location.reload();
                    } else {
                        alert('코드 전달 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('코드 전달 중 오류가 발생했습니다.');
                });
            }
        }
    </script>

    <footer style="text-align: center; padding: 20px 0; font-size: 14px; color: #333; background: #f8f9fa; margin-top: 30px; border-top: 1px solid #dee2e6; font-weight: 500;">
        &copy; 2025 luxfind. All rights reserved. Developed by Kim Jongsoung.
    </footer>
</body>
</html>
