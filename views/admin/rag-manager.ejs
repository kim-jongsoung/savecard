<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG ìƒí’ˆ ê°€ì´ë“œ ê´€ë¦¬ | ê´Œì„¸ì´ë¸Œì¹´ë“œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        .main-container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .guide-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .guide-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .category-badge {
            font-size: 0.85rem;
            padding: 5px 12px;
            border-radius: 20px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3f8f 100%);
        }
        
        .code-editor {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
        }
        
        .alert-custom {
            border-left: 4px solid #667eea;
            background: #f0f4ff;
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar', { currentPage: 'rag-manager', adminUsername: adminUsername || 'admin' }) %>

    <div class="main-container">
        <!-- í˜ì´ì§€ í—¤ë” -->
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="mb-2">
                        <i class="bi bi-book-half text-primary me-2"></i>RAG ìƒí’ˆ ê°€ì´ë“œ ê´€ë¦¬
                    </h2>
                    <p class="text-muted mb-0">ë°”ìš°ì²˜ì— ìë™ìœ¼ë¡œ í¬í•¨ë  ìƒí’ˆë³„ ì´ìš©ë°©ë²•ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-primary btn-lg" onclick="openCreateModal()">
                        <i class="bi bi-plus-circle me-2"></i>ìƒˆ ê°€ì´ë“œ ë“±ë¡
                    </button>
                </div>
            </div>
        </div>

        <!-- í†µê³„ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <h3 class="mb-2" id="total-guides">0</h3>
                    <p class="mb-0"><i class="bi bi-file-text me-2"></i>ì „ì²´ ê°€ì´ë“œ</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h3 class="text-primary mb-2" id="category-count">0</h3>
                        <p class="text-muted mb-0"><i class="bi bi-tags me-2"></i>ì¹´í…Œê³ ë¦¬ ìˆ˜</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h3 class="text-success mb-2" id="recent-updates">0</h3>
                        <p class="text-muted mb-0"><i class="bi bi-clock-history me-2"></i>ìµœê·¼ ìˆ˜ì •</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <button class="btn btn-outline-primary w-100" onclick="refreshGuides()">
                            <i class="bi bi-arrow-clockwise me-2"></i>ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê²€ìƒ‰ ë° í•„í„° -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="search-input" 
                               placeholder="ìƒí’ˆëª… ë˜ëŠ” í‚¤ì›Œë“œ ê²€ìƒ‰..." 
                               onkeyup="filterGuides()">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="category-filter" onchange="filterGuides()">
                            <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                            <i class="bi bi-x-circle me-2"></i>í•„í„° ì´ˆê¸°í™”
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì•ˆë‚´ -->
        <div class="alert alert-custom">
            <i class="bi bi-info-circle me-2"></i>
            <strong>ğŸ’¡ ê°€ì´ë“œ ë“±ë¡ ë°©ë²•:</strong> 
            <ol class="mb-0 mt-2">
                <li><strong>ê¸°ë³¸ ì •ë³´:</strong> ìƒí’ˆëª…ê³¼ ì¹´í…Œê³ ë¦¬ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤. í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ë©´ AIê°€ ë” ì •í™•í•˜ê²Œ ë§¤ì¹­í•©ë‹ˆë‹¤.</li>
                <li><strong>ìœ„ì¹˜ ë° ìš´ì˜:</strong> ì£¼ì†Œ, ìš´ì˜ì‹œê°„, ì—°ë½ì²˜ ë“± ê³ ê°ì´ í˜„ì¥ì—ì„œ í•„ìš”í•œ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</li>
                <li><strong>ì´ìš© ë°©ë²•:</strong> ë‹¨ê³„ë³„ë¡œ êµ¬ì²´ì ì¸ ì´ìš© ì ˆì°¨ë¥¼ ì‘ì„±í•˜ì„¸ìš”. ë°”ìš°ì²˜ì— ìë™ìœ¼ë¡œ í¬í•¨ë©ë‹ˆë‹¤.</li>
                <li><strong>ì£¼ì˜ì‚¬í•­:</strong> ê³ ê°ì´ ë°˜ë“œì‹œ ì•Œì•„ì•¼ í•  ì£¼ì˜ì‚¬í•­, ì·¨ì†Œ ê·œì •, ì¤€ë¹„ë¬¼ì„ ì…ë ¥í•˜ì„¸ìš”.</li>
                <li><strong>ë¯¸ë¦¬ë³´ê¸°:</strong> ìµœì¢… ì €ì¥ ì „ ìƒì„±ë  ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”.</li>
            </ol>
        </div>

        <!-- ê°€ì´ë“œ ëª©ë¡ -->
        <div id="guides-container" class="row">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">ë¡œë”©ì¤‘...</span>
                </div>
                <p class="text-muted mt-3">ê°€ì´ë“œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>
    </div>

    <!-- ìƒì„±/ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal fade" id="guideModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-text me-2"></i>
                        <span id="modal-title">ìƒˆ ê°€ì´ë“œ ë“±ë¡</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
                    <ul class="nav nav-tabs mb-4" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#basic-tab" type="button">
                                <i class="bi bi-info-circle me-2"></i>ê¸°ë³¸ ì •ë³´
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#location-tab" type="button">
                                <i class="bi bi-geo-alt me-2"></i>ìœ„ì¹˜ ë° ìš´ì˜
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#usage-tab" type="button">
                                <i class="bi bi-card-checklist me-2"></i>ì´ìš© ë°©ë²•
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#notice-tab" type="button">
                                <i class="bi bi-exclamation-triangle me-2"></i>ì£¼ì˜ì‚¬í•­
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#preview-tab" type="button">
                                <i class="bi bi-eye me-2"></i>ë¯¸ë¦¬ë³´ê¸°
                            </button>
                        </li>
                    </ul>

                    <!-- íƒ­ ì»¨í…ì¸  -->
                    <div class="tab-content">
                        <!-- ê¸°ë³¸ ì •ë³´ íƒ­ -->
                        <div class="tab-pane fade show active" id="basic-tab">
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label class="form-label fw-bold">ìƒí’ˆëª… <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control form-control-lg" id="product-name" 
                                           placeholder="ì˜ˆ: ì–¸ë”ì›Œí„°ì›”ë“œ ì…ì¥ê¶Œ">
                                    <small class="text-muted">ë°”ìš°ì²˜ ìƒì„± ì‹œ ì´ ì´ë¦„ìœ¼ë¡œ ìë™ ë§¤ì¹­ë©ë‹ˆë‹¤</small>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">ì¹´í…Œê³ ë¦¬ <span class="text-danger">*</span></label>
                                    <select class="form-select form-select-lg" id="category">
                                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                        <option value="ê´€ê´‘/ì²´í—˜">ê´€ê´‘/ì²´í—˜</option>
                                        <option value="ì•¡í‹°ë¹„í‹°">ì•¡í‹°ë¹„í‹°</option>
                                        <option value="ë ˆìŠ¤í† ë‘">ë ˆìŠ¤í† ë‘</option>
                                        <option value="ë Œí„°ì¹´">ë Œí„°ì¹´</option>
                                        <option value="ìŠ¤íŒŒ/ë§ˆì‚¬ì§€">ìŠ¤íŒŒ/ë§ˆì‚¬ì§€</option>
                                        <option value="ì‡¼/ê³µì—°">ì‡¼/ê³µì—°</option>
                                        <option value="íˆ¬ì–´">íˆ¬ì–´</option>
                                        <option value="ì›Œí„°íŒŒí¬">ì›Œí„°íŒŒí¬</option>
                                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">ê²€ìƒ‰ í‚¤ì›Œë“œ</label>
                                <input type="text" class="form-control" id="keywords" 
                                       placeholder="ìˆ˜ì¡±ê´€, í•´ì–‘ìƒë¬¼, ê°€ì¡±ì—¬í–‰ (ì‰¼í‘œë¡œ êµ¬ë¶„)">
                                <small class="text-muted">AIê°€ ìƒí’ˆì„ ë” ì •í™•í•˜ê²Œ ì°¾ì„ ìˆ˜ ìˆë„ë¡ ê´€ë ¨ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">ìƒí’ˆ ì„¤ëª…</label>
                                <textarea class="form-control" id="description" rows="3" 
                                          placeholder="ìƒí’ˆì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                            </div>
                        </div>

                        <!-- ìœ„ì¹˜ ë° ìš´ì˜ íƒ­ -->
                        <div class="tab-pane fade" id="location-tab">
                            <div class="mb-3">
                                <label class="form-label fw-bold">ì£¼ì†Œ</label>
                                <input type="text" class="form-control" id="address" 
                                       placeholder="ì˜ˆ: 1172 Pale San Vitores Rd, Tumon, Guam">
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">ìš´ì˜ ì‹œê°„</label>
                                    <input type="text" class="form-control" id="operating-hours" 
                                           placeholder="ì˜ˆ: ë§¤ì¼ 10:00 - 18:30">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">ì—°ë½ì²˜</label>
                                    <input type="text" class="form-control" id="contact" 
                                           placeholder="ì˜ˆ: +1 (671) 649-9191">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">ì£¼ì°¨ ì •ë³´</label>
                                <input type="text" class="form-control" id="parking" 
                                       placeholder="ì˜ˆ: ë¬´ë£Œ ì£¼ì°¨ì¥ ì´ìš© ê°€ëŠ¥">
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">ì°¾ì•„ê°€ëŠ” ë°©ë²•</label>
                                <textarea class="form-control" id="directions" rows="3" 
                                          placeholder="í˜„ì¥ê¹Œì§€ ê°€ëŠ” ë°©ë²•ì„ ìƒì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”"></textarea>
                            </div>
                        </div>

                        <!-- ì´ìš© ë°©ë²• íƒ­ -->
                        <div class="tab-pane fade" id="usage-tab">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                ì´ìš© ë°©ë²•ì€ ë‹¨ê³„ë³„ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”. ê° ë‹¨ê³„ë§ˆë‹¤ - ë¡œ ì‹œì‘í•˜ëŠ” ì„¸ë¶€ í•­ëª©ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </div>
                            <div id="usage-steps">
                                <div class="usage-step mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label fw-bold mb-0">1ë‹¨ê³„: ì˜ˆì•½ í™•ì¸</label>
                                    </div>
                                    <input type="text" class="form-control mb-2" placeholder="ë‹¨ê³„ ì œëª© (ì˜ˆ: ì˜ˆì•½ í™•ì¸)" value="ì˜ˆì•½ í™•ì¸">
                                    <textarea class="form-control" rows="3" 
                                              placeholder="ì„¸ë¶€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. ê° ì¤„ì€ ìë™ìœ¼ë¡œ í•­ëª©ìœ¼ë¡œ ë³€í™˜ë©ë‹ˆë‹¤.&#10;ì˜ˆ:&#10;ë°”ìš°ì²˜ë¥¼ ì¶œë ¥í•˜ê±°ë‚˜ ëª¨ë°”ì¼ë¡œ ì§€ì°¸í•´ì£¼ì„¸ìš”&#10;ì»¨íŒë²ˆí˜¸ë¥¼ ë©”ëª¨í•´ë‘ì‹œë©´ í¸ë¦¬í•©ë‹ˆë‹¤">ë°”ìš°ì²˜ë¥¼ ì¶œë ¥í•˜ê±°ë‚˜ ëª¨ë°”ì¼ë¡œ ì§€ì°¸í•´ì£¼ì„¸ìš”
ì»¨íŒë²ˆí˜¸ë¥¼ ë©”ëª¨í•´ë‘ì‹œë©´ í¸ë¦¬í•©ë‹ˆë‹¤</textarea>
                                </div>
                                <div class="usage-step mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label fw-bold mb-0">2ë‹¨ê³„: í˜„ì¥ ë„ì°©</label>
                                    </div>
                                    <input type="text" class="form-control mb-2" placeholder="ë‹¨ê³„ ì œëª©" value="í˜„ì¥ ë„ì°©">
                                    <textarea class="form-control" rows="3" 
                                              placeholder="ì„¸ë¶€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">ì˜ˆì•½ ì‹œê°„ 10ë¶„ ì „ ë„ì°© ê¶Œì¥
ì£¼ì°¨ì¥ ì´ìš© ì•ˆë‚´ë¥¼ í™•ì¸í•˜ì„¸ìš”</textarea>
                                </div>
                                <div class="usage-step mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label fw-bold mb-0">3ë‹¨ê³„: ì…ì¥ ì ˆì°¨</label>
                                    </div>
                                    <input type="text" class="form-control mb-2" placeholder="ë‹¨ê³„ ì œëª©" value="ì…ì¥ ì ˆì°¨">
                                    <textarea class="form-control" rows="3" 
                                              placeholder="ì„¸ë¶€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">ë§¤í‘œì†Œì—ì„œ ë°”ìš°ì²˜ ì œì‹œ
ì‹ ë¶„ì¦ ì§€ì°¸ ê¶Œì¥</textarea>
                                </div>
                            </div>
                            <button class="btn btn-outline-primary btn-sm" onclick="addUsageStep()">
                                <i class="bi bi-plus-circle me-1"></i>ë‹¨ê³„ ì¶”ê°€
                            </button>
                        </div>

                        <!-- ì£¼ì˜ì‚¬í•­ íƒ­ -->
                        <div class="tab-pane fade" id="notice-tab">
                            <div class="mb-3">
                                <label class="form-label fw-bold">í•„ìˆ˜ ì£¼ì˜ì‚¬í•­</label>
                                <textarea class="form-control" id="warnings" rows="5" 
                                          placeholder="ê° ì¤„ë§ˆë‹¤ í•˜ë‚˜ì˜ ì£¼ì˜ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”&#10;ì˜ˆ:&#10;ì˜ˆì•½ ì‹œê°„ ì—„ìˆ˜&#10;ìŒì‹ë¬¼ ë°˜ì… ê¸ˆì§€&#10;ì–´ë¦°ì´ëŠ” ë³´í˜¸ì ë™ë°˜ í•„ìˆ˜"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">ì·¨ì†Œ/ë³€ê²½ ê·œì •</label>
                                <textarea class="form-control" id="cancellation" rows="3" 
                                          placeholder="ì·¨ì†Œ ë° ë³€ê²½ ê·œì •ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">ì¤€ë¹„ë¬¼</label>
                                <input type="text" class="form-control" id="requirements" 
                                       placeholder="ì˜ˆ: ì‹ ë¶„ì¦, ìˆ˜ì˜ë³µ, íƒ€ì›”">
                            </div>
                        </div>

                        <!-- ë¯¸ë¦¬ë³´ê¸° íƒ­ -->
                        <div class="tab-pane fade" id="preview-tab">
                            <div class="alert alert-warning">
                                <i class="bi bi-eye me-2"></i>
                                ì•„ë˜ëŠ” ìµœì¢… ìƒì„±ë  ê°€ì´ë“œ ë‚´ìš©ì…ë‹ˆë‹¤. ì €ì¥ ì „ í™•ì¸í•´ì£¼ì„¸ìš”.
                            </div>
                            <pre class="code-editor border rounded p-3 bg-light" id="final-preview" style="max-height: 600px; overflow-y: auto;"></pre>
                            <button class="btn btn-outline-secondary" onclick="updatePreview()">
                                <i class="bi bi-arrow-clockwise me-1"></i>ë¯¸ë¦¬ë³´ê¸° ìƒˆë¡œê³ ì¹¨
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" onclick="generateTemplate()">
                        <i class="bi bi-file-earmark-code me-1"></i>í…œí”Œë¦¿ ìƒì„±
                    </button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button class="btn btn-primary" onclick="saveGuide()">
                        <i class="bi bi-check-circle me-1"></i>ì €ì¥
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-eye me-2"></i>ê°€ì´ë“œ ë¯¸ë¦¬ë³´ê¸°
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <pre class="code-editor border rounded p-3 bg-light" id="preview-content"></pre>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let guides = [];
        let currentEditingId = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê°€ì´ë“œ ëª©ë¡ ì¡°íšŒ
        document.addEventListener('DOMContentLoaded', () => {
            loadGuides();
            
            // ë¯¸ë¦¬ë³´ê¸° íƒ­ í´ë¦­ ì‹œ ìë™ìœ¼ë¡œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            document.querySelector('[data-bs-target="#preview-tab"]').addEventListener('click', () => {
                setTimeout(updatePreview, 100);
            });
        });

        // ê°€ì´ë“œ ëª©ë¡ ë¡œë“œ
        async function loadGuides() {
            try {
                const response = await fetch('/api/rag/guides');
                const data = await response.json();
                
                if (data.success) {
                    guides = data.guides;
                    renderGuides();
                    updateStats();
                    updateCategoryFilter();
                } else {
                    showAlert('ê°€ì´ë“œ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ' + data.message, 'danger');
                }
            } catch (error) {
                console.error('ê°€ì´ë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
                showAlert('ê°€ì´ë“œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        // ê°€ì´ë“œ ë Œë”ë§
        function renderGuides() {
            const container = document.getElementById('guides-container');
            
            if (guides.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 4rem; color: #ddd;"></i>
                        <p class="text-muted mt-3">ë“±ë¡ëœ ê°€ì´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <button class="btn btn-primary" onclick="openCreateModal()">
                            <i class="bi bi-plus-circle me-2"></i>ì²« ê°€ì´ë“œ ë“±ë¡í•˜ê¸°
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = guides.map(guide => `
                <div class="col-md-6 col-lg-4 guide-item" 
                     data-name="${guide.name}" 
                     data-category="${guide.category}">
                    <div class="card guide-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">${guide.name}</h5>
                                <span class="category-badge badge bg-primary">${guide.category}</span>
                            </div>
                            <p class="text-muted small mb-3">
                                <i class="bi bi-calendar me-1"></i>${new Date(guide.created_at).toLocaleDateString('ko-KR')}
                            </p>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary btn-sm flex-fill" 
                                        onclick="editGuide(${guide.id})">
                                    <i class="bi bi-pencil"></i> ìˆ˜ì •
                                </button>
                                <button class="btn btn-outline-info btn-sm flex-fill" 
                                        onclick="previewGuide(${guide.id})">
                                    <i class="bi bi-eye"></i> ë³´ê¸°
                                </button>
                                <button class="btn btn-outline-danger btn-sm" 
                                        onclick="deleteGuide(${guide.id}, '${guide.name}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            document.getElementById('total-guides').textContent = guides.length;
            
            const categories = new Set(guides.map(g => g.category));
            document.getElementById('category-count').textContent = categories.size;
            
            // ìµœê·¼ ìˆ˜ì • (ì„ì‹œ)
            document.getElementById('recent-updates').textContent = guides.length;
        }

        // ì¹´í…Œê³ ë¦¬ í•„í„° ì—…ë°ì´íŠ¸
        function updateCategoryFilter() {
            const categories = [...new Set(guides.map(g => g.category))];
            const select = document.getElementById('category-filter');
            
            select.innerHTML = '<option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>' +
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        // í•„í„°ë§
        function filterGuides() {
            const searchText = document.getElementById('search-input').value.toLowerCase();
            const category = document.getElementById('category-filter').value;
            
            document.querySelectorAll('.guide-item').forEach(item => {
                const name = item.dataset.name.toLowerCase();
                const itemCategory = item.dataset.category;
                
                const matchSearch = name.includes(searchText);
                const matchCategory = !category || itemCategory === category;
                
                item.style.display = matchSearch && matchCategory ? '' : 'none';
            });
        }

        // í•„í„° ì´ˆê¸°í™”
        function resetFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('category-filter').value = '';
            filterGuides();
        }

        // ìƒˆë¡œê³ ì¹¨
        function refreshGuides() {
            loadGuides();
            showAlert('âœ… ëª©ë¡ì´ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }

        // ìƒì„± ëª¨ë‹¬ ì—´ê¸°
        function openCreateModal() {
            currentEditingId = null;
            document.getElementById('modal-title').textContent = 'ìƒˆ ê°€ì´ë“œ ë“±ë¡';
            
            // ê¸°ë³¸ ì •ë³´ ì´ˆê¸°í™”
            document.getElementById('product-name').value = '';
            document.getElementById('category').value = '';
            document.getElementById('keywords').value = '';
            document.getElementById('description').value = '';
            
            // ìœ„ì¹˜ ë° ìš´ì˜ ì´ˆê¸°í™”
            document.getElementById('address').value = '';
            document.getElementById('operating-hours').value = '';
            document.getElementById('contact').value = '';
            document.getElementById('parking').value = '';
            document.getElementById('directions').value = '';
            
            // ì£¼ì˜ì‚¬í•­ ì´ˆê¸°í™”
            document.getElementById('warnings').value = '';
            document.getElementById('cancellation').value = '';
            document.getElementById('requirements').value = '';
            
            new bootstrap.Modal(document.getElementById('guideModal')).show();
        }
        
        // ì´ìš© ë°©ë²• ë‹¨ê³„ ì¶”ê°€
        function addUsageStep() {
            const container = document.getElementById('usage-steps');
            const stepCount = container.querySelectorAll('.usage-step').length + 1;
            
            const stepHtml = `
                <div class="usage-step mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label fw-bold mb-0">${stepCount}ë‹¨ê³„</label>
                        <button class="btn btn-sm btn-outline-danger" onclick="this.closest('.usage-step').remove()">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <input type="text" class="form-control mb-2" placeholder="ë‹¨ê³„ ì œëª©">
                    <textarea class="form-control" rows="3" placeholder="ì„¸ë¶€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', stepHtml);
        }
        
        // í¼ ë°ì´í„°ë¥¼ ê°€ì´ë“œ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
        function generateGuideText() {
            const productName = document.getElementById('product-name').value.trim();
            const category = document.getElementById('category').value.trim();
            const keywords = document.getElementById('keywords').value.trim();
            const description = document.getElementById('description').value.trim();
            
            const address = document.getElementById('address').value.trim();
            const operatingHours = document.getElementById('operating-hours').value.trim();
            const contact = document.getElementById('contact').value.trim();
            const parking = document.getElementById('parking').value.trim();
            const directions = document.getElementById('directions').value.trim();
            
            const warnings = document.getElementById('warnings').value.trim();
            const cancellation = document.getElementById('cancellation').value.trim();
            const requirements = document.getElementById('requirements').value.trim();
            
            let guideText = `ìƒí’ˆëª…: ${productName}\n`;
            guideText += `ì¹´í…Œê³ ë¦¬: ${category || 'ë¯¸ë¶„ë¥˜'}\n`;
            if (keywords) guideText += `í‚¤ì›Œë“œ: ${keywords}\n`;
            if (description) guideText += `\nì„¤ëª…: ${description}\n`;
            
            // ìœ„ì¹˜ ì •ë³´
            if (address || operatingHours || contact || parking) {
                guideText += `\n=== ìœ„ì¹˜ ë° ìš´ì˜ ì •ë³´ ===\n\n`;
                if (address) guideText += `ì£¼ì†Œ: ${address}\n`;
                if (operatingHours) guideText += `ìš´ì˜ì‹œê°„: ${operatingHours}\n`;
                if (contact) guideText += `ì—°ë½ì²˜: ${contact}\n`;
                if (parking) guideText += `ì£¼ì°¨: ${parking}\n`;
                if (directions) guideText += `\nì°¾ì•„ê°€ëŠ” ë°©ë²•:\n${directions}\n`;
            }
            
            // ì´ìš© ë°©ë²•
            guideText += `\n=== ì´ìš© ë°©ë²• ===\n\n`;
            const usageSteps = document.querySelectorAll('#usage-steps .usage-step');
            usageSteps.forEach((step, index) => {
                const title = step.querySelector('input').value.trim() || `${index + 1}ë‹¨ê³„`;
                const content = step.querySelector('textarea').value.trim();
                
                guideText += `${index + 1}. ${title}\n`;
                if (content) {
                    content.split('\n').forEach(line => {
                        if (line.trim()) guideText += `   - ${line.trim()}\n`;
                    });
                }
                guideText += '\n';
            });
            
            // ì£¼ì˜ì‚¬í•­
            if (warnings || cancellation || requirements) {
                guideText += `=== ì£¼ì˜ì‚¬í•­ ===\n\n`;
                if (warnings) {
                    warnings.split('\n').forEach(line => {
                        if (line.trim()) guideText += `- ${line.trim()}\n`;
                    });
                }
                if (cancellation) {
                    guideText += `\nì·¨ì†Œ/ë³€ê²½:\n${cancellation}\n`;
                }
                if (requirements) {
                    guideText += `\nì¤€ë¹„ë¬¼: ${requirements}\n`;
                }
            }
            
            return guideText;
        }
        
        // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updatePreview() {
            const guideText = generateGuideText();
            document.getElementById('final-preview').textContent = guideText;
        }
        
        // í…œí”Œë¦¿ ìƒì„± (ê¸°ë³¸ê°’ ì±„ìš°ê¸°)
        function generateTemplate() {
            if (!document.getElementById('product-name').value) {
                showAlert('ìƒí’ˆëª…ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }
            
            const productName = document.getElementById('product-name').value;
            
            // ê¸°ë³¸ í…œí”Œë¦¿ ê°’ ì„¤ì •
            if (!document.getElementById('keywords').value) {
                document.getElementById('keywords').value = 'ê´€ê´‘, ì²´í—˜, ê°€ì¡±ì—¬í–‰';
            }
            
            if (!document.getElementById('description').value) {
                document.getElementById('description').value = `${productName}ì— ëŒ€í•œ ì„¤ëª…ì…ë‹ˆë‹¤.`;
            }
            
            showAlert('âœ… ê¸°ë³¸ í…œí”Œë¦¿ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ê° íƒ­ì—ì„œ ë‚´ìš©ì„ ìˆ˜ì •í•´ì£¼ì„¸ìš”.', 'success');
        }

        // ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
        async function editGuide(id) {
            try {
                const response = await fetch(`/api/rag/guides/${id}`);
                const data = await response.json();
                
                if (data.success) {
                    currentEditingId = id;
                    document.getElementById('modal-title').textContent = 'ê°€ì´ë“œ ìˆ˜ì •';
                    
                    // íŒŒì‹±
                    const content = data.content;
                    
                    // ê¸°ë³¸ ì •ë³´
                    const nameMatch = content.match(/ìƒí’ˆëª…:\s*(.+)/);
                    const categoryMatch = content.match(/ì¹´í…Œê³ ë¦¬:\s*(.+)/);
                    const keywordsMatch = content.match(/í‚¤ì›Œë“œ:\s*(.+)/);
                    const descMatch = content.match(/ì„¤ëª…:\s*(.+)/);
                    
                    document.getElementById('product-name').value = nameMatch ? nameMatch[1].trim() : '';
                    document.getElementById('category').value = categoryMatch ? categoryMatch[1].trim() : '';
                    document.getElementById('keywords').value = keywordsMatch ? keywordsMatch[1].trim() : '';
                    document.getElementById('description').value = descMatch ? descMatch[1].trim() : '';
                    
                    // ìœ„ì¹˜ ë° ìš´ì˜
                    const addressMatch = content.match(/ì£¼ì†Œ:\s*(.+)/);
                    const hoursMatch = content.match(/ìš´ì˜ì‹œê°„:\s*(.+)/);
                    const contactMatch = content.match(/ì—°ë½ì²˜:\s*(.+)/);
                    const parkingMatch = content.match(/ì£¼ì°¨:\s*(.+)/);
                    const directionsMatch = content.match(/ì°¾ì•„ê°€ëŠ” ë°©ë²•:\n(.+?)(?=\n\n|$)/s);
                    
                    document.getElementById('address').value = addressMatch ? addressMatch[1].trim() : '';
                    document.getElementById('operating-hours').value = hoursMatch ? hoursMatch[1].trim() : '';
                    document.getElementById('contact').value = contactMatch ? contactMatch[1].trim() : '';
                    document.getElementById('parking').value = parkingMatch ? parkingMatch[1].trim() : '';
                    document.getElementById('directions').value = directionsMatch ? directionsMatch[1].trim() : '';
                    
                    // ì´ìš© ë°©ë²• íŒŒì‹± (ê¸°ë³¸ 3ë‹¨ê³„ë§Œ ì±„ì›€)
                    const usageSection = content.match(/=== ì´ìš© ë°©ë²• ===\n\n(.+?)(?=\n===|$)/s);
                    if (usageSection) {
                        const steps = usageSection[1].match(/\d+\.\s+(.+?)\n((?:\s+-\s+.+\n?)*)/g);
                        if (steps && steps.length > 0) {
                            const stepElements = document.querySelectorAll('#usage-steps .usage-step');
                            steps.forEach((stepText, index) => {
                                if (index < stepElements.length) {
                                    const titleMatch = stepText.match(/\d+\.\s+(.+)/);
                                    const itemsMatch = stepText.match(/\s+-\s+(.+)/g);
                                    
                                    if (titleMatch) {
                                        stepElements[index].querySelector('input').value = titleMatch[1].trim();
                                    }
                                    if (itemsMatch) {
                                        const items = itemsMatch.map(item => item.replace(/\s+-\s+/, '').trim()).join('\n');
                                        stepElements[index].querySelector('textarea').value = items;
                                    }
                                }
                            });
                        }
                    }
                    
                    // ì£¼ì˜ì‚¬í•­
                    const noticeSection = content.match(/=== ì£¼ì˜ì‚¬í•­ ===\n\n(.+?)(?:\nì·¨ì†Œ\/ë³€ê²½:|$)/s);
                    if (noticeSection) {
                        const warnings = noticeSection[1].match(/^-\s+(.+)/gm);
                        if (warnings) {
                            document.getElementById('warnings').value = warnings.map(w => w.replace(/^-\s+/, '')).join('\n');
                        }
                    }
                    
                    const cancelMatch = content.match(/ì·¨ì†Œ\/ë³€ê²½:\n(.+?)(?=\n\n|$)/s);
                    const reqMatch = content.match(/ì¤€ë¹„ë¬¼:\s*(.+)/);
                    
                    document.getElementById('cancellation').value = cancelMatch ? cancelMatch[1].trim() : '';
                    document.getElementById('requirements').value = reqMatch ? reqMatch[1].trim() : '';
                    
                    new bootstrap.Modal(document.getElementById('guideModal')).show();
                }
            } catch (error) {
                console.error('ê°€ì´ë“œ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
                showAlert('ê°€ì´ë“œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        // ë¯¸ë¦¬ë³´ê¸°
        async function previewGuide(id) {
            try {
                const response = await fetch(`/api/rag/guides/${id}`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('preview-content').textContent = data.content;
                    new bootstrap.Modal(document.getElementById('previewModal')).show();
                }
            } catch (error) {
                showAlert('ê°€ì´ë“œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        // ì €ì¥
        async function saveGuide() {
            const productName = document.getElementById('product-name').value.trim();
            const category = document.getElementById('category').value.trim();
            
            if (!productName) {
                showAlert('ìƒí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                // ê¸°ë³¸ ì •ë³´ íƒ­ìœ¼ë¡œ ì´ë™
                document.querySelector('[data-bs-target="#basic-tab"]').click();
                return;
            }
            
            if (!category) {
                showAlert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
                document.querySelector('[data-bs-target="#basic-tab"]').click();
                return;
            }
            
            // í¼ ë°ì´í„°ë¥¼ ê°€ì´ë“œ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
            const content = generateGuideText();
            
            try {
                const response = await fetch('/api/rag/guides', {
                    method: currentEditingId ? 'PUT' : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: currentEditingId,
                        productName,
                        content
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('âœ… ê°€ì´ë“œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('guideModal')).hide();
                    loadGuides();
                } else {
                    showAlert('ì €ì¥ ì‹¤íŒ¨: ' + data.message, 'danger');
                }
            } catch (error) {
                showAlert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        // ì‚­ì œ
        async function deleteGuide(id, productName) {
            if (!confirm(`"${productName}" ê°€ì´ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/rag/guides/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('âœ… ê°€ì´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    loadGuides();
                } else {
                    showAlert('ì‚­ì œ ì‹¤íŒ¨: ' + data.message, 'danger');
                }
            } catch (error) {
                showAlert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        // ì•Œë¦¼
        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" 
                     style="z-index: 9999; min-width: 300px;" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', alertHtml);
            
            setTimeout(() => {
                document.querySelector('.alert')?.remove();
            }, 3000);
        }
    </script>
</body>
</html>
