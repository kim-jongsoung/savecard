<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG 상품 가이드 관리 | 괌세이브카드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .main-container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .page-header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .guide-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .guide-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .category-badge {
            font-size: 0.85rem;
            padding: 5px 12px;
            border-radius: 20px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3f8f 100%);
        }
        
        .code-editor {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
        }
        
        .alert-custom {
            border-left: 4px solid #667eea;
            background: #f0f4ff;
        }
    </style>
</head>
<body>
    <!-- 네비게이션 -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin/dashboard">
                <i class="bi bi-grid-3x3-gap-fill me-2"></i>괌세이브카드 관리자
            </a>
            <div class="d-flex align-items-center">
                <span class="text-white me-3">
                    <i class="bi bi-person-circle me-1"></i>관리자
                </span>
                <a href="/admin/logout" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-box-arrow-right me-1"></i>로그아웃
                </a>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- 페이지 헤더 -->
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="mb-2">
                        <i class="bi bi-book-half text-primary me-2"></i>RAG 상품 가이드 관리
                    </h2>
                    <p class="text-muted mb-0">바우처에 자동으로 포함될 상품별 이용방법을 관리합니다</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-primary btn-lg" onclick="openCreateModal()">
                        <i class="bi bi-plus-circle me-2"></i>새 가이드 등록
                    </button>
                </div>
            </div>
        </div>

        <!-- 통계 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <h3 class="mb-2" id="total-guides">0</h3>
                    <p class="mb-0"><i class="bi bi-file-text me-2"></i>전체 가이드</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h3 class="text-primary mb-2" id="category-count">0</h3>
                        <p class="text-muted mb-0"><i class="bi bi-tags me-2"></i>카테고리 수</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h3 class="text-success mb-2" id="recent-updates">0</h3>
                        <p class="text-muted mb-0"><i class="bi bi-clock-history me-2"></i>최근 수정</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <button class="btn btn-outline-primary w-100" onclick="refreshGuides()">
                            <i class="bi bi-arrow-clockwise me-2"></i>새로고침
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 검색 및 필터 -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="search-input" 
                               placeholder="상품명 또는 키워드 검색..." 
                               onkeyup="filterGuides()">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="category-filter" onchange="filterGuides()">
                            <option value="">전체 카테고리</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                            <i class="bi bi-x-circle me-2"></i>필터 초기화
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 안내 -->
        <div class="alert alert-custom">
            <i class="bi bi-info-circle me-2"></i>
            <strong>가이드 형식:</strong> TXT 파일로 저장되며, 바우처 생성 시 상품명으로 자동 매칭됩니다. 
            "=== 이용 방법 ===" 섹션이 바우처에 포함됩니다.
        </div>

        <!-- 가이드 목록 -->
        <div id="guides-container" class="row">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">로딩중...</span>
                </div>
                <p class="text-muted mt-3">가이드 목록을 불러오는 중...</p>
            </div>
        </div>
    </div>

    <!-- 생성/수정 모달 -->
    <div class="modal fade" id="guideModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-text me-2"></i>
                        <span id="modal-title">새 가이드 등록</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">상품명 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="product-name" 
                                   placeholder="예: 언더워터월드 입장권">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">카테고리 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="category" 
                                   placeholder="예: 관광/체험">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">키워드</label>
                            <input type="text" class="form-control" id="keywords" 
                                   placeholder="쉼표로 구분">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">가이드 내용 <span class="text-danger">*</span></label>
                        <textarea class="form-control code-editor" id="guide-content" rows="20" 
                                  placeholder="상품명: 언더워터월드 입장권
카테고리: 관광/체험
키워드: 수족관, 해양생물, 가족여행

=== 이용 방법 ===

1. 예약 확인
   - 바우처를 출력하거나 모바일로 지참해주세요
   - 컨펌번호를 메모해두시면 편리합니다

2. 현장 도착
   - 주소: 1172 Pale San Vitores Rd, Tumon, Guam
   - 운영시간: 매일 10:00 - 18:30 (마지막 입장 18:00)
   - 무료 주차장 이용 가능

3. 입장 절차
   - 매표소에서 바우처 제시 및 입장권 교환
   - 소요시간: 약 5-10분
   - 신분증 지참 권장

=== 주의사항 ===
- 예약 시간 엄수
- 음식물 반입 금지
- 어린이는 보호자 동반 필수"></textarea>
                        <div class="form-text">
                            <i class="bi bi-lightbulb me-1"></i>
                            "=== 이용 방법 ===" 섹션이 자동으로 바우처에 포함됩니다
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button class="btn btn-primary" onclick="saveGuide()">
                        <i class="bi bi-check-circle me-1"></i>저장
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 미리보기 모달 -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-eye me-2"></i>가이드 미리보기
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <pre class="code-editor border rounded p-3 bg-light" id="preview-content"></pre>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let guides = [];
        let currentEditingFile = null;

        // 페이지 로드 시 가이드 목록 조회
        document.addEventListener('DOMContentLoaded', () => {
            loadGuides();
        });

        // 가이드 목록 로드
        async function loadGuides() {
            try {
                const response = await fetch('/api/rag/guides');
                const data = await response.json();
                
                if (data.success) {
                    guides = data.guides;
                    renderGuides();
                    updateStats();
                    updateCategoryFilter();
                } else {
                    showAlert('가이드 목록 조회 실패: ' + data.message, 'danger');
                }
            } catch (error) {
                console.error('가이드 로드 오류:', error);
                showAlert('가이드 목록을 불러올 수 없습니다.', 'danger');
            }
        }

        // 가이드 렌더링
        function renderGuides() {
            const container = document.getElementById('guides-container');
            
            if (guides.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 4rem; color: #ddd;"></i>
                        <p class="text-muted mt-3">등록된 가이드가 없습니다.</p>
                        <button class="btn btn-primary" onclick="openCreateModal()">
                            <i class="bi bi-plus-circle me-2"></i>첫 가이드 등록하기
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = guides.map(guide => `
                <div class="col-md-6 col-lg-4 guide-item" 
                     data-name="${guide.name}" 
                     data-category="${guide.category}">
                    <div class="card guide-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">${guide.name}</h5>
                                <span class="category-badge badge bg-primary">${guide.category}</span>
                            </div>
                            <p class="text-muted small mb-3">
                                <i class="bi bi-file-text me-1"></i>${guide.file}
                            </p>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary btn-sm flex-fill" 
                                        onclick="editGuide('${guide.file}')">
                                    <i class="bi bi-pencil"></i> 수정
                                </button>
                                <button class="btn btn-outline-info btn-sm flex-fill" 
                                        onclick="previewGuide('${guide.file}')">
                                    <i class="bi bi-eye"></i> 보기
                                </button>
                                <button class="btn btn-outline-danger btn-sm" 
                                        onclick="deleteGuide('${guide.file}', '${guide.name}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 통계 업데이트
        function updateStats() {
            document.getElementById('total-guides').textContent = guides.length;
            
            const categories = new Set(guides.map(g => g.category));
            document.getElementById('category-count').textContent = categories.size;
            
            // 최근 수정 (임시)
            document.getElementById('recent-updates').textContent = guides.length;
        }

        // 카테고리 필터 업데이트
        function updateCategoryFilter() {
            const categories = [...new Set(guides.map(g => g.category))];
            const select = document.getElementById('category-filter');
            
            select.innerHTML = '<option value="">전체 카테고리</option>' +
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        // 필터링
        function filterGuides() {
            const searchText = document.getElementById('search-input').value.toLowerCase();
            const category = document.getElementById('category-filter').value;
            
            document.querySelectorAll('.guide-item').forEach(item => {
                const name = item.dataset.name.toLowerCase();
                const itemCategory = item.dataset.category;
                
                const matchSearch = name.includes(searchText);
                const matchCategory = !category || itemCategory === category;
                
                item.style.display = matchSearch && matchCategory ? '' : 'none';
            });
        }

        // 필터 초기화
        function resetFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('category-filter').value = '';
            filterGuides();
        }

        // 새로고침
        function refreshGuides() {
            loadGuides();
            showAlert('✅ 목록이 새로고침되었습니다', 'success');
        }

        // 생성 모달 열기
        function openCreateModal() {
            currentEditingFile = null;
            document.getElementById('modal-title').textContent = '새 가이드 등록';
            document.getElementById('product-name').value = '';
            document.getElementById('category').value = '';
            document.getElementById('keywords').value = '';
            document.getElementById('guide-content').value = '';
            
            new bootstrap.Modal(document.getElementById('guideModal')).show();
        }

        // 수정 모달 열기
        async function editGuide(filename) {
            try {
                const response = await fetch(`/api/rag/guides/${encodeURIComponent(filename)}`);
                const data = await response.json();
                
                if (data.success) {
                    currentEditingFile = filename;
                    document.getElementById('modal-title').textContent = '가이드 수정';
                    
                    // 파싱
                    const content = data.content;
                    const nameMatch = content.match(/상품명:\s*(.+)/);
                    const categoryMatch = content.match(/카테고리:\s*(.+)/);
                    const keywordsMatch = content.match(/키워드:\s*(.+)/);
                    
                    document.getElementById('product-name').value = nameMatch ? nameMatch[1].trim() : '';
                    document.getElementById('category').value = categoryMatch ? categoryMatch[1].trim() : '';
                    document.getElementById('keywords').value = keywordsMatch ? keywordsMatch[1].trim() : '';
                    document.getElementById('guide-content').value = content;
                    
                    new bootstrap.Modal(document.getElementById('guideModal')).show();
                }
            } catch (error) {
                showAlert('가이드를 불러올 수 없습니다.', 'danger');
            }
        }

        // 미리보기
        async function previewGuide(filename) {
            try {
                const response = await fetch(`/api/rag/guides/${encodeURIComponent(filename)}`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('preview-content').textContent = data.content;
                    new bootstrap.Modal(document.getElementById('previewModal')).show();
                }
            } catch (error) {
                showAlert('가이드를 불러올 수 없습니다.', 'danger');
            }
        }

        // 저장
        async function saveGuide() {
            const productName = document.getElementById('product-name').value.trim();
            const content = document.getElementById('guide-content').value.trim();
            
            if (!productName || !content) {
                showAlert('상품명과 가이드 내용을 입력해주세요.', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/rag/guides', {
                    method: currentEditingFile ? 'PUT' : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productName,
                        content,
                        existingFile: currentEditingFile
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('✅ 가이드가 저장되었습니다!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('guideModal')).hide();
                    loadGuides();
                } else {
                    showAlert('저장 실패: ' + data.message, 'danger');
                }
            } catch (error) {
                showAlert('저장 중 오류가 발생했습니다.', 'danger');
            }
        }

        // 삭제
        async function deleteGuide(filename, productName) {
            if (!confirm(`"${productName}" 가이드를 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/rag/guides/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('✅ 가이드가 삭제되었습니다.', 'success');
                    loadGuides();
                } else {
                    showAlert('삭제 실패: ' + data.message, 'danger');
                }
            } catch (error) {
                showAlert('삭제 중 오류가 발생했습니다.', 'danger');
            }
        }

        // 알림
        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" 
                     style="z-index: 9999; min-width: 300px;" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', alertHtml);
            
            setTimeout(() => {
                document.querySelector('.alert')?.remove();
            }, 3000);
        }
    </script>
</body>
</html>
