<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìˆ˜ë°°í”¼ ê´€ë¦¬</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { font-size: 0.7rem; }
    h2 { font-size: 1.4rem; }
    .btn { font-size: 0.7rem; padding: 0.3rem 0.7rem; }
    .form-label { font-size: 0.7rem; }
    .form-control, .form-select { font-size: 0.7rem; padding: 0.3rem 0.5rem; }
    .table { font-size: 0.65rem; }
    .table th { font-size: 0.7rem; padding: 0.5rem; }
    .table td { padding: 0.5rem; }
    .badge { font-size: 0.65rem; }
    .filter-card { background: #f8f9fa; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; }
    .alert-info { font-size: 0.7rem; padding: 0.75rem; }
  </style>
</head>
<body>
  <%- include('../partials/navbar') %>
  <div class="container-fluid mt-4">
    <h2><i class="bi bi-currency-dollar"></i> ìˆ˜ë°°í”¼ ê´€ë¦¬ <button class="btn btn-primary btn-sm ms-3" onclick="openAddModal()"><i class="bi bi-plus-circle"></i> ë“±ë¡</button></h2>
    
    <div class="alert alert-info mt-3">
      ğŸ’¡ <strong>ìˆ˜ë°°í”¼ = ìˆ˜ë°°ëŒ€í–‰ë£Œ + ì†¡ê¸ˆìˆ˜ìˆ˜ë£Œ</strong><br>
      â€¢ <strong>1ë°•ë‹¹ ë°©ì‹</strong>: 1ë°•ì— $10ì”© ê³„ì‚° (ì˜ˆ: 3ë°• = $30)<br>
      â€¢ <strong>ì •ì•¡ì œ ë°©ì‹</strong>: Në°•ê¹Œì§€ 1ë°•ë‹¹, Në°• ì´ˆê³¼ì‹œ ì •ì•¡ ê³ ì • (ì˜ˆ: 3ë°•ê¹Œì§€ $10/ë°•, 4ë°• ì´ìƒ $30 ê³ ì •)
    </div>
    
    <div class="filter-card">
      <div class="row g-2">
        <div class="col-md-4">
          <label class="form-label">ê±°ë˜ì²˜</label>
          <select class="form-select" id="filterAgency" onchange="loadFees()">
            <option value="">ì „ì²´</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">í˜¸í…”</label>
          <select class="form-select" id="filterHotel" onchange="loadFees()">
            <option value="">ì „ì²´</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">ìƒíƒœ</label>
          <select class="form-select" id="filterActive" onchange="loadFees()">
            <option value="">ì „ì²´</option>
            <option value="true" selected>í™œì„±</option>
            <option value="false">ë¹„í™œì„±</option>
          </select>
        </div>
      </div>
    </div>
    
    <table class="table table-sm table-hover">
      <thead class="table-light">
        <tr>
          <th>ê±°ë˜ì²˜</th>
          <th>í˜¸í…”</th>
          <th>ìˆ˜ë°°í”¼ëª…</th>
          <th>ë°©ì‹</th>
          <th>1ë°•ë‹¹ ê¸ˆì•¡</th>
          <th>ìµœëŒ€ë°•ìˆ˜</th>
          <th>ì •ì•¡ ê¸ˆì•¡</th>
          <th>ì ìš© ê¸°ê°„</th>
          <th>ìƒíƒœ</th>
          <th>ì‘ì—…</th>
        </tr>
      </thead>
      <tbody id="feeList">
        <tr><td colspan="10" class="text-center">ë¡œë”©ì¤‘...</td></tr>
      </tbody>
    </table>
  </div>
  
  <div class="modal fade" id="feeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">ìˆ˜ë°°í”¼ ë“±ë¡</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="feeId">
          
          <div class="row">
            <div class="col-md-6 mb-2">
              <label class="form-label">ê±°ë˜ì²˜ *</label>
              <select class="form-select" id="agencyId" required>
                <option value="">ì„ íƒ</option>
              </select>
            </div>
            <div class="col-md-6 mb-2">
              <label class="form-label">í˜¸í…”</label>
              <select class="form-select" id="hotelId">
                <option value="">ì „ì²´ í˜¸í…” ì ìš©</option>
              </select>
            </div>
          </div>
          
          <div class="mb-2">
            <label class="form-label">ìˆ˜ë°°í”¼ëª… *</label>
            <input type="text" class="form-control" id="feeName" placeholder="ì˜ˆ: ê¸°ë³¸ ìˆ˜ë°°í”¼" required>
          </div>
          
          <div class="mb-2">
            <label class="form-label">ë°©ì‹ *</label>
            <select class="form-select" id="feeType" onchange="onFeeTypeChange()" required>
              <option value="per_night">1ë°•ë‹¹ ë°©ì‹</option>
              <option value="flat">ì •ì•¡ì œ ë°©ì‹</option>
            </select>
          </div>
          
          <div class="row" id="perNightFields">
            <div class="col-md-12 mb-2">
              <label class="form-label">1ë°•ë‹¹ ê¸ˆì•¡ ($) *</label>
              <input type="number" class="form-control" id="feePerNight" step="0.01" placeholder="10.00">
            </div>
          </div>
          
          <div class="row" id="flatFields" style="display: none;">
            <div class="col-md-4 mb-2">
              <label class="form-label">1ë°•ë‹¹ ê¸ˆì•¡ ($) *</label>
              <input type="number" class="form-control" id="feePerNightFlat" step="0.01" placeholder="10.00">
            </div>
            <div class="col-md-4 mb-2">
              <label class="form-label">ìµœëŒ€ ë°•ìˆ˜</label>
              <input type="number" class="form-control" id="maxNights" placeholder="3">
              <small class="text-muted">ì´ ë°•ìˆ˜ê¹Œì§€ë§Œ 1ë°•ë‹¹ ì ìš©</small>
            </div>
            <div class="col-md-4 mb-2">
              <label class="form-label">ì •ì•¡ ê¸ˆì•¡ ($)</label>
              <input type="number" class="form-control" id="flatFeeAmount" step="0.01" placeholder="30.00">
              <small class="text-muted">ìµœëŒ€ë°•ìˆ˜ ì´ˆê³¼ì‹œ ê³ ì •</small>
            </div>
          </div>
          
          <div class="alert alert-secondary" style="font-size: 0.65rem; padding: 0.5rem;">
            <strong>ì˜ˆì‹œ:</strong><br>
            â€¢ 1ë°•ë‹¹ ë°©ì‹: $10/ë°• â†’ 3ë°• = $30, 4ë°• = $40<br>
            â€¢ ì •ì•¡ì œ: $10/ë°•, 3ë°•ê¹Œì§€, ì •ì•¡ $30 â†’ 3ë°• = $30, 4ë°• = $30 (ê³ ì •)
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-2">
              <label class="form-label">ì ìš© ì‹œì‘ì¼</label>
              <input type="date" class="form-control" id="effectiveDate">
            </div>
            <div class="col-md-6 mb-2">
              <label class="form-label">ì ìš© ì¢…ë£Œì¼</label>
              <input type="date" class="form-control" id="expiryDate">
            </div>
          </div>
          
          <div class="mb-2">
            <label class="form-label">ì„¤ëª…</label>
            <textarea class="form-control" id="description" rows="2"></textarea>
          </div>
          
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="isActive" checked>
            <label class="form-check-label">í™œì„±í™”</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" onclick="saveFee()">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentFees = [];
    let agencies = [];
    let hotels = [];
    
    document.addEventListener('DOMContentLoaded', () => { loadData(); });
    
    async function loadData() {
      // ê±°ë˜ì²˜ ë¡œë“œ
      const agRes = await fetch('/api/booking-agencies?is_active=true');
      agencies = await agRes.json();
      document.getElementById('filterAgency').innerHTML = '<option value="">ì „ì²´</option>' + agencies.map(a => '<option value="' + a.id + '">' + a.agency_name + '</option>').join('');
      document.getElementById('agencyId').innerHTML = '<option value="">ì„ íƒ</option>' + agencies.map(a => '<option value="' + a.id + '">' + a.agency_name + '</option>').join('');
      
      // í˜¸í…” ë¡œë“œ
      const htRes = await fetch('/api/hotels?is_active=true');
      hotels = await htRes.json();
      document.getElementById('filterHotel').innerHTML = '<option value="">ì „ì²´</option>' + hotels.map(h => '<option value="' + h.id + '">' + h.hotel_name + '</option>').join('');
      document.getElementById('hotelId').innerHTML = '<option value="">ì „ì²´ í˜¸í…” ì ìš©</option>' + hotels.map(h => '<option value="' + h.id + '">' + h.hotel_name + '</option>').join('');
      
      loadFees();
    }
    
    async function loadFees() {
      let url = '/api/agency-procurement-fees?';
      const agencyId = document.getElementById('filterAgency').value;
      const hotelId = document.getElementById('filterHotel').value;
      const isActive = document.getElementById('filterActive').value;
      
      if (agencyId) url += 'agency_id=' + agencyId + '&';
      if (hotelId) url += 'hotel_id=' + hotelId + '&';
      if (isActive) url += 'is_active=' + isActive;
      
      const res = await fetch(url);
      currentFees = await res.json();
      renderFees();
    }
    
    function renderFees() {
      const tbody = document.getElementById('feeList');
      if (currentFees.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center">ë“±ë¡ëœ ìˆ˜ë°°í”¼ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        return;
      }
      
      let html = '';
      currentFees.forEach(f => {
        const feeTypeText = f.fee_type === 'per_night' ? '1ë°•ë‹¹' : 'ì •ì•¡ì œ';
        const hotelText = f.hotel_name || '<span class="text-muted">ì „ì²´</span>';
        const period = (f.effective_date || '') + (f.expiry_date ? ' ~ ' + f.expiry_date : '');
        
        html += '<tr>';
        html += '<td><strong>' + f.agency_name + '</strong></td>';
        html += '<td>' + hotelText + '</td>';
        html += '<td>' + f.fee_name + '</td>';
        html += '<td><span class="badge bg-primary">' + feeTypeText + '</span></td>';
        html += '<td>' + (f.fee_per_night ? '$' + parseFloat(f.fee_per_night).toFixed(2) : '-') + '</td>';
        html += '<td>' + (f.max_nights_for_fee || '-') + '</td>';
        html += '<td>' + (f.flat_fee_amount ? '$' + parseFloat(f.flat_fee_amount).toFixed(2) : '-') + '</td>';
        html += '<td><small>' + (period || 'ì œí•œì—†ìŒ') + '</small></td>';
        html += '<td>' + (f.is_active ? '<span class="badge bg-success">í™œì„±</span>' : '<span class="badge bg-secondary">ë¹„í™œì„±</span>') + '</td>';
        html += '<td>';
        html += '<button class="btn btn-sm btn-outline-primary" onclick="editFee(' + f.id + ')"><i class="bi bi-pencil"></i></button> ';
        html += '<button class="btn btn-sm btn-outline-danger" onclick="deleteFee(' + f.id + ')"><i class="bi bi-trash"></i></button>';
        html += '</td></tr>';
      });
      
      tbody.innerHTML = html;
    }
    
    function openAddModal() {
      document.getElementById('modalTitle').textContent = 'ìˆ˜ë°°í”¼ ë“±ë¡';
      document.getElementById('feeId').value = '';
      document.getElementById('agencyId').value = '';
      document.getElementById('hotelId').value = '';
      document.getElementById('feeName').value = '';
      document.getElementById('feeType').value = 'per_night';
      document.getElementById('feePerNight').value = '';
      document.getElementById('feePerNightFlat').value = '';
      document.getElementById('maxNights').value = '';
      document.getElementById('flatFeeAmount').value = '';
      document.getElementById('effectiveDate').value = '';
      document.getElementById('expiryDate').value = '';
      document.getElementById('description').value = '';
      document.getElementById('isActive').checked = true;
      onFeeTypeChange();
      new bootstrap.Modal(document.getElementById('feeModal')).show();
    }
    
    function onFeeTypeChange() {
      const feeType = document.getElementById('feeType').value;
      if (feeType === 'per_night') {
        document.getElementById('perNightFields').style.display = 'block';
        document.getElementById('flatFields').style.display = 'none';
      } else {
        document.getElementById('perNightFields').style.display = 'none';
        document.getElementById('flatFields').style.display = 'block';
      }
    }
    
    async function editFee(id) {
      const res = await fetch('/api/agency-procurement-fees/' + id);
      const f = await res.json();
      
      document.getElementById('modalTitle').textContent = 'ìˆ˜ë°°í”¼ ìˆ˜ì •';
      document.getElementById('feeId').value = f.id;
      document.getElementById('agencyId').value = f.agency_id;
      document.getElementById('hotelId').value = f.hotel_id || '';
      document.getElementById('feeName').value = f.fee_name;
      document.getElementById('feeType').value = f.fee_type;
      
      if (f.fee_type === 'per_night') {
        document.getElementById('feePerNight').value = f.fee_per_night || '';
      } else {
        document.getElementById('feePerNightFlat').value = f.fee_per_night || '';
        document.getElementById('maxNights').value = f.max_nights_for_fee || '';
        document.getElementById('flatFeeAmount').value = f.flat_fee_amount || '';
      }
      
      document.getElementById('effectiveDate').value = f.effective_date || '';
      document.getElementById('expiryDate').value = f.expiry_date || '';
      document.getElementById('description').value = f.description || '';
      document.getElementById('isActive').checked = f.is_active;
      
      onFeeTypeChange();
      new bootstrap.Modal(document.getElementById('feeModal')).show();
    }
    
    async function saveFee() {
      const id = document.getElementById('feeId').value;
      const feeType = document.getElementById('feeType').value;
      
      let feePerNight, maxNights, flatFeeAmount;
      
      if (feeType === 'per_night') {
        feePerNight = parseFloat(document.getElementById('feePerNight').value);
        maxNights = null;
        flatFeeAmount = null;
      } else {
        feePerNight = parseFloat(document.getElementById('feePerNightFlat').value);
        maxNights = parseInt(document.getElementById('maxNights').value) || null;
        flatFeeAmount = parseFloat(document.getElementById('flatFeeAmount').value) || null;
      }
      
      const data = {
        agency_id: document.getElementById('agencyId').value,
        hotel_id: document.getElementById('hotelId').value || null,
        fee_name: document.getElementById('feeName').value,
        fee_type: feeType,
        fee_per_night: feePerNight,
        max_nights_for_fee: maxNights,
        flat_fee_amount: flatFeeAmount,
        effective_date: document.getElementById('effectiveDate').value || null,
        expiry_date: document.getElementById('expiryDate').value || null,
        description: document.getElementById('description').value || null,
        is_active: document.getElementById('isActive').checked
      };
      
      if (!data.agency_id || !data.fee_name) {
        alert('í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”'); return;
      }
      
      const res = await fetch(id ? '/api/agency-procurement-fees/' + id : '/api/agency-procurement-fees', {
        method: id ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      const result = await res.json();
      if (result.error) { alert('ì €ì¥ ì‹¤íŒ¨: ' + result.error); return; }
      
      alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
      bootstrap.Modal.getInstance(document.getElementById('feeModal')).hide();
      loadFees();
    }
    
    async function deleteFee(id) {
      if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      const res = await fetch('/api/agency-procurement-fees/' + id, { method: 'DELETE' });
      const result = await res.json();
      if (result.error) { alert('ì‚­ì œ ì‹¤íŒ¨: ' + result.error); return; }
      
      alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      loadFees();
    }
  </script>
</body>
</html>
