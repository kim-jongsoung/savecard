<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒ¨í‚¤ì§€ ì˜ˆì•½ ë“±ë¡ - ê´Œì„¸ì´ë¸Œì¹´ë“œ ê´€ë¦¬ì</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .section-divider {
            border-top: 1px solid #dee2e6;
            margin: 20px 0;
            padding-top: 20px;
        }
        .form-label {
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        .form-control, .form-select {
            font-size: 0.875rem;
            padding: 0.375rem 0.5rem;
        }
        h4 {
            font-size: 1.1rem;
            margin-bottom: 1rem !important;
        }
        h5 {
            font-size: 1rem;
            margin-bottom: 0.75rem !important;
        }
        .draft-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ffc107;
            color: #000;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }
        .draft-indicator.show {
            display: block;
        }
        .component-item {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: white;
        }
        .component-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .component-type-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        .badge-flight { background-color: #e3f2fd; color: #1976d2; }
        .badge-hotel { background-color: #f3e5f5; color: #7b1fa2; }
        .badge-tour { background-color: #e8f5e9; color: #388e3c; }
        .badge-other { background-color: #fff3e0; color: #f57c00; }
        .summary-box {
            background-color: #f8f9fa;
            border: 1px solid #0d6efd;
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.875rem;
        }
        .summary-total {
            font-size: 1rem;
            font-weight: bold;
            color: #0d6efd;
            border-top: 1px solid #dee2e6;
            padding-top: 8px;
            margin-top: 8px;
        }
        .guest-card {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }
        .guest-header {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar', { currentPage: 'package-inbox', adminUsername: adminUsername || 'ê´€ë¦¬ì' }) %>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="mb-0"><i class="fas fa-box-open me-2"></i>íŒ¨í‚¤ì§€ ì˜ˆì•½ ë“±ë¡</h3>
                    <div>
                        <button type="button" class="btn btn-sm btn-warning me-1" onclick="saveDraft()">
                            <i class="fas fa-save me-1"></i>ì„ì‹œì €ì¥
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-info me-1" onclick="loadDraft()">
                            <i class="fas fa-folder-open me-1"></i>ë¶ˆëŸ¬ì˜¤ê¸°
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger me-1" onclick="clearDraft()">
                            <i class="fas fa-trash me-1"></i>ì´ˆê¸°í™”
                        </button>
                        <a href="/admin/package-reservations" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-list me-1"></i>ëª©ë¡
                        </a>
                    </div>
                </div>

                <!-- í¼ -->
                <div class="card">
                    <div class="card-body">
                        <form id="packageForm">
                            <!-- ê¸°ë³¸ ì •ë³´ -->
                            <div>
                                <h4>ğŸ“‹ ê¸°ë³¸ ì˜ˆì•½ ì •ë³´</h4>
                                
                                <!-- í•œì¤„ ìš”ì•½ ì •ë³´ -->
                                <div class="row mb-2">
                                    <div class="col-md-2">
                                        <label class="form-label">ì˜ˆì•½ì±„ë„ *</label>
                                        <select class="form-select" id="platform_name" required>
                                            <option value="">ì„ íƒ</option>
                                            <option value="VASCO">VASCO</option>
                                            <option value="NOL">NOL</option>
                                            <option value="ë¡±í˜¼ìŠ¤í…Œì´í¬">ë¡±í˜¼</option>
                                            <option value="ì§ì ‘ì˜ˆì•½">ì§ì ‘</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">íŒ¨í‚¤ì§€ëª… *</label>
                                        <input type="text" class="form-control" id="package_name" 
                                               placeholder="3ë°•4ì¼ í—ˆë‹ˆë¬¸" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">ì¶œë°œì¼ *</label>
                                        <input type="date" class="form-control" id="departure_date" 
                                               onchange="calculateNights()" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">ê·€êµ­ì¼ *</label>
                                        <input type="date" class="form-control" id="return_date" 
                                               onchange="calculateNights()" required>
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label">ê¸°ê°„</label>
                                        <input type="text" class="form-control" id="period_display" 
                                               readonly placeholder="ìë™">
                                    </div>
                                </div>

                                <div class="row mb-2">
                                    <div class="col-md-1">
                                        <label class="form-label">ì¶œêµ­í¸ëª…</label>
                                        <input type="text" class="form-control" id="outbound_flight" 
                                               placeholder="OZ601">
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label">ì¶œë°œì‹œê°„</label>
                                        <input type="time" class="form-control" id="outbound_departure_time">
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label">ë„ì°©ì‹œê°„</label>
                                        <input type="time" class="form-control" id="outbound_arrival_time">
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label">ì…êµ­í¸ëª…</label>
                                        <input type="text" class="form-control" id="inbound_flight" 
                                               placeholder="OZ602">
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label">ì¶œë°œì‹œê°„</label>
                                        <input type="time" class="form-control" id="inbound_departure_time">
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label">ë„ì°©ì‹œê°„</label>
                                        <input type="time" class="form-control" id="inbound_arrival_time">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">ì´ìš©í˜¸í…”</label>
                                        <input type="text" class="form-control" id="hotel_name" 
                                               placeholder="í˜¸í…”ëª…">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">ë£¸íƒ€ì…ëª…</label>
                                        <input type="text" class="form-control" id="room_type" 
                                               placeholder="ë””ëŸ­ìŠ¤ ì˜¤ì…˜ë·°">
                                    </div>
                                </div>

                                <!-- ì¸ì› ì…ë ¥ -->
                                <h5 class="mt-3">ï¿½ ì¸ì› êµ¬ì„±</h5>
                                <div class="row mb-2">
                                    <div class="col-md-2">
                                        <label class="form-label">ì„±ì¸</label>
                                        <input type="number" class="form-control" id="people_adult" 
                                               value="0" min="0" onchange="generateGuestFields()">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">ì†Œì•„</label>
                                        <input type="number" class="form-control" id="people_child" 
                                               value="0" min="0" onchange="generateGuestFields()">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">ìœ ì•„</label>
                                        <input type="number" class="form-control" id="people_infant" 
                                               value="0" min="0" onchange="generateGuestFields()">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">ğŸ¤– AI ì¸ë°•ìŠ¤ (ì˜ˆì•½ ë°ì´í„° ë¶™ì—¬ë„£ê¸°)</label>
                                        <textarea class="form-control" id="ai_inbox" rows="3" 
                                                  placeholder="ì˜ˆì•½ ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. AIê°€ ìë™ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ í•„ë“œë¥¼ ì±„ì›ë‹ˆë‹¤."></textarea>
                                        <button type="button" class="btn btn-sm btn-primary mt-1" onclick="parseAIInbox()">
                                            <i class="fas fa-magic"></i> AI íŒŒì‹± ì‹œì‘
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info mb-2 py-1">
                                    <small>ğŸ’¡ ì¸ì›ìˆ˜ ì…ë ¥ í›„ ìë™ìœ¼ë¡œ ê³ ê°ì •ë³´ ì…ë ¥ í•„ë“œê°€ ìƒì„±ë©ë‹ˆë‹¤</small>
                                </div>

                                <!-- ë™ì  ê³ ê° ì •ë³´ í•„ë“œ -->
                                <div id="guests-container" class="mt-3"></div>

                                <!-- ì¼ì • ë° í¬í•¨/ë¶ˆí¬í•¨ ì‚¬í•­ -->
                                <h5 class="mt-3">ğŸ“… ì¼ì • ë° í¬í•¨/ë¶ˆí¬í•¨ ì‚¬í•­</h5>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <label class="form-label">ì¼ì •</label>
                                        <textarea class="form-control" id="itinerary" rows="4" 
                                                  placeholder="1ì¼ì°¨: ì¸ì²œê³µí•­ ì¶œë°œ â†’ ê´Œ ë„ì°©&#10;2ì¼ì°¨: ììœ ì¼ì •&#10;3ì¼ì°¨: ì‹œë‚´ê´€ê´‘&#10;4ì¼ì°¨: ê·€êµ­"></textarea>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">í¬í•¨ì‚¬í•­</label>
                                        <textarea class="form-control" id="inclusions" rows="2" 
                                                  placeholder="ì™•ë³µí•­ê³µê¶Œ, í˜¸í…”ìˆ™ë°•, ê³µí•­í”½ì—…, ì¡°ì‹ ë“±"></textarea>
                                        <label class="form-label mt-2">ë¶ˆí¬í•¨ì‚¬í•­</label>
                                        <textarea class="form-control" id="exclusions" rows="2" 
                                                  placeholder="ê°œì¸ê²½ë¹„, ì„ íƒê´€ê´‘, ì—¬í–‰ìë³´í—˜ ë“±"></textarea>
                                    </div>
                                </div>

                            </div>

                            <!-- ê¸ˆì•¡ ì •ë³´ -->
                            <div class="section-divider">
                                <h4>ğŸ’° ê¸ˆì•¡ ì •ë³´</h4>
                                
                                <!-- ì¸ì›ë³„ íŒë§¤ê°€ -->
                                <h5>ğŸ‘¥ ì¸ì›ë³„ íŒë§¤ê°€</h5>
                                <div class="row mb-2">
                                    <div class="col-md-2">
                                        <label class="form-label">í†µí™” *</label>
                                        <select class="form-select" id="currency" onchange="toggleExchangeRate()">
                                            <option value="KRW">KRW</option>
                                            <option value="USD">USD</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">í™˜ìœ¨</label>
                                        <input type="text" class="form-control" id="exchange_rate" 
                                               value="1,300" disabled oninput="formatCurrency(this)">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">ì„±ì¸ 1ì¸ ìš”ê¸ˆ *</label>
                                        <input type="text" class="form-control" id="price_adult" 
                                               placeholder="500,000" oninput="formatCurrency(this); calculateTotalPrice();" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">ì†Œì•„ 1ì¸ ìš”ê¸ˆ</label>
                                        <input type="text" class="form-control" id="price_child" 
                                               placeholder="400,000" oninput="formatCurrency(this); calculateTotalPrice();">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">ìœ ì•„ 1ì¸ ìš”ê¸ˆ</label>
                                        <input type="text" class="form-control" id="price_infant" 
                                               placeholder="100,000" oninput="formatCurrency(this); calculateTotalPrice();">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">ì´ íŒë§¤ê°€</label>
                                        <input type="text" class="form-control" id="total_selling_price" 
                                               readonly style="background-color: #e9ecef; font-weight: bold;">
                                    </div>
                                </div>

                                <!-- ê²°ì œ ë¹Œë§ -->
                                <h5 class="mt-3">ğŸ’³ ê²°ì œ ë¹Œë§</h5>
                                <div id="billing-container"></div>
                                <button type="button" class="btn btn-sm btn-outline-success mb-3" onclick="addBilling()">
                                    <i class="fas fa-plus me-1"></i>ê²°ì œ ì¶”ê°€
                                </button>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="alert alert-info mb-0">
                                            <strong>ê²°ì œ í˜„í™©:</strong> 
                                            <span id="payment_status_text">ë¯¸ê²°ì œ</span><br>
                                            <strong>ì´ íŒë§¤ê°€:</strong> <span id="billing_total_price">â‚©0</span><br>
                                            <strong>ê²°ì œ ì™„ë£Œ:</strong> <span id="billing_paid_amount">â‚©0</span><br>
                                            <strong>ë¯¸ê²°ì œ ê¸ˆì•¡:</strong> <span id="billing_remaining_amount" style="color: #dc3545; font-weight: bold;">â‚©0</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- ë§¤ì… êµ¬ì„±ìš”ì†Œ -->
                                <h5 class="mt-3">ğŸ“¦ ë§¤ì… êµ¬ì„±ìš”ì†Œ</h5>
                                <div id="components-container"></div>

                                <button type="button" class="btn btn-sm btn-outline-primary mb-3" onclick="addComponent()">
                                    <i class="fas fa-plus me-1"></i>êµ¬ì„±ìš”ì†Œ ì¶”ê°€
                                </button>

                                <!-- ìë™ ê³„ì‚° ìš”ì•½ -->
                                <div class="summary-box">
                                    <h5>ğŸ’µ ê¸ˆì•¡ ìš”ì•½</h5>
                                    <div class="summary-row">
                                        <span>ì´ íŒë§¤ê°€:</span>
                                        <span id="summary_revenue">â‚©0</span>
                                    </div>
                                    <div class="summary-row">
                                        <span>ì´ ë§¤ì…ê°€:</span>
                                        <span id="summary_cost">â‚©0</span>
                                    </div>
                                    <div class="summary-row summary-total">
                                        <span>ì˜ˆìƒ ë§ˆì§„:</span>
                                        <span id="summary_margin">â‚©0 (0%)</span>
                                    </div>
                                    <div class="summary-row">
                                        <span>ë¶€ê°€ì„¸ (ë§ˆì§„ì˜ 10%):</span>
                                        <span id="summary_vat">â‚©0</span>
                                    </div>
                                </div>

                                <div class="mb-2 mt-3">
                                    <label class="form-label">íŠ¹ë³„ ìš”ì²­ì‚¬í•­</label>
                                    <textarea class="form-control" id="special_requests" rows="2" 
                                              placeholder="íŠ¹ë³„ ìš”ì²­ì‚¬í•­ì´ ìˆìœ¼ë©´ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                                </div>

                                <div class="text-end mt-3">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-check me-2"></i>íŒ¨í‚¤ì§€ ì˜ˆì•½ ë“±ë¡
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let componentCount = 0;
        let guestData = [];

        // ë™ì  ê³ ê°ì •ë³´ í•„ë“œ ìƒì„±
        function generateGuestFields() {
            const adultCount = parseInt(document.getElementById('people_adult').value) || 0;
            const childCount = parseInt(document.getElementById('people_child').value) || 0;
            const infantCount = parseInt(document.getElementById('people_infant').value) || 0;
            const totalCount = adultCount + childCount + infantCount;
            
            const container = document.getElementById('guests-container');
            
            if (totalCount === 0) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<h5 class="mb-2">ğŸ‘¤ ê³ ê° ì •ë³´</h5>';
            let guestIndex = 0;
            
            // ì„±ì¸
            for (let i = 0; i < adultCount; i++) {
                guestIndex++;
                html += createGuestCard(guestIndex, 'ì„±ì¸', i + 1);
            }
            
            // ì†Œì•„
            for (let i = 0; i < childCount; i++) {
                guestIndex++;
                html += createGuestCard(guestIndex, 'ì†Œì•„', i + 1);
            }
            
            // ìœ ì•„
            for (let i = 0; i < infantCount; i++) {
                guestIndex++;
                html += createGuestCard(guestIndex, 'ìœ ì•„', i + 1);
            }
            
            container.innerHTML = html;
            
            // ì¸ì›ìˆ˜ ë³€ê²½ ì‹œ ì´ íŒë§¤ê°€ ìë™ ê³„ì‚°
            calculateTotalPrice();
        }
        
        function createGuestCard(index, type, typeIndex) {
            return `
                <div class="guest-card">
                    <div class="guest-header">${type} ${typeIndex}</div>
                    <div class="row">
                        <div class="col-md-2">
                            <label class="form-label">í•œê¸€ì´ë¦„ *</label>
                            <input type="text" class="form-control form-control-sm" 
                                   id="guest_${index}_korean_name" 
                                   data-guest-index="${index}"
                                   data-guest-type="${type}"
                                   placeholder="í™ê¸¸ë™" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ì˜ë¬¸ì´ë¦„ *</label>
                            <input type="text" class="form-control form-control-sm" 
                                   id="guest_${index}_english_name" 
                                   placeholder="HONG GILDONG" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ìƒë…„ì›”ì¼</label>
                            <input type="date" class="form-control form-control-sm" 
                                   id="guest_${index}_birth_date">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ì—°ë½ì²˜</label>
                            <input type="text" class="form-control form-control-sm" 
                                   id="guest_${index}_phone" 
                                   placeholder="010-1234-5678">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ì´ë©”ì¼</label>
                            <input type="email" class="form-control form-control-sm" 
                                   id="guest_${index}_email" 
                                   placeholder="hong@email.com">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">êµ¬ë¶„</label>
                            <input type="text" class="form-control form-control-sm" 
                                   value="${type}" readonly>
                        </div>
                    </div>
                </div>
            `;
        }

        // ë°•ìˆ˜ ìë™ ê³„ì‚°
        function calculateNights() {
            const departure = document.getElementById('departure_date').value;
            const returnDate = document.getElementById('return_date').value;
            
            if (departure && returnDate) {
                const d1 = new Date(departure);
                const d2 = new Date(returnDate);
                const diffTime = Math.abs(d2 - d1);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                document.getElementById('period_display').value = `${diffDays}ë°•${diffDays + 1}ì¼`;
            }
        }

        // ê¸ˆì•¡ í¬ë§·íŒ… (ì²œë‹¨ìœ„ ì‰¼í‘œ)
        function formatCurrency(input) {
            let value = input.value.replace(/,/g, '');
            if (value && !isNaN(value)) {
                input.value = Number(value).toLocaleString();
            }
        }
        
        // ê¸ˆì•¡ ê°’ ì¶”ì¶œ (ì‰¼í‘œ ì œê±°)
        function getNumericValue(elementId) {
            const value = document.getElementById(elementId).value.replace(/,/g, '');
            return parseFloat(value) || 0;
        }
        
        // ì¸ì›ë³„ ìš”ê¸ˆ ê³„ì‚° ë° ì´ íŒë§¤ê°€ ìë™ í•©ì‚°
        function calculateTotalPrice() {
            const adultCount = parseInt(document.getElementById('people_adult').value) || 0;
            const childCount = parseInt(document.getElementById('people_child').value) || 0;
            const infantCount = parseInt(document.getElementById('people_infant').value) || 0;
            
            const adultPrice = getNumericValue('price_adult');
            const childPrice = getNumericValue('price_child');
            const infantPrice = getNumericValue('price_infant');
            
            const totalPrice = (adultCount * adultPrice) + (childCount * childPrice) + (infantCount * infantPrice);
            
            document.getElementById('total_selling_price').value = totalPrice.toLocaleString();
            
            // ê²°ì œ í˜„í™© ì—…ë°ì´íŠ¸
            updateBillingStatus();
            calculateSummary();
        }
        
        // í™˜ìœ¨ í•„ë“œ í† ê¸€
        function toggleExchangeRate() {
            const currency = document.getElementById('currency').value;
            const exchangeRateInput = document.getElementById('exchange_rate');
            
            if (currency === 'USD') {
                exchangeRateInput.disabled = false;
            } else {
                exchangeRateInput.disabled = true;
                exchangeRateInput.value = '1';
            }
            
            calculateTotalPrice();
            calculateSummary();
        }
        
        // ê²°ì œ ë¹Œë§ ì¹´ìš´í„°
        let billingCount = 0;
        
        // ê²°ì œ ë¹Œë§ ì¶”ê°€
        function addBilling() {
            billingCount++;
            const container = document.getElementById('billing-container');
            
            const billingHTML = `
                <div class="component-item" id="billing-${billingCount}" style="background-color: #f8f9fa;">
                    <div class="component-header">
                        <div>
                            <select class="form-select form-select-sm d-inline-block w-auto" 
                                    id="billing-type-${billingCount}" onchange="updateBillingStatus()">
                                <option value="cash">ğŸ’µ í˜„ê¸ˆê²°ì œ</option>
                                <option value="card">ğŸ’³ ì¹´ë“œê²°ì œ</option>
                                <option value="discount">ğŸ í• ì¸</option>
                            </select>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeBilling(${billingCount})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-md-2">
                            <label class="form-label">ìš”ì²­ê¸ˆì•¡ *</label>
                            <input type="text" class="form-control form-control-sm" 
                                   id="billing-amount-${billingCount}" placeholder="500,000" 
                                   oninput="formatCurrency(this); calculateActualAmount(${billingCount}); updateBillingStatus();" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ì…ê¸ˆì™„ë£Œì¼</label>
                            <input type="date" class="form-control form-control-sm" 
                                   id="billing-date-${billingCount}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">PGìˆ˜ìˆ˜ë£Œ</label>
                            <input type="text" class="form-control form-control-sm" 
                                   id="billing-fee-${billingCount}" placeholder="5,000" 
                                   oninput="formatCurrency(this); calculateActualAmount(${billingCount}); updateBillingStatus();">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ì‹¤ì œì…ê¸ˆê¸ˆì•¡</label>
                            <input type="text" class="form-control form-control-sm" 
                                   id="billing-actual-${billingCount}" placeholder="495,000" 
                                   readonly style="background-color: #e9ecef;">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ê²°ì œìƒíƒœ *</label>
                            <select class="form-select form-select-sm" id="billing-status-${billingCount}" 
                                    onchange="updateBillingStatus()" required>
                                <option value="pending">ê²°ì œì „</option>
                                <option value="completed">ê²°ì œì™„ë£Œ</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ë¹„ê³ </label>
                            <input type="text" class="form-control form-control-sm" 
                                   id="billing-notes-${billingCount}" placeholder="ë¹„ê³ ">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', billingHTML);
            updateBillingStatus();
        }
        
        // ì‹¤ì œì…ê¸ˆê¸ˆì•¡ ìë™ ê³„ì‚° (ìš”ì²­ê¸ˆì•¡ - PGìˆ˜ìˆ˜ë£Œ)
        function calculateActualAmount(billingId) {
            const amount = getNumericValue(`billing-amount-${billingId}`);
            const fee = getNumericValue(`billing-fee-${billingId}`);
            const actualAmount = amount - fee;
            
            document.getElementById(`billing-actual-${billingId}`).value = actualAmount.toLocaleString();
        }
        
        // ê²°ì œ ë¹Œë§ ì‚­ì œ
        function removeBilling(id) {
            document.getElementById(`billing-${id}`).remove();
            updateBillingStatus();
        }
        
        // ê²°ì œ í˜„í™© ì—…ë°ì´íŠ¸
        function updateBillingStatus() {
            const totalPrice = getNumericValue('total_selling_price');
            let paidAmount = 0;
            
            document.querySelectorAll('[id^="billing-"]').forEach(element => {
                if (element.id.includes('billing-amount-')) {
                    const id = element.id.split('-')[2];
                    const status = document.getElementById(`billing-status-${id}`)?.value;
                    const type = document.getElementById(`billing-type-${id}`)?.value;
                    
                    if (status === 'completed') {
                        const amount = getNumericValue(`billing-amount-${id}`);
                        if (type === 'discount') {
                            // í• ì¸ì€ ì°¨ê°
                            paidAmount -= amount;
                        } else {
                            paidAmount += amount;
                        }
                    }
                }
            });
            
            const remainingAmount = totalPrice - paidAmount;
            
            document.getElementById('billing_total_price').textContent = `â‚©${totalPrice.toLocaleString()}`;
            document.getElementById('billing_paid_amount').textContent = `â‚©${paidAmount.toLocaleString()}`;
            document.getElementById('billing_remaining_amount').textContent = `â‚©${remainingAmount.toLocaleString()}`;
            
            // ê²°ì œ ìƒíƒœ í…ìŠ¤íŠ¸
            let statusText = 'ë¯¸ê²°ì œ';
            let statusColor = '#dc3545';
            
            if (remainingAmount <= 0) {
                statusText = 'ê²°ì œì™„ë£Œ';
                statusColor = '#198754';
            } else if (paidAmount > 0) {
                statusText = 'ë¶€ë¶„ê²°ì œ';
                statusColor = '#ffc107';
            }
            
            const statusElement = document.getElementById('payment_status_text');
            statusElement.textContent = statusText;
            statusElement.style.color = statusColor;
            statusElement.style.fontWeight = 'bold';
        }

        // êµ¬ì„±ìš”ì†Œ ì¶”ê°€
        function addComponent() {
            componentCount++;
            const container = document.getElementById('components-container');
            
            const componentHTML = `
                <div class="component-item" id="component-${componentCount}">
                    <div class="component-header">
                        <div>
                            <select class="form-select form-select-sm d-inline-block w-auto component-type" 
                                    id="type-${componentCount}" onchange="updateComponentBadge(${componentCount})">
                                <option value="flight">âœˆï¸ í•­ê³µê¶Œ</option>
                                <option value="hotel">ğŸ¨ í˜¸í…”</option>
                                <option value="tour">ğŸ¯ íˆ¬ì–´</option>
                                <option value="ground">ğŸš— ì§€ìƒë¹„</option>
                                <option value="other">ğŸ“¦ ê¸°íƒ€</option>
                            </select>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeComponent(${componentCount})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">ê³µê¸‰ì—…ì²´ëª… *</label>
                            <input type="text" class="form-control form-control-sm" 
                                   id="vendor-${componentCount}" placeholder="ì˜ˆ: ì•„ì‹œì•„ë‚˜í•­ê³µ" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ë§¤ì…ê°€ *</label>
                            <input type="text" class="form-control form-control-sm" 
                                   id="cost-${componentCount}" placeholder="850,000" 
                                   onchange="calculateSummary()" oninput="formatCurrency(this)" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">í†µí™”</label>
                            <select class="form-select form-select-sm" id="cost-currency-${componentCount}" 
                                    onchange="calculateSummary()">
                                <option value="KRW">KRW</option>
                                <option value="USD">USD</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ì›í™” í™˜ì‚°</label>
                            <input type="text" class="form-control form-control-sm" 
                                   id="cost-krw-${componentCount}" readonly>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ë¹„ê³ </label>
                            <input type="text" class="form-control form-control-sm" 
                                   id="notes-${componentCount}" placeholder="OZ601/OZ602 ì™•ë³µ">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', componentHTML);
        }

        // êµ¬ì„±ìš”ì†Œ íƒ€ì… ë³€ê²½ ì‹œ (í˜„ì¬ëŠ” ì•„ë¬´ ë™ì‘ ì•ˆí•¨, í•„ìš”ì‹œ í™•ì¥ ê°€ëŠ¥)
        function updateComponentBadge(id) {
            // íƒ€ì… ë³€ê²½ ì‹œ ì¶”ê°€ ë¡œì§ì´ í•„ìš”í•˜ë©´ ì—¬ê¸°ì— êµ¬í˜„
            // í˜„ì¬ëŠ” select ê°’ë§Œ ë³€ê²½ë˜ë©´ ë¨
        }

        // êµ¬ì„±ìš”ì†Œ ì‚­ì œ
        function removeComponent(id) {
            document.getElementById(`component-${id}`).remove();
            calculateSummary();
        }

        // AI ì¸ë°•ìŠ¤ íŒŒì‹±
        async function parseAIInbox() {
            const aiInboxText = document.getElementById('ai_inbox').value.trim();
            
            if (!aiInboxText) {
                alert('âš ï¸ AI ì¸ë°•ìŠ¤ì— ì˜ˆì•½ ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ë¡œë”© í‘œì‹œ
            const parseButton = event.target;
            const originalText = parseButton.innerHTML;
            parseButton.disabled = true;
            parseButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AI ë¶„ì„ ì¤‘...';
            
            try {
                const response = await fetch('/api/parse-package-reservation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: aiInboxText })
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    const data = result.data;
                    
                    // ê¸°ë³¸ ì •ë³´
                    if (data.platform_name) document.getElementById('platform_name').value = data.platform_name;
                    if (data.package_name) document.getElementById('package_name').value = data.package_name;
                    
                    // ê³ ê° ì •ë³´
                    if (data.customer) {
                        if (data.customer.korean_name) document.getElementById('customer_korean_name').value = data.customer.korean_name;
                        if (data.customer.english_name) document.getElementById('customer_english_name').value = data.customer.english_name;
                        if (data.customer.phone) document.getElementById('customer_phone').value = data.customer.phone;
                        if (data.customer.email) document.getElementById('customer_email').value = data.customer.email;
                    }
                    
                    // ì—¬í–‰ ê¸°ê°„
                    if (data.travel_period) {
                        if (data.travel_period.departure_date) document.getElementById('departure_date').value = data.travel_period.departure_date;
                        if (data.travel_period.return_date) document.getElementById('return_date').value = data.travel_period.return_date;
                        calculateNights();
                    }
                    
                    // ì¸ì› êµ¬ì„±
                    if (data.people) {
                        if (data.people.adult !== undefined) document.getElementById('people_adult').value = data.people.adult;
                        if (data.people.child !== undefined) document.getElementById('people_child').value = data.people.child;
                        if (data.people.infant !== undefined) document.getElementById('people_infant').value = data.people.infant;
                        generateGuestFields();
                    }
                    
                    // í•­ê³µí¸ ì •ë³´
                    if (data.flight_info) {
                        if (data.flight_info.outbound_flight) document.getElementById('outbound_flight').value = data.flight_info.outbound_flight;
                        if (data.flight_info.outbound_departure_time) document.getElementById('outbound_departure_time').value = data.flight_info.outbound_departure_time;
                        if (data.flight_info.outbound_arrival_time) document.getElementById('outbound_arrival_time').value = data.flight_info.outbound_arrival_time;
                        if (data.flight_info.inbound_flight) document.getElementById('inbound_flight').value = data.flight_info.inbound_flight;
                        if (data.flight_info.inbound_departure_time) document.getElementById('inbound_departure_time').value = data.flight_info.inbound_departure_time;
                        if (data.flight_info.inbound_arrival_time) document.getElementById('inbound_arrival_time').value = data.flight_info.inbound_arrival_time;
                    }
                    
                    // í˜¸í…” ì •ë³´
                    if (data.hotel_name) document.getElementById('hotel_name').value = data.hotel_name;
                    if (data.room_type) document.getElementById('room_type').value = data.room_type;
                    
                    // ì¼ì • ë° í¬í•¨/ë¶ˆí¬í•¨
                    if (data.itinerary) document.getElementById('itinerary').value = data.itinerary;
                    if (data.inclusions) document.getElementById('inclusions').value = data.inclusions;
                    if (data.exclusions) document.getElementById('exclusions').value = data.exclusions;
                    
                    // ê¸ˆì•¡ ì •ë³´
                    if (data.pricing) {
                        if (data.pricing.currency) document.getElementById('currency').value = data.pricing.currency;
                        if (data.pricing.exchange_rate) {
                            document.getElementById('exchange_rate').value = data.pricing.exchange_rate.toLocaleString();
                        }
                        if (data.pricing.price_adult) {
                            document.getElementById('price_adult').value = data.pricing.price_adult.toLocaleString();
                        }
                        if (data.pricing.price_child) {
                            document.getElementById('price_child').value = data.pricing.price_child.toLocaleString();
                        }
                        if (data.pricing.price_infant) {
                            document.getElementById('price_infant').value = data.pricing.price_infant.toLocaleString();
                        }
                        toggleExchangeRate();
                        calculateTotalPrice();
                    }
                    
                    // íˆ¬ìˆ™ê° ì •ë³´ (ìˆëŠ” ê²½ìš°)
                    if (data.guests && data.guests.length > 0) {
                        setTimeout(() => {
                            data.guests.forEach((guest, index) => {
                                if (document.getElementById(`guest_${index + 1}_korean_name`)) {
                                    if (guest.korean_name) document.getElementById(`guest_${index + 1}_korean_name`).value = guest.korean_name;
                                    if (guest.english_name) document.getElementById(`guest_${index + 1}_english_name`).value = guest.english_name;
                                    if (guest.birth_date) document.getElementById(`guest_${index + 1}_birth_date`).value = guest.birth_date;
                                    if (guest.phone) document.getElementById(`guest_${index + 1}_phone`).value = guest.phone;
                                    if (guest.email) document.getElementById(`guest_${index + 1}_email`).value = guest.email;
                                }
                            });
                        }, 300);
                    }
                    
                    // íŠ¹ë³„ ìš”ì²­ì‚¬í•­
                    if (data.special_requests) document.getElementById('special_requests').value = data.special_requests;
                    
                    alert('âœ… AI íŒŒì‹±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\níŒŒì‹±ëœ ì •ë³´ë¥¼ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ìˆ˜ì •í•´ì£¼ì„¸ìš”.');
                    
                } else {
                    alert('âŒ AI íŒŒì‹± ì‹¤íŒ¨: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
                
            } catch (error) {
                console.error('AI íŒŒì‹± ì˜¤ë¥˜:', error);
                alert('âŒ AI íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' + error.message);
            } finally {
                parseButton.disabled = false;
                parseButton.innerHTML = originalText;
            }
        }

        // ê¸ˆì•¡ ìš”ì•½ ê³„ì‚°
        function calculateSummary() {
            const sellingPrice = getNumericValue('total_selling_price');
            const currency = document.getElementById('currency').value;
            const exchangeRate = getNumericValue('exchange_rate') || 1;
            
            // ì´ íŒë§¤ê°€ (ì›í™” í™˜ì‚°)
            const revenueKRW = currency === 'KRW' ? sellingPrice : sellingPrice * exchangeRate;
            
            // ì´ ë§¤ì…ê°€ ê³„ì‚°
            let totalCostKRW = 0;
            const components = document.querySelectorAll('.component-item');
            
            components.forEach(component => {
                const id = component.id.split('-')[1];
                const cost = getNumericValue(`cost-${id}`);
                const costCurrency = document.getElementById(`cost-currency-${id}`).value;
                
                const costKRW = costCurrency === 'KRW' ? cost : cost * exchangeRate;
                totalCostKRW += costKRW;
                
                // ê°œë³„ êµ¬ì„±ìš”ì†Œ ì›í™” í™˜ì‚° í‘œì‹œ
                const costKrwEl = document.getElementById(`cost-krw-${id}`);
                if (costKrwEl) {
                    costKrwEl.value = `â‚©${Math.round(costKRW).toLocaleString()}`;
                }
            });
            
            // ë§ˆì§„ ê³„ì‚°
            const marginKRW = revenueKRW - totalCostKRW;
            const marginRate = revenueKRW > 0 ? (marginKRW / revenueKRW * 100).toFixed(1) : 0;
            
            // ë¶€ê°€ì„¸ (ë§ˆì§„ì˜ 10%)
            const vatAmount = Math.round(marginKRW * 0.1);
            
            // ìš”ì•½ í‘œì‹œ
            document.getElementById('summary_revenue').textContent = 
                `â‚©${Math.round(revenueKRW).toLocaleString()}`;
            document.getElementById('summary_cost').textContent = 
                `â‚©${Math.round(totalCostKRW).toLocaleString()}`;
            document.getElementById('summary_margin').textContent = 
                `â‚©${Math.round(marginKRW).toLocaleString()} (${marginRate}%)`;
            document.getElementById('summary_margin').style.color = marginKRW >= 0 ? '#198754' : '#dc3545';
            document.getElementById('summary_vat').textContent = 
                `â‚©${vatAmount.toLocaleString()}`;
        }

        // ì„ì‹œì €ì¥
        function saveDraft() {
            const draft = {
                platform_name: document.getElementById('platform_name').value,
                package_name: document.getElementById('package_name').value,
                departure_date: document.getElementById('departure_date').value,
                return_date: document.getElementById('return_date').value,
                hotel_name: document.getElementById('hotel_name').value,
                room_type: document.getElementById('room_type').value,
                outbound_flight: document.getElementById('outbound_flight').value,
                outbound_departure_time: document.getElementById('outbound_departure_time').value,
                outbound_arrival_time: document.getElementById('outbound_arrival_time').value,
                inbound_flight: document.getElementById('inbound_flight').value,
                inbound_departure_time: document.getElementById('inbound_departure_time').value,
                inbound_arrival_time: document.getElementById('inbound_arrival_time').value,
                people_adult: document.getElementById('people_adult').value,
                people_child: document.getElementById('people_child').value,
                people_infant: document.getElementById('people_infant').value,
                itinerary: document.getElementById('itinerary').value,
                inclusions: document.getElementById('inclusions').value,
                exclusions: document.getElementById('exclusions').value,
                price_adult: document.getElementById('price_adult').value,
                price_child: document.getElementById('price_child').value,
                price_infant: document.getElementById('price_infant').value,
                total_selling_price: document.getElementById('total_selling_price').value,
                currency: document.getElementById('currency').value,
                exchange_rate: document.getElementById('exchange_rate').value,
                special_requests: document.getElementById('special_requests').value,
                components: [],
                guests: [],
                billings: [],
                componentCount: componentCount,
                billingCount: billingCount
            };
            
            // êµ¬ì„±ìš”ì†Œ ì €ì¥
            document.querySelectorAll('.component-item').forEach(component => {
                const id = component.id.split('-')[1];
                const costEl = document.getElementById(`cost-${id}`);
                if (costEl) {
                    draft.components.push({
                        id: id,
                        type: document.getElementById(`type-${id}`).value,
                        vendor: document.getElementById(`vendor-${id}`).value,
                        cost: costEl.value,
                        cost_currency: document.getElementById(`cost-currency-${id}`).value,
                        notes: document.getElementById(`notes-${id}`).value
                    });
                }
            });
            
            // ê³ ê°ì •ë³´ ì €ì¥
            document.querySelectorAll('.guest-card').forEach((card, index) => {
                const guestIndex = index + 1;
                const koreanNameEl = document.getElementById(`guest_${guestIndex}_korean_name`);
                if (koreanNameEl) {
                    draft.guests.push({
                        korean_name: koreanNameEl.value,
                        english_name: document.getElementById(`guest_${guestIndex}_english_name`).value,
                        birth_date: document.getElementById(`guest_${guestIndex}_birth_date`).value,
                        phone: document.getElementById(`guest_${guestIndex}_phone`).value,
                        email: document.getElementById(`guest_${guestIndex}_email`).value,
                        type: koreanNameEl.dataset.guestType
                    });
                }
            });
            
            // ê²°ì œ ë¹Œë§ ì €ì¥
            document.querySelectorAll('[id^="billing-"]').forEach(element => {
                if (element.id.includes('billing-type-')) {
                    const id = element.id.split('-')[2];
                    const amountEl = document.getElementById(`billing-amount-${id}`);
                    if (amountEl) {
                        draft.billings.push({
                            id: id,
                            type: element.value,
                            amount: amountEl.value,
                            date: document.getElementById(`billing-date-${id}`).value,
                            fee: document.getElementById(`billing-fee-${id}`).value,
                            actual: document.getElementById(`billing-actual-${id}`).value,
                            status: document.getElementById(`billing-status-${id}`).value,
                            notes: document.getElementById(`billing-notes-${id}`).value
                        });
                    }
                }
            });
            
            localStorage.setItem('packageDraft', JSON.stringify(draft));
            alert('âœ… ì„ì‹œì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        // ë¶ˆëŸ¬ì˜¤ê¸°
        function loadDraft() {
            const draftStr = localStorage.getItem('packageDraft');
            if (!draftStr) {
                alert('ì €ì¥ëœ ì„ì‹œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!confirm('ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ì…ë ¥ëœ ë‚´ìš©ì€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.')) {
                return;
            }
            
            const draft = JSON.parse(draftStr);
            
            // ê¸°ë³¸ ì •ë³´ ë³µì›
            document.getElementById('platform_name').value = draft.platform_name || '';
            document.getElementById('package_name').value = draft.package_name || '';
            document.getElementById('departure_date').value = draft.departure_date || '';
            document.getElementById('return_date').value = draft.return_date || '';
            document.getElementById('hotel_name').value = draft.hotel_name || '';
            document.getElementById('room_type').value = draft.room_type || '';
            document.getElementById('outbound_flight').value = draft.outbound_flight || '';
            document.getElementById('outbound_departure_time').value = draft.outbound_departure_time || '';
            document.getElementById('outbound_arrival_time').value = draft.outbound_arrival_time || '';
            document.getElementById('inbound_flight').value = draft.inbound_flight || '';
            document.getElementById('inbound_departure_time').value = draft.inbound_departure_time || '';
            document.getElementById('inbound_arrival_time').value = draft.inbound_arrival_time || '';
            document.getElementById('people_adult').value = draft.people_adult || 0;
            document.getElementById('people_child').value = draft.people_child || 0;
            document.getElementById('people_infant').value = draft.people_infant || 0;
            document.getElementById('itinerary').value = draft.itinerary || '';
            document.getElementById('inclusions').value = draft.inclusions || '';
            document.getElementById('exclusions').value = draft.exclusions || '';
            document.getElementById('price_adult').value = draft.price_adult || '';
            document.getElementById('price_child').value = draft.price_child || '';
            document.getElementById('price_infant').value = draft.price_infant || '';
            document.getElementById('total_selling_price').value = draft.total_selling_price || '';
            document.getElementById('currency').value = draft.currency || 'KRW';
            document.getElementById('exchange_rate').value = draft.exchange_rate || '1,300';
            document.getElementById('special_requests').value = draft.special_requests || '';
            
            calculateNights();
            toggleExchangeRate();
            generateGuestFields();
            
            // ê³ ê°ì •ë³´ ë³µì›
            if (draft.guests && draft.guests.length > 0) {
                setTimeout(() => {
                    draft.guests.forEach((guest, index) => {
                        const guestIndex = index + 1;
                        const koreanNameEl = document.getElementById(`guest_${guestIndex}_korean_name`);
                        if (koreanNameEl) {
                            koreanNameEl.value = guest.korean_name || '';
                            document.getElementById(`guest_${guestIndex}_english_name`).value = guest.english_name || '';
                            document.getElementById(`guest_${guestIndex}_birth_date`).value = guest.birth_date || '';
                            document.getElementById(`guest_${guestIndex}_phone`).value = guest.phone || '';
                            document.getElementById(`guest_${guestIndex}_email`).value = guest.email || '';
                        }
                    });
                }, 100);
            }
            
            // ê²°ì œ ë¹Œë§ ë³µì›
            if (draft.billingCount) {
                billingCount = draft.billingCount;
            }
            
            if (draft.billings && draft.billings.length > 0) {
                draft.billings.forEach(billing => {
                    billingCount = Math.max(billingCount, parseInt(billing.id));
                    const container = document.getElementById('billing-container');
                    const billingHTML = `
                        <div class="component-item" id="billing-${billing.id}" style="background-color: #f8f9fa;">
                            <div class="component-header">
                                <div>
                                    <select class="form-select form-select-sm d-inline-block w-auto" 
                                            id="billing-type-${billing.id}" onchange="updateBillingStatus()">
                                        <option value="cash" ${billing.type === 'cash' ? 'selected' : ''}>ğŸ’µ í˜„ê¸ˆê²°ì œ</option>
                                        <option value="card" ${billing.type === 'card' ? 'selected' : ''}>ğŸ’³ ì¹´ë“œê²°ì œ</option>
                                        <option value="discount" ${billing.type === 'discount' ? 'selected' : ''}>ğŸ í• ì¸</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeBilling(${billing.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="row">
                                <div class="col-md-2">
                                    <label class="form-label">ìš”ì²­ê¸ˆì•¡ *</label>
                                    <input type="text" class="form-control form-control-sm" 
                                           id="billing-amount-${billing.id}" value="${billing.amount || ''}" placeholder="500,000" 
                                           oninput="formatCurrency(this); calculateActualAmount(${billing.id}); updateBillingStatus();" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">ì…ê¸ˆì™„ë£Œì¼</label>
                                    <input type="date" class="form-control form-control-sm" 
                                           id="billing-date-${billing.id}" value="${billing.date || ''}">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">PGìˆ˜ìˆ˜ë£Œ</label>
                                    <input type="text" class="form-control form-control-sm" 
                                           id="billing-fee-${billing.id}" value="${billing.fee || ''}" placeholder="5,000" 
                                           oninput="formatCurrency(this); calculateActualAmount(${billing.id}); updateBillingStatus();">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">ì‹¤ì œì…ê¸ˆê¸ˆì•¡</label>
                                    <input type="text" class="form-control form-control-sm" 
                                           id="billing-actual-${billing.id}" value="${billing.actual || ''}" placeholder="495,000" 
                                           readonly style="background-color: #e9ecef;">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">ê²°ì œìƒíƒœ *</label>
                                    <select class="form-select form-select-sm" id="billing-status-${billing.id}" 
                                            onchange="updateBillingStatus()" required>
                                        <option value="pending" ${billing.status === 'pending' ? 'selected' : ''}>ê²°ì œì „</option>
                                        <option value="completed" ${billing.status === 'completed' ? 'selected' : ''}>ê²°ì œì™„ë£Œ</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">ë¹„ê³ </label>
                                    <input type="text" class="form-control form-control-sm" 
                                           id="billing-notes-${billing.id}" value="${billing.notes || ''}" placeholder="ë¹„ê³ ">
                                </div>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', billingHTML);
                });
                updateBillingStatus();
            }
            
            // êµ¬ì„±ìš”ì†Œ ë³µì›
            if (draft.componentCount) {
                componentCount = draft.componentCount;
            }
            
            if (draft.components && draft.components.length > 0) {
                const container = document.getElementById('components-container');
                draft.components.forEach(comp => {
                    componentCount = Math.max(componentCount, parseInt(comp.id));
                    const componentHTML = `
                        <div class="component-item" id="component-${comp.id}">
                            <div class="component-header">
                                <div>
                                    <select class="form-select form-select-sm d-inline-block w-auto component-type" 
                                            id="type-${comp.id}" onchange="updateComponentBadge(${comp.id})">
                                        <option value="flight" ${comp.type === 'flight' ? 'selected' : ''}>âœˆï¸ í•­ê³µê¶Œ</option>
                                        <option value="hotel" ${comp.type === 'hotel' ? 'selected' : ''}>ğŸ¨ í˜¸í…”</option>
                                        <option value="tour" ${comp.type === 'tour' ? 'selected' : ''}>ğŸ¯ íˆ¬ì–´</option>
                                        <option value="ground" ${comp.type === 'ground' ? 'selected' : ''}>ğŸš— ì§€ìƒë¹„</option>
                                        <option value="other" ${comp.type === 'other' ? 'selected' : ''}>ğŸ“¦ ê¸°íƒ€</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeComponent(${comp.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="row">
                                <div class="col-md-3">
                                    <label class="form-label">ê³µê¸‰ì—…ì²´ëª… *</label>
                                    <input type="text" class="form-control form-control-sm" 
                                           id="vendor-${comp.id}" value="${comp.vendor || ''}" placeholder="ì˜ˆ: ì•„ì‹œì•„ë‚˜í•­ê³µ" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">ë§¤ì…ê°€ *</label>
                                    <input type="text" class="form-control form-control-sm" 
                                           id="cost-${comp.id}" value="${comp.cost || ''}" placeholder="850,000" 
                                           onchange="calculateSummary()" oninput="formatCurrency(this)" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">í†µí™”</label>
                                    <select class="form-select form-select-sm" id="cost-currency-${comp.id}" 
                                            onchange="calculateSummary()">
                                        <option value="KRW" ${comp.cost_currency === 'KRW' ? 'selected' : ''}>KRW</option>
                                        <option value="USD" ${comp.cost_currency === 'USD' ? 'selected' : ''}>USD</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">ì›í™” í™˜ì‚°</label>
                                    <input type="text" class="form-control form-control-sm" 
                                           id="cost-krw-${comp.id}" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ë¹„ê³ </label>
                                    <input type="text" class="form-control form-control-sm" 
                                           id="notes-${comp.id}" value="${comp.notes || ''}" placeholder="OZ601/OZ602 ì™•ë³µ">
                                </div>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', componentHTML);
                });
            }
            
            calculateSummary();
            alert('âœ… ì„ì‹œì €ì¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
        }
        
        // ì´ˆê¸°í™”
        function clearDraft() {
            if (!confirm('ì„ì‹œì €ì¥ëœ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            localStorage.removeItem('packageDraft');
            alert('âœ… ì„ì‹œì €ì¥ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // í¼ ì œì¶œ
        document.getElementById('packageForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // ê³ ê°ì •ë³´ ìˆ˜ì§‘
            const guests = [];
            document.querySelectorAll('.guest-card').forEach((card, index) => {
                const guestIndex = index + 1;
                const koreanNameEl = document.getElementById(`guest_${guestIndex}_korean_name`);
                if (koreanNameEl) {
                    guests.push({
                        korean_name: koreanNameEl.value,
                        english_name: document.getElementById(`guest_${guestIndex}_english_name`).value,
                        birth_date: document.getElementById(`guest_${guestIndex}_birth_date`).value,
                        phone: document.getElementById(`guest_${guestIndex}_phone`).value,
                        email: document.getElementById(`guest_${guestIndex}_email`).value,
                        type: koreanNameEl.dataset.guestType
                    });
                }
            });
            
            // êµ¬ì„±ìš”ì†Œ ìˆ˜ì§‘
            const components = [];
            document.querySelectorAll('.component-item[id^="component-"]').forEach(component => {
                const id = component.id.split('-')[1];
                components.push({
                    component_type: document.getElementById(`type-${id}`).value,
                    vendor_name: document.getElementById(`vendor-${id}`).value,
                    cost_amount: getNumericValue(`cost-${id}`),
                    cost_currency: document.getElementById(`cost-currency-${id}`).value,
                    notes: document.getElementById(`notes-${id}`).value
                });
            });
            
            if (components.length === 0) {
                alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ êµ¬ì„±ìš”ì†Œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ê²°ì œ ë¹Œë§ ìˆ˜ì§‘
            const billings = [];
            document.querySelectorAll('[id^="billing-type-"]').forEach(element => {
                const id = element.id.split('-')[2];
                const amountEl = document.getElementById(`billing-amount-${id}`);
                if (amountEl) {
                    billings.push({
                        type: element.value,
                        amount: getNumericValue(`billing-amount-${id}`),
                        date: document.getElementById(`billing-date-${id}`).value,
                        fee: getNumericValue(`billing-fee-${id}`),
                        actual_amount: getNumericValue(`billing-actual-${id}`),
                        status: document.getElementById(`billing-status-${id}`).value,
                        notes: document.getElementById(`billing-notes-${id}`).value
                    });
                }
            });
            
            const data = {
                platform_name: document.getElementById('platform_name').value,
                package_name: document.getElementById('package_name').value,
                customer: guests.length > 0 ? {
                    korean_name: guests[0].korean_name,
                    english_name: guests[0].english_name,
                    phone: guests[0].phone,
                    email: guests[0].email
                } : {
                    korean_name: '',
                    english_name: '',
                    phone: '',
                    email: ''
                },
                guests: guests,
                travel_period: {
                    departure_date: document.getElementById('departure_date').value,
                    return_date: document.getElementById('return_date').value
                },
                people: {
                    adult: parseInt(document.getElementById('people_adult').value) || 0,
                    child: parseInt(document.getElementById('people_child').value) || 0,
                    infant: parseInt(document.getElementById('people_infant').value) || 0
                },
                flight_info: {
                    outbound_flight: document.getElementById('outbound_flight').value,
                    outbound_departure_time: document.getElementById('outbound_departure_time').value,
                    outbound_arrival_time: document.getElementById('outbound_arrival_time').value,
                    inbound_flight: document.getElementById('inbound_flight').value,
                    inbound_departure_time: document.getElementById('inbound_departure_time').value,
                    inbound_arrival_time: document.getElementById('inbound_arrival_time').value
                },
                hotel_name: document.getElementById('hotel_name').value,
                room_type: document.getElementById('room_type').value,
                itinerary: document.getElementById('itinerary').value,
                inclusions: document.getElementById('inclusions').value,
                exclusions: document.getElementById('exclusions').value,
                pricing: {
                    price_adult: getNumericValue('price_adult'),
                    price_child: getNumericValue('price_child'),
                    price_infant: getNumericValue('price_infant'),
                    total_selling_price: getNumericValue('total_selling_price'),
                    currency: document.getElementById('currency').value,
                    exchange_rate: getNumericValue('exchange_rate') || 1
                },
                billings: billings,
                cost_components: components,
                special_requests: document.getElementById('special_requests').value
            };
            
            try {
                const response = await fetch('/api/package-reservations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // ë“±ë¡ ì„±ê³µ ì‹œ ì„ì‹œì €ì¥ ë°ì´í„° ì‚­ì œ
                    localStorage.removeItem('packageDraft');
                    alert(`âœ… íŒ¨í‚¤ì§€ ì˜ˆì•½ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!\nì˜ˆì•½ë²ˆí˜¸: ${result.data.reservation_number}`);
                    window.location.href = '/admin/package-reservations';
                } else {
                    alert('âŒ ë“±ë¡ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                console.error('ë“±ë¡ ì˜¤ë¥˜:', error);
                alert('íŒ¨í‚¤ì§€ ì˜ˆì•½ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            // ì„ì‹œì €ì¥ ë°ì´í„° í™•ì¸
            const draftStr = localStorage.getItem('packageDraft');
            if (draftStr) {
                if (confirm('ì €ì¥ëœ ì„ì‹œ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤. ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    loadDraft();
                    return;
                }
            }
            
            // ê¸°ë³¸ê°’ ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('departure_date').value = today;
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 3);
            document.getElementById('return_date').value = tomorrow.toISOString().split('T')[0];
            
            calculateNights();
            
            // ê¸°ë³¸ êµ¬ì„±ìš”ì†Œ 1ê°œ ì¶”ê°€
            addComponent();
        });
    </script>
</body>
</html>
