<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒ¨í‚¤ì§€ ì˜ˆì•½ ë“±ë¡ - ê´Œì„¸ì´ë¸Œì¹´ë“œ ê´€ë¦¬ì</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .section-divider {
            border-top: 1px solid #dee2e6;
            margin: 20px 0;
            padding-top: 20px;
        }
        .form-label {
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        .form-control, .form-select {
            font-size: 0.875rem;
            padding: 0.375rem 0.5rem;
        }
        h4 {
            font-size: 1.1rem;
            margin-bottom: 1rem !important;
        }
        h5 {
            font-size: 1rem;
            margin-bottom: 0.75rem !important;
        }
        .draft-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ffc107;
            color: #000;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }
        .draft-indicator.show {
            display: block;
        }
        .component-item {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: white;
        }
        .component-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .component-type-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        .badge-flight { background-color: #e3f2fd; color: #1976d2; }
        .badge-hotel { background-color: #f3e5f5; color: #7b1fa2; }
        .badge-tour { background-color: #e8f5e9; color: #388e3c; }
        .badge-other { background-color: #fff3e0; color: #f57c00; }
        .summary-box {
            background-color: #f8f9fa;
            border: 1px solid #0d6efd;
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.875rem;
        }
        .summary-total {
            font-size: 1rem;
            font-weight: bold;
            color: #0d6efd;
            border-top: 1px solid #dee2e6;
            padding-top: 8px;
            margin-top: 8px;
        }
        .guest-card {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }
        .guest-header {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar', { currentPage: 'package-inbox', adminUsername: adminUsername || 'ê´€ë¦¬ì' }) %>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="mb-0"><i class="fas fa-box-open me-2"></i>íŒ¨í‚¤ì§€ ì˜ˆì•½ ë“±ë¡</h3>
                    <div>
                        <button type="button" class="btn btn-sm btn-warning me-1" onclick="saveDraft()">
                            <i class="fas fa-save me-1"></i>ì„ì‹œì €ì¥
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-info me-1" onclick="loadDraft()">
                            <i class="fas fa-folder-open me-1"></i>ë¶ˆëŸ¬ì˜¤ê¸°
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger me-1" onclick="clearDraft()">
                            <i class="fas fa-trash me-1"></i>ì´ˆê¸°í™”
                        </button>
                        <a href="/admin/package-reservations" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-list me-1"></i>ëª©ë¡
                        </a>
                    </div>
                </div>

                <!-- í¼ -->
                <div class="card">
                    <div class="card-body">
                        <form id="packageForm">
                            <!-- ê¸°ë³¸ ì •ë³´ -->
                            <div>
                                <h4>ğŸ“‹ ê¸°ë³¸ ì˜ˆì•½ ì •ë³´</h4>
                                
                                <!-- í•œì¤„ ìš”ì•½ ì •ë³´ -->
                                <div class="row mb-2">
                                    <div class="col-md-2">
                                        <label class="form-label">ì˜ˆì•½ì±„ë„ *</label>
                                        <select class="form-select" id="platform_name" required>
                                            <option value="">ì„ íƒ</option>
                                            <option value="VASCO">VASCO</option>
                                            <option value="NOL">NOL</option>
                                            <option value="ë¡±í˜¼ìŠ¤í…Œì´í¬">ë¡±í˜¼</option>
                                            <option value="ì§ì ‘ì˜ˆì•½">ì§ì ‘</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">íŒ¨í‚¤ì§€ëª… *</label>
                                        <input type="text" class="form-control" id="package_name" 
                                               placeholder="3ë°•4ì¼ í—ˆë‹ˆë¬¸" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">ì¶œë°œì¼ *</label>
                                        <input type="date" class="form-control" id="departure_date" 
                                               onchange="calculateNights()" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">ê·€êµ­ì¼ *</label>
                                        <input type="date" class="form-control" id="return_date" 
                                               onchange="calculateNights()" required>
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label">ê¸°ê°„</label>
                                        <input type="text" class="form-control" id="period_display" 
                                               readonly placeholder="ìë™">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">ì´ìš©í˜¸í…”</label>
                                        <input type="text" class="form-control" id="hotel_name" 
                                               placeholder="í˜¸í…”ëª…">
                                    </div>
                                </div>

                                <div class="row mb-2">
                                    <div class="col-md-3">
                                        <label class="form-label">ì¶œêµ­í¸ëª…</label>
                                        <input type="text" class="form-control" id="outbound_flight" 
                                               placeholder="OZ601">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">ì…êµ­í¸ëª…</label>
                                        <input type="text" class="form-control" id="inbound_flight" 
                                               placeholder="OZ602">
                                    </div>
                                </div>

                                <!-- ì¸ì› ì…ë ¥ -->
                                <h5 class="mt-3">ï¿½ ì¸ì› êµ¬ì„±</h5>
                                <div class="row mb-2">
                                    <div class="col-md-2">
                                        <label class="form-label">ì„±ì¸</label>
                                        <input type="number" class="form-control" id="people_adult" 
                                               value="0" min="0" onchange="generateGuestFields()">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">ì†Œì•„</label>
                                        <input type="number" class="form-control" id="people_child" 
                                               value="0" min="0" onchange="generateGuestFields()">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">ìœ ì•„</label>
                                        <input type="number" class="form-control" id="people_infant" 
                                               value="0" min="0" onchange="generateGuestFields()">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">&nbsp;</label>
                                        <div class="alert alert-info mb-0 py-1">
                                            <small>ì¸ì›ìˆ˜ ì…ë ¥ í›„ ìë™ìœ¼ë¡œ ê³ ê°ì •ë³´ ì…ë ¥ í•„ë“œê°€ ìƒì„±ë©ë‹ˆë‹¤</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- ë™ì  ê³ ê° ì •ë³´ í•„ë“œ -->
                                <div id="guests-container" class="mt-3"></div>

                                <!-- ì¼ì • ë° í¬í•¨/ë¶ˆí¬í•¨ ì‚¬í•­ -->
                                <h5 class="mt-3">ğŸ“… ì¼ì • ë° í¬í•¨/ë¶ˆí¬í•¨ ì‚¬í•­</h5>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <label class="form-label">ì¼ì •</label>
                                        <textarea class="form-control" id="itinerary" rows="4" 
                                                  placeholder="1ì¼ì°¨: ì¸ì²œê³µí•­ ì¶œë°œ â†’ ê´Œ ë„ì°©&#10;2ì¼ì°¨: ììœ ì¼ì •&#10;3ì¼ì°¨: ì‹œë‚´ê´€ê´‘&#10;4ì¼ì°¨: ê·€êµ­"></textarea>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">í¬í•¨ì‚¬í•­</label>
                                        <textarea class="form-control" id="inclusions" rows="2" 
                                                  placeholder="ì™•ë³µí•­ê³µê¶Œ, í˜¸í…”ìˆ™ë°•, ê³µí•­í”½ì—…, ì¡°ì‹ ë“±"></textarea>
                                        <label class="form-label mt-2">ë¶ˆí¬í•¨ì‚¬í•­</label>
                                        <textarea class="form-control" id="exclusions" rows="2" 
                                                  placeholder="ê°œì¸ê²½ë¹„, ì„ íƒê´€ê´‘, ì—¬í–‰ìë³´í—˜ ë“±"></textarea>
                                    </div>
                                </div>

                            </div>

                            <!-- ê¸ˆì•¡ ì •ë³´ -->
                            <div class="section-divider">
                                <h4>ğŸ’° ê¸ˆì•¡ ì •ë³´</h4>
                                
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <label class="form-label">ì´ íŒë§¤ê°€ *</label>
                                        <input type="number" class="form-control" id="total_selling_price" 
                                               placeholder="1500000" onchange="calculateSummary()" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">í†µí™” *</label>
                                        <select class="form-select" id="currency" onchange="toggleExchangeRate()">
                                            <option value="KRW">KRW (ì›í™”)</option>
                                            <option value="USD">USD (ë‹¬ëŸ¬)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">í™˜ìœ¨</label>
                                        <input type="number" class="form-control" id="exchange_rate" 
                                               value="1300" disabled>
                                    </div>
                                </div>

                                <h5>ğŸ“¦ ë§¤ì… êµ¬ì„±ìš”ì†Œ</h5>
                                <div id="components-container"></div>

                                <button type="button" class="btn btn-sm btn-outline-primary mb-3" onclick="addComponent()">
                                    <i class="fas fa-plus me-1"></i>êµ¬ì„±ìš”ì†Œ ì¶”ê°€
                                </button>

                                <!-- ìë™ ê³„ì‚° ìš”ì•½ -->
                                <div class="summary-box">
                                    <h5>ğŸ’µ ê¸ˆì•¡ ìš”ì•½</h5>
                                    <div class="summary-row">
                                        <span>ì´ íŒë§¤ê°€:</span>
                                        <span id="summary_revenue">â‚©0</span>
                                    </div>
                                    <div class="summary-row">
                                        <span>ì´ ë§¤ì…ê°€:</span>
                                        <span id="summary_cost">â‚©0</span>
                                    </div>
                                    <div class="summary-row summary-total">
                                        <span>ì˜ˆìƒ ë§ˆì§„:</span>
                                        <span id="summary_margin">â‚©0 (0%)</span>
                                    </div>
                                    <div class="summary-row">
                                        <span>ë¶€ê°€ì„¸ (ë§ˆì§„ì˜ 10%):</span>
                                        <span id="summary_vat">â‚©0</span>
                                    </div>
                                </div>

                                <div class="mb-2 mt-3">
                                    <label class="form-label">íŠ¹ë³„ ìš”ì²­ì‚¬í•­</label>
                                    <textarea class="form-control" id="special_requests" rows="2" 
                                              placeholder="íŠ¹ë³„ ìš”ì²­ì‚¬í•­ì´ ìˆìœ¼ë©´ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                                </div>

                                <div class="text-end mt-3">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-check me-2"></i>íŒ¨í‚¤ì§€ ì˜ˆì•½ ë“±ë¡
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let componentCount = 0;
        let guestData = [];

        // ë™ì  ê³ ê°ì •ë³´ í•„ë“œ ìƒì„±
        function generateGuestFields() {
            const adultCount = parseInt(document.getElementById('people_adult').value) || 0;
            const childCount = parseInt(document.getElementById('people_child').value) || 0;
            const infantCount = parseInt(document.getElementById('people_infant').value) || 0;
            const totalCount = adultCount + childCount + infantCount;
            
            const container = document.getElementById('guests-container');
            
            if (totalCount === 0) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<h5 class="mb-2">ğŸ‘¤ ê³ ê° ì •ë³´</h5>';
            let guestIndex = 0;
            
            // ì„±ì¸
            for (let i = 0; i < adultCount; i++) {
                guestIndex++;
                html += createGuestCard(guestIndex, 'ì„±ì¸', i + 1);
            }
            
            // ì†Œì•„
            for (let i = 0; i < childCount; i++) {
                guestIndex++;
                html += createGuestCard(guestIndex, 'ì†Œì•„', i + 1);
            }
            
            // ìœ ì•„
            for (let i = 0; i < infantCount; i++) {
                guestIndex++;
                html += createGuestCard(guestIndex, 'ìœ ì•„', i + 1);
            }
            
            container.innerHTML = html;
        }
        
        function createGuestCard(index, type, typeIndex) {
            return `
                <div class="guest-card">
                    <div class="guest-header">${type} ${typeIndex}</div>
                    <div class="row">
                        <div class="col-md-2">
                            <label class="form-label">í•œê¸€ì´ë¦„ *</label>
                            <input type="text" class="form-control form-control-sm" 
                                   id="guest_${index}_korean_name" 
                                   data-guest-index="${index}"
                                   data-guest-type="${type}"
                                   placeholder="í™ê¸¸ë™" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ì˜ë¬¸ì´ë¦„ *</label>
                            <input type="text" class="form-control form-control-sm" 
                                   id="guest_${index}_english_name" 
                                   placeholder="HONG GILDONG" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ìƒë…„ì›”ì¼ *</label>
                            <input type="date" class="form-control form-control-sm" 
                                   id="guest_${index}_birth_date" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ì—°ë½ì²˜</label>
                            <input type="text" class="form-control form-control-sm" 
                                   id="guest_${index}_phone" 
                                   placeholder="010-1234-5678">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ì´ë©”ì¼</label>
                            <input type="email" class="form-control form-control-sm" 
                                   id="guest_${index}_email" 
                                   placeholder="hong@email.com">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">êµ¬ë¶„</label>
                            <input type="text" class="form-control form-control-sm" 
                                   value="${type}" readonly>
                        </div>
                    </div>
                </div>
            `;
        }

        // ë°•ìˆ˜ ìë™ ê³„ì‚°
        function calculateNights() {
            const departure = document.getElementById('departure_date').value;
            const returnDate = document.getElementById('return_date').value;
            
            if (departure && returnDate) {
                const d1 = new Date(departure);
                const d2 = new Date(returnDate);
                const diffTime = Math.abs(d2 - d1);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                document.getElementById('period_display').value = `${diffDays}ë°•${diffDays + 1}ì¼`;
            }
        }

        // í™˜ìœ¨ í•„ë“œ í† ê¸€
        function toggleExchangeRate() {
            const currency = document.getElementById('currency').value;
            const exchangeRateInput = document.getElementById('exchange_rate');
            
            if (currency === 'USD') {
                exchangeRateInput.disabled = false;
            } else {
                exchangeRateInput.disabled = true;
                exchangeRateInput.value = 1;
            }
            
            calculateSummary();
        }

        // êµ¬ì„±ìš”ì†Œ ì¶”ê°€
        function addComponent() {
            componentCount++;
            const container = document.getElementById('components-container');
            
            const componentHTML = `
                <div class="component-item" id="component-${componentCount}">
                    <div class="component-header">
                        <div>
                            <select class="form-select form-select-sm d-inline-block w-auto component-type" 
                                    id="type-${componentCount}" onchange="updateComponentBadge(${componentCount})">
                                <option value="flight">âœˆï¸ í•­ê³µê¶Œ</option>
                                <option value="hotel">ğŸ¨ í˜¸í…”</option>
                                <option value="tour">ğŸ¯ íˆ¬ì–´</option>
                                <option value="other">ğŸ“¦ ê¸°íƒ€</option>
                            </select>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeComponent(${componentCount})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">ê³µê¸‰ì—…ì²´ëª… *</label>
                            <input type="text" class="form-control form-control-sm" 
                                   id="vendor-${componentCount}" placeholder="ì˜ˆ: ì•„ì‹œì•„ë‚˜í•­ê³µ" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ë§¤ì…ê°€ *</label>
                            <input type="number" class="form-control form-control-sm" 
                                   id="cost-${componentCount}" placeholder="850000" 
                                   onchange="calculateSummary()" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">í†µí™”</label>
                            <select class="form-select form-select-sm" id="cost-currency-${componentCount}" 
                                    onchange="calculateSummary()">
                                <option value="KRW">KRW</option>
                                <option value="USD">USD</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ì›í™” í™˜ì‚°</label>
                            <input type="text" class="form-control form-control-sm" 
                                   id="cost-krw-${componentCount}" readonly>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ë¹„ê³ </label>
                            <input type="text" class="form-control form-control-sm" 
                                   id="notes-${componentCount}" placeholder="OZ601/OZ602 ì™•ë³µ">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', componentHTML);
        }

        // êµ¬ì„±ìš”ì†Œ íƒ€ì… ë³€ê²½ ì‹œ (í˜„ì¬ëŠ” ì•„ë¬´ ë™ì‘ ì•ˆí•¨, í•„ìš”ì‹œ í™•ì¥ ê°€ëŠ¥)
        function updateComponentBadge(id) {
            // íƒ€ì… ë³€ê²½ ì‹œ ì¶”ê°€ ë¡œì§ì´ í•„ìš”í•˜ë©´ ì—¬ê¸°ì— êµ¬í˜„
            // í˜„ì¬ëŠ” select ê°’ë§Œ ë³€ê²½ë˜ë©´ ë¨
        }

        // êµ¬ì„±ìš”ì†Œ ì‚­ì œ
        function removeComponent(id) {
            document.getElementById(`component-${id}`).remove();
            calculateSummary();
        }

        // ê¸ˆì•¡ ìš”ì•½ ê³„ì‚°
        function calculateSummary() {
            const sellingPrice = parseFloat(document.getElementById('total_selling_price').value) || 0;
            const currency = document.getElementById('currency').value;
            const exchangeRate = parseFloat(document.getElementById('exchange_rate').value) || 1;
            
            // ì´ íŒë§¤ê°€ (ì›í™” í™˜ì‚°)
            const revenueKRW = currency === 'KRW' ? sellingPrice : sellingPrice * exchangeRate;
            
            // ì´ ë§¤ì…ê°€ ê³„ì‚°
            let totalCostKRW = 0;
            const components = document.querySelectorAll('.component-item');
            
            components.forEach(component => {
                const id = component.id.split('-')[1];
                const cost = parseFloat(document.getElementById(`cost-${id}`).value) || 0;
                const costCurrency = document.getElementById(`cost-currency-${id}`).value;
                
                const costKRW = costCurrency === 'KRW' ? cost : cost * exchangeRate;
                totalCostKRW += costKRW;
                
                // ê°œë³„ êµ¬ì„±ìš”ì†Œ ì›í™” í™˜ì‚° í‘œì‹œ
                document.getElementById(`cost-krw-${id}`).value = 
                    `â‚©${Math.round(costKRW).toLocaleString()}`;
            });
            
            // ë§ˆì§„ ê³„ì‚°
            const marginKRW = revenueKRW - totalCostKRW;
            const marginRate = revenueKRW > 0 ? (marginKRW / revenueKRW * 100).toFixed(1) : 0;
            
            // ë¶€ê°€ì„¸ (ë§ˆì§„ì˜ 10%)
            const vatAmount = Math.round(marginKRW * 0.1);
            
            // ìš”ì•½ í‘œì‹œ
            document.getElementById('summary_revenue').textContent = 
                `â‚©${Math.round(revenueKRW).toLocaleString()}`;
            document.getElementById('summary_cost').textContent = 
                `â‚©${Math.round(totalCostKRW).toLocaleString()}`;
            document.getElementById('summary_margin').textContent = 
                `â‚©${Math.round(marginKRW).toLocaleString()} (${marginRate}%)`;
            document.getElementById('summary_margin').style.color = marginKRW >= 0 ? '#198754' : '#dc3545';
            document.getElementById('summary_vat').textContent = 
                `â‚©${vatAmount.toLocaleString()}`;
        }

        // ì„ì‹œì €ì¥
        function saveDraft() {
            const draft = {
                platform_name: document.getElementById('platform_name').value,
                package_name: document.getElementById('package_name').value,
                departure_date: document.getElementById('departure_date').value,
                return_date: document.getElementById('return_date').value,
                hotel_name: document.getElementById('hotel_name').value,
                outbound_flight: document.getElementById('outbound_flight').value,
                inbound_flight: document.getElementById('inbound_flight').value,
                people_adult: document.getElementById('people_adult').value,
                people_child: document.getElementById('people_child').value,
                people_infant: document.getElementById('people_infant').value,
                itinerary: document.getElementById('itinerary').value,
                inclusions: document.getElementById('inclusions').value,
                exclusions: document.getElementById('exclusions').value,
                total_selling_price: document.getElementById('total_selling_price').value,
                currency: document.getElementById('currency').value,
                exchange_rate: document.getElementById('exchange_rate').value,
                special_requests: document.getElementById('special_requests').value,
                components: [],
                guests: [],
                componentCount: componentCount
            };
            
            // êµ¬ì„±ìš”ì†Œ ì €ì¥
            document.querySelectorAll('.component-item').forEach(component => {
                const id = component.id.split('-')[1];
                draft.components.push({
                    id: id,
                    type: document.getElementById(`type-${id}`).value,
                    vendor: document.getElementById(`vendor-${id}`).value,
                    cost: document.getElementById(`cost-${id}`).value,
                    cost_currency: document.getElementById(`cost-currency-${id}`).value,
                    notes: document.getElementById(`notes-${id}`).value
                });
            });
            
            // ê³ ê°ì •ë³´ ì €ì¥
            document.querySelectorAll('.guest-card').forEach((card, index) => {
                const guestIndex = index + 1;
                const koreanNameEl = document.getElementById(`guest_${guestIndex}_korean_name`);
                if (koreanNameEl) {
                    draft.guests.push({
                        korean_name: koreanNameEl.value,
                        english_name: document.getElementById(`guest_${guestIndex}_english_name`).value,
                        birth_date: document.getElementById(`guest_${guestIndex}_birth_date`).value,
                        phone: document.getElementById(`guest_${guestIndex}_phone`).value,
                        email: document.getElementById(`guest_${guestIndex}_email`).value,
                        type: koreanNameEl.dataset.guestType
                    });
                }
            });
            
            localStorage.setItem('packageDraft', JSON.stringify(draft));
            alert('âœ… ì„ì‹œì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        // ë¶ˆëŸ¬ì˜¤ê¸°
        function loadDraft() {
            const draftStr = localStorage.getItem('packageDraft');
            if (!draftStr) {
                alert('ì €ì¥ëœ ì„ì‹œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!confirm('ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ì…ë ¥ëœ ë‚´ìš©ì€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.')) {
                return;
            }
            
            const draft = JSON.parse(draftStr);
            
            // ê¸°ë³¸ ì •ë³´ ë³µì›
            document.getElementById('platform_name').value = draft.platform_name || '';
            document.getElementById('package_name').value = draft.package_name || '';
            document.getElementById('departure_date').value = draft.departure_date || '';
            document.getElementById('return_date').value = draft.return_date || '';
            document.getElementById('hotel_name').value = draft.hotel_name || '';
            document.getElementById('outbound_flight').value = draft.outbound_flight || '';
            document.getElementById('inbound_flight').value = draft.inbound_flight || '';
            document.getElementById('people_adult').value = draft.people_adult || 0;
            document.getElementById('people_child').value = draft.people_child || 0;
            document.getElementById('people_infant').value = draft.people_infant || 0;
            document.getElementById('itinerary').value = draft.itinerary || '';
            document.getElementById('inclusions').value = draft.inclusions || '';
            document.getElementById('exclusions').value = draft.exclusions || '';
            document.getElementById('total_selling_price').value = draft.total_selling_price || '';
            document.getElementById('currency').value = draft.currency || 'KRW';
            document.getElementById('exchange_rate').value = draft.exchange_rate || 1300;
            document.getElementById('special_requests').value = draft.special_requests || '';
            
            calculateNights();
            toggleExchangeRate();
            generateGuestFields();
            
            // ê³ ê°ì •ë³´ ë³µì›
            if (draft.guests && draft.guests.length > 0) {
                setTimeout(() => {
                    draft.guests.forEach((guest, index) => {
                        const guestIndex = index + 1;
                        const koreanNameEl = document.getElementById(`guest_${guestIndex}_korean_name`);
                        if (koreanNameEl) {
                            koreanNameEl.value = guest.korean_name || '';
                            document.getElementById(`guest_${guestIndex}_english_name`).value = guest.english_name || '';
                            document.getElementById(`guest_${guestIndex}_birth_date`).value = guest.birth_date || '';
                            document.getElementById(`guest_${guestIndex}_phone`).value = guest.phone || '';
                            document.getElementById(`guest_${guestIndex}_email`).value = guest.email || '';
                        }
                    });
                }, 100);
            }
            
            // êµ¬ì„±ìš”ì†Œ ë³µì›
            document.getElementById('components-container').innerHTML = '';
            componentCount = 0;
            
            if (draft.components && draft.components.length > 0) {
                draft.components.forEach(comp => {
                    componentCount++;
                    const container = document.getElementById('components-container');
                    const componentHTML = `
                        <div class="component-item" id="component-${componentCount}">
                            <div class="component-header">
                                <div>
                                    <select class="form-select form-select-sm d-inline-block w-auto component-type" 
                                            id="type-${componentCount}" onchange="updateComponentBadge(${componentCount})">
                                        <option value="flight" ${comp.type === 'flight' ? 'selected' : ''}>âœˆï¸ í•­ê³µê¶Œ</option>
                                        <option value="hotel" ${comp.type === 'hotel' ? 'selected' : ''}>ğŸ¨ í˜¸í…”</option>
                                        <option value="tour" ${comp.type === 'tour' ? 'selected' : ''}>ğŸ¯ íˆ¬ì–´</option>
                                        <option value="other" ${comp.type === 'other' ? 'selected' : ''}>ğŸ“¦ ê¸°íƒ€</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeComponent(${componentCount})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="row">
                                <div class="col-md-3">
                                    <label class="form-label">ê³µê¸‰ì—…ì²´ëª… *</label>
                                    <input type="text" class="form-control form-control-sm" 
                                           id="vendor-${componentCount}" value="${comp.vendor || ''}" placeholder="ì˜ˆ: ì•„ì‹œì•„ë‚˜í•­ê³µ" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">ë§¤ì…ê°€ *</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           id="cost-${componentCount}" value="${comp.cost || ''}" placeholder="850000" 
                                           onchange="calculateSummary()" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">í†µí™”</label>
                                    <select class="form-select form-select-sm" id="cost-currency-${componentCount}" 
                                            onchange="calculateSummary()">
                                        <option value="KRW" ${comp.cost_currency === 'KRW' ? 'selected' : ''}>KRW</option>
                                        <option value="USD" ${comp.cost_currency === 'USD' ? 'selected' : ''}>USD</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">ì›í™” í™˜ì‚°</label>
                                    <input type="text" class="form-control form-control-sm" 
                                           id="cost-krw-${componentCount}" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ë¹„ê³ </label>
                                    <input type="text" class="form-control form-control-sm" 
                                           id="notes-${componentCount}" value="${comp.notes || ''}" placeholder="OZ601/OZ602 ì™•ë³µ">
                                </div>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', componentHTML);
                });
            }
            
            calculateSummary();
            alert('âœ… ì„ì‹œì €ì¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
        }
        
        // ì´ˆê¸°í™”
        function clearDraft() {
            if (!confirm('ì„ì‹œì €ì¥ëœ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            localStorage.removeItem('packageDraft');
            alert('âœ… ì„ì‹œì €ì¥ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // í¼ ì œì¶œ
        document.getElementById('packageForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // ê³ ê°ì •ë³´ ìˆ˜ì§‘
            const guests = [];
            document.querySelectorAll('.guest-card').forEach((card, index) => {
                const guestIndex = index + 1;
                const koreanNameEl = document.getElementById(`guest_${guestIndex}_korean_name`);
                if (koreanNameEl) {
                    guests.push({
                        korean_name: koreanNameEl.value,
                        english_name: document.getElementById(`guest_${guestIndex}_english_name`).value,
                        birth_date: document.getElementById(`guest_${guestIndex}_birth_date`).value,
                        phone: document.getElementById(`guest_${guestIndex}_phone`).value,
                        email: document.getElementById(`guest_${guestIndex}_email`).value,
                        type: koreanNameEl.dataset.guestType
                    });
                }
            });
            
            // êµ¬ì„±ìš”ì†Œ ìˆ˜ì§‘
            const components = [];
            document.querySelectorAll('.component-item').forEach(component => {
                const id = component.id.split('-')[1];
                components.push({
                    component_type: document.getElementById(`type-${id}`).value,
                    vendor_name: document.getElementById(`vendor-${id}`).value,
                    cost_amount: parseFloat(document.getElementById(`cost-${id}`).value),
                    cost_currency: document.getElementById(`cost-currency-${id}`).value,
                    notes: document.getElementById(`notes-${id}`).value
                });
            });
            
            if (components.length === 0) {
                alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ êµ¬ì„±ìš”ì†Œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const data = {
                platform_name: document.getElementById('platform_name').value,
                package_name: document.getElementById('package_name').value,
                customer: guests.length > 0 ? {
                    korean_name: guests[0].korean_name,
                    english_name: guests[0].english_name,
                    phone: guests[0].phone,
                    email: guests[0].email
                } : {
                    korean_name: '',
                    english_name: '',
                    phone: '',
                    email: ''
                },
                guests: guests,
                travel_period: {
                    departure_date: document.getElementById('departure_date').value,
                    return_date: document.getElementById('return_date').value
                },
                people: {
                    adult: parseInt(document.getElementById('people_adult').value) || 0,
                    child: parseInt(document.getElementById('people_child').value) || 0,
                    infant: parseInt(document.getElementById('people_infant').value) || 0
                },
                flight_info: {
                    outbound_flight: document.getElementById('outbound_flight').value,
                    inbound_flight: document.getElementById('inbound_flight').value
                },
                hotel_name: document.getElementById('hotel_name').value,
                itinerary: document.getElementById('itinerary').value,
                inclusions: document.getElementById('inclusions').value,
                exclusions: document.getElementById('exclusions').value,
                pricing: {
                    total_selling_price: parseFloat(document.getElementById('total_selling_price').value) || 0,
                    currency: document.getElementById('currency').value,
                    exchange_rate: parseFloat(document.getElementById('exchange_rate').value) || 1
                },
                cost_components: components,
                special_requests: document.getElementById('special_requests').value
            };
            
            try {
                const response = await fetch('/api/package-reservations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // ë“±ë¡ ì„±ê³µ ì‹œ ì„ì‹œì €ì¥ ë°ì´í„° ì‚­ì œ
                    localStorage.removeItem('packageDraft');
                    alert(`âœ… íŒ¨í‚¤ì§€ ì˜ˆì•½ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!\nì˜ˆì•½ë²ˆí˜¸: ${result.data.reservation_number}`);
                    window.location.href = '/admin/package-reservations';
                } else {
                    alert('âŒ ë“±ë¡ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                console.error('ë“±ë¡ ì˜¤ë¥˜:', error);
                alert('íŒ¨í‚¤ì§€ ì˜ˆì•½ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            // ì„ì‹œì €ì¥ ë°ì´í„° í™•ì¸
            const draftStr = localStorage.getItem('packageDraft');
            if (draftStr) {
                if (confirm('ì €ì¥ëœ ì„ì‹œ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤. ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    loadDraft();
                    return;
                }
            }
            
            // ê¸°ë³¸ê°’ ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('departure_date').value = today;
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 3);
            document.getElementById('return_date').value = tomorrow.toISOString().split('T')[0];
            
            calculateNights();
            
            // ê¸°ë³¸ êµ¬ì„±ìš”ì†Œ 1ê°œ ì¶”ê°€
            addComponent();
        });
    </script>
</body>
</html>
