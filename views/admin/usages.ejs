<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - 괌세이브카드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(45deg, #667eea, #764ba2) !important;
        }
        
        .content-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        
        .pagination {
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- 네비게이션 -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/admin">
                <i class="fas fa-shield-alt me-2"></i>괌세이브카드 관리자
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin">대시보드</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/agencies">여행사 관리</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/users">고객 관리</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/stores">제휴업체 관리</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/usages">사용 이력</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/banners">광고 관리</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/partner-applications">제휴업체 신청</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i><%= adminUsername %>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/admin/logout">로그아웃</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-chart-line me-2"></i><%= title %></h2>
                <p class="text-muted">할인카드 사용 이력을 확인합니다</p>
            </div>
        </div>

        <!-- 필터링 및 정렬 옵션 -->
        <div class="content-card">
            <h5><i class="fas fa-filter me-2"></i>필터 및 정렬</h5>
            <form method="GET" action="/admin/usages" class="row g-3">
                <div class="col-md-3">
                    <label for="store_filter" class="form-label">제휴업체</label>
                    <select name="store_filter" id="store_filter" class="form-select">
                        <option value="">전체 제휴업체</option>
                        <% if (stores && stores.length > 0) { %>
                            <% stores.forEach(store => { %>
                                <option value="<%= store %>" <%= store_filter === store ? 'selected' : '' %>><%= store %></option>
                            <% }); %>
                        <% } %>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="date_from" class="form-label">시작 날짜</label>
                    <input type="date" name="date_from" id="date_from" class="form-control" value="<%= date_from || '' %>">
                </div>
                <div class="col-md-3">
                    <label for="date_to" class="form-label">종료 날짜</label>
                    <input type="date" name="date_to" id="date_to" class="form-control" value="<%= date_to || '' %>">
                </div>
                <div class="col-md-2">
                    <label for="sort_order" class="form-label">정렬</label>
                    <select name="sort_order" id="sort_order" class="form-select">
                        <option value="desc" <%= sort_order === 'desc' ? 'selected' : '' %>">최신순</option>
                        <option value="asc" <%= sort_order === 'asc' ? 'selected' : '' %>">오래된순</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </form>
            
            <!-- 필터 초기화 버튼 -->
            <div class="mt-3">
                <a href="/admin/usages" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-undo me-1"></i>필터 초기화
                </a>
                <% if (store_filter || date_from || date_to) { %>
                    <span class="text-muted ms-3">
                        <i class="fas fa-info-circle me-1"></i>
                        필터 적용됨: 
                        <% if (store_filter) { %>제휴업체(<%= store_filter %>) <% } %>
                        <% if (date_from) { %>시작(<%= date_from %>) <% } %>
                        <% if (date_to) { %>종료(<%= date_to %>) <% } %>
                    </span>
                <% } %>
            </div>
        </div>

        <!-- 사용 이력 목록 -->
        <div class="content-card">
            <h5><i class="fas fa-list me-2"></i>할인 사용 이력 <span class="badge bg-primary"><%= totalUsages %></span></h5>
            
            <% if (usages && usages.length > 0) { %>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>고객명</th>
                                <th>여행사</th>
                                <th>제휴처</th>
                                <th>사용 시간</th>
                                <th>토큰</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% usages.forEach(usage => { %>
                                <tr>
                                    <td><strong><%= usage.customer_name %></strong></td>
                                    <td><%= usage.agency_name %></td>
                                    <td>
                                        <i class="fas fa-store me-1"></i><%= usage.store_code %>
                                    </td>
                                    <td>
                                        <i class="fas fa-clock me-1"></i>
                                        <%= new Date(usage.used_at).toLocaleString('ko-KR') %>
                                    </td>
                                    <td>
                                        <code class="small"><%= usage.token.substring(0, 8) %>...</code>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>

                <!-- 페이지네이션 -->
                <% if (totalPages > 1) { %>
                    <nav>
                        <ul class="pagination">
                            <% 
                                // 현재 필터 파라미터를 URL에 유지하기 위한 함수
                                function buildPageUrl(page) {
                                    const params = new URLSearchParams();
                                    params.set('page', page);
                                    if (store_filter) params.set('store_filter', store_filter);
                                    if (date_from) params.set('date_from', date_from);
                                    if (date_to) params.set('date_to', date_to);
                                    if (sort_order) params.set('sort_order', sort_order);
                                    return '?' + params.toString();
                                }
                            %>
                            <% if (currentPage > 1) { %>
                                <li class="page-item">
                                    <a class="page-link" href="<%= buildPageUrl(currentPage - 1) %>">이전</a>
                                </li>
                            <% } %>
                            
                            <% for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) { %>
                                <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                    <a class="page-link" href="<%= buildPageUrl(i) %>"><%= i %></a>
                                </li>
                            <% } %>
                            
                            <% if (currentPage < totalPages) { %>
                                <li class="page-item">
                                    <a class="page-link" href="<%= buildPageUrl(currentPage + 1) %>">다음</a>
                                </li>
                            <% } %>
                        </ul>
                    </nav>
                <% } %>
            <% } else { %>
                <div class="text-center text-muted py-5">
                    <i class="fas fa-chart-line fa-3x mb-3"></i>
                    <p>아직 사용 이력이 없습니다.</p>
                </div>
            <% } %>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
