<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - 괌세이브카드 관리자</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans KR', sans-serif;
        }
        
        .navbar {
            background: linear-gradient(45deg, #667eea, #764ba2);
            padding: 15px 0;
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.3rem;
        }
        
        .navbar-nav .nav-link {
            color: rgba(255,255,255,0.9) !important;
            margin: 0 5px;
            padding: 8px 15px !important;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        .navbar-nav .nav-link:hover, .navbar-nav .nav-link.active {
            background: rgba(255,255,255,0.2);
            color: white !important;
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            border-radius: 8px;
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            border: none;
            border-radius: 8px;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #e83e8c);
            border: none;
            border-radius: 8px;
        }
        
        .reservation-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .reservation-actions .btn {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        .modal-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .form-label {
            font-weight: 500;
            color: #495057;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .table th {
            background-color: #f8f9fa;
            border-top: none;
            font-weight: 600;
            color: #495057;
        }
        
        .badge {
            font-size: 0.75rem;
            padding: 0.5em 0.75em;
        }
        
        .btn-outline-primary {
            border-color: #667eea;
            color: #667eea;
        }
        
        .table th {
            background-color: #f8f9fa;
            border: none;
            font-weight: 500;
        }
        
        .badge {
            font-size: 0.75em;
            padding: 6px 12px;
        }
        
        .parsing-area {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .parsed-preview {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }
        
        .reservation-row {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .reservation-row:hover {
            background-color: #f8f9fa;
        }
        
        .reservation-details {
            display: none;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .company-badge {
            font-size: 0.7em;
            padding: 4px 8px;
            border-radius: 12px;
        }
        
        .company-nol { background: #28a745; color: white; }
        .company-klook { background: #ff6b35; color: white; }
        .company-viator { background: #00a8cc; color: white; }
        .company-other { background: #6c757d; color: white; }
        
        /* 여행사 선택 버튼 스타일 */
        .agency-selection-area {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }
        
        .agency-btn {
            height: 100px;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .agency-btn:hover {
            border-color: #667eea;
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .agency-btn.selected {
            border-color: #667eea;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .agency-btn.selected .text-muted {
            color: rgba(255, 255, 255, 0.8) !important;
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar', { currentPage: 'reservations', adminUsername: adminUsername }) %>

    <div class="container mt-4">
        <h2><i class="fas fa-calendar-check me-2"></i><%= title %></h2>
        <p class="text-muted">다양한 업체의 예약 데이터를 자동으로 파싱하여 관리하세요</p>

        <!-- 통계 카드 -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-calendar-alt fa-2x text-primary mb-2"></i>
                        <h4 class="card-title"><%= stats.total_reservations || 0 %></h4>
                        <p class="card-text text-muted">총 예약</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <h4 class="card-title"><%= stats.code_issued || 0 %></h4>
                        <p class="card-text text-muted">코드 발급 완료</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                        <h4 class="card-title"><%= stats.pending_codes || 0 %></h4>
                        <p class="card-text text-muted">코드 발급 대기</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-building fa-2x text-info mb-2"></i>
                        <h4 class="card-title"><%= stats.companies || 0 %></h4>
                        <p class="card-text text-muted">업체 수</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-edit fa-2x text-warning mb-2"></i>
                        <h4 class="card-title"><%= stats.drafts_pending || 0 %></h4>
                        <p class="card-text text-muted">검수 대기</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-check-double fa-2x text-success mb-2"></i>
                        <h4 class="card-title"><%= stats.drafts_ready || 0 %></h4>
                        <p class="card-text text-muted">승인 대기</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 예약 데이터 등록 -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h6><i class="fas fa-plus me-2"></i>예약 등록</h6>
                        <p class="text-muted small mb-0">텍스트 파싱 또는 직접 입력으로 예약을 등록하세요.</p>
                    </div>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addReservationModal">
                        <i class="fas fa-keyboard me-2"></i>직접 입력
                    </button>
                </div>

                <!-- 여행사 선택 버튼 메뉴 -->
                <div class="agency-selection-area mb-4">
                    <h6><i class="fas fa-building me-2"></i>여행사 선택</h6>
                    <p class="text-muted small mb-3">파싱할 예약 데이터의 여행사를 먼저 선택하세요. 선택된 여행사 정보가 자동으로 적용됩니다.</p>
                    
                    <div class="agency-buttons-container">
                        <% if (agencies && agencies.length > 0) { %>
                            <div class="row g-2">
                                <% agencies.forEach((agency, index) => { %>
                                    <div class="col-md-3 col-sm-4 col-6">
                                        <button type="button" 
                                                class="btn btn-outline-primary agency-btn w-100" 
                                                data-agency-id="<%= agency.id %>"
                                                data-agency-name="<%= agency.name %>"
                                                data-agency-code="<%= agency.agency_code || agency.code %>"
                                                onclick="selectAgency(this)">
                                            <div class="d-flex flex-column align-items-center">
                                                <% if (agency.logo_url) { %>
                                                    <img src="<%= agency.logo_url %>" alt="<%= agency.name %>" 
                                                         style="max-width: 40px; max-height: 30px; object-fit: contain;" 
                                                         class="mb-2">
                                                <% } else { %>
                                                    <i class="fas fa-building fa-2x mb-2"></i>
                                                <% } %>
                                                <div class="text-center">
                                                    <div class="fw-bold small"><%= agency.name %></div>
                                                    <div class="text-muted" style="font-size: 0.75rem;"><%= agency.agency_code || agency.code %></div>
                                                </div>
                                            </div>
                                        </button>
                                    </div>
                                <% }); %>
                            </div>
                            
                            <!-- 선택된 여행사 표시 -->
                            <div id="selectedAgencyInfo" class="mt-3" style="display: none;">
                                <div class="alert alert-info d-flex align-items-center">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <div>
                                        <strong>선택된 여행사:</strong> 
                                        <span id="selectedAgencyName"></span> 
                                        (<code id="selectedAgencyCode"></code>)
                                        <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="clearAgencySelection()">
                                            <i class="fas fa-times"></i> 선택 해제
                                        </button>
                                    </div>
                                </div>
                            </div>
                        <% } else { %>
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-building fa-2x mb-2"></i>
                                <p>등록된 여행사가 없습니다.</p>
                                <a href="/admin/agencies" class="btn btn-primary btn-sm">
                                    <i class="fas fa-plus me-1"></i>여행사 추가하기
                                </a>
                            </div>
                        <% } %>
                    </div>
                </div>
                
                <div class="parsing-area">
                    <h6><i class="fas fa-paste me-2"></i>예약 데이터 붙여넣기</h6>
                    <p class="text-muted small">NOL, KLOOK, VIATOR 등 다양한 업체의 예약 확인서 내용을 붙여넣으면 자동으로 파싱됩니다.</p>
                    
                    <form id="reservationParseForm">
                        <div class="mb-3">
                            <textarea class="form-control" id="reservationText" rows="10" 
                                    placeholder="예약 데이터를 여기에 붙여넣으세요...

예시:
롱혼 스테이크 하우스
예약접수
예약 일시
2025-09-15 01:38:29
예약 번호
458136
..."></textarea>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary" onclick="parseReservationData()">
                                <i class="fas fa-robot me-2"></i>OpenAI 파싱
                            </button>
                            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#directInputModal">
                                <i class="fas fa-keyboard me-2"></i>직접 입력
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearForm()">
                                <i class="fas fa-eraser me-2"></i>초기화
                            </button>
                        </div>
                    </form>

                    <!-- 파싱 결과 미리보기 -->
                    <div id="parsedPreview" class="parsed-preview" style="display: none;">
                        <h6><i class="fas fa-eye me-2"></i>파싱 결과 미리보기</h6>
                        <div id="parsedContent"></div>
                        <div class="mt-3">
                            <button type="button" class="btn btn-success" onclick="saveReservation()">
                                <i class="fas fa-save me-2"></i>예약 저장
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="hideParsedPreview()">
                                <i class="fas fa-times me-2"></i>취소
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 예약 목록 -->
        <div class="reservation-list-section">
                <!-- 예약 목록 -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-list me-2"></i>예약 목록</h5>
                        <div class="d-flex gap-2">
                            <!-- 검색 폼 -->
                            <form method="GET" class="d-flex gap-2">
                                <input type="text" name="search" class="form-control form-control-sm" 
                                       placeholder="예약번호, 이름, 상품명 검색..." 
                                       value="<%= search %>" style="width: 200px;">
                                <select name="status" class="form-select form-select-sm" style="width: 120px;">
                                    <option value="">전체</option>
                                    <option value="issued" <%= status === 'issued' ? 'selected' : '' %>>발급완료</option>
                                    <option value="pending" <%= status === 'pending' ? 'selected' : '' %>>발급대기</option>
                                </select>
                                <button type="submit" class="btn btn-sm btn-primary">
                                    <i class="fas fa-search"></i>
                                </button>
                                <a href="/admin/reservations" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-times"></i>
                                </a>
                            </form>
                        </div>
                </div>
            </div>
            <div class="card-body">
                <% if (reservations && reservations.length > 0) { %>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>업체</th>
                                    <th>예약번호</th>
                                    <th>상품명</th>
                                    <th>예약자</th>
                                    <th>이용일</th>
                                    <th>금액</th>
                                    <th>코드 상태</th>
                                    <th>액션</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% reservations.forEach((reservation, index) => { %>
                                    <tr class="reservation-row" onclick="toggleDetails(<%= index %>)">
                                        <td>
                                            <span class="company-badge company-<%= (reservation.platform_name || 'other').toLowerCase() %>">
                                                <%= reservation.platform_name || 'NOL' %>
                                            </span>
                                        </td>
                                        <td><%= reservation.reservation_number || '-' %></td>
                                        <td><%= reservation.product_name || '-' %></td>
                                        <td><%= reservation.korean_name || '-' %></td>
                                        <td><%= reservation.usage_date ? new Date(reservation.usage_date).toLocaleDateString('ko-KR') : '-' %></td>
                                        <td><%= reservation.total_price ? '$' + parseFloat(reservation.total_price).toFixed(2) : '-' %></td>
                                        <td>
                                            <% if (reservation.code_issued) { %>
                                                <span class="badge bg-success">발급 완료</span>
                                            <% } else { %>
                                                <span class="badge bg-warning">발급 대기</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <div class="reservation-actions">
                                                <button class="btn btn-sm btn-info" onclick="viewReservation(<%= reservation.id %>); event.stopPropagation();" title="상세보기">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-warning" onclick="editReservation(<%= reservation.id %>); event.stopPropagation();" title="수정">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteReservation(<%= reservation.id %>); event.stopPropagation();" title="삭제">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                <button class="btn btn-sm btn-secondary" onclick="duplicateReservation(<%= reservation.id %>); event.stopPropagation();" title="복제">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr id="details-<%= index %>" class="reservation-details-row" style="display: none;">
                                        <td colspan="8">
{{ ... }}
                                            <div class="reservation-details">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <h6><i class="fas fa-info-circle me-2"></i>기본 정보</h6>
                                                        <p><strong>예약번호:</strong> <%= reservation.reservation_number || '-' %></p>
                                                        <p><strong>플랫폼:</strong> <%= reservation.platform_name || '-' %></p>
                                                        <p><strong>예약채널:</strong> <%= reservation.channel || '-' %></p>
                                                        <p><strong>상품명:</strong> <%= reservation.product_name || '-' %></p>
                                                        <p><strong>결제상태:</strong> <%= reservation.payment_status || '-' %></p>
                                                        <p><strong>총 금액:</strong> <%= reservation.total_amount ? '$' + reservation.total_amount.toLocaleString() : '-' %></p>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h6><i class="fas fa-user me-2"></i>예약자 정보</h6>
                                                        <p><strong>한글명:</strong> <%= reservation.korean_name || '-' %></p>
                                                        <p><strong>영문명:</strong> <%= reservation.english_name || '-' %></p>
                                                        <p><strong>이메일:</strong> <%= reservation.email || '-' %></p>
                                                        <p><strong>전화번호:</strong> <%= reservation.phone || '-' %></p>
                                                        <p><strong>카카오ID:</strong> <%= reservation.kakao_id || '-' %></p>
                                                        <p><strong>인원수:</strong> 성인 <%= reservation.people_adult || 0 %>명, 소아 <%= reservation.people_child || 0 %>명, 유아 <%= reservation.people_infant || 0 %>명</p>
                                                    </div>
                                                </div>
                                                <div class="row mt-3">
                                                    <div class="col-md-6">
                                                        <h6><i class="fas fa-calendar me-2"></i>이용 정보</h6>
                                                        <p><strong>이용일:</strong> <%= reservation.usage_date ? new Date(reservation.usage_date).toLocaleDateString('ko-KR') : '-' %></p>
                                                        <p><strong>이용시간:</strong> <%= reservation.usage_time || '-' %></p>
                                                        <p><strong>패키지:</strong> <%= reservation.package_type || '-' %></p>
                                                        <p><strong>인원수:</strong> <%= reservation.guest_count || '-' %></p>
                                                        <p><strong>등록일:</strong> <%= reservation.created_at ? new Date(reservation.created_at).toLocaleString('ko-KR') : '-' %></p>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h6><i class="fas fa-credit-card me-2"></i>결제 정보</h6>
                                                        <p><strong>성인 단가:</strong> <%= reservation.adult_unit_price ? '$' + reservation.adult_unit_price.toLocaleString() : '-' %></p>
                                                        <p><strong>소아 단가:</strong> <%= reservation.child_unit_price ? '$' + reservation.child_unit_price.toLocaleString() : '-' %></p>
                                                        <p><strong>총 금액:</strong> <%= reservation.total_amount ? '$' + reservation.total_amount.toLocaleString() : '-' %></p>
                                                        <p><strong>결제 상태:</strong> <%= reservation.payment_status || '-' %></p>
                                                        <p><strong>코드 발급:</strong> <%= reservation.code_issued ? '완료' : '대기' %></p>
                                                    </div>
                                                </div>
                                                <% if (reservation.memo || reservation.policy_text) { %>
                                                <div class="row mt-3">
                                                    <% if (reservation.memo) { %>
                                                    <div class="col-md-6">
                                                        <h6><i class="fas fa-sticky-note me-2"></i>메모</h6>
                                                        <p><%= reservation.memo %></p>
                                                    </div>
                                                    <% } %>
                                                    <% if (reservation.policy_text) { %>
                                                    <div class="col-md-6">
                                                        <h6><i class="fas fa-exclamation-triangle me-2"></i>취소 정책</h6>
                                                        <p><%= reservation.policy_text %></p>
                                                    </div>
                                                    <% } %>
                                                </div>
                                                <% } %>
                                            </div>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } else { %>
                    <div class="text-center py-5">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">등록된 예약이 없습니다</h5>
                        <p class="text-muted">위의 예약 데이터 등록 기능을 사용해서 예약을 추가해보세요.</p>
                    </div>
                <% } %>
                
                <!-- 페이징 -->
                <% if (pagination && pagination.totalPages > 1) { %>
                <nav aria-label="예약 목록 페이징" class="mt-4">
                    <ul class="pagination justify-content-center">
                        <% if (pagination.hasPrev) { %>
                            <li class="page-item">
                                <a class="page-link" href="?page=<%= pagination.page - 1 %><%= search ? '&search=' + encodeURIComponent(search) : '' %><%= status ? '&status=' + status : '' %>">이전</a>
                            </li>
                        <% } %>
                        
                        <% for (let i = Math.max(1, pagination.page - 2); i <= Math.min(pagination.totalPages, pagination.page + 2); i++) { %>
                            <li class="page-item <%= i === pagination.page ? 'active' : '' %>">
                                <a class="page-link" href="?page=<%= i %><%= search ? '&search=' + encodeURIComponent(search) : '' %><%= status ? '&status=' + status : '' %>"><%= i %></a>
                            </li>
                        <% } %>
                        
                        <% if (pagination.hasNext) { %>
                            <li class="page-item">
                                <a class="page-link" href="?page=<%= pagination.page + 1 %><%= search ? '&search=' + encodeURIComponent(search) : '' %><%= status ? '&status=' + status : '' %>">다음</a>
                            </li>
                        <% } %>
                    </ul>
                    <div class="text-center text-muted small">
                        총 <%= pagination.totalCount || 0 %>개 중 <%= ((pagination.page - 1) * 20) + 1 %>-<%= Math.min(pagination.page * 20, pagination.totalCount || 0) %>개 표시
                    </div>
                </nav>
                <% } %>
            </div>
        </div>
    </div>

    <!-- 드래프트 관리 탭 -->
    <div class="tab-pane fade" id="drafts" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="fas fa-file-alt me-2"></i>드래프트 목록
                            <span class="badge bg-warning ms-2">검수 대기</span>
                        </h5>
                        <small class="text-muted">파싱된 예약 데이터를 검수하고 승인하세요</small>
                    </div>
                    <div class="d-flex gap-2">
                        <form method="GET" class="d-flex gap-2">
                            <input type="hidden" name="tab" value="drafts">
                            <input type="text" name="draft_search" class="form-control form-control-sm" 
                                   placeholder="예약번호, 이름 검색..." 
                                   value="<%= typeof draft_search !== 'undefined' ? draft_search : '' %>" style="width: 200px;">
                            <select name="draft_status" class="form-select form-select-sm" style="width: 120px;">
                                <option value="">전체 상태</option>
                                <option value="pending" <%= typeof draft_status !== 'undefined' && draft_status === 'pending' ? 'selected' : '' %>>검수 대기</option>
                                <option value="reviewed" <%= typeof draft_status !== 'undefined' && draft_status === 'reviewed' ? 'selected' : '' %>>검수 완료</option>
                                <option value="rejected" <%= typeof draft_status !== 'undefined' && draft_status === 'rejected' ? 'selected' : '' %>>반려</option>
                            </select>
                            <button type="submit" class="btn btn-sm btn-primary">
                                <i class="fas fa-search"></i>
                            </button>
                            <a href="/admin/reservations?tab=drafts" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-times"></i>
                            </a>
                        </form>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <% if (typeof drafts !== 'undefined' && drafts && drafts.length > 0) { %>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>상태</th>
                                    <th>신뢰도</th>
                                    <th>예약번호</th>
                                    <th>예약자</th>
                                    <th>상품명</th>
                                    <th>금액</th>
                                    <th>생성일</th>
                                    <th>액션</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% drafts.forEach(draft => { %>
                                    <tr>
                                        <td>
                                            <% if (draft.status === 'pending') { %>
                                                <span class="badge bg-warning">검수 대기</span>
                                            <% } else if (draft.status === 'reviewed') { %>
                                                <span class="badge bg-success">검수 완료</span>
                                            <% } else if (draft.status === 'rejected') { %>
                                                <span class="badge bg-danger">반려</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <% const confidence = parseFloat(draft.confidence || 0); %>
                                            <div class="d-flex align-items-center">
                                                <div class="progress me-2" style="width: 60px; height: 8px;">
                                                    <div class="progress-bar <%= confidence >= 0.8 ? 'bg-success' : confidence >= 0.6 ? 'bg-warning' : 'bg-danger' %>" 
                                                         style="width: <%= confidence * 100 %>%"></div>
                                                </div>
                                                <small class="text-muted"><%= Math.round(confidence * 100) %>%</small>
                                            </div>
                                        </td>
                                        <td>
                                            <strong><%= draft.reservation_code || '미확인' %></strong>
                                            <% if (draft.platform_name) { %>
                                                <br><small class="text-muted"><%= draft.platform_name %></small>
                                            <% } %>
                                        </td>
                                        <td>
                                            <strong><%= draft.name_kr || '미확인' %></strong>
                                            <% if (draft.name_en_first || draft.name_en_last) { %>
                                                <br><small class="text-muted"><%= (draft.name_en_first || '') + ' ' + (draft.name_en_last || '') %></small>
                                            <% } %>
                                        </td>
                                        <td>
                                            <div class="text-truncate" style="max-width: 200px;" title="<%= draft.product_name || '미확인' %>">
                                                <%= draft.product_name || '미확인' %>
                                            </div>
                                        </td>
                                        <td>
                                            <% if (draft.total_price) { %>
                                                <strong>$<%= parseFloat(draft.total_price).toFixed(2) %></strong>
                                            <% } else { %>
                                                <span class="text-muted">미확인</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                <%= new Date(draft.created_at).toLocaleDateString('ko-KR') %>
                                                <br><%= new Date(draft.created_at).toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'}) %>
                                            </small>
                                        </td>
                                        <td>
                                            <div class="btn-group-vertical btn-group-sm">
                                                <button type="button" class="btn btn-outline-primary btn-sm" 
                                                        onclick="viewDraft('<%= draft.id %>')" title="상세보기">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <% if (draft.status === 'pending') { %>
                                                    <button type="button" class="btn btn-outline-warning btn-sm" 
                                                            onclick="editDraft('<%= draft.id %>')" title="수정">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-success btn-sm" 
                                                            onclick="approveDraft('<%= draft.id %>')" title="승인">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-danger btn-sm" 
                                                            onclick="rejectDraft('<%= draft.id %>')" title="반려">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                <% } %>
                                            </div>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } else { %>
                    <div class="text-center py-5">
                        <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">드래프트가 없습니다</h5>
                        <p class="text-muted">예약 데이터를 파싱하면 여기에 드래프트가 표시됩니다.</p>
                    </div>
                <% } %>
                
                <!-- 드래프트 페이징 -->
                <% if (typeof draft_pagination !== 'undefined' && draft_pagination && draft_pagination.totalPages > 1) { %>
                <nav aria-label="드래프트 목록 페이징" class="mt-4">
                    <ul class="pagination justify-content-center">
                        <% if (draft_pagination.hasPrev) { %>
                            <li class="page-item">
                                <a class="page-link" href="?tab=drafts&page=<%= draft_pagination.page - 1 %><%= typeof draft_search !== 'undefined' && draft_search ? '&draft_search=' + encodeURIComponent(draft_search) : '' %><%= typeof draft_status !== 'undefined' && draft_status ? '&draft_status=' + draft_status : '' %>">이전</a>
                            </li>
                        <% } %>
                        
                        <% for (let i = Math.max(1, draft_pagination.page - 2); i <= Math.min(draft_pagination.totalPages, draft_pagination.page + 2); i++) { %>
                            <li class="page-item <%= i === draft_pagination.page ? 'active' : '' %>">
                                <a class="page-link" href="?tab=drafts&page=<%= i %><%= typeof draft_search !== 'undefined' && draft_search ? '&draft_search=' + encodeURIComponent(draft_search) : '' %><%= typeof draft_status !== 'undefined' && draft_status ? '&draft_status=' + draft_status : '' %>"><%= i %></a>
                            </li>
                        <% } %>
                        
                        <% if (draft_pagination.hasNext) { %>
                            <li class="page-item">
                                <a class="page-link" href="?tab=drafts&page=<%= draft_pagination.page + 1 %><%= typeof draft_search !== 'undefined' && draft_search ? '&draft_search=' + encodeURIComponent(draft_search) : '' %><%= typeof draft_status !== 'undefined' && draft_status ? '&draft_status=' + draft_status : '' %>">다음</a>
                            </li>
                        <% } %>
                    </ul>
                    <div class="text-center text-muted small">
                        총 <%= draft_pagination.totalCount || 0 %>개 중 <%= ((draft_pagination.page - 1) * 20) + 1 %>-<%= Math.min(draft_pagination.page * 20, draft_pagination.totalCount || 0) %>개 표시
                    </div>
                </nav>
                <% } %>
            </div>
        </div>
    </div>

    <!-- JSON 변환 결과 모달 -->
    <div class="modal fade" id="jsonModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">JSON 변환 결과</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">변환된 JSON 데이터:</label>
                        <textarea id="jsonResult" class="form-control" rows="20" readonly style="font-family: monospace; font-size: 12px;"></textarea>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-success" onclick="copyJSON()">
                            <i class="fas fa-copy me-2"></i>복사
                        </button>
                        <button type="button" class="btn btn-primary" onclick="downloadJSON()">
                            <i class="fas fa-download me-2"></i>다운로드
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let parsedReservationData = null;

        function parseReservationData() {
            const text = document.getElementById('reservationText').value.trim();
            if (!text) {
                alert('예약 데이터를 입력해주세요.');
                return;
            }

            // 여행사 선택 확인
            if (!selectedAgency) {
                alert('먼저 여행사를 선택해주세요.');
                return;
            }

            console.log('파싱 시작 - 선택된 여행사:', selectedAgency);

            fetch('/admin/reservations/parse', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    reservationText: text,
                    selectedAgency: selectedAgency
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('파싱 응답:', data);
                if (data.success) {
                    parsedReservationData = data.parsed_data;
                    displayParsedData(data.parsed_data);
                    
                    // 파싱 방법 표시
                    const methodBadge = data.parsing_method === 'OpenAI' ? 
                        '<span class="badge bg-success">OpenAI 파싱</span>' : 
                        '<span class="badge bg-warning">로컬 파싱</span>';
                    
                    // 파싱 결과 헤더 업데이트
                    setTimeout(() => {
                        const alertElement = document.querySelector('.alert-info');
                        if (alertElement) {
                            alertElement.innerHTML = 
                                `<i class="fas fa-robot me-2"></i><strong>파싱 완료</strong> ${methodBadge}`;
                        }
                    }, 100);
                    
                    // 파싱 완료 알림
                    if (data.workflow === 'parsing_only') {
                        console.log('파싱 완료 - 저장 버튼을 클릭하여 예약을 저장하세요.');
                    }
                } else {
                    alert('파싱 실패: ' + data.message);
                    console.error('파싱 오류:', data);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('파싱 중 오류가 발생했습니다.');
            });
        }

        function displayParsedData(data) {
            const content = document.getElementById('parsedContent');
            content.innerHTML = `
                <div class="alert alert-info mb-3">
                    <i class="fas fa-robot me-2"></i><strong>OpenAI 파싱 결과</strong>
                    <span class="badge bg-${data.parsing_confidence === 'high' ? 'success' : data.parsing_confidence === 'medium' ? 'warning' : 'secondary'} ms-2">
                        ${data.parsing_confidence === 'high' ? '높은 신뢰도' : data.parsing_confidence === 'medium' ? '보통 신뢰도' : '낮은 신뢰도'}
                    </span>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary"><i class="fas fa-info-circle me-2"></i>예약 정보</h6>
                        <p><strong>예약번호:</strong> ${data.reservation_number || '-'}</p>
                        <p><strong>채널:</strong> ${data.channel || '-'}</p>
                        <p><strong>플랫폼:</strong> ${data.platform_name || '-'}</p>
                        <p><strong>상품명:</strong> ${data.product_name || '-'}</p>
                        <p><strong>패키지 타입:</strong> ${data.package_type || '-'}</p>
                        <p><strong>총 금액:</strong> ${data.total_amount ? '$' + data.total_amount.toLocaleString() : '-'}</p>
                        <p><strong>결제 상태:</strong> ${data.payment_status || '-'}</p>
                        
                        <h6 class="text-primary mt-3"><i class="fas fa-calendar me-2"></i>일정 정보</h6>
                        <p><strong>이용일:</strong> ${data.usage_date || '-'}</p>
                        <p><strong>이용시간:</strong> ${data.usage_time || '-'}</p>
                        <p><strong>예약일시:</strong> ${data.reservation_datetime || '-'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary"><i class="fas fa-user me-2"></i>예약자 정보</h6>
                        <p><strong>한글명:</strong> ${data.korean_name || '-'}</p>
                        <p><strong>영문 성:</strong> ${data.english_first_name || '-'}</p>
                        <p><strong>영문 이름:</strong> ${data.english_last_name || '-'}</p>
                        <p><strong>이메일:</strong> ${data.email || '-'}</p>
                        <p><strong>전화번호:</strong> ${data.phone || '-'}</p>
                        <p><strong>카카오ID:</strong> ${data.kakao_id || '-'}</p>
                        
                        <h6 class="text-primary mt-3"><i class="fas fa-users me-2"></i>인원 정보</h6>
                        <p><strong>총 수량:</strong> ${data.quantity || '-'}</p>
                        <p><strong>총 인원:</strong> ${data.guest_count || '-'}명</p>
                        <p><strong>성인:</strong> ${data.people_adult || '-'}명 ${data.adult_unit_price ? '($' + data.adult_unit_price + '/인)' : ''}</p>
                        <p><strong>아동:</strong> ${data.people_child || '-'}명 ${data.child_unit_price ? '($' + data.child_unit_price + '/인)' : ''}</p>
                        <p><strong>유아:</strong> ${data.people_infant || '-'}명</p>
                        
                        ${data.memo ? `<h6 class="text-primary mt-3"><i class="fas fa-sticky-note me-2"></i>메모</h6><p>${data.memo}</p>` : ''}
                    </div>
                </div>
            `;
            document.getElementById('parsedPreview').style.display = 'block';
        }

        function saveReservation() {
            if (!parsedReservationData) {
                alert('파싱된 데이터가 없습니다.');
                return;
            }

            // 예약 직접 저장 API 호출
            fetch('/admin/reservations/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    parsedData: parsedReservationData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('예약이 성공적으로 저장되었습니다.');
                    location.reload();
                } else {
                    alert('저장 실패: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('저장 중 오류가 발생했습니다.');
            });
        }

        function clearForm() {
            document.getElementById('reservationText').value = '';
            hideParsedPreview();
        }

        function hideParsedPreview() {
            document.getElementById('parsedPreview').style.display = 'none';
            parsedReservationData = null;
        }

        function toggleDetails(index) {
            const detailsRow = document.getElementById('details-' + index);
            if (detailsRow.style.display === 'none') {
                detailsRow.style.display = 'table-row';
            } else {
                detailsRow.style.display = 'none';
            }
        }



        // 직접입력 저장 함수
        function saveDirectInput() {
            const form = document.getElementById('directInputForm');
            const formData = new FormData(form);
            
            // 필수 필드 검증
            const requiredFields = ['product_name', 'korean_name'];
            for (let field of requiredFields) {
                if (!formData.get(field)) {
                    alert(`${field === 'product_name' ? '상품명' : '한글명'}은(는) 필수 입력 항목입니다.`);
                    return;
                }
            }
            
            // FormData를 객체로 변환
            const reservationData = {};
            for (let [key, value] of formData.entries()) {
                if (value) {
                    reservationData[key] = value;
                }
            }
            
            // 예약 저장 API 호출
            fetch('/admin/reservations/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    parsedData: reservationData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('예약이 성공적으로 저장되었습니다.');
                    // 모달 닫기
                    const modal = bootstrap.Modal.getInstance(document.getElementById('directInputModal'));
                    modal.hide();
                    // 폼 초기화
                    form.reset();
                    // 페이지 새로고침
                    location.reload();
                } else {
                    alert('저장 실패: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('저장 중 오류가 발생했습니다.');
            });
        }

        // JSON 복사 함수
        function copyJSON() {
            const jsonText = document.getElementById('jsonResult');
            jsonText.select();
            document.execCommand('copy');
            alert('JSON 데이터가 클립보드에 복사되었습니다.');
        }

        // JSON 다운로드 함수
        function downloadJSON() {
            const jsonText = document.getElementById('jsonResult').value;
            const blob = new Blob([jsonText], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'reservation_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 드래프트 관리 함수들
        function viewDraft(draftId) {
            window.open(`/admin/drafts/${draftId}`, '_blank');
        }

        function editDraft(draftId) {
            window.location.href = `/admin/drafts/${draftId}/edit`;
        }

        function commitDraft(draftId) {
            if (confirm('이 드래프트를 최종 예약으로 승인하시겠습니까?')) {
                fetch(`/admin/drafts/${draftId}/commit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('드래프트가 성공적으로 승인되어 예약으로 등록되었습니다.');
                        location.reload();
                    } else {
                        alert('승인 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('승인 중 오류가 발생했습니다.');
                });
            }
        }

        // 기존 예약 관리 함수들
        function viewReservation(reservationId) {
            window.open(`/admin/reservations/${reservationId}`, '_blank');
        }

        function editReservation(reservationId) {
            window.location.href = `/admin/reservations/${reservationId}/edit`;
        }

        function deleteReservation(reservationId) {
            if (confirm('이 예약을 취소하시겠습니까? (완전 삭제가 아닌 취소 상태로 변경됩니다)')) {
                fetch(`/admin/reservations/${reservationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('예약이 취소되었습니다.');
                        location.reload();
                    } else {
                        alert('취소 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('취소 중 오류가 발생했습니다.');
                });
            }
        }

        function viewCode(reservationId) {
            fetch('/admin/reservations/' + reservationId + '/code')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('발급 코드: ' + data.code);
                } else {
                    alert('코드 조회 실패: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('코드 조회 중 오류가 발생했습니다.');
            });
        }

        // 예약 수정
        function editReservation(reservationId) {
            fetch('/admin/reservations/' + reservationId)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    populateEditModal(data.reservation);
                    const modal = new bootstrap.Modal(document.getElementById('editReservationModal'));
                    modal.show();
                } else {
                    alert('예약 정보를 불러올 수 없습니다: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('예약 정보 조회 중 오류가 발생했습니다.');
            });
        }

        // 예약 삭제
        function deleteReservation(reservationId) {
            if (confirm('정말로 이 예약을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                fetch('/admin/reservations/' + reservationId, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('예약이 삭제되었습니다.');
                        location.reload();
                    } else {
                        alert('예약 삭제 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('예약 삭제 중 오류가 발생했습니다.');
                });
            }
        }

        // 직접 예약 추가
        function addReservation() {
            const formData = new FormData(document.getElementById('addReservationForm'));
            const data = Object.fromEntries(formData.entries());

            fetch('/admin/reservations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('예약이 등록되었습니다.');
                    bootstrap.Modal.getInstance(document.getElementById('addReservationModal')).hide();
                    location.reload();
                } else {
                    alert('예약 등록 실패: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('예약 등록 중 오류가 발생했습니다.');
            });
        }

        // 예약 수정 저장
        function updateReservation() {
            const formData = new FormData(document.getElementById('editReservationForm'));
            const data = Object.fromEntries(formData.entries());
            const reservationId = document.getElementById('editReservationId').value;

            fetch('/admin/reservations/' + reservationId, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('예약이 수정되었습니다.');
                    bootstrap.Modal.getInstance(document.getElementById('editReservationModal')).hide();
                    location.reload();
                } else {
                    alert('예약 수정 실패: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('예약 수정 중 오류가 발생했습니다.');
            });
        }

        // 상세보기 모달 데이터 채우기
        function populateViewModal(reservation) {
            document.getElementById('viewReservationCode').textContent = reservation.reservation_code || '-';
            document.getElementById('viewPlatformName').textContent = reservation.platform_name || '-';
            document.getElementById('viewProductName').textContent = reservation.product_name || '-';
            document.getElementById('viewNameKr').textContent = reservation.name_kr || '-';
            document.getElementById('viewNameEn').textContent = (reservation.name_en_first + ' ' + reservation.name_en_last).trim() || '-';
            document.getElementById('viewEmail').textContent = reservation.email || '-';
            document.getElementById('viewPhone').textContent = reservation.phone || '-';
            document.getElementById('viewUsageDate').textContent = reservation.usage_date ? new Date(reservation.usage_date).toLocaleDateString('ko-KR') : '-';
            document.getElementById('viewUsageTime').textContent = reservation.usage_time || '-';
            document.getElementById('viewTotalPrice').textContent = reservation.total_price ? '$' + reservation.total_price.toLocaleString() : '-';
            document.getElementById('viewPeopleAdult').textContent = reservation.people_adult || 0;
            document.getElementById('viewPeopleChild').textContent = reservation.people_child || 0;
            document.getElementById('viewPeopleInfant').textContent = reservation.people_infant || 0;
            document.getElementById('viewMemo').textContent = reservation.memo || '-';
        }

        // 수정 모달 데이터 채우기
        function populateEditModal(reservation) {
            document.getElementById('editReservationId').value = reservation.reservation_id;
            document.getElementById('editReservationCode').value = reservation.reservation_code || '';
            document.getElementById('editPlatformName').value = reservation.platform_name || '';
            document.getElementById('editProductName').value = reservation.product_name || '';
            document.getElementById('editNameKr').value = reservation.name_kr || '';
            document.getElementById('editNameEnFirst').value = reservation.name_en_first || '';
            document.getElementById('editNameEnLast').value = reservation.name_en_last || '';
            document.getElementById('editEmail').value = reservation.email || '';
            document.getElementById('editPhone').value = reservation.phone || '';
            document.getElementById('editUsageDate').value = reservation.usage_date ? reservation.usage_date.split('T')[0] : '';
            document.getElementById('editUsageTime').value = reservation.usage_time || '';
            document.getElementById('editTotalPrice').value = reservation.total_price || '';
            document.getElementById('editPeopleAdult').value = reservation.people_adult || 0;
            document.getElementById('editPeopleChild').value = reservation.people_child || 0;
            document.getElementById('editPeopleInfant').value = reservation.people_infant || 0;
            document.getElementById('editMemo').value = reservation.memo || '';
        }
    </script>

    <!-- 직접 예약 추가 모달 -->
    <div class="modal fade" id="addReservationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus me-2"></i>예약 직접 입력</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addReservationForm">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3"><i class="fas fa-info-circle me-2"></i>기본 정보</h6>
                                <div class="mb-3">
                                    <label class="form-label">예약번호 *</label>
                                    <input type="text" class="form-control" name="reservation_code" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">플랫폼</label>
                                    <select class="form-control" name="platform_name">
                                        <option value="NOL">NOL</option>
                                        <option value="KLOOK">KLOOK</option>
                                        <option value="VIATOR">VIATOR</option>
                                        <option value="GETYOURGUIDE">GETYOURGUIDE</option>
                                        <option value="EXPEDIA">EXPEDIA</option>
                                        <option value="OTHER">기타</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">상품명 *</label>
                                    <input type="text" class="form-control" name="product_name" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">총 금액 ($)</label>
                                    <input type="number" step="0.01" class="form-control" name="total_price">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success mb-3"><i class="fas fa-user me-2"></i>예약자 정보</h6>
                                <div class="mb-3">
                                    <label class="form-label">한글명 *</label>
                                    <input type="text" class="form-control" name="name_kr" required>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="mb-3">
                                            <label class="form-label">영문 이름</label>
                                            <input type="text" class="form-control" name="name_en_first">
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="mb-3">
                                            <label class="form-label">영문 성</label>
                                            <input type="text" class="form-control" name="name_en_last">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">이메일</label>
                                    <input type="email" class="form-control" name="email">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">전화번호</label>
                                    <input type="text" class="form-control" name="phone">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-warning mb-3"><i class="fas fa-calendar me-2"></i>이용 정보</h6>
                                <div class="mb-3">
                                    <label class="form-label">이용일</label>
                                    <input type="date" class="form-control" name="usage_date">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">이용시간</label>
                                    <input type="time" class="form-control" name="usage_time">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-info mb-3"><i class="fas fa-users me-2"></i>인원 정보</h6>
                                <div class="row">
                                    <div class="col-4">
                                        <div class="mb-3">
                                            <label class="form-label">성인</label>
                                            <input type="number" class="form-control" name="people_adult" value="1" min="0">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="mb-3">
                                            <label class="form-label">소아</label>
                                            <input type="number" class="form-control" name="people_child" value="0" min="0">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="mb-3">
                                            <label class="form-label">유아</label>
                                            <input type="number" class="form-control" name="people_infant" value="0" min="0">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">메모</label>
                                    <textarea class="form-control" name="memo" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-success" onclick="addReservation()">
                        <i class="fas fa-save me-2"></i>저장
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 예약 상세보기 모달 -->
    <div class="modal fade" id="viewReservationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-eye me-2"></i>예약 상세보기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3"><i class="fas fa-info-circle me-2"></i>기본 정보</h6>
                            <p><strong>예약번호:</strong> <span id="viewReservationCode"></span></p>
                            <p><strong>플랫폼:</strong> <span id="viewPlatformName"></span></p>
                            <p><strong>상품명:</strong> <span id="viewProductName"></span></p>
                            <p><strong>총 금액:</strong> <span id="viewTotalPrice"></span></p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success mb-3"><i class="fas fa-user me-2"></i>예약자 정보</h6>
                            <p><strong>한글명:</strong> <span id="viewNameKr"></span></p>
                            <p><strong>영문명:</strong> <span id="viewNameEn"></span></p>
                            <p><strong>이메일:</strong> <span id="viewEmail"></span></p>
                            <p><strong>전화번호:</strong> <span id="viewPhone"></span></p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-warning mb-3"><i class="fas fa-calendar me-2"></i>이용 정보</h6>
                            <p><strong>이용일:</strong> <span id="viewUsageDate"></span></p>
                            <p><strong>이용시간:</strong> <span id="viewUsageTime"></span></p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-info mb-3"><i class="fas fa-users me-2"></i>인원 정보</h6>
                            <p><strong>성인:</strong> <span id="viewPeopleAdult"></span>명</p>
                            <p><strong>소아:</strong> <span id="viewPeopleChild"></span>명</p>
                            <p><strong>유아:</strong> <span id="viewPeopleInfant"></span>명</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-secondary mb-3"><i class="fas fa-sticky-note me-2"></i>메모</h6>
                            <p id="viewMemo" class="text-muted"></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 예약 수정 모달 -->
    <div class="modal fade" id="editReservationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>예약 수정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editReservationForm">
                        <input type="hidden" id="editReservationId" name="reservation_id">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3"><i class="fas fa-info-circle me-2"></i>기본 정보</h6>
                                <div class="mb-3">
                                    <label class="form-label">예약번호 *</label>
                                    <input type="text" class="form-control" id="editReservationCode" name="reservation_code" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">플랫폼</label>
                                    <select class="form-control" id="editPlatformName" name="platform_name">
                                        <option value="NOL">NOL</option>
                                        <option value="KLOOK">KLOOK</option>
                                        <option value="VIATOR">VIATOR</option>
                                        <option value="GETYOURGUIDE">GETYOURGUIDE</option>
                                        <option value="EXPEDIA">EXPEDIA</option>
                                        <option value="OTHER">기타</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">상품명 *</label>
                                    <input type="text" class="form-control" id="editProductName" name="product_name" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">총 금액 ($)</label>
                                    <input type="number" step="0.01" class="form-control" id="editTotalPrice" name="total_price">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success mb-3"><i class="fas fa-user me-2"></i>예약자 정보</h6>
                                <div class="mb-3">
                                    <label class="form-label">한글명 *</label>
                                    <input type="text" class="form-control" id="editNameKr" name="name_kr" required>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="mb-3">
                                            <label class="form-label">영문 이름</label>
                                            <input type="text" class="form-control" id="editNameEnFirst" name="name_en_first">
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="mb-3">
                                            <label class="form-label">영문 성</label>
                                            <input type="text" class="form-control" id="editNameEnLast" name="name_en_last">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">이메일</label>
                                    <input type="email" class="form-control" id="editEmail" name="email">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">전화번호</label>
                                    <input type="text" class="form-control" id="editPhone" name="phone">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-warning mb-3"><i class="fas fa-calendar me-2"></i>이용 정보</h6>
                                <div class="mb-3">
                                    <label class="form-label">이용일</label>
                                    <input type="date" class="form-control" id="editUsageDate" name="usage_date">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">이용시간</label>
                                    <input type="time" class="form-control" id="editUsageTime" name="usage_time">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-info mb-3"><i class="fas fa-users me-2"></i>인원 정보</h6>
                                <div class="row">
                                    <div class="col-4">
                                        <div class="mb-3">
                                            <label class="form-label">성인</label>
                                            <input type="number" class="form-control" id="editPeopleAdult" name="people_adult" min="0">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="mb-3">
                                            <label class="form-label">소아</label>
                                            <input type="number" class="form-control" id="editPeopleChild" name="people_child" min="0">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="mb-3">
                                            <label class="form-label">유아</label>
                                            <input type="number" class="form-control" id="editPeopleInfant" name="people_infant" min="0">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">메모</label>
                                    <textarea class="form-control" id="editMemo" name="memo" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-warning" onclick="updateReservation()">
                        <i class="fas fa-save me-2"></i>수정 저장
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 드래프트 상세보기 모달 -->
    <div class="modal fade" id="draftDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-file-alt me-2"></i>드래프트 상세보기
                        <span id="draftStatusBadge" class="badge ms-2"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>파싱된 예약 정보</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-primary mb-3">기본 정보</h6>
                                            <div class="mb-2">
                                                <strong>예약번호:</strong> <span id="draftReservationCode"></span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>플랫폼:</strong> <span id="draftPlatform"></span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>상품명:</strong> <span id="draftProductName"></span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>총 금액:</strong> <span id="draftTotalPrice"></span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-success mb-3">예약자 정보</h6>
                                            <div class="mb-2">
                                                <strong>한글명:</strong> <span id="draftNameKr"></span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>영문명:</strong> <span id="draftNameEn"></span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>이메일:</strong> <span id="draftEmail"></span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>전화번호:</strong> <span id="draftPhone"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <h6 class="text-warning mb-3">이용 정보</h6>
                                            <div class="mb-2">
                                                <strong>이용일:</strong> <span id="draftUsageDate"></span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>이용시간:</strong> <span id="draftUsageTime"></span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-info mb-3">인원 정보</h6>
                                            <div class="mb-2">
                                                <strong>성인:</strong> <span id="draftPeopleAdult"></span>명
                                            </div>
                                            <div class="mb-2">
                                                <strong>소아:</strong> <span id="draftPeopleChild"></span>명
                                            </div>
                                            <div class="mb-2">
                                                <strong>유아:</strong> <span id="draftPeopleInfant"></span>명
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>파싱 분석</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">신뢰도</label>
                                        <div class="d-flex align-items-center">
                                            <div class="progress flex-grow-1 me-2">
                                                <div id="draftConfidenceBar" class="progress-bar" style="width: 0%"></div>
                                            </div>
                                            <span id="draftConfidenceText" class="text-muted">0%</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">특이사항</label>
                                        <div id="draftExtractedNotes" class="border rounded p-2 bg-light" style="min-height: 80px;"></div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">원본 텍스트</label>
                                        <div id="draftRawText" class="border rounded p-2 bg-light" style="max-height: 200px; overflow-y: auto; font-size: 12px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <div id="draftActions" class="d-none">
                        <button type="button" class="btn btn-warning me-2" onclick="editDraftFromModal()">
                            <i class="fas fa-edit me-2"></i>수정
                        </button>
                        <button type="button" class="btn btn-success me-2" onclick="approveDraftFromModal()">
                            <i class="fas fa-check me-2"></i>승인
                        </button>
                        <button type="button" class="btn btn-danger" onclick="rejectDraftFromModal()">
                            <i class="fas fa-times me-2"></i>반려
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 직접입력 모달 -->
    <div class="modal fade" id="directInputModal" tabindex="-1" aria-labelledby="directInputModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="directInputModalLabel">
                        <i class="fas fa-keyboard me-2"></i>예약 직접 입력
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="directInputForm">
                        <div class="row">
                            <!-- 기본 정보 -->
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3"><i class="fas fa-info-circle me-2"></i>기본 정보</h6>
                                
                                <div class="mb-3">
                                    <label for="reservation_number" class="form-label">예약번호</label>
                                    <input type="text" class="form-control" id="reservation_number" name="reservation_number">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="confirmation_number" class="form-label">확인번호</label>
                                    <input type="text" class="form-control" id="confirmation_number" name="confirmation_number">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="channel" class="form-label">예약채널</label>
                                    <input type="text" class="form-control" id="channel" name="channel" value="웹">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="platform_name" class="form-label">플랫폼</label>
                                    <select class="form-select" id="platform_name" name="platform_name">
                                        <option value="NOL">NOL</option>
                                        <option value="KLOOK">KLOOK</option>
                                        <option value="VIATOR">VIATOR</option>
                                        <option value="GETYOURGUIDE">GETYOURGUIDE</option>
                                        <option value="EXPEDIA">EXPEDIA</option>
                                        <option value="기타">기타</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="product_name" class="form-label">상품명 *</label>
                                    <input type="text" class="form-control" id="product_name" name="product_name" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="package_type" class="form-label">패키지 타입</label>
                                    <input type="text" class="form-control" id="package_type" name="package_type">
                                </div>
                            </div>
                            
                            <!-- 예약자 정보 -->
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3"><i class="fas fa-user me-2"></i>예약자 정보</h6>
                                
                                <div class="mb-3">
                                    <label for="korean_name" class="form-label">한글명 *</label>
                                    <input type="text" class="form-control" id="korean_name" name="korean_name" required>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="english_first_name" class="form-label">영문 이름</label>
                                            <input type="text" class="form-control" id="english_first_name" name="english_first_name">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="english_last_name" class="form-label">영문 성</label>
                                            <input type="text" class="form-control" id="english_last_name" name="english_last_name">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="email" class="form-label">이메일</label>
                                    <input type="email" class="form-control" id="email" name="email">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="phone" class="form-label">전화번호</label>
                                    <input type="text" class="form-control" id="phone" name="phone">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="kakao_id" class="form-label">카카오ID</label>
                                    <input type="text" class="form-control" id="kakao_id" name="kakao_id">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- 금액 및 인원 정보 -->
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3"><i class="fas fa-dollar-sign me-2"></i>금액 및 인원</h6>
                                
                                <div class="mb-3">
                                    <label for="total_amount" class="form-label">총 금액 ($)</label>
                                    <input type="number" step="0.01" class="form-control" id="total_amount" name="total_amount">
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="people_adult" class="form-label">성인</label>
                                            <input type="number" class="form-control" id="people_adult" name="people_adult" min="0">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="people_child" class="form-label">아동</label>
                                            <input type="number" class="form-control" id="people_child" name="people_child" min="0">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="people_infant" class="form-label">유아</label>
                                            <input type="number" class="form-control" id="people_infant" name="people_infant" min="0">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="adult_unit_price" class="form-label">성인 단가 ($)</label>
                                            <input type="number" step="0.01" class="form-control" id="adult_unit_price" name="adult_unit_price">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="child_unit_price" class="form-label">아동 단가 ($)</label>
                                            <input type="number" step="0.01" class="form-control" id="child_unit_price" name="child_unit_price">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 일정 및 기타 정보 -->
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3"><i class="fas fa-calendar me-2"></i>일정 및 기타</h6>
                                
                                <div class="mb-3">
                                    <label for="usage_date" class="form-label">이용일</label>
                                    <input type="date" class="form-control" id="usage_date" name="usage_date">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="usage_time" class="form-label">이용시간</label>
                                    <input type="time" class="form-control" id="usage_time" name="usage_time">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="reservation_datetime" class="form-label">예약일시</label>
                                    <input type="datetime-local" class="form-control" id="reservation_datetime" name="reservation_datetime">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="payment_status" class="form-label">결제상태</label>
                                    <select class="form-select" id="payment_status" name="payment_status">
                                        <option value="confirmed">확정</option>
                                        <option value="pending">대기</option>
                                        <option value="cancelled">취소</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="memo" class="form-label">메모</label>
                                    <textarea class="form-control" id="memo" name="memo" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>취소
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveDirectInput()">
                        <i class="fas fa-save me-2"></i>예약 저장
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentDraftId = null;

        // 드래프트 상세보기
        function viewDraft(draftId) {
            fetch(`/api/drafts/${draftId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const draft = data.draft;
                        currentDraftId = draftId;
                        
                        // 상태 배지 설정
                        const statusBadge = document.getElementById('draftStatusBadge');
                        if (draft.status === 'pending') {
                            statusBadge.className = 'badge ms-2 bg-warning';
                            statusBadge.textContent = '검수 대기';
                            document.getElementById('draftActions').classList.remove('d-none');
                        } else if (draft.status === 'reviewed') {
                            statusBadge.className = 'badge ms-2 bg-success';
                            statusBadge.textContent = '검수 완료';
                            document.getElementById('draftActions').classList.add('d-none');
                        } else if (draft.status === 'rejected') {
                            statusBadge.className = 'badge ms-2 bg-danger';
                            statusBadge.textContent = '반려';
                            document.getElementById('draftActions').classList.add('d-none');
                        }
                        
                        // 기본 정보
                        document.getElementById('draftReservationCode').textContent = draft.reservation_code || '미확인';
                        document.getElementById('draftPlatform').textContent = draft.platform_name || '미확인';
                        document.getElementById('draftProductName').textContent = draft.product_name || '미확인';
                        document.getElementById('draftTotalPrice').textContent = draft.total_price ? `$${parseFloat(draft.total_price).toFixed(2)}` : '미확인';
                        
                        // 예약자 정보
                        document.getElementById('draftNameKr').textContent = draft.name_kr || '미확인';
                        document.getElementById('draftNameEn').textContent = 
                            (draft.name_en_first || '') + ' ' + (draft.name_en_last || '') || '미확인';
                        document.getElementById('draftEmail').textContent = draft.email || '미확인';
                        document.getElementById('draftPhone').textContent = draft.phone || '미확인';
                        
                        // 이용 정보
                        document.getElementById('draftUsageDate').textContent = draft.usage_date || '미확인';
                        document.getElementById('draftUsageTime').textContent = draft.usage_time || '미확인';
                        
                        // 인원 정보
                        document.getElementById('draftPeopleAdult').textContent = draft.people_adult || '0';
                        document.getElementById('draftPeopleChild').textContent = draft.people_child || '0';
                        document.getElementById('draftPeopleInfant').textContent = draft.people_infant || '0';
                        
                        // 파싱 분석
                        const confidence = parseFloat(draft.confidence || 0);
                        const confidencePercent = Math.round(confidence * 100);
                        const confidenceBar = document.getElementById('draftConfidenceBar');
                        
                        confidenceBar.style.width = confidencePercent + '%';
                        if (confidence >= 0.8) {
                            confidenceBar.className = 'progress-bar bg-success';
                        } else if (confidence >= 0.6) {
                            confidenceBar.className = 'progress-bar bg-warning';
                        } else {
                            confidenceBar.className = 'progress-bar bg-danger';
                        }
                        document.getElementById('draftConfidenceText').textContent = confidencePercent + '%';
                        
                        document.getElementById('draftExtractedNotes').textContent = draft.extracted_notes || '특이사항 없음';
                        document.getElementById('draftRawText').textContent = draft.raw_text || '원본 텍스트 없음';
                        
                        // 모달 표시
                        new bootstrap.Modal(document.getElementById('draftDetailModal')).show();
                    } else {
                        alert('드래프트 정보를 불러올 수 없습니다: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('드래프트 정보를 불러오는 중 오류가 발생했습니다.');
                });
        }

        // 드래프트 수정
        function editDraft(draftId) {
            // TODO: 드래프트 수정 모달 구현
            alert('드래프트 수정 기능은 곧 구현될 예정입니다.');
        }

        function editDraftFromModal() {
            if (currentDraftId) {
                editDraft(currentDraftId);
            }
        }

        // 드래프트 승인
        function approveDraft(draftId) {
            if (confirm('이 드래프트를 승인하여 최종 예약으로 등록하시겠습니까?')) {
                fetch(`/api/drafts/${draftId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('드래프트가 승인되어 예약으로 등록되었습니다.');
                        location.reload();
                    } else {
                        alert('승인 처리 중 오류가 발생했습니다: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('승인 처리 중 오류가 발생했습니다.');
                });
            }
        }

        function approveDraftFromModal() {
            if (currentDraftId) {
                approveDraft(currentDraftId);
            }
        }

        // 드래프트 반려
        function rejectDraft(draftId) {
            const reason = prompt('반려 사유를 입력해주세요:');
            if (reason !== null && reason.trim() !== '') {
                fetch(`/api/drafts/${draftId}/reject`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ reason: reason })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('드래프트가 반려되었습니다.');
                        location.reload();
                    } else {
                        alert('반려 처리 중 오류가 발생했습니다: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('반려 처리 중 오류가 발생했습니다.');
                });
            }
        }

        function rejectDraftFromModal() {
            if (currentDraftId) {
                rejectDraft(currentDraftId);
            }
        }

        // 예약 관리 함수들
        function viewReservation(id) {
            fetch(`/api/reservations/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('예약 상세보기 기능은 곧 구현될 예정입니다.');
                    } else {
                        alert('예약 정보를 불러올 수 없습니다: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('예약 정보를 불러오는 중 오류가 발생했습니다.');
                });
        }

        function editReservation(id) {
            alert('예약 수정 기능은 곧 구현될 예정입니다.');
        }

        function deleteReservation(id) {
            if (confirm('정말로 이 예약을 삭제하시겠습니까?')) {
                fetch(`/api/reservations/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('예약이 삭제되었습니다.');
                        location.reload();
                    } else {
                        alert('예약 삭제 중 오류가 발생했습니다: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('예약 삭제 중 오류가 발생했습니다.');
                });
            }
        }

        function generateCode(id) {
            if (confirm('이 예약에 대한 세이브카드 코드를 생성하시겠습니까?')) {
                fetch(`/api/reservations/${id}/generate-code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('세이브카드 코드가 생성되었습니다.');
                        location.reload();
                    } else {
                        alert('코드 생성 중 오류가 발생했습니다: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('코드 생성 중 오류가 발생했습니다.');
                });
            }
        }

        function viewCode(id) {
            alert('코드 보기 기능은 곧 구현될 예정입니다.');
        }

        function toggleDetails(index) {
            // 예약 상세 정보 토글 기능 (향후 구현)
            console.log('Toggle details for reservation index:', index);
        }

        // 여행사 선택 관련 변수
        let selectedAgency = null;

        // 여행사 선택 함수
        function selectAgency(button) {
            // 모든 버튼에서 selected 클래스 제거
            document.querySelectorAll('.agency-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // 선택된 버튼에 selected 클래스 추가
            button.classList.add('selected');
            
            // 선택된 여행사 정보 저장
            selectedAgency = {
                id: button.dataset.agencyId,
                name: button.dataset.agencyName,
                code: button.dataset.agencyCode
            };
            
            // 선택된 여행사 정보 표시
            document.getElementById('selectedAgencyName').textContent = selectedAgency.name;
            document.getElementById('selectedAgencyCode').textContent = selectedAgency.code;
            document.getElementById('selectedAgencyInfo').style.display = 'block';
            
            console.log('선택된 여행사:', selectedAgency);
        }

        // 여행사 선택 해제 함수
        function clearAgencySelection() {
            // 모든 버튼에서 selected 클래스 제거
            document.querySelectorAll('.agency-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // 선택된 여행사 정보 초기화
            selectedAgency = null;
            
            // 선택된 여행사 정보 숨기기
            document.getElementById('selectedAgencyInfo').style.display = 'none';
            
            console.log('여행사 선택이 해제되었습니다.');
        }

        // 탭 활성화 처리
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const activeTab = urlParams.get('tab');
            
            if (activeTab === 'drafts') {
                const draftsTab = document.getElementById('drafts-tab');
                const draftsPane = document.getElementById('drafts');
                const reservationsTab = document.getElementById('reservations-tab');
                const reservationsPane = document.getElementById('reservations');
                
                // 예약 탭 비활성화
                reservationsTab.classList.remove('active');
                reservationsPane.classList.remove('show', 'active');
                
                // 드래프트 탭 활성화
                draftsTab.classList.add('active');
                draftsPane.classList.add('show', 'active');
            }
        });
    </script>
</body>
</html>
