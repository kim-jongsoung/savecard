<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - 괌세이브카드 관리자</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans KR', sans-serif;
        }
        
        .navbar {
            background: linear-gradient(45deg, #667eea, #764ba2);
            padding: 15px 0;
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.3rem;
        }
        
        .navbar-nav .nav-link {
            color: rgba(255,255,255,0.9) !important;
            margin: 0 5px;
            padding: 8px 15px !important;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        .navbar-nav .nav-link:hover, .navbar-nav .nav-link.active {
            background: rgba(255,255,255,0.2);
            color: white !important;
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            border-radius: 8px;
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            border: none;
            border-radius: 8px;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #e83e8c);
            border: none;
            border-radius: 8px;
        }
        
        .reservation-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .reservation-actions .btn {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        .modal-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .form-label {
            font-weight: 500;
            color: #495057;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .table th {
            background-color: #f8f9fa;
            border-top: none;
            font-weight: 600;
            color: #495057;
        }
        
        .badge {
            font-size: 0.75rem;
            padding: 0.5em 0.75em;
        }
        
        .btn-outline-primary {
            border-color: #667eea;
            color: #667eea;
        }
        
        .table th {
            background-color: #f8f9fa;
            border: none;
            font-weight: 500;
        }
        
        .badge {
            font-size: 0.75em;
            padding: 6px 12px;
        }
        
        .parsing-area {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .parsed-preview {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }
        
        .reservation-row {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .reservation-row:hover {
            background-color: #f8f9fa;
        }
        
        .reservation-details {
            display: none;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .company-badge {
            font-size: 0.7em;
            padding: 4px 8px;
            border-radius: 12px;
        }
        
        .company-nol { background: #28a745; color: white; }
        .company-klook { background: #ff6b35; color: white; }
        .company-viator { background: #00a8cc; color: white; }
        .company-other { background: #6c757d; color: white; }
    </style>
</head>
<body>
    <!-- 네비게이션 -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/admin">
                <i class="fas fa-shield-alt me-2"></i>괌세이브카드 관리자
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin">대시보드</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/agencies">여행사 관리</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/users">고객 관리</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/stores">제휴업체 관리</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/usages">사용 이력</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/banners">광고 관리</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/partner-applications">제휴업체 신청</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/issue-codes">발급 코드 관리</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/reservations">예약 관리</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i><%= adminUsername %>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/admin/logout">로그아웃</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2><i class="fas fa-calendar-check me-2"></i><%= title %></h2>
        <p class="text-muted">다양한 업체의 예약 데이터를 자동으로 파싱하여 관리하세요</p>

        <!-- 통계 카드 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-calendar-alt fa-2x text-primary mb-2"></i>
                        <h4 class="card-title"><%= stats.total_reservations || 0 %></h4>
                        <p class="card-text text-muted">총 예약</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <h4 class="card-title"><%= stats.code_issued || 0 %></h4>
                        <p class="card-text text-muted">코드 발급 완료</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                        <h4 class="card-title"><%= stats.pending_codes || 0 %></h4>
                        <p class="card-text text-muted">코드 발급 대기</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-building fa-2x text-info mb-2"></i>
                        <h4 class="card-title"><%= stats.companies || 0 %></h4>
                        <p class="card-text text-muted">업체 수</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 예약 데이터 등록 -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h6><i class="fas fa-plus me-2"></i>예약 등록</h6>
                        <p class="text-muted small mb-0">텍스트 파싱 또는 직접 입력으로 예약을 등록하세요.</p>
                    </div>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addReservationModal">
                        <i class="fas fa-keyboard me-2"></i>직접 입력
                    </button>
                </div>
                
                <div class="parsing-area">
                    <h6><i class="fas fa-paste me-2"></i>예약 데이터 붙여넣기</h6>
                    <p class="text-muted small">NOL, KLOOK, VIATOR 등 다양한 업체의 예약 확인서 내용을 붙여넣으면 자동으로 파싱됩니다.</p>
                    
                    <form id="reservationParseForm">
                        <div class="mb-3">
                            <textarea class="form-control" id="reservationText" rows="10" 
                                    placeholder="예약 데이터를 여기에 붙여넣으세요...

예시:
롱혼 스테이크 하우스
예약접수
예약 일시
2025-09-15 01:38:29
예약 번호
458136
..."></textarea>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary" onclick="parseReservationData()">
                                <i class="fas fa-robot me-2"></i>OpenAI 파싱
                            </button>
                            <button type="button" class="btn btn-info" onclick="convertToJSON()">
                                <i class="fas fa-code me-2"></i>JSON 변환
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearForm()">
                                <i class="fas fa-eraser me-2"></i>초기화
                            </button>
                        </div>
                    </form>

                    <!-- 파싱 결과 미리보기 -->
                    <div id="parsedPreview" class="parsed-preview" style="display: none;">
                        <h6><i class="fas fa-eye me-2"></i>파싱 결과 미리보기</h6>
                        <div id="parsedContent"></div>
                        <div class="mt-3">
                            <button type="button" class="btn btn-success" onclick="saveReservation()">
                                <i class="fas fa-save me-2"></i>예약 저장
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="hideParsedPreview()">
                                <i class="fas fa-times me-2"></i>취소
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 예약 목록 -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list me-2"></i>예약 목록</h5>
            </div>
            <div class="card-body">
                <% if (reservations && reservations.length > 0) { %>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>업체</th>
                                    <th>예약번호</th>
                                    <th>상품명</th>
                                    <th>예약자</th>
                                    <th>이용일</th>
                                    <th>금액</th>
                                    <th>코드 상태</th>
                                    <th>액션</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% reservations.forEach((reservation, index) => { %>
                                    <tr class="reservation-row" onclick="toggleDetails(<%= index %>)">
                                        <td>
                                            <span class="company-badge company-<%= (reservation.platform_name || 'other').toLowerCase() %>">
                                                <%= reservation.platform_name || 'NOL' %>
                                            </span>
                                        </td>
                                        <td><%= reservation.reservation_number || '-' %></td>
                                        <td><%= reservation.product_name || '-' %></td>
                                        <td><%= reservation.korean_name || '-' %></td>
                                        <td><%= reservation.usage_date ? new Date(reservation.usage_date).toLocaleDateString('ko-KR') : '-' %></td>
                                        <td><%= reservation.total_amount ? '$' + reservation.total_amount.toLocaleString() : '-' %></td>
                                        <td>
                                            <% if (reservation.code_issued) { %>
                                                <span class="badge bg-success">발급 완료</span>
                                            <% } else { %>
                                                <span class="badge bg-warning">발급 대기</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <div class="reservation-actions">
                                                <button class="btn btn-sm btn-info" onclick="viewReservation(<%= reservation.id %>); event.stopPropagation();" title="상세보기">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-warning" onclick="editReservation(<%= reservation.id %>); event.stopPropagation();" title="수정">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteReservation(<%= reservation.id %>); event.stopPropagation();" title="삭제">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                <% if (!reservation.code_issued) { %>
                                                    <button class="btn btn-sm btn-success" onclick="generateCode(<%= reservation.id %>); event.stopPropagation();" title="코드 생성">
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                <% } else { %>
                                                    <button class="btn btn-sm btn-outline-success" onclick="viewCode(<%= reservation.id %>); event.stopPropagation();" title="코드 보기">
                                                        <i class="fas fa-qrcode"></i>
                                                    </button>
                                                <% } %>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr id="details-<%= index %>" class="reservation-details-row" style="display: none;">
                                        <td colspan="8">
                                            <div class="reservation-details">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <h6><i class="fas fa-info-circle me-2"></i>기본 정보</h6>
                                                        <p><strong>예약번호:</strong> <%= reservation.reservation_number || '-' %></p>
                                                        <p><strong>플랫폼:</strong> <%= reservation.platform_name || '-' %></p>
                                                        <p><strong>예약채널:</strong> <%= reservation.channel || '-' %></p>
                                                        <p><strong>상품명:</strong> <%= reservation.product_name || '-' %></p>
                                                        <p><strong>결제상태:</strong> <%= reservation.payment_status || '-' %></p>
                                                        <p><strong>총 금액:</strong> <%= reservation.total_amount ? '$' + reservation.total_amount.toLocaleString() : '-' %></p>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h6><i class="fas fa-user me-2"></i>예약자 정보</h6>
                                                        <p><strong>한글명:</strong> <%= reservation.korean_name || '-' %></p>
                                                        <p><strong>영문명:</strong> <%= reservation.english_name || '-' %></p>
                                                        <p><strong>이메일:</strong> <%= reservation.email || '-' %></p>
                                                        <p><strong>전화번호:</strong> <%= reservation.phone || '-' %></p>
                                                        <p><strong>카카오ID:</strong> <%= reservation.kakao_id || '-' %></p>
                                                        <p><strong>인원수:</strong> 성인 <%= reservation.people_adult || 0 %>명, 소아 <%= reservation.people_child || 0 %>명, 유아 <%= reservation.people_infant || 0 %>명</p>
                                                    </div>
                                                </div>
                                                <div class="row mt-3">
                                                    <div class="col-md-6">
                                                        <h6><i class="fas fa-calendar me-2"></i>이용 정보</h6>
                                                        <p><strong>이용일:</strong> <%= reservation.usage_date ? new Date(reservation.usage_date).toLocaleDateString('ko-KR') : '-' %></p>
                                                        <p><strong>이용시간:</strong> <%= reservation.usage_time || '-' %></p>
                                                        <p><strong>패키지:</strong> <%= reservation.package_type || '-' %></p>
                                                        <p><strong>인원수:</strong> <%= reservation.guest_count || '-' %></p>
                                                        <p><strong>등록일:</strong> <%= reservation.created_at ? new Date(reservation.created_at).toLocaleString('ko-KR') : '-' %></p>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h6><i class="fas fa-credit-card me-2"></i>결제 정보</h6>
                                                        <p><strong>성인 단가:</strong> <%= reservation.adult_unit_price ? '$' + reservation.adult_unit_price.toLocaleString() : '-' %></p>
                                                        <p><strong>소아 단가:</strong> <%= reservation.child_unit_price ? '$' + reservation.child_unit_price.toLocaleString() : '-' %></p>
                                                        <p><strong>총 금액:</strong> <%= reservation.total_amount ? '$' + reservation.total_amount.toLocaleString() : '-' %></p>
                                                        <p><strong>결제 상태:</strong> <%= reservation.payment_status || '-' %></p>
                                                        <p><strong>코드 발급:</strong> <%= reservation.code_issued ? '완료' : '대기' %></p>
                                                    </div>
                                                </div>
                                                <% if (reservation.memo || reservation.policy_text) { %>
                                                <div class="row mt-3">
                                                    <% if (reservation.memo) { %>
                                                    <div class="col-md-6">
                                                        <h6><i class="fas fa-sticky-note me-2"></i>메모</h6>
                                                        <p><%= reservation.memo %></p>
                                                    </div>
                                                    <% } %>
                                                    <% if (reservation.policy_text) { %>
                                                    <div class="col-md-6">
                                                        <h6><i class="fas fa-exclamation-triangle me-2"></i>취소 정책</h6>
                                                        <p><%= reservation.policy_text %></p>
                                                    </div>
                                                    <% } %>
                                                </div>
                                                <% } %>
                                            </div>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } else { %>
                    <div class="text-center py-5">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">등록된 예약이 없습니다</h5>
                        <p class="text-muted">위의 예약 데이터 등록 기능을 사용해서 예약을 추가해보세요.</p>
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <!-- JSON 변환 결과 모달 -->
    <div class="modal fade" id="jsonModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">JSON 변환 결과</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">변환된 JSON 데이터:</label>
                        <textarea id="jsonResult" class="form-control" rows="20" readonly style="font-family: monospace; font-size: 12px;"></textarea>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-success" onclick="copyJSON()">
                            <i class="fas fa-copy me-2"></i>복사
                        </button>
                        <button type="button" class="btn btn-primary" onclick="downloadJSON()">
                            <i class="fas fa-download me-2"></i>다운로드
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let parsedReservationData = null;

        function parseReservationData() {
            const text = document.getElementById('reservationText').value.trim();
            if (!text) {
                alert('예약 데이터를 입력해주세요.');
                return;
            }

            fetch('/admin/reservations/parse', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ reservationText: text })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    parsedReservationData = data.parsed_data;
                    displayParsedData(data.parsed_data);
                } else {
                    alert('파싱 실패: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('파싱 중 오류가 발생했습니다.');
            });
        }

        function displayParsedData(data) {
            const content = document.getElementById('parsedContent');
            content.innerHTML = `
                <div class="alert alert-info mb-3">
                    <i class="fas fa-robot me-2"></i><strong>OpenAI 파싱 결과</strong>
                    <span class="badge bg-${data.parsing_confidence === 'high' ? 'success' : data.parsing_confidence === 'medium' ? 'warning' : 'secondary'} ms-2">
                        ${data.parsing_confidence === 'high' ? '높은 신뢰도' : data.parsing_confidence === 'medium' ? '보통 신뢰도' : '낮은 신뢰도'}
                    </span>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary"><i class="fas fa-info-circle me-2"></i>예약 정보</h6>
                        <p><strong>예약번호:</strong> ${data.reservation_number || '-'}</p>
                        <p><strong>채널:</strong> ${data.channel || '-'}</p>
                        <p><strong>플랫폼:</strong> ${data.platform_name || '-'}</p>
                        <p><strong>상품명:</strong> ${data.product_name || '-'}</p>
                        <p><strong>패키지 타입:</strong> ${data.package_type || '-'}</p>
                        <p><strong>총 금액:</strong> ${data.total_amount ? '$' + data.total_amount.toLocaleString() : '-'}</p>
                        <p><strong>결제 상태:</strong> ${data.payment_status || '-'}</p>
                        
                        <h6 class="text-primary mt-3"><i class="fas fa-calendar me-2"></i>일정 정보</h6>
                        <p><strong>이용일:</strong> ${data.usage_date || '-'}</p>
                        <p><strong>이용시간:</strong> ${data.usage_time || '-'}</p>
                        <p><strong>예약일시:</strong> ${data.reservation_datetime || '-'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary"><i class="fas fa-user me-2"></i>예약자 정보</h6>
                        <p><strong>한글명:</strong> ${data.korean_name || '-'}</p>
                        <p><strong>영문 성:</strong> ${data.english_first_name || '-'}</p>
                        <p><strong>영문 이름:</strong> ${data.english_last_name || '-'}</p>
                        <p><strong>이메일:</strong> ${data.email || '-'}</p>
                        <p><strong>전화번호:</strong> ${data.phone || '-'}</p>
                        <p><strong>카카오ID:</strong> ${data.kakao_id || '-'}</p>
                        
                        <h6 class="text-primary mt-3"><i class="fas fa-users me-2"></i>인원 정보</h6>
                        <p><strong>총 수량:</strong> ${data.quantity || '-'}</p>
                        <p><strong>총 인원:</strong> ${data.guest_count || '-'}명</p>
                        <p><strong>성인:</strong> ${data.people_adult || '-'}명 ${data.adult_unit_price ? '($' + data.adult_unit_price + '/인)' : ''}</p>
                        <p><strong>아동:</strong> ${data.people_child || '-'}명 ${data.child_unit_price ? '($' + data.child_unit_price + '/인)' : ''}</p>
                        <p><strong>유아:</strong> ${data.people_infant || '-'}명</p>
                        
                        ${data.memo ? `<h6 class="text-primary mt-3"><i class="fas fa-sticky-note me-2"></i>메모</h6><p>${data.memo}</p>` : ''}
                    </div>
                </div>
            `;
            document.getElementById('parsedPreview').style.display = 'block';
        }

        function saveReservation() {
            if (!parsedReservationData) {
                alert('파싱된 데이터가 없습니다.');
                return;
            }

            fetch('/admin/reservations/parse', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    reservationText: document.getElementById('reservationText').value,
                    save: true 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('예약이 성공적으로 저장되었습니다.');
                    location.reload();
                } else {
                    alert('저장 실패: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('저장 중 오류가 발생했습니다.');
            });
        }

        function clearForm() {
            document.getElementById('reservationText').value = '';
            hideParsedPreview();
        }

        function hideParsedPreview() {
            document.getElementById('parsedPreview').style.display = 'none';
            parsedReservationData = null;
        }

        function toggleDetails(index) {
            const detailsRow = document.getElementById('details-' + index);
            if (detailsRow.style.display === 'none') {
                detailsRow.style.display = 'table-row';
            } else {
                detailsRow.style.display = 'none';
            }
        }

        function generateCode(reservationId) {
            if (confirm('이 예약에 대한 발급 코드를 생성하시겠습니까?')) {
                fetch('/admin/reservations/' + reservationId + '/generate-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('발급 코드가 생성되었습니다: ' + data.code);
                        location.reload();
                    } else {
                        alert('코드 생성 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('코드 생성 중 오류가 발생했습니다.');
                });
            }
        }

        // JSON 변환 함수
        function convertToJSON() {
            const text = document.getElementById('reservationText').value.trim();
            if (!text) {
                alert('예약 데이터를 입력해주세요.');
                return;
            }

            fetch('/admin/reservations/convert-json', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ reservationText: text })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('jsonResult').value = JSON.stringify(data, null, 2);
                const modal = new bootstrap.Modal(document.getElementById('jsonModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('JSON 변환 중 오류가 발생했습니다.');
            });
        }

        // JSON 복사 함수
        function copyJSON() {
            const jsonText = document.getElementById('jsonResult');
            jsonText.select();
            document.execCommand('copy');
            alert('JSON 데이터가 클립보드에 복사되었습니다.');
        }

        // JSON 다운로드 함수
        function downloadJSON() {
            const jsonText = document.getElementById('jsonResult').value;
            const blob = new Blob([jsonText], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'reservation_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function viewCode(reservationId) {
            fetch('/admin/reservations/' + reservationId + '/code')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('발급 코드: ' + data.code);
                } else {
                    alert('코드 조회 실패: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('코드 조회 중 오류가 발생했습니다.');
            });
        }

        // 예약 상세보기
        function viewReservation(reservationId) {
            fetch('/admin/reservations/' + reservationId)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    populateViewModal(data.reservation);
                    const modal = new bootstrap.Modal(document.getElementById('viewReservationModal'));
                    modal.show();
                } else {
                    alert('예약 정보를 불러올 수 없습니다: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('예약 정보 조회 중 오류가 발생했습니다.');
            });
        }

        // 예약 수정
        function editReservation(reservationId) {
            fetch('/admin/reservations/' + reservationId)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    populateEditModal(data.reservation);
                    const modal = new bootstrap.Modal(document.getElementById('editReservationModal'));
                    modal.show();
                } else {
                    alert('예약 정보를 불러올 수 없습니다: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('예약 정보 조회 중 오류가 발생했습니다.');
            });
        }

        // 예약 삭제
        function deleteReservation(reservationId) {
            if (confirm('정말로 이 예약을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                fetch('/admin/reservations/' + reservationId, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('예약이 삭제되었습니다.');
                        location.reload();
                    } else {
                        alert('예약 삭제 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('예약 삭제 중 오류가 발생했습니다.');
                });
            }
        }

        // 직접 예약 추가
        function addReservation() {
            const formData = new FormData(document.getElementById('addReservationForm'));
            const data = Object.fromEntries(formData.entries());

            fetch('/admin/reservations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('예약이 등록되었습니다.');
                    bootstrap.Modal.getInstance(document.getElementById('addReservationModal')).hide();
                    location.reload();
                } else {
                    alert('예약 등록 실패: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('예약 등록 중 오류가 발생했습니다.');
            });
        }

        // 예약 수정 저장
        function updateReservation() {
            const formData = new FormData(document.getElementById('editReservationForm'));
            const data = Object.fromEntries(formData.entries());
            const reservationId = document.getElementById('editReservationId').value;

            fetch('/admin/reservations/' + reservationId, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('예약이 수정되었습니다.');
                    bootstrap.Modal.getInstance(document.getElementById('editReservationModal')).hide();
                    location.reload();
                } else {
                    alert('예약 수정 실패: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('예약 수정 중 오류가 발생했습니다.');
            });
        }

        // 상세보기 모달 데이터 채우기
        function populateViewModal(reservation) {
            document.getElementById('viewReservationCode').textContent = reservation.reservation_code || '-';
            document.getElementById('viewPlatformName').textContent = reservation.platform_name || '-';
            document.getElementById('viewProductName').textContent = reservation.product_name || '-';
            document.getElementById('viewNameKr').textContent = reservation.name_kr || '-';
            document.getElementById('viewNameEn').textContent = (reservation.name_en_first + ' ' + reservation.name_en_last).trim() || '-';
            document.getElementById('viewEmail').textContent = reservation.email || '-';
            document.getElementById('viewPhone').textContent = reservation.phone || '-';
            document.getElementById('viewUsageDate').textContent = reservation.usage_date ? new Date(reservation.usage_date).toLocaleDateString('ko-KR') : '-';
            document.getElementById('viewUsageTime').textContent = reservation.usage_time || '-';
            document.getElementById('viewTotalPrice').textContent = reservation.total_price ? '$' + reservation.total_price.toLocaleString() : '-';
            document.getElementById('viewPeopleAdult').textContent = reservation.people_adult || 0;
            document.getElementById('viewPeopleChild').textContent = reservation.people_child || 0;
            document.getElementById('viewPeopleInfant').textContent = reservation.people_infant || 0;
            document.getElementById('viewMemo').textContent = reservation.memo || '-';
        }

        // 수정 모달 데이터 채우기
        function populateEditModal(reservation) {
            document.getElementById('editReservationId').value = reservation.reservation_id;
            document.getElementById('editReservationCode').value = reservation.reservation_code || '';
            document.getElementById('editPlatformName').value = reservation.platform_name || '';
            document.getElementById('editProductName').value = reservation.product_name || '';
            document.getElementById('editNameKr').value = reservation.name_kr || '';
            document.getElementById('editNameEnFirst').value = reservation.name_en_first || '';
            document.getElementById('editNameEnLast').value = reservation.name_en_last || '';
            document.getElementById('editEmail').value = reservation.email || '';
            document.getElementById('editPhone').value = reservation.phone || '';
            document.getElementById('editUsageDate').value = reservation.usage_date ? reservation.usage_date.split('T')[0] : '';
            document.getElementById('editUsageTime').value = reservation.usage_time || '';
            document.getElementById('editTotalPrice').value = reservation.total_price || '';
            document.getElementById('editPeopleAdult').value = reservation.people_adult || 0;
            document.getElementById('editPeopleChild').value = reservation.people_child || 0;
            document.getElementById('editPeopleInfant').value = reservation.people_infant || 0;
            document.getElementById('editMemo').value = reservation.memo || '';
        }
    </script>

    <!-- 직접 예약 추가 모달 -->
    <div class="modal fade" id="addReservationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus me-2"></i>예약 직접 입력</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addReservationForm">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3"><i class="fas fa-info-circle me-2"></i>기본 정보</h6>
                                <div class="mb-3">
                                    <label class="form-label">예약번호 *</label>
                                    <input type="text" class="form-control" name="reservation_code" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">플랫폼</label>
                                    <select class="form-control" name="platform_name">
                                        <option value="NOL">NOL</option>
                                        <option value="KLOOK">KLOOK</option>
                                        <option value="VIATOR">VIATOR</option>
                                        <option value="GETYOURGUIDE">GETYOURGUIDE</option>
                                        <option value="EXPEDIA">EXPEDIA</option>
                                        <option value="OTHER">기타</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">상품명 *</label>
                                    <input type="text" class="form-control" name="product_name" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">총 금액 ($)</label>
                                    <input type="number" step="0.01" class="form-control" name="total_price">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success mb-3"><i class="fas fa-user me-2"></i>예약자 정보</h6>
                                <div class="mb-3">
                                    <label class="form-label">한글명 *</label>
                                    <input type="text" class="form-control" name="name_kr" required>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="mb-3">
                                            <label class="form-label">영문 이름</label>
                                            <input type="text" class="form-control" name="name_en_first">
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="mb-3">
                                            <label class="form-label">영문 성</label>
                                            <input type="text" class="form-control" name="name_en_last">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">이메일</label>
                                    <input type="email" class="form-control" name="email">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">전화번호</label>
                                    <input type="text" class="form-control" name="phone">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-warning mb-3"><i class="fas fa-calendar me-2"></i>이용 정보</h6>
                                <div class="mb-3">
                                    <label class="form-label">이용일</label>
                                    <input type="date" class="form-control" name="usage_date">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">이용시간</label>
                                    <input type="time" class="form-control" name="usage_time">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-info mb-3"><i class="fas fa-users me-2"></i>인원 정보</h6>
                                <div class="row">
                                    <div class="col-4">
                                        <div class="mb-3">
                                            <label class="form-label">성인</label>
                                            <input type="number" class="form-control" name="people_adult" value="1" min="0">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="mb-3">
                                            <label class="form-label">소아</label>
                                            <input type="number" class="form-control" name="people_child" value="0" min="0">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="mb-3">
                                            <label class="form-label">유아</label>
                                            <input type="number" class="form-control" name="people_infant" value="0" min="0">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">메모</label>
                                    <textarea class="form-control" name="memo" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-success" onclick="addReservation()">
                        <i class="fas fa-save me-2"></i>저장
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 예약 상세보기 모달 -->
    <div class="modal fade" id="viewReservationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-eye me-2"></i>예약 상세보기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3"><i class="fas fa-info-circle me-2"></i>기본 정보</h6>
                            <p><strong>예약번호:</strong> <span id="viewReservationCode"></span></p>
                            <p><strong>플랫폼:</strong> <span id="viewPlatformName"></span></p>
                            <p><strong>상품명:</strong> <span id="viewProductName"></span></p>
                            <p><strong>총 금액:</strong> <span id="viewTotalPrice"></span></p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success mb-3"><i class="fas fa-user me-2"></i>예약자 정보</h6>
                            <p><strong>한글명:</strong> <span id="viewNameKr"></span></p>
                            <p><strong>영문명:</strong> <span id="viewNameEn"></span></p>
                            <p><strong>이메일:</strong> <span id="viewEmail"></span></p>
                            <p><strong>전화번호:</strong> <span id="viewPhone"></span></p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-warning mb-3"><i class="fas fa-calendar me-2"></i>이용 정보</h6>
                            <p><strong>이용일:</strong> <span id="viewUsageDate"></span></p>
                            <p><strong>이용시간:</strong> <span id="viewUsageTime"></span></p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-info mb-3"><i class="fas fa-users me-2"></i>인원 정보</h6>
                            <p><strong>성인:</strong> <span id="viewPeopleAdult"></span>명</p>
                            <p><strong>소아:</strong> <span id="viewPeopleChild"></span>명</p>
                            <p><strong>유아:</strong> <span id="viewPeopleInfant"></span>명</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-secondary mb-3"><i class="fas fa-sticky-note me-2"></i>메모</h6>
                            <p id="viewMemo" class="text-muted"></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 예약 수정 모달 -->
    <div class="modal fade" id="editReservationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>예약 수정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editReservationForm">
                        <input type="hidden" id="editReservationId" name="reservation_id">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3"><i class="fas fa-info-circle me-2"></i>기본 정보</h6>
                                <div class="mb-3">
                                    <label class="form-label">예약번호 *</label>
                                    <input type="text" class="form-control" id="editReservationCode" name="reservation_code" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">플랫폼</label>
                                    <select class="form-control" id="editPlatformName" name="platform_name">
                                        <option value="NOL">NOL</option>
                                        <option value="KLOOK">KLOOK</option>
                                        <option value="VIATOR">VIATOR</option>
                                        <option value="GETYOURGUIDE">GETYOURGUIDE</option>
                                        <option value="EXPEDIA">EXPEDIA</option>
                                        <option value="OTHER">기타</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">상품명 *</label>
                                    <input type="text" class="form-control" id="editProductName" name="product_name" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">총 금액 ($)</label>
                                    <input type="number" step="0.01" class="form-control" id="editTotalPrice" name="total_price">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success mb-3"><i class="fas fa-user me-2"></i>예약자 정보</h6>
                                <div class="mb-3">
                                    <label class="form-label">한글명 *</label>
                                    <input type="text" class="form-control" id="editNameKr" name="name_kr" required>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="mb-3">
                                            <label class="form-label">영문 이름</label>
                                            <input type="text" class="form-control" id="editNameEnFirst" name="name_en_first">
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="mb-3">
                                            <label class="form-label">영문 성</label>
                                            <input type="text" class="form-control" id="editNameEnLast" name="name_en_last">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">이메일</label>
                                    <input type="email" class="form-control" id="editEmail" name="email">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">전화번호</label>
                                    <input type="text" class="form-control" id="editPhone" name="phone">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-warning mb-3"><i class="fas fa-calendar me-2"></i>이용 정보</h6>
                                <div class="mb-3">
                                    <label class="form-label">이용일</label>
                                    <input type="date" class="form-control" id="editUsageDate" name="usage_date">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">이용시간</label>
                                    <input type="time" class="form-control" id="editUsageTime" name="usage_time">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-info mb-3"><i class="fas fa-users me-2"></i>인원 정보</h6>
                                <div class="row">
                                    <div class="col-4">
                                        <div class="mb-3">
                                            <label class="form-label">성인</label>
                                            <input type="number" class="form-control" id="editPeopleAdult" name="people_adult" min="0">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="mb-3">
                                            <label class="form-label">소아</label>
                                            <input type="number" class="form-control" id="editPeopleChild" name="people_child" min="0">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="mb-3">
                                            <label class="form-label">유아</label>
                                            <input type="number" class="form-control" id="editPeopleInfant" name="people_infant" min="0">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">메모</label>
                                    <textarea class="form-control" id="editMemo" name="memo" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-warning" onclick="updateReservation()">
                        <i class="fas fa-save me-2"></i>수정 저장
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
