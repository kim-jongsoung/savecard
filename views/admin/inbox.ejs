<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¸ë°•ìŠ¤ - ê´Œì„¸ì´ë¸Œì¹´ë“œ ê´€ë¦¬ì</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <%- include('../partials/navbar', { currentPage: 'inbox', adminUsername: adminUsername }) %>
    
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-inbox me-2"></i>ì¸ë°•ìŠ¤ - ì˜ˆì•½ íŒŒì‹± ë° ê´€ë¦¬</h2>
                    <div>
                        <button class="btn btn-outline-info me-2" onclick="openRulesModal()">
                            <i class="fas fa-cog me-1"></i>ìë™ ì„¤ì • ê·œì¹™
                        </button>
                        <button class="btn btn-outline-primary me-2" onclick="clearAll()">
                            <i class="fas fa-broom me-1"></i>ì „ì²´ ì´ˆê¸°í™”
                        </button>
                    </div>
                </div>

                <!-- ì—¬í–‰ì‚¬ ì„ íƒ ì œê±° -->

                <!-- íŒŒì‹± ì˜ì—­ -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h6><i class="fas fa-paste me-2"></i>ì˜ˆì•½ ë°ì´í„° íŒŒì‹±</h6>
                        <form id="parseForm">
                            <div class="mb-3">
                                <textarea class="form-control" id="reservationText" rows="8" 
                                        placeholder="ì˜ˆì•½ í™•ì¸ì„œ ë‚´ìš©ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-primary" onclick="parseReservation()">
                                    <i class="fas fa-robot me-1"></i>AI íŒŒì‹±
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="clearForm()">
                                    <i class="fas fa-eraser me-1"></i>ì´ˆê¸°í™”
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- íŒŒì‹± ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
                <div id="previewArea" class="card mb-4" style="display: none;">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-eye me-2"></i>íŒŒì‹± ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°</h6>
                            <div>
                                <span id="confidenceBadge" class="badge"></span>
                                <span id="parsingMethodBadge" class="badge bg-info ms-2"></span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- ì˜ˆì•½ ì •ë³´ ì„¹ì…˜ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2"><i class="fas fa-info-circle me-2"></i>ì˜ˆì•½ ì •ë³´</h6>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ì˜ˆì•½ë²ˆí˜¸</label>
                                <input type="text" class="form-control" id="reservation_number" name="reservation_number">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ì—…ì²´ëª…</label>
                                <input type="text" class="form-control" id="platform_name" name="platform_name">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ì˜ˆì•½ ìƒíƒœ</label>
                                <select class="form-control" id="payment_status" name="payment_status">
                                    <option value="pending" selected>ëŒ€ê¸°ì¤‘ (ì‹ ê·œì˜ˆì•½)</option>
                                    <option value="confirmed">í™•ì • (ìˆ˜ë°°ì™„ë£Œ)</option>
                                    <option value="cancelled">ì˜ˆì•½ì·¨ì†Œ</option>
                                    <option value="refunded">í™˜ë¶ˆì™„ë£Œ</option>
                                </select>
                            </div>
                            <div class="col-md-8 mb-3">
                                <label class="form-label">ìƒí’ˆëª…</label>
                                <input type="text" class="form-control" id="product_name" name="product_name">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">íŒ¨í‚¤ì§€ íƒ€ì… (ìƒí’ˆ ì˜µì…˜)</label>
                                <input type="text" class="form-control" id="package_type" name="package_type" placeholder="ì˜ˆ: 1ì°¨ (ì„ ì…‹ & ë³„ë¹›íˆ¬ì–´), ì˜¤ì „ íˆ¬ì–´, í”½ì—… í¬í•¨ ë“±">
                            </div>
                        </div>

                        <!-- ì¼ì • ì •ë³´ ì„¹ì…˜ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2"><i class="fas fa-calendar me-2"></i>ì¼ì • ì •ë³´</h6>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ì´ìš©ì¼</label>
                                <input type="date" class="form-control" id="tour_date" name="tour_date">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ì´ìš©ì‹œê°„</label>
                                <input type="time" class="form-control" id="tour_time" name="tour_time">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ì˜ˆì•½ì¼ì‹œ</label>
                                <input type="datetime-local" class="form-control" id="booking_date" name="booking_date">
                            </div>
                        </div>

                        <!-- ì˜ˆì•½ì ì •ë³´ ì„¹ì…˜ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2"><i class="fas fa-user me-2"></i>ì˜ˆì•½ì ì •ë³´</h6>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">í•œê¸€ëª…</label>
                                <input type="text" class="form-control" id="customer_name" name="customer_name">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">ì˜ë¬¸ ì„±</label>
                                <input type="text" class="form-control" id="customer_lastname" name="customer_lastname">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">ì˜ë¬¸ ì´ë¦„</label>
                                <input type="text" class="form-control" id="customer_firstname" name="customer_firstname">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">ì „í™”ë²ˆí˜¸</label>
                                <input type="tel" class="form-control" id="customer_phone" name="customer_phone">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ì´ë©”ì¼</label>
                                <input type="email" class="form-control" id="customer_email" name="customer_email">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ì¹´ì¹´ì˜¤ID</label>
                                <input type="text" class="form-control" id="kakao_id" name="kakao_id">
                            </div>
                        </div>

                        <!-- ì¸ì› ë° ê¸ˆì•¡ ì •ë³´ ì„¹ì…˜ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2"><i class="fas fa-users me-2"></i>ì¸ì› ë° ê¸ˆì•¡ ì •ë³´</h6>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">ì„±ì¸ ìˆ˜</label>
                                <input type="number" class="form-control" id="adult_count" name="adult_count" min="0" onchange="calculateTotal()">
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">ì„±ì¸ ë‹¨ê°€</label>
                                <input type="number" class="form-control" id="adult_price" name="adult_price" min="0" step="0.01" onchange="calculateTotal()">
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">ì•„ë™ ìˆ˜</label>
                                <input type="number" class="form-control" id="child_count" name="child_count" min="0" onchange="calculateTotal()">
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">ì•„ë™ ë‹¨ê°€</label>
                                <input type="number" class="form-control" id="child_price" name="child_price" min="0" step="0.01" onchange="calculateTotal()">
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">ìœ ì•„ ìˆ˜</label>
                                <input type="number" class="form-control" id="infant_count" name="infant_count" min="0" onchange="calculateTotal()">
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">ìœ ì•„ ë‹¨ê°€</label>
                                <input type="number" class="form-control" id="infant_price" name="infant_price" min="0" step="0.01" onchange="calculateTotal()">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ì´ ì¸ì›</label>
                                <input type="number" class="form-control" id="total_guests" name="total_guests" min="0" readonly style="background-color: #f8f9fa;">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ì´ ê¸ˆì•¡</label>
                                <input type="number" class="form-control" id="total_amount" name="total_amount" step="0.01" readonly style="background-color: #f8f9fa;">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ê³„ì‚°ì‹</label>
                                <input type="text" class="form-control" id="calculation_formula" readonly style="background-color: #f8f9fa; font-size: 0.9em;">
                            </div>
                        </div>

                        <!-- ë©”ëª¨ ì„¹ì…˜ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2"><i class="fas fa-sticky-note me-2"></i>ë©”ëª¨</h6>
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label">íŠ¹ì´ì‚¬í•­ ë° ìš”ì²­ì‚¬í•­</label>
                                <textarea class="form-control" id="special_requests" name="special_requests" rows="4"></textarea>
                            </div>
                        </div>

                        <!-- ì•¡ì…˜ ë²„íŠ¼ -->
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-success" onclick="saveReservation()">
                                <i class="fas fa-save me-1"></i>ì˜ˆì•½ ì €ì¥
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="editRawData()">
                                <i class="fas fa-edit me-1"></i>ë‹¤ì‹œ ìˆ˜ì •
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="clearPreview()">
                                <i class="fas fa-times me-1"></i>ì·¨ì†Œ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ìë™ ì„¤ì • ê·œì¹™ ëª¨ë‹¬ -->
    <div class="modal fade" id="rulesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-magic me-2"></i>ìë™ ì„¤ì • ê·œì¹™ ê´€ë¦¬</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-box me-2"></i>ìƒí’ˆë³„ ìë™ ìƒíƒœ ì„¤ì •</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>í‚¤ì›Œë“œ</th>
                                            <th>ìë™ ìƒíƒœ</th>
                                            <th>ì´ìœ </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><code>ë¡±í˜¼ìŠ¤í…Œì´í¬</code></td>
                                            <td><span class="badge bg-info">í™•ì •</span></td>
                                            <td>ìˆ˜ë°° ë¶ˆí•„ìš”</td>
                                        </tr>
                                        <tr>
                                            <td><code>ë¡±í˜¼</code></td>
                                            <td><span class="badge bg-info">í™•ì •</span></td>
                                            <td>ìˆ˜ë°° ë¶ˆí•„ìš”</td>
                                        </tr>
                                        <tr>
                                            <td><code>ë ˆìŠ¤í† ë‘</code></td>
                                            <td><span class="badge bg-info">í™•ì •</span></td>
                                            <td>ìˆ˜ë°° ë¶ˆí•„ìš”</td>
                                        </tr>
                                        <tr>
                                            <td><code>ì‹ë‹¹</code></td>
                                            <td><span class="badge bg-info">í™•ì •</span></td>
                                            <td>ìˆ˜ë°° ë¶ˆí•„ìš”</td>
                                        </tr>
                                        <tr>
                                            <td><code>ì¹´í˜</code></td>
                                            <td><span class="badge bg-info">í™•ì •</span></td>
                                            <td>ìˆ˜ë°° ë¶ˆí•„ìš”</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-building me-2"></i>ì—…ì²´ë³„ ìë™ ì„¤ì •</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>ì—…ì²´ëª…</th>
                                            <th>ìë™ ì„¤ì •</th>
                                            <th>ì„¤ëª…</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><code>íˆ¬ì–´ë¹„ìŠ¤</code></td>
                                            <td><span class="badge bg-success">ì¸ì›ìˆ˜ ìë™</span></td>
                                            <td>ì˜ˆì•½ ê±´ìˆ˜ = ì„±ì¸ ì¸ì›ìˆ˜</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>ìë™ ì„¤ì • ê·œì¹™ ì‘ë™ ë°©ì‹</h6>
                        <ul class="mb-0">
                            <li><strong>ìƒí’ˆëª… í‚¤ì›Œë“œ ë§¤ì¹­</strong>: ìƒí’ˆëª…ì— í‚¤ì›Œë“œê°€ í¬í•¨ë˜ë©´ ìë™ìœ¼ë¡œ ìƒíƒœ ë³€ê²½</li>
                            <li><strong>ì—…ì²´ë³„ íŠ¹ë³„ ì²˜ë¦¬</strong>: íŠ¹ì • ì—…ì²´ì˜ ì˜ˆì•½ì€ íŠ¹ë³„í•œ ë¡œì§ ì ìš©</li>
                            <li><strong>ìš°ì„ ìˆœìœ„</strong>: íŠ¹ë³„ ê·œì¹™ > ê¸°ë³¸ "ëŒ€ê¸°ì¤‘" ìƒíƒœ</li>
                            <li><strong>ì•Œë¦¼</strong>: ìë™ ì„¤ì •ì´ ì ìš©ë˜ë©´ íŒŒë€ìƒ‰ ì•Œë¦¼ìœ¼ë¡œ í‘œì‹œ</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    <button type="button" class="btn btn-primary" onclick="addCustomRule()">
                        <i class="fas fa-plus me-1"></i>ìƒˆ ê·œì¹™ ì¶”ê°€
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let parsedData = null;

        // ì˜ˆì•½ íŒŒì‹± (ì—¬í–‰ì‚¬ ì„ íƒ ì œê±°)
        async function parseReservation() {
            const text = document.getElementById('reservationText').value.trim();
            
            if (!text) {
                alert('ì˜ˆì•½ ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch('/admin/reservations/parse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        reservationText: text
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    parsedData = result.parsed_data;
                    showPreview(result);
                } else {
                    alert('íŒŒì‹± ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                console.error('íŒŒì‹± ì˜¤ë¥˜:', error);
                alert('íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ í‘œì‹œ
        function showPreview(result) {
            const previewArea = document.getElementById('previewArea');
            const confidenceBadge = document.getElementById('confidenceBadge');
            const parsingMethodBadge = document.getElementById('parsingMethodBadge');
            
            // ì‹ ë¢°ë„ ë°°ì§€
            const confidence = result.confidence || 0.5;
            confidenceBadge.textContent = `ì‹ ë¢°ë„ ${Math.round(confidence * 100)}%`;
            confidenceBadge.className = confidence > 0.8 ? 'badge bg-success' : 
                                      confidence > 0.6 ? 'badge bg-warning' : 'badge bg-danger';

            // íŒŒì‹± ë°©ë²• ë°°ì§€
            parsingMethodBadge.textContent = result.parsing_method || 'OpenAI';

            // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
            fillPreviewForm(parsedData);
            
            previewArea.style.display = 'block';
            previewArea.scrollIntoView({ behavior: 'smooth' });
        }

        // ë¯¸ë¦¬ë³´ê¸° í¼ì— ë°ì´í„° ì±„ìš°ê¸°
        function fillPreviewForm(data) {
            console.log('ğŸ“‹ íŒŒì‹±ëœ ë°ì´í„°:', data);
            
            // ì—…ì²´ëª… ì¶”ì¶œ í•¨ìˆ˜ (íŒë§¤ì±„ë„/ì—…ì²´ëª…/í”Œë«í¼ ì¤‘ ìš°ì„ ìˆœìœ„)
            function extractCompanyName(data) {
                // ìš°ì„ ìˆœìœ„: platform_name > channel > company
                const candidates = [
                    data.platform_name,
                    data.channel, 
                    data.company,
                    data.vendor,
                    data.agency
                ];
                
                for (let name of candidates) {
                    if (name && name.trim() && name !== 'OTHER' && name !== 'UNKNOWN') {
                        // ë°”ìŠ¤ì½”/ëŸ­ìŠ¤íŒŒì¸ë“œ ì œì™¸
                        const excludeCompanies = ['ë°”ìŠ¤ì½”', 'vasco', 'VASCO', 'ëŸ­ìŠ¤íŒŒì¸ë“œ', 'luxfind', 'LUXFIND'];
                        const lowerName = name.toLowerCase();
                        
                        let isExcluded = false;
                        for (let company of excludeCompanies) {
                            if (lowerName.includes(company.toLowerCase())) {
                                isExcluded = true;
                                break;
                            }
                        }
                        
                        if (!isExcluded) {
                            return name.trim();
                        }
                    }
                }
                return '';
            }
            
            // ë‚ ì§œ í˜•ì‹ ë³€í™˜ í•¨ìˆ˜
            function formatDate(dateStr) {
                if (!dateStr) return '';
                try {
                    // ë‹¤ì–‘í•œ ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬
                    let date = new Date(dateStr);
                    if (isNaN(date.getTime())) {
                        // í•œêµ­ì–´ ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬ (ì˜ˆ: 2025-09-13)
                        const match = dateStr.match(/(\d{4})-(\d{1,2})-(\d{1,2})/);
                        if (match) {
                            date = new Date(match[1], match[2] - 1, match[3]);
                        }
                    }
                    return date.toISOString().split('T')[0];
                } catch (e) {
                    return '';
                }
            }
            
            // ì‹œê°„ í˜•ì‹ ë³€í™˜ í•¨ìˆ˜
            function formatTime(timeStr) {
                if (!timeStr) return '';
                try {
                    const match = timeStr.match(/(\d{1,2}):(\d{2})/);
                    if (match) {
                        return `${match[1].padStart(2, '0')}:${match[2]}`;
                    }
                } catch (e) {
                    return '';
                }
                return '';
            }
            
            // ë‚ ì§œì‹œê°„ í˜•ì‹ ë³€í™˜ í•¨ìˆ˜
            function formatDateTime(dateTimeStr) {
                if (!dateTimeStr) return '';
                try {
                    const date = new Date(dateTimeStr);
                    if (!isNaN(date.getTime())) {
                        return date.toISOString().slice(0, 16);
                    }
                } catch (e) {
                    return '';
                }
                return '';
            }

            // ëª¨ë“  í•„ë“œ ë§¤í•‘ (AI íŒŒì„œ í•„ë“œëª… â†’ í¼ í•„ë“œëª…)
            const fieldMappings = {
                'reservation_number': data.reservation_number || data.booking_reference || data.order_number || '',
                'platform_name': extractCompanyName(data),
                'payment_status': data.payment_status || 'confirmed',
                'product_name': data.product_name || data.tour_name || data.service_name || '',
                'package_type': data.package_type || data.package || data.option || '',
                'tour_date': formatDate(data.usage_date || data.tour_date || data.date || data.service_date || ''),
                'tour_time': formatTime(data.usage_time || data.tour_time || data.time || data.service_time || ''),
                'booking_date': formatDateTime(data.reservation_datetime || data.booking_date || data.created_at || data.reservation_date || ''),
                'customer_name': data.korean_name || data.customer_name || data.name || data.guest_name || '',
                'customer_lastname': data.english_last_name || data.customer_lastname || data.last_name || data.surname || '',
                'customer_firstname': data.english_first_name || data.customer_firstname || data.first_name || data.given_name || '',
                'customer_phone': data.phone || data.customer_phone || data.mobile || data.contact || '',
                'customer_email': data.email || data.customer_email || '',
                'kakao_id': data.kakao_id || data.kakao || data.kakao_talk || data.kakaotalk || '',
                'adult_count': parseInt(data.people_adult || data.adult_count || data.adults || data.adult || 0),
                'child_count': parseInt(data.people_child || data.child_count || data.children || data.child || 0),
                'infant_count': parseInt(data.people_infant || data.infant_count || data.infants || data.infant || 0),
                'adult_price': parseFloat(data.adult_unit_price || data.adult_price || data.adult_amount || 0),
                'child_price': parseFloat(data.child_unit_price || data.child_price || data.child_amount || 0),
                'infant_price': parseFloat(data.infant_price || data.infant_amount || 0),
                'special_requests': data.memo || data.special_requests || data.notes || data.remarks || ''
            };

            // í¼ í•„ë“œì— ê°’ ì„¤ì •
            Object.entries(fieldMappings).forEach(([fieldId, value]) => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.value = value || '';
                    
                    // ë¹ˆ ê°’ì´ê±°ë‚˜ nullì¸ ê²½ìš° ê²½ê³  ìŠ¤íƒ€ì¼ ì ìš©
                    if (!value || value === 'null' || value === '-' || value === 0) {
                        element.classList.add('border-warning');
                        element.style.backgroundColor = '#fff3cd';
                    } else {
                        element.classList.remove('border-warning');
                        element.style.backgroundColor = '';
                    }
                }
            });

            // íŠ¹ë³„ ì„¤ì • ê·œì¹™ ì ìš©
            applySpecialRules(fieldMappings);

            // ê¸°ë³¸ì ìœ¼ë¡œëŠ” "ëŒ€ê¸°ì¤‘ (ì‹ ê·œì˜ˆì•½)" ìƒíƒœ (íŠ¹ë³„ ê·œì¹™ì´ ì—†ëŠ” ê²½ìš°)
            const paymentStatusElement = document.getElementById('payment_status');
            if (paymentStatusElement && paymentStatusElement.value === 'pending') {
                paymentStatusElement.classList.remove('border-warning');
                paymentStatusElement.style.backgroundColor = '#fff3cd'; // ëŒ€ê¸°ì¤‘ ìƒ‰ìƒìœ¼ë¡œ ê°•ì¡°
            }

            // ì´ ì¸ì› ë° ê¸ˆì•¡ ê³„ì‚°
            calculateTotal();
        }

        // íŠ¹ë³„ ì„¤ì • ê·œì¹™ ì ìš©
        function applySpecialRules(fieldMappings) {
            const productName = fieldMappings.product_name || '';
            const platformName = fieldMappings.platform_name || '';
            const memo = fieldMappings.special_requests || '';
            
            // ğŸ¯ ìƒí’ˆë³„ íŠ¹ë³„ ê·œì¹™
            const productRules = {
                // ë¡±í˜¼ìŠ¤í…Œì´í¬ í•˜ìš°ìŠ¤ - ìˆ˜ë°° ë¶ˆí•„ìš”, ë°”ë¡œ í™•ì •
                'ë¡±í˜¼ìŠ¤í…Œì´í¬': { status: 'confirmed', reason: 'ìˆ˜ë°° ë¶ˆí•„ìš” ìƒí’ˆ' },
                'ë¡±í˜¼': { status: 'confirmed', reason: 'ìˆ˜ë°° ë¶ˆí•„ìš” ìƒí’ˆ' },
                'longhorn': { status: 'confirmed', reason: 'ìˆ˜ë°° ë¶ˆí•„ìš” ìƒí’ˆ' },
                
                // ê¸°íƒ€ ìˆ˜ë°° ë¶ˆí•„ìš” ìƒí’ˆë“¤
                'ë ˆìŠ¤í† ë‘': { status: 'confirmed', reason: 'ìˆ˜ë°° ë¶ˆí•„ìš” ìƒí’ˆ' },
                'ì‹ë‹¹': { status: 'confirmed', reason: 'ìˆ˜ë°° ë¶ˆí•„ìš” ìƒí’ˆ' },
                'ë§›ì§‘': { status: 'confirmed', reason: 'ìˆ˜ë°° ë¶ˆí•„ìš” ìƒí’ˆ' },
                'ì¹´í˜': { status: 'confirmed', reason: 'ìˆ˜ë°° ë¶ˆí•„ìš” ìƒí’ˆ' }
            };

            // ğŸ¯ ì—…ì²´ë³„ íŠ¹ë³„ ê·œì¹™
            const platformRules = {
                'íˆ¬ì–´ë¹„ìŠ¤': { 
                    countRule: 'booking_to_people', // ì˜ˆì•½ ê±´ìˆ˜ = ì¸ì›ìˆ˜
                    reason: 'íˆ¬ì–´ë¹„ìŠ¤ ì˜ˆì•½ ê±´ìˆ˜ = ì¸ì›ìˆ˜'
                }
            };

            // ìƒí’ˆëª… ê¸°ë°˜ ê·œì¹™ ì ìš©
            Object.keys(productRules).forEach(keyword => {
                if (productName.toLowerCase().includes(keyword.toLowerCase())) {
                    const rule = productRules[keyword];
                    
                    if (rule.status) {
                        const statusElement = document.getElementById('payment_status');
                        if (statusElement) {
                            statusElement.value = rule.status;
                            statusElement.style.backgroundColor = rule.status === 'confirmed' ? '#d1ecf1' : '#fff3cd';
                            
                            // ê·œì¹™ ì ìš© ì•Œë¦¼ í‘œì‹œ
                            showRuleNotification(`ğŸ¯ ìë™ ì„¤ì •: ${rule.reason} â†’ ${getStatusText(rule.status)}`);
                        }
                    }
                }
            });

            // ì—…ì²´ë³„ ê·œì¹™ ì ìš©
            Object.keys(platformRules).forEach(platform => {
                if (platformName.toLowerCase().includes(platform.toLowerCase())) {
                    const rule = platformRules[platform];
                    
                    if (rule.countRule === 'booking_to_people') {
                        // ë©”ëª¨ë‚˜ ìƒí’ˆëª…ì—ì„œ ìˆ«ì ì¶”ì¶œí•˜ì—¬ ì¸ì›ìˆ˜ë¡œ ì„¤ì •
                        const numbers = extractNumbers(memo + ' ' + productName);
                        if (numbers.length > 0) {
                            const adultCountElement = document.getElementById('adult_count');
                            if (adultCountElement && !adultCountElement.value) {
                                adultCountElement.value = numbers[0];
                                adultCountElement.style.backgroundColor = '#d1ecf1';
                                
                                showRuleNotification(`ğŸ¯ ìë™ ì„¤ì •: ${rule.reason} â†’ ì„±ì¸ ${numbers[0]}ëª…`);
                            }
                        }
                    }
                }
            });
        }

        // ìˆ«ì ì¶”ì¶œ í•¨ìˆ˜
        function extractNumbers(text) {
            const matches = text.match(/\d+/g);
            return matches ? matches.map(num => parseInt(num)).filter(num => num > 0 && num <= 50) : [];
        }

        // ê·œì¹™ ì ìš© ì•Œë¦¼ í‘œì‹œ
        function showRuleNotification(message) {
            // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
            const existingNotification = document.querySelector('.rule-notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // ìƒˆ ì•Œë¦¼ ìƒì„±
            const notification = document.createElement('div');
            notification.className = 'rule-notification alert alert-info alert-dismissible fade show mt-2';
            notification.style.cssText = 'position: relative; z-index: 1000;';
            notification.innerHTML = `
                <i class="fas fa-magic me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            // ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ ìƒë‹¨ì— ì¶”ê°€
            const previewArea = document.getElementById('previewArea');
            previewArea.insertBefore(notification, previewArea.firstChild);

            // 5ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // ìë™ ì„¤ì • ê·œì¹™ ëª¨ë‹¬ ì—´ê¸°
        function openRulesModal() {
            const modal = new bootstrap.Modal(document.getElementById('rulesModal'));
            modal.show();
        }

        // ìƒˆ ê·œì¹™ ì¶”ê°€ (í–¥í›„ í™•ì¥ ê°€ëŠ¥)
        function addCustomRule() {
            alert('ìƒˆ ê·œì¹™ ì¶”ê°€ ê¸°ëŠ¥ì€ í–¥í›„ ì—…ë°ì´íŠ¸ì—ì„œ ì œê³µë©ë‹ˆë‹¤.\ní˜„ì¬ëŠ” ì½”ë“œì—ì„œ ì§ì ‘ ê·œì¹™ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }

        // ì´ ì¸ì› ë° ê¸ˆì•¡ ê³„ì‚°
        function calculateTotal() {
            const adultCount = parseInt(document.getElementById('adult_count').value) || 0;
            const childCount = parseInt(document.getElementById('child_count').value) || 0;
            const infantCount = parseInt(document.getElementById('infant_count').value) || 0;
            
            const adultPrice = parseFloat(document.getElementById('adult_price').value) || 0;
            const childPrice = parseFloat(document.getElementById('child_price').value) || 0;
            const infantPrice = parseFloat(document.getElementById('infant_price').value) || 0;
            
            // ì´ ì¸ì› ê³„ì‚°
            const totalGuests = adultCount + childCount + infantCount;
            document.getElementById('total_guests').value = totalGuests;
            
            // ì´ ê¸ˆì•¡ ê³„ì‚°
            const adultTotal = adultCount * adultPrice;
            const childTotal = childCount * childPrice;
            const infantTotal = infantCount * infantPrice;
            const totalAmount = adultTotal + childTotal + infantTotal;
            
            document.getElementById('total_amount').value = totalAmount.toFixed(2);
            
            // ê³„ì‚°ì‹ í‘œì‹œ
            let formula = [];
            if (adultCount > 0) formula.push(`ì„±ì¸ ${adultCount}ëª…Ã—$${adultPrice}`);
            if (childCount > 0) formula.push(`ì•„ë™ ${childCount}ëª…Ã—$${childPrice}`);
            if (infantCount > 0) formula.push(`ìœ ì•„ ${infantCount}ëª…Ã—$${infantPrice}`);
            
            const formulaText = formula.length > 0 ? formula.join(' + ') + ` = $${totalAmount.toFixed(2)}` : '';
            document.getElementById('calculation_formula').value = formulaText;
        }

        // ì¸ì› ìˆ˜ ë° ê°€ê²© ë³€ê²½ ì‹œ ì¬ê³„ì‚° - í˜ì´ì§€ ë¡œë“œ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.addEventListener('DOMContentLoaded', function() {
            ['adult_count', 'child_count', 'infant_count', 'adult_price', 'child_price', 'infant_price'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', calculateTotal);
                    element.addEventListener('change', calculateTotal);
                }
            });
        });

        // ì˜ˆì•½ ì €ì¥
        async function saveReservation() {
            if (!parsedData) return;

            // í¼ì—ì„œ ëª¨ë“  ê°’ë“¤ ìˆ˜ì§‘í•˜ê³  í•„ë“œëª… ë§¤í•‘
            const formData = {};
            document.querySelectorAll('#previewArea input, #previewArea select, #previewArea textarea').forEach(element => {
                if (element.name) {
                    formData[element.name] = element.value;
                }
            });

            // í•„ë“œëª…ì„ DB ìŠ¤í‚¤ë§ˆì— ë§ê²Œ ë§¤í•‘
            const mappedData = {
                reservation_number: formData.reservation_number,
                platform_name: formData.platform_name,
                payment_status: 'pending', // íŒŒì‹±ëœ ì˜ˆì•½ì€ í•­ìƒ ëŒ€ê¸°ì¤‘ ìƒíƒœë¡œ ì‹œì‘
                product_name: formData.product_name,
                package_type: formData.package_type,
                usage_date: formData.tour_date,
                usage_time: formData.tour_time,
                reservation_datetime: formData.booking_date ? formData.booking_date.replace('T', ' ') : null,
                korean_name: formData.customer_name,
                english_last_name: formData.customer_lastname,
                english_first_name: formData.customer_firstname,
                phone: formData.customer_phone,
                email: formData.customer_email,
                kakao_id: formData.kakao_id,
                people_adult: parseInt(formData.adult_count) || 1,
                people_child: parseInt(formData.child_count) || 0,
                people_infant: parseInt(formData.infant_count) || 0,
                adult_unit_price: parseFloat(formData.adult_price) || null,
                child_unit_price: parseFloat(formData.child_price) || null,
                memo: formData.special_requests,
                channel: 'inbox',
                guest_count: (parseInt(formData.adult_count) || 1) + (parseInt(formData.child_count) || 0) + (parseInt(formData.infant_count) || 0)
            };

            try {
                const response = await fetch('/api/reservations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(mappedData)
                });

                const result = await response.json();
                
                if (result.success || response.ok) {
                    alert('ì˜ˆì•½ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    clearForm();
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ë‹¤ì‹œ ìˆ˜ì •
        function editRawData() {
            document.getElementById('previewArea').style.display = 'none';
            document.getElementById('reservationText').focus();
        }

        // ë¯¸ë¦¬ë³´ê¸° ì·¨ì†Œ
        function clearPreview() {
            document.getElementById('previewArea').style.display = 'none';
            parsedData = null;
        }

        // í¼ ì´ˆê¸°í™”
        function clearForm() {
            document.getElementById('reservationText').value = '';
            document.getElementById('previewArea').style.display = 'none';
            parsedData = null;
        }

        // ìƒˆë¡œê³ ì¹¨
        function refreshInbox() {
            location.reload();
        }
    </script>
</body>
</html>
