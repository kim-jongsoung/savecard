
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¸ë°•ìŠ¤ - ê´Œì„¸ì´ë¸Œì¹´ë“œ ê´€ë¦¬ì</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* PC í™”ë©´ì—ì„œ ê°€ë¡œí­ 1200px ê³ ì • */
        @media (min-width: 1200px) {
            .container-fluid {
                max-width: 1200px;
                margin: 0 auto;
            }
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar', { currentPage: 'inbox', adminUsername: adminUsername }) %>
    
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-inbox me-2"></i>ì¸ë°•ìŠ¤ - ì˜ˆì•½ íŒŒì‹± ë° ê´€ë¦¬</h2>
                    <div>
                        <button class="btn btn-success me-2" onclick="openBookmarkletModal()">
                            <i class="fas fa-bookmark me-1"></i>ë¶ë§ˆí´ë¦¿ ì„¤ì¹˜
                        </button>
                        <button class="btn btn-primary" onclick="openRulesModal()">
                            <i class="fas fa-cogs me-1"></i>íŒŒì‹± ê·œì¹™ ì„¤ì •
                        </button>
                    </div>
                </div>

                <!-- ì—¬í–‰ì‚¬ ì„ íƒ ì œê±° -->

                <!-- íŒŒì‹± ì˜ì—­ -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h6><i class="fas fa-paste me-2"></i>ì˜ˆì•½ ë°ì´í„° íŒŒì‹±</h6>
                        <form id="parseForm">
                            <div class="mb-3">
                                <textarea class="form-control" id="reservationText" rows="8" 
                                        placeholder="ì˜ˆì•½ í™•ì¸ì„œ ë‚´ìš©ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
                            </div>
                            <div class="d-flex gap-2 justify-content-between">
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" id="parseBtn" onclick="parseReservation()">
                                        <i class="fas fa-robot me-1"></i>
                                        <span id="parseBtnText">AI íŒŒì‹±</span>
                                        <span id="parseBtnSpinner" class="spinner-border spinner-border-sm ms-1" style="display: none;" role="status" aria-hidden="true"></span>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="clearForm()">
                                        <i class="fas fa-eraser me-1"></i>ì´ˆê¸°í™”
                                    </button>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="openParsingSettings()">
                                    <i class="fas fa-cog me-1"></i>AI íŒŒì‹± ì„¤ì •
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- íŒŒì‹± ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
                <div id="previewArea" class="card mb-4" style="display: none;">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-eye me-2"></i>íŒŒì‹± ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°</h6>
                            <div>
                                <span id="confidenceBadge" class="badge"></span>
                                <span id="parsingMethodBadge" class="badge bg-info ms-2"></span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- ì˜ˆì•½ ì •ë³´ ì„¹ì…˜ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2"><i class="fas fa-info-circle me-2"></i>ì˜ˆì•½ ì •ë³´</h6>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ì˜ˆì•½ë²ˆí˜¸</label>
                                <input type="text" class="form-control" id="reservation_number" name="reservation_number">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ì—…ì²´ëª…</label>
                                <input type="text" class="form-control" id="platform_name" name="platform_name" placeholder="ì˜ˆ: KLOOK, ë…¸ì„íˆ¬ì–´, ê´Œíˆ¬ì–´ ë“±">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ì˜ˆì•½ ìƒíƒœ</label>
                                <select class="form-control" id="payment_status" name="payment_status">
                                    <option value="pending" selected>ëŒ€ê¸°ì¤‘ (ì‹ ê·œì˜ˆì•½)</option>
                                    <option value="in_progress">ìˆ˜ë°°ì¤‘ (í˜„ì§€ìˆ˜ë°°)</option>
                                    <option value="confirmed">í™•ì • (ìˆ˜ë°°ì™„ë£Œ)</option>
                                    <option value="cancelled">ì˜ˆì•½ì·¨ì†Œ</option>
                                    <option value="refunded">í™˜ë¶ˆì™„ë£Œ</option>
                                </select>
                            </div>
                            <div class="col-md-8 mb-3">
                                <label class="form-label">ìƒí’ˆëª…</label>
                                <input type="text" class="form-control" id="product_name" name="product_name" onchange="matchVendorByProductOnChange()">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">íŒ¨í‚¤ì§€ íƒ€ì… (ìƒí’ˆ ì˜µì…˜)</label>
                                <input type="text" class="form-control" id="package_type" name="package_type" placeholder="ì˜ˆ: 1ì°¨ (ì„ ì…‹ & ë³„ë¹›íˆ¬ì–´), ì˜¤ì „ íˆ¬ì–´, í”½ì—… í¬í•¨ ë“±">
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">
                                    <i class="bi bi-building me-1"></i>ìˆ˜ë°°ì—…ì²´ 
                                    <span class="badge bg-info" id="vendor-match-badge" style="display: none;">ìë™ ë§¤ì¹­ë¨</span>
                                </label>
                                <select class="form-control" id="vendor_id" name="vendor_id">
                                    <option value="">ë¯¸ì§€ì •</option>
                                </select>
                                <small class="text-muted">ìƒí’ˆëª…ì„ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ë§¤ì¹­ë©ë‹ˆë‹¤. ì§ì ‘ ì„ íƒë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.</small>
                            </div>
                        </div>

                        <!-- ì¼ì • ì •ë³´ ì„¹ì…˜ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2"><i class="fas fa-calendar me-2"></i>ì¼ì • ì •ë³´</h6>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ì´ìš©ì¼</label>
                                <input type="date" class="form-control" id="tour_date" name="tour_date">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ì´ìš©ì‹œê°„</label>
                                <input type="time" class="form-control" id="tour_time" name="tour_time">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ì˜ˆì•½ì¼ì‹œ</label>
                                <input type="datetime-local" class="form-control" id="booking_date" name="booking_date">
                            </div>
                        </div>

                        <!-- ì˜ˆì•½ì ì •ë³´ ì„¹ì…˜ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2"><i class="fas fa-user me-2"></i>ì˜ˆì•½ì ì •ë³´</h6>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">í•œê¸€ëª…</label>
                                <input type="text" class="form-control" id="customer_name" name="customer_name">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">ì˜ë¬¸ ì„±</label>
                                <input type="text" class="form-control" id="customer_lastname" name="customer_lastname">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">ì˜ë¬¸ ì´ë¦„</label>
                                <input type="text" class="form-control" id="customer_firstname" name="customer_firstname">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">ì „í™”ë²ˆí˜¸</label>
                                <input type="tel" class="form-control" id="customer_phone" name="customer_phone">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ì´ë©”ì¼</label>
                                <input type="email" class="form-control" id="customer_email" name="customer_email">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ì¹´ì¹´ì˜¤ID</label>
                                <input type="text" class="form-control" id="kakao_id" name="kakao_id">
                            </div>
                        </div>

                        <!-- ì¸ì› ë° ê¸ˆì•¡ ì •ë³´ ì„¹ì…˜ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2"><i class="fas fa-users me-2"></i>ì¸ì› ë° ê¸ˆì•¡ ì •ë³´</h6>
                            </div>
                            
                            <!-- ì„±ì¸ -->
                            <div class="col-12 mb-2">
                                <div class="row g-2 align-items-end">
                                    <div class="col-md-1">
                                        <span class="badge bg-primary">ì„±ì¸</span>
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label small">ì¸ì›</label>
                                        <input type="number" class="form-control form-control-sm" id="adult_count" name="adult_count" min="0" placeholder="2" onchange="calculateTotal()">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">íŒë§¤ê°€</label>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="adult_price" name="adult_price" min="0" step="0.01" placeholder="19900" onchange="calculateTotal()">
                                            <select class="form-select" id="adult_currency" name="adult_currency" style="max-width: 70px;" onchange="calculateTotal()">
                                                <option value="KRW">â‚©</option>
                                                <option value="USD">$</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">ì›ê°€</label>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="adult_cost" name="adult_cost" min="0" step="0.01" placeholder="10000" onchange="calculateTotal()">
                                            <select class="form-select" id="adult_cost_currency" name="adult_cost_currency" style="max-width: 70px;" onchange="calculateTotal()">
                                                <option value="KRW">â‚©</option>
                                                <option value="USD">$</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">ë§ˆì§„</label>
                                        <input type="text" class="form-control form-control-sm fw-bold" id="adult_margin" readonly style="background-color: #e7f3ff;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ì†Œì•„ -->
                            <div class="col-12 mb-2">
                                <div class="row g-2 align-items-end">
                                    <div class="col-md-1">
                                        <span class="badge bg-info">ì†Œì•„</span>
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label small">ì¸ì›</label>
                                        <input type="number" class="form-control form-control-sm" id="child_count" name="child_count" min="0" placeholder="1" onchange="calculateTotal()">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">íŒë§¤ê°€</label>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="child_price" name="child_price" min="0" step="0.01" placeholder="15000" onchange="calculateTotal()">
                                            <select class="form-select" id="child_currency" name="child_currency" style="max-width: 70px;" onchange="calculateTotal()">
                                                <option value="KRW">â‚©</option>
                                                <option value="USD">$</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">ì›ê°€</label>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="child_cost" name="child_cost" min="0" step="0.01" placeholder="8000" onchange="calculateTotal()">
                                            <select class="form-select" id="child_cost_currency" name="child_cost_currency" style="max-width: 70px;" onchange="calculateTotal()">
                                                <option value="KRW">â‚©</option>
                                                <option value="USD">$</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">ë§ˆì§„</label>
                                        <input type="text" class="form-control form-control-sm fw-bold" id="child_margin" readonly style="background-color: #d1ecf1;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ìœ ì•„ -->
                            <div class="col-12 mb-3">
                                <div class="row g-2 align-items-end">
                                    <div class="col-md-1">
                                        <span class="badge bg-warning text-dark">ìœ ì•„</span>
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label small">ì¸ì›</label>
                                        <input type="number" class="form-control form-control-sm" id="infant_count" name="infant_count" min="0" placeholder="0" onchange="calculateTotal()">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">íŒë§¤ê°€</label>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="infant_price" name="infant_price" min="0" step="0.01" placeholder="5000" onchange="calculateTotal()">
                                            <select class="form-select" id="infant_currency" name="infant_currency" style="max-width: 70px;" onchange="calculateTotal()">
                                                <option value="KRW">â‚©</option>
                                                <option value="USD">$</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">ì›ê°€</label>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="infant_cost" name="infant_cost" min="0" step="0.01" placeholder="3000" onchange="calculateTotal()">
                                            <select class="form-select" id="infant_cost_currency" name="infant_cost_currency" style="max-width: 70px;" onchange="calculateTotal()">
                                                <option value="KRW">â‚©</option>
                                                <option value="USD">$</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">ë§ˆì§„</label>
                                        <input type="text" class="form-control form-control-sm fw-bold" id="infant_margin" readonly style="background-color: #fff3cd;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- í•©ê³„ -->
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">ì´ ì¸ì›</label>
                                <input type="number" class="form-control fw-bold" id="total_guests" name="total_guests" min="0" readonly style="background-color: #f8f9fa; font-size: 1.1em;">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">ì´ ê¸ˆì•¡</label>
                                <input type="text" class="form-control fw-bold text-primary" id="total_amount" name="total_amount" readonly style="background-color: #f8f9fa; font-size: 1.1em;">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">ê³„ì‚°ì‹</label>
                                <input type="text" class="form-control" id="calculation_formula" readonly style="background-color: #f8f9fa; font-size: 0.85em;">
                            </div>
                        </div>

                        <!-- ë©”ëª¨ ì„¹ì…˜ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2"><i class="fas fa-sticky-note me-2"></i>ë©”ëª¨</h6>
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label">íŠ¹ì´ì‚¬í•­ ë° ìš”ì²­ì‚¬í•­</label>
                                <textarea class="form-control" id="special_requests" name="special_requests" rows="4"></textarea>
                            </div>
                        </div>

                        <!-- ì•¡ì…˜ ë²„íŠ¼ -->
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-success" id="saveBtn" onclick="saveReservation()">
                                <i class="fas fa-save me-1"></i>
                                <span id="saveBtnText">ì˜ˆì•½ ì €ì¥</span>
                                <span id="saveBtnSpinner" class="spinner-border spinner-border-sm ms-1" style="display: none;" role="status" aria-hidden="true"></span>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="editRawData()">
                                <i class="fas fa-edit me-1"></i>ë‹¤ì‹œ ìˆ˜ì •
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="clearPreview()">
                                <i class="fas fa-times me-1"></i>ì·¨ì†Œ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ìë™ ì„¤ì • ê·œì¹™ ëª¨ë‹¬ -->
    <div class="modal fade" id="rulesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-cogs me-2"></i>íŒŒì‹± ê·œì¹™ ì„¤ì •</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- ê¸°ë³¸ ê·œì¹™ ì œê±° - ì‚¬ìš©ì ì •ì˜ ê·œì¹™ë§Œ ì‚¬ìš© -->
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>ê·œì¹™ ì„¤ì • ì•ˆë‚´</strong><br>
                        ì•„ë˜ì—ì„œ ì§ì ‘ ì„¤ì •í•œ ê·œì¹™ë§Œ íŒŒì‹± ì‹œ ì ìš©ë©ë‹ˆë‹¤. 
                        ìƒí™©ì— ë§ê²Œ í•„ìš”í•œ ê·œì¹™ì„ ì¶”ê°€í•˜ì—¬ ì‚¬ìš©í•˜ì„¸ìš”.
                    </div>
                    
                    <hr>
                    
                    <!-- ì‚¬ìš©ì ì •ì˜ ê·œì¹™ ê´€ë¦¬ -->
                    <div class="mb-4">
                        <h6><i class="fas fa-user-cog me-2"></i>ì‚¬ìš©ì ì •ì˜ ê·œì¹™</h6>
                        
                        <!-- ìƒˆ ê·œì¹™ ì¶”ê°€ í¼ -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-plus me-2"></i>ìƒˆ ê·œì¹™ ì¶”ê°€</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label class="form-label">ì¡°ê±´ ìœ í˜•</label>
                                        <select class="form-select" id="newConditionType">
                                            <option value="product_exact">ìƒí’ˆëª… ì •í™•íˆ ì¼ì¹˜</option>
                                            <option value="product_contains">ìƒí’ˆëª… í¬í•¨</option>
                                            <option value="platform_exact">ì—…ì²´ëª… ì •í™•íˆ ì¼ì¹˜</option>
                                            <option value="platform_contains">ì—…ì²´ëª… í¬í•¨</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">ìƒí’ˆëª…/ì—…ì²´ëª…</label>
                                        <input type="text" class="form-control" id="newKeyword" placeholder="ì˜ˆ: ê´Œ ëŒí•€íˆ¬ì–´ (ìŠ¤ë…¸í´ë§ í¬í•¨)">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">ë³€ê²½ í•„ë“œ</label>
                                        <select class="form-select" id="newFieldType" onchange="updateValueOptions()">
                                            <option value="">-- í•„ë“œ ì„ íƒ --</option>
                                            <option value="payment_status">ì˜ˆì•½ ìƒíƒœ</option>
                                            <option value="adult_count">ì„±ì¸ìˆ˜ (people_adult)</option>
                                            <option value="child_count">ì•„ë™ìˆ˜ (people_child)</option>
                                            <option value="infant_count">ìœ ì•„ìˆ˜ (people_infant)</option>
                                            <option value="total_amount">ì´ ê¸ˆì•¡ (total_amount)</option>
                                            <option value="adult_price">ì„±ì¸ ë‹¨ê°€ (adult_unit_price)</option>
                                            <option value="child_price">ì•„ë™ ë‹¨ê°€ (child_unit_price)</option>
                                            <option value="platform_name">í”Œë«í¼ëª… (platform_name)</option>
                                            <option value="channel">ì—…ì²´ëª… (channel)</option>
                                            <option value="product_name">ìƒí’ˆëª… (product_name)</option>
                                            <option value="package_type">íŒ¨í‚¤ì§€ íƒ€ì… (package_type)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">ì„¤ì •ê°’</label>
                                        <select class="form-select" id="newValue" onchange="handleValueChange()">
                                            <option value="">-- ë¨¼ì € í•„ë“œë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
                                        </select>
                                        <input type="text" class="form-control mt-2" id="customValue" placeholder="ì§ì ‘ ì…ë ¥..." style="display: none;">
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <label class="form-label">ì„¤ëª…</label>
                                        <input type="text" class="form-control" id="newDescription" placeholder="ì˜ˆ: ê´Œ ëŒí•€íˆ¬ì–´ëŠ” ë°”ë¡œ í™•ì • ì²˜ë¦¬">
                                    </div>
                                    <div class="col-md-6 d-flex align-items-end">
                                        <button class="btn btn-success" onclick="addParsingRule()">
                                            <i class="fas fa-plus me-1"></i>ê·œì¹™ ì¶”ê°€
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ê¸°ì¡´ ê·œì¹™ ëª©ë¡ -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-list me-2"></i>ì„¤ì •ëœ ê·œì¹™ ëª©ë¡</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm" id="parsingRulesTable">
                                        <thead>
                                            <tr>
                                                <th>ì¡°ê±´</th>
                                                <th>í‚¤ì›Œë“œ</th>
                                                <th>ë³€ê²½ í•„ë“œ</th>
                                                <th>ì„¤ì •ê°’</th>
                                                <th>ì„¤ëª…</th>
                                                <th>ì‘ì—…</th>
                                            </tr>
                                        </thead>
                                        <tbody id="parsingRulesBody">
                                            <!-- ê¸°ë³¸ ê·œì¹™ë“¤ -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>íŒŒì‹± ë³´ì • ê·œì¹™ ì‘ë™ ë°©ì‹</h6>
                        <ul class="mb-0">
                            <li><strong>ì¡°ê±´ ë§¤ì¹­</strong>: ìƒí’ˆëª…/ì—…ì²´ëª…ì— í‚¤ì›Œë“œê°€ í¬í•¨ë˜ë©´ ìë™ ì ìš©</li>
                            <li><strong>í•„ë“œ ë³€ê²½</strong>: íŒŒì‹± í›„ ì§€ì •ëœ í•„ë“œê°’ì„ ìë™ìœ¼ë¡œ ë³€ê²½</li>
                            <li><strong>ìš°ì„ ìˆœìœ„</strong>: ìœ„ì—ì„œë¶€í„° ìˆœì„œëŒ€ë¡œ ì ìš©</li>
                            <li><strong>ì‹¤ì‹œê°„ ì ìš©</strong>: íŒŒì‹± ì¦‰ì‹œ ê·œì¹™ì´ ì ìš©ë¨</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    <button type="button" class="btn btn-info" onclick="exportRules()">
                        <i class="fas fa-download me-1"></i>ê·œì¹™ ë‚´ë³´ë‚´ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let parsedData = null;
        let preprocessingRules = [];
        let customPrompt = '';
        let customParsingRules = []; // DBì—ì„œ ë¡œë“œë  ë°ì´í„°

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        document.addEventListener('DOMContentLoaded', function() {
            loadParsingSettings();
        });

        // ==================== ì„¤ì • ê´€ë¦¬ ====================
        
        // íŒŒì‹± ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
        function openParsingSettings() {
            loadParsingSettings();
            renderPreprocessingRules();
            const modal = new bootstrap.Modal(document.getElementById('parsingSettingsModal'));
            modal.show();
        }

        // ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° (DBì—ì„œ - ì¦ê¸¸ê±°ë¦¬ ì „ìš©)
        async function loadParsingSettings() {
            try {
                // ì¦ê¸¸ê±°ë¦¬ ì¸ë°•ìŠ¤ ì „ìš© ì„¤ì •
                const response = await fetch('/api/parsing-settings?type=activity');
                const data = await response.json();
                
                if (data.success && data.settings) {
                    // DBì—ì„œ ë¡œë“œëœ ì„¤ì • ì‚¬ìš©
                    preprocessingRules = data.settings.preprocessing_rules || [];
                    customPrompt = data.settings.custom_prompt || '';
                    customParsingRules = data.settings.custom_parsing_rules || [];
                    
                    console.log('âœ… DBì—ì„œ íŒŒì‹± ì„¤ì • ë¡œë“œ:', {
                        ì „ì²˜ë¦¬ê·œì¹™: preprocessingRules.length + 'ê°œ',
                        í™œì„±í™”ëœê·œì¹™: preprocessingRules.filter(r => r.enabled).length + 'ê°œ',
                        ì»¤ìŠ¤í…€í”„ë¡¬í”„íŠ¸: customPrompt ? 'ìˆìŒ' : 'ì—†ìŒ',
                        ì»¤ìŠ¤í…€íŒŒì‹±ê·œì¹™: customParsingRules.length + 'ê°œ'
                    });
                } else {
                    // ê¸°ë³¸ê°’ ì‚¬ìš©
                    preprocessingRules = [
                        { pattern: 'logo_', replacement: '', type: 'remove', enabled: true },
                        { pattern: 'image_', replacement: '', type: 'remove', enabled: true },
                        { pattern: 'icon_', replacement: '', type: 'remove', enabled: true },
                        { pattern: 'img_', replacement: '', type: 'remove', enabled: true },
                        { pattern: 'photo_', replacement: '', type: 'remove', enabled: true }
                    ];
                    customParsingRules = [];
                    console.log('âœ… ê¸°ë³¸ íŒŒì‹± ì„¤ì • ë¡œë“œ');
                }
                
                const promptTextarea = document.getElementById('customPromptText');
                if (promptTextarea) {
                    promptTextarea.value = customPrompt;
                }
                
                // íŒŒì‹± ê·œì¹™ í…Œì´ë¸” ì—…ë°ì´íŠ¸
                updateParsingRulesTable();
                
            } catch (error) {
                console.error('âŒ íŒŒì‹± ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
                // ê¸°ë³¸ê°’ ì‚¬ìš©
                preprocessingRules = [
                    { pattern: 'logo_', replacement: '', type: 'remove', enabled: true },
                    { pattern: 'image_', replacement: '', type: 'remove', enabled: true },
                    { pattern: 'icon_', replacement: '', type: 'remove', enabled: true },
                    { pattern: 'img_', replacement: '', type: 'remove', enabled: true },
                    { pattern: 'photo_', replacement: '', type: 'remove', enabled: true }
                ];
                customParsingRules = [];
            }
        }

        // ì„¤ì • ì €ì¥ (DBì—)
        async function saveParsingSettings() {
            try {
                customPrompt = document.getElementById('customPromptText').value;
                
                const response = await fetch('/api/parsing-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: 'activity',
                        preprocessing_rules: preprocessingRules,
                        custom_prompt: customPrompt,
                        custom_parsing_rules: customParsingRules
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('âœ… DBì— íŒŒì‹± ì„¤ì • ì €ì¥ ì™„ë£Œ');
                    showNotification('íŒŒì‹± ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('parsingSettingsModal')).hide();
                } else {
                    throw new Error(data.message || 'ì €ì¥ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('âŒ íŒŒì‹± ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', error);
                showNotification('íŒŒì‹± ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger');
            }
        }

        // ==================== ì „ì²˜ë¦¬ ê·œì¹™ ê´€ë¦¬ ====================
        
        // HTML ì´ìŠ¤ì¼€ì´í”„ í—¬í¼ (ê¸°í˜¸/ë¶€í˜¸ ì•ˆì „ ì²˜ë¦¬)
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // ì „ì²˜ë¦¬ ê·œì¹™ ë Œë”ë§
        function renderPreprocessingRules() {
            const container = document.getElementById('preprocessingRulesList');
            
            if (preprocessingRules.length === 0) {
                container.innerHTML = '<div class="text-muted text-center py-3">ë“±ë¡ëœ ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            container.innerHTML = preprocessingRules.map((rule, index) => `
                <div class="card mb-2">
                    <div class="card-body p-3">
                        <div class="row g-2 align-items-center">
                            <div class="col-auto">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" ${rule.enabled ? 'checked' : ''} 
                                           onchange="toggleRule(${index})">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control form-control-sm" 
                                       value="${escapeHtml(rule.pattern)}" 
                                       onchange="updateRulePattern(${index}, this.value)"
                                       placeholder="ì°¾ì„ ë¬¸ìì—´">
                            </div>
                            <div class="col-md-1 text-center">
                                <i class="fas fa-arrow-right text-muted"></i>
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control form-control-sm" 
                                       value="${escapeHtml(rule.replacement)}" 
                                       onchange="updateRuleReplacement(${index}, this.value)"
                                       placeholder="ë°”ê¿€ ë¬¸ìì—´ (ë¹„ìš°ë©´ ì‚­ì œ)">
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" onchange="updateRuleType(${index}, this.value)">
                                    <option value="remove" ${rule.type === 'remove' ? 'selected' : ''}>ì‚­ì œ</option>
                                    <option value="replace" ${rule.type === 'replace' ? 'selected' : ''}>ë³€ê²½</option>
                                </select>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteRule(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ê·œì¹™ ì¶”ê°€
        function addPreprocessingRule() {
            preprocessingRules.push({
                pattern: '',
                replacement: '',
                type: 'remove',
                enabled: true
            });
            renderPreprocessingRules();
        }

        // ê·œì¹™ í† ê¸€
        function toggleRule(index) {
            preprocessingRules[index].enabled = !preprocessingRules[index].enabled;
        }

        // ê·œì¹™ íŒ¨í„´ ì—…ë°ì´íŠ¸
        function updateRulePattern(index, value) {
            preprocessingRules[index].pattern = value;
        }

        // ê·œì¹™ ë³€ê²½ê°’ ì—…ë°ì´íŠ¸
        function updateRuleReplacement(index, value) {
            preprocessingRules[index].replacement = value;
        }

        // ê·œì¹™ íƒ€ì… ì—…ë°ì´íŠ¸
        function updateRuleType(index, value) {
            preprocessingRules[index].type = value;
        }

        // ê·œì¹™ ì‚­ì œ
        function deleteRule(index) {
            preprocessingRules.splice(index, 1);
            renderPreprocessingRules();
        }

        // ==================== ë°ì´í„° ì „ì²˜ë¦¬ ====================
        
        // ì •ê·œì‹ íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // ë°ì´í„° ì „ì²˜ë¦¬ ì‹¤í–‰
        function preprocessData(text) {
            let processedText = text;
            
            console.log('ğŸ”§ ì „ì²˜ë¦¬ ì‹œì‘:', {
                originalLength: text.length,
                rulesCount: preprocessingRules.filter(r => r.enabled).length
            });
            
            // í™œì„±í™”ëœ ê·œì¹™ë§Œ ì ìš©
            preprocessingRules.filter(r => r.enabled).forEach(rule => {
                if (!rule.pattern) return;
                
                try {
                    // íŠ¹ìˆ˜ë¬¸ìë¥¼ ì•ˆì „í•˜ê²Œ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
                    const escapedPattern = escapeRegex(rule.pattern);
                    const regex = new RegExp(escapedPattern, 'gi');

                    // \nì„ ì‹¤ì œ ì¤„ë°”ê¿ˆìœ¼ë¡œ ë³€í™˜í•´ì„œ ì‚¬ìš©
                    const replacement = (rule.replacement || '').replace(/\\n/g, '\n');

                    const beforeLength = processedText.length;
                    processedText = processedText.replace(regex, replacement);
                    const afterLength = processedText.length;
                    
                    if (beforeLength !== afterLength) {
                        console.log(`âœ… ê·œì¹™ ì ìš©: "${rule.pattern}" â†’ "${rule.replacement}" (${beforeLength - afterLength}ì ë³€ê²½)`);
                    }
                } catch (error) {
                    console.error(`âŒ ê·œì¹™ ì ìš© ì‹¤íŒ¨: "${rule.pattern}"`, error);
                }
            });
            
            console.log('ğŸ”§ ì „ì²˜ë¦¬ ì™„ë£Œ:', {
                processedLength: processedText.length,
                difference: text.length - processedText.length
            });
            
            return processedText;
        }

        // ==================== AI íŒŒì‹± ====================
        
        // ì˜ˆì•½ íŒŒì‹± (ì „ì²˜ë¦¬ + í”„ë¡¬í”„íŠ¸ ì¶”ê°€)
        async function parseReservation() {
            const text = document.getElementById('reservationText').value.trim();
            
            if (!text) {
                alert('ì˜ˆì•½ ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ë¡œë”© UI í‘œì‹œ
            const parseBtn = document.getElementById('parseBtn');
            const parseBtnText = document.getElementById('parseBtnText');
            const parseBtnSpinner = document.getElementById('parseBtnSpinner');
            const reservationTextarea = document.getElementById('reservationText');
            const allButtons = document.querySelectorAll('#parseForm button');
            
            parseBtn.disabled = true;
            parseBtnText.textContent = 'íŒŒì‹± ì¤‘';
            parseBtnSpinner.style.display = 'inline-block';
            reservationTextarea.disabled = true;
            parseBtn.style.cursor = 'wait';
            
            // ë‹¤ë¥¸ ëª¨ë“  ë²„íŠ¼ë„ ë¹„í™œì„±í™”
            allButtons.forEach(btn => btn.disabled = true);

            try {
                // 0ë‹¨ê³„: ì´ë¯¸ DBì—ì„œ ë¡œë“œëœ ì„¤ì • ì‚¬ìš© (customPrompt, preprocessingRules)
                console.log('ğŸ”„ í˜„ì¬ ì„¤ì • ìƒíƒœ:');
                console.log('  - ì»¤ìŠ¤í…€í”„ë¡¬í”„íŠ¸:', customPrompt ? `ìˆìŒ (${customPrompt.length}ì)` : 'ì—†ìŒ');
                console.log('  - ì „ì²˜ë¦¬ê·œì¹™:', preprocessingRules.length + 'ê°œ');
                console.log('  - ì»¤ìŠ¤í…€íŒŒì‹±ê·œì¹™:', customParsingRules.length + 'ê°œ');
                if (customPrompt) {
                    console.log('  - í”„ë¡¬í”„íŠ¸ ë‚´ìš©:', customPrompt);
                }
                
                // 1ë‹¨ê³„: ë°ì´í„° ì „ì²˜ë¦¬
                const preprocessedText = preprocessData(text);
                
                console.log('ğŸ“Š ì „ì²˜ë¦¬ ê²°ê³¼:', {
                    ì›ë³¸ê¸¸ì´: text.length,
                    ì „ì²˜ë¦¬í›„ê¸¸ì´: preprocessedText.length,
                    ì°¨ì´: text.length - preprocessedText.length
                });

                console.log('ğŸ¤– AI íŒŒì‹± ìš”ì²­:');
                console.log('  - ì „ì²˜ë¦¬ëœí…ìŠ¤íŠ¸ê¸¸ì´:', preprocessedText.length);
                console.log('  - ì»¤ìŠ¤í…€í”„ë¡¬í”„íŠ¸:', customPrompt ? `ìˆìŒ (${customPrompt.length}ì)` : 'ì—†ìŒ');
                if (customPrompt) {
                    console.log('  - ì „ì†¡í•  í”„ë¡¬í”„íŠ¸:', customPrompt);
                }

                // 2ë‹¨ê³„: AI íŒŒì‹± (ì „ì²˜ë¦¬ëœ ë°ì´í„° + ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ + íŒŒì‹± ê·œì¹™)
                const response = await fetch('/admin/reservations/parse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        reservationText: preprocessedText,
                        customPrompt: customPrompt,  // ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸
                        customParsingRules: customParsingRules  // íŒŒì‹± ê·œì¹™ ì¶”ê°€ (ìš”ê¸ˆ RAG ë§¤ì¹­ìš©)
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    parsedData = result.parsed_data;
                    await showPreview(result);
                } else {
                    alert('íŒŒì‹± ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                console.error('íŒŒì‹± ì˜¤ë¥˜:', error);
                alert('íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                // ë¡œë”© UI ë³µêµ¬
                parseBtn.disabled = false;
                parseBtnText.textContent = 'AI íŒŒì‹±';
                parseBtnSpinner.style.display = 'none';
                reservationTextarea.disabled = false;
                parseBtn.style.cursor = 'pointer';
                
                // ë‹¤ë¥¸ ëª¨ë“  ë²„íŠ¼ë„ í™œì„±í™”
                allButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.cursor = 'pointer';
                });
            }
        }

        // ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ í‘œì‹œ
        async function showPreview(result) {
            const previewArea = document.getElementById('previewArea');
            const confidenceBadge = document.getElementById('confidenceBadge');
            const parsingMethodBadge = document.getElementById('parsingMethodBadge');
            
            // ì‹ ë¢°ë„ ë°°ì§€
            const confidence = result.confidence || 0.5;
            confidenceBadge.textContent = `ì‹ ë¢°ë„ ${Math.round(confidence * 100)}%`;
            confidenceBadge.className = confidence > 0.8 ? 'badge bg-success' : 
                                      confidence > 0.6 ? 'badge bg-warning' : 'badge bg-danger';

            // íŒŒì‹± ë°©ë²• ë°°ì§€
            parsingMethodBadge.textContent = result.parsing_method || 'OpenAI';

            // ìš”ê¸ˆ RAG ë§¤ì¹­ ì •ë³´ í‘œì‹œ
            if (result.pricing_matched && result.pricing_info) {
                const pricingInfo = result.pricing_info;
                showNotification(`ğŸ’° ìš”ê¸ˆ ìë™ ì„¤ì •: ${pricingInfo.matched_option.option_name || 'ì˜µì…˜ ë§¤ì¹­ ì™„ë£Œ'}`, 'success');
                console.log('âœ… ìš”ê¸ˆ RAG ë§¤ì¹­ ì„±ê³µ:', pricingInfo);
            }

            // í¼ì— ë°ì´í„° ì±„ìš°ê¸° (ìˆ˜ë°°ì—…ì²´ ë§¤ì¹­ í¬í•¨)
            await fillPreviewForm(parsedData);
            
            previewArea.style.display = 'block';
            previewArea.scrollIntoView({ behavior: 'smooth' });
        }

        // ë¯¸ë¦¬ë³´ê¸° í¼ì— ë°ì´í„° ì±„ìš°ê¸°
        async function fillPreviewForm(data) {
            console.log('ğŸ“‹ íŒŒì‹±ëœ ë°ì´í„°:', data);
            console.log('ğŸ’° ì›ê°€ ë°ì´í„° í™•ì¸:', {
                adult_cost: data.adult_cost,
                child_cost: data.child_cost,
                infant_cost: data.infant_cost,
                adult_cost_currency: data.adult_cost_currency,
                child_cost_currency: data.child_cost_currency,
                infant_cost_currency: data.infant_cost_currency
            });
            
            // ì—…ì²´ëª… ì¶”ì¶œ í•¨ìˆ˜ (íŒë§¤ì±„ë„/ì—…ì²´ëª…/í”Œë«í¼ ì¤‘ ìš°ì„ ìˆœìœ„)
            function extractCompanyName(data) {
                // ìš°ì„ ìˆœìœ„: platform_name > channel > company
                const candidates = [
                    data.platform_name,
                    data.channel, 
                    data.company,
                    data.vendor,
                    data.agency
                ];
                
                for (let name of candidates) {
                    if (name && name.trim() && name !== 'OTHER' && name !== 'UNKNOWN') {
                        // ë°”ìŠ¤ì½”/ëŸ­ìŠ¤íŒŒì¸ë“œ ì œì™¸
                        const excludeCompanies = ['ë°”ìŠ¤ì½”', 'vasco', 'VASCO', 'ëŸ­ìŠ¤íŒŒì¸ë“œ', 'luxfind', 'LUXFIND'];
                        const lowerName = name.toLowerCase();
                        
                        let isExcluded = false;
                        for (let company of excludeCompanies) {
                            if (lowerName.includes(company.toLowerCase())) {
                                isExcluded = true;
                                break;
                            }
                        }
                        
                        if (!isExcluded) {
                            return name.trim();
                        }
                    }
                }
                return '';
            }
            
            // ë‚ ì§œ í˜•ì‹ ë³€í™˜ í•¨ìˆ˜
            function formatDate(dateStr) {
                if (!dateStr) return '';
                try {
                    // ë‹¤ì–‘í•œ ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬
                    let date = new Date(dateStr);
                    if (isNaN(date.getTime())) {
                        // í•œêµ­ì–´ ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬ (ì˜ˆ: 2025-09-13)
                        const match = dateStr.match(/(\d{4})-(\d{1,2})-(\d{1,2})/);
                        if (match) {
                            date = new Date(match[1], match[2] - 1, match[3]);
                        }
                    }
                    return date.toISOString().split('T')[0];
                } catch (e) {
                    return '';
                }
            }
            
            // ì‹œê°„ í˜•ì‹ ë³€í™˜ í•¨ìˆ˜
            function formatTime(timeStr) {
                if (!timeStr) return '';
                try {
                    const match = timeStr.match(/(\d{1,2}):(\d{2})/);
                    if (match) {
                        return `${match[1].padStart(2, '0')}:${match[2]}`;
                    }
                } catch (e) {
                    return '';
                }
                return '';
            }
            
            // ë‚ ì§œì‹œê°„ í˜•ì‹ ë³€í™˜ í•¨ìˆ˜
            function formatDateTime(dateTimeStr) {
                if (!dateTimeStr) return '';
                try {
                    const date = new Date(dateTimeStr);
                    if (!isNaN(date.getTime())) {
                        return date.toISOString().slice(0, 16);
                    }
                } catch (e) {
                    return '';
                }
                return '';
            }

            // ëª¨ë“  í•„ë“œ ë§¤í•‘ (AI íŒŒì„œ í•„ë“œëª… â†’ í¼ í•„ë“œëª…)
            const companyName = extractCompanyName(data);
            
            // ğŸ” ë³„ì¹­ ì¡°íšŒ â†’ í‘œì¤€ ì—…ì²´ëª…ìœ¼ë¡œ ë³€í™˜
            let standardPlatformName = companyName;
            if (companyName) {
                try {
                    const aliasResponse = await fetch('/api/platforms/resolve-alias', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ alias: companyName })
                    });
                    const aliasData = await aliasResponse.json();
                    
                    if (aliasData.success && aliasData.matched) {
                        standardPlatformName = aliasData.standardName;
                        console.log(`âœ… ì—…ì²´ëª… ë³€í™˜: "${companyName}" â†’ "${standardPlatformName}" (${aliasData.matchType})`);
                    } else {
                        console.log(`â„¹ï¸ ì—…ì²´ëª… "${companyName}" - ë³„ì¹­ ë¯¸ë“±ë¡ (ì›ë³¸ ìœ ì§€)`);
                    }
                } catch (error) {
                    console.error('âŒ ë³„ì¹­ ì¡°íšŒ ì‹¤íŒ¨:', error);
                    // ì‹¤íŒ¨ ì‹œ ì›ë³¸ ìœ ì§€
                }
            }
            
            const fieldMappings = {
                'reservation_number': data.reservation_number || data.booking_reference || data.order_number || '',
                'platform_name': standardPlatformName,  // í‘œì¤€ ì—…ì²´ëª…
                'channel': standardPlatformName,        // í‘œì¤€ ì—…ì²´ëª… (ë™ê¸°í™”)
                'payment_status': 'pending', // ê¸°ë³¸ê°’: ëŒ€ê¸°ì¤‘ (ì‹ ê·œì˜ˆì•½)
                'product_name': data.product_name || data.tour_name || data.service_name || '',
                'package_type': data.package_type || data.package || data.option || '',
                'tour_date': formatDate(data.usage_date || data.tour_date || data.date || data.service_date || ''),
                'tour_time': formatTime(data.usage_time || data.tour_time || data.time || data.service_time || ''),
                'booking_date': formatDateTime(data.reservation_datetime || data.booking_date || data.created_at || data.reservation_date || ''),
                'customer_name': data.korean_name || data.customer_name || data.name || data.guest_name || '',
                'customer_lastname': data.english_last_name || data.customer_lastname || data.last_name || data.surname || '',
                'customer_firstname': data.english_first_name || data.customer_firstname || data.first_name || data.given_name || '',
                'customer_phone': data.phone || data.customer_phone || data.mobile || data.contact || '',
                'customer_email': data.email || data.customer_email || '',
                'kakao_id': data.kakao_id || data.kakao || data.kakao_talk || data.kakaotalk || '',
                'adult_count': parseInt(data.people_adult || data.adult_count || data.adults || data.adult || 0),
                'child_count': parseInt(data.people_child || data.child_count || data.children || data.child || 0),
                'infant_count': parseInt(data.people_infant || data.infant_count || data.infants || data.infant || 0),
                'adult_price': parseFloat(data.adult_unit_price || data.adult_price || data.adult_amount || 0),
                'child_price': parseFloat(data.child_unit_price || data.child_price || data.child_amount || 0),
                'infant_price': parseFloat(data.infant_unit_price || data.infant_price || data.infant_amount || 0),
                'adult_cost': parseFloat(data.adult_cost || data.adult_unit_cost || 0),
                'child_cost': parseFloat(data.child_cost || data.child_unit_cost || 0),
                'infant_cost': parseFloat(data.infant_cost || data.infant_unit_cost || 0),
                'adult_currency': data.adult_currency || 'USD',
                'child_currency': data.child_currency || 'USD',
                'infant_currency': data.infant_currency || 'USD',
                'adult_cost_currency': data.adult_cost_currency || data.adult_currency || 'USD',
                'child_cost_currency': data.child_cost_currency || data.child_currency || 'USD',
                'infant_cost_currency': data.infant_cost_currency || data.infant_currency || 'USD',
                'commission_rate': parseFloat(data.commission_rate || 0),
                'special_requests': data.memo || data.special_requests || data.notes || data.remarks || ''
            };
            
            // RAG ìˆ˜ìˆ˜ë£Œìœ¨ ì €ì¥ (ì „ì—­ ë³€ìˆ˜)
            window.ragCommissionRate = fieldMappings.commission_rate;
            
            console.log('ğŸ” fieldMappings ì›ê°€ ë° ìˆ˜ìˆ˜ë£Œìœ¨ í™•ì¸:', {
                adult_cost: fieldMappings.adult_cost,
                child_cost: fieldMappings.child_cost,
                infant_cost: fieldMappings.infant_cost,
                adult_cost_currency: fieldMappings.adult_cost_currency,
                commission_rate: fieldMappings.commission_rate
            });

            // 1ë‹¨ê³„: í¼ í•„ë“œì— ê¸°ë³¸ê°’ ì„¤ì •
            Object.entries(fieldMappings).forEach(([fieldId, value]) => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.value = value || '';
                    
                    // ë¹ˆ ê°’ì´ê±°ë‚˜ nullì¸ ê²½ìš° ê²½ê³  ìŠ¤íƒ€ì¼ ì ìš©
                    if (!value || value === 'null' || value === '-' || value === 0) {
                        element.classList.add('border-warning');
                        element.style.backgroundColor = '#fff3cd';
                    } else {
                        element.classList.remove('border-warning');
                        element.style.backgroundColor = '';
                    }
                }
            });

            // 2ë‹¨ê³„: íŠ¹ë³„ ì„¤ì • ê·œì¹™ ì ìš©
            applySpecialRules(fieldMappings);

            // 3ë‹¨ê³„: ì‚¬ìš©ì ì •ì˜ íŒŒì‹± ê·œì¹™ ì ìš© (ìƒí’ˆëª…/ì—…ì²´ëª… ê¸°ë°˜ ìƒíƒœ ë³€ê²½)
            applyCustomParsingRules(fieldMappings);
            
            // 4ë‹¨ê³„: ìˆ˜ë°°ì—…ì²´ ìë™ ë§¤ì¹­ (ë¹„ë™ê¸° ì²˜ë¦¬)
            await matchVendorByProduct(fieldMappings.product_name);

            // ê¸°ë³¸ì ìœ¼ë¡œëŠ” "ëŒ€ê¸°ì¤‘ (ì‹ ê·œì˜ˆì•½)" ìƒíƒœ (íŠ¹ë³„ ê·œì¹™ì´ ì—†ëŠ” ê²½ìš°)
            const paymentStatusElement = document.getElementById('payment_status');
            if (paymentStatusElement && paymentStatusElement.value === 'pending') {
                paymentStatusElement.classList.remove('border-warning');
                paymentStatusElement.style.backgroundColor = '#fff3cd'; // ëŒ€ê¸°ì¤‘ ìƒ‰ìƒìœ¼ë¡œ ê°•ì¡°
            }

            // ì´ ì¸ì› ë° ê¸ˆì•¡ ê³„ì‚°
            calculateTotal();
            
            // ğŸ’° í†µí™” í‘œì‹œ ì—…ë°ì´íŠ¸
            updateCurrencyDisplay();
        }

        // íŠ¹ë³„ ì„¤ì • ê·œì¹™ ì ìš©
        function applySpecialRules(fieldMappings) {
            const productName = fieldMappings.product_name || '';
            const platformName = fieldMappings.platform_name || '';
            const memo = fieldMappings.special_requests || '';
            
            // ğŸ¯ ìƒí’ˆë³„ íŠ¹ë³„ ê·œì¹™
            const productRules = {
                // ë¡±í˜¼ìŠ¤í…Œì´í¬ í•˜ìš°ìŠ¤ - ìˆ˜ë°° ë¶ˆí•„ìš”, ë°”ë¡œ í™•ì •
                'ë¡±í˜¼ìŠ¤í…Œì´í¬': { status: 'confirmed', reason: 'ìˆ˜ë°° ë¶ˆí•„ìš” ìƒí’ˆ' },
                'ë¡±í˜¼': { status: 'confirmed', reason: 'ìˆ˜ë°° ë¶ˆí•„ìš” ìƒí’ˆ' },
                'longhorn': { status: 'confirmed', reason: 'ìˆ˜ë°° ë¶ˆí•„ìš” ìƒí’ˆ' },
                
                // ê¸°íƒ€ ìˆ˜ë°° ë¶ˆí•„ìš” ìƒí’ˆë“¤
                'ë ˆìŠ¤í† ë‘': { status: 'confirmed', reason: 'ìˆ˜ë°° ë¶ˆí•„ìš” ìƒí’ˆ' },
                'ì‹ë‹¹': { status: 'confirmed', reason: 'ìˆ˜ë°° ë¶ˆí•„ìš” ìƒí’ˆ' },
                'ë§›ì§‘': { status: 'confirmed', reason: 'ìˆ˜ë°° ë¶ˆí•„ìš” ìƒí’ˆ' },
                'ì¹´í˜': { status: 'confirmed', reason: 'ìˆ˜ë°° ë¶ˆí•„ìš” ìƒí’ˆ' }
            };

            // ğŸ¯ ì—…ì²´ë³„ íŠ¹ë³„ ê·œì¹™
            const platformRules = {
                'íˆ¬ì–´ë¹„ìŠ¤': { 
                    countRule: 'booking_to_people', // ì˜ˆì•½ ê±´ìˆ˜ = ì¸ì›ìˆ˜
                    reason: 'íˆ¬ì–´ë¹„ìŠ¤ ì˜ˆì•½ ê±´ìˆ˜ = ì¸ì›ìˆ˜'
                }
            };

            // ìƒí’ˆëª… ê¸°ë°˜ ê·œì¹™ ì ìš©
            Object.keys(productRules).forEach(keyword => {
                if (productName.toLowerCase().includes(keyword.toLowerCase())) {
                    const rule = productRules[keyword];
                    
                    if (rule.status) {
                        const statusElement = document.getElementById('payment_status');
                        if (statusElement) {
                            statusElement.value = rule.status;
                            statusElement.style.backgroundColor = rule.status === 'confirmed' ? '#d1ecf1' : '#fff3cd';
                            
                            // ê·œì¹™ ì ìš© ì•Œë¦¼ í‘œì‹œ
                            showRuleNotification(`ğŸ¯ ìë™ ì„¤ì •: ${rule.reason} â†’ ${getStatusText(rule.status)}`);
                        }
                    }
                }
            });

            // ì—…ì²´ë³„ ê·œì¹™ ì ìš©
            Object.keys(platformRules).forEach(platform => {
                if (platformName.toLowerCase().includes(platform.toLowerCase())) {
                    const rule = platformRules[platform];
                    
                    if (rule.countRule === 'booking_to_people') {
                        // ë©”ëª¨ë‚˜ ìƒí’ˆëª…ì—ì„œ ìˆ«ì ì¶”ì¶œí•˜ì—¬ ì¸ì›ìˆ˜ë¡œ ì„¤ì •
                        const numbers = extractNumbers(memo + ' ' + productName);
                        if (numbers.length > 0) {
                            const adultCountElement = document.getElementById('adult_count');
                            if (adultCountElement && !adultCountElement.value) {
                                adultCountElement.value = numbers[0];
                                adultCountElement.style.backgroundColor = '#d1ecf1';
                                
                                showRuleNotification(`ğŸ¯ ìë™ ì„¤ì •: ${rule.reason} â†’ ì„±ì¸ ${numbers[0]}ëª…`);
                            }
                        }
                    }
                }
            });
        }

        // ìˆ«ì ì¶”ì¶œ í•¨ìˆ˜
        function extractNumbers(text) {
            const matches = text.match(/\d+/g);
            return matches ? matches.map(num => parseInt(num)).filter(num => num > 0 && num <= 50) : [];
        }

        // ê·œì¹™ ì ìš© ì•Œë¦¼ í‘œì‹œ
        function showRuleNotification(message) {
            // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
            const existingNotification = document.querySelector('.rule-notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // ìƒˆ ì•Œë¦¼ ìƒì„±
            const notification = document.createElement('div');
            notification.className = 'rule-notification alert alert-info alert-dismissible fade show mt-2';
            notification.style.cssText = 'position: relative; z-index: 1000;';
            notification.innerHTML = `
                <i class="fas fa-magic me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            // ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ ìƒë‹¨ì— ì¶”ê°€
            const previewArea = document.getElementById('previewArea');
            previewArea.insertBefore(notification, previewArea.firstChild);

            // 5ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // ìë™ ì„¤ì • ê·œì¹™ ëª¨ë‹¬ ì—´ê¸°
        function openRulesModal() {
            updateParsingRulesTable(); // ê¸°ì¡´ ê·œì¹™ë“¤ í‘œì‹œ
            const modal = new bootstrap.Modal(document.getElementById('rulesModal'));
            modal.show();
        }

        // íŒŒì‹± ë³´ì • ê·œì¹™ì€ ì´ì œ loadParsingSettings()ì—ì„œ DBë¡œë¶€í„° ë¡œë“œë¨

        // íŒŒì‹± ë³´ì • ê·œì¹™ ì¶”ê°€
        function addParsingRule() {
            const conditionType = document.getElementById('newConditionType').value;
            const keyword = document.getElementById('newKeyword').value.trim();
            const fieldType = document.getElementById('newFieldType').value;
            const valueSelect = document.getElementById('newValue');
            const customInput = document.getElementById('customValue');
            const description = document.getElementById('newDescription').value.trim();

            // ì„¤ì •ê°’ ê²°ì • (ë“œë¡­ë‹¤ìš´ ë˜ëŠ” ì§ì ‘ ì…ë ¥)
            let value = '';
            if (valueSelect.value === 'CUSTOM') {
                value = customInput.value.trim();
            } else {
                value = valueSelect.value.trim();
            }

            if (!keyword || !fieldType || !value) {
                alert('í‚¤ì›Œë“œ, ë³€ê²½ í•„ë“œ, ì„¤ì •ê°’ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const newRule = {
                id: Date.now(),
                conditionType,
                keyword,
                fieldType,
                value,
                description: description || `${keyword} â†’ ${fieldType} = ${value}`
            };

            customParsingRules.push(newRule);
            // DBì— ì¦‰ì‹œ ì €ì¥
            saveParsingRulesToDB();
            
            // í¼ ì´ˆê¸°í™”
            document.getElementById('newConditionType').value = 'product';
            document.getElementById('newKeyword').value = '';
            document.getElementById('newFieldType').value = '';
            document.getElementById('newValue').innerHTML = '<option value="">-- ë¨¼ì € í•„ë“œë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>';
            document.getElementById('customValue').value = '';
            document.getElementById('customValue').style.display = 'none';
            document.getElementById('newDescription').value = '';
            
            // í…Œì´ë¸” ì—…ë°ì´íŠ¸
            updateParsingRulesTable();
            
            showRuleNotification(`âœ… ìƒˆ ê·œì¹™ ì¶”ê°€ë¨: ${newRule.description}`);
        }

        // íŒŒì‹± ë³´ì • ê·œì¹™ ì‚­ì œ
        function deleteParsingRule(ruleId) {
            if (confirm('ì´ ê·œì¹™ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                customParsingRules = customParsingRules.filter(rule => rule.id !== ruleId);
                // DBì— ì¦‰ì‹œ ì €ì¥
                saveParsingRulesToDB();
                updateParsingRulesTable();
                showRuleNotification('ğŸ—‘ï¸ ê·œì¹™ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // íŒŒì‹± ê·œì¹™ë§Œ DBì— ì €ì¥í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        async function saveParsingRulesToDB() {
            try {
                const response = await fetch('/api/parsing-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: 'activity',
                        preprocessing_rules: preprocessingRules,
                        custom_prompt: customPrompt,
                        custom_parsing_rules: customParsingRules
                    })
                });
                
                const data = await response.json();
                if (!data.success) {
                    console.error('âŒ íŒŒì‹± ê·œì¹™ ì €ì¥ ì‹¤íŒ¨:', data.message);
                }
            } catch (error) {
                console.error('âŒ íŒŒì‹± ê·œì¹™ ì €ì¥ ì˜¤ë¥˜:', error);
            }
        }

        // ì¡°ê±´ ìœ í˜• í‘œì‹œëª… í•¨ìˆ˜
        function getConditionTypeText(conditionType) {
            const typeMap = {
                'product_exact': 'ìƒí’ˆëª… ì •í™•íˆ ì¼ì¹˜',
                'product_contains': 'ìƒí’ˆëª… í¬í•¨',
                'platform_exact': 'ì—…ì²´ëª… ì •í™•íˆ ì¼ì¹˜', 
                'platform_contains': 'ì—…ì²´ëª… í¬í•¨',
                'product': 'ìƒí’ˆëª… í¬í•¨', // ë ˆê±°ì‹œ
                'platform': 'ì—…ì²´ëª… í¬í•¨' // ë ˆê±°ì‹œ
            };
            return typeMap[conditionType] || conditionType;
        }

        // íŒŒì‹± ë³´ì • ê·œì¹™ í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateParsingRulesTable() {
            const tbody = document.getElementById('parsingRulesBody');
            tbody.innerHTML = customParsingRules.map(rule => `
                <tr>
                    <td><span class="badge bg-${rule.conditionType.includes('product') ? 'primary' : 'info'}">${getConditionTypeText(rule.conditionType)}</span></td>
                    <td><code>${rule.keyword}</code></td>
                    <td>${getFieldDisplayName(rule.fieldType)}</td>
                    <td><strong>${rule.value}</strong></td>
                    <td>${rule.description}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteParsingRule(${rule.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // í•„ë“œ í‘œì‹œëª… ë³€í™˜
        function getFieldDisplayName(fieldType) {
            const fieldNames = {
                'payment_status': 'ì˜ˆì•½ ìƒíƒœ',
                'adult_count': 'ì„±ì¸ìˆ˜',
                'child_count': 'ì•„ë™ìˆ˜',
                'infant_count': 'ìœ ì•„ìˆ˜',
                'total_amount': 'ì´ ê¸ˆì•¡',
                'adult_price': 'ì„±ì¸ ë‹¨ê°€',
                'child_price': 'ì•„ë™ ë‹¨ê°€',
                'infant_price': 'ìœ ì•„ ë‹¨ê°€',
                'platform_name': 'í”Œë«í¼ëª…',
                'channel': 'ì—…ì²´ëª…',
                'product_name': 'ìƒí’ˆëª…',
                'package_type': 'íŒ¨í‚¤ì§€ íƒ€ì…'
            };
            return fieldNames[fieldType] || fieldType;
        }

        // ì‚¬ìš©ì ì •ì˜ íŒŒì‹± ë³´ì • ê·œì¹™ ì ìš©
        function applyCustomParsingRules(fieldMappings) {
            const productName = (fieldMappings.product_name || '').trim();
            const platformName = (fieldMappings.platform_name || '').trim();
            
            customParsingRules.forEach(rule => {
                let shouldApply = false;
                const keyword = rule.keyword.trim();
                
                // ì •í™•í•œ ë§¤ì¹­ vs í¬í•¨ ë§¤ì¹­
                if (rule.conditionType === 'product_exact') {
                    shouldApply = productName.toLowerCase() === keyword.toLowerCase();
                } else if (rule.conditionType === 'product_contains') {
                    shouldApply = productName.toLowerCase().includes(keyword.toLowerCase());
                } else if (rule.conditionType === 'platform_exact') {
                    shouldApply = platformName.toLowerCase() === keyword.toLowerCase();
                } else if (rule.conditionType === 'platform_contains') {
                    shouldApply = platformName.toLowerCase().includes(keyword.toLowerCase());
                }
                
                // ë ˆê±°ì‹œ ì§€ì› (ê¸°ì¡´ ê·œì¹™ë“¤)
                else if (rule.conditionType === 'product') {
                    shouldApply = productName.toLowerCase().includes(keyword.toLowerCase());
                } else if (rule.conditionType === 'platform') {
                    shouldApply = platformName.toLowerCase().includes(keyword.toLowerCase());
                }
                
                if (shouldApply) {
                    const element = document.getElementById(rule.fieldType);
                    if (element) {
                        element.value = rule.value;
                        element.style.backgroundColor = '#e7f3ff';
                        element.style.border = '2px solid #007bff';
                        
                        // âœ… platform_nameê³¼ channel ë™ê¸°í™”
                        if (rule.fieldType === 'platform_name') {
                            fieldMappings.channel = rule.value;
                            console.log(`ğŸ”„ ì—…ì²´ëª… ë™ê¸°í™”: platform_name = ${rule.value}, channel = ${rule.value}`);
                        } else if (rule.fieldType === 'channel') {
                            fieldMappings.platform_name = rule.value;
                            const platformElement = document.getElementById('platform_name');
                            if (platformElement) {
                                platformElement.value = rule.value;
                            }
                            console.log(`ğŸ”„ í”Œë«í¼ëª… ë™ê¸°í™”: channel = ${rule.value}, platform_name = ${rule.value}`);
                        }
                        
                        // ì˜ˆì•½ ìƒíƒœ ë³€ê²½ ì‹œ ì‹œê°ì  í”¼ë“œë°±
                        if (rule.fieldType === 'payment_status') {
                            const statusColors = {
                                'pending': '#fff3cd',
                                'in_progress': '#cff4fc', 
                                'confirmed': '#d1ecf1',
                                'cancelled': '#f8d7da'
                            };
                            element.style.backgroundColor = statusColors[rule.value] || '#e7f3ff';
                        }
                        
                        console.log(`ğŸ¯ íŒŒì‹± ê·œì¹™ ì ìš©: ${rule.description} (${rule.fieldType}: ${rule.value})`);
                        showRuleNotification(`ğŸ¯ íŒŒì‹± ê·œì¹™ ì ìš©: ${rule.description}`);
                    }
                }
            });
        }

        // ê·œì¹™ ë‚´ë³´ë‚´ê¸°
        function exportRules() {
            const data = JSON.stringify(customParsingRules, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `parsing-rules-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showRuleNotification('ğŸ“ ê·œì¹™ì´ JSON íŒŒì¼ë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤.');
        }

        // í•„ë“œ íƒ€ì…ì— ë”°ë¥¸ ì„¤ì •ê°’ ì˜µì…˜ ì—…ë°ì´íŠ¸
        function updateValueOptions() {
            const fieldType = document.getElementById('newFieldType').value;
            const valueSelect = document.getElementById('newValue');
            
            // ê¸°ì¡´ ì˜µì…˜ ì œê±°
            valueSelect.innerHTML = '';
            
            // í•„ë“œ íƒ€ì…ë³„ ì˜µì…˜ ì •ì˜
            const valueOptions = {
                'payment_status': [
                    { value: 'pending', text: 'ëŒ€ê¸°ì¤‘ (ì‹ ê·œì˜ˆì•½)' },
                    { value: 'in_progress', text: 'ìˆ˜ë°°ì¤‘ (í˜„ì§€ìˆ˜ë°°)' },
                    { value: 'confirmed', text: 'í™•ì • (ìˆ˜ë°°ì™„ë£Œ)' },
                    { value: 'cancelled', text: 'ì˜ˆì•½ì·¨ì†Œ' },
                    { value: 'refunded', text: 'í™˜ë¶ˆì™„ë£Œ' }
                ],
                'adult_count': [
                    { value: '1', text: '1ëª…' },
                    { value: '2', text: '2ëª…' },
                    { value: '3', text: '3ëª…' },
                    { value: '4', text: '4ëª…' },
                    { value: '5', text: '5ëª…' },
                    { value: '6', text: '6ëª…' },
                    { value: '7', text: '7ëª…' },
                    { value: '8', text: '8ëª…' }
                ],
                'child_count': [
                    { value: '0', text: '0ëª…' },
                    { value: '1', text: '1ëª…' },
                    { value: '2', text: '2ëª…' },
                    { value: '3', text: '3ëª…' },
                    { value: '4', text: '4ëª…' }
                ],
                'infant_count': [
                    { value: '0', text: '0ëª…' },
                    { value: '1', text: '1ëª…' },
                    { value: '2', text: '2ëª…' }
                ],
                'total_amount': [
                    { value: '50', text: '$50' },
                    { value: '80', text: '$80' },
                    { value: '100', text: '$100' },
                    { value: '120', text: '$120' },
                    { value: '150', text: '$150' },
                    { value: '200', text: '$200' }
                ],
                'adult_price': [
                    { value: '50', text: '$50' },
                    { value: '60', text: '$60' },
                    { value: '70', text: '$70' },
                    { value: '80', text: '$80' },
                    { value: '90', text: '$90' },
                    { value: '100', text: '$100' }
                ],
                'child_price': [
                    { value: '30', text: '$30' },
                    { value: '40', text: '$40' },
                    { value: '50', text: '$50' },
                    { value: '60', text: '$60' }
                ],
                'infant_price': [
                    { value: '0', text: '$0 (ë¬´ë£Œ)' },
                    { value: '10', text: '$10' },
                    { value: '20', text: '$20' }
                ],
                'platform_name': [
                    { value: 'KLOOK', text: 'KLOOK' },
                    { value: 'íˆ¬ì–´ë¹„ìŠ¤', text: 'íˆ¬ì–´ë¹„ìŠ¤' },
                    { value: 'ë…¸ì„íˆ¬ì–´', text: 'ë…¸ì„íˆ¬ì–´' },
                    { value: 'ê´Œíˆ¬ì–´', text: 'ê´Œíˆ¬ì–´' },
                    { value: 'í•˜ë‚˜íˆ¬ì–´', text: 'í•˜ë‚˜íˆ¬ì–´' },
                    { value: 'ëª¨ë‘íˆ¬ì–´', text: 'ëª¨ë‘íˆ¬ì–´' },
                    { value: 'custom', text: 'ì§ì ‘ ì…ë ¥' }
                ],
                'channel': [
                    { value: 'KLOOK', text: 'KLOOK' },
                    { value: 'íˆ¬ì–´ë¹„ìŠ¤', text: 'íˆ¬ì–´ë¹„ìŠ¤' },
                    { value: 'ë…¸ì„íˆ¬ì–´', text: 'ë…¸ì„íˆ¬ì–´' },
                    { value: 'ê´Œíˆ¬ì–´', text: 'ê´Œíˆ¬ì–´' },
                    { value: 'í•˜ë‚˜íˆ¬ì–´', text: 'í•˜ë‚˜íˆ¬ì–´' },
                    { value: 'ëª¨ë‘íˆ¬ì–´', text: 'ëª¨ë‘íˆ¬ì–´' },
                    { value: 'custom', text: 'ì§ì ‘ ì…ë ¥' }
                ],
                'product_name': [
                    { value: 'ê´Œ ë³„ë¹›íˆ¬ì–´', text: 'ê´Œ ë³„ë¹›íˆ¬ì–´' },
                    { value: 'ê´Œ ëŒí•€íˆ¬ì–´', text: 'ê´Œ ëŒí•€íˆ¬ì–´' },
                    { value: 'ê´Œ ìŠ¤ë…¸í´ë§', text: 'ê´Œ ìŠ¤ë…¸í´ë§' },
                    { value: 'ê´Œ ì„ ì…‹í¬ë£¨ì¦ˆ', text: 'ê´Œ ì„ ì…‹í¬ë£¨ì¦ˆ' },
                    { value: 'ê´Œ ì‹œí‹°íˆ¬ì–´', text: 'ê´Œ ì‹œí‹°íˆ¬ì–´' },
                    { value: 'ê´Œ ì˜¤ì…˜ë·°', text: 'ê´Œ ì˜¤ì…˜ë·°' },
                    { value: 'custom', text: 'ì§ì ‘ ì…ë ¥' }
                ],
                'package_type': [
                    { value: '1ì°¨ (ì„ ì…‹ & ë³„ë¹›íˆ¬ì–´)', text: '1ì°¨ (ì„ ì…‹ & ë³„ë¹›íˆ¬ì–´)' },
                    { value: '2ì°¨ (ë³„ë¹›íˆ¬ì–´)', text: '2ì°¨ (ë³„ë¹›íˆ¬ì–´)' },
                    { value: 'ì˜¤ì „ íˆ¬ì–´', text: 'ì˜¤ì „ íˆ¬ì–´' },
                    { value: 'ì˜¤í›„ íˆ¬ì–´', text: 'ì˜¤í›„ íˆ¬ì–´' },
                    { value: 'í”½ì—… í¬í•¨', text: 'í”½ì—… í¬í•¨' },
                    { value: 'í”½ì—… ë¯¸í¬í•¨', text: 'í”½ì—… ë¯¸í¬í•¨' },
                    { value: 'custom', text: 'ì§ì ‘ ì…ë ¥' }
                ]
            };
            
            if (fieldType && valueOptions[fieldType]) {
                // ê¸°ë³¸ ì˜µì…˜ ì¶”ê°€
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- ê°’ ì„ íƒ --';
                valueSelect.appendChild(defaultOption);
                
                // í•´ë‹¹ í•„ë“œì˜ ì˜µì…˜ë“¤ ì¶”ê°€
                valueOptions[fieldType].forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.text;
                    valueSelect.appendChild(optionElement);
                });
                
                // ì§ì ‘ ì…ë ¥ ì˜µì…˜ ì¶”ê°€
                const customOption = document.createElement('option');
                customOption.value = 'CUSTOM';
                customOption.textContent = 'ğŸ–Šï¸ ì§ì ‘ ì…ë ¥...';
                valueSelect.appendChild(customOption);
                
            } else {
                // í•„ë“œê°€ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš°
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- ë¨¼ì € í•„ë“œë¥¼ ì„ íƒí•˜ì„¸ìš” --';
                valueSelect.appendChild(defaultOption);
            }
        }

        // ì„¤ì •ê°’ ë³€ê²½ ì²˜ë¦¬ (ì§ì ‘ ì…ë ¥ ëª¨ë“œ)
        function handleValueChange() {
            const valueSelect = document.getElementById('newValue');
            const customInput = document.getElementById('customValue');
            
            if (valueSelect.value === 'CUSTOM') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                customInput.value = '';
            }
        }

        // ìƒˆ ê·œì¹™ ì¶”ê°€ (ê¸°ì¡´ í•¨ìˆ˜ ëŒ€ì²´)
        function addCustomRule() {
            // ëª¨ë‹¬ì´ ì´ë¯¸ ì—´ë ¤ìˆìœ¼ë¯€ë¡œ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
        }

        // ì „ì²´ ì´ˆê¸°í™”
        function clearAll() {
            if (confirm('ì „ì²´ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ˆê¸°í™” ë‚´ìš©:\n- íŒŒì‹± ì…ë ¥ í…ìŠ¤íŠ¸\n- ë¯¸ë¦¬ë³´ê¸° ì˜ì—­\n- ì•Œë¦¼ ë©”ì‹œì§€\n- íŒŒì‹± ë°ì´í„°')) {
                // 1. íŒŒì‹± ì…ë ¥ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
                document.getElementById('reservationText').value = '';
                
                // 2. ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ ì´ˆê¸°í™”
                const previewArea = document.getElementById('previewArea');
                previewArea.innerHTML = '<p class="text-muted">íŒŒì‹±ëœ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>';
                
                // 3. íŒŒì‹± ë°ì´í„° ì´ˆê¸°í™”
                parsedData = null;
                
                // 4. ëª¨ë“  ì•Œë¦¼ ì œê±°
                const notifications = document.querySelectorAll('.rule-notification, .alert');
                notifications.forEach(notification => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                });
                
                // 5. ì„±ê³µ ë©”ì‹œì§€
                const successAlert = document.createElement('div');
                successAlert.className = 'alert alert-success alert-dismissible fade show mt-2';
                successAlert.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>ì „ì²´ ì´ˆê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                const container = document.querySelector('.container-fluid');
                container.insertBefore(successAlert, container.firstChild.nextSibling);
                
                // 3ì´ˆ í›„ ì„±ê³µ ë©”ì‹œì§€ ì œê±°
                setTimeout(() => {
                    if (successAlert.parentNode) {
                        successAlert.remove();
                    }
                }, 3000);
                
                console.log('ğŸ§¹ ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ');
            }
        }

        // ì´ ì¸ì› ë° ê¸ˆì•¡ ê³„ì‚°
        function calculateTotal() {
            const adultCount = parseInt(document.getElementById('adult_count').value) || 0;
            const childCount = parseInt(document.getElementById('child_count').value) || 0;
            const infantCount = parseInt(document.getElementById('infant_count').value) || 0;
            
            // íŒë§¤ê°€
            const adultPrice = parseFloat(document.getElementById('adult_price').value) || 0;
            const childPrice = parseFloat(document.getElementById('child_price').value) || 0;
            const infantPrice = parseFloat(document.getElementById('infant_price').value) || 0;
            
            // ì›ê°€
            const adultCost = parseFloat(document.getElementById('adult_cost').value) || 0;
            const childCost = parseFloat(document.getElementById('child_cost').value) || 0;
            const infantCost = parseFloat(document.getElementById('infant_cost').value) || 0;
            
            // í†µí™”
            const adultCurrency = document.getElementById('adult_currency').value || 'USD';
            const childCurrency = document.getElementById('child_currency').value || 'USD';
            const infantCurrency = document.getElementById('infant_currency').value || 'USD';
            
            const adultCostCurrency = document.getElementById('adult_cost_currency').value || 'USD';
            const childCostCurrency = document.getElementById('child_cost_currency').value || 'USD';
            const infantCostCurrency = document.getElementById('infant_cost_currency').value || 'USD';
            
            // ìˆ˜ìˆ˜ë£Œìœ¨ ê°€ì ¸ì˜¤ê¸° (RAGì—ì„œ ì„¤ì •ëœ ê°’)
            const commissionRate = window.ragCommissionRate || 0;
            
            // í™˜ìœ¨ (í™˜ìœ¨ê´€ë¦¬ì—ì„œ ê°€ì ¸ì˜¨ ìµœì‹  í™˜ìœ¨)
            const exchangeRate = window.latestExchangeRate || 1300;
            
            // í†µí™” ë³€í™˜ í•¨ìˆ˜ (ëª¨ë“  ê¸ˆì•¡ì„ ì›í™”ë¡œ í†µì¼)
            function convertToKRW(amount, currency) {
                if (currency === 'USD') {
                    return amount * exchangeRate;
                }
                return amount; // ì´ë¯¸ KRW
            }
            
            // íŒë§¤ê°€ë¥¼ ì›í™”ë¡œ ë³€í™˜
            const adultPriceKRW = convertToKRW(adultPrice, adultCurrency);
            const childPriceKRW = convertToKRW(childPrice, childCurrency);
            const infantPriceKRW = convertToKRW(infantPrice, infantCurrency);
            
            // ì›ê°€ë¥¼ ì›í™”ë¡œ ë³€í™˜
            const adultCostKRW = convertToKRW(adultCost, adultCostCurrency);
            const childCostKRW = convertToKRW(childCost, childCostCurrency);
            const infantCostKRW = convertToKRW(infantCost, infantCostCurrency);
            
            // ë§ˆì§„ ê³„ì‚° (ì›í™” ê¸°ì¤€: íŒë§¤ê°€ - ì›ê°€ - ìˆ˜ìˆ˜ë£Œ)
            const adultCommissionKRW = adultPriceKRW * (commissionRate / 100);
            const childCommissionKRW = childPriceKRW * (commissionRate / 100);
            const infantCommissionKRW = infantPriceKRW * (commissionRate / 100);
            
            const adultMarginKRW = adultPriceKRW - adultCostKRW - adultCommissionKRW;
            const childMarginKRW = childPriceKRW - childCostKRW - childCommissionKRW;
            const infantMarginKRW = infantPriceKRW - infantCostKRW - infantCommissionKRW;
            
            console.log('ğŸ’° ë§ˆì§„ ê³„ì‚° (í™˜ìœ¨ ì ìš©):', {
                exchangeRate: exchangeRate,
                commissionRate: commissionRate + '%',
                adult: { 
                    priceOriginal: `${adultPrice} ${adultCurrency}`,
                    priceKRW: adultPriceKRW, 
                    costOriginal: `${adultCost} ${adultCostCurrency}`,
                    costKRW: adultCostKRW, 
                    commission: adultCommissionKRW, 
                    margin: adultMarginKRW 
                },
                child: { 
                    priceOriginal: `${childPrice} ${childCurrency}`,
                    priceKRW: childPriceKRW, 
                    costOriginal: `${childCost} ${childCostCurrency}`,
                    costKRW: childCostKRW, 
                    commission: childCommissionKRW, 
                    margin: childMarginKRW 
                },
                infant: { 
                    priceOriginal: `${infantPrice} ${infantCurrency}`,
                    priceKRW: infantPriceKRW, 
                    costOriginal: `${infantCost} ${infantCostCurrency}`,
                    costKRW: infantCostKRW, 
                    commission: infantCommissionKRW, 
                    margin: infantMarginKRW 
                }
            });
            
            // ì„±ì¸ ë§ˆì§„ í‘œì‹œ (ì›í™” ê¸°ì¤€)
            if (adultPrice > 0 || adultCost > 0) {
                const display = `â‚©${Math.round(adultMarginKRW).toLocaleString('ko-KR')}`;
                document.getElementById('adult_margin').value = display;
            } else {
                document.getElementById('adult_margin').value = '';
            }
            
            // ì†Œì•„ ë§ˆì§„ í‘œì‹œ (ì›í™” ê¸°ì¤€)
            if (childPrice > 0 || childCost > 0) {
                const display = `â‚©${Math.round(childMarginKRW).toLocaleString('ko-KR')}`;
                document.getElementById('child_margin').value = display;
            } else {
                document.getElementById('child_margin').value = '';
            }
            
            // ìœ ì•„ ë§ˆì§„ í‘œì‹œ (ì›í™” ê¸°ì¤€)
            if (infantPrice > 0 || infantCost > 0) {
                const display = `â‚©${Math.round(infantMarginKRW).toLocaleString('ko-KR')}`;
                document.getElementById('infant_margin').value = display;
            } else {
                document.getElementById('infant_margin').value = '';
            }
            
            // ì´ ì¸ì› ê³„ì‚°
            const totalGuests = adultCount + childCount + infantCount;
            document.getElementById('total_guests').value = totalGuests;
            
            // ì´ ê¸ˆì•¡ ê³„ì‚° (íŒë§¤ê°€ ê¸°ì¤€)
            const adultTotal = adultCount * adultPrice;
            const childTotal = childCount * childPrice;
            const infantTotal = infantCount * infantPrice;
            const totalAmount = adultTotal + childTotal + infantTotal;
            
            const mainCurrency = adultCurrency || childCurrency || infantCurrency || 'USD';
            const totalDisplay = mainCurrency === 'USD' ? 
                `$${totalAmount.toFixed(2)}` : `â‚©${Math.round(totalAmount).toLocaleString('ko-KR')}`;
            document.getElementById('total_amount').value = totalDisplay;
            
            // ê³„ì‚°ì‹ í‘œì‹œ
            let formula = [];
            if (adultCount > 0) {
                const adultDisplay = adultCurrency === 'USD' ? 
                    `$${adultPrice.toFixed(2)}` : `â‚©${Math.round(adultPrice).toLocaleString('ko-KR')}`;
                formula.push(`ì„±ì¸${adultCount}Ã—${adultDisplay}`);
            }
            if (childCount > 0) {
                const childDisplay = childCurrency === 'USD' ? 
                    `$${childPrice.toFixed(2)}` : `â‚©${Math.round(childPrice).toLocaleString('ko-KR')}`;
                formula.push(`ì†Œì•„${childCount}Ã—${childDisplay}`);
            }
            if (infantCount > 0) {
                const infantDisplay = infantCurrency === 'USD' ? 
                    `$${infantPrice.toFixed(2)}` : `â‚©${Math.round(infantPrice).toLocaleString('ko-KR')}`;
                formula.push(`ìœ ì•„${infantCount}Ã—${infantDisplay}`);
            }
            
            const formulaText = formula.length > 0 ? formula.join(' + ') + ` = ${totalDisplay}` : '';
            document.getElementById('calculation_formula').value = formulaText;
            
            // ğŸ’° í†µí™” í‘œì‹œ ì—…ë°ì´íŠ¸
            updateCurrencyDisplay();
        }

        // ìˆ˜ë°°ì—…ì²´ ëª©ë¡ ë¡œë“œ
        async function loadVendors() {
            try {
                const response = await fetch('/api/vendors');
                const data = await response.json();
                
                if (data.success) {
                    const vendorSelect = document.getElementById('vendor_id');
                    vendorSelect.innerHTML = '<option value="">ë¯¸ì§€ì •</option>';
                    
                    data.vendors.forEach(vendor => {
                        if (vendor.is_active) {
                            const option = document.createElement('option');
                            option.value = vendor.id;
                            option.textContent = vendor.vendor_name;
                            vendorSelect.appendChild(option);
                        }
                    });
                    
                    console.log('âœ… ìˆ˜ë°°ì—…ì²´ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', data.vendors.length);
                }
            } catch (error) {
                console.error('âŒ ìˆ˜ë°°ì—…ì²´ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ìƒí’ˆëª… ì…ë ¥ ì‹œ ìˆ˜ë°°ì—…ì²´ ìë™ ë§¤ì¹­ (ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ìš©)
        async function matchVendorByProductOnChange() {
            const productName = document.getElementById('product_name').value;
            if (productName && productName.trim() !== '') {
                await matchVendorByProduct(productName);
            }
        }

        // ìµœì‹  USD í™˜ìœ¨ ê°€ì ¸ì˜¤ê¸°
        async function fetchLatestExchangeRate() {
            try {
                const response = await fetch('/api/exchange-rates?currency=USD');
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    window.latestExchangeRate = result.data[0].rate;
                    console.log('ğŸ’± ìµœì‹  USD í™˜ìœ¨:', window.latestExchangeRate);
                } else {
                    window.latestExchangeRate = 1300; // ê¸°ë³¸ê°’
                    console.warn('âš ï¸ í™˜ìœ¨ ì¡°íšŒ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', window.latestExchangeRate);
                }
            } catch (error) {
                console.error('í™˜ìœ¨ ì¡°íšŒ ì˜¤ë¥˜:', error);
                window.latestExchangeRate = 1300; // ê¸°ë³¸ê°’
            }
        }

        // ì¸ì› ìˆ˜ ë° ê°€ê²© ë³€ê²½ ì‹œ ì¬ê³„ì‚° - í˜ì´ì§€ ë¡œë“œ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.addEventListener('DOMContentLoaded', function() {
            // ìµœì‹  í™˜ìœ¨ ê°€ì ¸ì˜¤ê¸°
            fetchLatestExchangeRate();
            
            // ìˆ˜ë°°ì—…ì²´ ëª©ë¡ ë¡œë“œ
            loadVendors();
            
            ['adult_count', 'child_count', 'infant_count', 'adult_price', 'child_price', 'infant_price'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', calculateTotal);
                    element.addEventListener('change', calculateTotal);
                }
            });
        });

        // ì˜ˆì•½ ì €ì¥
        async function saveReservation() {
            // ë¡œë”© UI í‘œì‹œ
            const saveBtn = document.getElementById('saveBtn');
            const saveBtnText = document.getElementById('saveBtnText');
            const saveBtnSpinner = document.getElementById('saveBtnSpinner');
            const actionButtons = document.querySelectorAll('#previewArea .d-flex.gap-2 button');
            
            saveBtn.disabled = true;
            saveBtnText.textContent = 'ì €ì¥ ì¤‘';
            saveBtnSpinner.style.display = 'inline-block';
            saveBtn.style.cursor = 'wait';
            
            // ë‹¤ë¥¸ ì•¡ì…˜ ë²„íŠ¼ë“¤ë„ ë¹„í™œì„±í™”
            actionButtons.forEach(btn => btn.disabled = true);
            
            const formData = {};
            
            // í¼ ë°ì´í„° ìˆ˜ì§‘
            document.querySelectorAll('#previewArea input, #previewArea select, #previewArea textarea').forEach(element => {
                if (element.name) {
                    formData[element.name] = element.value;
                }
            });

            // âœ… ìˆ˜ë°°ì—…ì²´ëŠ” íŒŒì‹± ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ì´ë¯¸ ì„ íƒë¨ (ì¤‘ë³µ ë§¤ì¹­ ì œê±°)

            // í•„ë“œëª…ì„ DB ìŠ¤í‚¤ë§ˆì— ë§ê²Œ ë§¤í•‘
            const mappedData = {
                reservation_number: formData.reservation_number,
                platform_name: formData.platform_name,
                channel: formData.platform_name,  // âœ… ì—…ì²´ëª…ê³¼ í”Œë«í¼ëª… ë™ê¸°í™”
                payment_status: formData.payment_status || 'pending', // íŒŒì‹± ê·œì¹™ì— ë”°ë¼ ì„¤ì •ëœ ìƒíƒœ ìœ ì§€
                product_name: formData.product_name,
                package_type: formData.package_type,
                usage_date: formData.tour_date,
                usage_time: formData.tour_time,
                reservation_datetime: formData.booking_date ? formData.booking_date.replace('T', ' ') : null,
                korean_name: formData.customer_name,
                english_last_name: formData.customer_lastname,
                english_first_name: formData.customer_firstname,
                phone: formData.customer_phone,
                email: formData.customer_email,
                kakao_id: formData.kakao_id,
                people_adult: parseInt(formData.adult_count) || 1,
                people_child: parseInt(formData.child_count) || 0,
                people_infant: parseInt(formData.infant_count) || 0,
                // íŒë§¤ê°€
                adult_price: parseFloat(formData.adult_price) || null,
                child_price: parseFloat(formData.child_price) || null,
                infant_price: parseFloat(formData.infant_price) || null,
                // ì›ê°€
                adult_cost: parseFloat(formData.adult_cost) || null,
                child_cost: parseFloat(formData.child_cost) || null,
                infant_cost: parseFloat(formData.infant_cost) || null,
                // íŒë§¤ê°€ í†µí™”
                adult_currency: formData.adult_currency || 'USD',
                child_currency: formData.child_currency || 'USD',
                infant_currency: formData.infant_currency || 'USD',
                // ì›ê°€ í†µí™”
                adult_cost_currency: formData.adult_cost_currency || formData.adult_currency || 'USD',
                child_cost_currency: formData.child_cost_currency || formData.child_currency || 'USD',
                infant_cost_currency: formData.infant_cost_currency || formData.infant_currency || 'USD',
                // ìˆ˜ìˆ˜ë£Œìœ¨ (RAGì—ì„œ ê°€ì ¸ì˜¨ ê°’)
                commission_rate: window.ragCommissionRate || 10,
                // í™˜ìœ¨ (ì¸ë°•ìŠ¤ì—ì„œ ê³„ì‚°í•œ í™˜ìœ¨)
                exchange_rate: window.latestExchangeRate || 1300,
                memo: formData.special_requests,
                guest_count: (parseInt(formData.adult_count) || 1) + (parseInt(formData.child_count) || 0) + (parseInt(formData.infant_count) || 0),
                vendor_id: formData.vendor_id || null // ìˆ˜ë°°ì—…ì²´ ID ì¶”ê°€
            };
            
            console.log('ğŸ’¾ ì €ì¥í•  ë°ì´í„°:', mappedData);
            console.log('ğŸ¢ ì„ íƒëœ ìˆ˜ë°°ì—…ì²´ ID:', formData.vendor_id);
            console.log('ğŸ“‹ ì—…ì²´ëª… ë™ê¸°í™”:', {
                platform_name: mappedData.platform_name,
                channel: mappedData.channel,
                ë™ì¼ì—¬ë¶€: mappedData.platform_name === mappedData.channel ? 'âœ…' : 'âŒ'
            });

            try {
                const response = await fetch('/api/reservations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(mappedData)
                });

                const result = await response.json();
                
                if (result.success || response.ok) {
                    // âœ… ì €ì¥ ê²°ê³¼ì— ë”°ë¼ ë©”ì‹œì§€ í‘œì‹œ
                    let successMessage = 'âœ… ì˜ˆì•½ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    let redirectPage = '/admin/reservations'; // ê¸°ë³¸: ì˜ˆì•½ê´€ë¦¬
                    
                    // vendor_idê°€ ìˆìœ¼ë©´ ìˆ˜ë°°ê´€ë¦¬ë¡œ, ì—†ìœ¼ë©´ ì˜ˆì•½ê´€ë¦¬ë¡œ
                    if (formData.vendor_id && formData.vendor_id !== '') {
                        successMessage += '\n\nğŸ¯ ìˆ˜ë°°ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\nìˆ˜ë°°ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...';
                        redirectPage = '/admin/assignments';
                    } else {
                        successMessage += '\n\nâš ï¸ ìˆ˜ë°°ì—…ì²´ ë¯¸ì§€ì •\nì˜ˆì•½ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.';
                    }
                    
                    alert(successMessage);
                    clearForm();
                    
                    // í•´ë‹¹ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                    setTimeout(() => {
                        window.location.href = redirectPage;
                    }, 1000);
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                // ë¡œë”© UI ë³µêµ¬
                saveBtn.disabled = false;
                saveBtnText.textContent = 'ì˜ˆì•½ ì €ì¥';
                saveBtnSpinner.style.display = 'none';
                saveBtn.style.cursor = 'pointer';
                
                // ë‹¤ë¥¸ ì•¡ì…˜ ë²„íŠ¼ë“¤ë„ í™œì„±í™”
                actionButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.cursor = 'pointer';
                });
            }
        }

        // ë‹¤ì‹œ ìˆ˜ì •
        function editRawData() {
            document.getElementById('previewArea').style.display = 'none';
            document.getElementById('reservationText').focus();
        }

        // ë¯¸ë¦¬ë³´ê¸° ì·¨ì†Œ
        function clearPreview() {
            document.getElementById('previewArea').style.display = 'none';
            parsedData = null;
        }

        // í¼ ì´ˆê¸°í™”
        function clearForm() {
            document.getElementById('reservationText').value = '';
            document.getElementById('previewArea').style.display = 'none';
            parsedData = null;
        }

        // ìƒˆë¡œê³ ì¹¨
        function refreshInbox() {
            location.reload();
        }

        // ğŸ’° ê¸ˆì•¡ ë‹¨ìœ„ ìë™ íŒë³„ í•¨ìˆ˜ (999 ì´í•˜=ë‹¬ëŸ¬, 1000 ì´ìƒ=ì›í™”)
        function determineCurrency(amount) {
            if (!amount || isNaN(amount)) {
                return { currency: 'UNKNOWN', symbol: '' };
            }
            
            if (amount <= 999) {
                return { currency: 'USD', symbol: '$' };
            } else {
                return { currency: 'KRW', symbol: 'â‚©' };
            }
        }

        // ğŸ’° ê¸ˆì•¡ì„ í†µí™” ê¸°í˜¸ì™€ í•¨ê»˜ í‘œì‹œ
        function formatCurrencyDisplay(amount) {
            if (!amount || isNaN(amount)) return '';
            
            const currencyInfo = determineCurrency(amount);
            
            if (currencyInfo.currency === 'USD') {
                return `$${parseFloat(amount).toFixed(2)}`;
            } else if (currencyInfo.currency === 'KRW') {
                return `â‚©${parseInt(amount).toLocaleString('ko-KR')}`;
            }
            
            return amount.toString();
        }

        // ğŸ’° ê¸ˆì•¡ í•„ë“œì— í†µí™” í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateCurrencyDisplay() {
            const totalAmount = document.getElementById('total_amount').value;
            const adultPrice = document.getElementById('adult_price').value;
            const childPrice = document.getElementById('child_price').value;
            const infantPrice = document.getElementById('infant_price').value;

            // ì´ ê¸ˆì•¡ í‘œì‹œ ì—…ë°ì´íŠ¸
            if (totalAmount) {
                const totalDisplay = formatCurrencyDisplay(totalAmount);
                document.getElementById('total_amount').setAttribute('data-currency', totalDisplay);
                document.getElementById('total_amount').title = totalDisplay;
            }

            // ë‹¨ê°€ í‘œì‹œ ì—…ë°ì´íŠ¸
            if (adultPrice) {
                const adultDisplay = formatCurrencyDisplay(adultPrice);
                document.getElementById('adult_price').setAttribute('data-currency', adultDisplay);
                document.getElementById('adult_price').title = adultDisplay;
            }

            if (childPrice) {
                const childDisplay = formatCurrencyDisplay(childPrice);
                document.getElementById('child_price').setAttribute('data-currency', childDisplay);
                document.getElementById('child_price').title = childDisplay;
            }

            if (infantPrice) {
                const infantDisplay = formatCurrencyDisplay(infantPrice);
                document.getElementById('infant_price').setAttribute('data-currency', infantDisplay);
                document.getElementById('infant_price').title = infantDisplay;
            }
        }

        // íŒŒì‹± ì‹œ ìˆ˜ë°°ì—…ì²´ ìë™ ë§¤ì¹­ (íŒŒì‹± ë¯¸ë¦¬ë³´ê¸°ìš©)
        async function matchVendorByProduct(productName) {
            console.log('ğŸ”µ matchVendorByProduct í˜¸ì¶œë¨:', productName);
            
            if (!productName || productName.trim() === '') {
                console.log('âš ï¸ ìƒí’ˆëª…ì´ ë¹„ì–´ìˆì–´ ë§¤ì¹­ ì¤‘ë‹¨');
                return;
            }
            
            const vendorSelect = document.getElementById('vendor_id');
            const matchBadge = document.getElementById('vendor-match-badge');
            
            try {
                console.log(`ğŸ” ìˆ˜ë°°ì—…ì²´ ë§¤ì¹­ ì‹œë„: "${productName}"`);
                console.log(`ğŸ“¡ API ìš”ì²­ ì‹œì‘: /api/vendors/match`);
                
                const response = await fetch('/api/vendors/match', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        product_name: productName.trim()
                    })
                });
                
                console.log(`ğŸ“¥ API ì‘ë‹µ ìƒíƒœ: ${response.status}`);
                const result = await response.json();
                console.log('ğŸ“¦ API ì‘ë‹µ ë°ì´í„°:', result);
                
                if (result.success && result.vendor) {
                    const vendor = result.vendor;
                    
                    // ìˆ˜ë°°ì—…ì²´ ì„ íƒ
                    vendorSelect.value = vendor.id;
                    matchBadge.style.display = 'inline-block';
                    
                    console.log(`âœ… ìˆ˜ë°°ì—…ì²´ ë§¤ì¹­ ì„±ê³µ: ${vendor.vendor_name} (ID: ${vendor.id})`);
                    console.log(`ğŸ“Œ ë§¤ì¹­ëœ íŒ¨í„´: "${result.matched_keyword}"`);
                    
                    // ë§¤ì¹­ ê²°ê³¼ ì•Œë¦¼ í‘œì‹œ
                    showRuleNotification(
                        `ğŸ¯ ìˆ˜ë°°ì—…ì²´ ìë™ ë§¤ì¹­: ${vendor.vendor_name} (íŒ¨í„´: "${result.matched_keyword}")`
                    );
                    
                } else {
                    // ë§¤ì¹­ ì‹¤íŒ¨
                    vendorSelect.value = '';
                    matchBadge.style.display = 'none';
                    console.log(`âŒ ë§¤ì¹­ë˜ëŠ” ìˆ˜ë°°ì—…ì²´ ì—†ìŒ: "${productName}"`);
                    console.log('ğŸ“„ API ì‘ë‹µ:', result);
                    showRuleNotification(`â“ "${productName}" ìƒí’ˆì— ë§¤ì¹­ë˜ëŠ” ìˆ˜ë°°ì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                }
                
            } catch (error) {
                console.error('âŒ ìˆ˜ë°°ì—…ì²´ ë§¤ì¹­ ì˜¤ë¥˜:', error);
                vendorSelect.value = '';
                matchBadge.style.display = 'none';
            }
        }

        // ë¶ë§ˆí´ë¦¿ ëª¨ë‹¬ ì—´ê¸°
        function openBookmarkletModal() {
            const modal = new bootstrap.Modal(document.getElementById('bookmarkletModal'));
            modal.show();
        }

        // ë¶ë§ˆí´ë¦¿ ì½”ë“œ ë³µì‚¬
        function copyBookmarkletCode() {
            const codeElement = document.getElementById('bookmarkletCode');
            const code = codeElement.textContent;
            
            navigator.clipboard.writeText(code).then(() => {
                showNotification('ë¶ë§ˆí´ë¦¿ ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            }).catch(err => {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                showNotification('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ì„ íƒí•˜ì—¬ ë³µì‚¬í•´ì£¼ì„¸ìš”.', 'danger');
            });
        }

        // ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showNotification(message, type = 'info') {
            // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
            const existingNotification = document.querySelector('.delete-notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // ìƒˆ ì•Œë¦¼ ìƒì„±
            const notification = document.createElement('div');
            notification.className = `delete-notification alert alert-${type} alert-dismissible fade show`;
            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            // bodyì— ì¶”ê°€
            document.body.appendChild(notification);

            // 3ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }
    </script>

    <!-- ë¶ë§ˆí´ë¦¿ ì„¤ì¹˜ ëª¨ë‹¬ -->
    <div class="modal fade" id="bookmarkletModal" tabindex="-1" aria-labelledby="bookmarkletModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="bookmarkletModalLabel">
                        <i class="fas fa-bookmark me-2"></i>ë¶ë§ˆí´ë¦¿(Bookmarklet) ì„¤ì¹˜ ê°€ì´ë“œ
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- ë¶ë§ˆí´ë¦¿ì´ë€? -->
                    <div class="alert alert-info">
                        <h6 class="alert-heading"><i class="fas fa-lightbulb me-2"></i>ë¶ë§ˆí´ë¦¿ì´ë€?</h6>
                        <p class="mb-2">ë¸Œë¼ìš°ì € ì¦ê²¨ì°¾ê¸°(ë¶ë§ˆí¬)ì— ì €ì¥í•˜ëŠ” <strong>ì‘ì€ ìë°”ìŠ¤í¬ë¦½íŠ¸ í”„ë¡œê·¸ë¨</strong>ì…ë‹ˆë‹¤.</p>
                        <p class="mb-0">
                            <i class="fas fa-check-circle text-success me-1"></i>
                            í”Œë«í¼ ì˜ˆì•½ ìƒì„¸ í˜ì´ì§€ì—ì„œ <strong>ë²„íŠ¼ í•œ ë²ˆë§Œ í´ë¦­</strong>í•˜ë©´,<br>
                            <i class="fas fa-check-circle text-success me-1 ms-3"></i>
                            í•´ë‹¹ í˜ì´ì§€ì˜ HTMLì´ ìë™ìœ¼ë¡œ ìš°ë¦¬ ì‹œìŠ¤í…œìœ¼ë¡œ ì „ì†¡ë˜ì–´ AIê°€ íŒŒì‹±í•©ë‹ˆë‹¤!
                        </p>
                    </div>

                    <!-- ì¥ì  -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-star text-warning me-2"></i>ì™œ í•„ìš”í•œê°€ìš”?</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-danger"><i class="fas fa-times-circle me-1"></i>ê¸°ì¡´ ë°©ì‹</h6>
                                    <ul class="text-muted">
                                        <li>ì´ë©”ì¼ ë§í¬ í´ë¦­ â†’ í”Œë«í¼ ë¡œê·¸ì¸</li>
                                        <li>ë§ˆì´í˜ì´ì§€ â†’ ì˜ˆì•½ ìƒì„¸ í˜ì´ì§€ ì—´ê¸°</li>
                                        <li>ì •ë³´ ë³µì‚¬ â†’ ë¶™ì—¬ë„£ê¸° â†’ íŒŒì‹±</li>
                                        <li><strong>ë²ˆê±°ë¡­ê³  ì‹œê°„ ì†Œìš”!</strong></li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-success"><i class="fas fa-check-circle me-1"></i>ë¶ë§ˆí´ë¦¿ ë°©ì‹</h6>
                                    <ul>
                                        <li>í”Œë«í¼ì— <strong>ì´ë¯¸ ë¡œê·¸ì¸ëœ ìƒíƒœ</strong></li>
                                        <li>ì˜ˆì•½ ìƒì„¸ í˜ì´ì§€ì—ì„œ</li>
                                        <li><strong>ë¶ë§ˆí¬ ë²„íŠ¼ í•œ ë²ˆ í´ë¦­!</strong></li>
                                        <li>ìë™ìœ¼ë¡œ HTML ì „ì†¡ â†’ AI íŒŒì‹± â†’ ì¸ë°•ìŠ¤ ë“±ë¡ âœ¨</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì„¤ì¹˜ ë°©ë²• -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="fas fa-download me-2"></i>ì„¤ì¹˜ ë°©ë²• (í•œ ë²ˆë§Œ í•˜ë©´ ë¨)</h6>
                        </div>
                        <div class="card-body">
                            <ol class="mb-3">
                                <li class="mb-2">
                                    <strong>ë¸Œë¼ìš°ì € ë¶ë§ˆí¬ë°” í‘œì‹œ</strong>
                                    <ul class="text-muted small">
                                        <li>Chrome/Edge: <kbd>Ctrl+Shift+B</kbd></li>
                                        <li>Safari: <kbd>âŒ˜+Shift+B</kbd></li>
                                    </ul>
                                </li>
                                <li class="mb-2">
                                    <strong>ë¶ë§ˆí¬ë°”ì—ì„œ ë§ˆìš°ìŠ¤ ìš°í´ë¦­</strong> â†’ <strong>"ìƒˆ ë¶ë§ˆí¬ ì¶”ê°€"</strong> ì„ íƒ
                                </li>
                                <li class="mb-2">
                                    <strong>ì´ë¦„</strong>: <code>ğŸ“¥ ì˜ˆì•½ì „ì†¡</code> (ì›í•˜ëŠ” ì´ë¦„ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥)
                                </li>
                                <li class="mb-2">
                                    <strong>URL/ì£¼ì†Œ</strong>: ì•„ë˜ ì½”ë“œë¥¼ <strong>ì „ì²´ ë³µì‚¬</strong>í•˜ì—¬ ë¶™ì—¬ë„£ê¸°
                                    <div class="mt-2">
                                        <div class="input-group">
                                            <input type="text" class="form-control font-monospace small" id="bookmarkletCode" readonly
                                                   value="javascript:(()=>{const u='https://www.guamsavecard.com/api/ingest/html';const b=new Blob([document.documentElement.outerHTML],{type:'text/html'});const f=new FormData();f.append('html',b,'page.html');f.append('page_url',location.href);fetch(u,{method:'POST',body:f,credentials:'include'}).then(r=>r.json()).then(x=>alert('ì „ì†¡ì™„ë£Œ: '+(x.ok?'ì„±ê³µ':'ì‹¤íŒ¨'))).catch(e=>alert('ì˜¤ë¥˜: '+e));})();">
                                            <button class="btn btn-outline-primary" type="button" onclick="copyBookmarkletCode()">
                                                <i class="fas fa-copy me-1"></i>ë³µì‚¬
                                            </button>
                                        </div>
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            ìœ„ ì½”ë“œë¥¼ ë³µì‚¬í•˜ì—¬ ë¶ë§ˆí¬ì˜ URL/ì£¼ì†Œ í•„ë“œì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”
                                        </small>
                                    </div>
                                </li>
                                <li class="mb-2">
                                    <strong>ì €ì¥</strong> í´ë¦­! ì™„ë£Œ! ğŸ‰
                                </li>
                            </ol>
                        </div>
                    </div>

                    <!-- ì‚¬ìš© ë°©ë²• -->
                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="fas fa-rocket me-2"></i>ì‚¬ìš© ë°©ë²•</h6>
                        </div>
                        <div class="card-body">
                            <ol>
                                <li class="mb-2">
                                    <strong>í”Œë«í¼ ì‚¬ì´íŠ¸ì— ë¡œê·¸ì¸</strong> (KLOOK, Viator, NOL ë“±)
                                </li>
                                <li class="mb-2">
                                    <strong>ì˜ˆì•½ ìƒì„¸ í˜ì´ì§€</strong> (ë§ˆì´í˜ì´ì§€ â†’ ì˜ˆì•½ ë‚´ì—­)ë¡œ ì´ë™
                                </li>
                                <li class="mb-2">
                                    ë¸Œë¼ìš°ì € ë¶ë§ˆí¬ë°”ì—ì„œ <strong>ğŸ“¥ ì˜ˆì•½ì „ì†¡</strong> í´ë¦­!
                                </li>
                                <li class="mb-2">
                                    ì ì‹œ í›„ <span class="badge bg-success">ì „ì†¡ì™„ë£Œ: ì„±ê³µ</span> íŒì—…ì´ ëœ¨ë©´ ì™„ë£Œ!
                                </li>
                                <li class="mb-0">
                                    <strong>ì¸ë°•ìŠ¤ í˜ì´ì§€</strong>ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ìë™ìœ¼ë¡œ íŒŒì‹±ëœ ì˜ˆì•½ì´ í‘œì‹œë©ë‹ˆë‹¤ âœ¨
                                </li>
                            </ol>
                            <div class="alert alert-warning mt-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>ì£¼ì˜:</strong> ë°˜ë“œì‹œ <strong>í”Œë«í¼ì— ë¡œê·¸ì¸ëœ ìƒíƒœ</strong>ì—ì„œ ì‚¬ìš©í•˜ì„¸ìš”!<br>
                                ë¡œê·¸ì¸í•˜ì§€ ì•Šìœ¼ë©´ ì˜ˆì•½ ìƒì„¸ ì •ë³´ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                            </div>
                        </div>
                    </div>

                    <!-- ë¬¸ì œ í•´ê²° -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-wrench me-2"></i>ë¬¸ì œ í•´ê²°</h6>
                        </div>
                        <div class="card-body">
                            <dl class="mb-0">
                                <dt><i class="fas fa-question-circle text-info me-1"></i>"ì „ì†¡ì™„ë£Œ: ì‹¤íŒ¨" ë©”ì‹œì§€ê°€ ëœ° ë•Œ</dt>
                                <dd class="text-muted">
                                    â†’ ê´Œì„¸ì´ë¸Œì¹´ë“œ ê´€ë¦¬ìì— ë¡œê·¸ì¸ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”<br>
                                    â†’ ë¸Œë¼ìš°ì € ì¿ í‚¤ê°€ ì°¨ë‹¨ë˜ì–´ ìˆì§€ ì•Šì€ì§€ í™•ì¸í•˜ì„¸ìš”
                                </dd>
                                
                                <dt class="mt-3"><i class="fas fa-question-circle text-info me-1"></i>ë¶ë§ˆí¬ë¥¼ í´ë¦­í•´ë„ ì•„ë¬´ ë°˜ì‘ì´ ì—†ì„ ë•Œ</dt>
                                <dd class="text-muted">
                                    â†’ ë¶ë§ˆí¬ URLì— ì½”ë“œê°€ ì˜¬ë°”ë¥´ê²Œ ë³µì‚¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”<br>
                                    â†’ <code>javascript:(()=>{...</code>ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤
                                </dd>
                                
                                <dt class="mt-3"><i class="fas fa-question-circle text-info me-1"></i>íŒŒì‹±ì´ ì œëŒ€ë¡œ ì•ˆ ë  ë•Œ</dt>
                                <dd class="text-muted mb-0">
                                    â†’ í”Œë«í¼ì˜ í˜ì´ì§€ êµ¬ì¡°ê°€ ë³€ê²½ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
                                    â†’ ì¸ë°•ìŠ¤ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì •í•˜ê±°ë‚˜ ê°œë°œíŒ€ì— ë¬¸ì˜í•˜ì„¸ìš”
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    <button type="button" class="btn btn-primary" onclick="copyBookmarkletCode()">
                        <i class="fas fa-copy me-1"></i>ì½”ë“œ ë³µì‚¬
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI íŒŒì‹± ì„¤ì • ëª¨ë‹¬ -->
    <div class="modal fade" id="parsingSettingsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-cog me-2"></i>AI íŒŒì‹± ì„¤ì •</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#preprocessingTab">
                                <i class="fas fa-filter me-1"></i>ì „ì²˜ë¦¬ ê·œì¹™
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#promptTab">
                                <i class="fas fa-comment-dots me-1"></i>í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿
                            </a>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3">
                        <!-- ì „ì²˜ë¦¬ ê·œì¹™ íƒ­ -->
                        <div class="tab-pane fade show active" id="preprocessingTab">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">ë°ì´í„° ì „ì²˜ë¦¬ ê·œì¹™</h6>
                                    <small class="text-muted">AI íŒŒì‹± ì „ì— ë¶ˆí•„ìš”í•œ í…ìŠ¤íŠ¸ë¥¼ ìë™ìœ¼ë¡œ ì œê±°í•˜ê±°ë‚˜ ë³€ê²½í•©ë‹ˆë‹¤</small>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <button class="btn btn-sm btn-primary" onclick="addPreprocessingRule()">
                                            <i class="fas fa-plus me-1"></i>ê·œì¹™ ì¶”ê°€
                                        </button>
                                    </div>
                                    <div id="preprocessingRulesList"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ íƒ­ -->
                        <div class="tab-pane fade" id="promptTab">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">AI í”„ë¡¬í”„íŠ¸ ì¶”ê°€ ì§€ì¹¨</h6>
                                    <small class="text-muted">AIì—ê²Œ ì „ë‹¬í•  ì¶”ê°€ ì§€ì¹¨ì„ ì„¤ì •í•©ë‹ˆë‹¤</small>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">í”„ë¡¬í”„íŠ¸ ì¶”ê°€ ë¬¸êµ¬</label>
                                        <textarea class="form-control" id="customPromptText" rows="6" 
                                                placeholder="ì˜ˆ: ìƒí’ˆëª…ì—ì„œ ë‚ ì§œì™€ ì‹œê°„ ì •ë³´ë¥¼ ì œê±°í•˜ì„¸ìš”.&#10;ì˜ˆ: ê°€ê²©ì€ í•­ìƒ ìˆ«ìë§Œ ì¶”ì¶œí•˜ì„¸ìš”.&#10;ì˜ˆ: í†µí™”ëŠ” USD ë˜ëŠ” KRWë§Œ ì¸ì‹í•˜ì„¸ìš”."></textarea>
                                        <small class="text-muted mt-2 d-block">
                                            ì´ ë¬¸êµ¬ê°€ AI í”„ë¡¬í”„íŠ¸ì— ì¶”ê°€ë˜ì–´ ë” ì •í™•í•œ íŒŒì‹±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-primary" onclick="saveParsingSettings()">
                        <i class="fas fa-save me-1"></i>ì €ì¥
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
