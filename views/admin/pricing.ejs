<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš”ê¸ˆ RAG ê´€ë¦¬ - ê´Œì„¸ì´ë¸Œì¹´ë“œ ê´€ë¦¬ì</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .package-option {
            border-left: 4px solid #0d6efd;
        }
        .package-option:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .margin-preview {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar', { currentPage: 'pricing' }) %>
    
    <div class="container-fluid mt-4" style="max-width: 1400px;">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-dollar-sign me-2 text-primary"></i>ìš”ê¸ˆ RAG ê´€ë¦¬</h2>
                    <div>
                        <span class="badge bg-info me-2">ë²„ì „ ê´€ë¦¬</span>
                        <span class="badge bg-success">ë³€ê²½ ì´ë ¥ ìë™ ì €ì¥</span>
                    </div>
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>ìš”ê¸ˆ RAGë€?</strong> ì—…ì²´ë³„/ìƒí’ˆë³„ íŒë§¤ê°€, ìˆ˜ìˆ˜ë£Œìœ¨, ì›ê°€ë¥¼ ë“±ë¡í•˜ë©´ <strong>ì¸ë°•ìŠ¤ì—ì„œ ì˜ˆì•½ ì €ì¥ ì‹œ ìë™ìœ¼ë¡œ ê¸ˆì•¡ì´ ë§¤ì¹­</strong>ë©ë‹ˆë‹¤. 
                    íŒ¨í‚¤ì§€ ì˜µì…˜ë³„ë¡œ ìƒì„¸ ìš”ê¸ˆ ê´€ë¦¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                </div>

                <!-- ìš”ê¸ˆ ë“±ë¡/ìˆ˜ì • í¼ -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>ìš”ê¸ˆ ì •ë³´ ë“±ë¡</h5>
                        <button type="button" class="btn btn-sm btn-light" onclick="resetPricingForm()">
                            <i class="fas fa-redo me-1"></i>ì´ˆê¸°í™”
                        </button>
                    </div>
                    <div class="card-body">
                        <form id="pricingForm">
                            <input type="hidden" id="pricingId">
                            
                            <!-- 1ë‹¨ê³„: ê¸°ë³¸ ì •ë³´ -->
                            <div class="row g-3 mb-4">
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">ì—…ì²´ëª… (í”Œë«í¼) <span class="text-danger">*</span></label>
                                    <select class="form-select" id="platformName" required>
                                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                    </select>
                                    <small class="text-muted">ì˜ˆì•½ í”Œë«í¼ ì„ íƒ</small>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">ìƒí’ˆëª… <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="productName" placeholder="ì˜ˆ: ê´Œ ëŒí•€í¬ë£¨ì¦ˆ íˆ¬ì–´" required>
                                    <small class="text-muted">ì‹¤ì œ ìƒí’ˆ ì´ë¦„</small>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">ìˆ˜ìˆ˜ë£Œìœ¨ (ì „ì²´ ê³µí†µ) <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="commissionRate" step="0.01" placeholder="15" required onchange="recalculateAllMargins()">
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <small class="text-muted">ëª¨ë“  ì˜µì…˜ì— ë™ì¼ ì ìš©</small>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">ìˆ˜ë°°ì—…ì²´</label>
                                    <select class="form-select" id="vendorId">
                                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                    </select>
                                    <small class="text-muted">ê³µê¸‰ì‚¬ ì„ íƒ (ì„ íƒì‚¬í•­)</small>
                                </div>
                            </div>

                            <hr>

                            <!-- 2ë‹¨ê³„: íŒ¨í‚¤ì§€ ì˜µì…˜ ê´€ë¦¬ -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">
                                    <i class="fas fa-boxes me-2 text-primary"></i>íŒ¨í‚¤ì§€ ì˜µì…˜ë³„ ìš”ê¸ˆ
                                </h6>
                                <button type="button" class="btn btn-sm btn-success" onclick="addPackageOption()">
                                    <i class="fas fa-plus me-1"></i>ì˜µì…˜ ì¶”ê°€
                                </button>
                            </div>

                            <div id="packageOptionsContainer">
                                <!-- ê¸°ë³¸ ì˜µì…˜ 1ê°œ -->
                                <div class="package-option card mb-3" data-index="0">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="mb-0 text-primary"><i class="fas fa-box me-1"></i>íŒ¨í‚¤ì§€ ì˜µì…˜ #1</h6>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePackageOption(0)" disabled>
                                                <i class="fas fa-trash"></i> ì‚­ì œ
                                            </button>
                                        </div>
                                        
                                        <!-- ì˜µì…˜ëª… -->
                                        <div class="row g-3 mb-3">
                                            <div class="col-md-12">
                                                <label class="form-label fw-bold">ì˜µì…˜ëª… <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" name="option_name_0" placeholder="ì˜ˆ: í”½ì—… í¬í•¨ + ì˜¤ì „, í”½ì—… ë¯¸í¬í•¨ + ì˜¤í›„" required>
                                                <small class="text-muted">í”½ì—… í¬í•¨ ì—¬ë¶€, ì´ìš© ì‹œê°„ëŒ€ ë“±ì„ ëª…ì‹œ</small>
                                            </div>
                                        </div>

                                        <hr class="my-3">

                                        <!-- ì„±ì¸/ì†Œì•„/ìœ ì•„ ìš”ê¸ˆ -->
                                        <h6 class="text-secondary mb-3"><i class="fas fa-users me-1"></i>ì¸ì›ë³„ ìš”ê¸ˆ</h6>
                                        
                                        <!-- ì„±ì¸ -->
                                        <div class="row g-2 mb-2 align-items-end">
                                            <div class="col-md-2">
                                                <label class="form-label small"><span class="badge bg-primary me-1">ì„±ì¸</span> íŒë§¤ê°€</label>
                                                <input type="number" class="form-control form-control-sm" name="adult_price_0" step="0.01" placeholder="19900 (â‚©) or 120 ($)" oninput="autoSetCurrency(this, 'adult_currency_0')">
                                                <input type="hidden" name="adult_currency_0" value="USD">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label small">ì›ê°€</label>
                                                <input type="number" class="form-control form-control-sm" name="adult_cost_0" step="0.01" placeholder="10000 (â‚©) or 85 ($)" oninput="autoSetCurrency(this, 'adult_cost_currency_0')">
                                                <input type="hidden" name="adult_cost_currency_0" value="USD">
                                            </div>

                                            <!-- ì†Œì•„ -->
                                            <div class="col-md-2">
                                                <label class="form-label small"><span class="badge bg-info me-1">ì†Œì•„</span> íŒë§¤ê°€</label>
                                                <input type="number" class="form-control form-control-sm" name="child_price_0" step="0.01" placeholder="15000 (â‚©) or 80 ($)" oninput="autoSetCurrency(this, 'child_currency_0')">
                                                <input type="hidden" name="child_currency_0" value="USD">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label small">ì›ê°€</label>
                                                <input type="number" class="form-control form-control-sm" name="child_cost_0" step="0.01" placeholder="8000 (â‚©) or 50 ($)" oninput="autoSetCurrency(this, 'child_cost_currency_0')">
                                                <input type="hidden" name="child_cost_currency_0" value="USD">
                                            </div>

                                            <!-- ìœ ì•„ -->
                                            <div class="col-md-2">
                                                <label class="form-label small"><span class="badge bg-warning text-dark me-1">ìœ ì•„</span> íŒë§¤ê°€</label>
                                                <input type="number" class="form-control form-control-sm" name="infant_price_0" step="0.01" placeholder="5000 (â‚©) or 40 ($)" oninput="autoSetCurrency(this, 'infant_currency_0')">
                                                <input type="hidden" name="infant_currency_0" value="USD">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label small">ì›ê°€</label>
                                                <input type="number" class="form-control form-control-sm" name="infant_cost_0" step="0.01" placeholder="3000 (â‚©) or 20 ($)" oninput="autoSetCurrency(this, 'infant_cost_currency_0')">
                                                <input type="hidden" name="infant_cost_currency_0" value="USD">
                                            </div>
                                        </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row g-3 mt-3">
                                <div class="col-md-12">
                                    <label class="form-label">ë¹„ê³ </label>
                                    <textarea class="form-control" id="pricingNotes" rows="2" placeholder="íŠ¹ì´ì‚¬í•­, ì‹œì¦Œë³„ ê°€ê²© ë“±..."></textarea>
                                </div>
                            </div>

                            <div class="text-end mt-3">
                                <button type="button" class="btn btn-outline-secondary me-2" onclick="resetPricingForm()">
                                    <i class="fas fa-undo me-1"></i>ì·¨ì†Œ
                                </button>
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-save me-1"></i><span id="saveBtnText">ë“±ë¡</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- ë“±ë¡ëœ ìš”ê¸ˆ ëª©ë¡ -->
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-0"><i class="fas fa-list me-2"></i>ë“±ë¡ëœ ìš”ê¸ˆ ì •ë³´</h5>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" id="pricingSearchInput" placeholder="ì—…ì²´ëª… ë˜ëŠ” ìƒí’ˆëª… ê²€ìƒ‰..." onkeypress="if(event.keyCode==13) searchPricing()">
                                    <button class="btn btn-outline-primary" onclick="searchPricing()">
                                        <i class="fas fa-search"></i> ê²€ìƒ‰
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="loadPricingList()">
                                        <i class="fas fa-sync"></i> ìƒˆë¡œê³ ì¹¨
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 12%;">ì—…ì²´ëª…</th>
                                        <th style="width: 20%;">ìƒí’ˆëª…</th>
                                        <th style="width: 12%;">ìˆ˜ë°°ì—…ì²´</th>
                                        <th style="width: 25%;">íŒ¨í‚¤ì§€ ì˜µì…˜</th>
                                        <th style="width: 8%;">ë²„ì „</th>
                                        <th style="width: 10%;">ë“±ë¡ì¼</th>
                                        <th style="width: 13%;">ì‘ì—…</th>
                                    </tr>
                                </thead>
                                <tbody id="pricingList">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted py-4">
                                            <i class="fas fa-spinner fa-spin me-2"></i>ë¡œë”© ì¤‘...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- í˜ì´ì§• -->
                        <nav aria-label="ìš”ê¸ˆ ëª©ë¡ í˜ì´ì§•">
                            <ul class="pagination justify-content-center mb-0" id="pagination">
                                <!-- ë™ì  ë¡œë“œ -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let packageOptionIndex = 1;
        let currentPage = 1;
        const USD_TO_KRW = 1330; // í™˜ìœ¨ (ì„¤ì •ì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            loadPlatforms();
            loadVendors();
            loadPricingList();
        });

        // ê¸ˆì•¡ ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ í†µí™” ì„¤ì • (999 ì´ìƒ: ì›í™”, ì´í•˜: ë‹¬ëŸ¬)
        function autoSetCurrency(input, hiddenFieldName) {
            const value = parseFloat(input.value);
            const hiddenField = document.getElementsByName(hiddenFieldName)[0];
            
            if (!isNaN(value) && value > 0) {
                if (value > 999) {
                    hiddenField.value = 'KRW';
                    input.style.borderLeft = '4px solid #4CAF50'; // ì´ˆë¡ìƒ‰ (ì›í™”)
                } else {
                    hiddenField.value = 'USD';
                    input.style.borderLeft = '4px solid #2196F3'; // íŒŒë€ìƒ‰ (ë‹¬ëŸ¬)
                }
            } else {
                input.style.borderLeft = '';
            }
        }

        // í”Œë«í¼ ëª©ë¡ ë¡œë“œ
        async function loadPlatforms() {
            try {
                const response = await fetch('/api/platforms');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('platformName');
                    select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
                    data.platforms.forEach(platform => {
                        select.innerHTML += `<option value="${platform.platform_name}">${platform.platform_name}</option>`;
                    });
                }
            } catch (error) {
                console.error('í”Œë«í¼ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ìˆ˜ë°°ì—…ì²´ ëª©ë¡ ë¡œë“œ
        async function loadVendors() {
            try {
                const response = await fetch('/api/vendors');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('vendorId');
                    select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
                    data.vendors.forEach(vendor => {
                        select.innerHTML += `<option value="${vendor.id}">${vendor.vendor_name}</option>`;
                    });
                }
            } catch (error) {
                console.error('ìˆ˜ë°°ì—…ì²´ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // íŒ¨í‚¤ì§€ ì˜µì…˜ ì¶”ê°€
        function addPackageOption() {
            const container = document.getElementById('packageOptionsContainer');
            const newOption = `
                <div class="package-option card mb-3" data-index="${packageOptionIndex}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0 text-primary"><i class="fas fa-box me-1"></i>íŒ¨í‚¤ì§€ ì˜µì…˜ #${packageOptionIndex + 1}</h6>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePackageOption(${packageOptionIndex})">
                                <i class="fas fa-trash"></i> ì‚­ì œ
                            </button>
                        </div>
                        
                        <!-- ì˜µì…˜ëª… -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-12">
                                <label class="form-label fw-bold">ì˜µì…˜ëª… <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="option_name_${packageOptionIndex}" placeholder="ì˜ˆ: í”½ì—… í¬í•¨ + ì˜¤ì „, í”½ì—… ë¯¸í¬í•¨ + ì˜¤í›„" required>
                                <small class="text-muted">í”½ì—… í¬í•¨ ì—¬ë¶€, ì´ìš© ì‹œê°„ëŒ€ ë“±ì„ ëª…ì‹œ</small>
                            </div>
                        </div>

                        <hr class="my-3">

                        <!-- ì„±ì¸/ì†Œì•„/ìœ ì•„ ìš”ê¸ˆ -->
                        <h6 class="text-secondary mb-3"><i class="fas fa-users me-1"></i>ì¸ì›ë³„ ìš”ê¸ˆ</h6>
                        
                        <div class="row g-2 mb-2 align-items-end">
                            <div class="col-md-2">
                                <label class="form-label small"><span class="badge bg-primary me-1">ì„±ì¸</span> íŒë§¤ê°€</label>
                                <input type="number" class="form-control form-control-sm" name="adult_price_${packageOptionIndex}" step="0.01" placeholder="19900 (â‚©) or 120 ($)" oninput="autoSetCurrency(this, 'adult_currency_${packageOptionIndex}')">
                                <input type="hidden" name="adult_currency_${packageOptionIndex}" value="USD">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">ì›ê°€</label>
                                <input type="number" class="form-control form-control-sm" name="adult_cost_${packageOptionIndex}" step="0.01" placeholder="10000 (â‚©) or 85 ($)" oninput="autoSetCurrency(this, 'adult_cost_currency_${packageOptionIndex}')">
                                <input type="hidden" name="adult_cost_currency_${packageOptionIndex}" value="USD">
                            </div>

                            <!-- ì†Œì•„ -->
                            <div class="col-md-2">
                                <label class="form-label small"><span class="badge bg-info me-1">ì†Œì•„</span> íŒë§¤ê°€</label>
                                <input type="number" class="form-control form-control-sm" name="child_price_${packageOptionIndex}" step="0.01" placeholder="15000 (â‚©) or 80 ($)" oninput="autoSetCurrency(this, 'child_currency_${packageOptionIndex}')">
                                <input type="hidden" name="child_currency_${packageOptionIndex}" value="USD">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">ì›ê°€</label>
                                <input type="number" class="form-control form-control-sm" name="child_cost_${packageOptionIndex}" step="0.01" placeholder="8000 (â‚©) or 50 ($)" oninput="autoSetCurrency(this, 'child_cost_currency_${packageOptionIndex}')">
                                <input type="hidden" name="child_cost_currency_${packageOptionIndex}" value="USD">
                            </div>

                            <!-- ìœ ì•„ -->
                            <div class="col-md-2">
                                <label class="form-label small"><span class="badge bg-warning text-dark me-1">ìœ ì•„</span> íŒë§¤ê°€</label>
                                <input type="number" class="form-control form-control-sm" name="infant_price_${packageOptionIndex}" step="0.01" placeholder="5000 (â‚©) or 40 ($)" oninput="autoSetCurrency(this, 'infant_currency_${packageOptionIndex}')">
                                <input type="hidden" name="infant_currency_${packageOptionIndex}" value="USD">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">ì›ê°€</label>
                                <input type="number" class="form-control form-control-sm" name="infant_cost_${packageOptionIndex}" step="0.01" placeholder="3000 (â‚©) or 20 ($)" oninput="autoSetCurrency(this, 'infant_cost_currency_${packageOptionIndex}')">
                                <input type="hidden" name="infant_cost_currency_${packageOptionIndex}" value="USD">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', newOption);
            packageOptionIndex++;
        }

        // íŒ¨í‚¤ì§€ ì˜µì…˜ ì‚­ì œ
        function removePackageOption(index) {
            const option = document.querySelector(`[data-index="${index}"]`);
            if (option) {
                option.remove();
            }
        }

        // ëª¨ë“  ì˜µì…˜ì˜ ë§ˆì§„ ì¬ê³„ì‚° (ìˆ˜ìˆ˜ë£Œìœ¨ ë³€ê²½ ì‹œ)
        function recalculateAllMargins() {
            const options = document.querySelectorAll('.package-option');
            options.forEach(option => {
                const index = option.getAttribute('data-index');
                calculateAllMargins(index);
            });
        }

        // íŠ¹ì • ì˜µì…˜ì˜ ëª¨ë“  ì¸ì›ë³„ ë§ˆì§„ ê³„ì‚°
        function calculateAllMargins(index) {
            const commissionRate = parseFloat(document.getElementById('commissionRate')?.value) || 0;
            
            // ì„±ì¸ ë§ˆì§„ ê³„ì‚°
            const adultPrice = parseFloat(document.querySelector(`[name="adult_price_${index}"]`)?.value) || 0;
            const adultCurrency = document.querySelector(`[name="adult_currency_${index}"]`)?.value || 'USD';
            const adultCost = parseFloat(document.querySelector(`[name="adult_cost_${index}"]`)?.value) || 0;
            const adultCostCurrency = document.querySelector(`[name="adult_cost_currency_${index}"]`)?.value || 'USD';
            
            if (adultPrice > 0) {
                const adultPriceUSD = adultCurrency === 'KRW' ? adultPrice / USD_TO_KRW : adultPrice;
                const adultCostUSD = adultCostCurrency === 'KRW' ? adultCost / USD_TO_KRW : adultCost;
                const adultCommission = adultPriceUSD * (commissionRate / 100);
                const adultMargin = adultPriceUSD - adultCommission - adultCostUSD;
                const adultMarginRate = (adultMargin / adultPriceUSD) * 100;
                
                const adultMarginInput = document.querySelector(`[name="adult_margin_${index}"]`);
                if (adultMarginInput) {
                    adultMarginInput.value = `$${adultMargin.toFixed(2)} (${adultMarginRate.toFixed(1)}%)`;
                    adultMarginInput.style.color = adultMargin > 0 ? '#28a745' : (adultMargin < 0 ? '#dc3545' : '#6c757d');
                }
            }
            
            // ì†Œì•„ ë§ˆì§„ ê³„ì‚°
            const childPrice = parseFloat(document.querySelector(`[name="child_price_${index}"]`)?.value) || 0;
            const childCurrency = document.querySelector(`[name="child_currency_${index}"]`)?.value || 'USD';
            const childCost = parseFloat(document.querySelector(`[name="child_cost_${index}"]`)?.value) || 0;
            const childCostCurrency = document.querySelector(`[name="child_cost_currency_${index}"]`)?.value || 'USD';
            
            if (childPrice > 0) {
                const childPriceUSD = childCurrency === 'KRW' ? childPrice / USD_TO_KRW : childPrice;
                const childCostUSD = childCostCurrency === 'KRW' ? childCost / USD_TO_KRW : childCost;
                const childCommission = childPriceUSD * (commissionRate / 100);
                const childMargin = childPriceUSD - childCommission - childCostUSD;
                const childMarginRate = (childMargin / childPriceUSD) * 100;
                
                const childMarginInput = document.querySelector(`[name="child_margin_${index}"]`);
                if (childMarginInput) {
                    childMarginInput.value = `$${childMargin.toFixed(2)} (${childMarginRate.toFixed(1)}%)`;
                    childMarginInput.style.color = childMargin > 0 ? '#28a745' : (childMargin < 0 ? '#dc3545' : '#6c757d');
                }
            }
            
            // ìœ ì•„ ë§ˆì§„ ê³„ì‚°
            const infantPrice = parseFloat(document.querySelector(`[name="infant_price_${index}"]`)?.value) || 0;
            const infantCurrency = document.querySelector(`[name="infant_currency_${index}"]`)?.value || 'USD';
            const infantCost = parseFloat(document.querySelector(`[name="infant_cost_${index}"]`)?.value) || 0;
            const infantCostCurrency = document.querySelector(`[name="infant_cost_currency_${index}"]`)?.value || 'USD';
            
            if (infantPrice > 0) {
                const infantPriceUSD = infantCurrency === 'KRW' ? infantPrice / USD_TO_KRW : infantPrice;
                const infantCostUSD = infantCostCurrency === 'KRW' ? infantCost / USD_TO_KRW : infantCost;
                const infantCommission = infantPriceUSD * (commissionRate / 100);
                const infantMargin = infantPriceUSD - infantCommission - infantCostUSD;
                const infantMarginRate = (infantMargin / infantPriceUSD) * 100;
                
                const infantMarginInput = document.querySelector(`[name="infant_margin_${index}"]`);
                if (infantMarginInput) {
                    infantMarginInput.value = `$${infantMargin.toFixed(2)} (${infantMarginRate.toFixed(1)}%)`;
                    infantMarginInput.style.color = infantMargin > 0 ? '#28a745' : (infantMargin < 0 ? '#dc3545' : '#6c757d');
                }
            }
        }

        // í¼ ì´ˆê¸°í™”
        function resetPricingForm() {
            document.getElementById('pricingForm').reset();
            document.getElementById('pricingId').value = '';
            document.getElementById('saveBtnText').textContent = 'ë“±ë¡';
            
            // íŒ¨í‚¤ì§€ ì˜µì…˜ ì´ˆê¸°í™” (ì²« ë²ˆì§¸ë§Œ ë‚¨ê¸°ê³  ì‚­ì œ)
            const container = document.getElementById('packageOptionsContainer');
            const options = container.querySelectorAll('.package-option');
            options.forEach((option, idx) => {
                if (idx > 0) option.remove();
            });
            packageOptionIndex = 1;
        }

        // ìš”ê¸ˆ ë“±ë¡/ìˆ˜ì •
        document.getElementById('pricingForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const pricingId = document.getElementById('pricingId').value;
            const platformName = document.getElementById('platformName').value;
            const productName = document.getElementById('productName').value;
            const commissionRate = parseFloat(document.getElementById('commissionRate').value);
            const vendorId = document.getElementById('vendorId').value || null;
            const notes = document.getElementById('pricingNotes').value;

            // íŒ¨í‚¤ì§€ ì˜µì…˜ ìˆ˜ì§‘ (ìƒˆë¡œìš´ êµ¬ì¡°: ì˜µì…˜ëª… + ì„±ì¸/ì†Œì•„/ìœ ì•„ ê°€ê²©)
            const packageOptions = [];
            const options = document.querySelectorAll('.package-option');
            
            options.forEach(option => {
                const index = option.getAttribute('data-index');
                const optionName = document.querySelector(`[name="option_name_${index}"]`).value;
                
                // ì„±ì¸ ê°€ê²©
                const adultPrice = parseFloat(document.querySelector(`[name="adult_price_${index}"]`)?.value) || null;
                const adultCurrency = document.querySelector(`[name="adult_currency_${index}"]`)?.value || 'USD';
                const adultCost = parseFloat(document.querySelector(`[name="adult_cost_${index}"]`)?.value) || null;
                const adultCostCurrency = document.querySelector(`[name="adult_cost_currency_${index}"]`)?.value || 'USD';
                
                // ì†Œì•„ ê°€ê²©
                const childPrice = parseFloat(document.querySelector(`[name="child_price_${index}"]`)?.value) || null;
                const childCurrency = document.querySelector(`[name="child_currency_${index}"]`)?.value || 'USD';
                const childCost = parseFloat(document.querySelector(`[name="child_cost_${index}"]`)?.value) || null;
                const childCostCurrency = document.querySelector(`[name="child_cost_currency_${index}"]`)?.value || 'USD';
                
                // ìœ ì•„ ê°€ê²©
                const infantPrice = parseFloat(document.querySelector(`[name="infant_price_${index}"]`)?.value) || null;
                const infantCurrency = document.querySelector(`[name="infant_currency_${index}"]`)?.value || 'USD';
                const infantCost = parseFloat(document.querySelector(`[name="infant_cost_${index}"]`)?.value) || null;
                const infantCostCurrency = document.querySelector(`[name="infant_cost_currency_${index}"]`)?.value || 'USD';

                packageOptions.push({
                    option_name: optionName,
                    adult_price: adultPrice,
                    adult_currency: adultCurrency,
                    adult_cost: adultCost,
                    adult_cost_currency: adultCostCurrency,
                    child_price: childPrice,
                    child_currency: childCurrency,
                    child_cost: childCost,
                    child_cost_currency: childCostCurrency,
                    infant_price: infantPrice,
                    infant_currency: infantCurrency,
                    infant_cost: infantCost,
                    infant_cost_currency: infantCostCurrency
                });
            });

            try {
                const url = pricingId ? `/api/pricing/${pricingId}` : '/api/pricing';
                const method = pricingId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        platform_name: platformName,
                        vendor_id: vendorId,
                        product_name: productName,
                        commission_rate: commissionRate,
                        package_options: packageOptions,
                        notes: notes,
                        change_reason: pricingId ? 'ìš”ê¸ˆ ìˆ˜ì •' : 'ì‹ ê·œ ë“±ë¡'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    resetPricingForm();
                    loadPricingList();
                } else {
                    alert('ì˜¤ë¥˜: ' + data.message);
                }
            } catch (error) {
                console.error('ìš”ê¸ˆ ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ìš”ê¸ˆ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // ìš”ê¸ˆ ëª©ë¡ ë¡œë“œ
        async function loadPricingList(page = 1) {
            try {
                currentPage = page;
                const searchQuery = document.getElementById('pricingSearchInput').value;
                
                let url = `/api/pricing?page=${page}&limit=20`;
                if (searchQuery) {
                    url += `&product=${encodeURIComponent(searchQuery)}`;
                }

                console.log('ğŸ“‹ ìš”ê¸ˆ ëª©ë¡ ë¡œë“œ ìš”ì²­:', url);
                const response = await fetch(url);
                console.log('ğŸ“‹ ì‘ë‹µ ìƒíƒœ:', response.status);
                
                const data = await response.json();
                console.log('ğŸ“‹ ì‘ë‹µ ë°ì´í„°:', data);

                if (data.success) {
                    renderPricingList(data.data);
                    renderPagination(data.pagination);
                } else {
                    console.error('âŒ API ì˜¤ë¥˜:', data.message);
                    document.getElementById('pricingList').innerHTML = `
                        <tr><td colspan="7" class="text-center text-danger">
                            ë¡œë“œ ì‹¤íŒ¨: ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}
                        </td></tr>
                    `;
                }
            } catch (error) {
                console.error('âŒ ìš”ê¸ˆ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('pricingList').innerHTML = `
                    <tr><td colspan="7" class="text-center text-danger">
                        ë¡œë“œ ì‹¤íŒ¨: ${error.message}
                    </td></tr>
                `;
            }
        }

        // ìš”ê¸ˆ ëª©ë¡ ë Œë”ë§
        function renderPricingList(pricings) {
            const tbody = document.getElementById('pricingList');
            
            if (pricings.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="7" class="text-center text-muted">ë“±ë¡ëœ ìš”ê¸ˆì´ ì—†ìŠµë‹ˆë‹¤</td></tr>
                `;
                return;
            }

            tbody.innerHTML = pricings.map(pricing => {
                // PostgreSQL JSONBëŠ” ì´ë¯¸ ê°ì²´ë¡œ ë³€í™˜ë¨
                const options = pricing.package_options || [];
                
                // ì˜µì…˜ ì •ë³´ í‘œì‹œ (ìƒˆë¡œìš´ êµ¬ì¡°)
                const optionsText = options.map(opt => {
                    const prices = [];
                    if (opt.adult_price) {
                        const currency = opt.adult_currency === 'KRW' ? 'â‚©' : '$';
                        prices.push(`ì„±ì¸: ${currency}${opt.adult_price}`);
                    }
                    if (opt.child_price) {
                        const currency = opt.child_currency === 'KRW' ? 'â‚©' : '$';
                        prices.push(`ì†Œì•„: ${currency}${opt.child_price}`);
                    }
                    if (opt.infant_price) {
                        const currency = opt.infant_currency === 'KRW' ? 'â‚©' : '$';
                        prices.push(`ìœ ì•„: ${currency}${opt.infant_price}`);
                    }
                    return `<div class="mb-1"><strong>${opt.option_name}</strong><br>${prices.join(', ')}</div>`;
                }).join('');

                const date = new Date(pricing.created_at).toLocaleDateString('ko-KR');
                const commissionRate = pricing.commission_rate || 15;

                return `
                    <tr>
                        <td><span class="badge bg-primary">${pricing.platform_name}</span></td>
                        <td>
                            <strong>${pricing.product_name}</strong><br>
                            <small class="text-muted">ìˆ˜ìˆ˜ë£Œ: ${commissionRate}%</small>
                        </td>
                        <td>${pricing.vendor_name || '<span class="text-muted">-</span>'}</td>
                        <td><small>${optionsText}</small></td>
                        <td><span class="badge bg-info">v${pricing.version}</span></td>
                        <td><small>${date}</small></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editPricing(${pricing.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePricing(${pricing.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // í˜ì´ì§• ë Œë”ë§
        function renderPagination(pagination) {
            const paginationEl = document.getElementById('pagination');
            if (!pagination || pagination.totalPages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }

            let html = '';
            for (let i = 1; i <= pagination.totalPages; i++) {
                html += `
                    <li class="page-item ${i === pagination.page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadPricingList(${i}); return false;">${i}</a>
                    </li>
                `;
            }
            paginationEl.innerHTML = html;
        }

        // ê²€ìƒ‰
        function searchPricing() {
            loadPricingList(1);
        }

        // ìš”ê¸ˆ ìˆ˜ì •
        async function editPricing(id) {
            try {
                const response = await fetch(`/api/pricing/${id}`);
                const result = await response.json();

                if (result.success) {
                    const pricing = result.data;
                    
                    document.getElementById('pricingId').value = pricing.id;
                    document.getElementById('platformName').value = pricing.platform_name;
                    document.getElementById('productName').value = pricing.product_name;
                    document.getElementById('commissionRate').value = pricing.commission_rate || 15;
                    document.getElementById('vendorId').value = pricing.vendor_id || '';
                    document.getElementById('pricingNotes').value = pricing.notes || '';
                    document.getElementById('saveBtnText').textContent = 'ìˆ˜ì •';

                    // íŒ¨í‚¤ì§€ ì˜µì…˜ ë¡œë“œ (ìƒˆë¡œìš´ êµ¬ì¡°)
                    // PostgreSQL JSONBëŠ” ì´ë¯¸ ê°ì²´ë¡œ ë³€í™˜ë¨
                    const options = pricing.package_options || [];
                    const container = document.getElementById('packageOptionsContainer');
                    container.innerHTML = '';
                    packageOptionIndex = 0;

                    options.forEach((opt, idx) => {
                        const optionHTML = `
                            <div class="package-option card mb-3" data-index="${idx}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0 text-primary"><i class="fas fa-box me-1"></i>íŒ¨í‚¤ì§€ ì˜µì…˜ #${idx + 1}</h6>
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePackageOption(${idx})" ${idx === 0 ? 'disabled' : ''}>
                                            <i class="fas fa-trash"></i> ì‚­ì œ
                                        </button>
                                    </div>
                                    
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-12">
                                            <label class="form-label fw-bold">ì˜µì…˜ëª…</label>
                                            <input type="text" class="form-control" name="option_name_${idx}" value="${opt.option_name}" required>
                                        </div>
                                    </div>

                                    <hr class="my-3">

                                    <h6 class="text-secondary mb-3"><i class="fas fa-users me-1"></i>ì¸ì›ë³„ ìš”ê¸ˆ</h6>
                                    
                                    <!-- ì„±ì¸ -->
                                    <div class="row g-2 mb-2 align-items-end">
                                        <div class="col-md-1"><span class="badge bg-primary">ì„±ì¸</span></div>
                                        <div class="col-md-2">
                                            <label class="form-label small">íŒë§¤ê°€</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" name="adult_price_${idx}" value="${opt.adult_price || ''}" step="0.01" onchange="calculateAllMargins(${idx})">
                                                <select class="form-select" name="adult_currency_${idx}" style="max-width: 70px;" onchange="calculateAllMargins(${idx})">
                                                    <option value="KRW" ${opt.adult_currency === 'KRW' ? 'selected' : ''}>â‚©</option>
                                                    <option value="USD" ${opt.adult_currency !== 'KRW' ? 'selected' : ''}>$</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small">ì›ê°€</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" name="adult_cost_${idx}" value="${opt.adult_cost || ''}" step="0.01" onchange="calculateAllMargins(${idx})">
                                                <select class="form-select" name="adult_cost_currency_${idx}" style="max-width: 70px;" onchange="calculateAllMargins(${idx})">
                                                    <option value="KRW" ${opt.adult_cost_currency === 'KRW' ? 'selected' : ''}>â‚©</option>
                                                    <option value="USD" ${opt.adult_cost_currency !== 'KRW' ? 'selected' : ''}>$</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small">ë§ˆì§„</label>
                                            <input type="text" class="form-control form-control-sm fw-bold" name="adult_margin_${idx}" readonly>
                                        </div>

                                        <!-- ì†Œì•„ -->
                                        <div class="col-md-1"><span class="badge bg-info">ì†Œì•„</span></div>
                                        <div class="col-md-2">
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" name="child_price_${idx}" value="${opt.child_price || ''}" step="0.01" onchange="calculateAllMargins(${idx})">
                                                <select class="form-select" name="child_currency_${idx}" style="max-width: 70px;" onchange="calculateAllMargins(${idx})">
                                                    <option value="KRW" ${opt.child_currency === 'KRW' ? 'selected' : ''}>â‚©</option>
                                                    <option value="USD" ${opt.child_currency !== 'KRW' ? 'selected' : ''}>$</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" name="child_cost_${idx}" value="${opt.child_cost || ''}" step="0.01" onchange="calculateAllMargins(${idx})">
                                                <select class="form-select" name="child_cost_currency_${idx}" style="max-width: 70px;" onchange="calculateAllMargins(${idx})">
                                                    <option value="KRW" ${opt.child_cost_currency === 'KRW' ? 'selected' : ''}>â‚©</option>
                                                    <option value="USD" ${opt.child_cost_currency !== 'KRW' ? 'selected' : ''}>$</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ìœ ì•„ -->
                                    <div class="row g-2 align-items-center">
                                        <div class="col-md-1"><span class="badge bg-warning text-dark">ìœ ì•„</span></div>
                                        <div class="col-md-2">
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" name="infant_price_${idx}" value="${opt.infant_price || ''}" step="0.01" onchange="calculateAllMargins(${idx})">
                                                <select class="form-select" name="infant_currency_${idx}" style="max-width: 70px;" onchange="calculateAllMargins(${idx})">
                                                    <option value="KRW" ${opt.infant_currency === 'KRW' ? 'selected' : ''}>â‚©</option>
                                                    <option value="USD" ${opt.infant_currency !== 'KRW' ? 'selected' : ''}>$</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" name="infant_cost_${idx}" value="${opt.infant_cost || ''}" step="0.01" onchange="calculateAllMargins(${idx})">
                                                <select class="form-select" name="infant_cost_currency_${idx}" style="max-width: 70px;" onchange="calculateAllMargins(${idx})">
                                                    <option value="KRW" ${opt.infant_cost_currency === 'KRW' ? 'selected' : ''}>â‚©</option>
                                                    <option value="USD" ${opt.infant_cost_currency !== 'KRW' ? 'selected' : ''}>$</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <input type="text" class="form-control form-control-sm fw-bold" name="child_margin_${idx}" readonly>
                                        </div>
                                        <div class="col-md-1"></div>
                                        <div class="col-md-4">
                                            <input type="text" class="form-control form-control-sm fw-bold" name="infant_margin_${idx}" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        container.insertAdjacentHTML('beforeend', optionHTML);
                        calculateAllMargins(idx);
                        packageOptionIndex++;
                    });

                    // í¼ìœ¼ë¡œ ìŠ¤í¬ë¡¤
                    document.getElementById('pricingForm').scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error('ìš”ê¸ˆ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ìš”ê¸ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ìš”ê¸ˆ ì‚­ì œ
        async function deletePricing(id) {
            if (!confirm('ì •ë§ ì´ ìš”ê¸ˆ ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch(`/api/pricing/${id}`, { method: 'DELETE' });
                const data = await response.json();

                if (data.success) {
                    alert('ìš”ê¸ˆ ì •ë³´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadPricingList(currentPage);
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.message);
                }
            } catch (error) {
                console.error('ìš”ê¸ˆ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
    </script>
</body>
</html>
