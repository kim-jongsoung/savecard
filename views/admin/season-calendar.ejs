<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì‹œì¦Œ ë‹¬ë ¥ ê´€ë¦¬ - ëŸ­ìŠ¤íŒŒì¸ë“œ ERP</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .season-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 20px; }
    .season-table th, .season-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    .season-table th { background: #f8f9fa; font-weight: bold; position: sticky; top: 0; z-index: 10; }
    .season-table td { cursor: pointer; transition: all 0.2s; min-width: 30px; height: 35px; }
    .season-table td:hover { transform: scale(1.05); }
    .season-table td.selected { border: 2px solid #000; }
    .month-section { margin-bottom: 30px; }
    .month-title { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px; border-radius: 5px; font-weight: bold; margin-bottom: 10px; }
    
    /* ì‹œì¦Œ ìƒ‰ìƒ */
    .season-LOW { background-color: #90EE90; color: #155724; }
    .season-SHOULDER { background-color: #87CEEB; color: #004085; }
    .season-HIGH { background-color: #FFD700; color: #856404; }
    .season-PEAK { background-color: #FF6347; color: #721c24; }
    .season-UNASSIGNED { background-color: #D3D3D3; color: #666; }
    
    .legend { display: flex; gap: 15px; flex-wrap: wrap; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }
    .legend-item { display: flex; align-items: center; gap: 5px; font-size: 12px; }
    .legend-color { width: 30px; height: 20px; border-radius: 3px; border: 1px solid #ddd; }
  </style>
</head>
<body>
  <%- include('../partials/navbar') %>
  <div class="container-fluid mt-3">
    <div class="mb-3">
      <div class="d-flex align-items-center mb-2">
        <h4 class="mb-0 me-3">ğŸ—“ï¸ ì‹œì¦Œ ë‹¬ë ¥ ê´€ë¦¬</h4>
        <label class="me-2">í˜¸í…”:</label>
        <select class="form-select form-select-sm d-inline-block w-auto me-3" id="hotelSelect" onchange="loadData()">
          <option value="">í˜¸í…” ì„ íƒ</option>
        </select>
        <label class="me-2">ì‹œì‘ ì›”:</label>
        <input type="month" class="form-control form-control-sm d-inline-block w-auto me-3" id="startMonth" value="2025-11" onchange="loadData()">
        <span class="text-muted small">by <%= adminUsername %> | <span id="todayDate"></span></span>
      </div>
      
      <!-- ì‹œì¦Œ ë²”ë¡€ ë° ì»¨íŠ¸ë¡¤ -->
      <div class="legend">
        <div class="legend-item">
          <div class="legend-color season-LOW"></div>
          <span>ë¹„ìˆ˜ê¸° (LOW)</span>
        </div>
        <div class="legend-item">
          <div class="legend-color season-SHOULDER"></div>
          <span>í‰ìˆ˜ê¸° (SHOULDER)</span>
        </div>
        <div class="legend-item">
          <div class="legend-color season-HIGH"></div>
          <span>ì„±ìˆ˜ê¸° (HIGH)</span>
        </div>
        <div class="legend-item">
          <div class="legend-color season-PEAK"></div>
          <span>ê·¹ì„±ìˆ˜ê¸° (PEAK)</span>
        </div>
        <div class="legend-item">
          <div class="legend-color season-UNASSIGNED"></div>
          <span>ì‹œì¦Œë¯¸ì •</span>
        </div>
      </div>
      
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-primary btn-sm" onclick="selectAllCells()">ì „ì²´ì„ íƒ</button>
        <button class="btn btn-secondary btn-sm" onclick="clearSelection()">ì„ íƒí•´ì œ</button>
        <span class="text-muted">|</span>
        <button class="btn btn-success btn-sm" onclick="setSeasonBulk('LOW')">ë¹„ìˆ˜ê¸°</button>
        <button class="btn btn-info btn-sm" onclick="setSeasonBulk('SHOULDER')">í‰ìˆ˜ê¸°</button>
        <button class="btn btn-warning btn-sm" onclick="setSeasonBulk('HIGH')">ì„±ìˆ˜ê¸°</button>
        <button class="btn btn-danger btn-sm" onclick="setSeasonBulk('PEAK')">ê·¹ì„±ìˆ˜ê¸°</button>
        <button class="btn btn-secondary btn-sm" onclick="setSeasonBulk('UNASSIGNED')">ë¯¸ì •</button>
        <span class="text-muted">|</span>
        <button class="btn btn-dark btn-sm" onclick="saveChanges()">ğŸ’¾ ì €ì¥</button>
      </div>
    </div>
    
    <div id="calendarContainer"></div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.getElementById('todayDate').textContent = new Date().toLocaleDateString('ko-KR');
    
    let hotels = [];
    let seasonTypes = [];
    let seasonCalendar = {}; // key: 'YYYY-MM-DD', value: season_code
    let selected = new Set();
    let changes = {};
    
    async function loadHotels() {
      const res = await fetch('/api/hotels?is_active=true');
      hotels = await res.json();
      const select = document.getElementById('hotelSelect');
      hotels.forEach(h => {
        const opt = document.createElement('option');
        opt.value = h.id;
        opt.textContent = h.hotel_name;
        select.appendChild(opt);
      });
      
      // ì‹œì¦Œ íƒ€ì… ë¡œë“œ
      const stRes = await fetch('/api/season-types');
      seasonTypes = await stRes.json();
    }
    
    async function loadData() {
      const hid = document.getElementById('hotelSelect').value;
      if (!hid) return;
      
      const start = document.getElementById('startMonth').value.split('-');
      const year = parseInt(start[0]), month = parseInt(start[1]);
      seasonCalendar = {};
      
      for (let m = 0; m < 6; m++) {
        const y = month + m > 12 ? year + 1 : year;
        const mo = month + m > 12 ? month + m - 12 : month + m;
        const res = await fetch(`/api/season-calendar?hotel_id=${hid}&year=${y}&month=${mo}`);
        const data = await res.json();
        
        data.forEach(item => {
          const dateOnly = item.calendar_date.split('T')[0];
          seasonCalendar[dateOnly] = item.season_code;
        });
      }
      
      renderCalendar(year, month);
    }
    
    function renderCalendar(year, month) {
      const container = document.getElementById('calendarContainer');
      let html = '';
      
      for (let m = 0; m < 6; m++) {
        const y = month + m > 12 ? year + 1 : year;
        const mo = month + m > 12 ? month + m - 12 : month + m;
        const monthName = new Date(y, mo - 1).toLocaleString('ko', { year: 'numeric', month: 'long' });
        const days = new Date(y, mo, 0).getDate();
        
        html += `<div class="month-section">
          <div class="month-title">${monthName}</div>
          <table class="season-table">
            <thead>
              <tr>
                <th>ì¼</th>`;
        
        for (let d = 1; d <= days; d++) html += `<th>${d}</th>`;
        html += `</tr></thead><tbody><tr><td>ì‹œì¦Œ</td>`;
        
        for (let d = 1; d <= days; d++) {
          const dateStr = `${y}-${String(mo).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
          const season = changes[dateStr] || seasonCalendar[dateStr] || 'UNASSIGNED';
          const isSelected = selected.has(dateStr);
          
          html += `<td class="season-${season} ${isSelected ? 'selected' : ''}" 
                      onclick="toggleCell('${dateStr}')" 
                      title="${dateStr}">${getSeasonDisplay(season)}</td>`;
        }
        
        html += `</tr></tbody></table></div>`;
      }
      
      container.innerHTML = html;
    }
    
    function getSeasonDisplay(code) {
      const map = {
        'LOW': 'L',
        'SHOULDER': 'S',
        'HIGH': 'H',
        'PEAK': 'P',
        'UNASSIGNED': '-'
      };
      return map[code] || '-';
    }
    
    function toggleCell(dateStr) {
      if (selected.has(dateStr)) {
        selected.delete(dateStr);
      } else {
        selected.add(dateStr);
      }
      const [year, month] = document.getElementById('startMonth').value.split('-').map(Number);
      renderCalendar(year, month);
    }
    
    function selectAllCells() {
      const [year, month] = document.getElementById('startMonth').value.split('-').map(Number);
      for (let m = 0; m < 6; m++) {
        const y = month + m > 12 ? year + 1 : year;
        const mo = month + m > 12 ? month + m - 12 : month + m;
        const days = new Date(y, mo, 0).getDate();
        for (let d = 1; d <= days; d++) {
          const dateStr = `${y}-${String(mo).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
          selected.add(dateStr);
        }
      }
      renderCalendar(year, month);
    }
    
    function clearSelection() {
      selected.clear();
      const [year, month] = document.getElementById('startMonth').value.split('-').map(Number);
      renderCalendar(year, month);
    }
    
    function setSeasonBulk(seasonCode) {
      if (selected.size === 0) {
        alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      selected.forEach(dateStr => {
        changes[dateStr] = seasonCode;
      });
      
      selected.clear();
      const [year, month] = document.getElementById('startMonth').value.split('-').map(Number);
      renderCalendar(year, month);
    }
    
    async function saveChanges() {
      if (Object.keys(changes).length === 0) {
        alert('ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      const hid = document.getElementById('hotelSelect').value;
      
      // ì‹œì¦Œ ì½”ë“œë¥¼ IDë¡œ ë³€í™˜
      const seasonCodeToId = {};
      seasonTypes.forEach(st => {
        seasonCodeToId[st.season_code] = st.id;
      });
      
      const updates = [];
      for (const [date, seasonCode] of Object.entries(changes)) {
        updates.push({
          date,
          season_type_id: seasonCodeToId[seasonCode]
        });
      }
      
      try {
        const res = await fetch('/api/season-calendar/bulk', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ hotel_id: hid, updates })
        });
        
        const data = await res.json();
        
        if (data.success) {
          alert(`ì €ì¥ ì™„ë£Œ: ${data.updated}ê°œ ì—…ë°ì´íŠ¸`);
          changes = {};
          await loadData();
        } else {
          alert('ì €ì¥ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (error) {
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }
    
    loadHotels();
  </script>
</body>
</html>
