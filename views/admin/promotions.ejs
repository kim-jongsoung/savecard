<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>프로모션 관리</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { font-size: 0.7rem; }
    h2 { font-size: 1.4rem; }
    .btn { font-size: 0.7rem; padding: 0.3rem 0.7rem; }
    .form-label { font-size: 0.7rem; }
    .form-control, .form-select { font-size: 0.7rem; padding: 0.3rem 0.5rem; }
    .badge { font-size: 0.65rem; }
    .filter-card { background: #f8f9fa; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; }
    .promo-card { border: 1px solid #dee2e6; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; background: white; }
    .promo-code { font-size: 1.1rem; font-weight: 600; color: #667eea; }
  </style>
</head>
<body>
  <%- include('../partials/navbar') %>
  <div class="container-fluid mt-4">
    <h2><i class="bi bi-tag"></i> 프로모션 관리 <button class="btn btn-primary btn-sm ms-3" onclick="openAddModal()"><i class="bi bi-plus-circle"></i> 등록</button></h2>
    <div class="filter-card mt-3">
      <div class="row g-2">
        <div class="col-md-4">
          <label class="form-label">호텔</label>
          <select class="form-select" id="filterHotel" onchange="loadPromotions()">
            <option value="">전체</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">코드 검색</label>
          <input type="text" class="form-control" id="filterPromoCode">
        </div>
        <div class="col-md-2">
          <label class="form-label">상태</label>
          <select class="form-select" id="filterActive" onchange="loadPromotions()">
            <option value="">전체</option>
            <option value="true" selected>활성</option>
            <option value="false">비활성</option>
          </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button class="btn btn-primary w-100" onclick="loadPromotions()"><i class="bi bi-search"></i> 검색</button>
        </div>
      </div>
    </div>
    <div id="promoList"></div>
  </div>
  
  <div class="modal fade" id="promoModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">프로모션 등록</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="promoId">
          <div class="row">
            <div class="col-md-6 mb-2">
              <label class="form-label">호텔 *</label>
              <select class="form-select" id="hotelId" onchange="loadRoomTypesForPromo()" required>
                <option value="">선택</option>
              </select>
            </div>
            <div class="col-md-3 mb-2">
              <label class="form-label">프로모션 코드 *</label>
              <input type="text" class="form-control" id="promoCode" required>
            </div>
            <div class="col-md-3 mb-2">
              <label class="form-label">최소박</label>
              <input type="number" class="form-control" id="minNights" value="1">
            </div>
          </div>
          <div class="mb-2">
            <label class="form-label">프로모션명 *</label>
            <input type="text" class="form-control" id="promoName" required>
          </div>
          <div class="row">
            <div class="col-md-3 mb-2">
              <label class="form-label">예약 시작 *</label>
              <input type="date" class="form-control" id="bookingStartDate" required>
            </div>
            <div class="col-md-3 mb-2">
              <label class="form-label">예약 종료 *</label>
              <input type="date" class="form-control" id="bookingEndDate" required>
            </div>
            <div class="col-md-3 mb-2">
              <label class="form-label">투숙 시작 *</label>
              <input type="date" class="form-control" id="stayStartDate" required>
            </div>
            <div class="col-md-3 mb-2">
              <label class="form-label">투숙 종료 *</label>
              <input type="date" class="form-control" id="stayEndDate" required>
            </div>
          </div>
          <div class="mb-2">
            <label class="form-label">설명</label>
            <textarea class="form-control" id="description" rows="2"></textarea>
          </div>
          
          <hr>
          <h6><i class="bi bi-percent"></i> 객실별 할인</h6>
          <div id="discountsList"></div>
          
          <hr>
          <h6><i class="bi bi-gift"></i> 베네핏 <button type="button" class="btn btn-sm btn-outline-primary" onclick="addBenefit()"><i class="bi bi-plus"></i></button></h6>
          <div id="benefitsList"></div>
          
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="isActive" checked>
            <label class="form-check-label">활성화</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="button" class="btn btn-primary" onclick="savePromo()">저장</button>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentPromos = [];
    let hotels = [];
    let currentRoomTypes = [];
    let benefitCounter = 0;
    
    document.addEventListener('DOMContentLoaded', () => { loadHotels(); });
    
    async function loadHotels() {
      const res = await fetch('/api/hotels?is_active=true');
      hotels = await res.json();
      document.getElementById('filterHotel').innerHTML = '<option value="">전체</option>' + hotels.map(h => '<option value="' + h.id + '">' + h.hotel_name + '</option>').join('');
      document.getElementById('hotelId').innerHTML = '<option value="">선택</option>' + hotels.map(h => '<option value="' + h.id + '">' + h.hotel_name + '</option>').join('');
      loadPromotions();
    }
    
    async function loadPromotions() {
      let url = '/api/promotions?';
      const hotelId = document.getElementById('filterHotel').value;
      const promoCode = document.getElementById('filterPromoCode').value;
      const isActive = document.getElementById('filterActive').value;
      
      if (hotelId) url += 'hotel_id=' + hotelId + '&';
      if (promoCode) url += 'promo_code=' + promoCode + '&';
      if (isActive) url += 'is_active=' + isActive;
      
      const res = await fetch(url);
      currentPromos = await res.json();
      renderPromos();
    }
    
    function renderPromos() {
      const container = document.getElementById('promoList');
      if (currentPromos.length === 0) {
        container.innerHTML = '<div class="text-center py-4 text-muted">등록된 프로모션이 없습니다</div>';
        return;
      }
      
      let html = '';
      currentPromos.forEach(p => {
        html += '<div class="promo-card"><div class="d-flex justify-content-between"><div>';
        html += '<div class="promo-code">' + p.promo_code + '</div>';
        html += '<div><strong>' + p.promo_name + '</strong> <span class="text-muted ms-2">' + p.hotel_name + '</span></div>';
        html += '<div class="mt-1">';
        html += '<span class="badge bg-primary">예약: ' + p.booking_start_date + ' ~ ' + p.booking_end_date + '</span> ';
        html += '<span class="badge bg-success">투숙: ' + p.stay_start_date + ' ~ ' + p.stay_end_date + '</span> ';
        html += '<span class="badge bg-info">할인 ' + p.discount_count + '개</span> ';
        html += '<span class="badge bg-warning">베네핏 ' + p.benefit_count + '개</span> ';
        html += p.is_active ? '<span class="badge bg-success">활성</span>' : '<span class="badge bg-secondary">비활성</span>';
        html += '</div></div><div>';
        html += '<button class="btn btn-sm btn-outline-primary" onclick="editPromo(' + p.id + ')"><i class="bi bi-pencil"></i></button> ';
        html += '<button class="btn btn-sm btn-outline-danger" onclick="deletePromo(' + p.id + ')"><i class="bi bi-trash"></i></button>';
        html += '</div></div></div>';
      });
      
      container.innerHTML = html;
    }
    
    function openAddModal() {
      document.getElementById('modalTitle').textContent = '프로모션 등록';
      document.getElementById('promoId').value = '';
      document.getElementById('hotelId').value = '';
      document.getElementById('promoCode').value = '';
      document.getElementById('promoName').value = '';
      document.getElementById('bookingStartDate').value = '';
      document.getElementById('bookingEndDate').value = '';
      document.getElementById('stayStartDate').value = '';
      document.getElementById('stayEndDate').value = '';
      document.getElementById('minNights').value = 1;
      document.getElementById('description').value = '';
      document.getElementById('isActive').checked = true;
      document.getElementById('discountsList').innerHTML = '<p class="text-muted">먼저 호텔을 선택하세요</p>';
      document.getElementById('benefitsList').innerHTML = '';
      benefitCounter = 0;
      new bootstrap.Modal(document.getElementById('promoModal')).show();
    }
    
    async function loadRoomTypesForPromo() {
      const hotelId = document.getElementById('hotelId').value;
      if (!hotelId) return;
      
      const res = await fetch('/api/room-types?hotel_id=' + hotelId + '&is_active=true');
      currentRoomTypes = await res.json();
      
      let html = '';
      currentRoomTypes.forEach(rt => {
        html += '<div class="row mb-2">';
        html += '<div class="col-md-6"><input type="text" class="form-control" value="' + rt.room_type_name + '" readonly>';
        html += '<input type="hidden" class="discount-room-id" value="' + rt.id + '"></div>';
        html += '<div class="col-md-3"><input type="number" class="form-control discount-value" placeholder="할인금액" step="0.01"></div>';
        html += '<div class="col-md-3"><select class="form-select"><option value="USD">USD</option><option value="KRW">KRW</option></select></div>';
        html += '</div>';
      });
      
      document.getElementById('discountsList').innerHTML = html;
    }
    
    function addBenefit() {
      const id = benefitCounter++;
      const html = '<div class="row mb-2" id="benefit-' + id + '">' +
        '<div class="col-md-3"><select class="form-select benefit-type">' +
        '<option value="drink_coupon">음료쿠폰</option>' +
        '<option value="late_checkout">레이트체크아웃</option>' +
        '<option value="breakfast">조식</option>' +
        '<option value="upgrade">업그레이드</option>' +
        '<option value="credit">크레딧</option>' +
        '<option value="other">기타</option>' +
        '</select></div>' +
        '<div class="col-md-4"><input type="text" class="form-control benefit-name" placeholder="베네핏명"></div>' +
        '<div class="col-md-3"><input type="text" class="form-control benefit-value" placeholder="값"></div>' +
        '<div class="col-md-2"><button type="button" class="btn btn-sm btn-danger" onclick="document.getElementById(\'benefit-' + id + '\').remove()"><i class="bi bi-trash"></i></button></div>' +
        '</div>';
      
      document.getElementById('benefitsList').innerHTML += html;
    }
    
    async function editPromo(id) {
      const res = await fetch('/api/promotions/' + id);
      const p = await res.json();
      
      document.getElementById('modalTitle').textContent = '프로모션 수정';
      document.getElementById('promoId').value = p.id;
      document.getElementById('hotelId').value = p.hotel_id;
      await loadRoomTypesForPromo();
      
      document.getElementById('promoCode').value = p.promo_code;
      document.getElementById('promoName').value = p.promo_name;
      document.getElementById('bookingStartDate').value = p.booking_start_date;
      document.getElementById('bookingEndDate').value = p.booking_end_date;
      document.getElementById('stayStartDate').value = p.stay_start_date;
      document.getElementById('stayEndDate').value = p.stay_end_date;
      document.getElementById('minNights').value = p.min_nights || 1;
      document.getElementById('description').value = p.description || '';
      document.getElementById('isActive').checked = p.is_active;
      
      // 할인값 채우기
      p.discounts.forEach(d => {
        const inputs = document.querySelectorAll('.discount-room-id');
        inputs.forEach((input, idx) => {
          if (parseInt(input.value) === d.room_type_id) {
            document.querySelectorAll('.discount-value')[idx].value = d.discount_value;
          }
        });
      });
      
      // 베네핏 추가
      document.getElementById('benefitsList').innerHTML = '';
      benefitCounter = 0;
      p.benefits.forEach(b => {
        addBenefit();
        const lastId = benefitCounter - 1;
        const row = document.getElementById('benefit-' + lastId);
        row.querySelector('.benefit-type').value = b.benefit_type;
        row.querySelector('.benefit-name').value = b.benefit_name;
        row.querySelector('.benefit-value').value = b.benefit_value || '';
      });
      
      new bootstrap.Modal(document.getElementById('promoModal')).show();
    }
    
    async function savePromo() {
      const id = document.getElementById('promoId').value;
      
      // 할인 수집
      const discounts = [];
      document.querySelectorAll('.discount-room-id').forEach((input, idx) => {
        const value = parseFloat(document.querySelectorAll('.discount-value')[idx].value);
        if (value > 0) {
          discounts.push({
            room_type_id: parseInt(input.value),
            discount_value: value
          });
        }
      });
      
      // 베네핏 수집
      const benefits = [];
      document.querySelectorAll('[id^="benefit-"]').forEach(row => {
        const name = row.querySelector('.benefit-name').value;
        if (name) {
          benefits.push({
            benefit_type: row.querySelector('.benefit-type').value,
            benefit_name: name,
            benefit_value: row.querySelector('.benefit-value').value || null
          });
        }
      });
      
      const data = {
        hotel_id: document.getElementById('hotelId').value,
        promo_code: document.getElementById('promoCode').value,
        promo_name: document.getElementById('promoName').value,
        booking_start_date: document.getElementById('bookingStartDate').value,
        booking_end_date: document.getElementById('bookingEndDate').value,
        stay_start_date: document.getElementById('stayStartDate').value,
        stay_end_date: document.getElementById('stayEndDate').value,
        min_nights: parseInt(document.getElementById('minNights').value) || 1,
        description: document.getElementById('description').value || null,
        is_active: document.getElementById('isActive').checked,
        discounts,
        benefits
      };
      
      if (!data.hotel_id || !data.promo_code || !data.promo_name) {
        alert('필수 항목을 입력하세요'); return;
      }
      
      const res = await fetch(id ? '/api/promotions/' + id : '/api/promotions', {
        method: id ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      const result = await res.json();
      if (result.error) { alert('저장 실패: ' + result.error); return; }
      
      alert('저장되었습니다');
      bootstrap.Modal.getInstance(document.getElementById('promoModal')).hide();
      loadPromotions();
    }
    
    async function deletePromo(id) {
      if (!confirm('삭제하시겠습니까?')) return;
      
      const res = await fetch('/api/promotions/' + id, { method: 'DELETE' });
      const result = await res.json();
      if (result.error) { alert('삭제 실패: ' + result.error); return; }
      
      alert('삭제되었습니다');
      loadPromotions();
    }
  </script>
</body>
</html>
