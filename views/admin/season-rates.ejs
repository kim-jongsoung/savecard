<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì‹œì¦Œë³„ ê¸°ë³¸ ìš”ê¸ˆ ê´€ë¦¬ - ëŸ­ìŠ¤íŒŒì¸ë“œ ERP</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .rate-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .rate-table th, .rate-table td { border: 1px solid #ddd; padding: 12px; text-align: center; }
    .rate-table th { background: #f8f9fa; font-weight: bold; }
    .rate-table input { width: 100%; text-align: right; border: none; background: transparent; }
    .rate-table input:focus { outline: 2px solid #667eea; background: #fff; }
    
    /* ì‹œì¦Œ ìƒ‰ìƒ */
    .season-LOW { background-color: #90EE90; }
    .season-SHOULDER { background-color: #87CEEB; }
    .season-HIGH { background-color: #FFD700; }
    .season-PEAK { background-color: #FF6347; }
    .season-UNASSIGNED { background-color: #D3D3D3; }
    
    .changed { background-color: #fff3cd !important; }
  </style>
</head>
<body>
  <%- include('../partials/navbar') %>
  <div class="container-fluid mt-3">
    <div class="mb-3">
      <div class="d-flex align-items-center mb-2">
        <h4 class="mb-0 me-3">ğŸ’° ì‹œì¦Œë³„ ê¸°ë³¸ ìš”ê¸ˆ ê´€ë¦¬</h4>
        <label class="me-2">í˜¸í…”:</label>
        <select class="form-select form-select-sm d-inline-block w-auto me-3" id="hotelSelect" onchange="loadData()">
          <option value="">í˜¸í…” ì„ íƒ</option>
        </select>
        <span class="text-muted small">by <%= adminUsername %> | <span id="todayDate"></span></span>
      </div>
      
      <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle"></i> 
        <strong>ì•ˆë‚´:</strong> ì—¬ê¸° ì…ë ¥í•œ ìš”ê¸ˆì€ <strong>ê¸°ë³¸ ì°¸ê³  ìš”ê¸ˆ</strong>ì…ë‹ˆë‹¤. 
        ì‹¤ì œ ì˜ˆì•½ ë° ì •ì‚°ì—ëŠ” <strong>í”„ë¡œëª¨ì…˜ ìš”ê¸ˆ</strong>ì´ ì‚¬ìš©ë©ë‹ˆë‹¤.
      </div>
      
      <div class="d-flex align-items-center gap-2 mb-3">
        <button class="btn btn-success btn-sm" onclick="saveChanges()">ğŸ’¾ ì €ì¥</button>
        <button class="btn btn-secondary btn-sm" onclick="loadData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        <span class="text-muted">|</span>
        <label class="me-2">í†µí™”:</label>
        <select class="form-select form-select-sm d-inline-block w-auto" id="currencySelect">
          <option value="USD">USD ($)</option>
          <option value="KRW">KRW (â‚©)</option>
        </select>
      </div>
    </div>
    
    <div id="rateContainer"></div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.getElementById('todayDate').textContent = new Date().toLocaleDateString('ko-KR');
    
    let hotels = [];
    let seasonTypes = [];
    let roomTypes = [];
    let rates = {}; // key: 'seasonId-roomId', value: { id, base_rate }
    let changes = {};
    
    async function loadHotels() {
      const res = await fetch('/api/hotels?is_active=true');
      hotels = await res.json();
      const select = document.getElementById('hotelSelect');
      hotels.forEach(h => {
        const opt = document.createElement('option');
        opt.value = h.id;
        opt.textContent = h.hotel_name;
        select.appendChild(opt);
      });
      
      // ì‹œì¦Œ íƒ€ì… ë¡œë“œ
      const stRes = await fetch('/api/season-types');
      seasonTypes = await stRes.json();
    }
    
    async function loadData() {
      const hid = document.getElementById('hotelSelect').value;
      if (!hid) return;
      
      // ê°ì‹¤ íƒ€ì… ë¡œë“œ
      const rtRes = await fetch(`/api/hotels/${hid}/room-types`);
      roomTypes = await rtRes.json();
      
      // ìš”ê¸ˆ ë¡œë“œ
      const rateRes = await fetch(`/api/season-rates?hotel_id=${hid}`);
      const rateData = await rateRes.json();
      
      rates = {};
      rateData.forEach(r => {
        const key = `${r.season_type_id}-${r.room_type_id}`;
        rates[key] = r;
      });
      
      changes = {};
      renderTable();
    }
    
    function renderTable() {
      const container = document.getElementById('rateContainer');
      
      if (roomTypes.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">í˜¸í…”ì„ ì„ íƒí•˜ê±°ë‚˜ ê°ì‹¤ íƒ€ì…ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      
      let html = `
        <table class="rate-table">
          <thead>
            <tr>
              <th rowspan="2" style="width: 150px;">ê°ì‹¤ íƒ€ì…</th>
              <th colspan="${seasonTypes.length}">ì‹œì¦Œë³„ ê¸°ë³¸ ìš”ê¸ˆ (USD)</th>
            </tr>
            <tr>`;
      
      seasonTypes.forEach(st => {
        html += `<th class="season-${st.season_code}">${st.season_name}</th>`;
      });
      
      html += `</tr></thead><tbody>`;
      
      roomTypes.forEach(rt => {
        html += `<tr><td><strong>${rt.room_type_name}</strong></td>`;
        
        seasonTypes.forEach(st => {
          const key = `${st.id}-${rt.id}`;
          const rate = changes[key] !== undefined ? changes[key] : (rates[key]?.base_rate || '');
          const isChanged = changes[key] !== undefined;
          
          html += `<td class="season-${st.season_code} ${isChanged ? 'changed' : ''}">
            <input type="number" 
                   value="${rate}" 
                   onchange="markChanged(${st.id}, ${rt.id}, this.value)"
                   placeholder="ì…ë ¥"
                   step="0.01"
                   min="0">
          </td>`;
        });
        
        html += `</tr>`;
      });
      
      html += `</tbody></table>`;
      container.innerHTML = html;
    }
    
    function markChanged(seasonId, roomId, value) {
      const key = `${seasonId}-${roomId}`;
      changes[key] = parseFloat(value) || 0;
      renderTable();
    }
    
    async function saveChanges() {
      if (Object.keys(changes).length === 0) {
        alert('ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      const hid = document.getElementById('hotelSelect').value;
      const currency = document.getElementById('currencySelect').value;
      
      const rateUpdates = [];
      for (const [key, base_rate] of Object.entries(changes)) {
        const [season_type_id, room_type_id] = key.split('-').map(Number);
        rateUpdates.push({ season_type_id, room_type_id, base_rate, currency });
      }
      
      try {
        const res = await fetch('/api/season-rates/bulk', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ hotel_id: hid, rates: rateUpdates })
        });
        
        const data = await res.json();
        
        if (data.success) {
          alert(`ì €ì¥ ì™„ë£Œ: ${data.updated}ê°œ ì—…ë°ì´íŠ¸`);
          changes = {};
          await loadData();
        } else {
          alert('ì €ì¥ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (error) {
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }
    
    loadHotels();
  </script>
</body>
</html>
