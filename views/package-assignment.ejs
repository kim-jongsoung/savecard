<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title || '수배서' %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Sans KR', 'Malgun Gothic', sans-serif;
            background: #f5f5f5;
            color: #000;
            font-size: 9pt;
            line-height: 1.3;
        }
        
        .document-wrapper {
            max-width: 210mm;
            margin: 0.5rem auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 12mm;
        }
        
        @media print {
            body { 
                background: white; 
                margin: 0;
                font-size: 9pt;
            }
            .document-wrapper { 
                max-width: 100%;
                margin: 0;
                padding: 8mm;
                box-shadow: none;
            }
            .no-print { display: none !important; }
            @page { 
                size: A4; 
                margin: 8mm;
            }
            table { page-break-inside: avoid; }
        }
        
        .assignment-header {
            text-align: center;
            border: 2px solid #000;
            padding: 6px;
            margin-bottom: 8px;
            background: #fff;
        }
        
        .doc-title {
            font-size: 20pt;
            font-weight: 700;
            margin: 0;
            padding: 3px 0;
            letter-spacing: 8px;
        }
        
        .doc-subtitle {
            font-size: 9pt;
            margin: 2px 0;
            color: #333;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 6px;
            font-size: 9pt;
        }
        
        table th, table td {
            border: 1px solid #333;
            padding: 3px 5px;
            text-align: left;
            vertical-align: middle;
        }
        
        table th {
            background: #e9ecef;
            font-weight: 600;
            text-align: center;
        }
        
        .section-title {
            background: #333;
            color: white;
            font-weight: 600;
            text-align: center;
            padding: 4px;
            font-size: 9pt;
        }
        
        .label-cell {
            background: #f8f9fa;
            font-weight: 600;
            width: 15%;
            text-align: center;
            font-size: 8.5pt;
        }
        
        .value-cell {
            width: 18%;
            font-size: 9pt;
        }
        
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .fw-bold { font-weight: 600; }
        
        .badge {
            display: inline-block;
            padding: 1px 6px;
            border-radius: 2px;
            font-size: 8pt;
            font-weight: 600;
        }
        
        .badge-success { background: #28a745; color: white; }
        .badge-warning { background: #ffc107; color: #000; }
        .badge-danger { background: #dc3545; color: white; }
        .badge-info { background: #17a2b8; color: white; }
        
        .btn-group {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="document-wrapper">
        <!-- 헤더 -->
        <div class="assignment-header">
            <div class="doc-title">수 배 서</div>
            <div class="doc-subtitle">럭스파인드 (LUXFIND)</div>
            <div class="doc-subtitle">예약번호: <strong><%= assignment.reservation_number %></strong></div>
        </div>

        <!-- 기본 예약 정보 -->
        <table>
            <tr>
                <th colspan="6" class="section-title">기본 예약 정보</th>
            </tr>
            <tr>
                <td class="label-cell">상태</td>
                <td class="value-cell">
                    <% if (assignment.reservation_status === 'confirmed') { %>
                        <span class="badge badge-success">확정</span>
                    <% } else if (assignment.reservation_status === 'pending') { %>
                        <span class="badge badge-warning">대기</span>
                    <% } else if (assignment.reservation_status === 'cancelled') { %>
                        <span class="badge badge-danger">취소</span>
                    <% } else { %>
                        <%= assignment.reservation_status %>
                    <% } %>
                </td>
                <td class="label-cell">예약채널</td>
                <td class="value-cell"><%= assignment.platform_name %></td>
                <td class="label-cell">기간</td>
                <td class="value-cell"><%= assignment.nights %>박<%= assignment.days %>일</td>
            </tr>
            <tr>
                <td class="label-cell">패키지명</td>
                <td colspan="5"><%= assignment.package_name %></td>
            </tr>
            <tr>
                <td class="label-cell">출발일</td>
                <td class="value-cell"><%= new Date(assignment.departure_date).toLocaleDateString('ko-KR') %></td>
                <td class="label-cell">귀국일</td>
                <td class="value-cell"><%= new Date(assignment.return_date).toLocaleDateString('ko-KR') %></td>
                <td class="label-cell">인원</td>
                <td class="value-cell">성인 <%= assignment.adult_count %><% if(assignment.child_count > 0) { %>, 소아 <%= assignment.child_count %><% } %><% if(assignment.infant_count > 0) { %>, 유아 <%= assignment.infant_count %><% } %></td>
            </tr>
        </table>

        <!-- 항공편 정보 -->
        <% if (assignment.flight_info && (assignment.flight_info.outbound_flight || assignment.flight_info.inbound_flight)) { %>
        <table>
            <tr>
                <th colspan="6" class="section-title">항공편 정보</th>
            </tr>
            <tr>
                <td class="label-cell" rowspan="2">출국편</td>
                <td class="label-cell">편명</td>
                <td class="value-cell"><strong><%= assignment.flight_info.outbound_flight || '-' %></strong></td>
                <td class="label-cell" rowspan="2">입국편</td>
                <td class="label-cell">편명</td>
                <td class="value-cell"><strong><%= assignment.flight_info.inbound_flight || '-' %></strong></td>
            </tr>
            <tr>
                <td class="label-cell">출발/도착</td>
                <td class="value-cell"><%= assignment.flight_info.outbound_departure_time || '-' %> / <%= assignment.flight_info.outbound_arrival_time || '-' %></td>
                <td class="label-cell">출발/도착</td>
                <td class="value-cell"><%= assignment.flight_info.inbound_departure_time || '-' %> / <%= assignment.flight_info.inbound_arrival_time || '-' %></td>
            </tr>
        </table>
        <% } %>

        <!-- 호텔 정보 -->
        <% if (assignment.hotel_name || assignment.room_type) { %>
        <table>
            <tr>
                <th colspan="4" class="section-title">이용호텔</th>
            </tr>
            <tr>
                <td class="label-cell">호텔명</td>
                <td class="value-cell"><strong><%= assignment.hotel_name || '-' %></strong></td>
                <td class="label-cell">룸타입</td>
                <td class="value-cell"><%= assignment.room_type || '-' %></td>
            </tr>
        </table>
        <% } %>


        <!-- 고객 정보 -->
        <% if (assignment.guests && assignment.guests.length > 0) { %>
        <table>
            <tr>
                <th colspan="6" class="section-title">고객 정보</th>
            </tr>
            <tr>
                <th class="text-center" style="width: 8%;">구분</th>
                <th class="text-center" style="width: 15%;">한글이름</th>
                <th class="text-center" style="width: 22%;">영문이름</th>
                <th class="text-center" style="width: 12%;">생년월일</th>
                <th class="text-center" style="width: 15%;">연락처</th>
                <th class="text-center" style="width: 8%;">성별</th>
            </tr>
            <% assignment.guests.forEach((guest, index) => { %>
            <tr>
                <td class="text-center"><%= guest.type || '성인' %></td>
                <td><%= guest.korean_name || '-' %></td>
                <td><%= guest.english_name || '-' %></td>
                <td class="text-center"><%= guest.birth_date ? new Date(guest.birth_date).toLocaleDateString('ko-KR') : '-' %></td>
                <td class="text-center"><%= guest.phone || '-' %></td>
                <td class="text-center"><%= guest.gender || '-' %></td>
            </tr>
            <% }); %>
        </table>
        <% } %>

        <!-- 일정 및 포함/불포함 사항 -->
        <% if (assignment.itinerary || assignment.inclusions || assignment.exclusions) { %>
        <table>
            <tr>
                <th colspan="2" class="section-title">일정 및 포함/불포함 사항</th>
            </tr>
            <% if (assignment.itinerary) { %>
            <tr>
                <td class="label-cell" style="width: 15%;">일정</td>
                <td style="white-space: pre-line; padding: 6px;"><%= assignment.itinerary %></td>
            </tr>
            <% } %>
            <% if (assignment.inclusions) { %>
            <tr>
                <td class="label-cell" style="width: 15%;">포함사항</td>
                <td style="white-space: pre-line; padding: 6px;"><%= assignment.inclusions %></td>
            </tr>
            <% } %>
            <% if (assignment.exclusions) { %>
            <tr>
                <td class="label-cell" style="width: 15%;">불포함사항</td>
                <td style="white-space: pre-line; padding: 6px;"><%= assignment.exclusions %></td>
            </tr>
            <% } %>
        </table>
        <% } %>

        <!-- 특별 요청사항 -->
        <% if (assignment.special_requests) { %>
        <table>
            <tr>
                <th colspan="2" class="section-title" style="background: #dc3545;">특별 요청사항</th>
            </tr>
            <tr>
                <td colspan="2" style="white-space: pre-line; padding: 6px; background: #fff3cd;"><strong>⚠️ <%= assignment.special_requests %></strong></td>
            </tr>
        </table>
        <% } %>

        <!-- 수배 정보 -->
        <table>
            <tr>
                <th colspan="4" class="section-title">수배 정보</th>
            </tr>
            <tr>
                <td class="label-cell">수배항목</td>
                <td class="value-cell"><%= assignment.component_type %></td>
                <td class="label-cell">공급업체</td>
                <td class="value-cell"><%= assignment.vendor_name %></td>
            </tr>
            <% if (assignment.notes) { %>
            <tr>
                <td class="label-cell">비고</td>
                <td colspan="3" style="background: #fff3cd;"><%= assignment.notes %></td>
            </tr>
            <% } %>
            <tr>
                <td class="label-cell">발송일시</td>
                <td class="value-cell"><%= assignment.assignment_sent_at ? new Date(assignment.assignment_sent_at).toLocaleString('ko-KR') : '-' %></td>
                <td class="label-cell">수신확인</td>
                <td class="value-cell">
                    <% if (assignment.assignment_confirmed_at) { %>
                        <span class="badge badge-info">✓ <%= new Date(assignment.assignment_confirmed_at).toLocaleString('ko-KR') %></span>
                    <% } else { %>
                        <span class="badge badge-warning">미확인</span>
                    <% } %>
                </td>
            </tr>
        </table>

        <!-- 버튼 영역 -->
        <div class="text-center mt-3 no-print btn-group">
            <% if (!assignment.assignment_confirmed_at) { %>
            <button class="btn btn-success" onclick="confirmReceipt()" style="min-width: 150px; margin-right: 10px;">
                <i class="fas fa-check-circle me-1"></i>수신 확인
            </button>
            <% } %>
            <button class="btn btn-primary" onclick="window.print()" style="min-width: 150px;">
                <i class="fas fa-print me-1"></i>인쇄
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 수신 확인
        async function confirmReceipt() {
            if (!confirm('수배서를 수신 확인하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch('/api/package-reservations/<%= reservationId %>/assignment/<%= componentIndex %>/confirm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    alert('수신 확인이 완료되었습니다.');
                    location.reload();
                } else {
                    alert('수신 확인 실패: ' + result.message);
                }
            } catch (error) {
                console.error('수신 확인 오류:', error);
                alert('수신 확인 중 오류가 발생했습니다.');
            }
        }
    </script>
</body>
</html>
