<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title || '수배서' %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Sans KR', 'Malgun Gothic', sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .document-wrapper {
            max-width: 1200px;
            margin: 2rem auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            padding: 2rem;
        }
        
        @media print {
            body { background: white; margin: 0; }
            .document-wrapper { 
                max-width: 100%;
                margin: 0;
                padding: 1.5cm;
                box-shadow: none;
            }
            .no-print { display: none !important; }
            @page { size: A4; margin: 1.5cm; }
        }
        
        .assignment-header {
            background: linear-gradient(to right, #28a745, #20c997);
            color: white;
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .doc-title {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: 2px;
            margin-bottom: 0.5rem;
        }
        
        .info-card {
            border: 1px solid #e0e0e0;
            border-left: 4px solid #28a745;
            background: white;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .card-header {
            background: #f8f9fa;
            border-bottom: 2px solid #28a745;
            font-weight: 600;
        }
        
        .info-row {
            padding: 0.75rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #666;
            font-size: 0.9rem;
        }
        
        .info-value {
            font-size: 1rem;
            color: #333;
        }
        
        .badge-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="document-wrapper">
        <!-- 헤더 -->
        <div class="assignment-header">
            <div class="doc-title">
                <i class="fas fa-file-alt me-2"></i>
                수배서 - 럭스파인드
            </div>
            <div class="mt-2">
                <code class="fs-5 text-white"><%= assignment.reservation_number %></code>
            </div>
        </div>

        <!-- 기본 예약 정보 -->
        <div class="card info-card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>기본 예약 정보</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="info-row">
                            <div class="info-label">예약번호</div>
                            <div class="info-value"><code><%= assignment.reservation_number %></code></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-row">
                            <div class="info-label">예약 상태</div>
                            <div class="info-value">
                                <% if (assignment.reservation_status === 'confirmed') { %>
                                    <span class="badge bg-success">✅ 확정</span>
                                <% } else if (assignment.reservation_status === 'pending') { %>
                                    <span class="badge bg-warning">⏳ 대기</span>
                                <% } else if (assignment.reservation_status === 'cancelled') { %>
                                    <span class="badge bg-danger">❌ 취소</span>
                                <% } else { %>
                                    <span class="badge bg-secondary"><%= assignment.reservation_status %></span>
                                <% } %>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-row">
                            <div class="info-label">예약채널</div>
                            <div class="info-value"><span class="badge bg-info"><%= assignment.platform_name %></span></div>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="info-row">
                            <div class="info-label">패키지명</div>
                            <div class="info-value"><strong><%= assignment.package_name %></strong></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-row">
                            <div class="info-label">출발일</div>
                            <div class="info-value"><%= new Date(assignment.departure_date).toLocaleDateString('ko-KR') %></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-row">
                            <div class="info-label">귀국일</div>
                            <div class="info-value"><%= new Date(assignment.return_date).toLocaleDateString('ko-KR') %></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-row">
                            <div class="info-label">기간</div>
                            <div class="info-value"><strong><%= assignment.nights %>박<%= assignment.days %>일</strong></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 항공편 정보 -->
        <% if (assignment.flight_info && (assignment.flight_info.outbound_flight || assignment.flight_info.inbound_flight)) { %>
        <div class="card info-card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-plane me-2"></i>항공편 정보</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <% if (assignment.flight_info.outbound_flight) { %>
                    <div class="col-md-6">
                        <h6 class="text-primary"><i class="fas fa-plane-departure me-2"></i>출국편</h6>
                        <div class="info-row">
                            <div class="info-label">편명</div>
                            <div class="info-value"><strong><%= assignment.flight_info.outbound_flight %></strong></div>
                        </div>
                        <% if (assignment.flight_info.outbound_departure_time) { %>
                        <div class="info-row">
                            <div class="info-label">출발시간</div>
                            <div class="info-value"><%= assignment.flight_info.outbound_departure_time %></div>
                        </div>
                        <% } %>
                        <% if (assignment.flight_info.outbound_arrival_time) { %>
                        <div class="info-row">
                            <div class="info-label">도착시간</div>
                            <div class="info-value"><%= assignment.flight_info.outbound_arrival_time %></div>
                        </div>
                        <% } %>
                    </div>
                    <% } %>
                    <% if (assignment.flight_info.inbound_flight) { %>
                    <div class="col-md-6">
                        <h6 class="text-success"><i class="fas fa-plane-arrival me-2"></i>입국편</h6>
                        <div class="info-row">
                            <div class="info-label">편명</div>
                            <div class="info-value"><strong><%= assignment.flight_info.inbound_flight %></strong></div>
                        </div>
                        <% if (assignment.flight_info.inbound_departure_time) { %>
                        <div class="info-row">
                            <div class="info-label">출발시간</div>
                            <div class="info-value"><%= assignment.flight_info.inbound_departure_time %></div>
                        </div>
                        <% } %>
                        <% if (assignment.flight_info.inbound_arrival_time) { %>
                        <div class="info-row">
                            <div class="info-label">도착시간</div>
                            <div class="info-value"><%= assignment.flight_info.inbound_arrival_time %></div>
                        </div>
                        <% } %>
                    </div>
                    <% } %>
                </div>
            </div>
        </div>
        <% } %>

        <!-- 호텔 정보 -->
        <% if (assignment.hotel_name || assignment.room_type) { %>
        <div class="card info-card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-hotel me-2"></i>이용호텔</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <% if (assignment.hotel_name) { %>
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">호텔명</div>
                            <div class="info-value"><strong><%= assignment.hotel_name %></strong></div>
                        </div>
                    </div>
                    <% } %>
                    <% if (assignment.room_type) { %>
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">룸타입명</div>
                            <div class="info-value"><%= assignment.room_type %></div>
                        </div>
                    </div>
                    <% } %>
                </div>
            </div>
        </div>
        <% } %>

        <!-- 인원 구성 -->
        <div class="card info-card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-users me-2"></i>인원 구성</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="info-row">
                            <div class="info-label">성인</div>
                            <div class="info-value"><span class="badge bg-primary fs-5"><%= assignment.adult_count %></span></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-row">
                            <div class="info-label">소아</div>
                            <div class="info-value"><span class="badge bg-info fs-5"><%= assignment.child_count %></span></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-row">
                            <div class="info-label">유아</div>
                            <div class="info-value"><span class="badge bg-secondary fs-5"><%= assignment.infant_count %></span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 고객 정보 (투숙객) -->
        <% if (assignment.guests && assignment.guests.length > 0) { %>
        <div class="card info-card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-user me-2"></i>고객 정보</h5>
            </div>
            <div class="card-body">
                <% assignment.guests.forEach((guest, index) => { %>
                <div class="card mb-2" style="border-left: 3px solid #007bff;">
                    <div class="card-body">
                        <h6 class="text-primary mb-3"><%= guest.type || '고객' %> <%= index + 1 %></h6>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="info-label">한글이름</div>
                                <div class="info-value"><strong><%= guest.korean_name || '-' %></strong></div>
                            </div>
                            <div class="col-md-3">
                                <div class="info-label">영문이름</div>
                                <div class="info-value"><%= guest.english_name || '-' %></div>
                            </div>
                            <div class="col-md-2">
                                <div class="info-label">생년월일</div>
                                <div class="info-value"><%= guest.birth_date ? new Date(guest.birth_date).toLocaleDateString('ko-KR') : '-' %></div>
                            </div>
                            <div class="col-md-2">
                                <div class="info-label">연락처</div>
                                <div class="info-value"><%= guest.phone || '-' %></div>
                            </div>
                            <div class="col-md-2">
                                <div class="info-label">성별</div>
                                <div class="info-value"><%= guest.gender || '-' %></div>
                            </div>
                            <% if (guest.email) { %>
                            <div class="col-md-12 mt-2">
                                <div class="info-label">이메일</div>
                                <div class="info-value"><%= guest.email %></div>
                            </div>
                            <% } %>
                        </div>
                    </div>
                </div>
                <% }); %>
            </div>
        </div>
        <% } %>

        <!-- 일정 및 포함/불포함 사항 -->
        <% if (assignment.itinerary || assignment.inclusions || assignment.exclusions) { %>
        <div class="card info-card">
            <div class="card-header" style="background: linear-gradient(to right, #667eea, #764ba2); color: white;">
                <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>일정 및 포함/불포함 사항</h5>
            </div>
            <div class="card-body">
                <% if (assignment.itinerary) { %>
                <div class="mb-3">
                    <div class="info-label mb-2">일정</div>
                    <div class="alert alert-light" style="white-space: pre-line;"><%= assignment.itinerary %></div>
                </div>
                <% } %>
                <% if (assignment.inclusions) { %>
                <div class="mb-3">
                    <div class="info-label mb-2">포함사항</div>
                    <div class="alert alert-success" style="white-space: pre-line;"><i class="fas fa-check-circle me-2"></i><%= assignment.inclusions %></div>
                </div>
                <% } %>
                <% if (assignment.exclusions) { %>
                <div class="mb-3">
                    <div class="info-label mb-2">불포함사항</div>
                    <div class="alert alert-warning" style="white-space: pre-line;"><i class="fas fa-times-circle me-2"></i><%= assignment.exclusions %></div>
                </div>
                <% } %>
            </div>
        </div>
        <% } %>

        <!-- 특별 요청사항 -->
        <% if (assignment.special_requests) { %>
        <div class="card info-card">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>특별 요청사항</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-danger mb-0" style="white-space: pre-line;">
                    <i class="fas fa-info-circle me-2"></i><%= assignment.special_requests %>
                </div>
            </div>
        </div>
        <% } %>

        <!-- 수배 정보 -->
        <div class="card info-card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-building me-2"></i>수배 정보</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">항목</div>
                            <div class="info-value">
                                <span class="badge bg-success fs-6"><%= assignment.component_type %> - <%= assignment.vendor_name %></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">매입가</div>
                            <div class="info-value">
                                <strong class="text-success fs-5">
                                    <%= assignment.cost_amount.toLocaleString() %> <%= assignment.cost_currency %>
                                </strong>
                                <% if (assignment.cost_currency === 'USD') { %>
                                    <br><small class="text-muted">(₩<%= assignment.cost_krw.toLocaleString() %>)</small>
                                <% } %>
                            </div>
                        </div>
                    </div>
                    <% if (assignment.notes) { %>
                    <div class="col-md-12">
                        <div class="info-row">
                            <div class="info-label">비고</div>
                            <div class="info-value">
                                <div class="alert alert-warning mb-0">
                                    <i class="fas fa-sticky-note me-2"></i><%= assignment.notes %>
                                </div>
                            </div>
                        </div>
                    </div>
                    <% } %>
                    <% if (assignment.assignment_sent_at) { %>
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">발송일시</div>
                            <div class="info-value">
                                <%= new Date(assignment.assignment_sent_at).toLocaleString('ko-KR') %>
                            </div>
                        </div>
                    </div>
                    <% } %>
                    <% if (assignment.assignment_confirmed_at) { %>
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">수신확인일시</div>
                            <div class="info-value">
                                <span class="badge bg-info">
                                    <i class="fas fa-check-circle me-1"></i>
                                    <%= new Date(assignment.assignment_confirmed_at).toLocaleString('ko-KR') %>
                                </span>
                            </div>
                        </div>
                    </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- 수신 확인 버튼 (미확인 시에만 표시) -->
        <% if (!assignment.assignment_confirmed_at) { %>
        <div class="text-center mt-4 no-print">
            <button class="btn btn-success btn-lg" onclick="confirmReceipt()" style="min-width: 250px;">
                <i class="fas fa-check-circle me-2"></i>수신 확인
            </button>
        </div>
        <% } %>

        <!-- 인쇄 버튼 -->
        <div class="text-center mt-4 no-print">
            <button class="btn btn-primary btn-lg" onclick="window.print()" style="min-width: 250px;">
                <i class="fas fa-print me-2"></i>인쇄
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 수신 확인
        async function confirmReceipt() {
            if (!confirm('수배서를 수신 확인하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch('/api/package-reservations/<%= reservationId %>/assignment/<%= componentIndex %>/confirm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    alert('수신 확인이 완료되었습니다.');
                    location.reload();
                } else {
                    alert('수신 확인 실패: ' + result.message);
                }
            } catch (error) {
                console.error('수신 확인 오류:', error);
                alert('수신 확인 중 오류가 발생했습니다.');
            }
        }
    </script>
</body>
</html>
