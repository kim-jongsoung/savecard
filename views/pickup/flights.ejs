<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>항공편 관리</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="bi bi-airplane"></i> 항공편 관리</h2>
      <div>
        <button class="btn btn-outline-secondary me-2" onclick="location.href='/pickup'">
          <i class="bi bi-arrow-left"></i> 픽업 관리로
        </button>
        <button class="btn btn-primary" onclick="showAddModal()">
          <i class="bi bi-plus-circle"></i> 항공편 추가
        </button>
      </div>
    </div>

    <!-- 항공편 목록 -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-list"></i> 등록된 항공편</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover" id="flightsTable">
            <thead>
              <tr>
                <th>편명</th>
                <th>출발공항</th>
                <th>도착공항</th>
                <th>출발시간</th>
                <th>도착시간</th>
                <th>비행시간</th>
                <th>운항요일</th>
                <th>상태</th>
                <th>관리</th>
              </tr>
            </thead>
            <tbody id="flightsBody">
              <!-- 동적 로드 -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 추가/수정 모달 -->
  <div class="modal fade" id="flightModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">항공편 추가</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="flightForm">
            <input type="hidden" id="flightId">
            
            <div class="mb-3">
              <label class="form-label">편명 *</label>
              <input type="text" class="form-control" id="flightNumber" placeholder="예: KE111, OZ456" required style="text-transform: uppercase;">
              <small class="text-muted">항공사 코드 + 숫자</small>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">출발공항 (코드) *</label>
                <input type="text" class="form-control" id="departureAirport" placeholder="ICN" maxlength="3" required style="text-transform: uppercase;" list="depAirports">
                <datalist id="depAirports">
                  <option value="ICN">인천</option>
                  <option value="PUS">부산(김해)</option>
                  <option value="TAE">대구</option>
                  <option value="GMP">김포</option>
                  <option value="CJU">제주</option>
                  <option value="GUM">괌</option>
                  <option value="NRT">나리타</option>
                  <option value="FUK">후쿠오카</option>
                </datalist>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">도착공항 (코드) *</label>
                <input type="text" class="form-control" id="arrivalAirport" placeholder="GUM" maxlength="3" required style="text-transform: uppercase;" list="arrAirports">
                <datalist id="arrAirports">
                  <option value="GUM">괌</option>
                  <option value="ICN">인천</option>
                  <option value="PUS">부산(김해)</option>
                  <option value="TAE">대구</option>
                  <option value="GMP">김포</option>
                  <option value="NRT">나리타</option>
                  <option value="SPN">사이판</option>
                  <option value="ROR">팔라우</option>
                </datalist>
              </div>
            </div>

            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">출발시간 *</label>
                <input type="text" class="form-control" id="departureTime" placeholder="07:30" pattern="[0-2][0-9]:[0-5][0-9]" required list="timeSuggestions">
                <small class="text-muted">00:00~24:00 (24시간제)</small>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">도착시간 *</label>
                <input type="text" class="form-control" id="arrivalTime" placeholder="12:30" pattern="[0-2][0-9]:[0-5][0-9]" required list="timeSuggestions">
                <small class="text-muted">현지시간 00:00~24:00</small>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">비행시간 (시간) *</label>
                <input type="number" class="form-control" id="flightHours" step="0.5" min="1" max="12" value="4" required>
                <small class="text-muted">날짜 계산용</small>
              </div>
            </div>
            
            <datalist id="timeSuggestions">
              <option value="00:00"></option>
              <option value="01:00"></option>
              <option value="03:30"></option>
              <option value="07:00"></option>
              <option value="07:30"></option>
              <option value="10:00"></option>
              <option value="12:30"></option>
              <option value="13:00"></option>
              <option value="13:20"></option>
              <option value="15:00"></option>
              <option value="15:30"></option>
              <option value="17:00"></option>
              <option value="20:00"></option>
              <option value="22:00"></option>
              <option value="23:59"></option>
            </datalist>

            <div class="mb-3">
              <label class="form-label">운항요일</label>
              <div class="btn-group btn-group-sm w-100" role="group">
                <input type="checkbox" class="btn-check" id="day1" value="1">
                <label class="btn btn-outline-primary" for="day1">월</label>
                
                <input type="checkbox" class="btn-check" id="day2" value="2">
                <label class="btn btn-outline-primary" for="day2">화</label>
                
                <input type="checkbox" class="btn-check" id="day3" value="3">
                <label class="btn btn-outline-primary" for="day3">수</label>
                
                <input type="checkbox" class="btn-check" id="day4" value="4">
                <label class="btn btn-outline-primary" for="day4">목</label>
                
                <input type="checkbox" class="btn-check" id="day5" value="5">
                <label class="btn btn-outline-primary" for="day5">금</label>
                
                <input type="checkbox" class="btn-check" id="day6" value="6">
                <label class="btn btn-outline-primary" for="day6">토</label>
                
                <input type="checkbox" class="btn-check" id="day7" value="7">
                <label class="btn btn-outline-primary" for="day7">일</label>
              </div>
              <small class="text-muted">선택하지 않으면 매일 운항</small>
            </div>

            <div class="mb-3">
              <label class="form-label">메모</label>
              <textarea class="form-control" id="notes" rows="2" placeholder="예: 심야편, 새벽 출발 등"></textarea>
            </div>

            <div class="mb-3">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="isActive" checked>
                <label class="form-check-label" for="isActive">활성화</label>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="button" class="btn btn-primary" onclick="saveFlight()">저장</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let modal;
    let editingId = null;

    document.addEventListener('DOMContentLoaded', () => {
      modal = new bootstrap.Modal(document.getElementById('flightModal'));
      loadFlights();
    });

    // 항공편 목록 로드
    async function loadFlights() {
      try {
        const res = await fetch('/pickup/api/flights/all');
        const flights = await res.json();
        
        const tbody = document.getElementById('flightsBody');
        if (flights.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" class="text-center">등록된 항공편이 없습니다</td></tr>';
          return;
        }

        tbody.innerHTML = flights.map(f => `
          <tr class="${!f.is_active ? 'table-secondary' : ''}">
            <td>
              <strong>${f.flight_number}</strong>
              ${!f.is_active ? '<br><small class="text-muted">(사용중인 픽업건 있음)</small>' : ''}
            </td>
            <td><span class="badge bg-info">${f.departure_airport || '-'}</span></td>
            <td><span class="badge bg-info">${f.arrival_airport || '-'}</span></td>
            <td>${f.departure_time?.substring(0,5) || '-'}</td>
            <td>${f.arrival_time?.substring(0,5) || '-'}</td>
            <td>${f.flight_hours || '-'}h</td>
            <td>${formatDaysOfWeek(f.days_of_week)}</td>
            <td>
              ${f.is_active 
                ? '<span class="badge bg-success">활성</span>' 
                : '<span class="badge bg-secondary">비활성</span>'}
            </td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="editFlight(${f.id})">
                <i class="bi bi-pencil"></i>
              </button>
              ${f.is_active
                ? `<button class="btn btn-sm btn-outline-danger" onclick="deleteFlight(${f.id}, '${f.flight_number}')">
                     <i class="bi bi-trash"></i>
                   </button>`
                : `<button class="btn btn-sm btn-outline-success" onclick="activateFlight(${f.id}, '${f.flight_number}')">
                     <i class="bi bi-check-circle"></i> 활성화
                   </button>`
              }
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('항공편 로드 실패:', error);
        alert('항공편 목록을 불러오는데 실패했습니다.');
      }
    }

    // 운항요일 포맷
    function formatDaysOfWeek(days) {
      if (!days || days === '1,2,3,4,5,6,7') return '매일';
      const dayNames = ['', '월', '화', '수', '목', '금', '토', '일'];
      return days.split(',').map(d => dayNames[d]).join(',');
    }

    // 추가 모달 표시
    function showAddModal() {
      editingId = null;
      document.getElementById('modalTitle').textContent = '항공편 추가';
      document.getElementById('flightForm').reset();
      document.getElementById('flightId').value = '';
      document.getElementById('isActive').checked = true;
      
      // 모든 요일 체크
      for (let i = 1; i <= 7; i++) {
        document.getElementById(`day${i}`).checked = true;
      }
      
      modal.show();
    }

    // 수정 모달
    async function editFlight(id) {
      try {
        const res = await fetch(`/pickup/api/flights/${id}`);
        const flight = await res.json();
        
        editingId = id;
        document.getElementById('modalTitle').textContent = '항공편 수정';
        document.getElementById('flightId').value = id;
        document.getElementById('flightNumber').value = flight.flight_number;
        document.getElementById('departureAirport').value = flight.departure_airport || '';
        document.getElementById('arrivalAirport').value = flight.arrival_airport || '';
        document.getElementById('departureTime').value = flight.departure_time?.substring(0,5) || '';
        document.getElementById('arrivalTime').value = flight.arrival_time?.substring(0,5) || '';
        document.getElementById('flightHours').value = flight.flight_hours || 4;
        document.getElementById('notes').value = flight.notes || '';
        document.getElementById('isActive').checked = flight.is_active;
        
        // 운항요일 체크
        const days = flight.days_of_week?.split(',') || [];
        for (let i = 1; i <= 7; i++) {
          document.getElementById(`day${i}`).checked = days.includes(String(i));
        }
        
        modal.show();
      } catch (error) {
        console.error('항공편 로드 실패:', error);
        alert('항공편 정보를 불러오는데 실패했습니다.');
      }
    }

    // 저장
    async function saveFlight() {
      const form = document.getElementById('flightForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      // 운항요일 수집
      const days = [];
      for (let i = 1; i <= 7; i++) {
        if (document.getElementById(`day${i}`).checked) {
          days.push(i);
        }
      }

      const flightNumber = document.getElementById('flightNumber').value.toUpperCase();
      const airline = flightNumber.match(/^[A-Z]+/)?.[0] || '';
      
      const data = {
        airline: airline,
        flight_number: flightNumber,
        departure_airport: document.getElementById('departureAirport').value.toUpperCase(),
        arrival_airport: document.getElementById('arrivalAirport').value.toUpperCase(),
        departure_time: document.getElementById('departureTime').value,
        arrival_time: document.getElementById('arrivalTime').value,
        flight_hours: parseFloat(document.getElementById('flightHours').value),
        days_of_week: days.length > 0 ? days.join(',') : '1,2,3,4,5,6,7',
        notes: document.getElementById('notes').value,
        is_active: document.getElementById('isActive').checked
      };

      try {
        const url = editingId 
          ? `/pickup/api/flights/${editingId}`
          : '/pickup/api/flights';
        
        const method = editingId ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || '저장 실패');
        }

        alert(editingId ? '항공편이 수정되었습니다.' : '항공편이 추가되었습니다.');
        modal.hide();
        loadFlights();
      } catch (error) {
        console.error('저장 실패:', error);
        alert('저장에 실패했습니다: ' + error.message);
      }
    }

    // 삭제
    async function deleteFlight(id, flightNumber) {
      if (!confirm(`${flightNumber} 항공편을 삭제하시겠습니까?\n\n※ 해당 항공편을 사용하는 픽업 예약이 있으면 비활성화 처리됩니다.`)) return;

      try {
        const res = await fetch(`/pickup/api/flights/${id}`, {
          method: 'DELETE'
        });
        
        const result = await res.json();

        if (res.ok) {
          if (result.deactivated) {
            alert('⚠️ ' + result.message + '\n\n비활성 상태로 전환되었습니다.');
          } else {
            alert('✅ ' + result.message);
          }
          loadFlights();
        } else {
          alert('❌ 삭제 실패\n\n' + (result.error || '알 수 없는 오류'));
          if (result.hint) {
            alert('💡 ' + result.hint);
          }
        }
      } catch (error) {
        console.error('삭제 실패:', error);
        alert('❌ 삭제에 실패했습니다: ' + error.message);
      }
    }
    
    // 활성화
    async function activateFlight(id, flightNumber) {
      if (!confirm(`${flightNumber} 항공편을 다시 활성화하시겠습니까?`)) return;
      
      try {
        const res = await fetch(`/pickup/api/flights/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_active: true })
        });
        
        if (res.ok) {
          alert('✅ 항공편이 활성화되었습니다.');
          loadFlights();
        } else {
          const result = await res.json();
          alert('❌ 활성화 실패: ' + (result.error || '알 수 없는 오류'));
        }
      } catch (error) {
        console.error('활성화 실패:', error);
        alert('❌ 활성화에 실패했습니다: ' + error.message);
      }
    }
  </script>
</body>
</html>
