<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í•­ê³µí¸ ê´€ë¦¬</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="bi bi-airplane"></i> í•­ê³µí¸ ê´€ë¦¬</h2>
      <div>
        <button class="btn btn-outline-secondary me-2" onclick="location.href='/pickup'">
          <i class="bi bi-arrow-left"></i> í”½ì—… ê´€ë¦¬ë¡œ
        </button>
        <button class="btn btn-primary" onclick="showAddModal()">
          <i class="bi bi-plus-circle"></i> í•­ê³µí¸ ì¶”ê°€
        </button>
      </div>
    </div>

    <!-- í•­ê³µí¸ ëª©ë¡ -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-list"></i> ë“±ë¡ëœ í•­ê³µí¸</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover" id="flightsTable">
            <thead>
              <tr>
                <th>í¸ëª…</th>
                <th>ì¶œë°œê³µí•­</th>
                <th>ë„ì°©ê³µí•­</th>
                <th>ì¶œë°œì‹œê°„</th>
                <th>ë„ì°©ì‹œê°„</th>
                <th>ë¹„í–‰ì‹œê°„</th>
                <th>ìš´í•­ìš”ì¼</th>
                <th>ìƒíƒœ</th>
                <th>ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody id="flightsBody">
              <!-- ë™ì  ë¡œë“œ -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
  <div class="modal fade" id="flightModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">í•­ê³µí¸ ì¶”ê°€</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="flightForm">
            <input type="hidden" id="flightId">
            
            <div class="mb-3">
              <label class="form-label">í¸ëª… *</label>
              <input type="text" class="form-control" id="flightNumber" placeholder="ì˜ˆ: KE111, OZ456" required style="text-transform: uppercase;">
              <small class="text-muted">í•­ê³µì‚¬ ì½”ë“œ + ìˆ«ì</small>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">ì¶œë°œê³µí•­ (ì½”ë“œ) *</label>
                <input type="text" class="form-control" id="departureAirport" placeholder="ICN" maxlength="3" required style="text-transform: uppercase;" list="depAirports">
                <datalist id="depAirports">
                  <option value="ICN">ì¸ì²œ</option>
                  <option value="PUS">ë¶€ì‚°(ê¹€í•´)</option>
                  <option value="TAE">ëŒ€êµ¬</option>
                  <option value="GMP">ê¹€í¬</option>
                  <option value="CJU">ì œì£¼</option>
                  <option value="GUM">ê´Œ</option>
                  <option value="NRT">ë‚˜ë¦¬íƒ€</option>
                  <option value="FUK">í›„ì¿ ì˜¤ì¹´</option>
                </datalist>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">ë„ì°©ê³µí•­ (ì½”ë“œ) *</label>
                <input type="text" class="form-control" id="arrivalAirport" placeholder="GUM" maxlength="3" required style="text-transform: uppercase;" list="arrAirports">
                <datalist id="arrAirports">
                  <option value="GUM">ê´Œ</option>
                  <option value="ICN">ì¸ì²œ</option>
                  <option value="PUS">ë¶€ì‚°(ê¹€í•´)</option>
                  <option value="TAE">ëŒ€êµ¬</option>
                  <option value="GMP">ê¹€í¬</option>
                  <option value="NRT">ë‚˜ë¦¬íƒ€</option>
                  <option value="SPN">ì‚¬ì´íŒ</option>
                  <option value="ROR">íŒ”ë¼ìš°</option>
                </datalist>
              </div>
            </div>

            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">ì¶œë°œì‹œê°„ *</label>
                <input type="text" class="form-control" id="departureTime" placeholder="07:30" pattern="[0-2][0-9]:[0-5][0-9]" required list="timeSuggestions">
                <small class="text-muted">00:00~24:00 (24ì‹œê°„ì œ)</small>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">ë„ì°©ì‹œê°„ *</label>
                <input type="text" class="form-control" id="arrivalTime" placeholder="12:30" pattern="[0-2][0-9]:[0-5][0-9]" required list="timeSuggestions">
                <small class="text-muted">í˜„ì§€ì‹œê°„ 00:00~24:00</small>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">ë¹„í–‰ì‹œê°„ (ì‹œê°„) *</label>
                <input type="number" class="form-control" id="flightHours" step="0.5" min="1" max="12" value="4" required>
                <small class="text-muted">ë‚ ì§œ ê³„ì‚°ìš©</small>
              </div>
            </div>
            
            <datalist id="timeSuggestions">
              <option value="00:00"></option>
              <option value="01:00"></option>
              <option value="03:30"></option>
              <option value="07:00"></option>
              <option value="07:30"></option>
              <option value="10:00"></option>
              <option value="12:30"></option>
              <option value="13:00"></option>
              <option value="13:20"></option>
              <option value="15:00"></option>
              <option value="15:30"></option>
              <option value="17:00"></option>
              <option value="20:00"></option>
              <option value="22:00"></option>
              <option value="23:59"></option>
            </datalist>

            <div class="mb-3">
              <label class="form-label">ìš´í•­ìš”ì¼</label>
              <div class="btn-group btn-group-sm w-100" role="group">
                <input type="checkbox" class="btn-check" id="day1" value="1">
                <label class="btn btn-outline-primary" for="day1">ì›”</label>
                
                <input type="checkbox" class="btn-check" id="day2" value="2">
                <label class="btn btn-outline-primary" for="day2">í™”</label>
                
                <input type="checkbox" class="btn-check" id="day3" value="3">
                <label class="btn btn-outline-primary" for="day3">ìˆ˜</label>
                
                <input type="checkbox" class="btn-check" id="day4" value="4">
                <label class="btn btn-outline-primary" for="day4">ëª©</label>
                
                <input type="checkbox" class="btn-check" id="day5" value="5">
                <label class="btn btn-outline-primary" for="day5">ê¸ˆ</label>
                
                <input type="checkbox" class="btn-check" id="day6" value="6">
                <label class="btn btn-outline-primary" for="day6">í† </label>
                
                <input type="checkbox" class="btn-check" id="day7" value="7">
                <label class="btn btn-outline-primary" for="day7">ì¼</label>
              </div>
              <small class="text-muted">ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ë§¤ì¼ ìš´í•­</small>
            </div>

            <div class="mb-3">
              <label class="form-label">ë©”ëª¨</label>
              <textarea class="form-control" id="notes" rows="2" placeholder="ì˜ˆ: ì‹¬ì•¼í¸, ìƒˆë²½ ì¶œë°œ ë“±"></textarea>
            </div>

            <div class="mb-3">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="isActive" checked>
                <label class="form-check-label" for="isActive">í™œì„±í™”</label>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" onclick="saveFlight()">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let modal;
    let editingId = null;

    document.addEventListener('DOMContentLoaded', () => {
      modal = new bootstrap.Modal(document.getElementById('flightModal'));
      loadFlights();
    });

    // í•­ê³µí¸ ëª©ë¡ ë¡œë“œ
    async function loadFlights() {
      try {
        const res = await fetch('/pickup/api/flights/all');
        const flights = await res.json();
        
        const tbody = document.getElementById('flightsBody');
        if (flights.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" class="text-center">ë“±ë¡ëœ í•­ê³µí¸ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
          return;
        }

        tbody.innerHTML = flights.map(f => `
          <tr class="${!f.is_active ? 'table-secondary' : ''}">
            <td>
              <strong>${f.flight_number}</strong>
              ${!f.is_active ? '<br><small class="text-muted">(ì‚¬ìš©ì¤‘ì¸ í”½ì—…ê±´ ìˆìŒ)</small>' : ''}
            </td>
            <td><span class="badge bg-info">${f.departure_airport || '-'}</span></td>
            <td><span class="badge bg-info">${f.arrival_airport || '-'}</span></td>
            <td>${f.departure_time?.substring(0,5) || '-'}</td>
            <td>${f.arrival_time?.substring(0,5) || '-'}</td>
            <td>${f.flight_hours || '-'}h</td>
            <td>${formatDaysOfWeek(f.days_of_week)}</td>
            <td>
              ${f.is_active 
                ? '<span class="badge bg-success">í™œì„±</span>' 
                : '<span class="badge bg-secondary">ë¹„í™œì„±</span>'}
            </td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="editFlight(${f.id})">
                <i class="bi bi-pencil"></i>
              </button>
              ${f.is_active
                ? `<button class="btn btn-sm btn-outline-danger" onclick="deleteFlight(${f.id}, '${f.flight_number}')">
                     <i class="bi bi-trash"></i>
                   </button>`
                : `<button class="btn btn-sm btn-outline-success" onclick="activateFlight(${f.id}, '${f.flight_number}')">
                     <i class="bi bi-check-circle"></i> í™œì„±í™”
                   </button>`
              }
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('í•­ê³µí¸ ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('í•­ê³µí¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ìš´í•­ìš”ì¼ í¬ë§·
    function formatDaysOfWeek(days) {
      if (!days || days === '1,2,3,4,5,6,7') return 'ë§¤ì¼';
      const dayNames = ['', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
      return days.split(',').map(d => dayNames[d]).join(',');
    }

    // ì¶”ê°€ ëª¨ë‹¬ í‘œì‹œ
    function showAddModal() {
      editingId = null;
      document.getElementById('modalTitle').textContent = 'í•­ê³µí¸ ì¶”ê°€';
      document.getElementById('flightForm').reset();
      document.getElementById('flightId').value = '';
      document.getElementById('isActive').checked = true;
      
      // ëª¨ë“  ìš”ì¼ ì²´í¬
      for (let i = 1; i <= 7; i++) {
        document.getElementById(`day${i}`).checked = true;
      }
      
      modal.show();
    }

    // ìˆ˜ì • ëª¨ë‹¬
    async function editFlight(id) {
      try {
        const res = await fetch(`/pickup/api/flights/${id}`);
        const flight = await res.json();
        
        editingId = id;
        document.getElementById('modalTitle').textContent = 'í•­ê³µí¸ ìˆ˜ì •';
        document.getElementById('flightId').value = id;
        document.getElementById('flightNumber').value = flight.flight_number;
        document.getElementById('departureAirport').value = flight.departure_airport || '';
        document.getElementById('arrivalAirport').value = flight.arrival_airport || '';
        document.getElementById('departureTime').value = flight.departure_time?.substring(0,5) || '';
        document.getElementById('arrivalTime').value = flight.arrival_time?.substring(0,5) || '';
        document.getElementById('flightHours').value = flight.flight_hours || 4;
        document.getElementById('notes').value = flight.notes || '';
        document.getElementById('isActive').checked = flight.is_active;
        
        // ìš´í•­ìš”ì¼ ì²´í¬
        const days = flight.days_of_week?.split(',') || [];
        for (let i = 1; i <= 7; i++) {
          document.getElementById(`day${i}`).checked = days.includes(String(i));
        }
        
        modal.show();
      } catch (error) {
        console.error('í•­ê³µí¸ ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('í•­ê³µí¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ì €ì¥
    async function saveFlight() {
      const form = document.getElementById('flightForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      // ìš´í•­ìš”ì¼ ìˆ˜ì§‘
      const days = [];
      for (let i = 1; i <= 7; i++) {
        if (document.getElementById(`day${i}`).checked) {
          days.push(i);
        }
      }

      const flightNumber = document.getElementById('flightNumber').value.toUpperCase();
      const airline = flightNumber.match(/^[A-Z]+/)?.[0] || '';
      
      const data = {
        airline: airline,
        flight_number: flightNumber,
        departure_airport: document.getElementById('departureAirport').value.toUpperCase(),
        arrival_airport: document.getElementById('arrivalAirport').value.toUpperCase(),
        departure_time: document.getElementById('departureTime').value,
        arrival_time: document.getElementById('arrivalTime').value,
        flight_hours: parseFloat(document.getElementById('flightHours').value),
        days_of_week: days.length > 0 ? days.join(',') : '1,2,3,4,5,6,7',
        notes: document.getElementById('notes').value,
        is_active: document.getElementById('isActive').checked
      };

      try {
        const url = editingId 
          ? `/pickup/api/flights/${editingId}`
          : '/pickup/api/flights';
        
        const method = editingId ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'ì €ì¥ ì‹¤íŒ¨');
        }

        alert(editingId ? 'í•­ê³µí¸ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'í•­ê³µí¸ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
        modal.hide();
        loadFlights();
      } catch (error) {
        console.error('ì €ì¥ ì‹¤íŒ¨:', error);
        alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }

    // ì‚­ì œ
    async function deleteFlight(id, flightNumber) {
      if (!confirm(`${flightNumber} í•­ê³µí¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€» í•´ë‹¹ í•­ê³µí¸ì„ ì‚¬ìš©í•˜ëŠ” í”½ì—… ì˜ˆì•½ì´ ìˆìœ¼ë©´ ë¹„í™œì„±í™” ì²˜ë¦¬ë©ë‹ˆë‹¤.`)) return;

      try {
        const res = await fetch(`/pickup/api/flights/${id}`, {
          method: 'DELETE'
        });
        
        const result = await res.json();

        if (res.ok) {
          if (result.deactivated) {
            alert('âš ï¸ ' + result.message + '\n\në¹„í™œì„± ìƒíƒœë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
          } else {
            alert('âœ… ' + result.message);
          }
          loadFlights();
        } else {
          alert('âŒ ì‚­ì œ ì‹¤íŒ¨\n\n' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          if (result.hint) {
            alert('ğŸ’¡ ' + result.hint);
          }
        }
      } catch (error) {
        console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
        alert('âŒ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }
    
    // í™œì„±í™”
    async function activateFlight(id, flightNumber) {
      if (!confirm(`${flightNumber} í•­ê³µí¸ì„ ë‹¤ì‹œ í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      
      try {
        const res = await fetch(`/pickup/api/flights/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_active: true })
        });
        
        if (res.ok) {
          alert('âœ… í•­ê³µí¸ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadFlights();
        } else {
          const result = await res.json();
          alert('âŒ í™œì„±í™” ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (error) {
        console.error('í™œì„±í™” ì‹¤íŒ¨:', error);
        alert('âŒ í™œì„±í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }
  </script>
</body>
</html>
