<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì˜¤ëŠ˜ì˜ í”½ì—…</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f5f5f5; padding: 10px; }
    .flight-card { 
      background: white; 
      border: 3px solid #ddd; 
      border-radius: 10px; 
      padding: 20px; 
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .flight-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
    .passenger-item { 
      background: #f8f9fa; 
      padding: 15px; 
      margin: 10px 0; 
      border-radius: 8px;
      border-left: 5px solid #007bff;
    }
    .early-morning { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      color: white;
      border-color: #5a67d8;
    }
    .early-morning .passenger-item { 
      background: rgba(255,255,255,0.2); 
      color: white;
      border-left-color: #fbbf24;
    }
    .vehicle-select { font-size: 20px; padding: 12px; }
    .stats { font-size: 18px; padding: 15px; background: #e3f2fd; border-radius: 8px; }
    .date-nav { margin-bottom: 20px; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <h2 class="text-center mb-3">ğŸš— ê¸°ì‚¬ í™”ë©´</h2>
    
    <!-- ë‹¬ë ¥ ë·° (ìœ ì¼í•œ í™”ë©´) -->
    <div id="calendarView" class="mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <button class="btn btn-sm btn-secondary" onclick="changeMonth(-1)">â—€ ì´ì „ë‹¬</button>
        <h4 id="currentMonth"></h4>
        <button class="btn btn-sm btn-secondary" onclick="changeMonth(1)">ë‹¤ìŒë‹¬ â–¶</button>
      </div>
      <div id="calendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; font-size: 12px;"></div>
    </div>
  </div>
  
  <!-- ìƒì„¸ ë³´ê¸° ëª¨ë‹¬ -->
  <div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">í”½ì—… ìƒì„¸</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="detailBody">
          <!-- ë™ì  ë‚´ìš© -->
        </div>
        <div class="modal-footer">
          <select class="form-select w-auto me-auto" id="modalVehicle" onchange="updateVehicleFromModal()">
            <option value="">ì°¨ëŸ‰ ì„ íƒ</option>
            <option value="ì„¸ë‹¨">ì„¸ë‹¨</option>
            <option value="SUV">SUV</option>
            <option value="ë°´">ë°´</option>
            <option value="ë²„ìŠ¤">ë²„ìŠ¤</option>
          </select>
          <div class="form-check me-3">
            <input class="form-check-input" type="checkbox" id="modalReady" onchange="updateReadyFromModal()">
            <label class="form-check-label" for="modalReady">ì¤€ë¹„ì™„ë£Œ</label>
          </div>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
        </div>
      </div>
    </div>
  </div>
  
  <div style="display:none;">
    <div id="detailView" style="display:none;">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <button class="btn btn-secondary" onclick="backToCalendar()">â† ë‹¬ë ¥ìœ¼ë¡œ</button>
        <h4 id="detailDate" class="mb-0"></h4>
        <div>
          <button class="btn btn-sm btn-secondary" onclick="changeDetailDate(-1)">â† ì „ë‚ </button>
          <button class="btn btn-sm btn-secondary" onclick="changeDetailDate(1)">ë‹¤ìŒë‚  â†’</button>
        </div>
      </div>
      
      <!-- í†µê³„ -->
      <div class="stats text-center mb-3">
        <div>ğŸ“Š ì „ì²´: <strong id="totalCount">0ëª…</strong></div>
      </div>
      
      <!-- ê³µí•­ í”½ì—… -->
      <h3 class="text-primary">ğŸ›¬ ê³µí•­ í”½ì—…</h3>
      <div id="arrivalsList"></div>
      
      <!-- í˜¸í…” í”½ì—… -->
      <h3 class="text-danger mt-4">ğŸ¨ í˜¸í…” í”½ì—…</h3>
      <div id="departuresList"></div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let detailModalInstance;
    let currentPickupData = null;
    let currentCalendarYear = new Date().getFullYear();
    let currentCalendarMonth = new Date().getMonth() + 1;
    let allPickups = {}; // IDë³„ ì˜ˆì•½ ë°ì´í„° ì €ì¥
    
    // í˜ì´ì§€ ë¡œë“œ
    document.addEventListener('DOMContentLoaded', () => {
      detailModalInstance = new bootstrap.Modal(document.getElementById('detailModal'));
      loadCalendar(); // ë‹¬ë ¥ì„ ê¸°ë³¸ìœ¼ë¡œ
      
      // 3ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
      setInterval(loadCalendar, 3000);
    });
    
    // ë‹¬ë ¥ìœ¼ë¡œ ëŒì•„ê°€ê¸°
    function backToCalendar() {
      // ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
      }
      document.getElementById('detailView').style.display = 'none';
      document.getElementById('calendarView').style.display = 'block';
      loadCalendar();
    }
    
    // ë‚ ì§œ í´ë¦­ ì‹œ ìƒì„¸ ë³´ê¸°
    function viewDate(date) {
      currentDetailDate = date;
      document.getElementById('calendarView').style.display = 'none';
      document.getElementById('detailView').style.display = 'block';
      updateDetailDate();
      loadPickups();
      
      // 3ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘
      if (autoRefreshInterval) clearInterval(autoRefreshInterval);
      autoRefreshInterval = setInterval(loadPickups, 3000);
    }
    
    // ìƒì„¸ ë‚ ì§œ ë³€ê²½
    function changeDetailDate(days) {
      const date = new Date(currentDetailDate);
      date.setDate(date.getDate() + days);
      currentDetailDate = date.toISOString().split('T')[0];
      updateDetailDate();
      loadPickups();
    }
    
    // ìƒì„¸ ë‚ ì§œ í‘œì‹œ
    function updateDetailDate() {
      const date = new Date(currentDetailDate);
      const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      const dayName = days[date.getDay()];
      document.getElementById('detailDate').textContent = 
        `${currentDetailDate} (${dayName})`;
    }
    
    function changeMonth(delta) {
      currentCalendarMonth += delta;
      if (currentCalendarMonth > 12) {
        currentCalendarMonth = 1;
        currentCalendarYear++;
      } else if (currentCalendarMonth < 1) {
        currentCalendarMonth = 12;
        currentCalendarYear--;
      }
      loadCalendar();
    }
    
    async function loadCalendar() {
      const res = await fetch(`/pickup/api/calendar?year=${currentCalendarYear}&month=${currentCalendarMonth}`);
      const { arrivals, departures } = await res.json();
      
      console.log('ğŸ“… ë‹¬ë ¥ ë°ì´í„°:', { arrivals: arrivals.length, departures: departures.length });
      
      document.getElementById('currentMonth').textContent = `${currentCalendarYear}ë…„ ${currentCalendarMonth}ì›”`;
      
      // ì „ì—­ ì˜ˆì•½ ë°ì´í„° ì´ˆê¸°í™”
      allPickups = {};
      
      // ë‚ ì§œë³„ë¡œ ì˜ˆì•½ ê·¸ë£¹í™”
      const pickupsByDate = {};
      arrivals.forEach(p => {
        allPickups[p.id] = p; // ì „ì—­ ì €ì¥
        const date = p.guam_arrival_date;
        if (!pickupsByDate[date]) pickupsByDate[date] = { arrivals: [], departures: [] };
        pickupsByDate[date].arrivals.push(p);
      });
      departures.forEach(p => {
        allPickups[p.id] = p; // ì „ì—­ ì €ì¥
        const date = p.hotel_pickup_date;
        if (!pickupsByDate[date]) pickupsByDate[date] = { arrivals: [], departures: [] };
        pickupsByDate[date].departures.push(p);
      });
      
      const daysInMonth = new Date(currentCalendarYear, currentCalendarMonth, 0).getDate();
      const firstDay = new Date(currentCalendarYear, currentCalendarMonth - 1, 1).getDay();
      
      let html = '';
      ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].forEach(day => {
        html += `<div style="font-weight:bold;text-align:center;padding:5px;background:#f0f0f0;">${day}</div>`;
      });
      
      for (let i = 0; i < firstDay; i++) {
        html += '<div style="border:1px solid #ddd;padding:5px;"></div>';
      }
      
      const today = new Date().toISOString().split('T')[0];
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${currentCalendarYear}-${String(currentCalendarMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayPickups = pickupsByDate[dateStr] || { arrivals: [], departures: [] };
        const hasPickup = dayPickups.arrivals.length > 0 || dayPickups.departures.length > 0;
        const isToday = dateStr === today;
        
        const arrCount = dayPickups.arrivals.length;
        const depCount = dayPickups.departures.length;
        const arrPax = dayPickups.arrivals.reduce((sum, p) => sum + (p.passenger_count || 0), 0);
        const depPax = dayPickups.departures.reduce((sum, p) => sum + (p.passenger_count || 0), 0);
        
        const bgColor = isToday ? '#fff3cd' : (hasPickup ? '#fafafa' : '#fff');
        const border = isToday ? '2px solid #ff9800' : '1px solid #ddd';
        
        html += `<div style="border:${border};padding:5px;background:${bgColor};border-radius:5px;min-height:100px;max-height:100px;overflow-y:auto;">`;
        html += `<div style="font-size:14px;font-weight:bold;margin-bottom:3px;position:sticky;top:0;background:${bgColor};">${day}ì¼</div>`;
        
        if (hasPickup) {
          html += `<div style="background:#fff3cd;padding:2px;border-radius:2px;margin:2px 0;font-size:9px;font-weight:bold;">ğŸ“Š ${arrCount+depCount}ê±´ | ${arrPax+depPax}ëª…</div>`;
        }
        
        // ê³µí•­ í”½ì—…
        dayPickups.arrivals.forEach(p => {
          const time = p.guam_arrival_time || '';
          html += `<div style="background:#e3f2fd;padding:2px 3px;margin:2px 0;border-radius:2px;font-size:9px;cursor:pointer;border-left:2px solid #2196f3;color:#1565c0;" onclick="showPickupDetail(${p.id})">ğŸ›¬ ${time} ${p.customer_name} (${p.passenger_count}ëª…)</div>`;
        });
        
        // í˜¸í…” í”½ì—…
        dayPickups.departures.forEach(p => {
          const isEarly = p.is_early_morning;
          const bg = isEarly ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#fce4ec';
          const color = isEarly ? 'white' : '#c2185b';
          const time = p.hotel_pickup_time || '';
          html += `<div style="background:${bg};padding:2px 3px;margin:2px 0;border-radius:2px;font-size:9px;cursor:pointer;border-left:2px solid ${isEarly ? '#fbbf24' : '#e91e63'};color:${color};" onclick="showPickupDetail(${p.id})">${ isEarly ? 'ğŸŒ™' : 'ğŸ¨'} ${time} ${p.customer_name} (${p.passenger_count}ëª…)</div>`;
        });
        
        html += `</div>`;
      }
      
      document.getElementById('calendar').innerHTML = html;
    }
    
    // ì˜ˆì•½ ìƒì„¸ ë³´ê¸°
    function showPickupDetail(pickupId) {
      const pickup = allPickups[pickupId];
      if (!pickup) return;
      currentPickupData = pickup;
      const isArrival = pickup.guam_arrival_date;
      
      let html = `
        <div class="row">
          <div class="col-md-6">
            <h6>ğŸ‘¤ ê³ ê° ì •ë³´</h6>
            <p><strong>ì´ë¦„:</strong> ${pickup.customer_name}</p>
            <p><strong>ì—…ì²´:</strong> ${pickup.agency_name || '-'}</p>
            <p><strong>í˜¸í…”:</strong> ${pickup.hotel_name}</p>
            <p><strong>ì „í™”:</strong> ${pickup.phone || '-'}</p>
          </div>
          <div class="col-md-6">
            <h6>ğŸ‘¥ ì¸ì›</h6>
            <p><strong>ì„±ì¸:</strong> ${pickup.adult_count || 0}ëª…</p>
            <p><strong>ì†Œì•„:</strong> ${pickup.child_count || 0}ëª…</p>
            <p><strong>ìœ ì•„:</strong> ${pickup.infant_count || 0}ëª…</p>
            <p><strong>ì§:</strong> ${pickup.luggage_count || 0}ê°œ</p>
            <p><strong>ì´:</strong> ${pickup.passenger_count}ëª…</p>
          </div>
        </div>
      `;
      
      if (isArrival) {
        html += `<hr><h6>âœˆï¸ ê³µí•­ í”½ì—…</h6><p>í•œêµ­: ${pickup.kr_departure_date} ${pickup.kr_departure_time} (${pickup.kr_flight_number})</p><p>ê´Œ: ${pickup.guam_arrival_date} ${pickup.guam_arrival_time}</p>`;
      } else {
        html += `<hr><h6>ğŸ¨ í˜¸í…” í”½ì—…</h6><p>í”½ì—…: ${pickup.hotel_pickup_date} ${pickup.hotel_pickup_time}</p><p>ë¹„í–‰ê¸°: ${pickup.guam_departure_date} ${pickup.guam_departure_time} (${pickup.departure_flight_number})</p>`;
        if (pickup.is_early_morning) html += '<p class="text-danger"><strong>âš ï¸ ìƒˆë²½ ë¹„í–‰ê¸°</strong></p>';
      }
      if (pickup.memo) html += `<p><strong>ë©”ëª¨:</strong> ${pickup.memo}</p>`;
      
      document.getElementById('detailBody').innerHTML = html;
      document.getElementById('modalVehicle').value = pickup.vehicle_type || '';
      document.getElementById('modalReady').checked = pickup.vehicle_ready || false;
      detailModalInstance.show();
    }
    
    // ëª¨ë‹¬ì—ì„œ ì°¨ëŸ‰ ì—…ë°ì´íŠ¸
    async function updateVehicleFromModal() {
      if (!currentPickupData) return;
      const vehicle = document.getElementById('modalVehicle').value;
      await fetch(`/pickup/api/${currentPickupData.id}/vehicle`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ vehicle_type: vehicle })
      });
      currentPickupData.vehicle_type = vehicle;
    }
    
    // ëª¨ë‹¬ì—ì„œ ì¤€ë¹„ì™„ë£Œ ì—…ë°ì´íŠ¸
    async function updateReadyFromModal() {
      if (!currentPickupData) return;
      const ready = document.getElementById('modalReady').checked;
      await fetch(`/pickup/api/${currentPickupData.id}/vehicle`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ vehicle_ready: ready })
      });
      currentPickupData.vehicle_ready = ready;
    }
    
    async function loadPickups() {
      try {
        const res = await fetch(`/pickup/api/list?date=${currentDetailDate}`);
        const { arrivals, departures } = await res.json();
        
        // ì´ ì¸ì›ìˆ˜
        const totalArr = arrivals.reduce((sum, p) => sum + (p.passenger_count || 0), 0);
        const totalDep = departures.reduce((sum, p) => sum + (p.passenger_count || 0), 0);
        document.getElementById('totalCount').textContent = 
          `ê³µí•­í”½ì—… ${totalArr}ëª… | í˜¸í…”í”½ì—… ${totalDep}ëª…`;
        
        // ê³µí•­ í”½ì—…
        if (arrivals.length === 0) {
          document.getElementById('arrivalsList').innerHTML = 
            '<p class="text-muted text-center">ì˜ˆì•½ ì—†ìŒ</p>';
        } else {
          // ë¹„í–‰í¸ë³„ë¡œ ê·¸ë£¹í™”
          const grouped = {};
          arrivals.forEach(p => {
            const key = `${p.kr_flight_number}_${p.guam_arrival_time}`;
            if (!grouped[key]) grouped[key] = { flight: p, passengers: [] };
            grouped[key].passengers.push(p);
          });
          
          document.getElementById('arrivalsList').innerHTML = 
            Object.values(grouped).map(renderArrivalFlight).join('');
        }
        
        // í˜¸í…” í”½ì—…
        if (departures.length === 0) {
          document.getElementById('departuresList').innerHTML = 
            '<p class="text-muted text-center">ì˜ˆì•½ ì—†ìŒ</p>';
        } else {
          const grouped = {};
          departures.forEach(p => {
            const key = `${p.hotel_pickup_time}`;
            if (!grouped[key]) grouped[key] = { flight: p, passengers: [] };
            grouped[key].passengers.push(p);
          });
          
          document.getElementById('departuresList').innerHTML = 
            Object.values(grouped).map(renderDepartureFlight).join('');
        }
      } catch (error) {
        console.error('ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }
    
    // ê³µí•­ í”½ì—… ë Œë”ë§
    function renderArrivalFlight(group) {
      const p = group.flight;
      const passengers = group.passengers;
      const totalPax = passengers.reduce((sum, x) => sum + (x.passenger_count || 0), 0);
      
      return `
        <div class="flight-card">
          <div class="flight-title">
            âœˆï¸ ${p.kr_flight_number} ${p.guam_arrival_time} ë„ì°©
          </div>
          <div class="mb-2">
            <strong>ğŸ‘¥ ì´ ${totalPax}ëª… (${passengers.length}íŒ€)</strong>
          </div>
          <div class="mb-3">
            ğŸš— ì°¨ëŸ‰: 
            <select class="vehicle-select" onchange="updateVehicle(${p.id}, this.value)">
              <option value="">ì„ íƒ</option>
              <option value="sedan" ${p.vehicle_type === 'sedan' ? 'selected' : ''}>ì„¸ë‹¨ (1-4ëª…)</option>
              <option value="van" ${p.vehicle_type === 'van' ? 'selected' : ''}>ë°´ (5-8ëª…)</option>
              <option value="bus12" ${p.vehicle_type === 'bus12' ? 'selected' : ''}>12ì¸ìŠ¹ (9-12ëª…)</option>
            </select>
            <label class="ms-3">
              <input type="checkbox" ${p.vehicle_ready ? 'checked' : ''} 
                onchange="updateReady(${p.id}, this.checked)"> âœ… ì¤€ë¹„ì™„ë£Œ
            </label>
          </div>
          ${passengers.map(renderPassenger).join('')}
          <small class="text-muted">í•œêµ­ ${p.kr_departure_date} ${p.kr_departure_time} ì¶œë°œ</small>
        </div>
      `;
    }
    
    // í˜¸í…” í”½ì—… ë Œë”ë§
    function renderDepartureFlight(group) {
      const p = group.flight;
      const passengers = group.passengers;
      const totalPax = passengers.reduce((sum, x) => sum + (x.passenger_count || 0), 0);
      const isEarly = p.is_early_morning;
      
      return `
        <div class="flight-card ${isEarly ? 'early-morning' : ''}">
          <div class="flight-title">
            â° ${p.hotel_pickup_time} í”½ì—… ${isEarly ? 'ğŸŒ™' : ''}
          </div>
          ${isEarly ? '<div class="mb-2">âš ï¸ ìƒˆë²½ ë¹„í–‰ê¸° - ì „ë‚  ë°¤ í”½ì—…</div>' : ''}
          <div class="mb-2">
            <strong>ğŸ‘¥ ì´ ${totalPax}ëª… (${passengers.length}íŒ€)</strong>
          </div>
          <div class="mb-3">
            ğŸš— ì°¨ëŸ‰: 
            <select class="vehicle-select" onchange="updateVehicle(${p.id}, this.value)">
              <option value="">ì„ íƒ</option>
              <option value="sedan" ${p.vehicle_type === 'sedan' ? 'selected' : ''}>ì„¸ë‹¨</option>
              <option value="van" ${p.vehicle_type === 'van' ? 'selected' : ''}>ë°´</option>
              <option value="bus12" ${p.vehicle_type === 'bus12' ? 'selected' : ''}>12ì¸ìŠ¹</option>
            </select>
            <label class="ms-3">
              <input type="checkbox" ${p.vehicle_ready ? 'checked' : ''} 
                onchange="updateReady(${p.id}, this.checked)"> âœ… ì¤€ë¹„ì™„ë£Œ
            </label>
          </div>
          ${passengers.map(renderPassenger).join('')}
          <small ${isEarly ? '' : 'class="text-muted"'}>
            ë¹„í–‰ê¸°: ${p.guam_departure_date} ${p.guam_departure_time} ì¶œë°œ
          </small>
        </div>
      `;
    }
    
    // ìŠ¹ê° ë Œë”ë§
    function renderPassenger(p) {
      return `
        <div class="passenger-item">
          <strong>${p.customer_name} ${p.passenger_count}ëª…</strong>
          â†’ ${p.hotel_name}
          ${p.memo ? `<br>ğŸ“ ${p.memo}` : ''}
          ${p.phone ? `<br>ğŸ“ ${p.phone}` : ''}
        </div>
      `;
    }
    
    // ì°¨ëŸ‰ ì—…ë°ì´íŠ¸
    async function updateVehicle(id, vehicle_type) {
      await fetch(`/pickup/api/${id}/vehicle`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ vehicle_type, vehicle_ready: false })
      });
      loadPickups();
    }
    
    // ì¤€ë¹„ì™„ë£Œ ì—…ë°ì´íŠ¸
    async function updateReady(id, vehicle_ready) {
      const card = event.target.closest('.flight-card');
      const select = card.querySelector('.vehicle-select');
      const vehicle_type = select.value;
      
      await fetch(`/pickup/api/${id}/vehicle`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ vehicle_type, vehicle_ready })
      });
      loadPickups();
    }
  </script>
</body>
</html>
