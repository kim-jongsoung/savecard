<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HKT Pickup Schedule</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }
    
    .header .date-display {
      font-size: 24px;
      font-weight: bold;
      margin: 15px 0;
    }
    
    .nav-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    
    .nav-buttons button {
      background: rgba(255,255,255,0.2);
      border: 2px solid white;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .nav-buttons button:hover {
      background: rgba(255,255,255,0.3);
      transform: scale(1.05);
    }
    
    .info-bar {
      background: #f8f9fa;
      padding: 10px;
      border-bottom: 2px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .summary {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .summary-item {
      background: white;
      padding: 5px 10px;
      border-radius: 5px;
      border: 2px solid #e0e0e0;
      font-size: 12px;
    }
    
    .summary-item strong {
      color: #667eea;
      font-size: 16px;
    }
    
    .last-updated {
      color: #666;
      font-size: 11px;
      font-style: italic;
    }
    
    .table-container {
      overflow-x: auto;
      padding: 10px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    thead {
      background: #6B8E23;
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    th {
      padding: 12px 8px;
      text-align: left;
      font-weight: bold;
      border-right: 1px solid rgba(255,255,255,0.2);
      white-space: nowrap;
    }
    
    th:last-child {
      border-right: none;
    }
    
    td {
      padding: 12px 8px;
      border-bottom: 1px solid #e0e0e0;
      vertical-align: middle;
    }
    
    tbody tr:hover {
      background: #f8f9fa;
      cursor: pointer;
    }
    
    /* ì™¸ë¶€ ë°ì´í„° í–‰ ë°°ê²½ (ì—°í•œ íšŒìƒ‰) */
    tbody tr.external-data-row {
      background: #f5f5f5;
    }
    
    tbody tr.external-data-row:hover {
      background: #ececec;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .status-contacted {
      background: #d4edda;
      color: #155724;
    }
    
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .time-col {
      font-weight: bold;
      font-size: 16px;
      color: #667eea;
    }
    
    .source-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: bold;
      margin-left: 5px;
    }
    
    .source-system {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .source-manual {
      background: #fff3e0;
      color: #f57c00;
    }
    
    .source-excel {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .empty-state h2 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    
    .footer {
      background: #f8f9fa;
      padding: 20px;
      text-align: center;
      color: #666;
      border-top: 2px solid #e0e0e0;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      font-size: 18px;
      color: #667eea;
    }
    
    @media print {
      .nav-buttons, .footer {
        display: none;
      }
      
      body {
        padding: 0;
      }
      
      .container {
        box-shadow: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸš— HKT Pickup Schedule</h1>
      <div class="date-display" id="dateDisplay">Loading...</div>
      <div class="nav-buttons">
        <button onclick="changeDate(-1)">â—€ Prev Day</button>
        <button onclick="goToday()">ğŸ“… Today</button>
        <button onclick="changeDate(1)">Next Day â–¶</button>
      </div>
      <div class="nav-buttons" style="margin-top: 10px;">
        <button onclick="load3Days()" style="background: #FF9800; border-color: #FF9800;">ğŸ“… 3 Days (ì–´ì œ-ì˜¤ëŠ˜-ë‚´ì¼)</button>
      </div>
    </div>
    
    <div class="info-bar">
      <div class="summary" id="summary">
        <div class="summary-item">Total Pickups: <strong id="totalCount">0</strong></div>
        <div class="summary-item">âœ… Contacted: <strong id="contactedCount">0</strong></div>
        <div class="summary-item">â³ Pending: <strong id="pendingCount">0</strong></div>
        <div class="summary-item">ğŸ‘¥ Total Passengers: <strong id="passengerCount">0</strong></div>
      </div>
      <div class="last-updated" id="lastUpdated">Last updated: ...</div>
    </div>
    
    <div id="loadingIndicator" class="loading">
      Loading schedule...
    </div>
    
    <div class="table-container" id="tableContainer" style="display: none;">
      <table>
        <thead>
          <tr>
            <th>DATE</th>
            <th>STATUS</th>
            <th>TIME</th>
            <th>Pickup Loc</th>
            <th>PERSON</th>
            <th>DER</th>
            <th>VEHICLE</th>
            <th>NUM</th>
            <th>NAME</th>
            <th>ENG NAME</th>
            <th>CONTACT</th>
            <th>FLIGHT</th>
            <th>AGENCY</th>
            <th>PAY</th>
            <th>REQUEST</th>
            <th>REMARK</th>
          </tr>
        </thead>
        <tbody id="scheduleBody">
        </tbody>
      </table>
    </div>
    
    <div id="emptyState" class="empty-state" style="display: none;">
      <h2>ğŸ“­ No pickups scheduled</h2>
      <p>Check another date using the navigation buttons above</p>
    </div>
    
    <div class="footer">
      <p>ğŸ”— Bookmark this page for quick access</p>
      <p>Auto-refresh: Every 30 seconds</p>
    </div>
  </div>

  <script>
    let currentDate = '<%= initialDate %>';
    let autoRefreshInterval;
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
      if (currentDate === 'today') {
        currentDate = getTodayDate();
      }
      loadSchedule(currentDate);
      startAutoRefresh();
    });
    
    // ì˜¤ëŠ˜ ë‚ ì§œ êµ¬í•˜ê¸°
    function getTodayDate() {
      const today = new Date();
      return today.toISOString().split('T')[0];
    }
    
    // ë‚ ì§œ ë³€ê²½
    function changeDate(days) {
      const date = new Date(currentDate);
      date.setDate(date.getDate() + days);
      currentDate = date.toISOString().split('T')[0];
      loadSchedule(currentDate);
      
      // URL ì—…ë°ì´íŠ¸ (íˆìŠ¤í† ë¦¬)
      window.history.pushState({}, '', `/pickup/schedule/public/${currentDate}`);
    }
    
    // ì˜¤ëŠ˜ë¡œ ì´ë™
    function goToday() {
      currentDate = getTodayDate();
      loadSchedule(currentDate);
      window.history.pushState({}, '', `/pickup/schedule/public/today`);
    }
    
    // ìŠ¤ì¼€ì¤„ ë¡œë“œ
    async function loadSchedule(date) {
      try {
        document.getElementById('loadingIndicator').style.display = 'block';
        document.getElementById('tableContainer').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
        
        const response = await fetch(`/pickup/api/schedule/${date}`);
        const data = await response.json();
        
        // ë‚ ì§œ í‘œì‹œ ì—…ë°ì´íŠ¸
        updateDateDisplay(date);
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        updateSummary(data.summary);
        
        // í…Œì´ë¸” ì—…ë°ì´íŠ¸
        if (data.pickups && data.pickups.length > 0) {
          renderScheduleTable(data.pickups);
          document.getElementById('tableContainer').style.display = 'block';
        } else {
          document.getElementById('emptyState').style.display = 'block';
        }
        
        document.getElementById('loadingIndicator').style.display = 'none';
        
        // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
        updateLastUpdatedTime();
        
      } catch (error) {
        console.error('ìŠ¤ì¼€ì¤„ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('loadingIndicator').innerHTML = 
          '<p style="color: red;">âŒ Failed to load schedule. Please try again.</p>';
      }
    }
    
    // ë‚ ì§œ í‘œì‹œ ì—…ë°ì´íŠ¸
    function updateDateDisplay(dateStr) {
      const date = new Date(dateStr);
      const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const dayName = days[date.getDay()];
      document.getElementById('dateDisplay').textContent = 
        `${dateStr} (${dayName})`;
    }
    
    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateSummary(summary) {
      document.getElementById('totalCount').textContent = summary.total || 0;
      document.getElementById('contactedCount').textContent = summary.contacted || 0;
      document.getElementById('pendingCount').textContent = summary.pending || 0;
      document.getElementById('passengerCount').textContent = summary.total_passengers || 0;
    }
    
    // í…Œì´ë¸” ë Œë”ë§
    function renderScheduleTable(pickups) {
      const tbody = document.getElementById('scheduleBody');
      tbody.innerHTML = '';
      
      // ì™¸ë¶€ ë°ì´í„°ì™€ ì‹œìŠ¤í…œ ë°ì´í„° ë¶„ë¦¬
      const externalData = pickups.filter(p => 
        p.pickup_source === 'manual' || p.pickup_source === 'excel_import'
      );
      const systemData = pickups.filter(p => 
        p.pickup_source !== 'manual' && p.pickup_source !== 'excel_import'
      );
      
      // ì‹œê°„ ë¹„êµ í•¨ìˆ˜
      const getTimeValue = (pickup) => {
        const time = pickup.actual_pickup_time || pickup.display_time || '';
        if (!time) return 9999; // ì‹œê°„ ì—†ìœ¼ë©´ ë§¨ ë’¤ë¡œ
        const [hours, minutes] = time.split(':').map(Number);
        return hours * 60 + minutes; // ë¶„ ë‹¨ìœ„ë¡œ ë³€í™˜
      };
      
      // ê° ê·¸ë£¹ ë‚´ì—ì„œ ì‹œê°„ìˆœ ì •ë ¬ (ë¹ ë¥¸ ì‹œê°„ì´ ìœ„ë¡œ)
      externalData.sort((a, b) => getTimeValue(a) - getTimeValue(b));
      systemData.sort((a, b) => getTimeValue(a) - getTimeValue(b));
      
      // ì™¸ë¶€ ë°ì´í„° ë¨¼ì €, ì‹œìŠ¤í…œ ë°ì´í„°ëŠ” ë‚˜ì¤‘ì—
      const sortedPickups = [...externalData, ...systemData];
      
      console.log(`ğŸ“Š ë°ì´í„° ì •ë ¬: ì™¸ë¶€ ${externalData.length}ê±´, ì‹œìŠ¤í…œ ${systemData.length}ê±´ (ê° ê·¸ë£¹ ë‚´ ì‹œê°„ìˆœ)`);
      
      sortedPickups.forEach(pickup => {
        const isExternalData = pickup.pickup_source === 'manual' || pickup.pickup_source === 'excel_import';
        const row = document.createElement('tr');
        
        // ì™¸ë¶€ ë°ì´í„° êµ¬ë¶„ í´ë˜ìŠ¤ ì¶”ê°€
        if (isExternalData) {
          row.classList.add('external-data-row');
        }
        
        // STATUS
        const statusClass = pickup.contact_status === 'CONTACTED' ? 'status-contacted' : 'status-pending';
        const statusText = pickup.contact_status === 'CONTACTED' ? 'CONTACTED' : 'PENDING';
        
        // SOURCE BADGE: ì™¸ë¶€ ë°ì´í„°(ìˆ˜ë™/ì—‘ì…€)ì™€ ì‹œìŠ¤í…œ ë°ì´í„° êµ¬ë¶„
        let sourceClass, sourceText;
        if (pickup.pickup_source === 'manual') {
          sourceClass = 'source-manual';
          sourceText = 'âœï¸ Manual Input';
        } else if (pickup.pickup_source === 'excel_import') {
          sourceClass = 'source-excel';
          sourceText = 'ğŸ“Š Excel Import';
        } else {
          sourceClass = 'source-system';
          sourceText = 'ğŸ¤– System Data';
        }
        
        // TIME
        const timeDisplay = pickup.actual_pickup_time || pickup.display_time || '';
        
        // ë ŒíŠ¸ì¹´ ì •ë³´
        const rentalNumber = pickup.rental_number || '-';
        const rentalDuration = pickup.rental_duration || '-';
        
        // VEHICLE ì»¬ëŸ¼: ìˆ˜ë™ ì…ë ¥ê°’ ìš°ì„ , ì—†ìœ¼ë©´ ìë™ ìƒì„±ëœ ë£¨íŒ… ì •ë³´
        let vehicleWithRoute = '-';
        
        // 1ìˆœìœ„: ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•œ rental_vehicle ê°’
        if (pickup.rental_vehicle && pickup.rental_vehicle.trim() !== '') {
          vehicleWithRoute = pickup.rental_vehicle;
        }
        // 2ìˆœìœ„: ìë™ ìƒì„±ëœ ë£¨íŒ… ì •ë³´
        else if (pickup.hotel_name) {
          if (pickup.record_type === 'departure') {
            vehicleWithRoute = `(${pickup.hotel_name} â†’ AIRPORT)`;
          } else if (pickup.record_type === 'arrival') {
            vehicleWithRoute = `(AIRPORT â†’ ${pickup.hotel_name})`;
          }
        }
        
        // FLIGHT ì»¬ëŸ¼: í•­ê³µí¸ ë²ˆí˜¸ë§Œ
        const flightNumber = pickup.flight_number || '-';
        
        // AGENCY: ì—…ì²´ëª… í‘œì‹œ
        const agencyDisplay = pickup.agency_name || '-';
        
        // PAY: payment_status
        const payDisplay = pickup.payment_status || '-';
        
        // REQUEST: special_request
        const requestDisplay = pickup.special_request || '-';
        
        // PERSON ì»¬ëŸ¼: ì„±ì¸+ì†Œì•„+ìœ ì•„ í˜•ì‹ (ì˜ˆ: 2+1+3)
        const adultCount = pickup.adult_count || 0;
        const childCount = pickup.child_count || 0;
        const infantCount = pickup.infant_count || 0;
        const personDisplay = `${adultCount}+${childCount}+${infantCount}`;
        
        // Pickup Loc ì»¬ëŸ¼: ìš´ì „ìˆ˜ í”½ì—… ì¥ì†Œ
        let pickupLocation = '-';
        if (pickup.record_type === 'arrival') {
          // ê´Œ ë„ì°© â†’ ê³µí•­ì—ì„œ í”½ì—…
          pickupLocation = 'AIRPORT';
        } else if (pickup.record_type === 'departure') {
          // ê´Œ ì¶œë°œ â†’ í˜¸í…”ì—ì„œ í”½ì—…
          pickupLocation = pickup.hotel_name || '-';
        } else {
          // ìˆ˜ë™ ì…ë ¥ â†’ í˜¸í…” ì´ë¦„
          pickupLocation = pickup.hotel_name || '-';
        }
        
        // ë‚ ì§œ í‘œì‹œ (MM/DD í˜•ì‹) - pickupì˜ display_date ì‚¬ìš©
        const pickupDate = pickup.display_date || currentDate;
        const dateObj = new Date(pickupDate);
        const dateDisplay = `${String(dateObj.getMonth() + 1).padStart(2, '0')}/${String(dateObj.getDate()).padStart(2, '0')}`;
        
        row.innerHTML = `
          <td>${dateDisplay}</td>
          <td><span class="status-badge ${statusClass}">${statusText}</span></td>
          <td class="time-col">${timeDisplay.substring(0, 5)}</td>
          <td>${pickupLocation}</td>
          <td>${personDisplay}</td>
          <td>${rentalDuration}</td>
          <td>${vehicleWithRoute}</td>
          <td>${rentalNumber}</td>
          <td>${pickup.customer_name || '-'}</td>
          <td>${pickup.english_name || '-'}</td>
          <td>${pickup.phone ? maskPhone(pickup.phone) : '-'}</td>
          <td>${flightNumber}</td>
          <td>${agencyDisplay}</td>
          <td>${payDisplay}</td>
          <td>${requestDisplay}</td>
          <td>${pickup.remark || ''}</td>
        `;
        
        tbody.appendChild(row);
      });
    }
    
    // ì „í™”ë²ˆí˜¸ ë§ˆìŠ¤í‚¹ (ë³´ì•ˆ)
    function maskPhone(phone) {
      if (!phone) return '-';
      if (phone.length > 4) {
        return phone.substring(0, phone.length - 4) + '****';
      }
      return phone;
    }
    
    // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
    function updateLastUpdatedTime() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('en-US');
      document.getElementById('lastUpdated').textContent = `Last updated: ${timeStr}`;
    }
    
    // 3ì¼ ë³´ê¸° (ì–´ì œ-ì˜¤ëŠ˜-ë‚´ì¼) - currentDate ê¸°ì¤€
    async function load3Days() {
      try {
        document.getElementById('loadingIndicator').style.display = 'block';
        document.getElementById('tableContainer').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
        
        const baseDate = new Date(currentDate);
        const dates = [];
        
        // ì–´ì œ, ì˜¤ëŠ˜, ë‚´ì¼ (currentDate ê¸°ì¤€ -1, 0, +1)
        for (let i = -1; i <= 1; i++) {
          const date = new Date(baseDate);
          date.setDate(date.getDate() + i);
          dates.push(date.toISOString().split('T')[0]);
        }
        
        // ëª¨ë“  ë‚ ì§œ ë°ì´í„° ë¡œë“œ
        const allData = await Promise.all(
          dates.map(date => fetch(`/pickup/api/schedule/${date}`).then(r => r.json()))
        );
        
        // ë‚ ì§œ í‘œì‹œ ì—…ë°ì´íŠ¸ (ì–´ì œ + ì˜¤ëŠ˜ + ë‚´ì¼)
        const yesterday = dates[0];
        const today = dates[1];
        const tomorrow = dates[2];
        
        document.getElementById('dateDisplay').textContent = 
          `ì–´ì œ (${yesterday}) + ì˜¤ëŠ˜ (${today}) + ë‚´ì¼ (${tomorrow})`;
        
        // ì „ì²´ í†µê³„ ê³„ì‚°
        const totalSummary = {
          total: allData.reduce((sum, d) => sum + (d.summary?.total || 0), 0),
          contacted: allData.reduce((sum, d) => sum + (d.summary?.contacted || 0), 0),
          pending: allData.reduce((sum, d) => sum + (d.summary?.pending || 0), 0),
          total_passengers: allData.reduce((sum, d) => sum + (d.summary?.total_passengers || 0), 0)
        };
        updateSummary(totalSummary);
        
        // ëª¨ë“  í”½ì—… í•©ì¹˜ê¸° (ë‚ ì§œìˆœ ì •ë ¬)
        const allPickups = [];
        allData.forEach((data, index) => {
          if (data.pickups && data.pickups.length > 0) {
            allPickups.push(...data.pickups);
          }
        });
        
        // ë‚ ì§œìˆœ ì •ë ¬ (ë‚ ì§œ -> ì‹œê°„ ìˆœ)
        allPickups.sort((a, b) => {
          const dateCompare = (a.display_date || '').localeCompare(b.display_date || '');
          if (dateCompare !== 0) return dateCompare;
          
          const timeA = a.actual_pickup_time || a.display_time || '';
          const timeB = b.actual_pickup_time || b.display_time || '';
          return timeA.localeCompare(timeB);
        });
        
        // í…Œì´ë¸” ë Œë”ë§
        if (allPickups.length > 0) {
          renderScheduleTable(allPickups);
          document.getElementById('tableContainer').style.display = 'block';
        } else {
          document.getElementById('emptyState').style.display = 'block';
        }
        
        document.getElementById('loadingIndicator').style.display = 'none';
        updateLastUpdatedTime();
        
      } catch (error) {
        console.error('ìŠ¤ì¼€ì¤„ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('loadingIndicator').innerHTML = 
          '<p style="color: red;">âŒ Failed to load schedule. Please try again.</p>';
      }
    }
    
    // ìë™ ìƒˆë¡œê³ ì¹¨ (30ì´ˆë§ˆë‹¤)
    function startAutoRefresh() {
      autoRefreshInterval = setInterval(() => {
        loadSchedule(currentDate);
      }, 30000); // 30ì´ˆ
    }
    
    // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì¸í„°ë²Œ ì •ë¦¬
    window.addEventListener('beforeunload', () => {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
    });
  </script>
</body>
</html>
