<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì—…ì²´ ê´€ë¦¬</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2>ğŸ¢ í”½ì—… ì—…ì²´ ê´€ë¦¬</h2>
        <p class="text-muted mb-0">ê° ì—…ì²´ëŠ” ê³ ìœ  ì½”ë“œë¡œ ì§ì ‘ ì˜ˆì•½ì„ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
      </div>
      <div>
        <button class="btn btn-secondary me-2" onclick="location.href='/pickup'">
          <i class="bi bi-arrow-left"></i> í”½ì—… ê´€ë¦¬ë¡œ
        </button>
        <button class="btn btn-warning me-2" onclick="showPendingModal()">
          <i class="bi bi-exclamation-circle"></i> ì‹ ê·œì˜ˆì•½ <span class="badge bg-danger" id="pendingCount">0</span>
        </button>
        <button class="btn btn-primary" onclick="showAddModal()">+ ì—…ì²´ ì¶”ê°€</button>
      </div>
    </div>
    
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>ì—…ì²´ëª…</th>
            <th>ì—…ì²´ ì½”ë“œ</th>
            <th>ë‹´ë‹¹ì</th>
            <th>ì—°ë½ì²˜</th>
            <th>ì´ë©”ì¼</th>
            <th>ìƒíƒœ</th>
            <th>ë“±ë¡ì¼</th>
            <th>ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody id="agenciesList"></tbody>
      </table>
    </div>
  </div>
  
  <!-- ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
  <div class="modal fade" id="agencyModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">ì—…ì²´ ì¶”ê°€</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="agencyForm">
            <input type="hidden" id="agencyId">
            <div class="mb-3">
              <label class="form-label">ì—…ì²´ëª… *</label>
              <input type="text" class="form-control" id="agencyName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">ë‹´ë‹¹ì</label>
              <input type="text" class="form-control" id="contactPerson">
            </div>
            <div class="mb-3">
              <label class="form-label">ì—°ë½ì²˜</label>
              <input type="text" class="form-control" id="phone">
            </div>
            <div class="mb-3">
              <label class="form-label">ì´ë©”ì¼</label>
              <input type="email" class="form-control" id="email">
            </div>
            <div class="mb-3">
              <label class="form-check-label">
                <input type="checkbox" class="form-check-input" id="isActive" checked>
                í™œì„± ìƒíƒœ
              </label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" onclick="saveAgency()">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ì‹ ê·œì˜ˆì•½ ê´€ë¦¬ ëª¨ë‹¬ -->
  <div class="modal fade" id="pendingModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-exclamation-circle text-warning"></i> ì‹ ê·œì˜ˆì•½ í™•ì • ê´€ë¦¬
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
          <ul class="nav nav-tabs mb-3" id="pendingTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pendingList" type="button">
                <i class="bi bi-clock-history"></i> ê²€ìˆ˜ ëŒ€ê¸° <span class="badge bg-warning text-dark" id="pendingTabCount">0</span>
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejectedList" type="button">
                <i class="bi bi-x-circle"></i> ë¯¸í™•ì • <span class="badge bg-danger" id="rejectedTabCount">0</span>
              </button>
            </li>
          </ul>

          <!-- íƒ­ ë‚´ìš© -->
          <div class="tab-content" id="pendingTabContent">
            <!-- ê²€ìˆ˜ ëŒ€ê¸° ë¦¬ìŠ¤íŠ¸ -->
            <div class="tab-pane fade show active" id="pendingList" role="tabpanel">
              <div id="pendingReservations">
                <div class="text-center text-muted py-5">
                  <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                  <p class="mt-2">ê²€ìˆ˜ ëŒ€ê¸° ì¤‘ì¸ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
              </div>
            </div>

            <!-- ë¯¸í™•ì • ë¦¬ìŠ¤íŠ¸ -->
            <div class="tab-pane fade" id="rejectedList" role="tabpanel">
              <div id="rejectedReservations">
                <div class="text-center text-muted py-5">
                  <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                  <p class="mt-2">ë¯¸í™•ì • ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ì˜ˆì•½ ìˆ˜ì • ëª¨ë‹¬ -->
  <div class="modal fade" id="editReservationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ì˜ˆì•½ ìˆ˜ì •</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editReservationForm">
            <input type="hidden" id="editPickupId">
            
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">ê³ ê°ëª…</label>
                <input type="text" class="form-control" id="editCustomerName">
              </div>
              <div class="col-md-6">
                <label class="form-label">í˜¸í…”</label>
                <input type="text" class="form-control" id="editHotelName">
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">ì—°ë½ì²˜</label>
                <input type="text" class="form-control" id="editPhone">
              </div>
              <div class="col-md-6">
                <label class="form-label">ì¹´í†¡ID</label>
                <input type="text" class="form-control" id="editKakaoId">
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-3">
                <label class="form-label">ì„±ì¸</label>
                <input type="number" class="form-control" id="editAdultCount" min="0">
              </div>
              <div class="col-md-3">
                <label class="form-label">ì†Œì•„</label>
                <input type="number" class="form-control" id="editChildCount" min="0">
              </div>
              <div class="col-md-3">
                <label class="form-label">ìœ ì•„</label>
                <input type="number" class="form-control" id="editInfantCount" min="0">
              </div>
              <div class="col-md-3">
                <label class="form-label">ì§</label>
                <input type="number" class="form-control" id="editLuggageCount" min="0">
              </div>
            </div>
            
            <div class="mb-3">
              <label class="form-label">ë©”ëª¨</label>
              <textarea class="form-control" id="editMemo" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" onclick="saveReservationEdit()">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let modalInstance;
    let pendingModalInstance;
    let editReservationModalInstance;
    
    document.addEventListener('DOMContentLoaded', () => {
      modalInstance = new bootstrap.Modal(document.getElementById('agencyModal'));
      pendingModalInstance = new bootstrap.Modal(document.getElementById('pendingModal'));
      editReservationModalInstance = new bootstrap.Modal(document.getElementById('editReservationModal'));
      loadAgencies();
      loadPendingCount();
      
      // 5ì´ˆë§ˆë‹¤ ì‹ ê·œì˜ˆì•½ ì¹´ìš´íŠ¸ ê°±ì‹ 
      setInterval(loadPendingCount, 5000);
    });
    
    async function loadAgencies() {
      const res = await fetch('/pickup/api/agencies/all');
      const agencies = await res.json();
      
      document.getElementById('agenciesList').innerHTML = agencies.map(a => `
        <tr class="${!a.is_active ? 'table-secondary' : ''}">
          <td>
            <strong>${a.agency_name}</strong>
            ${!a.is_active ? '<small class="text-muted"> (ì‚¬ìš©ì¤‘ì¸ í”½ì—…ê±´ ìˆìŒ)</small>' : ''}
          </td>
          <td>
            ${a.agency_code ? `
              <div class="d-flex align-items-center gap-2">
                <code class="bg-light px-2 py-1 rounded" style="font-size: 1.1rem; font-weight: bold;">${a.agency_code}</code>
                <button class="btn btn-sm btn-outline-primary" onclick="copyCode('${a.agency_code}')" title="ì½”ë“œ ë³µì‚¬">
                  <i class="bi bi-clipboard"></i>
                </button>
                <a href="/pickup/agency/${a.agency_code}" target="_blank" class="btn btn-sm btn-outline-success" title="ì˜ˆì•½ í˜ì´ì§€ ì—´ê¸°">
                  <i class="bi bi-box-arrow-up-right"></i>
                </a>
              </div>
            ` : '<small class="text-muted">ì½”ë“œ ì—†ìŒ</small>'}
          </td>
          <td>${a.contact_person || '-'}</td>
          <td>${a.phone || '-'}</td>
          <td>${a.email || '-'}</td>
          <td>
            <span class="badge ${a.is_active ? 'bg-success' : 'bg-secondary'}">
              ${a.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}
            </span>
          </td>
          <td>${new Date(a.created_at).toLocaleDateString()}</td>
          <td>
            <button class="btn btn-sm btn-warning" onclick='editAgency(${JSON.stringify(a)})'>ìˆ˜ì •</button>
            ${a.is_active 
              ? `<button class="btn btn-sm btn-danger" onclick="deleteAgency(${a.id})">ì‚­ì œ</button>`
              : `<button class="btn btn-sm btn-success" onclick="activateAgency(${a.id})">í™œì„±í™”</button>`
            }
          </td>
        </tr>
      `).join('');
    }
    
    function showAddModal() {
      document.getElementById('modalTitle').textContent = 'ì—…ì²´ ì¶”ê°€';
      document.getElementById('agencyForm').reset();
      document.getElementById('agencyId').value = '';
      document.getElementById('isActive').checked = true;
      modalInstance.show();
    }
    
    function editAgency(agency) {
      document.getElementById('modalTitle').textContent = 'ì—…ì²´ ìˆ˜ì •';
      document.getElementById('agencyId').value = agency.id;
      document.getElementById('agencyName').value = agency.agency_name;
      document.getElementById('contactPerson').value = agency.contact_person || '';
      document.getElementById('phone').value = agency.phone || '';
      document.getElementById('email').value = agency.email || '';
      document.getElementById('isActive').checked = agency.is_active;
      modalInstance.show();
    }
    
    async function saveAgency() {
      const id = document.getElementById('agencyId').value;
      const data = {
        agency_name: document.getElementById('agencyName').value,
        contact_person: document.getElementById('contactPerson').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        is_active: document.getElementById('isActive').checked
      };
      
      const url = id ? `/pickup/api/agencies/${id}` : '/pickup/api/agencies';
      const method = id ? 'PUT' : 'POST';
      
      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      if (res.ok) {
        alert('âœ… ì €ì¥ ì™„ë£Œ!');
        modalInstance.hide();
        loadAgencies();
      } else {
        alert('âŒ ì˜¤ë¥˜ ë°œìƒ');
      }
    }
    
    async function deleteAgency(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€» í•´ë‹¹ ì—…ì²´ë¥¼ ì‚¬ìš©í•˜ëŠ” í”½ì—… ì˜ˆì•½ì´ ìˆìœ¼ë©´ ë¹„í™œì„±í™” ì²˜ë¦¬ë©ë‹ˆë‹¤.')) return;
      
      try {
        const res = await fetch(`/pickup/api/agencies/${id}`, { method: 'DELETE' });
        const result = await res.json();
        
        if (res.ok) {
          if (result.deactivated) {
            alert('âš ï¸ ' + result.message + '\n\në¹„í™œì„± ìƒíƒœë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
          } else {
            alert('âœ… ' + result.message);
          }
          loadAgencies();
        } else {
          alert('âŒ ì‚­ì œ ì‹¤íŒ¨\n\n' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          if (result.hint) {
            alert('ğŸ’¡ ' + result.hint);
          }
        }
      } catch (error) {
        console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
      }
    }
    
    async function activateAgency(id) {
      if (!confirm('ì´ ì—…ì²´ë¥¼ ë‹¤ì‹œ í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      try {
        const res = await fetch(`/pickup/api/agencies/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_active: true })
        });
        
        if (res.ok) {
          alert('âœ… ì—…ì²´ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadAgencies();
        } else {
          alert('âŒ í™œì„±í™” ì‹¤íŒ¨');
        }
      } catch (error) {
        console.error('í™œì„±í™” ì˜¤ë¥˜:', error);
        alert('âŒ í™œì„±í™” ì‹¤íŒ¨: ' + error.message);
      }
    }
    
    // ì—…ì²´ ì½”ë“œ ë³µì‚¬
    function copyCode(code) {
      navigator.clipboard.writeText(code).then(() => {
        alert(`âœ… ì—…ì²´ ì½”ë“œ "${code}" ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì—…ì²´ì—ê²Œ ì´ ì½”ë“œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.`);
      }).catch(err => {
        console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
        prompt('ì½”ë“œë¥¼ ë³µì‚¬í•˜ì„¸ìš”:', code);
      });
    }
    
    // ==================== ì‹ ê·œì˜ˆì•½ ê´€ë¦¬ ====================
    
    // ì‹ ê·œì˜ˆì•½ ì¹´ìš´íŠ¸ ë¡œë“œ
    async function loadPendingCount() {
      try {
        const res = await fetch('/pickup/api/pending-count');
        const data = await res.json();
        document.getElementById('pendingCount').textContent = data.pending || 0;
      } catch (error) {
        console.error('ì¹´ìš´íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }
    
    // ì‹ ê·œì˜ˆì•½ ëª¨ë‹¬ ì—´ê¸°
    async function showPendingModal() {
      await loadPendingReservations();
      pendingModalInstance.show();
    }
    
    // ì‹ ê·œì˜ˆì•½ ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
    async function loadPendingReservations() {
      try {
        const res = await fetch('/pickup/api/pending-reservations');
        const data = await res.json();
        
        // ê²€ìˆ˜ ëŒ€ê¸° ë¦¬ìŠ¤íŠ¸
        const pendingList = data.pending || [];
        const rejectedList = data.rejected || [];
        
        // ì—°ê²°ëœ ì˜ˆì•½ ê·¸ë£¹í™” (departureë§Œ í‘œì‹œ, arrivalì€ í¬í•¨)
        const groupedPending = groupLinkedReservations(pendingList);
        const groupedRejected = groupLinkedReservations(rejectedList);
        
        document.getElementById('pendingTabCount').textContent = groupedPending.length;
        document.getElementById('rejectedTabCount').textContent = groupedRejected.length;
        
        // ê²€ìˆ˜ ëŒ€ê¸° ë Œë”ë§
        if (groupedPending.length === 0) {
          document.getElementById('pendingReservations').innerHTML = `
            <div class="text-center text-muted py-5">
              <i class="bi bi-inbox" style="font-size: 3rem;"></i>
              <p class="mt-2">ê²€ìˆ˜ ëŒ€ê¸° ì¤‘ì¸ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤</p>
            </div>
          `;
        } else {
          document.getElementById('pendingReservations').innerHTML = groupedPending.map(p => renderReservationCard(p, 'pending')).join('');
        }
        
        // ë¯¸í™•ì • ë Œë”ë§
        if (groupedRejected.length === 0) {
          document.getElementById('rejectedReservations').innerHTML = `
            <div class="text-center text-muted py-5">
              <i class="bi bi-inbox" style="font-size: 3rem;"></i>
              <p class="mt-2">ë¯¸í™•ì • ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤</p>
            </div>
          `;
        } else {
          document.getElementById('rejectedReservations').innerHTML = groupedRejected.map(p => renderReservationCard(p, 'rejected')).join('');
        }
        
        loadPendingCount();
      } catch (error) {
        console.error('ì˜ˆì•½ ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('ì˜ˆì•½ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
    }
    
    // ì—°ê²°ëœ ì˜ˆì•½ ê·¸ë£¹í™” (ì¶œë°œ+ë„ì°©ì„ í•˜ë‚˜ë¡œ)
    function groupLinkedReservations(reservations) {
      const grouped = [];
      const processedIds = new Set();
      
      reservations.forEach(reservation => {
        // ì´ë¯¸ ì²˜ë¦¬ëœ ì˜ˆì•½ì€ ê±´ë„ˆë›°ê¸°
        if (processedIds.has(reservation.id)) return;
        
        // departure ë ˆì½”ë“œë§Œ ë©”ì¸ìœ¼ë¡œ í‘œì‹œ
        if (reservation.record_type === 'departure') {
          // ì—°ê²°ëœ arrival ë ˆì½”ë“œ ì°¾ê¸°
          const linkedArrival = reservations.find(r => r.id === reservation.linked_id);
          
          // departureì— arrival ì •ë³´ ì¶”ê°€
          reservation.arrival_record = linkedArrival;
          grouped.push(reservation);
          
          processedIds.add(reservation.id);
          if (linkedArrival) {
            processedIds.add(linkedArrival.id);
          }
        } 
        // linked_idê°€ ì—†ëŠ” arrival ë ˆì½”ë“œ (ì—°ê²° ì•ˆëœ ë‹¨ë… ì˜ˆì•½)
        else if (!reservation.linked_id) {
          grouped.push(reservation);
          processedIds.add(reservation.id);
        }
      });
      
      return grouped;
    }
    
    // ê³µí•­ ì½”ë“œë¥¼ ë„ì‹œ ì´ë¦„ìœ¼ë¡œ ë³€í™˜
    function getAirportName(code) {
      const airportNames = {
        'ICN': 'ì¸ì²œ',
        'GMP': 'ê¹€í¬',
        'PUS': 'ë¶€ì‚°',
        'CJU': 'ì œì£¼',
        'GUM': 'ê´Œ'
      };
      return airportNames[code] || code;
    }
    
    // ë‚ ì§œ í¬ë§· (YYYY-MM-DDë§Œ ì¶”ì¶œ)
    function formatDate(dateStr) {
      if (!dateStr) return '';
      if (dateStr.includes('T') || dateStr.includes('Z')) {
        return dateStr.split('T')[0];
      }
      return dateStr;
    }
    
    // ì˜ˆì•½ ì¹´ë“œ ë Œë”ë§ (ì¶œë°œí¸ë§Œ í‘œì‹œ)
    function renderReservationCard(pickup, type) {
      const hasRoundtrip = pickup.arrival_record;
      const depAirport = pickup.departure_airport || 'GUM';
      const depCity = getAirportName(depAirport);
      
      return `
        <div class="card mb-3" style="border-left: 4px solid #2196f3;">
          <div class="card-body" style="background: #e3f2fd;">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="flex-grow-1">
                <h6 class="mb-1" style="color: #2196f3;">âœˆï¸ <strong>${depCity}ì¶œë°œ</strong></h6>
                <div class="mt-1">
                  <span class="badge bg-secondary me-2">ğŸ“… ${formatDate(pickup.display_date)}</span>
                  <span class="badge bg-primary me-2">âœˆï¸ ${pickup.flight_number}</span>
                  <span class="badge bg-info">ğŸ‘¤ ${pickup.customer_name}</span>
                  ${pickup.agency_name ? `<span class="badge bg-success ms-2">ğŸ¢ ${pickup.agency_name}</span>` : ''}
                </div>
              </div>
              <span class="badge bg-secondary">ID: ${pickup.id}</span>
            </div>
            
            <div class="text-muted small mb-3">
              ğŸ“… ${pickup.display_date} ${pickup.display_time}<br>
              ğŸ¨ ${pickup.hotel_name}<br>
              ğŸ‘¥ ${pickup.passenger_count}ëª… (ì„±ì¸:${pickup.adult_count}, ì†Œì•„:${pickup.child_count}, ìœ ì•„:${pickup.infant_count})<br>
              ğŸ§³ ${pickup.luggage_count}ê°œ<br>
              ${pickup.phone ? `ğŸ“ ${pickup.phone}<br>` : ''}
              ${pickup.kakao_id ? `ğŸ’¬ ${pickup.kakao_id}<br>` : ''}
              ${pickup.memo ? `ğŸ“ ${pickup.memo}` : ''}
            </div>
            
            <div class="btn-group w-100" role="group">
              ${type === 'pending' ? `
                <button class="btn btn-primary" onclick="confirmReservation(${pickup.id}, ${pickup.linked_id || 'null'})">
                  <i class="bi bi-check-circle-fill"></i> ì˜ˆì•½ í™•ì •
                </button>
                <button class="btn btn-danger" onclick="rejectReservation(${pickup.id}, ${pickup.linked_id || 'null'})">
                  <i class="bi bi-x-circle-fill"></i> ë¯¸í™•ì •
                </button>
              ` : `
                <button class="btn btn-success" onclick="confirmReservation(${pickup.id}, ${pickup.linked_id || 'null'})">
                  <i class="bi bi-arrow-clockwise"></i> í™•ì •ìœ¼ë¡œ ë³€ê²½
                </button>
                <button class="btn btn-danger" onclick="deleteReservation(${pickup.id}, ${pickup.linked_id || 'null'})">
                  <i class="bi bi-trash-fill"></i> ì˜ˆì•½ ì‚­ì œ
                </button>
              `}
              <button class="btn btn-warning" onclick="editReservation(${pickup.id})">
                <i class="bi bi-pencil-fill"></i> ìˆ˜ì •
              </button>
            </div>
          </div>
        </div>
      `;
    }
    
    // ì˜ˆì•½ í™•ì • ì²˜ë¦¬
    async function confirmReservation(id, linkedId) {
      if (!confirm('ì´ ì˜ˆì•½ì„ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní™•ì • ì‹œ ë‹¬ë ¥ì— í‘œì‹œë©ë‹ˆë‹¤.')) return;
      
      try {
        const res = await fetch(`/pickup/api/confirm-reservation`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, linkedId })
        });
        
        if (res.ok) {
          alert('âœ… ì˜ˆì•½ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
          loadPendingReservations();
        } else {
          const error = await res.json();
          alert('âŒ í™•ì • ì‹¤íŒ¨: ' + (error.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (error) {
        console.error('í™•ì • ì˜¤ë¥˜:', error);
        alert('âŒ í™•ì • ì‹¤íŒ¨: ' + error.message);
      }
    }
    
    // ì˜ˆì•½ ë¯¸í™•ì • ì²˜ë¦¬
    async function rejectReservation(id, linkedId) {
      const reason = prompt('ë¯¸í™•ì • ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ):');
      
      try {
        const res = await fetch(`/pickup/api/reject-reservation`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, linkedId, reason })
        });
        
        if (res.ok) {
          alert('âš ï¸ ì˜ˆì•½ì´ ë¯¸í™•ì • ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadPendingReservations();
        } else {
          const error = await res.json();
          alert('âŒ ì²˜ë¦¬ ì‹¤íŒ¨: ' + (error.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (error) {
        console.error('ë¯¸í™•ì • ì˜¤ë¥˜:', error);
        alert('âŒ ì²˜ë¦¬ ì‹¤íŒ¨: ' + error.message);
      }
    }
    
    // ì˜ˆì•½ ì‚­ì œ
    async function deleteReservation(id, linkedId) {
      if (!confirm('ì´ ì˜ˆì•½ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œ í›„ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
      
      try {
        const res = await fetch(`/pickup/api/delete-reservation`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, linkedId })
        });
        
        if (res.ok) {
          alert('âœ… ì˜ˆì•½ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadPendingReservations();
        } else {
          const error = await res.json();
          alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + (error.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (error) {
        console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
      }
    }
    
    // ì˜ˆì•½ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
    async function editReservation(id) {
      try {
        const res = await fetch(`/pickup/api/pickup/${id}`);
        const pickup = await res.json();
        
        document.getElementById('editPickupId').value = pickup.id;
        document.getElementById('editCustomerName').value = pickup.customer_name || '';
        document.getElementById('editHotelName').value = pickup.hotel_name || '';
        document.getElementById('editPhone').value = pickup.phone || '';
        document.getElementById('editKakaoId').value = pickup.kakao_id || '';
        document.getElementById('editAdultCount').value = pickup.adult_count || 0;
        document.getElementById('editChildCount').value = pickup.child_count || 0;
        document.getElementById('editInfantCount').value = pickup.infant_count || 0;
        document.getElementById('editLuggageCount').value = pickup.luggage_count || 0;
        document.getElementById('editMemo').value = pickup.memo || '';
        
        editReservationModalInstance.show();
      } catch (error) {
        console.error('ì˜ˆì•½ ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('ì˜ˆì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
    }
    
    // ì˜ˆì•½ ìˆ˜ì • ì €ì¥
    async function saveReservationEdit() {
      const id = document.getElementById('editPickupId').value;
      const data = {
        customer_name: document.getElementById('editCustomerName').value,
        hotel_name: document.getElementById('editHotelName').value,
        phone: document.getElementById('editPhone').value,
        kakao_id: document.getElementById('editKakaoId').value,
        adult_count: parseInt(document.getElementById('editAdultCount').value) || 0,
        child_count: parseInt(document.getElementById('editChildCount').value) || 0,
        infant_count: parseInt(document.getElementById('editInfantCount').value) || 0,
        luggage_count: parseInt(document.getElementById('editLuggageCount').value) || 0,
        memo: document.getElementById('editMemo').value
      };
      
      data.passenger_count = data.adult_count + data.child_count + data.infant_count;
      
      try {
        const res = await fetch(`/pickup/api/pickup/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (res.ok) {
          alert('âœ… ì˜ˆì•½ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
          editReservationModalInstance.hide();
          loadPendingReservations();
        } else {
          const error = await res.json();
          alert('âŒ ìˆ˜ì • ì‹¤íŒ¨: ' + (error.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (error) {
        console.error('ìˆ˜ì • ì˜¤ë¥˜:', error);
        alert('âŒ ìˆ˜ì • ì‹¤íŒ¨: ' + error.message);
      }
    }
  </script>
</body>
</html>
