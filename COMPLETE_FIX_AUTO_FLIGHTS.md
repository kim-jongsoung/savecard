# 항공편 자동 생성 문제 완전 해결

## 🔍 문제 상황

**증상**: 
- 항공편을 삭제해도 서버 재시작 시 KE111, KE123, OZ456 등이 다시 생성됨
- 항공편 관리 페이지에서 삭제 기능이 제대로 작동하지 않는 것처럼 보임

**스크린샷**: KE324, LJ752, KE111 등 많은 테스트 항공편이 계속 생성됨

## 🎯 근본 원인

### 1. server-postgresql.js (핵심 문제) ⚠️

**위치**: Line 652-664

서버가 **시작할 때마다** 다음 코드가 실행됨:

```javascript
// 기본 항공편 데이터 추가
await pool.query(`
  INSERT INTO pickup_flights (...) 
  VALUES 
    ('KE111', 'KE', ...),
    ('KE123', 'KE', ...),
    ('KE124', 'KE', ...),
    ('OZ456', 'OZ', ...),
    ... 8개 항공편
  ON CONFLICT (flight_number) DO NOTHING
`);
```

**문제점**:
- Railway 재배포 → 서버 재시작 → INSERT 실행
- 삭제한 항공편이 다시 생성됨
- `ON CONFLICT DO NOTHING`이 있어도 삭제된 데이터는 다시 들어감

### 2. 마이그레이션 파일들

- `migrations/004-pickup-flights-agencies.sql` - 이미 수정 완료 ✅
- `create-pickup-flights-table.js` - 수동 실행 스크립트 (자동 실행 안 됨)

## ✅ 해결 완료

### 1. server-postgresql.js 수정 ✅

**수정 전**:
```javascript
// 기본 항공편 데이터 추가
await pool.query(`INSERT INTO pickup_flights ...`);
console.log('✅ pickup_flights 기본 데이터 추가 완료');
```

**수정 후**:
```javascript
// 기본 항공편 데이터는 자동 생성하지 않음 (항공편 관리 페이지에서 직접 추가)
console.log('✅ pickup_flights 테이블 준비 완료');
```

### 2. 기존 항공편 데이터 정리

다음 명령어로 모든 테스트 항공편을 삭제하세요:

```bash
npm run clean:all-flights
```

**실행 결과**:
```
🚀 모든 항공편 데이터 삭제 시작...

📊 현재 등록된 항공편: 15개

🗑️  삭제할 항공편 목록:
  - KE111 (KE): ICN → GUM [활성]
  - KE123 (KE): ICN → GUM [활성]
  - KE324 (KE): GUM → ICN [활성]
  - LJ752 (LJ): ICN → GUM [활성]
  ... (생략)

✅ 15개의 항공편이 삭제되었습니다!

📈 현재 항공편 데이터: 0개

🎉 완료! 이제 항공편 관리 페이지에서 필요한 항공편만 추가하세요.
```

## 🚀 완전한 해결 절차

### 1단계: 코드 수정 (완료) ✅
`server-postgresql.js`에서 INSERT 문 제거

### 2단계: 기존 데이터 정리
```bash
npm run clean:all-flights
```

### 3단계: 코드 배포
```bash
git add .
git commit -m "항공편 자동 생성 제거"
git push
```

### 4단계: 검증
1. Railway 자동 재배포 대기
2. 항공편 관리 페이지 접속
3. 항공편 목록이 비어있는지 확인 ✅
4. 필요한 항공편만 수동으로 추가

### 5단계: 최종 테스트
1. 항공편 1개 추가 (예: KE111)
2. 삭제
3. Railway 수동 재시작
4. KE111이 다시 생성되지 않는지 확인 ✅

## 📋 생성된 파일

1. **`clean-all-flights.js`** - 모든 항공편 일괄 삭제
2. **`COMPLETE_FIX_AUTO_FLIGHTS.md`** - 이 문서

## 🎯 기대 효과

### Before ❌
```
1. 서버 시작 → 8개 항공편 자동 생성
2. 항공편 삭제 → ✅ 성공
3. 서버 재시작 → 8개 항공편 다시 생성 ❌
4. 사용자: "삭제가 안 돼요!"
```

### After ✅
```
1. 서버 시작 → 자동 생성 안 됨 ✅
2. 필요한 항공편만 수동 추가
3. 항공편 삭제 → ✅ 성공
4. 서버 재시작 → 삭제된 상태 유지 ✅
5. 사용자: "완벽해요!"
```

## 🔧 추가 정보

### 삭제 기능 정상 작동 확인

**스마트 삭제 시스템**:
```javascript
항공편 삭제
  ↓
픽업건 사용 여부 확인
  ↓
┌─────────────────┬─────────────────┐
│ 사용 중 (N건)    │  사용 안 함       │
└─────────────────┴─────────────────┘
      ↓                   ↓
  비활성화            완전 삭제
  (is_active=false)   (DELETE)
```

### 항공편 관리 워크플로우

1. **초기 설정** (최초 1회)
   - 항공편 관리 페이지에서 실제 운항하는 항공편만 추가
   - 예: KE111, OZ456, UA200 등

2. **일상 운영**
   - 항공편 추가/수정/삭제는 관리 페이지에서
   - 더 이상 자동 생성 안 됨

3. **데이터 유지**
   - 서버 재시작해도 추가한 항공편 유지
   - 삭제한 항공편은 다시 생성 안 됨

## 💡 문제 발생 시

### Q: 항공편이 또 자동 생성되면?

**A**: 다음을 확인하세요:

1. `server-postgresql.js` 수정이 배포되었는지 확인
   ```bash
   git log --oneline -1
   # "항공편 자동 생성 제거" 커밋이 있어야 함
   ```

2. Railway 재배포 확인
   - Railway 대시보드에서 최신 배포 상태 확인

3. 캐시 문제
   - Railway에서 수동으로 재배포 트리거

### Q: 기존 픽업 예약이 삭제된 항공편 번호를 사용하고 있으면?

**A**: 문제 없습니다!
- `airport_pickups.flight_number`는 그냥 문자열
- `pickup_flights`와 외래키 관계 없음
- 픽업 예약 데이터는 유지됨

### Q: 나중에 샘플 데이터가 필요하면?

**A**: `create-pickup-flights-table.js`를 수동으로 실행:
```bash
node create-pickup-flights-table.js
```

## 🎉 완료!

이제 다음이 보장됩니다:

- ✅ 서버 재시작 시 항공편 자동 생성 안 됨
- ✅ 항공편 삭제 시 완전히 삭제됨
- ✅ 필요한 항공편만 관리 페이지에서 추가
- ✅ 깨끗한 항공편 관리 시스템

---

**작성일**: 2025-10-15  
**버전**: 2.0.0  
**문제**: 서버 재시작 시 항공편 자동 생성  
**해결**: server-postgresql.js INSERT 문 제거
