# ê´Œì„¸ì´ë¸Œì¹´ë“œ ì˜ˆì•½ ê´€ë¦¬ ì‹œìŠ¤í…œ

ì™„ì „í•œ ì˜ˆì•½ íŒŒì‹± ì´í›„ ìš´ì˜ ê´€ë¦¬ ë°±ì—”ë“œ ì‹œìŠ¤í…œ

## ğŸ“‹ ê°œìš”

ì´ ì‹œìŠ¤í…œì€ OpenAI ê¸°ë°˜ ì˜ˆì•½ í…ìŠ¤íŠ¸ íŒŒì‹± ì´í›„ì˜ ìš´ì˜ ê´€ë¦¬ë¥¼ ìœ„í•œ ì™„ì „í•œ ë°±ì—”ë“œ ì†”ë£¨ì…˜ì…ë‹ˆë‹¤. ë™ì  í•„ë“œ ê´€ë¦¬, ê°ì‚¬ ë¡œê·¸, ì‹¤ì‹œê°„ ì´ë²¤íŠ¸, ì¼ê´„ ì‘ì—… ë“± ì—”í„°í”„ë¼ì´ì¦ˆê¸‰ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.

### ì£¼ìš” ê¸°ëŠ¥

- âœ… **OpenAI ì§€ëŠ¥í˜• íŒŒì‹±**: GPT-4o-mini ëª¨ë¸ì„ í™œìš©í•œ ì •í™•í•œ í…ìŠ¤íŠ¸ íŒŒì‹±
- âœ… **ë™ì  í•„ë“œ ê´€ë¦¬**: JSONB ê¸°ë°˜ í™•ì¥ ê°€ëŠ¥í•œ í•„ë“œ ì‹œìŠ¤í…œ
- âœ… **ì™„ì „í•œ CRUD**: ìƒì„±, ì¡°íšŒ, ìˆ˜ì •, ì‚­ì œ, ë³µêµ¬ ê¸°ëŠ¥
- âœ… **ê°ì‚¬ ë¡œê·¸**: ëª¨ë“  ë³€ê²½ì‚¬í•­ ì¶”ì  ë° ë¡¤ë°± ì§€ì›
- âœ… **ì‹¤ì‹œê°„ ì´ë²¤íŠ¸**: SSE ê¸°ë°˜ ì‹¤ì‹œê°„ ì•Œë¦¼
- âœ… **ì¼ê´„ ì‘ì—…**: ëŒ€ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ë° ë‚´ë³´ë‚´ê¸°
- âœ… **ì•Œë¦¼ ì‹œìŠ¤í…œ**: ì´ë©”ì¼/ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼ ì§€ì›
- âœ… **ë‚™ê´€ì  ì ê¸ˆ**: ë™ì‹œ ìˆ˜ì • ì¶©ëŒ ë°©ì§€

## ğŸ—ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend UI   â”‚    â”‚   Admin Panel   â”‚    â”‚   Mobile App    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚                      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Express.js Server       â”‚
                    â”‚   - API Routes            â”‚
                    â”‚   - SSE Events            â”‚
                    â”‚   - Authentication        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                      â”‚                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚PostgreSQL â”‚        â”‚  OpenAI API   â”‚      â”‚ Notificationâ”‚
    â”‚ Database  â”‚        â”‚   Parsing     â”‚      â”‚  Services   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### í•µì‹¬ í…Œì´ë¸”

#### reservations
```sql
-- ì˜ˆì•½ ë©”ì¸ í…Œì´ë¸” (ê¸°ì¡´ + í™•ì¥)
ALTER TABLE reservations ADD COLUMN IF NOT EXISTS extras JSONB DEFAULT '{}'::jsonb;
ALTER TABLE reservations ADD COLUMN IF NOT EXISTS review_status VARCHAR(50) DEFAULT 'pending';
ALTER TABLE reservations ADD COLUMN IF NOT EXISTS flags JSONB DEFAULT '{}'::jsonb;
ALTER TABLE reservations ADD COLUMN IF NOT EXISTS origin_hash VARCHAR(64);
ALTER TABLE reservations ADD COLUMN IF NOT EXISTS is_deleted BOOLEAN DEFAULT FALSE;
ALTER TABLE reservations ADD COLUMN IF NOT EXISTS lock_version INTEGER DEFAULT 1;
```

#### field_defs
```sql
-- ë™ì  í•„ë“œ ì •ì˜ í…Œì´ë¸”
CREATE TABLE field_defs (
    key TEXT PRIMARY KEY,
    label TEXT NOT NULL,
    type TEXT NOT NULL CHECK (type IN ('string', 'number', 'date', 'time', 'datetime', 'boolean', 'select', 'multiselect', 'textarea', 'email', 'phone')),
    required BOOLEAN DEFAULT FALSE,
    pattern TEXT,
    options JSONB,
    default_value TEXT,
    placeholder TEXT,
    help_text TEXT,
    category TEXT DEFAULT 'general',
    sort_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### reservation_audits
```sql
-- ê°ì‚¬ ë¡œê·¸ í…Œì´ë¸”
CREATE TABLE reservation_audits (
    audit_id BIGSERIAL PRIMARY KEY,
    booking_id BIGINT NOT NULL,
    actor TEXT,
    action TEXT NOT NULL CHECK (action IN ('create', 'update', 'cancel', 'restore', 'delete', 'bulk_update')),
    diff JSONB,
    previous_values JSONB,
    current_values JSONB,
    reason TEXT,
    ip_address INET,
    user_agent TEXT,
    request_id TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

## ğŸš€ ì„¤ì¹˜ ë° ì‹¤í–‰

### 1. í™˜ê²½ ì„¤ì •

```bash
# í™˜ê²½ë³€ìˆ˜ ì„¤ì • (.env íŒŒì¼)
DATABASE_URL=postgresql://user:password@host:port/database
OPENAI_API_KEY=sk-your-openai-api-key
SESSION_SECRET=your-session-secret
NODE_ENV=production
PORT=3001

# ì´ë©”ì¼ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
SMTP_FROM=noreply@guamsavecard.com
```

### 2. ì˜ì¡´ì„± ì„¤ì¹˜

```bash
npm install express pg cors express-session
npm install nodemailer ajv ajv-formats
npm install dotenv
```

### 3. ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜

```bash
# ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
node run-migrations.js

# ë˜ëŠ” ì„œë²„ ì‹œì‘ ì‹œ ìë™ ì‹¤í–‰
node server-booking-management.js
```

### 4. ì„œë²„ ì‹œì‘

```bash
# ê°œë°œ ëª¨ë“œ
NODE_ENV=development node server-booking-management.js

# í”„ë¡œë•ì…˜ ëª¨ë“œ
NODE_ENV=production node server-booking-management.js
```

## ğŸ“¡ API ì—”ë“œí¬ì¸íŠ¸

### ì˜ˆì•½ ê´€ë¦¬

```http
GET    /api/bookings              # ì˜ˆì•½ ëª©ë¡ (í•„í„°ë§, í˜ì´ì§•)
POST   /api/bookings              # ì˜ˆì•½ ìƒì„±
GET    /api/bookings/{id}         # ì˜ˆì•½ ìƒì„¸
PATCH  /api/bookings/{id}         # ì˜ˆì•½ ìˆ˜ì • (ë‚™ê´€ì  ì ê¸ˆ)
DELETE /api/bookings/{id}         # ì˜ˆì•½ ì·¨ì†Œ/ì‚­ì œ
POST   /api/bookings/{id}/restore # ì˜ˆì•½ ë³µêµ¬
POST   /api/bookings/bulk         # ì¼ê´„ ì‘ì—…
```

### í•„ë“œ ì •ì˜ ê´€ë¦¬

```http
GET    /api/field-defs            # í•„ë“œ ì •ì˜ ëª©ë¡
POST   /api/field-defs            # í•„ë“œ ì •ì˜ ìƒì„±
GET    /api/field-defs/{key}      # í•„ë“œ ì •ì˜ ìƒì„¸
PATCH  /api/field-defs/{key}      # í•„ë“œ ì •ì˜ ìˆ˜ì •
DELETE /api/field-defs/{key}      # í•„ë“œ ì •ì˜ ì‚­ì œ
```

### ê°ì‚¬ ë¡œê·¸

```http
GET    /api/audits/recent         # ìµœê·¼ ê°ì‚¬ ë¡œê·¸
GET    /api/audits/{audit_id}     # ê°ì‚¬ ë¡œê·¸ ìƒì„¸
POST   /api/audits/search         # ê°ì‚¬ ë¡œê·¸ ê²€ìƒ‰
GET    /api/bookings/{id}/audits  # íŠ¹ì • ì˜ˆì•½ì˜ ê°ì‚¬ ë¡œê·¸
```

### ì‹œìŠ¤í…œ

```http
GET    /healthz                   # í—¬ìŠ¤ ì²´í¬
GET    /events                    # SSE ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼
GET    /api/system/info           # ì‹œìŠ¤í…œ ì •ë³´
POST   /api/system/migrate        # ìˆ˜ë™ ë§ˆì´ê·¸ë ˆì´ì…˜
```

## ğŸ”§ ì‚¬ìš© ì˜ˆì‹œ

### 1. ì˜ˆì•½ ëª©ë¡ ì¡°íšŒ

```bash
curl -X GET "http://localhost:3001/api/bookings?q=ê¹€ì² ìˆ˜&status=confirmed&page=1&page_size=20" \
  -H "X-API-Key: your-api-key"
```

### 2. ì˜ˆì•½ ìƒì„±

```bash
curl -X POST "http://localhost:3001/api/bookings" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-api-key" \
  -d '{
    "reservation_number": "TEST001",
    "korean_name": "ê¹€ì² ìˆ˜",
    "product_name": "ê´Œ ì‹œí‹°íˆ¬ì–´",
    "usage_date": "2025-10-15",
    "total_amount": 150.00,
    "people_adult": 2,
    "extras": {
      "pickup_location": "í˜¸í…” ë¡œë¹„",
      "special_requests": "íœ ì²´ì–´ ì´ìš©"
    }
  }'
```

### 3. ì¼ê´„ ì·¨ì†Œ

```bash
curl -X POST "http://localhost:3001/api/bookings/bulk" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-api-key" \
  -d '{
    "action": "cancel",
    "ids": [1, 2, 3],
    "reason": "ê³ ê° ìš”ì²­ì— ì˜í•œ ì¼ê´„ ì·¨ì†Œ"
  }'
```

### 4. SSE ì´ë²¤íŠ¸ êµ¬ë…

```javascript
const eventSource = new EventSource('/events');
eventSource.onmessage = function(event) {
    const data = JSON.parse(event.data);
    console.log('ì˜ˆì•½ ì´ë²¤íŠ¸:', data);
};
```

## ğŸ”’ ë³´ì•ˆ ë° ê¶Œí•œ

### ì¸ì¦ ë°©ì‹

1. **API Key**: `X-API-Key` í—¤ë”
2. **Session**: ì¿ í‚¤ ê¸°ë°˜ ì„¸ì…˜ (ê´€ë¦¬ì íŒ¨ë„)

### ê¶Œí•œ ë ˆë²¨

- **admin**: ëª¨ë“  ê¸°ëŠ¥ ì ‘ê·¼
- **operator**: ì˜ˆì•½ ê´€ë¦¬, ì œí•œì  ì„¤ì •
- **viewer**: ì½ê¸° ì „ìš© ì ‘ê·¼

### ë³´ì•ˆ ê¸°ëŠ¥

- ë‚™ê´€ì  ì ê¸ˆìœ¼ë¡œ ë™ì‹œ ìˆ˜ì • ë°©ì§€
- ê°ì‚¬ ë¡œê·¸ë¡œ ëª¨ë“  ë³€ê²½ì‚¬í•­ ì¶”ì 
- IP ì£¼ì†Œ ë° User-Agent ê¸°ë¡
- ì†Œí”„íŠ¸ ì‚­ì œë¡œ ë°ì´í„° ë³´í˜¸

## ğŸ“ˆ ì„±ëŠ¥ ìµœì í™”

### ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ìŠ¤

```sql
-- ì£¼ìš” ì¸ë±ìŠ¤
CREATE INDEX idx_reservations_usage_date ON reservations (usage_date);
CREATE INDEX idx_reservations_created_at ON reservations (created_at);
CREATE INDEX idx_reservations_payment_status ON reservations (payment_status);
CREATE INDEX idx_reservations_korean_name ON reservations (korean_name);
CREATE INDEX idx_reservations_email ON reservations (email);
CREATE INDEX idx_reservations_extras_gin ON reservations USING GIN (extras);

-- ê°ì‚¬ ë¡œê·¸ ì¸ë±ìŠ¤
CREATE INDEX idx_audits_booking_id ON reservation_audits (booking_id);
CREATE INDEX idx_audits_created_at ON reservation_audits (created_at);
CREATE INDEX idx_audits_actor ON reservation_audits (actor);
```

### ìºì‹± ì „ëµ

- í•„ë“œ ì •ì˜: ë©”ëª¨ë¦¬ ìºì‹œ (10ë¶„)
- í†µê³„ ë°ì´í„°: Redis ìºì‹œ (5ë¶„)
- SSE ì´ë²¤íŠ¸: ìµœê·¼ 100ê°œ ë©”ëª¨ë¦¬ ì €ì¥

## ğŸ”„ ì—…ë¬´ í”„ë¡œì„¸ìŠ¤

### ì˜ˆì•½ ìƒëª…ì£¼ê¸°

```
íŒŒì‹± â†’ ë“œë˜í”„íŠ¸ â†’ ê²€ìˆ˜ â†’ ìŠ¹ì¸ â†’ í™•ì • â†’ ì™„ë£Œ
  â†“       â†“       â†“      â†“      â†“      â†“
ì €ì¥    ìˆ˜ì •    ë³´ì •   ìŠ¹ì¸   ì•Œë¦¼   ì™„ë£Œ
```

### ìƒíƒœ ì „ì´

```
pending â†’ needs_review â†’ reviewed â†’ confirmed
   â†“           â†“           â†“          â†“
cancelled â† cancelled â† cancelled â† cancelled
   â†“
restored (24ì‹œê°„ ì´ë‚´)
```

### ê²€ìˆ˜ ì›Œí¬í”Œë¡œìš°

1. **ìë™ íŒŒì‹±**: OpenAIë¡œ í…ìŠ¤íŠ¸ íŒŒì‹±
2. **í’ˆì§ˆ ê²€ì‚¬**: í•„ìˆ˜ í•„ë“œ ë° ì• ë§¤í•œ ë°ì´í„° í™•ì¸
3. **í”Œë˜ê·¸ ì„¤ì •**: missing, ambiguous í•„ë“œ í‘œì‹œ
4. **ê²€ìˆ˜ ëŒ€ê¸°**: review_status = 'needs_review'
5. **ìˆ˜ë™ ê²€ìˆ˜**: ìš´ì˜ìê°€ ë°ì´í„° í™•ì¸ ë° ìˆ˜ì •
6. **ìŠ¹ì¸**: review_status = 'reviewed'
7. **ì•Œë¦¼ ë°œì†¡**: ê³ ê°ì—ê²Œ í™•ì¸ ì•Œë¦¼

## ğŸš¨ ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼

### í—¬ìŠ¤ ì²´í¬

```bash
curl http://localhost:3001/healthz
```

### ë¡œê·¸ ëª¨ë‹ˆí„°ë§

```bash
# ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸
tail -f logs/booking-management.log

# ì—ëŸ¬ ë¡œê·¸ í•„í„°ë§
grep "âŒ" logs/booking-management.log
```

### ì•Œë¦¼ ì„¤ì •

- **ì´ë©”ì¼**: ì˜ˆì•½ í™•ì¸, ì·¨ì†Œ, ë¦¬ë§ˆì¸ë”
- **ì¹´ì¹´ì˜¤í†¡**: ì˜ˆì•½ ì•Œë¦¼ (API ì—°ë™ í•„ìš”)
- **SSE**: ì‹¤ì‹œê°„ ê´€ë¦¬ì ì•Œë¦¼

## ğŸ”§ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ì¼ë°˜ì ì¸ ë¬¸ì œ

1. **ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨**
   ```bash
   # ì—°ê²° í…ŒìŠ¤íŠ¸
   psql $DATABASE_URL -c "SELECT NOW();"
   ```

2. **ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨**
   ```bash
   # ìˆ˜ë™ ë§ˆì´ê·¸ë ˆì´ì…˜
   node run-migrations.js
   ```

3. **OpenAI API ì˜¤ë¥˜**
   ```bash
   # API í‚¤ í™•ì¸
   echo $OPENAI_API_KEY
   ```

4. **SSE ì—°ê²° ë¬¸ì œ**
   ```javascript
   // ì¬ì—°ê²° ë¡œì§
   eventSource.onerror = function() {
       setTimeout(() => {
           eventSource = new EventSource('/events');
       }, 5000);
   };
   ```

### ì„±ëŠ¥ ë¬¸ì œ

1. **ëŠë¦° ì¿¼ë¦¬ ìµœì í™”**
   ```sql
   -- ì¿¼ë¦¬ ì‹¤í–‰ ê³„íš í™•ì¸
   EXPLAIN ANALYZE SELECT * FROM reservations WHERE usage_date >= '2025-01-01';
   ```

2. **ì¸ë±ìŠ¤ ì‚¬ìš©ë¥  í™•ì¸**
   ```sql
   -- ì¸ë±ìŠ¤ í†µê³„
   SELECT schemaname, tablename, indexname, idx_scan, idx_tup_read, idx_tup_fetch 
   FROM pg_stat_user_indexes;
   ```

## ğŸ“š ì¶”ê°€ ë¬¸ì„œ

- [OpenAPI ìŠ¤í™](./OPENAPI.yaml)
- [ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ](../migrations/)
- [ë°°í¬ ê°€ì´ë“œ](./DEPLOYMENT.md)
- [ê°œë°œ ê°€ì´ë“œ](./DEVELOPMENT.md)

## ğŸ¤ ê¸°ì—¬í•˜ê¸°

1. Fork the repository
2. Create feature branch (`git checkout -b feature/amazing-feature`)
3. Commit changes (`git commit -m 'Add amazing feature'`)
4. Push to branch (`git push origin feature/amazing-feature`)
5. Open Pull Request

## ğŸ“„ ë¼ì´ì„ ìŠ¤

ì´ í”„ë¡œì íŠ¸ëŠ” MIT ë¼ì´ì„ ìŠ¤ í•˜ì— ìˆìŠµë‹ˆë‹¤.

## ğŸ“ ì§€ì›

- **ì´ë©”ì¼**: support@guamsavecard.com
- **ë¬¸ì„œ**: https://docs.guamsavecard.com
- **ì´ìŠˆ**: GitHub Issues
